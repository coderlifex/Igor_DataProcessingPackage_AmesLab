#pragma version = 1.00	// Version of this Procedure#pragma IgorVersion = 4.0	// Requires Igor 4 or later#pragma rtGlobals=2		// Use modern global access method.dowindow/f Au#include <Multi-peak fitting 2.0>  // Initializations for complete new ExperimentMDCdispersion// not necessary when using Blank experimentmenu "ARPES"	"New Experiment", NewExperiment()end	Macro NewExperiment()silent 1; pauseupdate 	dowindow/F AutoGraph	if(V_flag==0)	string/g dispwave="gr", sampleName=" "	Variable/g last_ff, last_lf GF_power, last_beam=0	String/g last_path = "MacIntosh HD:Data:rxxsyy:rxxsyy-"	String/g last_postfix = ".txt"		 // Modify_graph variables	variable/g LeftOn, FontSizevalue	string/g AxisName, BottomLabel, LeftLabel	variable/g ZeroLeft, Zerobottom, MinorLeft, MinorBottom, OffsetLeft, OffsetBottom	variable/g LabelOnleft, LabelOnBottom, TickLeft, TickBottom, SwapXYvalue	variable/g  XmaxValue,XminValue,YmaxValue,YminValue, Ysizevalue, Xsizevalue	variable/g YAxischecked, XAxischecked, Yvaluechecked, Xvaluechecked, Ysizechecked, Xsizechecked	variable/g Ylabelchecked, Xlabelchecked, topMargin, rightMargin, leftMargin, bottomMargin	variable/g Standleft, StandBottom, AutoCheck, XYswapCheck, MarginCheck, AutoSizeCheck	   dowindow Memo_R	if (v_flag==0)	NewNotebook/W=(30,30,300,300) /F=0/N=Memo_R /V=0	endif	make/d /o  /n=0 zerowave 	make/d /o /n=(1000,20)   graphlist	if(!exists("map"))	make/d /o /n=(1000,20) map	map[0][0]=1000	endif	if(!exists("mapT"))	make/t /o /n=(1000,20)  mapT	endif	make/d /o /n=0 temp, temp1, temp2, temp3, tempX	make/t /o /n=10  tempT, tempT1, tempT2, tempT3, tempT4	make/d /o /n=2 DrawX=nan,DrawY=nan, DrawWaveX=nan, DrawWaveY=nan, DrawWaveX_L=nan, DrawWaveY_L=nan	make/d /o /n=100 GrAllNum, NrAllNum	make/d /o /n=0 int2d	make/d /o /n=(10,3) bzmap	make/d /o /n=(10,3) bzTemp	make/d /o /n=(2,5)  cutoff, bz, nk2d, ne2d, akw2d, Dif2d	make/d /o /n=5 w, w_coef, wlor, wlor2, coeff	Redimension/D coeff	make/d /o /n=12 lor	make/d /o /n=0 nil	make/o/n=5 BZlinetetraX, BZlinetetraY	BZlinetetraX={1, -1, -1, 1,1}	BZlinetetraY={1, 1, -1, -1,1}	make/o/n=2 BZlinetetraDiagX, BZlinetetraDiagY1,  BZlinetetraDiagY2, BZlinetetraVX, BZlinetetraVY, BZlinetetraHX, BZlinetetraHY	BZlinetetraDiagX={3,-3}	BZlinetetraDiagY1={3,-3}	BZlinetetraDiagY2={-3,3}	BZlinetetraVX={-3,3}	BZlinetetraVY={0,0}	BZlinetetraHX={0,0}	BZlinetetraHY={-3,3}	make/o/n=8 BZlinehexXn, BZlinehexXp, BZlinehexY	BZlinehexXn={-1, 0, 0, -1, -1, 0, 0,-1}	BZlinehexXp=-1*BZlinehexXn	BZlinehexY={5/sqrt(3), 4/sqrt(3), 2/sqrt(3), 1/sqrt(3), -1/sqrt(3), -2/sqrt(3), -4/sqrt(3), -5/sqrt(3)}	make/o/n=2 BZlinehexDiage1X, BZlinehexDiage2X, BZlinehexDiage3X, BZlinehexDiage1Y, BZlinehexDiage2Y, BZlinehexDiage3Y	BZlinehexDiage1X={-3,3}	BZlinehexDiage1Y={0,0}	BZlinehexDiage2X={-3/sqrt(3),3/sqrt(3)}	BZlinehexDiage2Y={-3,3}	BZlinehexDiage3X={-3/sqrt(3),3/sqrt(3)}	BZlinehexDiage3Y={3,-3}	// Autograph variables	Variable/g checked = 1, diffe_offset, Goffset, EfgraphNo, dEpoints, Nopoly, Noslice, interpX_Bz=1, interpY_Bz=1, Allchecked	Variable/g scope_graph=1, interp_scope=0,  scope_angle=0,  scope_range=1, scope_offs=0, symcheck, scope_add =1 	Variable/g scope_smooth=0, sweepNo=0, EFchecked=0, scope_mean=1, MDCchecked=0, Goffvalue, dEpoints, Nopoly, Noslice	Variable/g update_2d=1, update_scope=checked, diffe_offset, autloadChecked,  BzErange=0.01, BzEnergy, EFvalue	variable/g Old_scope_range, Old_scope_add=1, Old_scope_graph, ResetON=0, BzmapDimsize=10	variable/g lastNorm_ff, lastNorm_lf, GoffsetNorm, NormEi, NormEf, NormMode, autNormChecked, NormMode, Fermicheck	variable/g  lastEF_ff, lastEF_lf, GoffsetEF, page=1, of=1, ListNo, LastNo, scopeNow, Draw_smooth	variable/g FolderChecked=1, SampleChecked=1, SliceNoChecked=1, SweepChecked=1, PassEChecked=1, EiiChecked=1, EffChecked=1	variable/g EstepChecked=1, DateChecked=1, TimeChecked=1, TempChecked=1, XChecked=1, YChecked=1, ZChecked=1, ThetaChecked=1, TiltChecked=1, PsiChecked=1	variable/g a_ang, c_ang, hvi, hvf, V_0, AnaFromAn, AnaToAn, AutoCentMinus, AutoCentPlus, CurveRotaAngle, WithFlatCheck	variable/g MDC_Graph,MDC_E,MDCone_Ei, MDCone_Ef, MDCone_mP0, MDCone_P0, MDCone_mP1, MDCone_P1, MDCgraphi, MDCgraphf	variable/g MDCtwo_Ei, MDCtwo_Ef, MDCtwo_mP0, MDCtwo_P0, MDCtwo_mP1, MDCtwo_P1, kdistance	variable/g interpX_Draw=1, interpY_Draw=1, Draw_offs, Draw_sym_checked, Draw_meanX=1, Draw_meanY=1, Draw_Fermi_checked		variable/g D2nd_graph,  D2nd_EDCsm1, D2nd_EDCsm2, D2nd_EDCsm3, D2nd_MDCsm1, D2nd_MDCsm2, D2nd_MDCsm3, D2nd_mode=1, D2nd_dim=1,D2nd_Goffvalue, D2nd_avgEDC,D2nd_avgMDC, D2nd_graphi, D2nd_graphf, D2nd_EDCfitpoints, D2nd_MDCfitpoints, d2nd_2dchecked	string/g D2nd_dispwave	variable/g dkpoints, Draw_Estep, Draw_dE, Eslice, Draw_Emean, Draw_Euler_checked, Draw_koffs, Auto_Estep	variable/g Auto_Ei, Auto_Ef, IntPoints, MapInterpX=1, MapInterpY=1, Erange_back, Convo_Check, T_convo, convoON, Auto_FWHM_Convo	String /g scope_title =" ", sweep_title = " ", EFwave="aup", FolderPath, bzname="bzmap", Lastpathinfo,Spaceline	string/g Gmodestring="1", Goffsetstring="G0000",LastFoldername, Lastgr, LoadOption, GotName,DatasheetStr,EorPstr,NewInterpMapName	string/g DateInfostr, SampleInfostr, SweepInfostr, PassEInfostr, SliceInfostr, LowEInfostr, HighEInfostr, EStepstr, FolderInfostr	string/g TimeInfostr, TotalGInfostr, GraphNoInfostr, YesNocorr="No", TempInfostr, XInfostr, YInfostr, ZInfostr, ThetaInfostr,  TiltInfostr, PsiInfostr, Goffinfo		string/g Difname, EDCorMDC, DrawWinName, DrawBZname, DrawPanelname, Gobzname, MDCtwo_mP0_OneorTwo, FindWaveName, IntName, FermiPassageStr	string/g Auto_Yes_No_Convo, EFvsT_curveName	variable/g EFvsT_firstG, EFvsT_lastG, stopLoad	make /d /o/n=0 scope0, scope1, scope2, scope3, scope4, scope5, scope6, scope7, scope8, scope9, scopeX 	make /d /o/n=0 scope10, scope11, scope12, scope13, scope14, scope15, scope16, scope17, scope18, scope19	make /d /o/n=0 scope20, scope21, scope22, scope23, scope24, scope25, scope26, scope27, scope28, scope29	make /d /o/n=0 scope30, scope31, scope32, scope33, scope34, scope35, scope36, scope37, scope38, scope39	make /d /o/n=0 scope40, scope41, scope42, scope43, scope44, scope45, scope46, scope47, scope48, scope49	make /o /d /n=5 wFermi	make /d /o /t /n=20 sweep_desc	make /d /o /n=10 Deriva2dwave	make/t/o/n=(20.5) Datasheetstock	variable/g SSvector=0.24  // Resitration panel  variable/g copyG_offs, NoteFontSize, DivMean_Ei, DivMean_Ef  string/g Notename, NewNoteName    	// Buttongraph variabloesF	Variable /g butt_gr1,butt_gr2,butt_gr3,butt_gr4,butt_gr5,butt_gr6,butt_gr7,butt_gr8,butt_gr9,butt_gr10	Variable /g butt_an1,butt_an2,butt_an3,butt_an4,butt_an5,butt_an6,butt_an7,butt_an8,butt_an9,butt_an10	variable/g Butt_off1,Butt_off2,Butt_off3,Butt_off4,Butt_off5,Butt_off6,Butt_off7,Butt_off8,Butt_off9,Butt_off10, Butt_offAll	Variable /g butt_shift,butt_set,butt_range,buttload_check, Butt_Page=1, Butt_of=1, ButtXminValue,ButtXmaxValue	variable/g Butt_FromGraph, Butt_FromNo, Butt_toGraph, ButtFermiTemp, ButtSubtractNo,ButtDivideNo,AnaFromNo, AnaToNo, AutoTempcheck, Butt_replaceNo, Butt_withNo	Variable /g normalizeON,MaxNormON,AllAreaON,symon,butt_leg,mdc_flag,Butt_backgr_on,buttload_check,ButtAllON,Butt_i,butt_setExtra,Butt_FromEtra,Butt_ToEtra,Butt_ThisPageFrom	variable/g Butt_Bold1=1,Butt_Bold2=1,Butt_Bold3=1,Butt_Bold4=1,Butt_Bold5=1	variable/g Butt_Bold6=1,Butt_Bold7=1,Butt_Bold8=1,Butt_Bold9=1,Butt_Bold10=1,Butt_BoldAll=1	variable/g CentPlus, CentMinus, Butt_From, Butt_to, Butt_OffsetPart,Butt_OffsetPartBase, Butt_SlicePart, Butt_GraphPart, butt_Smooth	variable/g ButtFermiON, AutoCursorCheck, ContinueCheck, HightCheck, Butt_X1, Butt_X2, FWHM_Convolution, GapvsTempCheck, AreavsTempCheck,  useAreaCheck	variable/g Butt_AddFirst, Butt_AddLast,CentMinus_E, CentPlus_E	string /g butt_title, Butt_ANorGR,ButtTemp,ButtTheta,ButtGraphNo,memoButt,P1st,P2nd,P3rd,Yes_No_Convolution,Butt_EnergyPointStr	string/g butt_No1="1",butt_No2="2",butt_No3="3",butt_No4="4",butt_No5="5",	string/g butt_No6="6",butt_No7="7",butt_No8="8",butt_No9="9",butt_No10="10", butt_NoAll="All"	make/d /n=0 /o buttwave1, buttwave2, buttwave3, buttwave4, buttwave5, buttwave6, buttwave7, buttwave8, buttwave9, buttwave10 	make/d /n=0 /o buttx1, buttx2, buttx3, buttx4, buttx5, buttx6, buttx7, buttx8, buttx9, buttx10	make/d /n=11 /o  butt_graph, butt_angle, butt_offset, butt_Goff, butt_Bold=1, ButtGap, ButtPeak, ButtNo	make/d /n=30 /t /o butt_desc	make/o/t/n=11 Butt_color	make/t/o/n=51 memoT_Butt	make/t/o/n=(2,2,2) ButtSaveTable	make/t/o/n=(2,2,2) ButtSaveEDCMDC	make/o/t/n=11 No_, Temp_K_, Graph_, Theta_deg_, Slice_, Tilt_deg_, Psi_deg_    	//TB variables   Variable /g bt0, bt1, bt2, bt3,  bt4, bt5, bt6, d1, d2, d3, d4, d5, d6, saveNo, TBsavecheck   variable/g Ax=0, Ay=0, Bx=1, By=1, Cx=1, Cy=0, Dx=0, Dy=0, TBsize=101, TB_Emax=1.5, TB_Emin=-0.8,  p_value, sigma=0.001   variable/g RestNo, PiAngle=1   string/g saveNo_memo   string/g TB_kx, TB_ky, TB_E   variable/g CutRangeNum=3, FourSymCheck   make/t /o /n=51  memoT   make/d/o/n = 10 traceY, traceX    make/d/o/n = 10 DOS        // FS rotation variables   string/g kxwaveRota, kywaveRota, FScolor="Grays"  variable/g SliceAngle, RotaAngle, offXrota, offYrota, RotaXspacing, Theta  variable/g PhotoEnergy, workfunction, LatticeConstant  string/g BZType="Tetra", BZType_cut="Tetra"  variable/g GapMaxDwave, GapBvalue, RotaChecked, FSInvertCheck, FSGammaval=1  variable/g offTheta, offPhi, offpsi, offRota, readTheta, readPhi, readRota, FSBlankInt  variable/g FSsavecheck, saveNo_FS, maltiplesize=5, scientaAngle=7 //, MapRotaPiAngle  string/g saveNo_memoFS, UseparaFSMapstr="FSmapping", NewRotaMapName, FSbrankstr="zero"  make/o/t/n=51 memoT_FS  make/d/o/n=50 Rotakx_a1, Rotakx_b1, Rotakx_c1, Rotakx_d1  make/d/o/n=50 Rotakx_a2, Rotakx_b2, Rotakx_c2, Rotakx_d2  make/d/o/n=50 Rotaky_a1, Rotaky_b1, Rotaky_c1, Rotaky_d1  make/d/o/n=50 Rotaky_a2, Rotaky_b2, Rotaky_c2, Rotaky_d2     // Self Energy   string/g ReSigma_modi, ImSigma_modi   variable/g SelfMap_Kpoints, SelfMap_Epoints, SelfMap_C=1, SelfMap_EminFL=-0.1, SelfMap_EminML=-0.1, modeFLML=1   variable/g SelfMap_Emin1, SelfMap_Emin2, SelfMap_Emin3   variable/g SelfMap_ki, SelfMap_kf, SelfMap_Ei, SelfMap_Ef, SelfMap_VF, SelfMap_VF_eVA, SelfMap_T   string/g wMDCstr, enMDCstr   variable/g SelfMap_aFL, SelfMap_cFL, SelfMap_aML, SelfMap_cML, SelfMap_kFermi=0.1, SelfMap_Erange=1, SelfMap_VF_Erange   variable/g SelfMap_a1, SelfMap_b1, SelfMap_c1, SelfMap_a2, SelfMap_b2, SelfMap_c2, SelfMap_a3, SelfMap_b3, SelfMap_c3   variable/g LinearBandCheck, DataModelCheck, Self_SliceAngle, Self_Piangle   string/g ImXstr, ImYstr   variable/g InputImCheck   make/d/o/n=(101,101)  selfMap	 make/d/o/n=(101) selfEDC		// Globals for Combo	variable /g sg1, sg2, sg3, sg4, sg5, sg6, sg7, sg8, sg9, sg10, sg11, sg12, sgAll	variable /g st1, st2, st3, st4, st5, st6, st7, st8, st9, st10, st11, st12, stAll	variable /g num1, num2, num3, num4, num5, num6, num7, num8, num9, num10, num11, num12, numAll	variable /g off1, off2, off3, off4, off5, off6, off7, off8, off9, off10, off11, off12, offAll, combo_offset	variable /g combo_index, combo_autoload_chk, combo_Usecursor_chk, combo_Userange_chk, Combo_rangeEi, Combo_rangeEf	string /g combo_descr	string /g scope_title gf_title	make/o/t/n=13 Combo_color="(65535,0,0)"	make/d /o/d /n=(20,5) combo_var	make /t /o /n=100 combo_descr_wave	duplicate/o zerowave, combox1	String/g Combo_DispWave = "nr"	AutoGraph()		// Globals for ARPES line correction	//variable/g Psival, Thetaval, Phival, Thetafrom, Thetato, ThetaStep, ARPESPiAngle , ARPESRotaAngle	variable/g ScientaPsival, ScientaThetaval, ScientaPhival, ScientaThetaFrom, ScientaThetaTo, ScientaThetaStep, Scientahv=21.2, Scientawk=4.3, Scientaaa=3.8	variable/g RealTheta, RealPhi, RealRotation, CaliAngleCK	variable/g   ScientaRotaAngle, saveNo_Scienta, ScientaSavecheck, ImAxisCurveSlice, ImAxisCurveRange, ImAxis_MDCflag //ScientaPiAngle ,	string/g saveNo_memoScienta	make/o/t/n=51 memoT_Scienta		// Globals for ALS	variable/g GammaVal=1, InvertCheck, Gridkpoints, Gridepoints, ALShv1, ALShv2, ALSsliceDeg, ALSThetaOffset	variable/g ALSInner, ALSlattice_a, ALSlattice_c, ALSNormCheck, ALSsaveNo, ALSsavecheck	string/g ALScolor="grays", saveNo_memoALS, NewALSMapName	make/o/t/n=51 memoT_ALS		// Globals for Map Axis Correction	string/g  ImAxis_ImageName, ImAxis_NewImageName, ImAxis_color="Grays", ImAxis_saveNo_memo	variable/g  ImAxis_offset, ImAxis_oneSliceAngle, ImAxis_saveNo, ImAxis_PiAngle	variable/g ImAxis_InvertCheck, ImAxis_Gammaval, ImAxis_savecheck, ImAxis_saveNo	make/o/t/n=51 ImAxis_memoT   	// get color table 	string/g  color256listStr, ColorName, madeColorName 	variable/g to_color, from_color, changeTo8bitCheck 	 	endifEndMacromacro Modify_Experiment()  silent 1; pauseupdate     	if (stringmatch(WaveList("map","",""),"")==1)  	make/d /o /n=(1000,20)  map	//map[][0]=1 ; 	map[0][0]=1000	endif		if (stringmatch(WaveList("bzTemp","",""),"")==1)	make/d /o /n=(10,3) bzTemp	endif		if (stringmatch(WaveList("GrAllNum","",""),"")==1)	make/d /o /n=100 GrAllNum ; GrAllNum[]=0	make/d /o /n=100 NrAllNum ; NrAllNum[]=0	endif		if (stringmatch(WaveList("ne2d","",""),"")==1)	make/d /o /n=(2,5)  ne2d	endif		if (stringmatch(WaveList("DIf2d","",""),"")==1)	make/d /o /n=(2,5)  DIf2d	endif		if (stringmatch(WaveList("mapT","",""),"")==1)      make/t /o /n=(1000,20)  mapT	endif  	make/d /o /n=2 DrawX=nan,DrawY=nan	if (stringmatch(WaveList("coeff","",""),"")==1)    	make/d /o /n=5 coeff    	Redimension/D coeff	endif		dowindow Memo_R	if (v_flag==0)	NewNotebook/W=(30,30,300,300) /F=0/N=Memo_R /V=0	endif	make/t /o /n=10  tempT, tempT1, tempT2, tempT3, tempT4	   // Modify_graph variables  	variable/g LeftOn, FontSizevalue   	string/g AxisName, BottomLabel, LeftLabel   	variable/g ZeroLeft, Zerobottom, MinorLeft, MinorBottom	variable/g LabelOnleft, LabelOnBottom, TickLeft, TickBottom, OffsetLeft, OffsetBottom	variable/g  XmaxValue,XminValue,YmaxValue,YminValue, SwapXYvalue, Ysizevalue, Xsizevalue	variable/g YAxischecked, XAxischecked, Yvaluechecked, Xvaluechecked, Ysizechecked, Xsizechecked	variable/g Ylabelchecked, Xlabelchecked, topMargin, rightMargin, leftMargin, bottomMargin	variable/g StandLeft, StandBottom, AutoCheck, XYswapCheck, MarginCheck, AutoSizeCheck	   // Autograph variables   	findwavenum ()	string/g dispwave, sampleName	Variable/g last_ff, last_lf GF_power, last_beam	String/g last_path	String/g last_postfix	Variable/g checked , diffe_offset, EfgraphNo, dEpoints, Nopoly, Noslice, interpX_Bz=1, interpY_Bz=1, Allchecked	Variable/g scope_graph, interp_scope,  scope_angle,  scope_range, scope_offs, symcheck, scope_add =1 	Variable/g scope_smooth, sweepNo, EFchecked, scope_mean=1, MDCchecked, Goffvalue, dEpoints, Nopoly, Noslice	Variable/g update_2d, update_scope=checked, diffe_offset, autloadChecked,  BzErange=0.01, BzEnergy, EFvalue	variable/g Old_scope_range, Old_scope_add=1, Old_scope_graph, ResetON=0, BzmapDimsize=10	variable/g lastNorm_ff, lastNorm_lf, GoffsetNorm, NormEi, NormEf, NormMode, autNormChecked, NormMord, Fermicheck	variable/g  lastEF_ff, lastEF_lf, GoffsetEF, page=1, of=1, ListNo, LastNo, scopeNow, Draw_smooth	variable/g FolderChecked, SampleChecked, SliceNoChecked, SweepChecked, PassEChecked, EiiChecked, EffChecked	variable/g EstepChecked, DateChecked, TimeChecked, TempChecked, XChecked, YChecked, ZChecked, ThetaChecked	variable/g a_ang, c_ang, hvi, hvf, V_0, AnaFromAn, AnaToAn, AutoCentMinus, AutoCentPlus, CurveRotaAngle, WithFlatCheck	variable/g MDC_Graph,MDC_E,MDCone_Ei, MDCone_Ef, MDCone_mP0, MDCone_P0, MDCone_mP1, MDCone_P1	variable/g MDCtwo_Ei, MDCtwo_Ef, MDCtwo_mP0, MDCtwo_P0, MDCtwo_mP1, MDCtwo_P1, kdistance	variable/g interpX_Draw, interpY_Draw, Draw_offs, Draw_sym_checked, Deriva2dChecked, Draw_meanX, Draw_meanY, Draw_Fermi_checked	variable/g dkpoints, Draw_Estep, Draw_dE, Eslice, Draw_Emean, Draw_Euler_checked, Draw_koffs, Auto_Estep	variable/g Auto_Ei, Auto_Ef, IntPoints, MapInterpX=1, MapInterpY=1, Erange_back, Convo_Check, T_convo, convoON, Auto_FWHM_Convo	string/g Difname, EDCorMDC, DrawWinName, DrawBZname, DrawPanelname, Gobzname, MDCtwo_mP0_OneorTwo, FindWaveName, IntName, FermiPassageStr	String /g scope_title, sweep_title, EFwave="aup", FolderPath, bzname="bzmap", Lastpathinfo,Spaceline,EorPstr,NewInterpMapName	string/g Gmodestring="1", Goffsetstring="G0000",LastFoldername, Lastgr, LoadOption, GotName,DatasheetStr	string/g DateInfostr, SampleInfostr, SweepInfostr, PassEInfostr, SliceInfostr, LowEInfostr, HighEInfostr, EStepstr, FolderInfostr	string/g TimeInfostr, TotalGInfostr, GraphNoInfostr, YesNocorr="No", TempInfostr, XInfostr, YInfostr, ZInfostr, ThetaInfostr, TiltInfostr, PsiInfostr, Goffinfo	string/g Auto_Yes_No_Convo, EFvsT_curveName	variable/g EFvsT_firstG, EFvsT_lastG, stopLoad  	if (stringmatch(WaveList("Datasheetstock","",""),"")==1)	make/t/o/n=(20.5) Datasheetstock	endif		if (stringmatch(WaveList("Deriva2dwave","",""),"")==1)	make /d /o /n=10 Deriva2dwave	endif			if (stringmatch(WaveList("wFermi","",""),"")==1)	make /o /d /n=5 wFermi	endif			// Resistration panel  variable/g copyG_offs, NoteFontSize, DivMean_Ei, DivMean_Ef  string/g Notename, NewNoteName  	// Buttongraph variabloes	Variable /g butt_gr1,butt_gr2,butt_gr3,butt_gr4,butt_gr5,butt_gr6,butt_gr7,butt_gr8,butt_gr9,butt_gr10	Variable /g butt_an1,butt_an2,butt_an3,butt_an4,butt_an5,butt_an6,butt_an7,butt_an8,butt_an9,butt_an10	variable/g Butt_off1,Butt_off2,Butt_off3,Butt_off4,Butt_off5,Butt_off6,Butt_off7,Butt_off8,Butt_off9,Butt_off10,Butt_offAll	Variable /g butt_shift,butt_set,butt_range,buttload_check,Butt_Page=1, Butt_of, ButtXminValue, ButtXmaxValue	variable/g Butt_FromGraph, Butt_FromNo, Butt_toGraph, ButtFermiTemp, ButtSubtractNo,ButtDivideNo,AnaFromNo, AnaToNo, AutoTempcheck, Butt_replaceNo, Butt_withNo	Variable /g normalizeON,MaxNormON,AllAreaON,symon,butt_leg,mdc_flag,Butt_backgr_on,buttload_check,ButtAllON,Butt_i,butt_setExtra,Butt_FromEtra,Butt_ToEtra,Butt_ThisPageFrom	variable/g Butt_Bold1,Butt_Bold2,Butt_Bold3,Butt_Bold4,Butt_Bold5,Butt_Bold6,Butt_Bold7,Butt_Bold8,Butt_Bold9,Butt_Bold10,Butt_BoldAll	variable/g Butt_AddFirst, Butt_AddLast,CentMinus_E, CentPlus_E	string /g butt_title, Butt_ANorGR,ButtTemp,ButtTheta,ButtGraphNo,memoButt,P1st,P2nd,P3rd,Yes_No_Convolution,Butt_EnergyPointStr	string/g butt_No1="1",butt_No2="2",butt_No3="3",butt_No4="4",butt_No5="5",	string/g butt_No6="6",butt_No7="7",butt_No8="8",butt_No9="9",butt_No10="10", butt_NoAll="All"	variable/g CentPlus, CentMinus, Butt_From, Butt_to, Butt_OffsetPart,Butt_OffsetPartBase, Butt_SlicePart, Butt_GraphPart, butt_Smooth	variable/g ButtFermiON, AutoCursorCheck, ContinueCheck, HightCheck, Butt_X1, Butt_X2, FWHM_Convolution, GapvsTempCheck, AreavsTempCheck, useAreaCheck		if (stringmatch(WaveList("butt_graph","",""),"")==1)			make/d /n=11 /o  butt_graph	endif	if (stringmatch(WaveList("butt_angle","",""),"")==1)			make/d /n=11 /o  utt_angle	endif	if (stringmatch(WaveList("butt_offset","",""),"")==1)			make/d /n=11 /o  butt_offset	endif	if (stringmatch(WaveList("butt_Goff","",""),"")==1)			make/d /n=11 /o  butt_Goff	endif	if (stringmatch(WaveList("butt_Bold","",""),"")==1)			make/d /n=11 /o  butt_Bold			butt_Bold =1	endif	if (stringmatch(WaveList("ButtGap","",""),"")==1)			make/d /n=11 /o  ButtGap	endif	if (stringmatch(WaveList("ButtPeak","",""),"")==1)			make/d /n=11 /o  ButtPeak	endif	if (stringmatch(WaveList("ButtNo","",""),"")==1)			make/d /n=11 /o  ButtNo	endif		if (stringmatch(WaveList("butt_color","",""),"")==1)			make/t/o/n=11  butt_color	endif	if (stringmatch(WaveList("memoT_Butt","",""),"")==1)			make/t/o/n=51 memoT_Butt	endif	if (stringmatch(WaveList("ButtSaveTable","",""),"")==1)			make/t/o/n=(2,2,2) ButtSaveTable	endif	if (stringmatch(WaveList("ButtSaveEDCMDC","",""),"")==1)			make/t/o/n=(2,2,2) ButtSaveEDCMDC	endif	if (stringmatch(WaveList("No_","",""),"")==1)			make/o/t/n=11 No_	endif	if (stringmatch(WaveList("Temp_K_","",""),"")==1)			make/o/t/n=11 Temp_K_	endif	if (stringmatch(WaveList("Psi_deg_","",""),"")==1)			make/o/t/n=11 Psi_deg_	endif	if (stringmatch(WaveList("Tilt_deg_","",""),"")==1)			make/o/t/n=11 Tilt_deg_	endif	if (stringmatch(WaveList("Graph_","",""),"")==1)			make/o/t/n=11 ButtSaveEDCMDC	endif	if (stringmatch(WaveList("Theta_deg_","",""),"")==1)			make/o/t/n=11 ButtSaveEDCMDC	endif 	if (stringmatch(WaveList("Slice_","",""),"")==1)			make/o/t/n=11 ButtSaveEDCMDC	endif		//TB variables   Variable /g bt0, bt1, bt2, bt3,  bt4, bt5, bt6, d1, d2, d3, d4, d5, d6, saveNo, TBsavecheck   variable/g Ax=0, Ay=0, Bx=1, By=1, Cx=1, Cy=0, Dx=0, Dy=0, TBsize=101, TB_Emax=1.5, TB_Emin=-0.8,  p_value, sigma=0.001   variable/g RestNo, PiAngle   string/g saveNo_memo   string/g TB_kx, TB_ky, TB_E   variable/g CutRangeNum=3, FourSymCheck    make/t /o /n=10  tempT	if (stringmatch(WaveList("traceY","",""),"")==1 || stringmatch(WaveList("traceX","",""),"")==1)    	make/d/o/n = 10 traceY, traceX   endif   if (stringmatch(WaveList("DOS","",""),"")==1)    	make/d/o/n = 10 DOS   endif   if (stringmatch(WaveList("memoT","",""),"")==1)    	make/t /o /n=51  memoT   endif     // FS rotation variables   string/g kxwaveRota, kywaveRota, FScolor  variable/g SliceAngle, RotaAngle, offXrota, offYrota, RotaXspacing, Theta  variable/g GapMaxDwave, GapBvalue, RotaChecked, FSInvertCheck, FSGammaval=1   variable/g offTheta, offPhi, offpsi, FSBlankInt  variable/g FSsavecheck, saveNo_FS, MapRotaPiAngle=1, maltiplesize=1, scientaAngle  string/g saveNo_memoFS, UseparaFSMapstr="FSmapping", NewRotaMapName, FSbrankstr="zero"  make/o/t/n=51 memoT_FS  make/d/o/n=50 Rotakx_a1, Rotakx_b1, Rotakx_c1, Rotakx_d1  make/d/o/n=50 Rotakx_a2, Rotakx_b2, Rotakx_c2, Rotakx_d2  make/d/o/n=50 Rotaky_a1, Rotaky_b1, Rotaky_c1, Rotaky_d1  make/d/o/n=50 Rotaky_a2, Rotaky_b2, Rotaky_c2, Rotaky_d2       // Self Energy   string/g ReSigma_modi, ImSigma_modi   variable/g SelfMap_Kpoints, SelfMap_Epoints, SelfMap_C=1, SelfMap_EminFL=-0.1, SelfMap_EminML=-0.1, modeFLML=1   variable/g SelfMap_Emin1, SelfMap_Emin2, SelfMap_Emin3   variable/g SelfMap_ki, SelfMap_kf, SelfMap_Ei, SelfMap_Ef, SelfMap_VF, SelfMap_VF_eVA, SelfMap_T   string/g wMDCstr, enMDCstr   variable/g SelfMap_aFL, SelfMap_cFL, SelfMap_aML, SelfMap_cML, SelfMap_kFermi=0.1, SelfMap_Erange=1, SelfMap_VF_Erange   variable/g SelfMap_a1, SelfMap_b1, SelfMap_c1, SelfMap_a2, SelfMap_b2, SelfMap_c2, SelfMap_a3, SelfMap_b3, SelfMap_c3   variable/g LinearBandCheck, DataModelCheck, Self_SliceAngle, Self_Piangle   string/g ImXstr, ImYstr   variable/g InputImCheck   if (stringmatch(WaveList("selfMap","",""),"")==1)    	make/d/o/n=(101,101)  selfMap   endif   if (stringmatch(WaveList("selfEDC","",""),"")==1)    	make/d/o/n=(101) selfEDC   endif   	// Globals for ARPES line correction	//variable/g Psival, Thetaval, Phival, Thetafrom, Thetato,ThetaStep,ARPESPiAngle , ARPESRotaAngle		variable/g ScientaPsival, ScientaThetaval, ScientaPhival, ScientaThetaFrom, ScientaThetaTo, ScientaThetaStep	  variable/g  ScientaPiAngle , ScientaRotaAngle, saveNo_Scienta, ScientaSavecheck, ImAxisCurveSlice, ImAxisCurveRange, ImAxis_MDCflag	  string/g saveNo_memoScienta	  make/o/t/n=51 memoT_Scienta		// Globals for Combo		variable/g sgAll, stAll, numAll, offAll   variable/g combo_Usecursor_chk, combo_Userange_chk, Combo_rangeEi, Combo_rangeEf      if (stringmatch(WaveList("Combo_color=","",""),"")==1)    	make/t/o/n=13 Combo_color="(65535,0,0)"     endif						// Globals for ALS	variable/g GammaVal, InvertCheck, Gridkpoints, Gridepoints, ALShv1, ALShv2, ALSsliceDeg, ALSThetaOffset	variable/g ALSInner, ALSlattice_a, ALSlattice_c, ALSNormCheck, ALSsaveNo, ALSsavecheck	string/g ALScolor, saveNo_memoALS, NewALSMapName	make/o/t/n=51 memoT_ALS	  // Globals for Map Axis Correction   string/g  ImAxis_ImageName, ImAxis_NewImageName, ImAxis_color="Grays", ImAxis_saveNo_memo    variable/g  ImAxis_offset, ImAxis_oneSliceAngle, ImAxis_saveNo, ImAxis_PiAngle    variable/g ImAxis_InvertCheck, ImAxis_Gammaval, ImAxis_savecheck, ImAxis_saveNo     make/o/t/n=51 ImAxis_memoT       // get color table     string/g  color256listStr, ColorName, madeColorName     variable/g to_color, from_color, changeTo8bitCheckendmacro			Function    findwavenum ()	variable i=1, j, offset	string wavealready, Logname	string/g Goffstring 	wave GrAllNum, NrAllNum   do    	wavealready="gr"+num2istr(i)  		 if (i==1)   	Goffstring = "G0000"   	offset=0   	else   	Goffstring = "G"+num2istr(i-1)   	offset=i-1   	endif   	Logname = "LogG"+num2str(offset)   	if (offset==0)   	Logname+="000"   	endif 	 	 if (stringmatch((wavelist(wavealready,"","")),wavealready)==1)        	string/g  $Goffstring        		dowindow $Logname	          if (v_flag!=1)	           NewNotebook/W=(30,30,300,300) /F=0/N=$Logname /V=0	          endif   	    j=offset   	    do   	     wavealready="gr"+num2istr(j)   	     if (stringmatch((wavelist(wavealready,"","")),wavealready)==1)   	     GrAllNum[offset/1000]=j-offset   	     endif   	     wavealready="nr"+num2istr(j)   	     if (stringmatch((wavelist(wavealready,"","")),wavealready)==1)   	     NrAllNum[offset/1000]=j-offset   	     endif   	     j+=1   	   while (j<1000+offset)  		 endif  		 i+=1000   while (i<1000000) end	//////////////////////////////////////////////////////////		Procedures available from Macros-Menu		//////////////////////////////////////////////////////////// Menu "Macros"//	"Autoload/1"//	"NormScan/2"//	"Process Au"//	"New Experiment"// End///////////////////////////////////////////////// 		STANDARD FILE TREATEMENT		///////////////////////////////////////////////Macro NormScanMacro ( firstG, lastG, csr_1_he_2_so_3_prof_4_det_5  )	Variable  firstG=last_ff, lastG=last_lf,csr_1_he_2_so_3_prof_4_det_5=1	Variable mode		mode =csr_1_he_2_so_3_prof_4_det_5	NormScanFun( firstG, lastG, mode )EndMacro CalcDetect(graph)	variable graph	variable i,kpoints,epoints	variable total_ar,nb,det_start	string detcal	PauseUpdate;Silent 1	detcal = "gr" + num2istr(graph)	duplicate/o $detcal temp	epoints=dimsize(temp,0)	kpoints=dimsize(temp,1)	make /o/n=(epoints) temp1	total_ar=0	i=0	do		temp1=temp[x][i]		total_ar+=area(temp1,0,epoints)		i+=1	while(i<kpoints)	total_ar/=kpoints*epoints	i=0	do		temp1=temp[x][i]//		smooth 5,temp1		temp[][i]=temp1[x]/(1-0.0004*x)		i+=1	while(i<kpoints)	temp/=total_ar	detcal = "dt" + num2istr(graph)	duplicate /o temp $detcalEndMacroFunction processAu()	variable oldgraph, aucount,i,average,size	string nk,prof		NVAR scope_graph	WAVE au		oldgraph = scope_graph	aucount = dimsize(au,0)	for ( i=0; i<aucount; i+=1 )		scope_graph = au[i]		changescope()		scopebutton_nk(" ")		nk = "nk"+num2istr(scope_graph)		prof="prof"+num2istr(scope_graph)		duplicate/o $nk temp		size = dimsize(temp,0)		duplicate/o temp $nk		average = faverage(temp,0,size-1)		temp /= average		duplicate/o temp $prof		//print i	endfor	scope_graph = oldgraphend////////////////////////////////////////         IV and resistivity procedures////////////////////////////////////Macro LoadIV()loadIVfun()EndMacroFunction loadIVFun()	String  thewave, output	Variable WNum, scan,i,ext, nIV, nRT	string filename		loadwave /g/d/n/q		WNum = V_flag-1				make /o/n=(round(wnum/3)+1,2) tempif(wnum>1)temp[0][0]=0;temp[0][1]=0;		 i=0;scan=1		do			thewave = "wave"+num2istr(i)						duplicate /o $thewave temp1			temp[scan][]= temp1[y]			killwaves  $thewave			i+=1			thewave = "wave"+num2istr(i)			output="v"+num2istr(scan)			 duplicate/o  $thewave $output temp1			killwaves  $thewave			 			i+=1			thewave = "wave"+num2istr(i)			output="i"+num2istr(scan)			 duplicate/o  $thewave $output temp2 temp3			killwaves  $thewave						thewave = "r"+num2istr(scan)			temp3=temp1/temp2			duplicate /o temp3 $thewave			thewave = "pow"+num2istr(scan)			temp3=temp1*temp2			duplicate /o temp3 $thewave						 i+=1			scan+=1		while(i<Wnum)		duplicate /o temp temperelsekillwaves wave0endifnIV=scan-1//print "IV curves : ",nIV///////////////////// load RT file		ext=strsearch(S_filename,".txt",0)		filename=S_filename[0,ext-1]+"_temp"+S_filename[ext,strlen(S_filename)]		filename=S_path+filename		//print filename		loadwave /g/d/n/q filename		WNum = V_flag-1if(wnum>1)		 i=0;scan=1		do			thewave = "wave"+num2istr(i)			output="time"+num2istr(scan)			 duplicate/o  $thewave $output			killwaves  $thewave			 			i+=1			thewave = "wave"+num2istr(i)			output="RTT"+num2istr(scan)			 duplicate/o  $thewave $output			killwaves  $thewave			 			i+=1			thewave = "wave"+num2istr(i)			output="RTV"+num2istr(scan)			 duplicate/o  $thewave $output temp1			killwaves  $thewave			 i+=1						thewave = "wave"+num2istr(i)			output="RTI"+num2istr(scan)			 duplicate/o  $thewave $output temp2 temp3			killwaves  $thewave			 			i+=1						thewave = "rtr"+num2istr(scan)			temp3=temp1/temp2			duplicate /o temp3 $thewave									scan+=1		while(i<Wnum-1)		duplicate /o temp temperelsekillwaves wave0endifnRT=scan-1//print "RT curves : ",nRTEnd//################################////      Beam profile procedures////################################Macro LoadBeam()load_beam()endmacroFunction load_Beam()	NVAR	last_beam	WAVE beams	String  thewave, output	Variable WNum, scan,i, xsize, ysize	string beamname,xname		loadwave /g/d/n/q		WNum = V_flag-1if(wnum>1)			last_beam+=1		thewave="wave0"		duplicate /o $thewave temp1		beams[last_beam][]=temp1[y]//		killwaves wave0				ysize=dimsize(wave1,0)		xsize=Wnum-1;				xname="gx"+num2istr(last_beam)		make /o /n=(xsize) temp1		temp1=x*(beams[last_beam][10]*.025)+beams[last_beam][8]*0.025		duplicate /o temp1 $xname				make /o /n=(xsize,ysize) temp				for( i=0; i<Wnum;i+=1)			thewave = "wave"+num2istr(i+1)						duplicate /o $thewave temp1			temp[i][]= temp1[y]//			killwaves  $thewave		endfor		beamname="beam"+num2istr(last_beam)		duplicate /o temp $beamnameelsekillwaves wave0endif//print "Beam profile", last_beam, "X size=", xsize, "Y size=", ysizeendmacro calcbeam(bno)	variable bno	string beam	variable	total_int,xrange,yrange,xstep,ystep, scan_area		beam="beam"+num2istr(bno)	wavestats /q $beam		xrange=abs(beams[bno][5]-beams[bno][4])*0.0254	yrange=abs(beams[bno][8]-beams[bno][9])*0.0254	xstep=abs(beams[bno][6])*.0254	ystep=abs(beams[bno][10])*.0254	scan_area=xrange*yrange		total_int=V_npnts*V_avg/(0.75^2*pi)*xstep*ystep	//print "X:",xrange, xstep,"      Y:",yrange,ystep,"        Area:", scan_area	//print total_int/1000, " nA"	endmacro	/////////////////////////////////////////////		Standard Utility functions		////////////////////////////////////////////Function Data_type(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	String/g DispWave	if ( popnum==1 ) 		DispWave="gr"	elseif ( popnum==2 )		DispWave="nr"			elseif ( popnum==3 )		DispWave="ek"	elseif ( popnum==4 )		DispWave="difEDC"	elseif ( popnum==5 )		DispWave="difMDC"	elseif ( popnum==6 )		DispWave="cr"	elseif ( popnum==7 )		DispWave="dif"	endif		//if (stringmatch(dispwave,"gr"))		//SetVariable scopeoffset, limits={-Inf,Inf,100}		//elseif (stringmatch(dispwave,"gr")!=1)		//SetVariable scopeoffset, limits={-Inf,Inf,0.1}		//endif 	Endfunction getGraphDim( graph, dimNumber )	variable graph, dimNumber	string source_wave	SVAR dispwave	source_wave = DispWave+num2istr(graph)		if ( dimsize($source_wave,dimNumber) ==0)	return (1)	else 	return ( dimsize($source_wave,dimNumber) )		endifendFunction gmax(graph)	variable graph	WAVE map, graphlist			if ( map[graph][1]==0 )		//	VSW format		return ( graphlist[graph][0]-1 )	else								//	Scienta format		return ( (map[graph][1]-map[graph][0]+1)/2)-1	endifendfunction getef( graph, angle )// return Ef for graph or wave		variable graph, angle		WAVE map, efp		if ( map[graph][7]!=9999 ) 					return(map[graph][7])		else			return(efp[graph][angle+1])		endifendFunction waveoccur(wavenam)	string		wavenam	variable i, nwaves, occur		WAVE/T w_wavelist		nwaves=dimsize(w_wavelist,0)		i=0; occur=0	do		if(!cmpstr(w_wavelist[i][0],wavenam))			occur+=1		endif		i+=1	while(i<nwaves)	return(occur)end///////////////////////////////////		2D FUNCTIONS		//////////////////////////////////Function bzne(bzmap,ki_point, kf_point)   wave bzmap 	variable ki_point, kf_point	variable nx, ny, nz, i, Windex, Est, dE		string Xaxis	WAVE bz, map, ne2d	sVar dispwave	nx = dimsize(bz,0)	ny = dimsize(bz,1)	nz = dimsize(bz,2)	Windex=bzmap[0][0][0]	if ( stringmatch(dispwave,"cr"))		Xaxis = "cx"+num2istr(Windex)	else	Xaxis="gx"+num2istr(Windex)	endif	make /o/n=(ny,nz) ne2d	ne2d = 0	duplicate/o $Xaxis temp0	if ( stringmatch(dispwave,"gr") ||  stringmatch(dispwave,"nr") || stringmatch(dispwave,"dif"))	temp0-=map[Windex][7]	Est=temp0[nz-1]	dE=temp0[nz-2]-Est	endif	for ( i=ki_point; i<kf_point; i+=1 )				ne2d[][]+=bz[i][p][q]   endfor   print Est,dE   SetScale/P y Est,dE,"", ne2dEndFunction ACorr()variable qx,qy, nx, nyvariable kx, ky, kqx, kqyvariable intenWAVE nk2d	nx = dimsize(nk2d,0)	ny = dimsize(nk2d,1)	make /o/n=(2*nx,2*ny) qwave	qwave=0	for(qx=0;qx<2*nx; qx+=1)		//print qx		for(qy=0; qy<2*ny;qy+=1)		//print qy		inten=0	for(kx=-nx;kx<nx; kx+=1)		for(ky=-ny; ky<ny;ky+=1)			kqx=kx+qx			if(kqx>nx) 			kqx=nx-(kqx-nx)			endif			if(kqx<-nx)			 kqx=nx+(kqx-nx)			endif			kqy=ky+qy			if(kqy>ny)			 kqy=ny-(kqy-ny)			endif			if(kqy<-ny)			 kqy=ny+(kqy-ny)			endif			inten+=nk2d[abs(kx)][abs(ky)]*nk2d[abs(kqx)][abs(kqy)]		  endfor	endfor	qwave[qx][qy]=inten	endfor	endfor			end///////////////////////////////// //		Fit Functions		///////////////////////////////////Function Fermi(w,x) : FitFunc	Wave w	Variable x  return  w[3]+( w[4]*(x-w[0]) + w[2] ) / ( 1 + exp( (x-w[0])/w[1] ) )EndFunction Fermi_convolution (w,x)wave wVariable xwave wFermiVariable Gau,A,width,result,x0,x1,fermiNvar T_convovariable eV=1.6*10^-19variable KB=1.38*10^-23variable C=2*(2*ln(2))^0.5x0=hcsr(a)-wFermi[1]*3x1=hcsr(b)dofermi = 1/( 1+exp((x0-w[0])/(kB*T_convo/eV)) )Gau+=fermi*exp(-(x-x0)^2/(2*(w[1]/C)^2))  // W[1] is FWHM of Gause function.//Gau+=fermi*exp(-(x-x0)^2/(2*w[1]^2))  // W[1] is dispersion of Gause function.x0+=0.001while ( x0<x1)result= w[3] + (w[4]*(x-w[0]) +w[2])*Gaureturn (result) EndFunction power(w,x) :FitFunc	wave w	variable x	return abs(w[0]/abs((x))^2+w[1])EndFunction lorOne(w,x) :FitFunc	wave w	variable x	return abs(w[0])+abs(w[1])/((x-w[2])^2+(w[3]/2)^2)Endmacro mdcsep(w)	string w		make /o /n=47 fh1 fh2 fh3 fh4	fh1=  abs($w[1]*abs($w[3]))/((x-$w[2])^2+$w[3]^2)	fh2=  abs($w[4]*abs($w[6]))/((x-$w[5])^2+$w[6]^2)	fh3=  abs($w[7]*abs($w[9]))/((x-$w[8])^2+$w[9]^2)	fh4=  abs($w[10]*abs($w[12]))/((x-$w[11])^2+$w[12]^2)end	macro genlor()	make /o /n=4 temp	l=mdc(w,x)	temp[0]=0;temp[1]=w[1];temp[2]=w[2];temp[3]=w[3]	l1=lorentz(temp,x)	temp[0]=0;temp[1]=w[4];temp[2]=w[5];temp[3]=w[6]	l2=lorentz(temp,x)	temp[0]=0;temp[1]=w[7];temp[2]=w[8];temp[3]=w[9]	l3=lorentz(temp,x)	temp[0]=0;temp[1]=w[10];temp[2]=w[11];temp[3]=w[12]	l4=lorentz(temp,x)endmacro lor4()	duplicate /o buttwave1 temp, temp1, temp2, temp3, buttwave10	w[0]=0;w[1]=l4[0][1];w[2]=l4[1][1];w[3]=l4[2][1]	temp=lorentz(w,x)	w[0]=0;w[1]=l4[0][2];w[2]=l4[1][2];w[3]=l4[2][2]	temp1=lorentz(w,x)	w[0]=0;w[1]=l4[0][3];w[2]=l4[1][3];w[3]=l4[2][3]	temp2=lorentz(w,x)	w[0]=0;w[1]=l4[0][4];w[2]=l4[1][4];w[3]=l4[2][4]	temp3=lorentz(w,x)	test=temp+temp1+temp2+temp3+l4[0][0]	return (0)EndFunction gauss2(w,x) :FitFunc	wave w	variable x	return abs(w[0])+abs(w[1])*exp(-((x-w[2])/w[3])^2)+abs(w[4])*exp(-((x-w[5])/w[6])^2)EndFunction gausscomb(w,x) :FitFunc	wave w	variable x	if(x<w[2])	return abs(w[0])+abs(w[1])/2/Pi*exp(-((x-w[2])/w[3])^2)	else	return(abs(w[0])+abs(w[1])/2/Pi*exp(-((x-w[2])/w[4])^2))	endifEnd//Function gauss(w,x) :FitFunc//	wave w//	variable x////	return abs(w[0])+abs(w[1])*exp(-((x-w[2])/w[3])^2)//EndFunction dlorentz(w,x)	wave w	variable x	variable f	f= abs(w[0])+abs(w[1]*5)/((x-w[2])^2+w[3]^2)+abs(w[4]*5)/((x-w[5])^2+w[3]^2)	return (f)EndFunction dgauss(w,x)	wave w	variable x	variable f	f= abs(w[0])+w[1]*exp(-((x-w[2])/w[3])^2)+w[4]*exp(-((x-w[5])/w[3])^2)	return (f)EndFunction Tsquare(wt,x)	wave wt	variable x	variable f	f= sqrt((wt[0]+wt[1]*x)^2+2.497^2)	return (f)End////////////////////////////////	Other Functions		///////////////////////////////Function vf()	string xwave, ywave	variable vf, startp, endp 	WAVE w_coef	ywave = csrxwave(A)	xwave = csrwave(A)		//print xwave, ywave	duplicate /o $xwave temp2	duplicate /o $ywave temp1	findlevel temp1,0	startp=xcsr(a)	endp=xcsr(b)	curvefit  line $ywave(startp, endp) /x=$xwave  /d	vf =abs(w_coef[1])	vf /= 0.25/22*0.807	//print abs(vf)	return ( abs(vf) )endFunction vfi()	string xwave, ywave	variable vf, startp, endp 	WAVE w_coef	xwave = csrxwave(A)	ywave = csrwave(A)		//print xwave, ywave	duplicate /o $xwave temp2	duplicate /o $ywave temp1	findlevel temp1,0	startp=xcsr(a)	endp=xcsr(b)	curvefit  line $ywave(startp, endp) /x=$xwave  /d	vf =abs(w_coef[1])	vf /= 0.25/22*0.807	//print abs(vf)	return ( abs(vf) )endFunction vfbn()	string xwave, ywave	variable vf, startp, endp 	WAVE w_coef	xwave = csrxwave(A)	ywave = csrwave(A)		duplicate /o $xwave temp1	duplicate /o $ywave temp2	findlevel temp1,0	curvefit /q line $ywave(xcsr(a), xcsr(b)) /x=$xwave/d	vf = abs(w_coef[1])	vf /= 0.807	//print abs(vf)	return ( abs(vf) )endfunction Enan(angle, energy)		variable angle, energy		return (180/pi*ASIN(SQRT((22-4.4)/(energy-4.4))*SIN(angle/180*pi)))endmacro rempos(band)	string band	variable i	PauseUpdate; Silent 1;	duplicate/o $band temp1	i=0;	do	if(temp1[i]>=0.001)		temp1[i]=nil	endif	i+=1	while(i<=dimsize(temp1,0))	duplicate/o temp1 $band		EndMacrofunction FS(kx)	variable kx	variable a = 0.12835, b = -0.595/2.0, c = 0.1636, d = -0.0519/2.0,e = -0.1107/2.0, f = 0.051	variable AA,BB,CC	kx*=Pi/22.0	CC=(a-d+(b-e)*cos(kx)+(d-f)*cos(2.0*kx))	BB=(b+c*cos(kx)+e*cos(2.0*kx))	AA=(2*d+2*f*cos(2.0*kx)+2.0*e*cos(kx))//	return( CC+BB*cos(ky)+AA*cos(ky)*cos(ky))	return(22.0/Pi*acos((-BB-sqrt(BB*BB-4.0*AA*CC))/2.0/AA))endmacro rotFS(wavex,wavey,angle)	string wavex,wavey	variable angle		duplicate/o $wavex temp1	duplicate/o $wavey temp2 			$wavex = cos(angle/360*6.28)*temp1 - sin(angle/360*6.28)*temp2	$wavey = sin(angle/360*6.28)*temp1 + cos(angle/360*6.28)*temp2EndMacro		macro resolution(width)	variable	width	variable epoints, i//	WAVE temp, temp1, temp2 , w		duplicate /o temp temp1 temp2	make /o /n=4 w	epoints=dimsize(temp,0)		w[0]=0;w[1]=1;w[3]=width	temp2=0	i=0	do		w[2]=i		temp1=gauss(w,x)		temp1*=temp		temp2[i]=area(temp1,0,epoints)		i+=1	 while(i<epoints)end				///////////////////////////////////		Window Macros		//////////////////////////////////Window efpos() : Graph	PauseUpdate; Silent 1		// building window...	Display /W=(6,398,536,746) 	ShowInfoEndMacroWindow efwidth() : Graph	PauseUpdate; Silent 1		// building window...	Display /W=(6,398,536,746) 	ShowInfoEndMacroWindow nk() : Graph	PauseUpdate; Silent 1		// building window...	Display ///W=(21,83,358,602)//	ModifyGraph rgb(nk45)=(0,0,65535)	ShowInfoEndMacroWindow nw() : Graph	PauseUpdate; Silent 1		// building window...	Display /W=(5,42,400,250)EndMacroWindow FWHM() : Graph	PauseUpdate; Silent 1		// building window...	Display /W=(282,409,528,595) 	Textbox/N=text0/F=0/A=MC/X=-20.00/Y=46.00 " \r Graph 38 T=0K hv=0 Angle=(0,0)"EndMacro////////////////////////////////////////////////	Condensation Energy and Procedures		////////////////////////////////////////////////Window condEn() : Graph	PauseUpdate; Silent 1		// building window...	Display /W=(325,85,712,627) mom1 vs momx1	AppendToGraph mom2 vs momx2	AppendToGraph mom3 vs momx3	AppendToGraph mom4 vs momx4	ModifyGraph rgb(mom2)=(65535,49157,16385),rgb(mom3)=(16386,65535,16385),rgb(mom4)=(1,16019,65535)	SetAxis left -0.000652252279989014,0.00442857826472108	SetAxis bottom -0.759481648452409,0.198151939333851	Legend/J/N=text0/F=0/A=MC/X=33.70/Y=3.12 "\\s(mom1) mom1\r\\s(mom2) mom2\r\\s(mom3) mom3\r\\s(mom4) mom4"	ShowTools	SetVariable setvar0,pos={198,39},size={69,17},proc=showmoments,title="NS 3"	SetVariable setvar0,limits={-Inf,Inf,1},value= K4	SetVariable setvar0_1,pos={271,7},size={69,17},proc=showmoments,title="SC 1"	SetVariable setvar0_1,limits={-Inf,Inf,1},value= K1	SetVariable setvar0_2,pos={198,23},size={69,17},proc=showmoments,title="NS 2"	SetVariable setvar0_2,limits={-Inf,Inf,1},value= K2	SetVariable setvar0_3,pos={198,7},size={69,17},proc=showmoments,title="NS 1"	SetVariable setvar0_3,limits={-Inf,Inf,1},value= K0	SetVariable setvar0_4,pos={198,55},size={69,17},proc=showmoments,title="NS 4"	SetVariable setvar0_4,limits={-Inf,Inf,1},value= K6	SetVariable setvar0_5,pos={271,23},size={69,17},proc=showmoments,title="SC 2"	SetVariable setvar0_5,limits={-Inf,Inf,1},value= K3	SetVariable setvar0_6,pos={271,39},size={69,17},proc=showmoments,title="SC 4"	SetVariable setvar0_6,limits={-Inf,Inf,1},value= K5	SetVariable setvar0_7,pos={271,55},size={69,17},proc=showmoments,title="SC 3"	SetVariable setvar0_7,limits={-Inf,Inf,1},value= K7	Button button0,pos={0,187},size={50,20},proc=graphcond,title="Graph"EndProc showmoments(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	PauseUpdate;Silent 1	string wns1,wns2,wns3,wns4,wsc1,wsc2,wsc3,wsc4	string wnsx1,wnsx2,wnsx3,wnsx4,wscx1,wscx2,wscx3,wscx4	string bs1,bs2,bs3,bs4,bn1,bn2,bn3,bn4	variable off1, off2, off3, off4	variable ef1,ef2,ef3,ef4		wns1="buttwave"+num2istr(K0);wsc1="buttwave"+num2istr(K1);	wns2="buttwave"+num2istr(K2);wsc2="buttwave"+num2istr(K3);	wns3="buttwave"+num2istr(K4);wsc3="buttwave"+num2istr(K5);	wns4="buttwave"+num2istr(K6);wsc4="buttwave"+num2istr(K7);	wnsx1="buttx"+num2istr(K0);	wnsx2="buttx"+num2istr(K2);	wnsx3="buttx"+num2istr(K4);wnsx4="buttx"+num2istr(K6)	bn1="butt_gr"+num2istr(K0);bn2="butt_gr"+num2istr(K2);bn3="butt_gr"+num2istr(K4);bn4="butt_gr"+num2istr(K6);	bs1="butt_gr"+num2istr(K1);bs2="butt_gr"+num2istr(K3);bs3="butt_gr"+num2istr(K5);bs4="butt_gr"+num2istr(K7);if((K0>0) %& (K0<11) %& (K1>0) %& (K1<11))	off1=(map[$bn1][7]-map[$bs1][7])/0.002;	duplicate /o $wnsx1 mom1 momx1	findlevel momx1,0	ef1=V_levelx	momdif=($wns1[x]-$wsc1[x-off1])*$wnsx1[x];mom1=1000*area(momdif,x,ef1)*0.002	//print "ok1"else 	duplicate /o zerowave mom1endifif((K2>0) %& (K2<11) %& (K3>0) %& (K3<11))	off2=(map[$bn2][7]-map[$bs2][7])/0.002;	duplicate /o $wnsx2 mom2 momx2	findlevel momx2,0	ef2=V_levelx	momdif=($wns2[x]-$wsc2[x-off2])*$wnsx2[x];mom2=1000*area(momdif,x,ef2)*0.002else 	duplicate /o zerowave mom2endifif((K4>0) %& (K4<11) %& (K5>0) %& (K5<11))	off3=(map[$bn3][7]-map[$bs3][7])/0.002;	duplicate /o $wnsx3 mom3 momx3	findlevel momx3,0	ef3=V_levelx	momdif=($wns3[x]-$wsc3[x-off3])*$wnsx3[x];mom3=1000*area(momdif,x,ef3)*0.002else 	duplicate /o zerowave mom3endifif((K6>0) %& (K6<11) %& (K7>0) %& (K7<11))	off4=(map[$bn4][7]-map[$bs4][7])/0.002	duplicate /o $wnsx4 mom4 momx4	findlevel momx4,0	ef4=V_levelx	momdif=($wns4[x]-$wsc4[x-off4])*$wnsx4[x];mom4=1000*area(momdif,x,ef4)*0.002else 	duplicate /o zerowave mom4endifEndProc graphcond(ctrlname) : ButtonControl	string	ctrlname	variable i,offs	string source,dest,descriptor,destxax,sourcexax	string legtext,name,values	pauseUpdate; Silent 1		display		offs=0	legtext=""if((K0>0) %& (K0<11) %& (K1>0) %& (K1<11))			dest="Mom_"+num2istr(butt_graph[K0])+"_"+num2istr(butt_graph[K1]);			destxax="Mom_"+num2istr(butt_graph[K0])+"_"+num2istr(butt_graph[K1])+"x" 			duplicate /o mom1 $dest			duplicate /o momx1 $destxax			appendtograph $dest vs $destxax			ModifyGraph rgb($dest)=(0,0,0)			ModifyGraph lsize($dest)=0.5				name="\\s(mom_"+num2istr(i)+") "				sprintf values "\\Z10\\s(%s) %s: %gK => %gK, %geV, (%g,%g)",dest,dest,map[butt_graph[K0]][3],map[butt_graph[K1]][3],map[butt_graph[K0]][4],map[butt_graph[K0]][5],map[butt_graph[K0]][6]				legtext+=values				legtext+="\r"endifif((K2>0) %& (K2<11) %& (K3>0) %& (K3<11))			dest="Mom_"+num2istr(butt_graph[K2])+"_"+num2istr(butt_graph[K3]);			destxax="Mom_"+num2istr(butt_graph[K2])+"_"+num2istr(butt_graph[K3])+"x" 			duplicate /o mom2 $dest			duplicate /o momx2 $destxax			appendtograph $dest vs $destxax			ModifyGraph rgb($dest)=(0,0,0)			ModifyGraph lsize($dest)=0.5				name="\\s(mom_"+num2istr(i)+") "				sprintf values "\\Z10\\s(%s) %s: %gK => %gK, %geV, (%g,%g)",dest,dest,map[butt_graph[K2]][3],map[butt_graph[K3]][3],map[butt_graph[K2]][4],map[butt_graph[K2]][5],map[butt_graph[K2]][6]				legtext+=values				legtext+="\r"endifif((K4>0) %& (K4<11) %& (K5>0) %& (K5<11))			dest="Mom_"+num2istr(butt_graph[K4])+"_"+num2istr(butt_graph[K5]);			destxax="Mom_"+num2istr(butt_graph[K4])+"_"+num2istr(butt_graph[K5])+"x" 			duplicate /o mom3 $dest			duplicate /o momx3 $destxax			appendtograph $dest vs $destxax		   ModifyGraph rgb($dest)=(0,0,0)			ModifyGraph lsize($dest)=0.5					name="\\s(mom_"+num2istr(i)+") "				sprintf values "\\Z10\\s(%s) %s: %gK => %gK, %geV, (%g,%g)",dest,dest,map[butt_graph[K4]][3],map[butt_graph[K5]][3],map[butt_graph[K4]][4],map[butt_graph[K4]][5],map[butt_graph[K4]][6]				legtext+=values				legtext+="\r"endifif((K6>0) %& (K6<11) %& (K7>0) %& (K7<11))			dest="Mom_"+num2istr(butt_graph[K6])+"_"+num2istr(butt_graph[K7]);			destxax="Mom_"+num2istr(butt_graph[K6])+"_"+num2istr(butt_graph[K7])+"x" 			duplicate /o mom4 $dest			duplicate /o momx4 $destxax			appendtograph $dest vs $destxax			ModifyGraph rgb($dest)=(0,0,0)			ModifyGraph lsize($dest)=0.5				name="\\s(mom_"+num2istr(i)+") "				sprintf values "\\Z10\\s(%s) %s: %gK => %gK, %geV, (%g,%g)",dest,dest,map[butt_graph[K6]][3],map[butt_graph[K7]][3],map[butt_graph[K6]][4],map[butt_graph[K6]][5],map[butt_graph[K6]][6]				legtext+=values				legtext+="\r"endif	textbox/k/n=text0	Legend/F=0/J/N=text0/A=MC/X=-10/Y=40 legtext		ModifyGraph lSize=0.5	ModifyGraph rgb=(0,0,0)	ModifyGraph tick=2	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph sep=10	ModifyGraph lblMargin(left)=7	ModifyGraph axOffset(left)=-0.571429	ModifyGraph lblLatPos(left)=6	Label left "\\Z14\\F'Times'First moment (meV)"	Label bottom "\\Z14\\F'Times'Energy (eV)"End/////////////////////////////////////////////		AutoGraph related functions		////////////////////////////////////////////Window AutoGraph() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(950,338,1181,779)	ModifyPanel cbRGB=(65535,65532,16385)	SetDrawLayer UserBack	SetDrawEnv linethick= 3	DrawLine 11,174,223,174	SetDrawEnv linethick= 3	DrawLine 12,146,221,146	SetDrawEnv linethick= 3	DrawLine 10,96,220,96	SetDrawEnv fillfgc= (65535,32764,16385)	SetDrawEnv save	SetDrawEnv linethick= 3	DrawLine 7,49,223,49	SetDrawEnv linethick= 3	DrawLine 9,382,223,382	SetDrawEnv linethick= 3	DrawLine 9,387,224,387	SetDrawEnv linethick= 3	DrawLine 9,265,222,265	SetDrawEnv linethick= 3	DrawLine 10,313,223,313	SetVariable setvar0,pos={15,123},size={89,18},proc=ScopeButton_ChangeGraph,title="Graph"	SetVariable setvar0,limits={0,inf,1},value= scope_graph	SetVariable setvar1,pos={101,153},size={64,18},proc=ScopeButton_ChangeGraph,title="Interp"	SetVariable setvar1,limits={1,10,1},value= interp_scope	SetVariable setvar2,pos={12,203},size={72,18},proc=ScopeButton_ChangeScopeParam,title="Angle"	SetVariable setvar2,limits={0,inf,1},value= scope_angle	SetVariable setvar3,pos={10,223},size={73,18},proc=ScopeButton_SetRange,title="Range"	SetVariable setvar3,limits={0,inf,1},value= scope_range	SetVariable scopeoffset,pos={86,243},size={91,18},proc=ScopeButton_offset,title="Offset"	SetVariable scopeoffset,limits={-inf,inf,0.1},value= scope_offs	SetVariable setvar5,pos={10,243},size={73,18},proc=ScopeButton_ChangeScopeParam,title="Smooth"	SetVariable setvar5,limits={0,100,1},value= scope_smooth	SetVariable setvar9,pos={86,223},size={65,18},proc=ScopeButton_mean,title="Mean"	SetVariable setvar9,limits={1,11,2},value= scope_mean	SetVariable setvar7,pos={80,101},size={111,18},proc=change_dispwave,title="dispwave"	SetVariable setvar7,value= dispwave	Button button2,pos={130,180},size={42,20},proc=ScopeButton_scopegraph,title="Graph"	Button button3,pos={14,268},size={42,20},proc=ScopeButton_fermi,title="Fermi"	Button button10,pos={60,180},size={38,20},proc=ScopeButton_ShowScope,title="Show"	Button button11,pos={51,151},size={44,20},proc=ScopeButton_Show2d,title="Show"	CheckBox check0_1,pos={12,152},size={34,15},proc=ScopeButton_Check2D,title="2D"	CheckBox check0_1,value= 1	CheckBox check0_2,pos={12,182},size={53,15},proc=ScopeButton_CheckScope,title="Scope"	CheckBox check0_2,value= 1	CheckBox check0,pos={178,245},size={41,15},proc=ScopeButton_CheckOffset,title="diffe"	CheckBox check0,value= 0	PopupMenu popup0,pos={7,100},size={52,21},proc=Data_type,title=" "	PopupMenu popup0,mode=3,popvalue="raw",value= #"\"raw;norm;Ek;EDC2nd;MDC2nd;combo;dif\""	Button LoadDataButton,pos={9,3},size={58,21},proc=LoadDataFunc,title="Load"	Button NormScan,pos={13,53},size={52,21},proc=NormScanFunc,title="Norm"	Button button03,pos={172,151},size={42,20},proc=ScopeButton_2Dimage,title="Graph"	CheckBox auto,pos={69,6},size={42,15},proc=autloadCheck,title="auto",value= 0	PopupMenu EFpopup,pos={111,270},size={53,21},proc=EFpopupFunc	PopupMenu EFpopup,mode=2,popvalue="aup1",value= #"\"_none_;\" + WaveList(\"aup*\",\";\",\"\")"	PopupMenu LoadNote,pos={114,3},size={65,21},proc=LoadNotePopup	PopupMenu LoadNote,mode=1,popvalue="_none_",value= #"\"_none_;\" + WinList(\"Log*\",\";\",\"\")"	CheckBox Sym,pos={176,191},size={42,15},proc=SymCheckProc,title="Sym",value= 0	SetVariable Filename,pos={8,28},size={209,18},disable=2,title="Last"	SetVariable Filename,value= Lastpathinfo	PopupMenu ListGoffset,pos={117,122},size={103,21},proc=ListGoffsetproc,title="Goffset"	PopupMenu ListGoffset,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	CheckBox Allcheck,pos={176,177},size={31,15},proc=AllcheckProc,title="All"	CheckBox Allcheck,value= 1	Button InfoCheck,pos={181,3},size={34,20},proc=InfoCheckProc,title="Info"	SetVariable AddSetvalue,pos={86,203},size={65,18},proc=ScopeButton_Add,title="Add"	SetVariable AddSetvalue,limits={1,inf,1},value= scope_add	Button EfvalueBotton,pos={176,269},size={38,20},proc=EfinputFunc,title="EF"	PopupMenu changeValue,pos={147,221},size={50,21},proc=ValmenuFunc,title=" "	PopupMenu changeValue,mode=2,popvalue="0.1",value= #"\"0.01;0.1;1;10;100;1000;10000\""	Button button12,pos={103,180},size={22,20},proc=ResetProc,title="Re"	CheckBox auto1,pos={88,75},size={42,15},proc=autNormCheck,title="auto",value= 1	SetVariable setvar8,pos={133,53},size={87,18},disable=2,title="Initial"	SetVariable setvar8,limits={-inf,inf,0.1},value= NormEi	SetVariable setvar4,pos={133,74},size={87,18},disable=2,title="final"	SetVariable setvar4,limits={-inf,inf,0.1},value= NormEf	SetVariable setvar6,pos={70,54},size={62,18},disable=2,title="Mode"	SetVariable setvar6,limits={1,3,1},value= NormMode	CheckBox Sym1,pos={176,205},size={50,15},proc=FermiCheckProc,title="Fermi"	CheckBox Sym1,value= 0	CheckBox check1,pos={62,271},size={50,15},proc=ScopeButton_CheckConbo,title="convo"	CheckBox check1,value= 1	Button button5,pos={133,338},size={32,20},proc=NewBzFunc	PopupMenu BZpopup,pos={69,320},size={65,21},proc=BZpopupFunc	PopupMenu BZpopup,mode=1,popvalue="_none_",value= #"\"_none_;\" + WaveList(\"bzmap*\",\";\",\"\")"	Button button06,pos={36,319},size={28,20},proc=BzGoFunc,title="Go"	SetVariable InterpX,pos={11,363},size={79,18},proc=InterpBzFunc,title="Interp: X"	SetVariable InterpX,limits={1,50,1},value= interpX_Bz	SetVariable setvar07,pos={68,343},size={61,18},proc=BzErangeFunc,title="dE"	SetVariable setvar07,limits={0.001,1,0.01},value= BzErange	SetVariable setvar08,pos={12,343},size={56,18},proc=BzEnergyFunc,title="E"	SetVariable setvar08,limits={-inf,inf,0.005},value= BzEnergy	Button button17,pos={142,359},size={72,20},proc=DrawProc,title="Draw Opt."	Button ButtonGraph,pos={11,394},size={36,20},proc=ButtonProc,title="Butt"	Button Combo,pos={52,394},size={34,20},proc=ComboProc,title="Cmb"	Button Graphmodify,pos={92,394},size={26,20},proc=GraphmodifyProc,title="GM"	SetVariable InterpY,pos={90,362},size={47,18},proc=InterpBzFunc,title="Y"	SetVariable InterpY,limits={1,20,1},value= interpY_Bz	Button OtherOpion,pos={168,416},size={41,20},proc=OtherOptionProc,title="Other"	Button Register,pos={124,394},size={23,20},proc=Rfunc,title="Re"	Button button4,pos={172,338},size={42,20},proc=BZgraphFunc,title="Graph"	SetVariable InterpY1,pos={171,320},size={47,18},proc=BzmapDimFunc,title="D"	SetVariable InterpY1,limits={1,inf,1},value= BzmapDimsize	Button ProPop,pos={11,417},size={149,20},proc=ScientShowFunc,title="ScientaProcedures.ipf"	Button ButtonGraph1,pos={153,394},size={24,20},proc=FSProc,title="FS"	Button button07,pos={11,319},size={19,20},proc=ShowMapFunc,title="S"	Button ButtonMapCorr,pos={183,394},size={27,20},proc=ImageAxisCorrProc,title="IM"	SetVariable DateInfo,pos={17,292},size={186,18},disable=2,title="Progress"	SetVariable DateInfo,value= FermiPassageStr	Button button18,pos={194,101},size={28,19},proc=Deriva2ndproc,title="2nd"EndMacroFunction ScopeButton_CheckConbo (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR Convo_Check	Convo_Check = checkedEndProc ImageAxisCorrProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f ImageAxisCorr	if (V_flag!=1)	ImageAxisCorr()	endifEndProc ShowMapFunc (ctrlName) : ButtonControl	String ctrlName	//svar bzname	silent 1 ; pauseupdate	dowindow/f Bztable	if (V_flag!=1)		edit/W=(50,50,400,500) $bzname	  dowindow/c Bztable	endif	dowindow/f Mapping	if (V_flag!=1)    abort "You need Go."	endifEndFunction FermiCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	variable FWHM	string Yes_No	Nvar Auto_FWHM_Convo	Svar Auto_Yes_No_Convo	nvar Fermicheck  Fermicheck=checked  if (Fermicheck)       Yes_No = Auto_Yes_No_Convo       Prompt Yes_No, "Do you use convolution?", popup ,"Yes"+";No"       Doprompt "Choose option.", Yes_No       if (V_Flag)   	  		  return -1// User canceled   		 endif   			Auto_Yes_No_Convo =  Yes_No       if (stringmatch(Yes_No,"Yes"))            FWHM=Auto_FWHM_Convo            Prompt FWHM, "Input FWHM of Gausian [meV]"            Doprompt "Convolution Gausian Width.", FWHM            if (V_Flag)   	  				return -1// User canceled   					endif             Auto_FWHM_Convo=FWHM       endif   endif  dowindow Graph_scope   if (V_flag==1)   ChangeScope()   if (checked!=1)   SetAxis/A/w=graph_scope   endif  endif  dowindow Graph_Image  if (V_flag==1)   Scope_Change2D()    if (checked!=1)   ModifyImage/w=graph_image akw2d ctab= {*,*,Rainbow,1}   endif   endifEndFunction NormScanFunc (ctrlName) : ButtonControlString ctrlNamevariable firstG, lastG, offset, mode=1, Erangevariable checkIntNorm=0Nvar lastNorm_ff, lastNorm_lf, GoffsetNorm, autNormChecked, Erange_backNvar NormEi, NormEf, NormMode, scopeNowsvar Goffsetstring, Gmodestring, EorPstrwave NrAllNum, GrAllNum, mapstring offsetstring, modestring, offsetstr, theX, EorPstring scheme=""Erange=Erange_backoffsetstring=Goffsetstring, modestring=Gmodestring, EorP=EorPstrfirstG=lastNorm_ff; lastG=lastNorm_lf; offset=GoffsetNormif (autNormChecked==1)  firstG+=offset  lastG+=offset  mode= NormModeelse	dowindow/f Graph_scope 	if (V_flag!=1)  	  abort "Show Scope_Graph" 	endif 	if (stringmatch(CsrWave(a),"") || stringmatch(CsrWave(b),"")) 	      Abort "Set A and B cursors!!" 	else  	endif 	if (GoffsetNorm==0) 		  offsetstr = "G0000" 	else 	  offsetstr = "G"+num2str(GoffsetNorm) 	endif 	scheme+="0: Area (total)" 	scheme+=";1: Area (slice)" 	scheme+=";2: Area after subtractcing background"  scheme+=";3: Use slope of background"	  scheme+=";4: Area then subtract background"  scheme+=";5: Do nothing-copy raw data"  scheme+=";6: For may 2011 SRC require temp_3"  scheme+=";7: Area with fit"  scheme+=";8: Using slope of backgroud with fit"  scheme+=";9: From Au data"  scheme+=";10: High energy data fit"   Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")     Prompt firstG, "First No.: "       Prompt lastG, "End No.: "    Prompt modestring, "chose scheme: ", popup ,scheme   Prompt EorP, "Energy or Point ?", popup ,"Energy"+";Point"   Doprompt "Norm Data Number", offsetstr,firstG, lastG, modestring, EorP   if (V_Flag)   	  return -1// User canceled    endif    mode=str2num(modestring)   if (mode==2 || mode==4)      Prompt Erange "Energy range for background (eV): "      Doprompt "Background energy range", Erange   endif   	sscanf offsetstr, "G%f", offset   Erange_back=Erange  lastNorm_ff=firstG; lastNorm_lf=lastG; GoffsetNorm=offset  Gmodestring=modestring  EorPstr = EorP  firstG+=offset  lastG+=offset  if (stringmatch(EorP,"Energy"))   theX = "gx"+num2istr(scopeNow)   duplicate/o $theX temp   NormEi = temp[pcsr(a)] ; NormEf = temp[pcsr(b)]  else   NormEi = pcsr(a) ; NormEf = pcsr(b)  endif    NormMode=modeendif   NormScan( firstG, lastG, mode, offset, EorP, Erange)  if(checkIntNorm==1)  TaltalIntNorm( firstG, lastG)  endif  dowindow/f AutographendFunction  NormScan( firstG, lastG, mode, offset, EorP, Erange)	Variable firstG, lastG,mode, offset	string EorP	variable Erange	Variable graph, graphepoints, graphkpoints, PixelA, PixelB	Variable wavenorm, wavenorm_back, epoints, kpoints, i, renorm	variable dE, dP	String theGraph, theX, theNorm, Logname, logtext	WAVE profile, map, W_coef, scopex, NrAllNum, temp_3, temp_4, norm_slices	Nvar NormEi, NormEf, NormMode, scopeNow    //dE = abs(hcsr(b) - hcsr(a))    //dP = abs(pcsr(b) - pcsr(a))    //dE/=dP    variable AuGraphN    string AuImg    string fitAustr="no"    nvar scope_graph    AuGraphN=scope_graph    	if (mode==9)    		Prompt AuGraphN "Au graph number: "    		Prompt fitAustr , "Poly fit Au data ?", popup ,"no"+";yes"     		Doprompt "Au graph number", AuGraphN, fitAustr      		AuImg="gr"+num2istr(AuGraphN)      		duplicate/o $AuImg temp4      		make /o /n=(dimsize(temp4,0)) temp5      		EorP="Point"    	endif    	for ( graph=firstG; graph <= lastG; graph+=1 )			theGraph = "gr"+num2istr(graph)		//theGraph = "nr"+num2istr(graph)		theX = "gx"+num2istr(graph)		theNorm = "nr"+num2istr(graph)				duplicate /o $theGraph temp1		duplicate /o $theX temp2		dE = abs(temp2[0]-temp2[1])		if (stringmatch(EorP,"Energy"))		  findlevel/q temp2, NormEi		  PixelA = V_levelX		  findlevel/q temp2, NormEf		  PixelB = V_levelX		else		  PixelA = NormEi		  PixelB = NormEf		endif 				if (stringmatch(num2str(V_levelX),"nan")==1)	   	  PixelB = numpnts(temp2)		endif		epoints = dimsize(temp1,0)		kpoints = dimsize(temp1,1)	 	if (kpoints==0)		  kpoints =1 		endif				make /o /n=(epoints) temp3		make/o/n=(kpoints) norm_slices		wavenorm=0;renorm=0	 		for ( i=0; i<kpoints; i+=1 )			if (dimsize(temp1,1)==0)		 	temp3[] = temp1[x]		 	else			temp3[] = temp1[x][i]      			endif      			      			if (mode==9)      				if (dimsize(temp4,1)==0)		 			temp5[] = temp4[x]		 		else					temp5[] = temp4[x][i]      				endif      			endif      			      			if (mode==0)      				wavenorm += faverage(temp3,PixelA,PixelB)      			endif      			      			if (mode==9)      				wavenorm = faverage(temp5,PixelA,PixelB)      				if(stringmatch(fitAustr, "yes"))      				norm_slices[i]=wavenorm      				else      				temp3 /= wavenorm      				endif      			endif      			      			if ( mode==1 ||  mode==3)				wavenorm = faverage(temp3,PixelA,PixelB)				temp3 /= wavenorm			elseif(mode==2)			  	//wavenorm_back = faverage(temp3,epoints-25,epoints) 				wavenorm_back = faverage(temp3,epoints-Erange/dE,epoints) 				temp3 -= wavenorm_back 				wavenorm = faverage(temp3,PixelA,PixelB)				temp3 /= wavenorm					elseif(mode==4)	  	  		wavenorm = faverage(temp3,PixelA,PixelB)	  	  		temp3 /= wavenorm					wavenorm_back = faverage(temp3,epoints-Erange/dE,epoints) 				temp3 -= wavenorm_back 		 	elseif(mode==5)				temp3 /= 1			elseif(mode==6)		             temp3 -=temp_4[i]		             temp3 /=temp_3[i]		 	elseif(mode==7 ||  mode==8 || mode==10)		             wavenorm = faverage(temp3,PixelA,PixelB)		             norm_slices[i]=wavenorm    			endif					if (dimsize(temp1,1)==0)		      		 temp1[]=temp3[p] 		  	else		 		  temp1[][i]=temp3[p]			endif		 			 	map[graph][8] = 0		 endfor   				if (mode==0)			 temp1= temp1/wavenorm		endif				if(mode==7 ||  mode==8)        		curvefit/q poly 10, norm_slices        		for ( i=0; i<kpoints; i+=1 )         		temp1[][i]/=poly(w_coef,i)      			endfor     		endif     		     		if(mode==9)     			if(stringmatch(fitAustr, "yes"))        		curvefit/q poly 10, norm_slices        		norm_slices/=poly(w_coef,p)         		temp1=temp1[p][q]/norm_slices[q]         		endif     		endif     		if(mode==10)     			curvefit/q poly 10, norm_slices        		norm_slices/=poly(w_coef,p)         		temp1=temp1[p][q]/norm_slices[q]     		endif		   		if( (mode==3 ||  mode==8) && dimsize(temp1,1)!=0)      			make /o /n=(epoints) temp2      			make /o /n=(epoints) temp3      			temp2 = 0					for ( i=0; i<kpoints; i+=1 )         			temp2[]+= temp1[x][i]      			endfor         	       	  	temp2[]/=kpoints      			CurveFit/q line  temp2[PixelA,PixelB] 			temp2[] = W_coef[0]+W_coef[1]*p      			      			for ( i=0; i<kpoints; i+=1 )         			temp3[] = temp1[p][i] - temp2[p]         			//wavenorm_back =  faverage(temp3,PixelA,PixelB)         			//temp1[][i]=temp3[p]-wavenorm_back         			temp1[][i]=temp3[p]      			endfor   		   		endif 	    	duplicate /o temp1 $theNorm		if (NrAllNum[offset/1000]< graph-offset)			NrAllNum[offset/1000]=graph-offset	 	endif	endfor	lastG = graph-1	Logname="LogG"+num2istr(offset)	if (offset==0)   		Logname+="000" 	 endif	dowindow/f $Logname	if (v_flag!=1)	   NewNotebook/W=(30,30,1000,200) /F=0/N=$Logname/V=1	endif	notebook $Logname selection={endoffile, endoffile}	Notebook $Logname fSize=12   	logtext = "From: nr"+num2istr(firstG)+"\r"+ "To: nr"+num2istr(lastG)+"\r"	Notebook $Logname  text=logtext   	Notebook $Logname fSize=12   	logtext = "----------- Norm END of Goffset "+num2istr(offset)+" -----------\r\r"	Notebook $Logname  text=logtextendFunction  TaltalIntNorm( firstG, lastG)	Variable firstG, lastG	variable graph	string theGraph	for ( graph=firstG; graph <= lastG; graph+=1 )			theGraph = "nr"+num2istr(graph)				duplicate/o $theGraph temp		wavestats/q temp		temp/=V_avg		duplicate/o temp $theGraph	endforendFunction autNormCheck(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar autNormCheckedautNormChecked=checkedEnd				Function EfinputFunc (ctrlName) : ButtonControl	String ctrlName	Nvar  lastEF_ff, lastEF_lf, GoffsetEF, EfgraphNo, EFvalue  //Nvar  last_ff, last_lf, Goffset  Svar YesNocorr  Variable  firstG=lastEF_ff, lastG=lastEF_lf,Goffvalue=GoffsetEF, augraph=EfgraphNo, EFinput  wave map   string offsetstr, YesorNo, comment   Nvar convoON  if (Goffvalue==0)   offsetstr = "G0000"  else   offsetstr = "G"+num2str(Goffvalue)  endif      if(EFvalue==0)  EFvalue=16.91  endif    EFinput = EFvalue  YesorNo = YesNocorr  if (convoON==1)    comment = "EF (eV) of aup"+  num2istr(augraph)+"_convo"  elseif (convoON==0)  	comment = "EF (eV) of aup"+  num2istr(augraph)  endif  Prompt firstG "Start No. "  Prompt lastG, "End No. "   Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")  Prompt EFinput, comment  Prompt YesorNo, "EF correction for each slice? ", popup, "Yes" + ";No"  Doprompt "EF information: Input map[ ][7]", offsetstr,firstG, lastG, EFinput, YesorNo  if (V_Flag)   return -1// User canceled   endif    sscanf offsetstr, "G%f", Goffvalue   lastEF_ff=firstG; lastEF_lf=lastG; GoffsetEF=Goffvalue   YesNocorr = YesorNo  firstG+=Goffvalue  lastG+=Goffvalue  map[firstG,lastG][7]=EFinput  print "gr"+num2istr(firstG) + " - gr"+num2istr(lastG)+": map[][7] =",EFinput,"eV"   if (stringmatch(YesorNo,"yes")==1)       EfcorrFun( firstG, lastG, augraph, EFinput)    endif  EFvalue = EFinputEndFunction EfCorrFun( firstG, lastG, augraph, EFinput)	Variable firstG, lastG, augraph, EFinput	Variable graph	Variable epoints, kpoints, ausize, i, renorm	variable estep, corr, wavesize, meanEF	String theGraph, thegraphX, theAuP, fit_EFtemp = "fit_EFtemp"	WAVE W_coef, temp1, temp2, temp3, temp4, map	for ( graph=firstG; graph <= lastG; graph+=1 )	 if (map[graph][8]==1)      abort "Stoped EF-correction at Graph"+num2str(graph)+"; You already did before."	    endif	 if (map[graph][8]==0)    	theGraph = "nr"+num2istr(graph)		theGraphX = "gx"+num2istr(graph)		duplicate /o $theGraph temp1		duplicate /o $theGraphx temp2		epoints = dimsize(temp1,0)		kpoints = dimsize(temp1,1)		estep=temp2[1]-temp2[0]      make /o /n=(epoints) temp4      Interpolate2/T=1/N=(kpoints)/Y=temp3 $fit_EFtemp        meanEF = mean($fit_EFtemp,-inf,inf)      temp3-= meanEF    //  if (abs(mean(temp3,-inf,inf)) > 1)   //     temp3-= EFinput    //    if (abs(mean(temp3,-inf,inf)) > 0.05)   //      abort "Too big EF-correction. Check aup" + num2str(graph) + "!!"   //    endif   //  endif      		for ( i=0; i<kpoints; i+=1 )			corr=temp3[i]			temp4[] = temp1[x][i]			temp1[][i]=interp(temp2[x]+corr,temp2, temp4)      endfor		duplicate /o temp1 $theGraph	 endif		map[graph][8]=1  endforendFunction EFpopupFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	wave map	string panelname, wavename  Nvar EfgraphNo, EFvalue  Nvar convoON  if (stringmatch(popStr,"_none_"))   return -1// User canceled   endif  panelname="EFpanel"  sscanf popStr, "aup%f", EfgraphNo	  if (stringmatch(popStr,"*convo"))   convoON=1  else   convoON=0  endif	dowindow/f $panelname	aup_panel_popup (EfgraphNo,panelname)	wavename="fit_"+popStr	EFvalue = mean($wavename,0,dimsize($wavename,0)-1)EndFunction aup_panel_popup (waveNo,panelname) : Graph   variable waveNo   string panelname   string aup, auw, fit_aup, fit_auw, paneltext1, paneltext2, BottomLabel, BottomNumstr    Nvar convoON   wave map   if (convoON==0) 	   aup = "aup" + num2str(waveNo)     	 auw = "auw" + num2str(waveNo)   elseif (convoON==1) 	   aup = "aup" + num2str(waveNo) +"_convo"  	 auw = "auw" + num2str(waveNo) +"_convo"        endif   fit_aup = "fit_EFtemp"    fit_auw = "fit_dEtemp"    duplicate/o $aup, EFtemp   duplicate/o $auw, dEtemp     CurveFit/q poly 5,  EFtemp[0,dimsize(EFtemp,0)-1] /D    CurveFit/q poly 5,  dEtemp[0,dimsize(dEtemp,0)-1] /D    paneltext1="\\Z16"+auw   paneltext2="\\Z16"+aup   dowindow/f $panelname      if (V_flag!=1)		PauseUpdate; Silent 1		// building window...			Display /W=(53,69,441,460) dEtemp,$fit_auw		dowindow/c $panelname		AppendToGraph/L=VertCrossing/B=HorizCrossing EFtemp,$fit_aup		ModifyGraph mode(dEtemp)=4,mode(EFtemp)=4		ModifyGraph marker(dEtemp)=19,marker(EFtemp)=19		ModifyGraph lSize($fit_auw)=2,lSize($fit_aup)=2		ModifyGraph rgb(dEtemp)=(9,37552,0),rgb($fit_auw)=(0,0,65535),rgb($fit_aup)=(0,0,65535)		ModifyGraph tick=2		ModifyGraph mirror(left)=1,mirror(VertCrossing)=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-2.57143,axOffset(bottom)=-0.8		ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37		ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}		ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}		ModifyGraph tickZap(VertCrossing)={0}		ModifyGraph tickZap(HorizCrossing)={0}		ModifyGraph axisEnab(left)={0,0.41}		ModifyGraph axisEnab(VertCrossing)={0.59,1}		ModifyGraph standoff=1	endif		TextBox/C/N=auw/F=0/A=MC/X=-39.64/Y=-11.57 paneltext1	  TextBox/C/N=aup/F=0/A=MC/X=-39.64/Y=46.59 paneltext2     if (convoON==0)			Label VertCrossing "Energy (eV)";DelayUpdate  	 sprintf BottomNumstr, "%7.4f", mean($fit_aup,0,dimsize($fit_aup,0)-1)    		BottomLabel = "mean= "+BottomNumstr+" eV, "+"map["+num2istr(waveNo)+"][7]= "+ num2str(map[waveNo][7])+" eV"  	 	Label HorizCrossing BottomLabel       	Label left "dE (eV)";DelayUpdate    	BottomLabel = "mean= "+num2str(mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000)+" meV"+",  4.4*mean= "+num2str(4.4*mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000)+" meV"    	Label bottom BottomLabel        	print aup, "EF =", mean($fit_aup,0,dimsize($fit_aup,0)-1),"eV"    	print auw, "4.4*dE =", 4.4*mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000,"meV"   //  map[waveNo][9]=mean($fit_aup,0,dimsize($fit_aup,0)-1)   		 map[waveNo][9]=mean($fit_aup,0,dimsize($fit_aup,0)-1) + map[waveNo][7]    	map[waveNo][10]=4.4*mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000  elseif (convoON==1)  		Label VertCrossing "Energy (eV)";DelayUpdate  	 sprintf BottomNumstr, "%7.4f", mean($fit_aup,0,dimsize($fit_aup,0)-1)    		BottomLabel = "mean= "+BottomNumstr+" eV, "+"map["+num2istr(waveNo)+"][7]= "+ num2str(map[waveNo][7])+" eV"  	 	Label HorizCrossing BottomLabel       	Label left "FWHM (eV)";DelayUpdate    	BottomLabel = "mean= "+num2str(mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000)+" meV"    	Label bottom BottomLabel        	print aup, "EF =", mean($fit_aup,0,dimsize($fit_aup,0)-1),"eV"    	print auw, "FWHM =", mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000,"meV"   endifEndMacroFunction BZpopupFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar bzname	Nvar BzmapDimsize	wave map	string panelname="Bztable", waveliststr, BzmapTable	variable i	if (stringmatch(popStr,"_none_")) 	bzname=""  return -1// User canceled   endif  BzmapTable = popStr // print ctrlName,popNum,popStr   duplicate/o $BzmapTable temp   temp[][1]=map[temp[p][0]][6] //ARPES angle input    temp[][4]=map[temp[p][0]][11]      temp[][5]=map[temp[p][0]][12]    duplicate/o  temp $BzmapTable  	dowindow/f $panelname	if (v_flag==1)	waveliststr = wavelist("*",";","win:")	 if (stringmatch(StringFromList(0, waveliststr),popStr)!=1)	  for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveFromTable $StringFromList(i, waveliststr)    	endfor    endif    appendtotable $popStr  else 	edit/W=(50,50,400,500) $popStr	dowindow/c $panelname  endIF	bzname=popStr	//BzmapDimsize = dimsize($bzname,1)	BzmapDimsize = dimsize($bzname,0)EndFunction BZpopupFunc_back (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar bzname	Nvar BzmapDimsize	string panelname="Bztable", waveliststr	variable i	if (stringmatch(popStr,"_none_")) 	bzname=""  return -1// User canceled   endif	dowindow/f $panelname	if (v_flag==1)	waveliststr = wavelist("*",";","win:")	 if (stringmatch(StringFromList(0, waveliststr),popStr)!=1)	  for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveFromTable $StringFromList(i, waveliststr)    	  appendtotable $popStr   	endfor    endif  else 	edit/W=(50,50,1200,200) $popStr	dowindow/c $panelname  endIF	bzname=popStr	BzmapDimsize = dimsize($bzname,1)EndFunction BzmapDimFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar BzmapDimsize	Svar bzname	variable OldDim, NewDim	wave map	OldDim = dimsize($bzname,0)	NewDim = varNum	if (OldDim >= NewDim)	  Redimension/N=(varNum,6) $bzname	else	  duplicate/o $bzname, temp temp1	  Redimension/N=(NewDim,6) temp, temp1	  temp1[OldDim,][0] = temp[OldDim-1][0]+p-(OldDim-1)	  temp1[OldDim,][1]=map[temp1[p]][6] 	  temp1[OldDim,][2] = temp[OldDim-1][2]	  temp1[OldDim,][3] = temp[OldDim-1][3]	  	  temp1[OldDim,][4]=map[temp1[p]][11] 	  temp1[OldDim,][5]=map[temp1[p]][12]      duplicate/o temp1 $bzname   endifEndProc ResetProc (ctrlName) : ButtonControl	String ctrlName	Dowindow graph_scopeif (V_flag==1)	getwindow graph_scope wsize  DoWindow /k  graph_scope	Old_scope_add = 1	ResetON = 1	Graph_Scope(V_left,V_top,V_right,V_bottom)	ResetON = 0endifEndWindow Graph_Scope(V_left,V_top,V_right,V_bottom) : Graph  variable V_left,V_top,V_right,V_bottom  variable i  symcheck=0	PauseUpdate; Silent 1		// building window...	if (ResetON == 1)	Display /W=(V_left,V_top,V_right,V_bottom)	else	Display /W=(277,49,750,500)	endif	AppendToGraph scope0 vs scopeX	ShowInfo	ShowTools ModifyGraph tick=2,zero(bottom)=3,mirror=1,minor(bottom)=1,fSize=16,axOffset=0;DelayUpdate Label left "Intensity (arb. units)";DelayUpdate Label bottom "Energy (eV)"  ModifyGraph margin(top)=28 SetVariable setvar0,pos={57,5},size={171,15},title=" ",value= scope_title SetRange_appendFunc_begin () ChangeScope() ScopeButton_offset("",0,"","")EndMacroProc ScopeButton_ShowScope(ctrlName) : ButtonControl	String ctrlName	dowindow/f graph_scope	if (V_flag!=1)	Old_scope_add = 1	Graph_Scope(0,0,0,0)	endifEndFunction BZgraphFunc (ctrlName) : ButtonControl	String ctrlName	NVAR scope_graph	svar bzname, Gobzname	string MapName,panelName, descriptor	MapName = "Map_"+Gobzname	panelName="Mapping_"+Gobzname	duplicate/o FSmapping $MapName	Dowindow/f $panelName	if (v_flag!=1)	 Display /W=(5,42,377,293)	 dowindow /c $panelName	AppendImage $MapName	ModifyImage $MapName ctab= {*,*,Rainbow,1}	textbox/k/n=text0   sprintf descriptor " \\Z16%s ", MapName	Textbox/N=MapName /x=-22.38/y=40/F=0/A=MC descriptor	ModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdate  Label bottom "\f02k\Bx";DelayUpdate  Label left "\f02k\By"  endifEndproc A()dowindow/f autographif (V_flag != 1)autograph ()endifendproc Re()dowindow/f Registerif (V_flag != 1)Register ()endifendproc GM()dowindow/f Graph_Modifyif (V_flag != 1)Graph_Modify ()endifendProc Rfunc (ctrlName) : ButtonControl	String ctrlName	dowindow/f Register	if (V_flag!=1)	Register()	endifEndFunction ValmenuFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr		if ( popnum==1 ) 		SetVariable scopeoffset, limits={-Inf,Inf,0.01}		endif	  if ( popnum==2 ) 		SetVariable scopeoffset, limits={-Inf,Inf,0.1}		endif		if ( popnum==3 ) 		SetVariable scopeoffset, limits={-Inf,Inf,1}		endif	   if ( popnum==4 ) 		SetVariable scopeoffset, limits={-Inf,Inf,10}		endif	   if ( popnum==5 ) 		SetVariable scopeoffset, limits={-Inf,Inf,100}		endif	   if ( popnum==6 ) 		SetVariable scopeoffset, limits={-Inf,Inf,1000}		endif	   if ( popnum==7 ) 		SetVariable scopeoffset, limits={-Inf,Inf,10000}		endifEndProc OtherOptionProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f AutoGraphOption	if (V_flag!=1)	AutoGraphOption()	endifEndProc GraphmodifyProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f Graph_Modify	if (V_flag!=1)	Graph_Modify()	endifEndFunction smoothFunc ()nvar scope_range, scope_angle, scope_smooth, scope_graphsvar dispwavevariable index, i, kpointsstring source, destwave scmat, temp, temp1    for ( index=0; index<scope_range; index+=1 )		dest = "scope"+num2istr(index)		duplicate/o $dest temp		smooth scope_smooth,temp		duplicate /o temp $dest	 endforEndFunction MeanFunc ()nvar scope_range, scope_angle, scope_mean, scope_graphsvar dispwavevariable index, i, kpointsstring source, destwave scmat, temp, temp1source = dispwave+num2istr(scope_graph)	duplicate /o $source scmat	kpoints = dimsize(scmat,1)	if (kpoints==0)	kpoints = 1	endif  for ( index=0; index<scope_range; index+=1 )		dest = "scope"+num2istr(index)		temp = scmat[x][index+scope_angle]		if (scope_mean > 1)		  for (i=1; i<=(scope_mean-1)/2; i+=1)        // if ((index+scope_angle+i)<kpoints)		     temp1= scmat[x][index+scope_angle+i]          temp+=temp1		  //  endif		   // if ((index+scope_angle-i)>=0)		     temp1= scmat[x][index+scope_angle-i]          temp+=temp1		   //endif		  endfor		     temp/=scope_mean		endif		duplicate /o temp $dest	endforEndFunction MeanFunc_back ()nvar scope_range, scope_angle, scope_mean, scope_graphsvar dispwavevariable index, i, kpointsstring source, destwave scmat, temp, temp1source = dispwave+num2istr(scope_graph)	duplicate /o $source scmat	kpoints = dimsize(scmat,1)	if (kpoints==0)	kpoints = 1	endif  for ( index=0; index<scope_range; index+=1 )		dest = "scope"+num2istr(index)		temp = scmat[x][index+scope_angle]		if (scope_mean > 1)		  for (i=1; i<=(scope_mean-1)/2; i+=1)         if ((index+scope_angle+i)<kpoints)		     temp1= scmat[x][index+scope_angle+i]          temp+=temp1          temp/=2		    endif		    if ((index+scope_angle-i)>=0)		     temp1= scmat[x][index+scope_angle-i]          temp+=temp1          temp/=2		    endif		  endfor		endif		duplicate /o temp $dest	endforEndFunction ScopeButton_add (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar scope_mean, scope_range, scope_add	if (stringmatch(WinName(0, 1),"Graph_scope")!=1)		dowindow/f scope_graph		if (V_flag != 1)	 	scope_mean =1 		endif	endif	if (scope_range < scope_add)	scope_add = scope_range	endif	  addfunc () EndFunction AddFunc ()	variable index, i, j	, kpoints, epoints	nvar scope_range, scope_angle, scope_graph, scope_add, Old_scope_add, scope_offs, scope_mean, scope_smooth   nvar symcheck, Old_scope_graph, Fermicheck   svar dispwave   string source, result, ScopeWave   wave scmat, temp, temp1   variable nwaves   DoWindow graph_scope if (V_flag==1)   source = dispwave+num2istr(scope_graph)	 duplicate /o $source scmat	 epoints = dimsize(scmat,0)	 kpoints = dimsize(scmat,1)	 if (kpoints==0)	  return -1	 else	    nwaves = ceil(scope_range/Old_scope_add)  if (nwaves > ceil(scope_range/scope_add))   for ( i=ceil(scope_range/scope_add); i<nwaves; i+=1 )	  ScopeWave = "scope"+num2istr(i)    removefromgraph/w=Graph_scope/z  $ScopeWave   endfor  elseif (ceil(scope_range/scope_add) > nwaves)   for ( i=nwaves; i<ceil(scope_range/scope_add); i+=1 )  		ScopeWave = "scope"+num2istr(i)  		duplicate /o nil $scopewave  		AppendToGraph/w=Graph_scope $ScopeWave vs scopex 	endfor  endif    make/o/n=(epoints) temp    make/o/n=(epoints) temp1    index = 0    i = 0	 do         result = "scope"+num2istr(index)        temp=0       for (j=0 ; j <scope_add ; j+=1)       temp1 = scmat[x][i+scope_angle]       temp+=temp1[p]       i+=1        if (i>=scope_range)        j+=1         break                 endif        endfor          temp/=j       duplicate /o temp $result       index+=1   while (i < scope_range)endif if (scope_mean>1)     scope_mean = 1    endif   if ( scope_smooth>0 )    smoothFunc ()   endif   if  (scope_offs > 0)    ScopeButton_offset("",0,"","")  endif  if (symcheck==1 )      ScopebuttonSymFunc () endif if (Fermicheck==1)     ScopebuttonFermiFunc () endif  Old_scope_graph = scope_graph Old_scope_add = scope_add  ModifyGraph/w=Graph_scope tick=2,zero(bottom)=3,mirror=1,minor(bottom)=1,fSize=16,axOffset=0;DelayUpdate Label/w=Graph_scope left "Intensity (arb. units)";DelayUpdateEndifendFunction AddFunc_backup ()	variable index, i, j	, kpoints, epoints	nvar scope_range, scope_angle, scope_graph, scope_add, Old_scope_add, scope_offs, scope_mean, scope_smooth   nvar symcheck, Old_scope_graph, Fermicheck   svar dispwave   string source, result, ScopeWave   wave scmat, temp, temp1   variable nwavesif (stringmatch(WinName(0, 1),"Graph_scope")!=1)  DoWindow /f  graph_scopeelse   DoWindow graph_scopeendif if (V_flag==1)   source = dispwave+num2istr(scope_graph)	 duplicate /o $source scmat	 epoints = dimsize(scmat,0)	 kpoints = dimsize(scmat,1)	 if (kpoints==0)	  return -1	 else	    nwaves = ceil(scope_range/Old_scope_add)  if (nwaves > ceil(scope_range/scope_add))   for ( i=ceil(scope_range/scope_add); i<nwaves; i+=1 )	  ScopeWave = "scope"+num2istr(i)    removefromgraph /z  $ScopeWave   endfor  elseif (ceil(scope_range/scope_add) > nwaves)   for ( i=nwaves; i<ceil(scope_range/scope_add); i+=1 )  		ScopeWave = "scope"+num2istr(i)  		duplicate /o nil $scopewave  		AppendToGraph $ScopeWave vs scopex 	endforendif    make/o/n=(epoints) temp      make/o/n=(epoints) temp1    index = 0    i = 0	 do         result = "scope"+num2istr(index)        temp=0       for (j=0 ; j <scope_add ; j+=1)       temp1 = scmat[x][i+scope_angle]       temp+=temp1[p]       i+=1        if (i>=scope_range)        j+=1         break                 endif        endfor          temp/=j       duplicate /o temp $result       index+=1   while (i < scope_range)   endif    if (scope_mean>1)     scope_mean = 1    endif   if ( scope_smooth>0 )    smoothFunc ()   endif   if  (scope_offs > 0)    ScopeButton_offset("",0,"","")  endif  if (symcheck==1 )      ScopebuttonSymFunc () endif if (Fermicheck==1)     ScopebuttonFermiFunc () endif  Old_scope_graph = scope_graph Old_scope_add = scope_add  ModifyGraph tick=2,zero(bottom)=3,mirror=1,minor(bottom)=1,fSize=16,axOffset=0;DelayUpdate Label left "Intensity (arb. units)";DelayUpdateEndifendFunction ChangeScope()	string source, Xaxis, dest, descriptor, polar	variable index, matindex, outwave, kpoints, epoints, i, j  NVAR scope_graph, scope_angle, scope_range, scope_smooth, scope_mean, symcheck, Allchecked, scope_add, scope_offs	nvar Old_scope_add, scopeNow, Fermicheck	SVAR dispwave, EFwave	WAVE map	string ScopeWave, ScopeWaveX	variable Old_scope_graph	   if (scope_graph==0 && exists("gr0")==0)    scope_graph=1   endif   source = dispwave+num2istr(scope_graph)   if (exists(source)==0)    abort "No such a data!!"   endif	if ( ((stringmatch(dispwave,"cr"))) || ((stringmatch(dispwave,"ak"))))		Xaxis = "cx"+num2istr(scope_graph)	else		Xaxis = "gx"+num2istr(scope_graph)	endif	duplicate /o $source scmat	duplicate /o $Xaxis scopeX 	kpoints = dimsize(scmat,1)	if (kpoints==0)	kpoints = 1	endif	epoints = dimsize(scmat,0)	if ( scope_angle>kpoints )		scope_angle = kpoints	endif		if ( scope_angle<0 ) 		scope_angle = 0	endif	if ( scope_range+scope_angle>=kpoints ) 		scope_angle = kpoints-scope_range	endif	duplicate/o scopeX temp0	duplicate/o scopeX temp1  if (Allchecked==1 && (kpoints != scope_range || scope_angle!=0))    AllsliceFunc()  else  if ((( stringmatch(dispwave,"cr"))==0) && (( stringmatch(dispwave,"ak"))==0))		scopeX -=map[scope_graph][7]  endif    make /o /n=(epoints) temp, temp1    if  (dimsize($source,1)==0)   dest = "scope"+num2istr(0)   temp = scmat[x]   duplicate /o temp $destelseif (scope_add > 1 && (scope_add != Old_scope_add || scope_graph!=Old_scope_graph))      Addfunc ()     sprintf scope_title "G%g:  %g K ,  %g deg",scope_graph,map[scope_graph][2],map[scope_graph][6]      Old_scope_add = scope_add      scopeNow = scope_graph      return-1else    for ( index=0; index<scope_range; index+=1 )		dest = "scope"+num2istr(index)		temp = scmat[x][index+scope_angle]		duplicate /o temp $dest	 endfor  endif  if (scope_mean>1)   meanFunc ()  endif  if ( scope_smooth>0 )   smoothFunc ()  endifendif  dowindow $"Graph_scope"if (V_flag==1)	sprintf scope_title "G%g:  %g K ,  %g deg",scope_graph,map[scope_graph][2],map[scope_graph][6]endifif (symcheck==1 && scope_graph!=Old_scope_graph)     ScopebuttonSymFunc ()endifif (Fermicheck==1 && scope_graph!=Old_scope_graph)     ScopebuttonFermiFunc ()endif  Old_scope_graph = scope_graph  scopeNow = scope_graphEndProc ButtonProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f ButtonGraph	if (V_flag!=1)  ButtonGraph()	endifEndProc ComboProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f Combo	if (V_flag!=1) Combo()	endifEndProc InfoCheckProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f DataInfo	if (V_flag!=1)	DataInfo()	endifEndFunction ScopeButton_ChangeGraph (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	NVAR scope_graph, update_2d, update_scope, Goffvalue, symcheck, scope_add	svar dispwave	WAVE map, GrAllNum, NrAllNumif (scope_graph<100000)	  if (scope_graph < Goffvalue)   for (scope_graph=scope_graph;scope_graph <= Goffvalue+1000;scope_graph+=1000)   endfor  endif  // if (scope_graph > Goffvalue)   //for (scope_graph=scope_graph;scope_graph >= Goffvalue+1000;scope_graph-=1000)   //endfor  //endif   if (scope_graph==0 && exists("gr0")==0)    scope_graph=1   endif	if ( scope_graph<1 )		scope_graph=0	endif	//if ( scope_graph==Goffvalue+999 )		//scope_graph=Goffvalue	//endif	if (stringmatch(dispwave,"gr") && scope_graph>Goffvalue+GrAllNum[Goffvalue/1000] )		scope_graph=Goffvalue+GrAllNum[Goffvalue/1000]	endif  if (stringmatch(dispwave,"nr") && scope_graph>Goffvalue+NrAllNum[Goffvalue/1000] )		scope_graph=Goffvalue+NrAllNum[Goffvalue/1000]	endif	if( scope_graph==Goffvalue)	scope_graph=scope_graph+1	endifendif	if ( scope_graph>map[0][0] )		scope_graph=map[0][0]	endif	if (update_scope==1)		  ChangeScope()	endif	if (update_2d==1 )			Scope_Change2D()	endif	  InputInformation ()EndProc AllcheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checkedAllchecked = checkedif (Allchecked==1)AllsliceFunc()endifEndFunction AllsliceFunc()	NVAR scope_graph, scope_angle, scope_range, old_scope_range	svar dispwave	string wavename 	if (stringmatch(dispwave,"cr"))	wavename="cr"+num2istr(scope_graph)	elseif (stringmatch(dispwave,"gr"))	wavename="gr"+num2istr(scope_graph)	else 	wavename="nr"+num2istr(scope_graph)	endif	old_scope_range = scope_range	scope_angle=0; scope_range=dimsize($wavename,1)	if (scope_range==0)   scope_range=1	endifif (stringmatch(WinName(0, 1),"Graph_scope")!=1)  DoWindow /f  graph_scopeelse   DoWindow graph_scopeendif	if (V_flag==1)	setRange_appendFunc ()	//setRange_appendFunc_begin ()	ChangeScope()	ScopeButton_offset("",0,"","")	endifEndFunction Goffsetfunc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName		Nvar scope_graph, update_scope, update_2d, Goffvalue	Svar dispwave	wave map, GrAllNum, NrAllNum	 if ( Goffvalue>=map[0][0] )		   Goffvalue=map[0][0]-1000	 endif	 if (scope_graph < Goffvalue)   for (scope_graph=scope_graph;scope_graph <= Goffvalue+1000;scope_graph+=1000)   endfor  endif   if (scope_graph > Goffvalue)   for (scope_graph=scope_graph;scope_graph >= Goffvalue+1000;scope_graph-=1000)   endforif (stringmatch(dispwave,"gr") && scope_graph>Goffvalue+GrAllNum[Goffvalue/1000])		scope_graph=Goffvalue+GrAllNum[Goffvalue/1000]endif if (stringmatch(dispwave,"nr") && scope_graph>Goffvalue+NrAllNum[Goffvalue/1000])		scope_graph=Goffvalue+NrAllNum[Goffvalue/1000]endif    endif		if (update_scope==1)		ChangeScope()	endif	if (update_2d==1 )			Scope_Change2D()	endifEndFunction ListGoffsetproc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Nvar scope_graph, update_scope, update_2d, Goffvalue	Svar dispwave	wave map, GrAllNum, NrAllNum	if (stringmatch(popStr,"_none_"))   return -1// User canceled   endif  sscanf popStr, "G%f", Goffvalue    if (stringmatch(dispwave,"nr") && NrAllNum[Goffvalue/1000]==0)  abort "There is no normalized data!!"  endif	 if ( Goffvalue>=map[0][0] )		   Goffvalue=map[0][0]-1000	 endif	 if (scope_graph < Goffvalue)      for (scope_graph=scope_graph;scope_graph <= Goffvalue+1000;scope_graph+=1000)      endfor   endif   if (scope_graph > Goffvalue)     for (scope_graph=scope_graph;scope_graph >= Goffvalue+1000;scope_graph-=1000)     endfor     if (stringmatch(dispwave,"gr") && scope_graph > Goffvalue+GrAllNum[Goffvalue/1000])		   scope_graph=Goffvalue+GrAllNum[Goffvalue/1000]     endif      if (stringmatch(dispwave,"nr") && scope_graph > Goffvalue+NrAllNum[Goffvalue/1000])		   scope_graph=Goffvalue+NrAllNum[Goffvalue/1000]     endif    endif	 if (update_scope==1)		ChangeScope()	endif	if (update_2d==1 )			Scope_Change2D()	endif	InputInformation ()EndFunction LoadNotePopup(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string str, Logname="Log2"  if (stringmatch(popStr,"_none_"))   return -1// User canceled   endif	DoWindow/F $popStrEndFunction SymCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	nvar symcheck	if (stringmatch(WinName(0, 1),"Graph_scope")!=1)  DoWindow /f  graph_scope  else   DoWindow graph_scope  endif	if (V_flag==1 && checked==1 )	   if ( stringmatch(CsrWave(a),"") || stringmatch(CsrWave(b),"") )	    checked=0       Abort "Can't do symmetlization. Set A and B cursors!!"  endif endif  symcheck=checked   ChangeScope()EndFunction Scopebutton_Sym(ctrlName) : ButtonControl	string ctrlName	ScopebuttonSymFunc ()end Function ScopebuttonSymFunc ()	string source, source2	variable i, nwaves	NVAR scope_range, EFchecked, scope_add	WAVE scopexif (stringmatch(WinName(0, 1),"Graph_scope")!=1)  DoWindow /f  graph_scopeelse   DoWindow graph_scopeendif	if ( V_Flag == 0 )		return -1		//Abort "Can't do symmetlization. Display the Scope first !"	endif	if (stringmatch(CsrWave(a),"") || stringmatch(CsrWave(b),""))       Abort "Can't do symmetlization. Set A and B cursors!!"  endif  // getwindow Graph_Scope wavelist  // nwaves = dimsize(w_wavelist,0)-1   nwaves = ceil(scope_range/scope_add) 		for ( i=0; i<nwaves; i+=1 )		source = "scope"+num2istr(i)		Symmetrization( scopex, $source, "tempscopeX", source)	   endfor	duplicate /o tempscopeX scopeXEndFunction ScopebuttonFermiFunc ()	string source	variable i, nwaves	variable eV=1.6*10^-19, kB=1.3807*10^-23, Temperature, Vmax, Vmin	NVAR scope_graph, scope_add, scope_range	WAVE scopex, map, akw2d	Svar Auto_Yes_No_Convo	duplicate/o $"scope1", temp1	duplicate/o scopex, temp2  Temperature = map[scope_graph][2]  //Temperature = map[scope_graph][0]  if (stringmatch(Auto_Yes_No_Convo,"Yes"))				makeFermiConvoWave (temp1,temp2,Temperature)	elseif (stringmatch(Auto_Yes_No_Convo,"No"))		  temp1[] = 1 / ( 1 + exp( temp2[p]/(kB*Temperature/eV) ) )  endif     	dowindow Graph_scope  if (V_flag==1)    GetAxis/q/W=Graph_scope left    Vmax = V_max    Vmin = V_min     nwaves = ceil(scope_range/scope_add) 		for ( i=0; i<nwaves; i+=1 )			source = "scope"+num2istr(i)			duplicate/o $source, temp,temp3    	temp[] = temp3[p]/temp1[p]    	duplicate/o  temp $source	  endfor	 	    SetAxis/w=graph_scope left Vmin, Vmax  endifEndFunction Symmetrization( XWaveIn, YWaveIn,  XWaveOut,  YWaveOut )	Wave XWaveIn, YWaveIn	String XWaveOut, YWaveOut	Variable Estep, EF, EFchannel, dE	Variable Npoints, Norm, NormA=xcsr(a), NormB=xcsr(b)   // determine energy step, rounded to 1meV	Npoints = DimSize(XWaveIn,0)	// Estep = Round(1000*(XWaveIn[Npoints-1]-XWaveIn[0])/(Npoints-1))/1000    Estep = (XWaveIn[Npoints-1]-XWaveIn[0])/(Npoints-1)// Locate EF = 0	findlevel/P/Q XWaveIn 0	if ( V_Flag == 1 )	// Ef not defined		Abort "Cannot locate Ef !! \rCheck your map"	endif	EF = V_levelx// Closest Wavepoint to EF and deviation of EF from that point	EFchannel = Round(EF)	dE = EF - EFchannel	make/o/n=(2*EFchannel+1) tempX	tempX[0,npoints-1] = XWaveIn[p]	tempX[npoints,] = XWaveIn[npoints-1]+(p-npoints+1)*Estep// extend background	norm = faverage(YWaveIn, normA, normB)	make/o/n=(2*EFchannel+1) temp	temp[0,normB] = YWaveIn[p]	temp[normB,] = norm// symmetrize	make/o/n=(2*EFchannel+1) tempY	tempY[] = temp[p] + temp[2*EFchannel-p +2*dE ]	duplicate/o tempX $XWaveOut	duplicate/o tempY $YWaveOutEndWindow DataInfo() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(482,206,726,574)	ModifyPanel cbRGB=(65535,65532,16385)	SetVariable DateInfo,pos={56,230},size={180,18},disable=2,title="Date :"	SetVariable DateInfo,value= DateInfostr	SetVariable SampleInfo,pos={56,39},size={180,18},disable=2,title="Sample :"	SetVariable SampleInfo,value= SampleInfostr	SetVariable SweepInfo,pos={56,128},size={180,18},disable=2,title="Sweep times :"	SetVariable SweepInfo,value= SweepInfostr	SetVariable PassEInfo,pos={56,213},size={180,18},disable=2,title="Pass E :"	SetVariable PassEInfo,value= PassEInfostr	SetVariable SliceInfo,pos={56,145},size={180,18},disable=2,title="Slice No. :"	SetVariable SliceInfo,value= SliceInfostr	SetVariable LowEinfo,pos={56,162},size={180,18},disable=2,title="Initial E (eV) :"	SetVariable LowEinfo,value= LowEInfostr	SetVariable HighEinfo,pos={56,179},size={180,18},disable=2,title="Final E (eV) :"	SetVariable HighEinfo,value= HighEInfostr	SetVariable PassEInfo3,pos={56,196},size={180,18},disable=2,title="E step (meV) :"	SetVariable PassEInfo3,value= EStepstr	SetVariable Folderinfo,pos={56,22},size={180,18},disable=2,title="Folder :"	SetVariable Folderinfo,value= FolderInfostr	SetVariable DateInfo1,pos={56,247},size={180,18},disable=2,title="Time :"	SetVariable DateInfo1,value= TimeInfostr	SetVariable DateInfo2,pos={190,2},size={45,18},disable=2,title="of"	SetVariable DateInfo2,value= TotalGInfostr	SetVariable DateInfo3,pos={115,2},size={74,18},disable=2,title="Graph :"	SetVariable DateInfo3,value= GraphNoInfostr	SetVariable DateInfo4,pos={56,56},size={180,18},disable=2,title="Temp (K) :"	SetVariable DateInfo4,value= TempInfostr	SetVariable DateInfo5,pos={56,264},size={180,18},disable=2,title="X :"	SetVariable DateInfo5,value= XInfostr	SetVariable DateInfo6,pos={56,281},size={180,18},disable=2,title="Y :"	SetVariable DateInfo6,value= YInfostr	SetVariable DateInfo7,pos={56,299},size={180,18},disable=2,title="Z :"	SetVariable DateInfo7,value= ZInfostr	SetVariable DateInfo8,pos={56,73},size={180,18},disable=2,title="Theta (deg) :"	SetVariable DateInfo8,value= ThetaInfostr	CheckBox DataInfoCkeck1,pos={36,23},size={16,14},proc=FolderCheckFunc,title=""	CheckBox DataInfoCkeck1,value= 1	CheckBox DataInfoCkeck2,pos={36,39},size={16,14},proc=SampleCheckFunc,title=""	CheckBox DataInfoCkeck2,value= 1	CheckBox DataInfoCkeck3,pos={36,145},size={16,14},proc=SliceNoCheckFunc,title=""	CheckBox DataInfoCkeck3,value= 1	CheckBox DataInfoCkeck4,pos={36,128},size={16,14},proc=SweepCheckFunc,title=""	CheckBox DataInfoCkeck4,value= 1	CheckBox DataInfoCkeck5,pos={36,213},size={16,14},proc=PassECheckFunc,title=""	CheckBox DataInfoCkeck5,value= 1	CheckBox DataInfoCkeck6,pos={36,163},size={16,14},proc=EiCheckFunc,title=""	CheckBox DataInfoCkeck6,value= 1	CheckBox DataInfoCkeck7,pos={36,180},size={16,14},proc=EfCheckFunc,title=""	CheckBox DataInfoCkeck7,value= 1	CheckBox DataInfoCkeck8,pos={36,197},size={16,14},proc=EstepCheckFunc,title=""	CheckBox DataInfoCkeck8,value= 1	CheckBox DataInfoCkeck9,pos={36,230},size={16,14},proc=DateCheckFunc,title=""	CheckBox DataInfoCkeck9,value= 1	CheckBox DataInfoCkeck10,pos={36,248},size={16,14},proc=TimeCheckFunc,title=""	CheckBox DataInfoCkeck10,value= 1	CheckBox DataInfoCkeck11,pos={36,56},size={16,14},proc=TempCheckFunc,title=""	CheckBox DataInfoCkeck11,value= 1	CheckBox DataInfoCkeck12,pos={36,264},size={16,14},proc=XCheckFunc,title=""	CheckBox DataInfoCkeck12,value= 1	CheckBox DataInfoCkeck13,pos={36,281},size={16,14},proc=YCheckFunc,title=""	CheckBox DataInfoCkeck13,value= 1	CheckBox DataInfoCkeck14,pos={36,299},size={16,14},proc=ZCheckFunc,title=""	CheckBox DataInfoCkeck14,value= 1	CheckBox DataInfoCkeck15,pos={36,73},size={16,14},proc=ThetaCheckFunc,title=""	CheckBox DataInfoCkeck15,value= 1	Button Allaxis2,pos={5,322},size={33,20},proc=AllInfoCheckFunc,title="All"	Button Allaxis3,pos={5,344},size={33,20},proc=NonInfoCheckFunc,title="Non"	SetVariable DataInfo,pos={8,22},size={29,18},disable=2,title=" "	SetVariable DataInfo,value= FolderChecked	SetVariable DataInfo1,pos={8,39},size={29,18},disable=2,title=" "	SetVariable DataInfo1,value= SampleChecked	SetVariable DataInfo2,pos={8,145},size={29,18},disable=2,title=" "	SetVariable DataInfo2,value= SliceNoChecked	SetVariable DataInfo3,pos={8,128},size={29,18},disable=2,title=" "	SetVariable DataInfo3,value= SweepChecked	SetVariable DataInfo4,pos={8,213},size={29,18},disable=2,title=" "	SetVariable DataInfo4,value= PassEChecked	SetVariable DataInfo5,pos={8,163},size={29,18},disable=2,title=" "	SetVariable DataInfo5,value= EiiChecked	SetVariable DataInfo6,pos={8,180},size={29,18},disable=2,title=" "	SetVariable DataInfo6,value= EffChecked	SetVariable DataInfo7,pos={8,197},size={29,18},disable=2,title=" "	SetVariable DataInfo7,value= EstepChecked	SetVariable DataInfo8,pos={8,230},size={29,18},disable=2,title=" "	SetVariable DataInfo8,value= DateChecked	SetVariable DataInfo9,pos={8,248},size={29,18},disable=2,title=" "	SetVariable DataInfo9,value= TimeChecked	SetVariable DataInfo10,pos={8,56},size={29,18},disable=2,title=" "	SetVariable DataInfo10,value= TempChecked	SetVariable DataInfo11,pos={8,264},size={29,18},disable=2,title=" "	SetVariable DataInfo11,value= XChecked	SetVariable DataInfo12,pos={8,281},size={29,18},disable=2,title=" "	SetVariable DataInfo12,value= YChecked	SetVariable DataInfo13,pos={8,299},size={29,18},disable=2,title=" "	SetVariable DataInfo13,value= ZChecked	SetVariable DataInfo14,pos={8,73},size={29,18},disable=2,title=" "	SetVariable DataInfo14,value= ThetaChecked	SetVariable DateInfo9,pos={111,346},size={51,18},disable=2,title="of",value= of	SetVariable DateInfo0,pos={46,345},size={62,18},proc=AutoPageFunc,title="Page"	SetVariable DateInfo0,limits={1,inf,1},value= Page	Button Allaxis4,pos={176,343},size={22,20},proc=PageListFunc,title="P"	PopupMenu Sheetpopup,pos={45,322},size={118,21},proc=DataSheetFunc,title="Data Seet"	PopupMenu Sheetpopup,mode=2,popvalue="G1000",value= #"StringList(\"G*000\",\";\")"	Button Allaxis5,pos={177,320},size={20,20},proc=ButtsheetShow,title="S"	SetVariable DateInfo09,pos={56,92},size={180,18},disable=2,title="Tilt (deg) :"	SetVariable DateInfo09,value= TiltInfostr	CheckBox DataInfoCkeck16,pos={36,92},size={16,14},proc=TiltCheckFunc,title=""	CheckBox DataInfoCkeck16,value= 1	SetVariable DataInfo15,pos={8,92},size={29,18},disable=2,title=" "	SetVariable DataInfo15,value= TiltChecked	SetVariable DateInfo10,pos={56,110},size={180,18},disable=2,title="Psi (deg) :"	SetVariable DateInfo10,value= PsiInfostr	CheckBox DataInfoCkeck17,pos={36,110},size={16,14},proc=PsiCheckFunc,title=""	CheckBox DataInfoCkeck17,value= 1	SetVariable DataInfo16,pos={8,110},size={29,18},disable=2,title=" "	SetVariable DataInfo16,value= PsiCheckedEndMacroFunction DataSheetFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	   svar Goffinfo, P1st, P2nd, P3rd, Spaceline	string waveliststr, P1stStr, P2ndStr, P3rdStr, SpaceStr	variable i	P1stStr=P1st ; P2ndStr=P2nd ; P3rdStr=P3rd  Prompt P1stStr, "1st Priority", popup, "_none_"+ ";Temp_K" + ";Theta_deg" + ";Sweep"  Prompt P2ndStr, "2nd Priority" , popup, "_none_"+";Temp_K" + ";Theta_deg" + ";Sweep"  Prompt P3rdStr, "3rd Priority" , popup, "_none_"+";Temp_K" + ";Theta_deg" + ";Sweep" // Prompt SpaceStr, "Need separation line?" , popup, "Yes"+";No"  Doprompt "Data Sheet Setting", P1stStr, P2ndStr, P3rdStr//, SpaceStr   if (V_Flag)   return -1// User canceled   endif  // Spaceline = SpaceStr   if (stringmatch(P1stStr,"_none_"))   P1st="Graph"  else   P1st=P1stStr  endif    if (stringmatch(P2ndStr,"_none_"))    P2nd="Graph"  else     P2nd=P2ndStr  endif  if (stringmatch(P3rdStr,"_none_"))    P3rd="Graph"  else     P3rd=P3rdStr   endif  	 Goffinfo = popStr  	dowindow/f DataSheet	if (v_flag==1)	waveliststr = wavelist("*",";","win:")	 if (stringmatch(StringFromList(0, waveliststr),popStr)!=1)	  for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveFromTable $StringFromList(i, waveliststr)      	endfor    endif   InputDataSheet (Goffinfo)   else   	edit	  InputDataSheet (Goffinfo)	dowindow/c DataSheet  endIFEndFunction InputDataSheet (popStr)   string popStr   wave grallnum   wave/t mapt, tempT   variable  Windex,i,Goffset 	 Nvar  FolderChecked, SampleChecked, SliceNoChecked, SweepChecked, PassEChecked, EiiChecked, EffChecked   Nvar EstepChecked, DateChecked, TimeChecked, TempChecked, XChecked, YChecked, ZChecked, ThetaChecked   Nvar Page, of, ListNo, LastNo   svar P1st, P2nd, P3rd, DatasheetStr   string waveResult, waveStr=""   sscanf popStr, "G%f", Goffset   LastNo = grallnum[Goffset/1000]    Windex = Goffset   if (stringmatch(P1st,"Graph"))      waveResult="Graph"      make/o/t/n=(LastNo+1) tempT, $waveResult      tempT[] = num2str(p+Windex)      tempT[0] = popStr      duplicate/o tempT $waveResult     waveStr+=waveResult+";"   elseif (stringmatch(P1st,"Temp_K"))         waveResult = P1st         InputSheet(popStr,waveResult,9," K")         waveStr+=waveResult+";"   elseif (stringmatch(P1st,"Theta_deg"))         waveResult = P1st         InputSheet(popStr,waveResult,13," deg")         waveStr+=waveResult+";"   elseif (stringmatch(P1st,"Sweep"))         waveResult = P1st         InputSheet(popStr,waveResult,2," times")         waveStr+=waveResult+";"   endif      if (stringmatch(P2nd,"Graph") && stringmatch(P1st,"Graph")!=1)      waveResult="Graph"      make/o/t/n=(LastNo+1) tempT, $waveResult      tempT[] = num2str(p+Windex)      tempT[0] = popStr      duplicate/o tempT $waveResult     waveStr+=waveResult+";"   elseif (stringmatch(P2nd,"Temp_K") && stringmatch(P1st,"Temp_K")!=1)         waveResult = P2nd         InputSheet(popStr,waveResult,9," K")         waveStr+=waveResult+";"   elseif (stringmatch(P2nd,"Theta_deg") && stringmatch(P1st,"Theta_deg")!=1)         waveResult = P2nd         InputSheet(popStr,waveResult,13," deg")         waveStr+=waveResult+";"   elseif (stringmatch(P2nd,"Sweep") && stringmatch(P1st,"Sweep")!=1)         waveResult = P2nd         InputSheet(popStr,waveResult,2," times")         waveStr+=waveResult+";"   endif   if (stringmatch(P3rd,"Graph") && stringmatch(P1st,"Graph")!=1 && stringmatch(P2nd,"Graph")!=1)      waveResult="Graph"      make/o/t/n=(LastNo+1) tempT, $waveResult      tempT[] = num2str(p+Windex)      tempT[0] = popStr      duplicate/o tempT $waveResult     waveStr+=waveResult+";"   elseif (stringmatch(P3rd,"Temp_K") && stringmatch(P1st,"Temp_K")!=1 && stringmatch(P2nd,"Temp_K")!=1)         waveResult = P3rd         InputSheet(popStr,waveResult,9," K")         waveStr+=waveResult+";"   elseif (stringmatch(P3rd,"Theta_deg") && stringmatch(P1st,"Theta_deg")!=1 && stringmatch(P2nd,"Theta_deg")!=1)         waveResult = P3rd         InputSheet(popStr,waveResult,13," deg")         waveStr+=waveResult+";"   elseif (stringmatch(P3rd,"Sweep") && stringmatch(P1st,"Sweep")!=1 && stringmatch(P2nd,"Sweep")!=1)         waveResult = P3rd         InputSheet(popStr,waveResult,2," times")         waveStr+=waveResult+";"   endif         if (stringmatch(P1st,"Graph")!=1 && stringmatch(P2nd,"Graph")!=1 && stringmatch(P3rd,"Graph")!=1)      waveResult="Graph"      make/o/t/n=(LastNo+1) tempT, $waveResult      tempT[] = num2str(p+Windex)      tempT[0] = popStr      duplicate/o tempT $waveResult     waveStr+=waveResult+";"   endif     if (TempChecked==1 && stringmatch(P1st,"Temp_K")!=1 && stringmatch(P2nd,"Temp_K")!=1 && stringmatch(P3rd,"Temp_K")!=1)       waveResult ="Temp_K"          InputSheet(popStr,waveResult,9," K")          waveStr+=waveResult+";"   endif   if (ThetaChecked==1 && stringmatch(P1st,"Theta_deg")!=1 && stringmatch(P2nd,"Theta_deg")!=1 && stringmatch(P3rd,"Theta_deg")!=1)       waveResult ="Theta_deg"       InputSheet(popStr,waveResult,13," deg")       waveStr+=waveResult+";"   endif   if (ThetaChecked==1)      waveResult = "Tilt_deg"        InputSheet(popStr,waveResult,14," deg")        waveStr+=waveResult+";"   endif    if (ThetaChecked==1)      waveResult = "Psi_deg"        InputSheet(popStr,waveResult,15," deg")        waveStr+=waveResult+";"   endif   if (SweepChecked==1 && stringmatch(P1st,"Sweep")!=1 && stringmatch(P2nd,"Sweep")!=1 && stringmatch(P3rd,"Sweep")!=1)      waveResult = "Sweep"        InputSheet(popStr,waveResult,2," times")        waveStr+=waveResult+";"   endif      if (SliceNoChecked==1)      waveResult = "Slice"        InputSheet(popStr,waveResult,4," slices")        waveStr+=waveResult+";"   endif      if (PassEChecked==1)      waveResult = "PassE"        InputSheet(popStr,waveResult,3,"")        waveStr+=waveResult+";"   endif      if (EiiChecked==1)      waveResult = "Ei_eV"         InputSheet(popStr,waveResult,5," eV")         waveStr+=waveResult+";"   endif      if (EffChecked==1)       waveResult ="Ef_eV"        InputSheet(popStr,waveResult,6," eV")        waveStr+=waveResult+";"   endif      if (EstepChecked==1)       waveResult ="Estep_eV"         InputSheet(popStr,waveResult,7," eV")         waveStr+=waveResult+";"   endif      if (DateChecked==1)       waveResult ="Date_"        InputSheet(popStr,waveResult,1,"")        waveStr+=waveResult+";"   endif      if (TimeChecked==1)       waveResult ="Time_"         InputSheet(popStr,waveResult,8,"")         waveStr+=waveResult+";"   endif      if (XChecked==1)       waveResult ="Xaxis"       InputSheet(popStr,waveResult,10,"")       waveStr+=waveResult+";"   endif         if (YChecked==1)       waveResult ="Yaxis"        InputSheet(popStr,waveResult,11,"")        waveStr+=waveResult+";"   endif      if (ZChecked==1)       waveResult ="Zaxis"      InputSheet(popStr,waveResult,12,"")       waveStr+=waveResult+";"   endif    if (FolderChecked==1)     waveResult = "Folder"    InputSheet(popStr,waveResult,19,"")    waveStr+=waveResult+";"   endif   if (SampleChecked==1)       waveResult = "Sample"        InputSheet(popStr,waveResult,0,"")        waveStr+=waveResult+";"   endif  DatasheetStr = waveStr  SortingFunc ()endFunction InputSheet (popStr,waveResult,i,extra)   string popStr,waveResult,extra   variable i   variable windex, Goffset    wave grallnum   Nvar Page, of, lastNo   wave/t mapt   sscanf popStr, "G%f", Goffset   LastNo = grallnum[Goffset/1000]       make/o/t/n=(LastNo+1) tempT, $waveResult      tempT[] = mapt[p+Goffset+Windex][i]+extra      tempT[0] = popStr      duplicate/o tempT $waveResultendFunction SortingFunc ()  variable i, j, p1, p2, NOofItem, sortingLeng, pieceNum  svar DatasheetStr  Nvar page, of, LastNo  string pieceStr, pieceNostr  wave/t tempT, Datasheetstock  svar P1st, P2nd, P3rd  NOofItem = ItemsInList(DatasheetStr)  make/t/o/n=(LastNo+1,NOofItem,6) Datasheetstock  Datasheetstock = ""     if (stringmatch(P1st,"Graph")==1)    PriorityNan ()  else    Priority1st ()        if (stringmatch(P2nd,"Graph")!=1)          Priority2nd ()            if (stringmatch(P3rd,"Graph")!=1)               Priority3rd ()            endif        endif              i = 1        pieceNum=0     do        pieceNostr=Datasheetstock[i][1][5]       pieceNum+=1        i+=1     while (stringmatch(pieceNostr,"")!=1)       pieceNum-=1    for (i=0 ;i<NOofItem;i+=1)       pieceStr = StringFromList(i,DatasheetStr)       make/t/o/n=(dimsize(Datasheetstock,0)+pieceNum) tempT       tempT[0] = Datasheetstock[0][i][4]       p1= 1 ; p2=1        for (j=1 ;j<=pieceNum;j+=1)            p2 = p1+str2num(Datasheetstock[j][1][5])-1       tempT[p1,p2] = Datasheetstock[p-(j-1)][i][4]       tempT[p2+1] = "---"       p1 = p2+2       endfor       duplicate/o/t  tempT $pieceStr       appendtotable $pieceStr    endfor  endif     of = 1 ; page=1end         Function PriorityNan ()  variable LowVal, Highval, skip  variable i, NOofItem, sortingLeng  svar DatasheetStr  string pieceStr  Nvar of, page  wave/t Datasheetstock   NOofItem = ItemsInList(DatasheetStr)   sortingLeng = numpnts($"Graph")    for (i=0 ;i<NOofItem;i+=1)       pieceStr = StringFromList(i,DatasheetStr)       duplicate/o/t $pieceStr tempT      appendtotable $pieceStr      Datasheetstock[][i][4] = tempT[p]  endforendFunction Priority1st ()  variable i, NOofItem, Windex, sortingLeng, skip, tolerance, sortingNo  variable sorting_i, sorting_f, LowVal, HighVal  svar P1st,DatasheetStr  Nvar LastNo  string pieceStr  wave/t tempt, Datasheetstock, No   if (stringmatch(P1st,"Temp_K")==1)    tolerance = 2.5   elseif (stringmatch(P1st,"Theta_deg")==1)    tolerance = 0.5   elseif (stringmatch(P1st,"Sweep")==1)    tolerance = 1   endif     NOofItem = ItemsInList(DatasheetStr)  sortingLeng = numpnts($"Graph")   make/o/n=(sortingLeng) $"SheetIndex"      makeindex/A $P1st $"SheetIndex"        for (i=0 ;i<NOofItem;i+=1)    pieceStr = StringFromList(i,DatasheetStr)    IndexSort $"SheetIndex" $pieceStr    duplicate/o/t $pieceStr tempT    Datasheetstock[][i][1] = tempT[p]   endfor  tempT[] = Datasheetstock[p][0][1] sorting_i=1 sorting_f=2    sortingNo=1 sortingLeng=0 Windex = 1 do    do       LowVal = str2num(tempT[sorting_i])       HighVal = str2num(tempT[sorting_f])       sorting_f+=1      sortingLeng += 1    while (LowVal-tolerance<HighVal && HighVal<LowVal+tolerance && sorting_f<=LastNo+1)  	 	 Datasheetstock[sortingNo][1][5] = num2str(sortingLeng) 		  make/o/n=(sortingLeng) $"SheetIndex"   	  make/t/o/n=(sortingLeng) tempT1   	 tempT1[] = Datasheetstock[p+Windex][1][1]     	  makeindex/A tempT1 $"SheetIndex"        for (i=0 ;i<NOofItem;i+=1)    tempT1[] = Datasheetstock[p+Windex][i][1]       IndexSort $"SheetIndex" tempT1    Datasheetstock[Windex,Windex+sortingLeng-1][i][2] = tempT1[p-Windex]    Datasheetstock[0][i][2] = Datasheetstock[0][i][1]     Datasheetstock[Windex,Windex+sortingLeng-1][i][4] = tempT1[p-Windex]     Datasheetstock[0][i][4] = Datasheetstock[0][i][1]    endfor     Windex+=sortingLeng      sorting_i=sorting_f-1   sortingNo+=1   sortingLeng=0 while (sorting_f<=LastNo+1)end    Function Priority2nd ()  variable i,j, NOofItem, Windex,WindexNo, sortingLeng, sortingLeng2, skip, tolerance, sortingNo  variable sorting_i, sorting_f, LowVal, HighVal, pieceNum  svar P2nd,DatasheetStr  Nvar LastNo  string pieceStr, pieceNostr  wave/t tempt, Datasheetstock, NoNOofItem = ItemsInList(DatasheetStr)   if (stringmatch(P2nd,"Temp_K")==1)    tolerance = 2.5   elseif (stringmatch(P2nd,"Theta_deg")==1)    tolerance = 0.5   elseif (stringmatch(P2nd,"Sweep")==1)    tolerance = 1   endif       i = 1      pieceNum=0     do        pieceNostr=Datasheetstock[i][1][5]       pieceNum+=1        i+=1     while (stringmatch(pieceNostr,"")!=1)       pieceNum-=1         Windex = 1     sortingNo=1   for (j=1 ; j<=pieceNum; j+=1)         sortingLeng = str2num(Datasheetstock[j][1][5])   make/o/n=(sortingLeng+1) $"SheetIndex"     make/t/o/n=(sortingLeng+1) tempT, tempT2   tempT[1,] = Datasheetstock[p+Windex-1][1][2]    tempT2[1,] = Datasheetstock[p+Windex-1][2][2]  // edit tempt, tempT2 ; abort    sorting_i=1	 sorting_f=2     	 WindexNo = 1   do	    sortingLeng2=0     do       LowVal = str2num(tempT[sorting_i])        HighVal = str2num(tempT[sorting_f])        sorting_f+=1       sortingLeng2 += 1     while (LowVal-tolerance<HighVal && HighVal<LowVal+tolerance && sorting_f<=sortingLeng+1)    Datasheetstock[sortingNo][2][5] = num2str(sortingLeng2)   make/o/n=(sortingLeng2) $"SheetIndex"   make/t/o/n=(sortingLeng2) tempT1   tempT1[] = tempT2[p+WindexNo]    makeindex/A tempT1 $"SheetIndex"        for (i=0 ;i<NOofItem;i+=1)    tempT1[] = Datasheetstock[p+WindexNo+Windex-1][i][2]       IndexSort $"SheetIndex" tempT1    Datasheetstock[Windex+WindexNo-1,(Windex+WindexNo-1)+(sortingLeng2-1)][i][3] = tempT1[p-(Windex+WindexNo-1)]    Datasheetstock[0][i][3] = Datasheetstock[0][i][1]     Datasheetstock[Windex+WindexNo-1,(Windex+WindexNo-1)+(sortingLeng2-1)][i][4] = tempT1[p-(Windex+WindexNo-1)]    Datasheetstock[0][i][4] = Datasheetstock[0][i][1]    endfor        WindexNo+=sortingLeng2      sorting_i=sorting_f-1   sortingNo+=1    while (sorting_f<=sortingLeng+1)    Windex+=sortingLengendforendFunction Priority3rd ()  variable i,j, NOofItem, Windex,WindexNo, sortingLeng, sortingLeng2, skip, tolerance, sortingNo  variable sorting_i, sorting_f, LowVal, HighVal, pieceNum  svar P3rd,DatasheetStr  Nvar LastNo  string pieceStr, pieceNostr  wave/t tempt, Datasheetstock, NoNOofItem = ItemsInList(DatasheetStr)   if (stringmatch(P3rd,"Temp_K")==1)    tolerance = 2.5   elseif (stringmatch(P3rd,"Theta_deg")==1)    tolerance = 0.5   elseif (stringmatch(P3rd,"Sweep")==1)    tolerance = 1   endif       i = 1      pieceNum=0     do        pieceNostr=Datasheetstock[i][2][5]       pieceNum+=1        i+=1     while (stringmatch(pieceNostr,"")!=1)       pieceNum-=1         Windex = 1     sortingNo=1   for (j=1 ; j<=pieceNum; j+=1)         sortingLeng = str2num(Datasheetstock[j][2][5])   make/o/n=(sortingLeng+1) $"SheetIndex"     make/t/o/n=(sortingLeng+1) tempT, tempT2   tempT[1,] = Datasheetstock[p+Windex-1][2][3]    tempT2[1,] = Datasheetstock[p+Windex-1][3][3]  // edit tempt, tempT2 ; abort    sorting_i=1	 sorting_f=2     	 WindexNo = 1   do	    sortingLeng2=0     do       LowVal = str2num(tempT[sorting_i])        HighVal = str2num(tempT[sorting_f])        sorting_f+=1       sortingLeng2 += 1     while (LowVal-tolerance<HighVal && HighVal<LowVal+tolerance && sorting_f<=sortingLeng+1)    Datasheetstock[sortingNo][3][5] = num2str(sortingLeng2)   make/o/n=(sortingLeng2) $"SheetIndex"   make/t/o/n=(sortingLeng2) tempT1   tempT1[] = tempT2[p+WindexNo]    makeindex/A tempT1 $"SheetIndex"        for (i=0 ;i<NOofItem;i+=1)    tempT1[] = Datasheetstock[p+WindexNo+Windex-1][i][3]       IndexSort $"SheetIndex" tempT1    Datasheetstock[Windex+WindexNo-1,(Windex+WindexNo-1)+(sortingLeng2-1)][i][4] = tempT1[p-(Windex+WindexNo-1)]    Datasheetstock[0][i][4] = Datasheetstock[0][i][1]    endfor        WindexNo+=sortingLeng2      sorting_i=sorting_f-1   sortingNo+=1    while (sorting_f<=sortingLeng+1)    Windex+=sortingLengendforendFunction Priorityfunc_back (Str1,Str2,Pval) string Str1,Str2 variable Pval   variable LowVal, Highval,LowVal2, Highval2, skip, skip2  variable i, NOofItem, sortingLeng, sorting_i, sorting_f, tolerance, tolerance2  svar DatasheetStr, Spaceline  variable P4th, space_i, nallskip  Nvar page, of, LastNo  string pieceStr  wave/t tempt, tempt1, Datasheetstock  Nvar ListNo  svar P1st   NOofItem = ItemsInList(DatasheetStr) duplicate/t/o $Str1 tempT    duplicate/t/o $Str2 tempT1       if (stringmatch(Str1,"No")==1)    skip=1   elseif (stringmatch(Str1,"Temp_K")==1)    tolerance = 2.5   elseif (stringmatch(Str1,"Theta_deg")==1)    tolerance = 0.5   elseif (stringmatch(Str1,"Sweep")==1)    tolerance = 1   endif     if (Pval==3)  duplicate/t/o $P1st tempT4     if (stringmatch(P1st,"No")==1)     skip2=1    elseif (stringmatch(P1st,"Temp_K")==1)     tolerance2 = 2.5    elseif (stringmatch(P1st,"Theta_deg")==1)     tolerance2 = 0.5    elseif (stringmatch(P1st,"Sweep")==1)     tolerance2 = 1    endif  endif   sorting_f=0   space_i=0if (skip!=1 && skip2!=1)    do   sorting_i=sorting_f+1   sorting_f+=1   sortingLeng=0      if (Pval==2)     do       LowVal = str2num(tempT[sorting_i])       HighVal = str2num(tempT[sorting_f])       sorting_f+=1      sortingLeng += 1      //print "A", "LowVal", LowVal, "HighVal", HighVal     while (LowVal-tolerance<HighVal && HighVal<LowVal+tolerance && sorting_f<=LastNo+1)        sortingLeng-=1      sorting_f = sorting_i+sortingLeng-1         elseif (Pval==3)   do      if (stringmatch(tempT[sorting_i],"---")!=1 )      LowVal = str2num(tempT[sorting_i])      HighVal = str2num(tempT[sorting_f])      LowVal2 = str2num(tempT4[sorting_i])      HighVal2 = str2num(tempT4[sorting_f])      sorting_f+=1      sortingLeng += 1      nallskip=0     // print "A", "LowVal", LowVal, "HighVal", HighVal     else     	 	HighVal = LowVal+2*tolerance     	HighVal2 = LowVal+2*tolerance2     	      sorting_f+=2 ;      sortingLeng+=2     	nallskip=1     //	print "B"     endif        while ( LowVal-tolerance<HighVal && HighVal<LowVal+tolerance && LowVal2-tolerance2<HighVal2 && HighVal2<LowVal2+tolerance2 && sorting_f<dimsize(tempT,0))     sortingLeng-=1     sorting_f = sorting_i+sortingLeng-1      //print "sorting_f", sorting_f, "sortingLeng", sortingLeng endif     make/t/o/n=(sortingLeng) tempT2   tempT2[] = tempT1[p+sorting_i] // cut from P2nd   make/o/n=(sortingLeng) $"SheetIndex"     makeindex/A tempT2 $"SheetIndex"  //make index of cue P2nd   for (i=0 ;i<NOofItem;i+=1)    pieceStr = StringFromList(i,DatasheetStr)    duplicate/o/t $pieceStr tempT3    tempT2[] = tempT3[p+sorting_i]     IndexSort $"SheetIndex" tempT2              Datasheetstock[sorting_i+space_i,sorting_f+space_i][i] = tempT2[p-sorting_i+space_i]   endfor       if (Pval==2 && stringmatch(Spaceline,"Yes"))       space_i+=1         for (i=0 ;i<NOofItem;i+=1)            // print "LastNo", LastNo         Redimension/N=( (LastNo+1)+(space_i),-1) Datasheetstock        Datasheetstock[sorting_f+(space_i)][i]="---"     endfor       endif   while (sorting_f<LastNo)  for (i=0 ;i<NOofItem;i+=1)       pieceStr = StringFromList(i,DatasheetStr)       make/t/o/n=(dimsize(Datasheetstock,0)) tempT3       tempT3[] = Datasheetstock[p][i]      duplicate/o/t  tempT3 $pieceStr  endforendif   endFunction ButtsheetShow (ctrlName) : ButtonControl String ctrlName dowindow/f datasheetend    Function PageListFunc(ctrlName) : ButtonControl String ctrlName Nvar ListNo, page svar Goffinfo variable Goffset wave grallnum Nvar of , page, LastNo sscanf Goffinfo, "G%f", Goffset page = 1 ; ListNo = 31 of = ceil((dimsize(Datasheetstock,0)-1)/ListNo) LastNo=dimsize(Datasheetstock,0)-1 pageFunc ()EndFunction pageFunc () Nvar page, of, ListNo, LastNo wave/t Datasheetstock variable i, Windex, NOofItem Svar DatasheetStr string pieceStr NOofItem = ItemsInList(DatasheetStr) for (i=0 ;i<NOofItem;i+=1)    pieceStr = StringFromList(i,DatasheetStr)    Windex = ListNo*(page-1)    make/t/o/n=(ListNo) tempT    tempT = ""    if (Windex+ListNo-1< LastNo)    tempT[]=Datasheetstock[p+Windex][i][4]    else     tempT[0,LastNo-Windex+1]=Datasheetstock[p+Windex][i][4]    endif    duplicate/t/o tempT $pieceStr  endforend Function AutoPageFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	Nvar page, of	svar Goffinfo	wave grallnum	Nvar ListNo, LastNo	variable Goffset	LastNo=dimsize(Datasheetstock,0)-2	page = varNum   ListNo = 31	of = ceil((LastNo+1)/ListNo)	   if (page > of)	 page = of	endif	pageFunc ()end	Function AllInfoCheckFunc(ctrlName) : ButtonControl	String ctrlName   Nvar  FolderChecked, SampleChecked, SliceNoChecked, SweepChecked, PassEChecked, EiiChecked, EffChecked   Nvar EstepChecked, DateChecked, TimeChecked, TempChecked, XChecked, YChecked, ZChecked, ThetaChecked    FolderChecked=1; SampleChecked=1; SliceNoChecked=1; SweepChecked=1    PassEChecked=1; EiiChecked=1; EffChecked=1; EstepChecked=1; DateChecked=1    TimeChecked=1; TempChecked=1; XChecked=1; YChecked=1; ZChecked=1; ThetaChecked=1EndFunction NonInfoCheckFunc(ctrlName) : ButtonControl	String ctrlName   Nvar  FolderChecked, SampleChecked, SliceNoChecked, SweepChecked, PassEChecked, EiiChecked, EffChecked   Nvar EstepChecked, DateChecked, TimeChecked, TempChecked, XChecked, YChecked, ZChecked, ThetaChecked    FolderChecked=0; SampleChecked=0; SliceNoChecked=0; SweepChecked=0    PassEChecked=0; EiiChecked=0; EffChecked=0; EstepChecked=0; DateChecked=0    TimeChecked=0; TempChecked=0; XChecked=0; YChecked=0; ZChecked=0; ThetaChecked=0EndFunction FolderCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar FolderChecked  FolderChecked = checkedEndFunction SampleCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar SampleChecked  SampleChecked = checkedEndFunction SliceNoCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar SliceNoChecked  SliceNoChecked = checkedEndFunction SweepCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar SweepChecked  SweepChecked = checkedEndFunction PassECheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar PassEChecked  PassEChecked = checkedEndFunction EiCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar EiiChecked  EiiChecked = checkedEndFunction EfCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar EffChecked  EffChecked = checkedEndFunction EstepCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar EstepChecked  EstepChecked = checkedEndFunction DateCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar DateChecked  DateChecked = checkedEndFunction TimeCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar TimeChecked  TimeChecked = checkedEndFunction TempCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar TempChecked  TempChecked = checkedEndFunction XCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar XChecked  XChecked = checkedEndFunction YCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar YChecked  YChecked = checkedEndFunction ZCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar ZChecked  ZChecked = checkedEndFunction ThetaCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar ThetaChecked  ThetaChecked = checkedEndFunction TiltCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar TiltChecked  TiltChecked = checkedEndFunction PsiCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar PsiChecked  PsiChecked = checkedEndWindow AutoGraphOption() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/k=1/W=(987,424,1221,741)	ModifyPanel cbRGB=(61166,61166,61166)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 10,243,222,243	SetDrawEnv linethick= 2	DrawLine 8,205,220,205	SetDrawEnv linethick= 2	DrawLine 8,169,220,169	SetDrawEnv linethick= 2	DrawLine 9,131,221,131	SetDrawEnv linethick= 2	DrawLine 11,278,223,278	Button ButtonGraph,pos={16,175},size={55,19},proc=TBProc,title="TB"	Button ButtonGraph2,pos={83,175},size={54,20},proc=SelfProc,title="Self"	Button ButtonGraph3,pos={11,43},size={65,19},proc=ScientaProc,title="Scienta"	Button button5,pos={80,9},size={66,19},proc=ALSProc,title="ALS"	Button button06,pos={86,42},size={65,20},proc=EvsKzProc,title="E vs kz"	Button button17,pos={91,215},size={64,20},proc=SetTraceColor,title="tracecolor"	Button button11,pos={9,8},size={68,20},proc=LoadIgorProc,title="LoadIgor"	Button button12,pos={13,141},size={66,20},proc=GetEFfunc,title="Get EF"	Button button19,pos={156,140},size={67,20},proc=FermiMultiFunc,title="FermiMulti"	Button ButtonGraph4,pos={149,175},size={55,20},proc=SelfProc_v2,title="Self_v2"	Button button10,pos={14,249},size={63,20},proc=Auto_Analize,title="Analize"	Button button13,pos={102,290},size={45,24},proc=Auto_Other,title="Other"	Button button13,fStyle=1	Button button14,pos={153,7},size={67,20},proc=CutImagefunc,title="Cut Image"	Button button15,pos={86,140},size={63,21},proc=InputEFfunc,title="Input EF"	Button ButtonGraph1,pos={14,214},size={71,20},proc=getColorProc,title="get color"	Button ButtonGraph5,pos={158,43},size={65,19},proc=cutang,title="GetAngle"	Button ButtonGraph6,pos={10,73},size={81,19},proc=Imgsym,title="ImgSymetize"	Button ButtonGraph7,pos={95,72},size={76,21},proc=Laserhv,title="Laser wl2hv"	Button button18,pos={88,250},size={72,20},proc=SE_ButtonProc,title="SelfEnergy"	Button ButtonGraph8,pos={12,101},size={76,21},proc=ButtonProc_circular,title="Circular data"EndMacroProc getColorProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f getColortable	if (V_flag==0)	  getColortable()	endifEndFunction InputEFfunc (ctrlName) : ButtonControl	String ctrlName  	string name	variable firstG, lastG,i	Svar EFvsT_curveName	Nvar EFvsT_firstG, EFvsT_lastG	wave map	 firstG = EFvsT_firstG	 lastG = EFvsT_lastG	 name = EFvsT_curveName	 prompt name "EF vs T curve: "   Prompt firstG "Start No.: "   Prompt lastG, "End No.: "    Doprompt "Input EF with T variation", name, firstG, lastG  if (V_Flag)  		 return -1  endif    EFvsT_curveName = name   EFvsT_firstG = firstG	 EFvsT_lastG = lastG   //make/o/n=(dimsize($name,0)) temp, temp1   duplicate/o $name, temp temp1   temp1[]= pnt2x($name,p)   for (i=firstG; i<=lastG; i+=1)   		map[i][7] = interp(map[i][0],temp1,temp)   endforendproc CutImageFunc (ctrlName) : ButtonControlstring ctrlNamestring/g CutImg_Goffset="G0000"variable/g CutImg_InitialG, CutImg_FinalG,  CutImg_iFirstNo, CutImg_iLastNo,  CutImg_fFirstNo, CutImg_fLastNodowindow/f CutImagePanelif(V_flag==0)CutImagePanel()endifendWindow CutImagePanel() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel /W=(588,420,886,593)/K=1/N=CutImagePanel	Button button0,pos={181,7},size={61,31},proc=ImageCutFunc,title="Cut",fSize=18	Button button0,fStyle=1	SetVariable setvar0,pos={10,57},size={115,18},title="Initial Graph"	SetVariable setvar0,value= CutImg_InitialG	SetVariable setvar1,pos={161,57},size={120,18},title="Final Graph"	SetVariable setvar1,value= CutImg_FinalG	SetVariable setvar2,pos={11,88},size={115,18},title="First slice"	SetVariable setvar2,value= CutImg_iFirstNo	SetVariable setvar3,pos={14,113},size={112,18},title="last slice"	SetVariable setvar3,value= CutImg_iLastNo	SetVariable setvar4,pos={161,85},size={121,18},title="First slice"	SetVariable setvar4,value= CutImg_fFirstNo	SetVariable setvar5,pos={163,112},size={118,18},title="last slice"	SetVariable setvar5,value= CutImg_fLastNo	Button button1,pos={53,142},size={50,20},proc=CutImg_getcsri,title="Cursor"	Button button2,pos={202,140},size={50,20},proc=CutImg_getcsrf,title="Cursor"	PopupMenu popup0,pos={13,13},size={103,21},proc=ImageCut_Goffset,title="Goffset"	PopupMenu popup0,mode=1,popvalue="G1000",value= #"StringList(\"G*000\",\";\")"EndMacroFunction CutImg_getcsri(ctrlName) : ButtonControl	String ctrlName	nvar CutImg_iFirstNo, CutImg_iLastNo	CutImg_iFirstNo=qcsr(A)	CutImg_iLastNo=qcsr(B)EndFunction CutImg_getcsrf(ctrlName) : ButtonControl	String ctrlName	nvar CutImg_fFirstNo, CutImg_fLastNo	CutImg_fFirstNo=qcsr(A)	CutImg_fLastNo=qcsr(B)EndFunction ImageCut_Goffset(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar CutImg_Goffset	CutImg_Goffset=popStrEndFunction  ImageCutFunc (ctrlName) : ButtonControl	String ctrlNamesvar Goffset=CutImg_Goffsetnvar InitialG=CutImg_InitialGnvar FinalG=CutImg_FinalGnvar iFirstNo=CutImg_iFirstNonvar iLastNo=CutImg_iLastNonvar fFirstNo=CutImg_fFirstNonvar fLastNo=CutImg_fLastNovariable Goffval, i , sizeX, sizeY, Windexstring  base2Dvariable FirstNoprint Goffsetsscanf Goffset, "G%f", GoffvalsizeY=abs(fLastNo-fFirstNo)<abs(iLastNo-iFirstNo)?abs(fLastNo-fFirstNo):abs(iLastNo-iFirstNo)for (i=InitialG;i<=FinalG;i+=1)    Windex = Goffval+i    base2D ="gr"+num2istr(Windex)    duplicate/o $base2D temp1    sizeX=dimsize($base2D,0)//    sizeY=(LastNo-FirstNo)+1    Make/o/N=(sizeX,sizeY)/D temp2    FirstNo=iFirstNo+round((i-InitialG)*(fFirstNo-iFirstNo)/(FinalG-InitialG))    temp2[][]=temp1[p][q+FirstNo]    duplicate/o temp2, $base2DendforendProc Auto_Analize (ctrlName) : ButtonControl	String ctrlName		dowindow/f AutoAnalize	if (V_flag!=1)	AutoAnalize()	endifendProc Auto_Other (ctrlName) : ButtonControl	String ctrlName		dowindow/f AutoOther	if (V_flag!=1)	AutoOther()	endifendWindow AutoOther() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(664,660,900,767)	Button button0,pos={81,52},size={53,20},proc=ScopeButton_Sbackgr,title="UnBkgr"	Button button1,pos={13,7},size={57,20},proc=ScopeButton_gbackgr,title="GetBkgr"	Button button4,pos={14,29},size={42,20},proc=scopeButton_nk,title="n(k)"	Button button4_1,pos={61,29},size={42,20},proc=scopeButton_nw,title="n(w)"	Button button6,pos={14,77},size={48,20},proc=ScopeButton_surf,title="Surfer"	Button button7,pos={158,28},size={41,20},proc=ScopeButton_diff,title="diff"	Button button8,pos={75,7},size={46,20},proc=scopebutton_disp1,title="Disp1"	Button button09,pos={126,6},size={46,20},proc=scopebutton_disp2,title="Disp2"	Button button16,pos={178,6},size={46,20},proc=scopebutton_disp3,title="Disp3"	Button button9,pos={109,29},size={45,20},proc=scopeButton_width,title="FWHM"	Button button13,pos={140,52},size={42,20},proc=scopeButton_norm,title="Norm"	Button button14,pos={12,52},size={64,21},proc=ScopeButton_DivFermi,title="Div Fermi"	Button button15,pos={187,51},size={33,20},proc=scope_gaussfit,title="fitG"	Button button18,pos={71,76},size={68,20},proc=CurveRotaProc,title="CurveRota"	Button button19,pos={147,76},size={75,20},proc=MultiPeakFit,title="MultiPeakFit"EndMacroFunction MultiPeakFit(ctrlname): Buttoncontrol                  String ctrlname         variable kpoints,epointsvariable i,j,kwave wwwave mybaby, fsmapping_fit,fsmapping_fit2wave temp_rui,temp_rui1duplicate/o $"FSrotamap" mybabykpoints=dimsize(mybaby,0)epoints=dimsize(mybaby,1)make/o/n=300 wwmake fsmapping_fitmake fsmapping_fit2Redimension/N=(10,kpoints) fsmapping_fit    make/n=(epoints) /o temp_rui1       make/n=(10,5) /o temp_ruifor(i=0;i<kpoints;i=i+1)        temp_rui1[]=mybaby[i][p]    ww[i]=mpf2_autompfit("ruijiang","Lorentzian","peakcoefs%d","None","abc","temp_rui1","",5)    duplicate/o $"root:ruijiang_0:W_AutoPeakInfo" temp_rui    fsmapping_fit[][i]=temp_rui[p][0]endforRedimension/N=(kpoints,epoints) fsmapping_fit2fsmapping_fit2[][]=0for(i=0;i<kpoints;i=i+1)  for(j=0;j<10;j=j+1)       k=fsmapping_fit[j][i]       fsmapping_fit2[i][k]=1  endfor  endforRedimension/N=(10,epoints) fsmapping_fit    make/n=(kpoints) /o temp_rui1       make/n=(10,5) /o temp_ruifor(i=0;i<epoints;i=i+1)        temp_rui1[]=mybaby[p][i]    ww[i]=mpf2_autompfit("ruijiang","Lorentzian","peakcoefs%d","None","abc","temp_rui1","",5)    duplicate/o $"root:ruijiang_0:W_AutoPeakInfo" temp_rui    fsmapping_fit[][i]=temp_rui[p][0]endforRedimension/N=(kpoints,epoints) fsmapping_fit2for(i=0;i<epoints;i=i+1)  for(j=0;j<10;j=j+1)       k=fsmapping_fit[j][i]       fsmapping_fit2[k][i]=1  endfor  endfordisplay/w=(30,30,300,300)appendimage mybabyappendimage fsmapping_fit2setscale/I x,-4,4,fsmapping_fit2setscale/I y,-4,4,fsmapping_fit2modifyimage fsmapping_fit2, explicit=1, eval={0,0, -1, 0 },eval={1,65535, 0, 0 }            endProc SelfProc_v2 (ctrlName) : ButtonControl	String ctrlName	dowindow/f Self_Energy_v2	if (V_flag!=1)	variable/g SE_gap	variable/g selfmap_gh	variable/g selfmap_gw	variable/g selfmap_gp	variable/g selfmap_gaussck	Self_Energy_v2()	endifEndProc SelfProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f Self_Energy	if (V_flag!=1)	Self_Energy()	endifEndFunction FermiMultiFunc (ctrlName) : ButtonControl	String ctrlName  	Nvar scope_graph  variable startGraph, endGraph, i, j=0  wave wFermi, map  prompt startGraph, "Start Graph"  prompt endGraph, "End Graph"  Doprompt "Fermi fitting", startGraph, endGraph  if (V_Flag)   		return -1  endif  make /o /d /n=(endGraph-startGraph+1) FermiEnergyWave, ResolutionWave, GraphNoWave  FermiEnergyWave[]=nan; ResolutionWave[]=nan; GraphNoWave[]=nan  FermiMulti_panel ()  for (i=startGraph; i<=endGraph; i+=1)  	scope_graph=i  	ScopeButton_ChangeGraph ("",0,"","")  	Scopebutton_fermi ("")    	FermiEnergyWave[j]=map[i][9]  	ResolutionWave[j]=map[i][10]      GraphNoWave[j]=i    j+=1    dowindow/f FermiMultiPanel  endfor   endFunction FermiMulti_panel () : Graph   wave FermiEnergyWave,ResolutionWave,GraphNoWave   string panelname   string aup, auw, fit_aup, fit_auw, paneltext1, paneltext2, BottomLabel, BottomNumstr    wave map   dowindow/f FermiMultiPanel   if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(454,72,842,463) ResolutionWave vs GraphNoWave	dowindow/c FermiMultiPanel	AppendToGraph/L=VertCrossing/B=HorizCrossing FermiEnergyWave vs GraphNoWave 	ModifyGraph mode(FermiEnergyWave)=4,mode(ResolutionWave)=4	ModifyGraph marker(FermiEnergyWave)=19,marker(ResolutionWave)=19	ModifyGraph rgb(ResolutionWave)=(9,37552,0)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-2.57143,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.41}	ModifyGraph axisEnab(VertCrossing)={0.59,1}	ModifyGraph standoff=1	endif		Label VertCrossing "Energy (eV)";DelayUpdate   Label HorizCrossing "Graph No"     Label left "dE (eV)";DelayUpdate   Label bottom "Graph No"EndMacroProc CurveRotaProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f CurveRota	if (V_flag!=1)     CurveRota()	endifEndWindow CurveRota() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(584,501,827,547)	SetVariable setvar4,pos={14,10},size={118,15},title="rotation (deg)"	SetVariable setvar4,limits={-inf,inf,1},value= CurveRotaAngle	Button button07,pos={139,7},size={84,20},proc=RotaCurveFunc,title="Go rotation"EndMacroproc RotaCurveFunc (ctrlName) : ButtonControl	String ctrlName  	string Ybase, Xbase, Yrota, Xrota	string waveAll, printstr  variable Itemtotal, i  silent 1 ; pauseupdate	 Ybase = CsrWave(a)	 Xbase = CsrXWave(a)	 Yrota = CsrWave(a)+"_rota"	 Xrota = CsrXWave(a)+"_rota"   RotationFunc(Xbase,Ybase,Xrota,Yrota,CurveRotaAngle)      	waveAll = wavelist("*",";","win:")	Itemtotal = ItemsInList(waveAll, ";")	do 	  printstr = StringFromList(i, waveAll)	  if (stringmatch(printstr,Yrota)==1)	    abort	  endif	  i+=1	while (i<Itemtotal)	 appendtograph $Yrota vs $XrotaendFunction GetEFfunc (ctrlName) : ButtonControl	String ctrlName  	variable firstG, lastG   Prompt firstG "Start No.: "   Prompt lastG, "End No.: "    Doprompt "Get and Input EF", firstG, lastG  if (V_Flag)   return -1  endif   getfermi(firstG, lastG)endFunction getfermi(startgr,endgr)	variable startgr, endgr	variable i	Nvar scope_graph, scope_add	wave map, scopex, scope0	string Name	svar dispwave	i=startgr	do		scope_graph=i		changescope()		Name = dispwave + num2str(i)		scope_add = dimsize($Name,1)		addfunc () 		differentiate scope0		wavestats/q scope0		map[i][7]+=scopex[v_minloc]		print "Graph",i,",",map[i][7]		i+=1	while(i<=endgr)endProc LoadIgorProc (ctrlName) : ButtonControl	String ctrlName		dowindow/f LoadIgor	if (V_flag!=1)	LoadIgor()	endifendWindow LoadIgor() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(331,229,564,292)	Button button0,pos={21,9},size={72,20},proc=LoadDataFunc_igor,title="LoadIgor"	CheckBox auto,pos={99,12},size={38,14},proc=autloadCheck,title="auto",value= 0	SetVariable Filename,pos={8,31},size={203,15},disable=2,title="Last"	SetVariable Filename,value= LastpathinfoEndMacroFunction LoadDataFunc_igor (ctrlName) : ButtonControl	String ctrlName	string  path, filename, LoadOptionlocal	variable spellleng, i	Nvar autloadChecked  svar LastFoldername, LoadOption	if (autloadChecked==0) 	  newpath/o DataFile   	  		if (V_flag != 0) 		 return -1; // User cancelled.  	  endif   endif    pathinfo DataFile     LastFoldername = StringFromList(ItemsInList(s_path,":")-1, s_path,":")     filename= IndexedFile(DataFile,0,".pxt")   if (stringmatch(filename,"")==1)   abort "There is no file!! Select a correct folder."   endif    path=S_path+filename[0,(strlen (filename)-9)]   LoadFileSetFunc_igor (path,S_path, filename)   dowindow/f AutographEnd Function LoadDataFunc_igor_back (ctrlName) : ButtonControl	String ctrlName	string  path, filename, LoadOptionlocal	variable spellleng, i	Nvar autloadChecked  svar LastFoldername, LoadOption	if (autloadChecked==0) 	  newpath/o DataFile   	  		if (V_flag != 0) 		 return -1; // User cancelled.  	  endif   endif    pathinfo DataFile     spellleng = strlen(S_path)    i=spellleng-2    do      i-=1    while (stringmatch(S_path[i],S_path[spellleng-1])!=1)    LastFoldername = S_path[i+1,spellleng-2]    filename= IndexedFile(DataFile,0,".pxt")   if (stringmatch(filename,"")==1)   abort "There is no file!! Select a correct folder."   endif    path=S_path+filename[0,(strlen (filename)-9)]   LoadFileSetFunc_igor (path,S_path, filename)   dowindow/f AutographEnd Function LoadFileSetFunc_igor (path,S_path, filename)string path,S_path, filenamesvar Goffsetstringstring postfix=".pxt", offsetstring, firstfilename, OffsetStrvariable firstG, lastG, offset, i, totaldataNoNVar last_ff, last_lf, Goffset, autloadCheckedNvar lastNorm_ff, lastNorm_lf, GoffsetNorm Nvar lastEF_ff, lastEF_lf, GoffsetEFsvar FolderPathwave map, mapTOffsetStr = "0000"+";1000"+";2000"+";3000"+";4000"+";5000"+";6000"+";7000"+";8000"+";9000"OffsetStr+= ";10000"+";11000"+";12000"+";13000"+";14000"+";15000"+";16000"+";17000"+";18000"+";19000"OffsetStr+= ";20000"+";21000"+";22000"+";23000"+";24000"+";25000"+";26000"+";27000"+";28000"+";29000"OffsetStr+= ";30000"+";31000"+";32000"+";33000"+";34000"+";35000"+";36000"+";37000"+";38000"+";39000"OffsetStr+= ";40000"+";41000"+";42000"+";43000"+";44000"+";45000"+";46000"+";47000"+";48000"+";49000"+";50000" if (autloadChecked==1)     lastG=inf  elseif (autloadChecked!=1) totaldataNo = ItemsInList(IndexedFile(DataFile,-1,".pxt")) lastG=str2num(filename[(strlen (filename)-5)])+totaldataNo-1endiffirstG=last_lf; offset=Goffset; offsetstring=Goffsetstringif (stringmatch(S_path,FolderPath)!=1)  firstfilename = Indexedfile(DataFile,0,".pxt")  firstG=str2num(firstfilename[(strlen (firstfilename)-5)])  FolderPath=S_pathendifif (autloadChecked==0)  Prompt firstG "Start No.: "  Prompt lastG, "End No.: "    Prompt offsetstring, "Graph offset: ", popup , OffsetStr  Doprompt "Load Data Number", offsetstring,firstG, lastG  if (V_Flag)   return -1  endif endifoffset=str2num(offsetstring)Goffset=offset ; GoffsetNorm=offset ; GoffsetEF=offsetGoffsetstring=offsetstring  if (map[0][0] < Goffset+1000)   Redimension/N=(Goffset+1000,-1) map   Redimension/N=(Goffset+1000,-1) mapT map[0][0]=Goffset+1000 //map[2,Goffset+1000-1][0]=1 endif   LoadSynchFunc_igor ( path, postfix,firstG, lastG,offset)   last_ff=firstG ; lastNorm_ff=firstG ; lastEF_ff=firstGendFunction LoadSynchFunc_igor (path, postfix, firstG , lastG, offset)	String path, postfix	Variable firstG, lastG, offset  Nvar last_lf, autloadChecked, lastNorm_lf, lastEF_lf	String  theGraph, thewavex, thewavey, grx, logtext, Logname 	Variable WNum, GNum, i, i_updated, i_initial, logstart=0	string  filepathname, Goffstring, firstfilename, filename, infowave	svar Lastpathinfo, lastfoldername, lastgr  WAVE map, GrAllNum  wave/t mapt  string FileNamePath  variable Epoints, kpoints  Logname="LogG"+num2istr(offset)	if (offset==0)	Logname+="000"	endif  firstfilename = Indexedfile(DataFile,0,".pxt")  i_initial=str2num(firstfilename[(strlen (firstfilename)-5)])   i_updated=firstG-i_initial	for ( GNum=firstG; GNum <= LastG; GNum+=1 )		if ( GNum<10 ) 				theGraph = path+"000" 				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "000" +num2istr(GNum)+postfix		elseif ( GNum < 100 )				theGraph = path + "00"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "00" +num2istr(GNum)+postfix	   elseif ( GNum < 1000 )				theGraph = path + "0"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "0" +num2istr(GNum)+postfix		else			theGraph = path					filename=firstfilename[0,(strlen (firstfilename)-9)]+num2istr(GNum)+postfix		endif 		theGraph+= num2istr(GNum)+postfix		for (i=i_updated; stringmatch (filename,indexedfile(DataFile,i,".pxt"))!=1 ; i+=1)		 if  (stringmatch (indexedfile(DataFile,i,".pxt"),"")==1)		 	  logtext = "**************** Load END of Goffset "+num2istr(offset)+" ****************\r\r"	    Notebook $Logname  text=logtext	    Goffstring="G"+num2istr(offset)	    if (offset==0)	   Goffstring+="000"	   endif	  string/g $Goffstring	  Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldername	      if (autloadChecked==1)	      return -1	      else		     abort "There is no file of No. " + num2istr(GNum)+" !!"		   endif		  endif		  i_updated=i+1		 endfor		 	  loaddata/T=aaa/q/o theGraph		filepathname = theGraph    theGraph = "gr"+num2istr(Gnum+offset)		grx = "gx"+num2istr(Gnum+offset)	    FileNamePath  = "root:aaa:"+ GetIndexedObjName("root:aaa:", 1, 0)     duplicate/o $FileNamePath temp1    Epoints = dimsize(temp1,0)    make/o/n=(Epoints) temp	  temp[] = DimOffset(temp1, 0) + p*DimDelta(temp1,0)	  duplicate/o temp $grx	      WNum = dimsize(temp1,1)   // print WNum   if(wnum > 1)			duplicate/o temp1 $theGraph   elseif (wnum == 0)      make /o/n=(Epoints) temp      temp[] = temp1[p]     duplicate/o temp $theGraph   endif     SetScale/P x 0,1,"", temp1     SetScale/P y 0,1,"", temp1     		DoWindow/F $Logname	if (V_flag == 0)		     NewNotebook/W=(30,30,1000,200) /F=0/N=$Logname/V=1   endif   notebook $Logname selection={startOfFile, startOfFile}    do      notebook $Logname findText={theGraph+" ", 0}     if (V_flag==1)     Notebook $Logname  text="updated"     endif    while (V_flag==1)   Notebook $Logname fSize=12   notebook $Logname selection={endoffile, endoffile}    if ( GNum==0 ||  GNum==1 && logstart==0)     logtext ="////////////////////  "+"Wavename"+" ,  "+"Slice numbers"+" ,  "+ "Sweep times" +" ,  "+"Path of data"+"  ////////////////////"+"\r"	   Notebook $Logname  text=logtext	   logstart+=1	 endif   logtext = theGraph+" ,  "+mapt[Gnum+offset][4]+" slices ,  "+ mapt[Gnum+offset][2]+" times ,  "+filepathname+"\r"	Notebook $Logname  text=logtext		if (GrAllNum[offset/1000]<GNum)		GrAllNum[offset/1000]=GNum		endif		last_lf=GNum; lastNorm_lf=GNum; lastEF_lf=GNum		lastgr = theGraphendfor	if(map[0][0]<Gnum-1)	map[0][0] = Gnum-1+offset	endif	Notebook $Logname fSize=12   logtext = "**************** Load END of Goffset "+num2istr(offset)+" ****************\r\r"	Notebook $Logname  text=logtext	Goffstring="G"+num2istr(offset)	if (offset==0)	 Goffstring+="000"	endif	string/g $Goffstring	Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldernameEndfunction  roadIgorImage (Folder, IgorNameBase, ImageName, startNo, endNo)string Folder, IgorNameBase, ImageNamevariable  startNo, endNostring Name,result,resultX,Path,Nostr,IgorNamevariable i, Epoints, Kpointssetdatafolder $"root:"for (i=startNo;i<=endNo;i+=1)  if (strlen(num2str(i))==1)    Nostr = "000"+num2str(i)  elseif (strlen(num2str(i))==2)     Nostr = "00"+num2str(i)  elseif (strlen(num2str(i))==3)     Nostr = "0"+num2str(i)  endif  IgorName = IgorNameBase+"_"+Nostr	Path="root:"+Folder+":"+IgorName+":"	Name=Path+ImageName	duplicate/o $name temp, temp2	Epoints = dimsize(temp,0) 	Kpoints = dimsize(temp,1)	result = "gr"+num2str(i)	resultX = "gx"+num2str(i)	make/o/n=(Epoints,Kpoints) $result	make/o/n=(Epoints) $resultX, temp1	temp1[] = DimOffset(temp, 0) + p*DimDelta(temp, 0)	duplicate/o temp $result	duplicate/o temp1 $resultX  SetScale/P x 0,1,"", $result  SetScale/P y 0,1,"", $resultendforendProc Deriva2ndproc (ctrlName) : ButtonControl	String ctrlName	dowindow/f Deriva2nd	if (V_flag!=1)	 Deriva2nd()	endifend	Window Deriva2nd() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel /K=1/W=(990,263,1241,651)	SetDrawLayer UserBack	SetDrawEnv fillfgc= (65280,59904,48896)	DrawRect 6,112,242,273	SetDrawEnv fillfgc= (57344,65280,48896)	DrawRect 5,9,243,80	DrawText 17,151,"EDC"	DrawText 17,171,"MDC"	DrawText 82,130,"Smooth Times"	DrawText 107,194,"Mean"	SetDrawEnv linethick= 1.5	DrawLine 12,220,235,220	SetDrawEnv linethick= 1.5	DrawLine 12,177,235,177	DrawText 67,239,"Fit Points in Fiting Mode"	SetDrawEnv fillfgc= (57344,65280,48896)	DrawRect 6,309,244,380	Button Go2div,pos={10,279},size={64,22},proc=D2nd_difimg,title="Image",fSize=14	Button Go2div,fStyle=1	Button All2div,pos={86,279},size={87,23},proc=D2nd_difmultiImg,title="MultiImage"	Button All2div,fSize=14,fStyle=1	PopupMenu EFpopup,pos={12,346},size={94,21},proc=D2nd_showextdif,title=" "	PopupMenu EFpopup,mode=72,popvalue="DifEDC1020",value= #"\"_none_;\" + WaveList(\"DifEDC*\",\";\",\"\")"	CheckBox Sym,pos={184,285},size={16,14},title="",variable=d2nd_2dchecked	Button button21,pos={154,317},size={55,24},proc=D2nd_MapGraph,title="Graph"	Button button21,fStyle=1	PopupMenu EFpopup1,pos={135,348},size={96,21},proc=D2nd_showextdif,title=" "	PopupMenu EFpopup1,mode=71,popvalue="DifMDC1018",value= #"\"_none_;\" + WaveList(\"DifMDC*\",\";\",\"\")"	PopupMenu ListGoffset,pos={10,21},size={103,21},proc=D2nd_Goffsetproc,title="Goffset"	PopupMenu ListGoffset,mode=2,popvalue="G1000",value= #"StringList(\"G*000\",\";\")"	PopupMenu popup0,pos={10,47},size={52,21},proc=D2nd_Data_type,title=" "	PopupMenu popup0,mode=1,popvalue="raw",value= #"\"raw;norm;combo\""	SetVariable setvar7,pos={74,48},size={79,18},proc=change_dispwave,title="dispwave"	SetVariable setvar7,valueBackColor=(56576,56576,56576)	SetVariable setvar7,value= D2nd_dispwave,noedit= 1	Button button11,pos={169,49},size={64,19},proc=D2nd_showimg,title="ShowImg"	SetVariable setvar02,pos={127,21},size={89,18},proc=D2d_ChangeGraph,title="Graph"	SetVariable setvar02,limits={0,inf,1},value= D2nd_graph	SetVariable setvar03,pos={53,134},size={57,18},proc=D2nd_paraChange,title="1"	SetVariable setvar03,limits={1,inf,1},value= D2nd_EDCsm1	PopupMenu popup1,pos={120,86},size={111,21},proc=D2nd_difmodefuc,title=" 2nd mode"	PopupMenu popup1,mode=1,popvalue="Fast",value= #"\"Fast;Fitting\""	SetVariable setvar04,pos={120,134},size={52,18},proc=D2nd_paraChange,title="2"	SetVariable setvar04,limits={1,inf,1},value= D2nd_EDCsm2	SetVariable setvar05,pos={179,134},size={52,18},proc=D2nd_paraChange,title="3"	SetVariable setvar05,limits={1,inf,1},value= D2nd_EDCsm3	SetVariable setvar06,pos={53,154},size={57,18},proc=D2nd_paraChange,title="1"	SetVariable setvar06,limits={1,inf,1},value= D2nd_MDCsm1	SetVariable setvar07,pos={120,154},size={52,18},proc=D2nd_paraChange,title="2"	SetVariable setvar07,limits={1,inf,1},value= D2nd_MDCsm2	SetVariable setvar08,pos={179,154},size={52,18},proc=D2nd_paraChange,title="3"	SetVariable setvar08,limits={1,inf,1},value= D2nd_MDCsm3	PopupMenu popup2,pos={8,86},size={51,21},proc=D2nd_dimfunc	PopupMenu popup2,mode=1,popvalue="EDC",value= #"\"EDC;MDC\""	Button All2div1,pos={204,282},size={37,19},proc=D2nd_showtable,title="table"	SetVariable setvar09,pos={18,198},size={103,18},proc=D2nd_paraChange,title="EDC(slice)"	SetVariable setvar09,limits={1,inf,1},value= D2nd_avgEDC	SetVariable setvar10,pos={130,197},size={103,18},proc=D2nd_paraChange,title="MDC(meV)"	SetVariable setvar10,limits={1,inf,1},value= D2nd_avgMDC	Button button12,pos={17,320},size={77,21},proc=D2nd_showdif2D,title="ShowD2nd"	SetVariable setvar11,pos={14,243},size={108,18},title="EDC(points)"	SetVariable setvar11,limits={1,inf,1},value= D2nd_EDCfitpoints	SetVariable setvar12,pos={128,243},size={106,18},title="MDC(Points)"	SetVariable setvar12,limits={1,inf,1},value= D2nd_MDCfitpointsEndMacroWindow AutoAnalize() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(599,316,829,558)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 4,74,203,74	SetDrawEnv linethick= 2	DrawLine 4,170,203,170	SetDrawEnv linethick= 2	DrawLine 4,219,203,219	SetVariable MInus1,pos={7,6},size={84,15},title="From No"	SetVariable MInus1,limits={0,inf,1},value= AnaFromAn	SetVariable Plus3,pos={91,6},size={58,15},title="to"	SetVariable Plus3,limits={0,inf,1},value= AnaToAn	Button button0,pos={149,3},size={28,20},proc=Auto_AllAn,title="All"	SetVariable MInus,pos={10,29},size={61,15},title="-P"	SetVariable MInus,limits={0,inf,1},value= AutoCentMinus	SetVariable Plus,pos={72,29},size={61,15},title="+P"	SetVariable Plus,limits={0,inf,1},value= AutoCentPlus	Button button4,pos={8,50},size={81,20},proc=Auto_GetPeakFunc,title="Get Peak"	Button button2,pos={101,49},size={23,20},proc=Auto_peakShow,title="S"	Button button5,pos={8,79},size={81,20},proc=Auto_LinearFitFunc,title="Linear fit"	Button button6,pos={7,101},size={81,20},proc=Auto_Subtract,title="Subtract"	Button button3,pos={101,100},size={64,20},proc=GetPlusfunc,title="PlusArea"	Button button7,pos={101,122},size={66,20},proc=GetPeakfunc,title="PeakArea"	Button button04,pos={102,144},size={91,20},proc=GetCoherentfunc,title="CoherentArea"	Button button8,pos={8,123},size={81,20},proc=Auto_Interpolate,title="Interpolate"	Button button9,pos={8,174},size={81,20},proc=Auto_MapInterp,title="Map Interp"	Button button1,pos={98,174},size={23,20},proc=Auto_MapInterpShow,title="S"	SetVariable setvar26,pos={7,197},size={137,15},title="New Map"	SetVariable setvar26,value= NewInterpMapName	Button button09,pos={151,194},size={52,20},proc=CreateInterpMap,title="Create"	CheckBox Sym,pos={101,80},size={53,14},proc=WithFlatCheckFunc,title="with flat"	CheckBox Sym,value= 1	Button button07,pos={7,145},size={87,20},proc=Auto_SubtByWave,title="Subt by wave"EndMacroFunction Auto_SubtByWave (ctrlName) : ButtonControl	String ctrlName	string wave1, wave2, wave1x, wave2x, ChosenY, ChosenX	variable scale	ChosenY="fit_ButtArea" // Prompt wave1,"original curve", popup  TraceNameList("",";",1)   Prompt ChosenY, "wave name for subt"  Prompt scale, "scale for subt wave"  DoPrompt "SubtByWave", scale,ChosenY  if (V_flag != 0) 	  return -1; // User cancelled.   endif   duplicate/o $ChosenY subtwave  subtwave*=scale  execute "subtbywave()"end	proc subtbywave() duplicate/o buttarea temp buttarea[] = temp[p] - subtwave(ButtAreaTemp[p])endFunction WithFlatCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar WithFlatCheck  WithFlatCheck=checkedEndFunction CreateInterpMap (ctrlName) : ButtonControl	String ctrlName	Svar NewInterpMapName	string YesNo,statement	dowindow InterpMap_panel	if (v_flag==1)	  statement = WinRecreation("InterpMap_panel",1)	else 	  abort "Make IntepMap first!!"	endif		if (stringmatch(NewInterpMapName,"")==1)	   abort "Input Map name first!!"	endif	if (exists(NewInterpMapName)==1) 	  Prompt YesNo, "Yes or No", popup, "Yes"+";No" 	  DoPrompt "There is this Map name. Do you want to replace?",  YesNo 	   if (stringmatch(YesNo,"No")==1) 	    abort      endif   if (V_Flag)   			return -1// User canceled    endif   	endif	duplicate/o InterpedMap $NewInterpMapName		display ; appendimage $NewInterpMapName	execute statementend			Function Auto_MapInterpShow (ctrlName) : ButtonControl	String ctrlName	dowindow/f InterpMap_panelend	Function Auto_MapInterp (ctrlName) : ButtonControl	String ctrlName	string waveAll, MapName="",printstr, statement	variable Itemtotal, i, Xinterp,Yinterp, resultName	variable XoffsetVal, XdeltaVal, YoffsetVal, YdeltaVal	Nvar MapInterpX, MapInterpY	waveAll = wavelist("*",";","win:")	Itemtotal = ItemsInList(waveAll, ";")	for (i=0 ; i<Itemtotal; i+=1)	  printstr = StringFromList(i,waveAll)	  if (WaveDims($printstr)==2)    	MapName += ";"+printstr    endif		endfor	Xinterp = MapInterpX	Yinterp = MapInterpY	if (stringmatch(MapName,"")==1)	  abort "No 2DImage in this panel!!"	endif	Prompt MapName,"Base Image: " popup MapName  Prompt Xinterp, "X interp: "  Prompt Yinterp, "Y interp: "  DoPrompt "Map Interpolate", MapName, Xinterp, Yinterp  if (V_flag != 0) 	  return -1; // User cancelled.   endif      MapInterpX = Xinterp	MapInterpY = Yinterp  ImageInterpolate /f={Xinterp,Yinterp} bilinear $MapName  XoffsetVal = DimOffset($MapName,0)  XdeltaVal = DimDelta($MapName,0)  YoffsetVal = DimOffset($MapName,1)  YdeltaVal = DimDelta($MapName,1)  SetScale/P x XoffsetVal,XdeltaVal/Xinterp,"",  M_InterpolatedImage  SetScale/P y YoffsetVal,YdeltaVal/Yinterp,"",  M_InterpolatedImage  duplicate/o  M_InterpolatedImage InterpedMap  statement = WinRecreation(winname(0,1),1)  dowindow/f InterpMap_panel  if (V_flag!=1)      display; appendimage InterpedMap      execute statement       dowindow/c InterpMap_panel  endif  end	Function Auto_Interpolate (ctrlName) : ButtonControl	String ctrlName	string wave1, wave1x, result, YesOrNo="even"	variable E_i, E_f, points	Nvar IntPoints	Svar IntName	if (stringmatch(csrwave(a),"")!=1)	  wave1 = csrwave(a)	endif	result = IntName	points = IntPoints	Prompt wave1,"Base wave: ", popup TraceNameList("",";",1)   Prompt points, "wave points num: "  Prompt result, "result name: "  DoPrompt "Simple Interpolate", wave1, points, result  if (V_flag != 0) 	  return -1; // User cancelled.   endif   if (exists(result)==1)     Prompt YesOrNo,"This wave exists. Do you replace?", popup "Yes"+";No"       DoPrompt "Confirmation", YesOrNo       if (V_flag != 0) 	       return -1; // User cancelled.        endif   endif  if (stringmatch(YesOrNo,"No")==1)   abort  else  	IntName = result  	IntPoints = points    	make/o/n=(points) $result  	duplicate/o $wave1 Int1y  	wave1x = XWaveName("",wave1)   	 if (stringmatch(wave1x,"")==1)  		duplicate/o $wave1 Int1x  		Int1x[] = 	 pnt2x($wave1,p)   	else    	duplicate/o $wave1x Int1x  	endif    Interpolate2/T=1/N=(points)/Y=$result Int1x, Int1y  	 print "Interp wave name: ", result   	duplicate/o $result InterpWave  	dowindow/f IntPanel  	if (V_flag==0)   		Display /W=(174,386,600,660) InterpWave   		dowindow/c IntPanel  		ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph zero=3			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0		endif  endifend	Function Auto_Subtract (ctrlName) : ButtonControl	String ctrlName	string wave1, wave2, wave1x, wave2x, ChosenY, ChosenX		if (stringmatch(csrwave(a),"")!=1)	  wave1 = getTraceName ("a")	endif	if (stringmatch(csrwave(b),"")!=1)	  wave2 = getTraceName ("a")	endif  Prompt wave1,"wave1 for (wave1 - wave2): ", popup  TraceNameList("",";",1)   Prompt wave2, "wave2 for (wave1 - wave2): ", popup TraceNameList("",";",1)   Prompt ChosenY, "Which structure do you use in wave1 - wave2: ", popup "wave1" + ";wave2"  DoPrompt "wave1 - wave2", wave1, wave2, ChosenY  if (V_flag != 0) 	  return -1; // User cancelled.   endif   duplicate/o  TraceNameToWaveRef("", wave1) Subt1y  duplicate/o  TraceNameToWaveRef("", wave2) Subt2y  wave1x = XWaveName("",wave1)  if (stringmatch(wave1x,"")==1)  	duplicate/o $wave1 Subt1x  	Subt1x[] = 	 pnt2x($wave1,p)   else    duplicate/o $wave1x Subt1x  endif    wave2x = XWaveName("",wave2)  if (stringmatch(wave2x,"")==1)  	duplicate/o $wave2 Subt2x    Subt2x[] = 	 pnt2x($wave2,p)   else    duplicate/o $wave2x Subt2x  endif  if (stringmatch(ChosenY,"wave1")==1)     duplicate/o Subt1y YsubtWave     duplicate/o Subt1x XsubtWave     YsubtWave[] = Subt1y[p] - interp(Subt1x[p], Subt2x, Subt2y)  elseif (stringmatch(ChosenY,"wave2")==1)     duplicate/o Subt2y YsubtWave     duplicate/o Subt2x XsubtWave     YsubtWave[] = interp(Subt2x[p], Subt1x, Subt1y) - Subt2y[p]  endif  killwaves Subt1y, Subt2y, Subt1x, Subt2x// edit Subt1y, Subt2y, Subt1x, Subt2x  dowindow/f SubtPanel  if (V_flag==0)   Display /W=(174,386,600,660) YsubtWave vs XsubtWave   dowindow/c SubtPanel  ModifyGraph mode=4	ModifyGraph marker=19	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0  endifend	FUnction Tracelist (text)String textstring partstrvariable flag = 0string waveAll, printstrvariable Itemtotal, i	waveAll =TraceNameList("",";",1)	Itemtotal = ItemsInList(waveAll, ";")	for (i=0 ; i<Itemtotal; i+=1)   	partstr = StringFromList(i, waveAll)   	flag=stringmatch(partstr,text)   	if (flag==1)   	 break   	endif	endfor	return flagendFunction Auto_LinearFitFunc (ctrlName) : ButtonControl	String ctrlName	variable E_low, E_high, start_x, end_x, waveLengY, waveLengX, Minleng	Nvar Auto_Ei, Auto_Ef, WithFlatCheck	wave W_coef	string Xaxis, Yaxis	start_x=Auto_Ei; end_x=Auto_Ef	Prompt start_x,"first x"  Prompt end_x, "last x"  DoPrompt "Linear Fit Setting", start_x, end_x  if (V_flag != 0) 	  return -1; // User cancelled.   endif   Auto_Ei=start_x ; Auto_Ef=end_x  Xaxis = getAxisinfo_X ("a") ; Yaxis = getAxisinfo_Y ("a") CurveFit/q line  $csrwave(a)[pcsr(A),pcsr(B)] /X=$CsrXWave(a)///D  make/o/n=200 LinearWave SetScale/I x start_x,end_x,"", LinearWave LinearWave = poly(W_coef,x) if (WithFlatCheck==1) 		execute "LinearWave(hcsr(b),inf)=poly(W_coef,hcsr(b))" endif if (Tracelist ("LinearWave") ==0)    // appendtograph LinearWave    AppendToGraph/L=$Yaxis/B=$Xaxis LinearWave    ModifyGraph rgb(LinearWave)=(0,0,65535) endifend	Function/s getAxisinfo_X (csrName)	string csrName	string Traceinfostr, Csrinfostr, TraceName	string Xaxis	Csrinfostr=CsrInfo($csrName,"") 	TraceName=StringByKey("TNAME", Csrinfostr)	Traceinfostr=TraceInfo("", TraceName	, 0)		Xaxis= StringByKey("XAXIS", Traceinfostr)	return (Xaxis)endFunction/s getAxisinfo_Y (csrName)	string csrName	string Traceinfostr, Csrinfostr, TraceName	string Yaxis	Csrinfostr=CsrInfo($csrName,"")	TraceName=StringByKey("TNAME", Csrinfostr)	Traceinfostr=TraceInfo("", TraceName	, 0)	Yaxis= StringByKey("YAXIS", Traceinfostr)		return (Yaxis)	endFunction/s getTraceName (csrName)	string csrName	string Traceinfostr, Csrinfostr, TraceName	string Xaxis	Csrinfostr=CsrInfo($csrName,"") 	TraceName=StringByKey("TNAME", Csrinfostr)	return (TraceName)end Function Auto_AllAn (ctrlName) : ButtonControl	String ctrlName	string wavestrY	variable i, check	Nvar  AnaFromAn, AnaToAn, Scope_range	AnaFromAn = 0	AnaToAn = Scope_range-1end	Function Auto_peakShow (ctrlName) : ButtonControl	String ctrlName	wave ScopePeak, ScopePeakNo	dowindow/f AutoPeakTable	if (V_flag!=1)	  edit ScopePeak, ScopePeakNo	  dowindow/c AutoPeakTable	endif	dowindow/f AutoPeakGraph  if (V_flag!=1)	  display ScopePeak vs ScopePeakNo	  dowindow/c AutoPeakGraph  	  ModifyGraph mode=4		ModifyGraph marker=19		ModifyGraph tick=2		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=16		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625		Label left "Peak"		Label bottom "No"	endif end	Function Auto_GetPeakFunc (ctrlName) : ButtonControl	String ctrlName	string wavestrX, wavestrY	variable i, center, check, windex	Nvar  AutoCentPlus, AutoCentMinus, AnaFromAn, AnaToAn, scope_offs, scope_range	wave ScopePeak, ScopePeakNo , w_coef, coeff		dowindow/f Graph_Scope	if (v_flag!=1)	abort "Show Graph_Scope"	endif	 make/o/n=(scope_range) ScopePeak, ScopePeakNo	 make/o/n=200 $"fit_temp"	 make/o/n=5 coeff		dowindow/f Graph_Scope		appendtograph $"fit_temp"		ModifyGraph rgb($"fit_temp")=(1,4,52428)   	ScopePeak[]=nan		ScopePeakNo[]=nan	     check = 0   	variable /g v_fitoptions=4	for (i=AnaFromAn ; i<=AnaToAn ; i+=1)		wavestrY = "Scope" + num2istr(i)		wavestrX = "scopeX"		duplicate/o $wavestrY temp		duplicate/o $wavestrX temp1		if (numpnts(temp)!=0)			ModifyGraph lsize($"fit_temp")=2			ModifyGraph offset($"fit_temp")={0,scope_offs*i}			if (check == 0)    		  		CurveFit/q lor  temp[pcsr(A),pcsr(B)] /X=temp1 /D		  		coeff[0] = W_coef[0]		  		coeff[1] = 0		  		coeff[2] = W_coef[1]		  		coeff[3] = W_coef[2]		  		coeff[4] = W_coef[3]		  		FuncFit/q  peakfunc coeff temp[pcsr(A),pcsr(B)] /X=temp1 /D		  		center = coeff[3]		  		check = 1			else	   		   FindLevel/Q temp1, center 	   		   center = V_LevelX	   	     FuncFit/q  peakfunc coeff temp[center-AutoCentMinus,center+AutoCentPlus] /X=temp1 /D	   		   center = coeff[3]	 	   		   wavestats/q $"fit_temp"  	   		   coeff[3] = V_maxloc 			endif	        ScopePeakNo[i]=i			ScopePeak[i]=(coeff[3])		else			ScopePeak[i]=nan		 	ScopePeakNo[i]=nan		endif   endfor    v_fitoptions=0    	removefromgraph $"fit_temp"    	dowindow/f ScopePeakTable   if (V_flag==0)       edit ScopePeakNo, ScopePeak        dowindow/c ScopePeakTable   endif    	dowindow/f ScopePeakGraph   if (V_flag==0)       display ScopePeak vs ScopePeakNo       dowindow/c ScopePeakGraph       	ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(bottom)=-0.25			Label left "Peak"			Label bottom "No"   endif   end		function getKval(hv, wk, aa)	variable hv	variable wk	variable aa	variable PiAngle	variable h_bar=1.0545*10^-34, m=9.11*10^-31, eV=1.6*10^-19	variable Ek=hv-wk	variable momentum=(2*m*Ek*eV)^0.5/(pi/(aa*10^-10))/h_bar	return momentumend	Function EvsKzProc (ctrlName) : ButtonControl  String ctrlName  Nvar a_ang, c_ang, hvi, hvf, V_0   variable KcZero, KcPi, KcsqrtPi, Kc2Pi, Kc2sqrtPi  variable aa, cc, aa_ang, cc_ang, VV_0  variable h_bar=1.0545*10^-34, m=9.11*10^-31, eV=1.6*10^-19, WW=4.5  variable start_E,end_E,angle,kcAtZero,kcAtPi,kcAtsqrtPi,kcAt2Pi,start_Ek,waveNum,Windex,deltaE=0.5  variable AngAtPi, AngAtsqrt2Pi,AngAt2sqrt2Pi, AngAt2Pi   start_E = hvi ; end_E = hvf   aa_ang = a_ang ; cc_ang = c_ang   VV_0 = V_0   Prompt start_E,"Ei"  Prompt end_E, "Ef"  Prompt deltaE, "delta E"  Prompt aa_ang, "a lattice constant (ang)"  Prompt cc_ang, "c lattice constant (ang)"  Prompt VV_0, "Inner potential"  DoPrompt "E vs Kz", start_E, end_E, deltaE, aa_ang, cc_ang, VV_0  // VV_0 = EE_0 + WW   if (V_flag != 0) 	 return -1; // User cancelled.   endif   hvi=start_E ; hvf=end_E  a_ang=aa_ang  ; c_ang=cc_ang  V_0=VV_0  aa = aa_ang*10^-10  cc = cc_ang*10^-10  waveNum=round((end_E-start_E)/deltaE)+1  make/o/N=(waveNum) Energy_eV, Piangle_deg, kz_AtZero_pi, kz_AtPi_pi, kz_AtSqrtPi_pi, kz_At2Pi_pi, kz_At2SqrtPi_pido start_Ek=start_E-WW AngAtPi=asin(h_bar*(pi/(aa))/(2*m*start_Ek*eV)^0.5) AngAtsqrt2Pi=asin(h_bar*(sqrt(2)*pi/(aa))/(2*m*start_Ek*eV)^0.5) AngAt2Pi=asin(h_bar*(2*pi/(aa))/(2*m*start_Ek*eV)^0.5) AngAt2sqrt2Pi=asin(h_bar*(2*sqrt(2)*pi/(aa))/(2*m*start_Ek*eV)^0.5)  KcZero=(1/h_bar)*(2*m*((start_Ek)*eV*cos(0)^2+(VV_0)*eV))^0.5 KcPi=(1/h_bar)*(2*m*((start_Ek)*eV*cos(AngAtPi)^2+(VV_0)*eV))^0.5 KcsqrtPi=(1/h_bar)*(2*m*((start_Ek)*eV*cos(AngAtsqrt2Pi)^2+(VV_0)*eV))^0.5 Kc2Pi=(1/h_bar)*(2*m*((start_Ek)*eV*cos(AngAt2Pi)^2+(VV_0)*eV))^0.5 Kc2sqrtPi=(1/h_bar)*(2*m*((start_Ek)*eV*cos(AngAt2sqrt2Pi)^2+(VV_0)*eV))^0.5  Energy_eV [Windex]=start_E Piangle_deg[Windex]=AngAtPi*180/pi kz_AtZero_pi[Windex]=KcZero/(pi/cc) kz_AtPi_pi[Windex]=KcPi/(pi/cc) kz_AtSqrtPi_pi[Windex]=KcsqrtPi/(pi/cc) kz_At2Pi_pi[Windex]=Kc2Pi/(pi/cc) kz_At2SqrtPi_pi[Windex]=Kc2sqrtPi/(pi/cc) Windex+=1 start_E+=deltaEwhile (start_E<=end_E)dowindow/f EvsKzif (V_flag!=1) edit Energy_eV, Piangle_deg, kz_AtZero_pi, kz_AtPi_pi, kz_AtSqrtPi_pi, kz_At2Pi_pi, kz_At2SqrtPi_pi dowindow/c EvsKzendifprint "a_lattice:",aa_ang, "c_lattice:",cc_ang, "Inner_potential:",VV_0End Function GetCoherentfunc (ctrlName) : ButtonControl	String ctrlName	string nameX, nameY	variable a,b,x1,y1,x2,y2, AreaLine, AreaCoherent, AreaSpectrum   nameY = csrwave(a)	nameX = csrXwave(a)	duplicate/o $nameY temp,temp1	duplicate/o $nameX temp2	x1=hcsr(a)	x2=hcsr(b)	y1=vcsr(a)	y2=vcsr(b)	a = (y2-y1)/(x2-x1)	b = y1-a*x1  temp[]=a*temp2[p]+b // line from A to B  AreaLine = area(temp,pcsr(a),pcsr(b))  AreaSpectrum = area(temp1,pcsr(a),pcsr(b))  AreaCoherent = AreaSpectrum - AreaLine	print nameY , AreaCoherentEndFunction GetPeakfunc (ctrlName) : ButtonControl	String ctrlName	string name	variable i, Valmin	name = csrwave(a)	duplicate/o $name temp, temp1	Valmin = min(temp1[pcsr(a)],temp1[pcsr(b)])	temp1-=Valmin   for (i=0 ; i<numpnts(temp1) ; i+=1)	  if (temp1[i]<0)	    temp[i]=0	   else 	    temp[i]=temp1[i]	   endif	endfor	print name , area(temp,pcsr(a),pcsr(b))EndFunction GetPlusfunc (ctrlName) : ButtonControl	String ctrlName	string name	variable i 	name = csrwave(a)	duplicate/o $name temp, temp1	for (i=0 ; i<numpnts(temp) ; i+=1)	 //  if (temp1[i]>0)	  if (temp1[i]<0)	    temp[i]=0	   else 	    temp[i]=temp1[i]	   endif	endfor	print name , area(temp,pcsr(a),pcsr(b))EndProc ALSProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f ALS	if (V_flag!=1)  ALS()	endifEndProc ScientaProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f ARPEScorrection	if (V_flag!=1)	ARPEScorrection()	endifEndProc Get_Cut (ctrlName) : ButtonControl	String ctrlName	dowindow/f ARPEScorrection//	nvar Scientahv, Scientawk, Scientaaa//	nvar PhotoEnergy, WorkFunction, LatticeConstant	Scientahv=PhotoEnergy	Scientawk=WorkFunction	Scientaaa=LatticeConstant	if (V_flag!=1)		ARPEScorrection()	endifEndProc FSProc (ctrlName) : ButtonControl	String ctrlName//	svar UseparaFSMapstr//	nvar readTheta//	svar bzname	dowindow/f FS_rotation	if (V_flag!=1)	variable/g FSsection, FSSymMode	make/n=2/o FSsecLine1x, FSsecLine1y, FSsecLine2x, FSsecLine2y	FS_rotation()	endifEndProc TBProc (ctrlName) : ButtonControl	String ctrlName	dowindow/f Tight_Binding	if (V_flag!=1)	Tight_Binding()	endifEndFUnction Tracelistfunc (ctrlName) : ButtonControlString ctrlNamestring waveAll, printstrvariable Itemtotal, i	waveAll =TraceNameList("",";",1)	Itemtotal = ItemsInList(waveAll, ";")	for (i=0 ; i<Itemtotal; i+=1)   	printstr = StringFromList(i, waveAll)+"\r"	  print printstr	endforendProc DrawProc(ctrlName) : ButtonControl	String ctrlName	dowindow/f DrawPanel	if (V_flag!=1)	 DrawPanel()	endifend			Window DrawPanel() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(1097,345,1286,649)	ModifyPanel cbRGB=(57346,65535,49151)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 7,81,180,81	DrawLine 7,169,180,169	DrawLine 7,228,180,228	DrawLine 7,124,180,124	Button button17,pos={12,85},size={54,20},proc=DrawlineFunc,title="Draw"	SetVariable InterpX,pos={16,21},size={80,15},title="Interp: X"	SetVariable InterpX,limits={1,50,1},value= interpX_Draw	SetVariable InterpY,pos={102,22},size={49,15},title="Y"	SetVariable InterpY,limits={1,20,1},value= interpY_Draw	Button button18,pos={12,128},size={77,20},proc=ShowMap,title="Show Map"	Button Check2div,pos={13,233},size={72,20},proc=Draw_check2divFunc,title="Check2dif"	Button Go2div,pos={91,233},size={53,20},proc=Draw_Div2dFunc,title="Go2dif"	Button button19,pos={11,173},size={77,20},proc=ShowEDC,title="Show EDCs"	Button button20,pos={73,85},size={54,20},proc=EraselineFunc,title="Erase"	Button button21,pos={124,128},size={54,20},proc=Draw_MapGraph,title="Graph"	Button button22,pos={124,173},size={47,20},proc=Draw_EDCGraph,title="Graph"	SetVariable copyGoffset,pos={13,196},size={86,15},proc=DrawOffset,title="Offset"	SetVariable copyGoffset,limits={-inf,inf,0.1},value= Draw_offs	CheckBox Sym,pos={105,195},size={37,14},proc=Draw_sym_check,title="Sym",value= 0	SetVariable setvar9,pos={102,4},size={48,15},title="Y"	SetVariable setvar9,limits={1,10,2},value= Draw_meanY	SetVariable setvar0,pos={22,4},size={72,15},title="Mean X"	SetVariable setvar0,limits={1,10,2},value= Draw_meanX	Button button23,pos={44,256},size={54,20},proc=Draw_2DivMapGraph,title="Graph"	Button button2,pos={95,128},size={23,20},proc=Draw_cutmapShow,title="S"	Button button3,pos={95,173},size={23,20},proc=Draw_scopeShow,title="S"	Button button4,pos={13,256},size={23,20},proc=Draw_SecondDerivativeShow,title="S"	Button button24,pos={25,39},size={132,20},proc=DrawMakeBz,title="Make 3D matrix"	SetVariable setvar5,pos={26,212},size={73,15},proc=Draw_smoothproc,title="Smooth"	SetVariable setvar5,limits={0,100,1},value= Draw_smooth	CheckBox Sym2,pos={134,88},size={42,14},proc=Draw_Fermi_check,title="Fermi"	CheckBox Sym2,value= 0	CheckBox Sym3,pos={13,152},size={71,14},proc=Draw_Euler_check,title="Euler param."	CheckBox Sym3,value= 0	SetVariable copyGoffset1,pos={92,151},size={86,15},proc=Draw_KOffset,title="k offset"	SetVariable copyGoffset1,limits={-inf,inf,0.01},value= Draw_koffs	SetVariable Filename,pos={7,61},size={173,15},disable=2,title="BZ name"	SetVariable Filename,value= DrawBZname	SetVariable Filename1,pos={7,105},size={173,15},disable=2,title="Draw panel"	SetVariable Filename1,value= DrawPanelname	Button button25,pos={105,256},size={70,20},proc=Draw_save2gr,title="save2gr"	Button button26,pos={13,279},size={70,20},proc=CombFS,title="CombFS"	Button button27,pos={88,279},size={55,20},proc=DrawCombFS,title="Draw"	EndMacroFunction Draw_KOffset (ctrlName,varNum,varStr,varName) : SetVariableControl		String ctrlName	Variable varNum	String varStr 	String varName	Nvar Draw_koffs, kdistance, Draw_Euler_checked	wave DrawImage	Svar DrawWinName	dowindow Cutmap	if (v_flag==1)   	if (stringmatch(DrawWinName,"RotatedMapping") || Draw_Euler_checked==1)	     SetScale/I y 0-Draw_koffs,kdistance-Draw_koffs,"", DrawImage     endif   endifEndFunction Draw_Fermi_check (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	variable i   string waveAll, source	Nvar Draw_Fermi_checked, Draw_sym_checked	Svar DrawWinName	Draw_Fermi_checked = checked  if (Draw_sym_checked==1)  abort "Take off sym check!!"  endif		Dowindow/f CutMap	if (V_flag==1 && Draw_Fermi_checked==1)            Fermi2DFunc ()	elseif (V_flag==1 && Draw_Fermi_checked==0)	   if (stringmatch(DrawWinName,"mapping"))	 	 	DrawGetFunc ()		elseif (stringmatch(DrawWinName,"RotatedMapping"))	 		 DrawGetFunc_BZ ()		endif      DrawImageXaxis ()	endif		Dowindow/f Draw_scope	if (V_flag==1 && Draw_Fermi_checked==1)      FermiScopeFunc ()	elseif (V_flag==1 && Draw_Fermi_checked==0)	   DrawInputFunc () 	   DrawOffsetfunc () 	endifendfunction  ShowEDC (ctrlname) : ButtonControl	string	ctrlname	Nvar Draw_sym_checked, Draw_Fermi_checked	dowindow cutmap	if (v_flag!=1)	  abort "Show Map furst!!"   endif	ShowEDCfunc ()  	 if (Draw_sym_checked==1)      Showsymfunc ()    elseif (Draw_Fermi_checked==1)      FermiScopeFunc ()    endifendFunction  ShowEDCfunc ()  	string nameX, nameY	variable Epoints, kpoints, i	wave DrawImage	 Epoints = dimsize(DrawImage,0)   kpoints = dimsize(DrawImage,1)    make/o/n=(Epoints) temp1, temp2    temp1[] = DimOffset(DrawImage, 0) + p*DimDelta(DrawImage, 0)    nameX = "DscopeX"   duplicate /o temp1 $nameX	Dowindow/f Draw_scope if (V_flag!=1)  Display /W=(277,49,645,781)  Dowindow/c Draw_scope  for (i=0 ; i<kpoints ; i+=1)     nameY = "Dscope"+num2str(i)     temp2[] = DrawImage[p][i]    	duplicate /o temp2 $nameY     appendtograph $nameY vs $nameX     endfor    DrawOffsetfunc ()    ModiGraphfunc ()     endif	endfunction  ShowSymfunc ()    string waveAll, nameX, nameY    variable i    waveAll = TraceNameList("",";",1)    for (i=0 ;  i < ItemsInList(waveAll); i+=1)      nameX = "DscopeX"       duplicate/o $nameX temp1       nameY = "Dscope"+num2str(i)       duplicate/o $nameY temp2		  Symmetrization_button(temp1, temp2, "tempscopeX", "tempscopeY")	    duplicate /o tempscopeX $nameX	     duplicate /o tempscopeY $nameY	  endforendFunction DrawlineFunc (ctrlName) : ButtonControl	String ctrlName	SVAR  DrawWinName, DrawPanelname	DrawWinName=WinName(0,1)	if (stringmatch(DrawWinName,"Mapping")!=1 && stringmatch(DrawWinName,"RotatedMapping")!=1)		 abort "Show Mapping or RotatedMapping !!"	endif//	EraselineFunc ("")	dowindow/f $DrawWinName	GraphWaveDraw/o DrawY,DrawX	DrawPanelname = DrawWinNameendFunction  EraselineFunc (ctrlName) : ButtonControl	String ctrlName	string waveAll, Item	variable Itemtotal,i 	dowindow mapping	if (V_flag==1)	    waveAll = TraceNameList("mapping",";",1)      Itemtotal = ItemsInList(waveAll, ";")      for (i=0 ; i<Itemtotal; i+=1)         Item = StringFromList(i, waveAll)         if (stringmatch(Item,"DrawY"))          removefromgraph/w=mapping DrawY         endif      endfor	endif			dowindow RotatedMapping	if (V_flag==1)	    waveAll = TraceNameList("RotatedMapping",";",1)      Itemtotal = ItemsInList(waveAll, ";")      for (i=0 ; i<Itemtotal; i+=1)         Item = StringFromList(i, waveAll)         if (stringmatch(Item,"DrawY"))          removefromgraph/w=RotatedMapping DrawY         endif      endfor	endifendFunction ShowMap (ctrlName): ButtonControlString ctrlNamestring resultImage="DrawImage" , waveAllvariable i, checkNvar Draw_sym_checked, draw_meanX, draw_meanY, interpX_Draw, interpY_Draw, Draw_Fermi_checkedNvar Draw_smooth, Draw_Euler_checkedSvar DrawWinName	    waveAll = TraceNameList(DrawWinName,";",1)   if (stringmatch(waveAll,"*DrawY*")!=1)          abort "Drqw line first!!"   endif 	if (interpX_Draw==1 && interpX_Draw==1)	  duplicate/o bz_mean bz_MeanInterp	endif	if (stringmatch(DrawWinName,"mapping"))	  DrawGetFunc ()	elseif (stringmatch(DrawWinName,"RotatedMapping"))	   GetXYpoint ()		   DrawGetFunc_BZ ()	endif	   dowindow/f CutMap   if (v_flag!=1)   display/w=(50,50,400,400) ; appendimage $resultImage   dowindow/c CutMap   ModifyImage DrawImage ctab= {*,*,Rainbow,1}   ModifyGraph swapXY=1   ModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdate   endif   if (stringmatch(DrawWinName,"mapping") && Draw_Euler_checked!=1)   Label bottom "Slice";DelayUpdate   Label left "Energy (eV)"   elseif (stringmatch(DrawWinName,"RotatedMapping") || Draw_Euler_checked==1)   Label bottom "\f02k\B\M\f00 / \F'Symbol'p";DelayUpdate   Label left "Energy (eV)"   endif      DrawImageXaxis ()   Dowindow/f Draw_scope if (V_flag==1)    DrawInputFunc ()     DrawOffsetfunc ()   	 if (Draw_sym_checked==1)      Showsymfunc ()    elseif (Draw_Fermi_checked==1)     FermiScopeFunc ()    endif endif   if (Draw_Fermi_checked==1)   Fermi2DFunc ()  endifEndFunction Draw_Euler_check (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	variable i   string waveAll, source	Nvar Draw_Euler_checked	Draw_Euler_checked = checkedendFunction DrawImageXaxis ()   wave temp   Svar bzname   string Xwave   wave map   variable Est, dE, refeGraphNo   svar dispwave   Nvar Draw_Estep, Draw_Euler_checked	duplicate/o $bzname temp1	refeGraphNo=temp1[0][0][0]	if (stringmatch(dispwave ,"gr") || stringmatch(dispwave ,"nr"))	Xwave="gx"+num2istr(refeGraphNo)	   duplicate/o $Xwave temp1	Est = temp1[0]-map[refeGraphNo][7]	dE = temp1[1]- temp1[0]	Draw_Estep = dE	 SetScale/P x est,de,"", DrawImage  elseif (stringmatch(dispwave ,"cr"))  Xwave="cx"+num2istr(refeGraphNo)   duplicate/o $Xwave temp1	Est = temp1[0]	dE = temp1[1]- temp1[0]	 SetScale/P x est,de,"", DrawImage	 endifendFunction GetXYpoint () wave DrawX, DrawY variable kpoints, epoints,dx, dy, slopeY, slopeX, kdistance, i, ratio variable  Kx1_interp, Kx0_interp, Ky1_interp, Ky0_interp, midY variable sizeX, sizeY, firstY, Psi, Phi, Theta, ANG, points=200 Nvar RotaXspacing, SliceAngle, readRota, offRota, readTheta, offTheta, readPhi, offPhi, LatticeConstant, Workfunction, PhotoEnergy// Nvar offpsi, offphi, offtheta, RotaXspacing, SliceAngle, MapRotaPiangle, RotaAngle Svar UseparaFSMapstr  sizeY=dimsize($UseparaFSMapstr,1) midY= DimOffset($UseparaFSMapstr,1) + SliceAngle*DimDelta($UseparaFSMapstr,1) *(sizeY-1)/2   /// Come back to RotaAngle=0  kx0_interp = DrawX[0]  kx1_interp = DrawX[1]  ky0_interp = DrawY[0]  ky1_interp = DrawY[1]  make/o/n=(points) DrawWave_kx, DrawWave_kY, DrawWave_kZ2, distanceK  slopeY = (Ky1_interp-Ky0_interp)/(points-1)  slopeX = (Kx1_interp-Kx0_interp)/(points-1)  DrawWave_kx[]=slopeX*p+kx0_interp  DrawWave_ky[]=slopeY*p+ky0_interp  make/o/n=(points) temp1, temp2  ANG=-(readRota-offRota)*pi/180  temp1[] = DrawWave_Kx[p]*cos(ANG)-DrawWave_Ky[p]*sin(ANG)  temp2[] = DrawWave_Kx[p]*sin(ANG)+DrawWave_Ky[p]*cos(ANG)  duplicate/o temp1 DrawWave_Kx2  duplicate/o temp2 DrawWave_Ky2   distanceK[] = sqrt(DrawWave_Kx2[p]^2+DrawWave_Ky2[p]^2) // DrawWave_kz2[] = sqrt(1-( distanceK[p]*sin(MapRotaPiangle*pi/180) )^2) /sin(MapRotaPiangle*pi/180)  DrawWave_kz2[] = sqrt(getKval(PhotoEnergy, Workfunction, LatticeConstant)*getKval(PhotoEnergy, Workfunction, LatticeConstant)-distanceK[p]*distanceK[p])  // change (kx,ky) to (x,y) 	make/o/n=(points) DrawWaveX, DrawWaveY	make/o/n=(points) Scienta_Kx, Scienta_Ky, ThetaWave, PhiWave	make/o/n=(points) termX1, termX2 ,termX3, termY1, termY2 ,termY3, termZ1, termZ2, termZ3, Ywave, Zwave	Psi = 0	Phi = (readPhi-offphi)*(pi/180)    	Theta = 0 	//Theta =offtheta *(pi/180) 		termx1[]=cos(Psi)*cos(Theta)-cos(Phi)*sin(theta)*sin(Psi)	termx2[]=-sin(Psi)*cos(theta)-cos(Phi)*sin(theta)*cos(Psi)	termx3[]=sin(phi)*sin(theta)		termz1[]=sin(psi)*sin(phi) 	termz2[]=cos(Phi)*sin(phi)	termz3[]=cos(Phi)		Scienta_Kx[] = ( termx1[p]*DrawWave_Kx2[p]+termx2[p]*DrawWave_Kz2[p]+termx3[p]*DrawWave_Ky2[p] )	Scienta_Ky[] = ( termz1[p]*DrawWave_Kx2[p]+termz2[p]*DrawWave_Kz2[p]+termz3[p]*DrawWave_Ky2[p] ) 		kdistance =getKval(PhotoEnergy, Workfunction, LatticeConstant)	PhiWave[]=asin(Scienta_Ky[p]/kdistance )	ThetaWave[]=asin(Scienta_Kx[p]/( kdistance*cos(PhiWave[p]) ))	PhiWave*=(180/pi)	ThetaWave*=-(180/pi)	DrawWaveY[]=(PhiWave[p]+midY)/SliceAngle	DrawWaveX[]=(ThetaWave[p]+offtheta)/RotaXspacing endFunction DrawGetFunc_BZ ()string Xwave, checkstring	variable Linelength, sizeZ, ix, iy, i=0, dx, dy, x1_interp, x0_interp, y1_interp, y0_interp	variable epoints	Nvar interpX_Draw, interpY_Draw, Draw_Euler_checked, kdistance	svar bzname	wave bz_MeanInterp, DrawX, DrawY, temp, temp1,temp2, map, ne2d	wave DrawWaveX, DrawWaveY, DrawWaveX_L, DrawWaveY_L	kdistance = sqrt( (DrawX[1]-DrawX[0])^2+(DrawY[1]-DrawY[0])^2 )	//GetXYpoint ()	   duplicate/o bz_MeanInterp, temp2   duplicate/o $bzname temp1  epoints=dimsize(bz_MeanInterp,2)  wavestats/q DrawWaveX	dx= abs(V_min-V_max)*interpX_Draw/abs(temp1[1][1]-temp1[0][1])	wavestats/q DrawWaveY	dy= abs(V_min-V_max)*interpY_Draw   if (dx>=dy)     Interpolate2/T=1/N=(dx)/Y=DrawWaveX_L DrawWaveX	   Interpolate2/T=1/N=(dx)/Y=DrawWaveY_L DrawWaveY	   //	   DrawWaveX_L=(DrawWaveX_L-temp1[0][1])*interpX_Draw//	   DrawWaveY_L*=interpY_Draw     		make/o/n=(epoints,dx) ne2d//   	ne2d[][]=temp2[DrawWaveX_L[q]][DrawWaveY_L[q]][epoints-p]   else           Interpolate2/T=1/N=(dy)/Y=DrawWaveX_L DrawWaveX	  Interpolate2/T=1/N=(dy)/Y=DrawWaveY_L DrawWaveY     		make/o/n=(epoints,dy) ne2d//     ne2d[][]=temp2[DrawWaveX_L[q]*interpX_Draw][DrawWaveY_L[q]*interpY_Draw][epoints-p]    endif   DrawWaveX_L=(DrawWaveX_L-temp1[0][1])*interpX_Draw/abs(temp1[1][1]-temp1[0][1])   DrawWaveY_L*=interpY_Draw   ne2d[][]=temp2[DrawWaveX_L[q]][DrawWaveY_L[q]][epoints-p]  SetScale/I y 0,kdistance,"", ne2d   duplicate/o ne2d, DrawImageEndFunction DrawGetFunc ()string Xwave, checkstring	variable Linelength, sizeZ, ix, iy, i=0, dx, dy, x1_interp, x0_interp, y1_interp, y0_interp	variable epoints	Nvar interpX_Draw, interpY_Draw, Draw_Euler_checked	svar bzname	wave bz_MeanInterp, DrawX, DrawY, temp, temp1,temp2, map, ne2d   duplicate/o bz_MeanInterp, temp2  epoints=dimsize(bz_MeanInterp,2)  svar bzname  duplicate/o $bzname temp1  x0_interp = (DrawX[0]-temp1[0][1])/(abs(temp1[1][1]-temp1[0][1]))*interpX_Draw  x1_interp = (DrawX[1]-temp1[0][1])/(abs(temp1[1][1]-temp1[0][1]))*interpX_Draw  y0_interp = DrawY[0]*interpY_Draw  y1_interp = DrawY[1]*interpY_Draw	dx=abs(x1_interp-x0_interp)	dy=abs(y1_interp-y0_interp)   if (dx>=dy)   Linelength=dx   make/o/n=(epoints,Linelength) ne2d    if (DrawX[0]<=DrawX[1])    	ne2d[][]=temp2[q+x0_interp][(y1_interp-y0_interp)/(x1_interp-x0_interp)*q+y0_interp][epoints-p]     else     ne2d[][]=temp2[(-q)+x0_interp][(y1_interp-y0_interp)/(x1_interp-x0_interp)*(-q)+y0_interp][epoints-p]     endif    else      Linelength=dy   make/o/n=(epoints,Linelength) ne2d    if (DrawY[0]<=DrawY[1])      ne2d[][]=temp2[(x1_interp-x0_interp)/(y1_interp-y0_interp)*q+x0_interp][q+y0_interp][epoints-p]     else     ne2d[][]=temp2[(x1_interp-x0_interp)/(y1_interp-y0_interp)*(-q)+x0_interp][(-q)+y0_interp][epoints-p]    endif   endif   duplicate/o ne2d, DrawImage    if (Draw_Euler_checked==1)      UseEulerAngle ()    endifEndFunction UseEulerAngle () wave DrawImage, DrawX, DrawY variable kpoints, epoints,dx, dy, slopeY, slopeX, i, ratio variable  x1_interp, x0_interp, y1_interp, y0_interp variable sizeX, sizeY, firstY, midY, Psi, Phi, ANG Nvar offpsi, offphi, offtheta, RotaXspacing, SliceAngle, MapRotaPiangle, RotaAngle, kdistance Svar UseparaFSMapstr string baseMat   /// get codinates of x and y point.  x0_interp = DrawX[0]  x1_interp = DrawX[1]  y0_interp = DrawY[0]  y1_interp = DrawY[1]  kpoints = dimsize(DrawImage,1)  epoints = dimsize(DrawImage,0)  slopeY = (y1_interp-y0_interp)/(kpoints-1)  slopeX = (x1_interp-x0_interp)/(kpoints-1)  make/o/n=(kpoints) DrawWaveX, DrawWaveY  DrawWaveX[]=slopeX*p+x0_interp  DrawWaveY[]=slopeY*p+y0_interp    // change (x,y) to (kx,ky)  make/o/n=(kpoints) DrawWave_Kx, DrawWave_Ky  	make/o/n=(kpoints) Ywave,Zwave,DrawWave_Kx, DrawWave_Ky, ThetaWave	make/o/n=(kpoints) termX2 ,termX3, termY2, termY3	baseMat=UseparaFSMapstr	sizeY=Dimsize($baseMat,1)  firstY = DimOffset($baseMat,1)	midY= DimOffset($baseMat,1) + SliceAngle*DimDelta($baseMat,1) *(sizeY-1)/2	dX = RotaXspacing	dY = SliceAngle		Ywave[] = sin( (DrawWaveY[p]*dY-midY)*pi/180 ) / sin(MapRotaPiangle*pi/180)	Zwave[] = cos( (DrawWaveY[p]*dY-midY)*pi/180 ) / sin(MapRotaPiangle*pi/180) 	Psi = offpsi*(pi/180)	Phi =- offphi*(pi/180) 	ThetaWave[] = ( DrawWaveX[p]*dx+offtheta ) *(pi/180)	termX2[]=cos(Psi)*sin(ThetaWave[p])+cos(Phi)*cos(ThetaWave[p])*sin(Psi)	termX3[]=sin(Psi)*sin(Phi)	termY2[]=-sin(Phi)*cos(ThetaWave[p])	termY3[]=cos(Phi)	DrawWave_Kx[] = termX2[p]*Zwave[p]+termX3[p]*Ywave[p]	DrawWave_Ky[] = termY2[p]*Zwave[p]+termY3[p]*Ywave[p]	   // rotation of (kx,ky)  make/o/n=(kpoints) temp1, temp2	ANG=RotaAngle*pi/180	 temp1[] = DrawWave_Kx[p]*cos(ANG)-DrawWave_Ky[p]*sin(ANG)	 temp2[] = DrawWave_Kx[p]*sin(ANG)+DrawWave_Ky[p]*cos(ANG)	 duplicate/o temp1 DrawWave_Kx	 duplicate/o temp2 DrawWave_Ky  // make |k| wave  duplicate/o DrawWave_Kx, dkwave, klengWave dkwave[0] = 0  dkwave[1,] = sqrt( (DrawWave_Kx[p]-DrawWave_Kx[p-1])^2+(DrawWave_Ky[p]-DrawWave_Ky[p-1])^2) Integrate dkwave/D=klengWave //kdistance = klengWave[kpoints-1] kdistance=sqrt( (DrawWave_Kx[kpoints-1]-DrawWave_Kx[0])^2 + (DrawWave_Ky[kpoints-1]-DrawWave_Ky[0])^2) ratio = kdistance/(kpoints-1) / dkwave[1] make/o/n=(epoints,ratio*kpoints) DrawImage_K SetScale/I y 0,kdistance,"", DrawImage_K execute "DrawImage_K()() = DrawImage(x)( getPoint(klengWave,y) )" duplicate/o DrawImage_K DrawImage   Label bottom "\f02k\B\M\f00 / \F'Symbol'p";DelayUpdate   Label left "Energy (eV)"endFunction getPoint(basewave,val)wave basewavevariable valfindlevel/q basewave, valreturn (V_LevelX)endFunction DivGraphpopup (popStr) 	String popStr	string statement, waveAll, MapName	variable Epoints, DrawPanelNo, i	string graphname, panelname, baseMap	string  wavename  Nvar EfgraphNo, EFvalue  if (stringmatch(popStr,"_none_"))   return -1// User canceled   endif	dowindow/f $popStr	DrawPanelNo = 0	do 	 if (stringmatch(popStr,"Draw_SecondDiv_EDC"))	  panelname = "Draw2ndEDCpanel"+num2str(DrawPanelNo)	  MapName = "Draw2ndEDC"+num2str(DrawPanelNo)	  baseMap = "Draw_Dif2dEDC"	  graphname="\\Z16Draw2ndEDC"+num2istr(DrawPanelNo)		 elseif (stringmatch(popStr,"Draw_SecondDiv_MDC"))	  panelname = "Draw2ndMDCpanel"+num2str(DrawPanelNo)	  MapName = "Draw2ndMDC"+num2str(DrawPanelNo)	  baseMap = "Draw_Dif2dMDC"	  graphname="\\Z16Draw2ndMDC"+num2istr(DrawPanelNo)		 endif	  dowindow $panelname	  DrawPanelNo+=1  	while (V_flag==1)	DrawPanelNo-=1	 	   statement = WinRecreation(winname(0,1),0)  	   execute statement     	dowindow/c $panelname	 		TextBox/C/N=graphname/F=0/A=MC graphname	TextBox/C/N=graphname/F=0/A=MC/X=-28.42/Y=36.55    duplicate/o $baseMap $MapName     AppendImage $MapName     ModifyImage $MapName  ctab= {*,*,Rainbow,1}    RemoveImage $baseMapEndFunction Draw_2DivMapGraph (ctrlname) : ButtonControl	string	ctrlname	string Panelname	string value= "_none_;" + WinList("Draw_SecondDiv_*",";","")	Prompt Panelname, "Chose panel name", popup ,value   Doprompt "Make Graph",  Panelname     if (V_Flag)   return -1// User canceled   endif    DivGraphpopup (Panelname) endFunction Draw_save2gr(ctrlname): Buttoncontrol     string ctrlname     wave Grallnum, temp_save2gr     string targetwin     variable epoints,xmin,xmax,v_min,v_max, offset,i     string offsetstr     Nvar GoffsetNorm     wave w_wavelist     Prompt targetwin, "Target Wave Name"     Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")       Doprompt "Where to Store", offsetstr, targetwin   if (V_Flag)   	  return -1// User canceled    endif         make/o temp_save2gr     epoints=dimsize($targetwin,0)     getaxis/q left     xmin=v_min; xmax=v_max  	sscanf offsetstr, "G%f", offset  	i=Grallnum[offset/1000]  	redimension/n=(epoints) temp_save2gr  	temp_save2gr[]=xmin+(xmax-xmin)/(epoints-1)*p  	duplicate/o  temp_save2gr 	$"gx"+num2str(offset+i+1)  	duplicate/o $targetwin $"gr"+num2str(offset+i+1)       Grallnum[offset/1000]=i+1       print "Store at gr"+num2str(offset+i+1)endFunction DrawCombFS (ctrlName) : ButtonControl	String ctrlName	SVAR  DrawWinName, DrawPanelname	DrawWinName=WinName(0,1)	dowindow/f $DrawWinName	GraphWaveDraw/o DrawY,DrawX	DrawPanelname = DrawWinNameendFunction CombFS(ctrlname): Buttoncontrol	string ctrlname	string FS1, FS2, name_fs3	variable i, j, v_min,v_max, kxpoint, kypoint, v_avg, FS11_avg, FS21_avg	wave FS3	wave drawY, drawX	wave drawyy,drawxx		make/o/n=2 drawxx	make/o/n=2 drawyy		Prompt FS1, "Master FS"	Prompt FS2, "Secondary FS"	Prompt name_fs3, "Final FS"	Doprompt "Enter wave name of FS", FS1, FS2, name_fs3	if(V_Flag)		return -1	endif		duplicate/o $FS1, FS3	wave FS11=$FS1	wave FS21=$FS2			kypoint=dimsize($FS1,0)	kxpoint=dimsize($FS1,1)		getaxis/q bottom	drawxx[0]=(drawx[0]-v_min)*(kxpoint-1)/(v_max-v_min)	drawxx[1]=(drawx[1]-v_min)*(kxpoint-1)/(v_max-v_min)	getaxis/q left	drawyy[0]=(drawy[0]-v_min)*(kypoint-1)/(v_max-v_min)	drawyy[1]=(drawy[1]-v_min)*(kypoint-1)/(v_max-v_min)	imagestats /g={drawXX[0], drawXX[1], drawYY[0],drawyy[1]} FS11	FS11_avg=v_avg	imagestats /g={drawXX[0], drawXX[1], drawYY[0],drawyy[1]} FS21	FS21_avg=v_avg		for(i=0;i<kxpoint;i=i+1)		for(j=0;j<kypoint;j=j+1)						if(FS11[i][j]==0)				FS3[i][j]=FS21[i][j]/FS21_avg			else				FS3[i][j]=FS11[i][j]/FS11_avg			endif		endfor	endfor		duplicate/o fs3 $name_fs3		display/W=(279,112,683,496); 	AppendImage $name_fs3	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	Label left "\\f02k\\By\\M\\f00 / \\F'Symbol'p"	Label bottom "\\f02k\\Bx\\M\\f00 / \\F'Symbol'p"	endFunction Draw_SecondDerivativeShow (ctrlName) : ButtonControl	String ctrlName	dowindow/f Draw_SecondDiv_EDC	dowindow/f Draw_SecondDiv_MDC	end	Function Draw_scopeShow (ctrlName) : ButtonControl	String ctrlName	dowindow/f Draw_scopeend	Function Draw_cutmapShow (ctrlName) : ButtonControl	String ctrlName	dowindow/f cutmapend	Function Draw_Div2dFunc(ctrlName) : ButtonControl	String ctrlName	Svar EDCorMDC	Nvar  dkpoints, Nopoly, Draw_dE, Draw_Emean, Draw_Estep	variable mean_meV, dE_meV, dE_points, dk_points, mean_slices, No_poly=3  string EorM  mean_meV=Draw_Emean ; dE_meV = Draw_dE  dk_points=dkpoints ; EorM=EDCorMDC    Prompt EorM, "Along EDC or MDC or Both ?", popup ,"EDC"+";MDC"+";Both"  Doprompt "Derivative Parameter",  EorM  if (V_Flag)   return -1// User canceled   endif   EDCorMDC=EorM   if (stringmatch(EorM,"EDC"))    dowindow/f Draw_scope    if (V_flag==0)     	abort "Show Draw_scope becasue this Function uses scopes."    endif       	Prompt dE_meV "dE (meV): "  			Doprompt "2nd derivative",  dE_meV  			if (V_Flag)   			return -1// User canceled   			endif   			Draw_dE=dE_meV ; dE_points=round( dE_meV/(Draw_Estep*1000) ) ; Nopoly=No_poly   			Draw_2divEDC (dE_points,No_poly)   elseif (stringmatch(EorM,"MDC"))        dowindow/f CutMap    if (V_flag==0)     	abort "Show CutMap becasue this Function uses the image."    endif     Prompt mean_meV, "mean range +-meV: "     Prompt dk_points "dk points: "    Doprompt "2nd derivative", dk_points,mean_meV    if (V_Flag)     return -1// User canceled     endif     Draw_Emean=mean_meV    mean_slices=round( mean_meV/(Draw_Estep*1000) )    dkpoints=dk_points; Nopoly=No_poly    Draw_2divMDC (dk_points,No_poly,mean_slices)       elseif (stringmatch(EorM,"Both"))       dowindow/f Draw_scope    if (V_flag==0)     	abort "Show Draw_scope becasue this Function uses scopes."    endif      dowindow/f CutMap    if (V_flag==0)     	abort "Show CutMap becasue this Function uses the image."    endif         Prompt dE_meV "EDC dE (meV): "    Prompt dk_points "MDC dk points: "       Prompt mean_meV, "MDC mean range +-meV: "         Doprompt "2nd derivative",  dE_meV,dk_points,mean_meV  			Draw_dE=dE_meV ; dE_points=round( dE_meV/(Draw_Estep*1000) ) ; Nopoly=No_poly       Draw_Emean=mean_meV ; mean_slices=round( mean_meV/(Draw_Estep*1000) ) ; dkpoints=dk_points       Draw_2divEDC (dE_points,No_poly)      Draw_2divMDC (dk_points,No_poly,mean_slices)   			      	  if (V_Flag)   	 return -1// User canceled   	 endif   endif  endFunction Draw_2divMDC (dk_points,No_poly,mean_slices)	variable dk_points,No_poly,mean_slices	variable i, j, Epoints, sliceNo, est, kst, de, dk, kpoints	wave temp0, temp1, temp2, temp3	NVAR  Draw_Estep	string fit, fit_def, fit_defdef, graphname	WAVE  Drawimage	dk_points/=2   Epoints=dimsize(Drawimage,0)	 kpoints=dimsize(Drawimage,1)	 dE = Draw_Estep   fit="fit_temp0"	fit_def="fit_temp0_DIF"	fit_defdef="fit_temp0_DIFDIF"  duplicate/o Drawimage temp3, Draw_Dif2dMDC  make/o/n=(kpoints) temp0	dowindow/f Draw_SecondDiv_MDCif (v_flag!=1)  display ; appendimage Draw_Dif2dMDC  dowindow/c Draw_SecondDiv_MDCendifModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdateLabel left "Slice";DelayUpdateLabel bottom "Energy (eV)"ModifyGraph swapXY=1ModifyImage Draw_Dif2dMDC ctab= {*,*,Rainbow,1}graphname="\\Z18Dif_MDC"TextBox/C/N=graphname/F=0/A=MC graphnameTextBox/C/N=graphname/X=-39.39/Y=37.24ModifyImage Draw_Dif2dMDC ctab= {0,*,Rainbow,1}variable /g v_fitoptions=4for (j=0; j<Epoints; j+=1) print j,"/",Epoints   for (i=-mean_slices ; i<=mean_slices ; i+=1)   temp0[]+=DrawImage[j+i][p]  endfor   temp0/=(1+mean_slices)  for (i=0; i<kpoints; i+=1)  if (i<= dk_points)   CurveFit/q poly No_poly, temp0[0,i+dk_points]/D   elseif (i <= (kpoints - dk_points))   CurveFit/q poly No_poly, temp0[i-dk_points,i+dk_points] /D   else     CurveFit/q poly No_poly, temp0[i-dk_points,numpnts(temp0)]/D   endif   Differentiate $fit/D=$fit_def   Differentiate $fit_def/D=$fit_defdef   duplicate/o $fit_defdef temp2  if (i<= dk_points)   temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dk_points)]  else    temp1[i]=-temp2[dimsize(temp2,0)/2]  endif endfor temp3[j][]=temp1[q] duplicate/o temp3 Draw_Dif2dMDCendforv_fitoptions=0endFunction Draw_check2div_MDC (No_slice,dk_points,No_poly,mean_slices)  variable No_slice,dk_points,No_poly,mean_slices	wave DrawImage	Nvar dkpoints, Nopoly, Noslice  variable i, Epoints, kpoints  wave scopeX, temp0, temp1, temp2, akw2d  string base, slice, result,  fit, fit_def, fit_defdef, panelname  dk_points/=2  kpoints=dimsize(DrawImage,1)  make/o/n=(kpoints) temp1   temp1=0   for (i=-mean_slices ; i<=mean_slices ; i+=1)   temp1[]+=DrawImage[No_slice+i][p]  endfor   temp1/=(1+mean_slices)  slice="baseMDC"  duplicate/o temp1 $slice  temp1=0  result="difslice"  fit="fit_baseMDC"  fit_def="fit_baseMDC_DIF"  fit_defdef="fit_baseMDC_DIFDIF"  panelname = "Check2ndDiv_MDC"dowindow/f $panelnameif (V_flag!=1)display/W=(30,30,500,250) $slice dowindow/c $panelnameModifyGraph tick(bottom)=2,mirror(bottom)=1,minor(bottom)=1,fSize=16;DelayUpdateLabel bottom "Slice"duplicate/o $slice $fit,$fit_def,$fit_defdef,$resultappendtograph  $fitappendtograph/R $resultendifModifyGraph fSize=16ModifyGraph rgb($fit)=(0,0,65535)ModifyGraph rgb($result)=(9,37956,0)ModifyGraph zero(right)=3variable /g v_fitoptions=4for (i=0; i<kpoints; i+=1) if (i<= dk_points) CurveFit/q poly No_poly, $slice[0,i+dk_points]/D  elseif (i <= (kpoints - dk_points)) CurveFit/q poly No_poly, $slice[i-dk_points,i+dk_points]/D  else  CurveFit/q poly No_poly, $slice[i-dk_points,numpnts($slice)] /D  endif Differentiate $fit/D=$fit_def Differentiate $fit_def/D=$fit_defdef duplicate/o $fit_defdef temp2 if (i<= dk_points) temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dk_points)] else temp1[i]=-temp2[dimsize(temp2,0)/2] endif duplicate/o temp1 $result endforv_fitoptions=0endFunction Draw_2divEDC (dE_points, No_poly)variable dE_points, No_polyvariable i, j, Epoints, kpoints, est, kst, de, dkwave DscopeX, temp0, temp1, temp2, temp3, akw2dstring slice, fit, fit_def, fit_defdef, MatDif, graphname, grNVAR  interp_scopeWAVE map, DrawImagedE_points/=2est = Dscopex[0]de = Dscopex[1]-estfit="fit_temp0"fit_def="fit_temp0_DIF"fit_defdef="fit_temp0_DIFDIF"kpoints=dimsize(DrawImage,1)duplicate/o DrawImage,  Draw_Dif2dEDC, temp3SetScale/P x est,de,"", Draw_Dif2dEDC, temp3Epoints=dimsize(Draw_Dif2dEDC,0)duplicate/o DscopeX temp1temp1=0dowindow/f Draw_SecondDiv_EDCif (v_flag!=1)  display ; appendimage Draw_Dif2dEDC  dowindow/c Draw_SecondDiv_EDCendifModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdateLabel left "Cannel";DelayUpdateLabel bottom "Energy (eV)"ModifyGraph swapXY=1ModifyImage Draw_Dif2dEDC ctab= {*,*,Rainbow,1}graphname="\\Z18Dif_EDC"TextBox/C/N=graphname/F=0/A=MC graphnameTextBox/C/N=graphname/X=-39.39/Y=37.24ModifyImage Draw_Dif2dEDC ctab= {0,*,Rainbow,1}variable /g v_fitoptions=4for (j=0; j<kpoints; j+=1) print j,"/",kpoints slice="Dscope"+num2istr(j) duplicate/o $slice temp0 for (i=0; i<epoints; i+=1)  if (i<= dE_points)   CurveFit/q poly No_poly, temp0[0,i+dE_points] /X=DscopeX /D   elseif (i <= (epoints - dE_points))   CurveFit/q poly No_poly, temp0[i-dE_points,i+dE_points] /X=DscopeX /D   else     CurveFit/q poly No_poly, temp0[i-dE_points,numpnts($slice)] /X=DscopeX /D   endif   Differentiate $fit/D=$fit_def   Differentiate $fit_def/D=$fit_defdef   duplicate/o $fit_defdef temp2  if (i<= dE_points)   temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dE_points)]  else    temp1[i]=-temp2[dimsize(temp2,0)/2]  endif endfor temp3[][j]=temp1[p] duplicate/o temp3 Draw_Dif2dEDCendforv_fitoptions=0//duplicate/o Draw_Dif2dEDC DifCutendFunction Draw_check2divFunc (ctrlName) : ButtonControl	String ctrlName	Nvar dkpoints, Nopoly, Noslice, Eslice, Draw_Estep, Draw_dE, Draw_Emean	Svar EDCorMDC  variable dE_points, dk_points, No_poly=3, No_slice  variable i, Epoints, dE_meV, sliceK_eV, mean_meV, mean_slices  wave DrawImage  string EorM  mean_meV=Draw_Emean ; sliceK_eV=Eslice ; dE_meV = Draw_dE   dk_points=dkpoints ; No_slice=Noslice ; EorM=EDCorMDC  Prompt EorM, "Along EDC or MDC ?", popup ,"EDC"+";MDC"    Doprompt "check derivative",  EorM  if (V_Flag)   return -1// User canceled   endif   EDCorMDC=EorM    if (stringmatch(EorM,"EDC"))    Prompt No_slice, "slice No.: "     Prompt dE_meV "dE (meV): "    Doprompt "check derivative",  No_slice,dE_meV    if (V_Flag)     return -1// User canceled     endif     Draw_dE=dE_meV ; dE_points=round( dE_meV/(Draw_Estep*1000) )    Nopoly=No_poly ; Noslice=No_slice    Draw_check2div_EDC (No_slice,dE_points,No_poly)  elseif (stringmatch(EorM,"MDC"))       Prompt sliceK_eV, "slice energy (eV): "    Prompt mean_meV, "mean range +-meV: "     Prompt dk_points "dk points: "    Doprompt "check derivative",  sliceK_eV ,mean_meV, dk_points    if (V_Flag)     return -1// User canceled     endif     Draw_Emean=mean_meV    mean_slices=round( mean_meV/(Draw_Estep*1000) )    Eslice=sliceK_eV ; dkpoints=dk_points; Nopoly=No_poly    No_slice=round( getEslice(sliceK_eV) )    Draw_check2div_MDC (No_slice,dk_points,No_poly,mean_slices)  endif  endFunction getEslice(sliceK_eV)	variable sliceK_eV	wave DrawImage	variable Epoints	Epoints=dimsize(DrawImage,0)	make/o/n=(Epoints) temp 	temp[] = DimOffset(DrawImage, 0) + p*DimDelta(DrawImage, 0)	findlevel/q temp, sliceK_eV	return(V_LevelX)endFunction Draw_check2div_EDC (No_slice,dE_points,No_poly)  variable No_slice,dE_points,No_poly  variable i, Epoints  wave DscopeX, temp0, temp1, temp2, akw2d  string base, slice, result,  fit, fit_def, fit_defdef, panelname, EorM  dE_points/=2  Epoints=dimsize(DscopeX,0)  make/o/n=(Epoints) temp1  base="Dscope"+num2istr(No_slice)  slice="baseEDC" duplicate/o $base $slice  temp1=0  result="difslice"  fit="fit_baseEDC"  fit_def="fit_baseEDC_DIF"  fit_defdef="fit_baseEDC_DIFDIF"  panelname = "Check2ndDiv_EDC"dowindow/f $panelnameif (V_flag!=1)display/W=(30,30,500,250) $slice vs DscopeXdowindow/c $panelnameModifyGraph tick(bottom)=2,mirror(bottom)=1,minor(bottom)=1,fSize=16;DelayUpdateLabel bottom "Energy (eV)"duplicate/o $base $fit,$fit_def,$fit_defdef,$resultappendtograph  $fitappendtograph/R $result vs DscopeXendifModifyGraph fSize=16ModifyGraph rgb($fit)=(0,0,65535)ModifyGraph rgb($result)=(9,37956,0)ModifyGraph zero(right)=3variable /g v_fitoptions=4for (i=0; i<epoints; i+=1) if (i<= dE_points) CurveFit/q poly No_poly, $slice[0,i+dE_points] /X=DscopeX /D  elseif (i <= (epoints - dE_points)) CurveFit/q poly No_poly, $slice[i-dE_points,i+dE_points] /X=DscopeX /D  else  CurveFit/q poly No_poly, $slice[i-dE_points,numpnts($slice)] /X=DscopeX /D  endif Differentiate $fit/D=$fit_def Differentiate $fit_def/D=$fit_defdef duplicate/o $fit_defdef temp2 if (i<= dE_points) temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dE_points)] else temp1[i]=-temp2[dimsize(temp2,0)/2] endif duplicate/o temp1 $result endforv_fitoptions=0endFunction Draw_smoothproc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr 	String varName	Nvar Draw_smooth	dowindow/f Draw_scope	if (V_flag==1)	    	DrawInputFunc ()    	DrawOffsetfunc ()    endif end	Function Draw_smoothFunc ()Nvar Draw_smoothvariable istring sourcestring waveAll   waveAll = TraceNameList("",";",1)   for ( i=0; i< ItemsInList(waveAll); i+=1 )		source = "Dscope"+num2istr(i)		duplicate/o $source temp		smooth Draw_smooth,temp		duplicate /o temp $source	endforend	   Function DrawMakeBz (ctrlName) : ButtonControl	String ctrlName		Svar Gobzname, DrawBZname	Nvar draw_meanX, draw_meanY, interpX_Draw, interpY_Draw  if (draw_meanX>1)	  DrawMean_X_Func ()	endif	if (draw_meanY>1)	  DrawMean_Y_Func ()	endif	if (draw_meanX==1 && draw_meanY==1)	  duplicate/o bz bz_mean	endif   if (interpX_Draw>1 || interpY_Draw>1)   DrawInterpFunc ()  endif 	if (interpX_Draw==1 && interpX_Draw==1)	  duplicate/o bz_mean bz_MeanInterp	endif	DrawBZname = Gobznameend		function  Fermi2DFunc ()    variable Vmax, Vmin, Temperature    variable eV=1.6*10^-19, kB=1.3807*10^-23    variable GraphNo    svar bzname    wave map, DrawImage    duplicate/o $bzname temp    GraphNo = temp[0][0]	 ImageStats/M=1 DrawImage    Vmax = V_max    Vmin = V_min	 Temperature =  map[GraphNo][2]	// Temperature =  map[GraphNo][0]	 DrawImage[][] /= 1 / ( 1 + exp(pnt2x(DrawImage,p)/(kB*Temperature/eV) ) )	  ModifyImage/w=CutMap DrawImage ctab= {Vmin,Vmax,Rainbow,1} endfunction  FermiScopeFunc ()    string waveAll, source    variable i, Vmax, Vmin, Temperature    variable eV=1.6*10^-19, kB=1.3807*10^-23    variable GraphNo    svar bzname    wave map    duplicate/o $bzname temp    GraphNo = temp[0][0]    GetAxis/q/W=Draw_scope left    Vmax = V_max    Vmin = V_min    waveAll = TraceNameList("",";",1)        		for ( i=0; i< ItemsInList(waveAll); i+=1 )		source = "Dscope"+num2istr(i)		duplicate/o $source, temp, temp2, temp3		duplicate/o DscopeX, temp1		Temperature = map[GraphNo][2]		//Temperature = map[GraphNo][0]     temp2[] = 1 / ( 1 + exp( temp1[p]/(kB*Temperature/eV) ) )     temp[] = temp3[p]/temp2[p]     duplicate/o  temp $source	   endfor	 SetAxis/w=Draw_scope left Vmin, Vmax endFunction DrawInterpFunc () Nvar interpX_Draw, interpY_Draw string base="M_interpolatedimage" wave bz variable j ImageInterpolate /f={interpX_Draw,interpY_Draw}  bilinear bz_Mean duplicate/o $base bz_MeanInterpend Function DrawInterp_Y_Func () Nvar Draw_meanX wave bz variable j duplicate/o bz bz_mean      bz_mean=0    for (j=-(Draw_meanX-1)/2 ; j<=(Draw_meanX-1)/2 ; j+=1)      bz_mean[][][] += bz[p+j][q][r]    endfor      bz_mean/=Draw_meanXendFunction DrawMean_X_Func () Nvar Draw_meanX wave bz variable j duplicate/o bz bz_mean      bz_mean=0    for (j=-(Draw_meanX-1)/2 ; j<=(Draw_meanX-1)/2 ; j+=1)      bz_mean[][][] += bz[p+j][q][r]    endfor      bz_mean/=Draw_meanXendFunction DrawMean_Y_Func () Nvar Draw_meanY wave bz variable j duplicate/o bz bz_mean      bz_mean=0    for (j=-(Draw_meanY-1)/2 ; j<=(Draw_meanY-1)/2 ; j+=1)      bz_mean[][][] += bz[p][q+j][r]    endfor      bz_mean/=Draw_meanYendFunction DrawInputFunc ()   string waveAll, nameY, nameX  wave zerowave, DrawImage  variable i, kpoints, Epoints, j  Nvar Draw_smooth  dowindow cutmap  if (V_flag==0)   abort "show Map first!!"  endif  	 Epoints = dimsize(DrawImage,0)   kpoints = dimsize(DrawImage,1)    make/o/n=(Epoints) temp1, temp2	  waveAll = TraceNameList("",";",1)	   appendtograph zerowave     for (i=ItemsInList(waveAll)-1; i >= 0; i-=1)        RemoveFromGraph $StringFromList(i, waveAll)     endfor    temp1[] = DimOffset(DrawImage, 0) + p*DimDelta(DrawImage, 0)    nameX = "DscopeX"    duplicate/o temp1 $nameX  for (i=0 ; i<kpoints ; i+=1)     nameY = "Dscope"+num2str(i)      temp2[] = DrawImage[p][i]    	duplicate /o temp2 $nameY     appendtograph $nameY vs $nameX     endfor   removefromgraph zerowave    if (Draw_smooth>=1)	     Draw_smoothFunc ()	 endifendFunction DrawGetFunc_back ()string Xwave, checkstring	string base="M_interpolatedimage"	variable Linelength, sizeZ, ix, iy, i=0, dx, dy, x1_interp, x0_interp, y1_interp, y0_interp	variable epoints	Nvar interpX_Draw, interpY_Draw	svar bzname	wave bz_mean, DrawX, DrawY, temp, temp1,temp2, map, ne2d	checkstring=num2istr(DrawX[0])  if (stringmatch(checkstring,"nan"))  abort "Draw line or Close this window!!"  endif  ImageInterpolate /f={interpX_Draw,interpY_Draw}  bilinear bz_mean  duplicate/o $base, temp2  epoints=dimsize(bz_mean,2)  x0_interp = DrawX[0]*interpX_Draw  x1_interp = DrawX[1]*interpX_Draw  y0_interp = DrawY[0]*interpY_Draw  y1_interp = DrawY[1]*interpY_Draw	dx=abs(x1_interp-x0_interp)	dy=abs(y1_interp-y0_interp)   if (dx>=dy)   Linelength=dx   make/o/n=(epoints,Linelength) ne2d    if (DrawX[0]<=DrawX[1])    	ne2d[][]=temp2[q+x0_interp][(y1_interp-y0_interp)/(x1_interp-x0_interp)*q+y0_interp][epoints-p]     else     ne2d[][]=temp2[(-q)+x0_interp][(y1_interp-y0_interp)/(x1_interp-x0_interp)*(-q)+y0_interp][epoints-p]     endif    else      Linelength=dy   make/o/n=(epoints,Linelength) ne2d    if (DrawY[0]<=DrawY[1])      ne2d[][]=temp2[(x1_interp-x0_interp)/(y1_interp-y0_interp)*q+x0_interp][q+y0_interp][epoints-p]     else     ne2d[][]=temp2[(x1_interp-x0_interp)/(y1_interp-y0_interp)*(-q)+x0_interp][(-q)+y0_interp][epoints-p]    endif   endif   duplicate/o ne2d, DrawImageEndFunction Draw_sym_check (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	variable i   string nameX, nameY, waveAll	Nvar Draw_sym_checked, Draw_Fermi_checked	Draw_sym_checked = checked	if (Draw_Fermi_checked==1)	abort "Take off Femi check !!"	endif	Dowindow/f Draw_scope	if (V_flag==1 && Draw_sym_checked==1)      ShowSymfunc ()	elseif (V_flag==1 && Draw_sym_checked==0)	   DrawInputFunc () 	   DrawOffsetfunc () 	endifendFunction Draw_EDCGraph (ctrlname) : ButtonControl	string	ctrlname	string statement, waveAll	variable Epoints, DrawPanelNo, i, valXmin, valXmax, offs	wave DrawImage	string nameY, nameX	string legtext, panelname	Nvar Draw_offs	dowindow/f Draw_scopeif (V_flag==1)	DrawPanelNo = 0	do 	panelname = "DrawEDC"+num2str(DrawPanelNo)	dowindow $panelname	DrawPanelNo+=1	while (V_flag==1)	DrawPanelNo-=1 	   statement = WinRecreation(winname(0,1),0)  	   execute statement     	dowindow/c $panelname	   	legtext="\\Z16DrawEDC"+num2istr(DrawPanelNo)		  waveAll = TraceNameList("",";",1)    nameX = "Dscope"+num2str(DrawPanelNo)+"X"    duplicate/o DscopeX $nameX 	  offs  = 0     for (i=0 ;  i < ItemsInList(waveAll); i+=1)        nameY = "Dscope"+num2str(DrawPanelNo)+"_"+num2str(i)        duplicate/o $StringFromList(i, waveAll) $nameY        appendtograph $nameY vs $nameX        ModifyGraph offset($nameY)={0,offs}		   offs += Draw_offs        RemoveFromGraph $StringFromList(i, waveAll)     endfor     Legend/C/N=ButtLeg/F=0/A=LT/B=0 legtext    legtext=legtext[0,strlen(legtext)-2] endifendFunction Draw_MapGraph (ctrlname) : ButtonControl	string	ctrlname	string statement, waveAll, MapName	variable Epoints, DrawPanelNo, i	wave DrawImage	string nameY, nameX	string legtext, panelname	Nvar Draw_offs		wave DrawImage	dowindow/f CutMapif (V_flag==1)	DrawPanelNo = 0	do 	panelname = "DrawMap"+num2str(DrawPanelNo)	dowindow $panelname	DrawPanelNo+=1	while (V_flag==1)	DrawPanelNo-=1 	   statement = WinRecreation(winname(0,1),0)  	   execute statement     	dowindow/c $panelname		legtext="\\Z16DrawMap"+num2istr(DrawPanelNo)	     Legend/C/N=ButtLeg/F=0/A=LT/B=0 legtext    legtext=legtext[0,strlen(legtext)-2]    MapName = "DrawIm"+num2str(DrawPanelNo)    duplicate/o DrawImage $MapName     AppendImage $MapName     ModifyImage $MapName  ctab= {*,*,Rainbow,1}    RemoveImage DrawImage endifendFunction DrawOffset (ctrlName,varNum,varStr,varName) : SetVariableControl		String ctrlName	Variable varNum	String varStr 	String varName  Drawoffsetfunc () EndFunction Drawoffsetfunc ()    variable kpoints,i,offs	String dest	NVAR Draw_offs	wave DrawImage   kpoints = dimsize(DrawImage,1)	offs = 0	for ( i=0; i<kpoints ; i+=1 )	  dest = "Dscope"+num2istr(i)  		ModifyGraph/w=Draw_scope offset($dest)={0,offs}		offs += Draw_offs	endforEndFunction ModiGraphfunc ()   ModifyGraph fSize=16	ModifyGraph tick(left)=3,tick(bottom)=2	ModifyGraph mirror(left)=2,mirror(bottom)=1	ModifyGraph minor(bottom)=1	ModifyGraph sep(bottom)=5	ModifyGraph noLabel(left)=1	ModifyGraph lblMargin(left)=10	ModifyGraph axOffset(left)=-3.75	ModifyGraph lblLatPos(left)=1	ModifyGraph standoff=0	ModifyGraph zero(bottom)=3	Label bottom "Energy (eV)"	Label left "Intensity (arb. units)"end	Function InterpBzFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varNameMappingFunc ()EndFunction BzGoFunc (ctrlName) : ButtonControl	String ctrlName	wave map	Svar bzname, Gobzname	nvar readTheta, readPhi,readRota	string result="FSmapping", base="M_interpolatedimage", panelname="Mapping" 	variable check, X1, X2	duplicate/o $bzname temp1	make/o/n=(2, dimsize($bzname,0), 3) bzTemp	bzTemp = 0	bzTemp[0][][0]=temp1[q][0]	bzTemp[0][][1]=temp1[q][2]	bzTemp[0][][2]=temp1[q][3]	makebz(bzTemp)	MappingFunc ()//	duplicate/o $base $result	 dowindow/f $panelname if (v_flag!=1) display/w=(30,30,800,400); appendimage $result ModifyImage $result ctab= {*,*,Rainbow,1}  dowindow/c $panelname   ModifyGraph minor=1,fSize=16,standoff=0//   if (check==1)//   SetScale/I x X1,X2,"", $result//   endif endif  Gobzname = bzname	readTheta=temp1[0][1]	readPhi=temp1[0][4]	readRota=temp1[0][5]End Function MappingFunc ()wave nk2d, tempNvar BzErange, BzEnergy, interpX_Bz, interpY_Bz Svar bzname	variable Enegative, Epositive, X1, X2	string result="FSmapping", base="M_interpolatedimage"	Enegative=(-1)*BzErange+BzEnergy	Epositive=BzErange+BzEnergy bznk($bzname,Enegative,Epositive) ImageInterpolate /f={interpX_Bz,interpY_Bz} bilinear nk2d   duplicate/o $bzname temp1 	if (stringmatch(num2str(temp1[0][1]),"nan")!=1)	 X1=temp1[0][1]	 X2=temp1[dimsize($bzname,0)-1][1]	 SetScale/I x X1,X2,"", $base	endif duplicate/o $base $result EndFunction bznk (bzmap,Ei_eV, Ef_eV)   wave bzmap 	variable Ei_eV, Ef_eV	variable nx, ny, nz, i, Windex, Ef_point, Ei_point		string Xaxis	WAVE bz, map	sVar dispwave	nx = dimsize(bz,0)	ny = dimsize(bz,1)	nz = dimsize(bz,2)	Windex=bzmap[0][0][0]	if ( stringmatch(dispwave,"cr"))		Xaxis = "cx"+num2istr(Windex)	else	Xaxis="gx"+num2istr(Windex)	endif	make /o/n=(nx,ny) nk2d	nk2d = 0	duplicate/o $Xaxis temp0	if ( stringmatch(dispwave,"gr") ||  stringmatch(dispwave,"nr") || stringmatch(dispwave,"Dif*"))	temp0-=map[Windex][7]	endif	findlevel/q temp0 Ei_eV	Ei_point=(nz-1)-V_LevelX	findlevel/q temp0 Ef_eV	Ef_point=(nz-1)-V_LevelX			for ( i=Ef_point; i<Ei_point; i+=1 )					nk2d[][]+=bz[p][q][i]			endforEndFunction MakeBz ( bzmap )	wave  bzmap	string theGraph, Xaxis	variable Gr, T, F, nx, ny, nz, nycut, ini, Ecompare	variable epoints,kpoints,i,MaxNycut,oldNycut,NewNycut,dp,dx,P0,P1   SVAR dispwave	   wave map		gr = bzmap[0][0][0]	Xaxis="gx"+num2istr(gr)	duplicate/o $Xaxis temp, temp1	dx = abs(temp[1]-temp[0])	  temp1[] = temp[p] - map[Gr][7]  Ecompare = temp1[dimsize(temp1,0)/2]   findlevel/q temp1 Ecompare   //findlevel/q temp1 0   P0 = V_LevelX		epoints = GetGraphDim(gr,0)	kpoints = GetGraphDim(gr,1)	ny = DimSize(bzmap,0)	nx = DimSize(bzmap,1)	nycut = 0	for ( i=0; i<nx; i+=1 )		NewNycut = (bzmap[0][i][2]-bzmap[0][i][1])		MaxNycut = max(oldNycut,NewNycut)		oldNycut = MaxNycut	endforprint "Epoints: ",epoints,   "     kx: ", nx, "    ky: ",MaxNycut		make/o/n=(nx,MaxNycut,epoints) bz	bz = 0	for ( T=0; T<nx; T+=1 )			Gr = bzmap[0][T][0]			theGraph = dispwave+num2istr(gr)        Xaxis="gx"+num2istr(gr)     	duplicate/o $Xaxis temp, temp1            temp1[] = temp[p] - map[Gr][7]        findlevel/q temp1 Ecompare      // findlevel/q temp1 0        P1 = V_LevelX					dp = P0 - P1		//	print dp			if (Gr>=0)				ini = bzmap[0][T][1]				duplicate/o $theGraph temp				bz[T][][] = temp[epoints-(r+dp)][q+ini]			endif    endforEndFunction MakeBz_back ( bzmap )	wave  bzmap	string theGraph	variable Gr, T, F, nx, ny, nz, nycut, ini	variable epoints, kpoints, i, MaxNycut, oldNycut, NewNycut   SVAR dispwave			gr = bzmap[0][0][0]	epoints = GetGraphDim(gr,0)	kpoints = GetGraphDim(gr,1)	ny = DimSize(bzmap,0)	nx = DimSize(bzmap,1)	nycut = 0	for ( i=0; i<nx; i+=1 )		NewNycut = (bzmap[0][i][2]-bzmap[0][i][1])		MaxNycut = max(oldNycut,NewNycut)		oldNycut = MaxNycut	endforprint "Epoints: ",epoints,   "     kx: ", nx, "    ky: ",MaxNycut		make/o/n=(nx,MaxNycut,epoints) bz	bz = 0	for ( T=0; T<nx; T+=1 )			Gr = bzmap[0][T][0]			theGraph = dispwave+num2istr(gr)			if (Gr>=0)				ini = bzmap[0][T][1]				i = 0				duplicate/o $theGraph temp				bz[T][][] = temp[epoints-r][q+ini]			endif    endforEndFunction BzErangeFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar BzErangeBzErange= varNumMappingFunc ()EndFunction BzEnergyFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar BzEnergyBzEnergy= varNumMappingFunc ()EndFunction change_bzname(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varNameEndFunction NewBzFunc (ctrlName) : ButtonControl	String ctrlName	Nvar Goffset, BzmapDimsize	string Addname="", offsetstr, BzmapTable, panelname="Bztable", Inputfirstwave, YesNo	variable LastGraphNo=1, FirstSliceNo=1,  FirstGraphNo=1, TotalSliceNo, offset, i	wave map	svar dispwave	if (Goffset==0)   offsetstr = "G0000"  else   offsetstr = "G"+num2str(Goffset)  endif	Prompt Addname,"bzmap_ + ? : Bzmap Table Name"	Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")	Prompt FirstGraphNo,"From No."	Prompt LastGraphNo,"To No."   DoPrompt "Bzmap Table setting",  Addname, offsetstr, FirstGraphNo, LastGraphNo 	if (V_flag != 0) 	 return -1; // User cancelled.  	endif  	BzmapTable = "bzmap_" + Addname 	if (exists(BzmapTable)==1) 	  Prompt YesNo, "Yes or No", popup, "Yes"+";No" 	  DoPrompt "There is this 'bamap' name. Do you want to replace?",  YesNo 	endif 	if (exists(BzmapTable)==0 || stringmatch(YesNo,"yes")==1)// 	Make/o/N=(2,ImputNum,3)/D $BzmapTable   Make/o/N=((abs(LastGraphNo-FirstGraphNo)+1),6)/D $BzmapTable	duplicate/o $BzmapTable temp	sscanf offsetstr, "G%f", offset 	Inputfirstwave = "gr" + num2str(FirstGraphNo+offset) 	//Inputfirstwave = dispwave + num2str(FirstGraphNo+offset) 	TotalSliceNo = dimsize($Inputfirstwave,1)	//temp[0][][0]=q+offset+FirstGraphNo	temp[][0]=p+offset+FirstGraphNo	temp[][1]=map[p+offset+FirstGraphNo][6] //ARPES angel input	//temp[0][][1]=FirstSliceNo	temp[][2]=FirstSliceNo	//temp[0][][2]=TotalSliceNo	temp[][3]=TotalSliceNo		temp[][4]=map[p+offset+FirstGraphNo][11]	temp[][5]=map[p+offset+FirstGraphNo][12]	duplicate/o  temp $BzmapTable	BZpopupFunc("",0,BzmapTable)	endifEndFunction EFwave_func (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string wavename	Svar EFwave	Nvar EfgraphNo		Prompt varStr,"EF wave",popup WaveList("nr*",";","")   DoPrompt "EF Information", varStr if (V_flag != 0) return -1; // User cancelled. endif 	EfgraphNo=varNum	wavename="fit_"+varStr	display $varStr	ModifyGraph mode=4,marker=19	CurveFit poly 5,  $EFwave[0,dimsize($varStr,0)-1] /D 	ModifyGraph lsize($wavename)=2,rgb($wavename)=(0,0,65535)EndFunction getEsliceNo (sliceK_eV)	variable sliceK_eV	wave akw2d	variable Epoints	Epoints=dimsize(akw2d,0)	make/o/n=(Epoints) temp 	temp[] = DimOffset(akw2d, 0) + p*DimDelta(akw2d, 0)	findlevel/q temp, sliceK_eV	return(V_LevelX)endFunction Div2dFunc_back(ctrlName) : ButtonControl	String ctrlName	Nvar dEpoints, Nopoly, scope_add	variable dE_points=dEpoints, No_poly=Nopoly	if (scope_add > 1)	 abort "Set Add = 1 becasue this Function use scopes."	endif	  dowindow/f graph_scope  if (V_flag==1)   Prompt dE_points "dE points: "  //Prompt No_poly, "poly No.: "   Doprompt "2nd derivative",  dE_points  if (V_Flag)   return -1// User canceled   endif    AllsliceFunc()  else    abort "Show Graph_scope becasue this Function use scopes."  endif  second_derivative (dE_points,3)endFunction ScopeButton_ChangeGraph_auto(value) 	Variable value	NVAR scope_graph, update_2d, update_scope, scope_add	WAVE map	scope_graph=value	if (update_scope==1)     AllsliceFunc()	endif	if (update_2d==1 )			Scope_Change2D()	endifEndFunction second_derivative (dE_points, No_poly)variable dE_points, No_polyvariable i, j, Epoints, sliceNo, est, kst, de, dkwave scopeX, temp0, temp1, temp2, temp3, akw2dSVAR dispwave NVAR  scope_graphstring slice, fit, fit_def, fit_defdef, MatDif, graphname, grNVAR scope_graph, interp_scopeSVAR dispwaveWAVE scopex, map, Dif2dgr = dispwave+num2istr(scope_graph)est = scopex[0]de = scopex[1]-estfit="fit_temp0"fit_def="fit_temp0_DIF"fit_defdef="fit_temp0_DIFDIF"sliceNo=getGraphDim (scope_graph,1)MatDif="Dif"+num2istr(scope_graph)duplicate/o $gr temp3, Dif2dSetScale/P x est,de,"", Dif2d, temp3Epoints=dimsize(Dif2d,0)duplicate/o scopeX temp1temp1=0dowindow/f SecondDerivativeif (v_flag!=1)  display ; appendimage Dif2d  dowindow/c SecondDerivativeendifModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdateLabel left "Slice";DelayUpdateLabel bottom "Energy (eV)"ModifyGraph swapXY=1ModifyImage Dif2d ctab= {*,*,Rainbow,1}graphname="\\Z18Dif"+num2istr(scope_graph)TextBox/C/N=graphname/F=0/A=MC graphnameTextBox/C/N=graphname/X=-39.39/Y=37.24ModifyImage Dif2d ctab= {0,*,Rainbow,1}variable /g v_fitoptions=4for (j=0; j<sliceNo; j+=1) print j slice="scope"+num2istr(j) duplicate/o $slice temp0 for (i=0; i<epoints; i+=1)  if (i<= dE_points)   CurveFit/q poly No_poly, temp0[0,i+dE_points] /X=scopeX /D   elseif (i <= (epoints - dE_points))   CurveFit/q poly No_poly, temp0[i-dE_points,i+dE_points] /X=scopeX /D   else     CurveFit/q poly No_poly, temp0[i-dE_points,numpnts($slice)] /X=scopeX /D   endif   Differentiate $fit/D=$fit_def   Differentiate $fit_def/D=$fit_defdef   duplicate/o $fit_defdef temp2  if (i<= dE_points)   temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dE_points)]  else    temp1[i]=-temp2[dimsize(temp2,0)/2]  endif endfor temp3[][j]=temp1[p] duplicate/o temp3 Dif2dendforv_fitoptions=0duplicate/o Dif2d $MatDifendFunction second_derivative_MDC (dk_points,No_poly)	variable dk_points,No_poly	variable i, j, Epoints, sliceNo, est, kst, de, dk, kpoints	wave scopeX, temp0, temp1, temp2, temp3, akw2d	SVAR dispwave 	NVAR  scope_graph	string slice, fit, fit_def, fit_defdef, MatDif, graphname, gr	NVAR scope_graph, interp_scope	SVAR dispwave	WAVE scopex, map, Dif2dgr = dispwave+num2istr(scope_graph)est = scopex[0]de = scopex[1]-estfit="fit_temp0"fit_def="fit_temp0_DIF"fit_defdef="fit_temp0_DIFDIF"sliceNo=getGraphDim (scope_graph,0)MatDif="Dif"+num2istr(scope_graph)duplicate/o $gr temp3, Dif2dSetScale/P x est,de,"", Dif2d, temp3kpoints=dimsize(Dif2d,1)make/o/n=(kpoints) temp1, temp0temp1=0dowindow/f SecondDerivativeif (v_flag!=1)  display ; appendimage Dif2d  dowindow/c SecondDerivativeendifModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdateLabel left "Slice";DelayUpdateLabel bottom "Energy (eV)"ModifyGraph swapXY=1ModifyImage Dif2d ctab= {*,*,Rainbow,1}graphname="\\Z18Dif"+num2istr(scope_graph)TextBox/C/N=graphname/F=0/A=MC graphnameTextBox/C/N=graphname/X=-39.39/Y=37.24ModifyImage Dif2d ctab= {0,*,Rainbow,1}variable /g v_fitoptions=4for (j=0; j<sliceNo; j+=1) print j temp0[] = Dif2d[j][p] for (i=0; i<kpoints; i+=1)  if (i<= dk_points)   CurveFit/q poly No_poly, temp0[0,i+dk_points]/D   elseif (i <= (kpoints - dk_points))   CurveFit/q poly No_poly, temp0[i-dk_points,i+dk_points] /D   else     CurveFit/q poly No_poly, temp0[i-dk_points,numpnts(temp0)]/D   endif   Differentiate $fit/D=$fit_def   Differentiate $fit_def/D=$fit_defdef   duplicate/o $fit_defdef temp2  if (i<= dk_points)   temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dk_points)]  else    temp1[i]=-temp2[dimsize(temp2,0)/2]  endif endfor temp3[j][]=temp1[q] duplicate/o temp3 Dif2dendforv_fitoptions=0duplicate/o Dif2d $MatDifendFunction Scopebutton_2Dimage (ctrlName) : ButtonControl	String ctrlName	NVAR scope_graph   variable gr = scope_graph	string ImName,panelName, descriptor	Svar dispwave	ImName = "Im_"+dispwave+num2istr(gr)	panelName="Image_"+dispwave+num2istr(gr)	duplicate/o akw2d $ImName	Dowindow/f $panelName	if (V_flag!=1)	 Display /W=(5,42,377,293)	 dowindow /c $panelName	AppendImage $ImName	ModifyGraph swapXY=1	ModifyImage $ImName ctab= {*,*,PlanetEarth,1}	textbox/k/n=text0   sprintf descriptor " \\Z12%s ", ImName	Textbox/N=ImName /x=-32/y=40/F=0/A=MC descriptor	ModifyGraph tick=2,mirror=1,minor=1,fSize=10,standoff=0;DelayUpdate  	ModifyGraph margin(left)=36,margin(bottom)=29,margin(top)=7,margin(right)=7;DelayUpdate	ModifyGraph width=108,height={Aspect,1.5}	  	Label left "\\f01Energy (eV)"  endif  svar dispwave     if(stringmatch(dispwave, "Ek"))     Label bottom "Momentum (A\\S-1\\M)"     else     Label bottom "Slice"     endif    ModifyGraph width=0,height=0EndFunction Scopebutton_scopegraph (ctrlName) : ButtonControl	String ctrlName	NVAR scope_graph, scope_offs, scope_angle, scope_range,diffe_offset, scope_add	SVAR sampleName, dispwave	WAVE map, zerowave	variable gr = scope_graph, i, offs,diff, Itemtotal = 0, check_V_flag	string source, source2, dest, descriptor, destxax, sourcexax, waveAll="", removewave	destxax = "EDC_"+dispwave+num2istr(gr)+"x" 	duplicate /o scopex $destxax	dest = "Grs_"+dispwave+num2istr(gr)	dowindow/f $dest	check_V_flag = V_flag		if(check_V_flag!=1)	  Display /W=(62,43,400,600) 	   dowindow /c $dest	elseif (check_V_flag==1)   waveAll = TraceNameList("",";",1)   Itemtotal = ItemsInList(waveAll, ";")    if (Itemtotal > i)      appendtograph zerowave	    for (i=0 ; i < Itemtotal; i+=1  )	     removewave = StringFromList(i, waveAll)	      removefromgraph $removewave	    endfor	  endif	endif			if (diffe_offset==1)	 //	for ( i=0; i<ceil(scope_range/scope_add); i+=1 )	for ( i=ceil(scope_range/scope_add)-1; i>=0; i-=1 )	  source = "scope"+num2istr(i)  	  source2 = "scope"+num2istr(abs(i+1))       		duplicate/o $source temp1	  duplicate/o $source2 temp2	  duplicate/o $source temp0	  temp0=temp1-temp2	  wavestats/Q temp0	  diff=v_min	  offs += scope_offs-diff		dest = "EDC_"+dispwave+num2istr(gr)+"_"+num2istr(i+scope_angle) ;		duplicate /o $source $dest		//if ( strsearch(waveAll, dest, 0) == -1 )		appendtograph $dest vs $destxax		//endif		ModifyGraph rgb($dest)=(0,0,0)		ModifyGraph offset($dest)={0,offs}		ModifyGraph lsize($dest)=1	  endfor	   if (check_V_flag==1)	    removefromgraph zerowave	   endif	else	  for ( i=0;i<ceil(scope_range/scope_add) ; i+=1 )		source = "scope"+num2istr(i)       		dest = "EDC_"+dispwave+num2istr(gr)+"_"+num2istr(i+scope_angle) ;		duplicate /o $source $dest//	  if ( strsearch(waveAll, dest, 0) == -1 )		appendtograph $dest vs $destxax//		endif		ModifyGraph rgb($dest)=(0,0,0)		ModifyGraph offset($dest)={0,offs}		ModifyGraph lsize($dest)=1		offs += scope_offs	  endfor	   if (check_V_flag==1)	    removefromgraph zerowave	   endif	endif	dest = "Grs_"+dispwave+num2istr(gr)  if (check_V_flag!=1)	textbox/k/n=text0   sprintf descriptor " \\Z16%s ", dest	Textbox/N=Grs /x=-27/y=46/F=0/A=MC descriptor	ModifyGraph noLabel(left)=1	ModifyGraph axOffset(left)=-8	ModifyGraph tick(left)=3,sep(bottom)=2	ModifyGraph mirror=1	ModifyGraph tick(bottom)=2	ModifyGraph minor(bottom)=1	ModifyGraph zero(bottom)=3	ModifyGraph fSize=16	ModifyGraph margin(left)=28	ModifyGraph margin=0	ModifyGraph axOffset(left)=-3.5	Label left "Intensity (arb. units)"	Label bottom "Energy (eV)"	endifEndmacro EfcorrProc2(firstG, lastG, augraph  )	Variable  firstG=last_ff, lastG=last_lf,augraph		EfcorrFun( firstG, lastG, augraph )EndFunction autloadCheck(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar autloadCheckedautloadChecked=checkedEndFunction LoadDataFunc(ctrlName) : ButtonControl	String ctrlName	string  path, filename, LoadOptionlocal	Nvar autloadChecked  svar LastFoldername, LoadOption	if (autloadChecked==0)	  if (stringmatch(LoadOption,"Ames Lab.")==1)	   Prompt LoadOptionlocal, "Load Mode: ", popup ,"Ames Lab."+";Synchrotron"	  else		Prompt LoadOptionlocal, "Load Mode: ", popup  "Ames Lab."+";Synchrotron"	  endif 	  DoPrompt "Load mode setting", LoadOptionlocal		if (V_flag != 0) 		 return -1; // User cancelled.  	  endif   	  LoadOption = LoadOptionlocal 	  newpath/o DataFile   	  		if (V_flag != 0) 		 return -1; // User cancelled.  	  endif   elseif (autloadChecked==1)    LoadOptionlocal = LoadOption  endif  pathinfo DataFile     LastFoldername = StringFromList(ItemsInList(s_path,":")-1, s_path,":")     filename= IndexedFile(DataFile,0,".txt")   if (stringmatch(filename,"")==1)   abort "There is no file!! Select a correct folder."   endif    path=S_path+filename[0,(strlen (filename)-9)]   LoadFileSetFunc (path,S_path, filename, LoadOption)   dowindow/f AutographEnd Function LoadFileSetFunc (path,S_path, filename, LoadOptionlocal)string path,S_path, filename, LoadOptionlocalsvar Goffsetstringstring postfix=".txt", offsetstring, firstfilename, OffsetStrvariable firstG, lastG, offset, i, totaldataNoNVar last_ff, last_lf, Goffset, autloadCheckedNvar lastNorm_ff, lastNorm_lf, GoffsetNorm Nvar lastEF_ff, lastEF_lf, GoffsetEFsvar FolderPathwave map, mapTOffsetStr = "0000"+";1000"+";2000"+";3000"+";4000"+";5000"+";6000"+";7000"+";8000"+";9000"OffsetStr+= ";10000"+";11000"+";12000"+";13000"+";14000"+";15000"+";16000"+";17000"+";18000"+";19000"OffsetStr+= ";20000"+";21000"+";22000"+";23000"+";24000"+";25000"+";26000"+";27000"+";28000"+";29000"OffsetStr+= ";30000"+";31000"+";32000"+";33000"+";34000"+";35000"+";36000"+";37000"+";38000"+";39000"OffsetStr+= ";40000"+";41000"+";42000"+";43000"+";44000"+";45000"+";46000"+";47000"+";48000"+";49000"+";50000" if (autloadChecked==1)    // lastG=inf    totaldataNo = ItemsInList(IndexedFile(DataFile,-1,".txt"))     lastG=str2num(filename[(strlen (filename)-5)])+totaldataNo-1  elseif (autloadChecked!=1) totaldataNo = ItemsInList(IndexedFile(DataFile,-1,".txt")) lastG=str2num(filename[(strlen (filename)-5)])+totaldataNo-1endiffirstG=last_lf; offset=Goffset; offsetstring=Goffsetstringif (stringmatch(S_path,FolderPath)!=1)  firstfilename = Indexedfile(DataFile,0,".txt")  firstG=str2num(firstfilename[(strlen (firstfilename)-5)])  FolderPath=S_pathendifif (autloadChecked==0)  Prompt firstG "Start No.: "  Prompt lastG, "End No.: "    Prompt offsetstring, "Graph offset: ", popup , OffsetStr  Doprompt "Load Data Number", offsetstring,firstG, lastG  if (V_Flag)   return -1  endif endifoffset=str2num(offsetstring)Goffset=offset ; GoffsetNorm=offset ; GoffsetEF=offsetGoffsetstring=offsetstring  if (map[0][0] < Goffset+1000)   Redimension/N=(Goffset+1000,-1) map   Redimension/N=(Goffset+1000,-1) mapT	 map[0][0]=Goffset+1000// map[2,Goffset+1000-1][0]=1 endif // if (stringmatch(LoadOptionlocal,"Synchrotron")==1)//  		  LoadSynchFunc ( path, postfix,firstG, lastG,offset)// endif//  if  (stringmatch(LoadOptionlocal,"Ames Lab.")==1)// 		  LoadAmesFunc ( path, postfix,firstG, lastG,offset)//  endif	LoadFunc (LoadOptionlocal,path, postfix,firstG, lastG,offset)last_ff=firstG ; lastNorm_ff=firstG ; lastEF_ff=firstGendFunction LoadFunc (LoadOptionlocal, path, postfix, firstG , lastG, offset)  string LoadOptionlocal	String path, postfix	Variable firstG, lastG, offset  Nvar last_lf, autloadChecked, lastNorm_lf, lastEF_lf, stopLoad	String  theGraph, thewavex, thewavey, grx, logtext,logtext_All,Logname, Logname_All	Variable WNum, GNum, i, i_updated, i_initial, logstart=0, Goffset, progressRate	string  filepathname, Goffstring, firstfilename, filename, infowave	svar Lastpathinfo, lastfoldername, lastgr  WAVE map, GrAllNum  wave/t mapt  Logname="LogG"+num2istr(offset)  if (offset==0)   	Logname+="000"  endif  Logname_All="LogG_All"    DoWindow/F $Logname	 if (V_flag == 0)		     NewNotebook/W=(30,30,1000,200) /F=0/N=$Logname/V=1     Notebook $Logname fSize=12   endif     firstfilename = Indexedfile(DataFile,0,".txt")  i_initial=str2num(firstfilename[(strlen (firstfilename)-5)])   i_updated=firstG-i_initial     ////////// progreee bar    	Dowindow/f ProgressPanel  	if (V_flag!=1)    NewPanel/K=1 /N=ProgressPanel /W=(542,547,996,629)    endif    ValDisplay valdisp0,pos={18,32},size={342,18}    ValDisplay valdisp0,limits={0,100,0},barmisc={0,0}    ValDisplay valdisp0,value= _NUM:0    ValDisplay valdisp0,mode= 3  // bar with no fractional part    ValDisplay valdisp0,highColor=(0,65535,0)    Button bStop,pos={375,32},size={50,20},proc=stopLoadFunc,title="Stop" //   DoUpdate /W=ProgressPanel /E=1 // mark this as our progress window	for ( GNum=firstG; GNum <= LastG; GNum+=1 )		if ( GNum<10 ) 				theGraph = path+"000" 				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "000" +num2istr(GNum)+postfix		elseif ( GNum < 100 )				theGraph = path + "00"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "00" +num2istr(GNum)+postfix	   elseif ( GNum < 1000 )				theGraph = path + "0"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "0" +num2istr(GNum)+postfix		else			theGraph = path					filename=firstfilename[0,(strlen (firstfilename)-9)]+num2istr(GNum)+postfix		endif 		theGraph+= num2istr(GNum)+postfix		for (i=i_updated; stringmatch (filename,indexedfile(DataFile,i,".txt"))!=1 ; i+=1)		 if  (stringmatch (indexedfile(DataFile,i,".txt"),"")==1)		 	Goffstring="G"+num2istr(offset)	    if (offset==0)	      Goffstring+="000"	    endif				   logtext = "**************** Load END of "+Goffstring+" ****************\r\r"	    Notebook $Logname  text=logtext  	  string/g $Goffstring	    Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldername	      if (autloadChecked==1)	     	 return -1	      else	      	KillWindow ProgressPanel		     	abort "There is no file of No. " + num2istr(GNum)+" !!"		    endif		  endif		  i_updated=i+1		 endforif (stringmatch(LoadOptionlocal,"Synchrotron")==1) 	 LoadWave/G/M/D/Q/N=loadMat/L={0,0,0,1,0} theGraph    if (v_flag == 0)       break    endif		LoadWave/G/M/D/Q/N=laodX/L={0,0,0,0,1} theGraph		filepathname = theGraph		loadwave/j/q/k=2/n=loadInfo theGraph   	theGraph = "gr"+num2istr(Gnum+offset)		grx = "gx"+num2istr(Gnum+offset)			make/o/n=(dimsize(laodX0,0)) temp		duplicate/o laodX0 temp1		temp[] = temp1[p][0]		duplicate/o temp $grx		killwaves/Z laodX0  				duplicate/o loadMat0 temp1		WNum = dimsize(temp1,1)	 GetInfofuncSynch(Gnum, offset)   if(wnum > 1)			duplicate/o loadMat0 $theGraph   elseif (wnum == 1)      make /o/n=(dimsize(temp1,0)) temp      temp[]=	temp1[p]     duplicate/o temp $theGraph   endif   killwaves/Z  loadMat0endif      if (stringmatch(LoadOptionlocal,"Ames Lab.")==1) 		 LoadWave/G/M/D/Q/N=loadMat/L={0,0,0,0,0} theGraph		 duplicate/o loadMat1 temp    if (v_flag < 2 )       break    endif		//LoadWave/G/M/D/Q/N=laodX/L={0,0,0,0,1} theGraph		filepathname = theGraph		loadwave/j/q/k=2/n=loadInfo theGraph   	theGraph = "gr"+num2istr(Gnum+offset)		grx = "gx"+num2istr(Gnum+offset)		make/o/n=(dimsize(temp,0)) temp1		temp1[]=temp[p][0]		duplicate/o temp1 $grx		//killwaves/Z loadX0,laodX1  		WNum = dimsize(temp,1)-1	 GetInfofuncAmes(Gnum, offset)   if(wnum > 1)       make/o/n=(dimsize(temp,0),dimsize(temp,1)-1) temp1       temp1[][]=temp[p][q+1]       duplicate/o temp1 $theGraph			//duplicate/o loadMat1 $theGraph	 elseif (wnum == 1)      make /o/n=(dimsize(temp1,0)) temp1      temp1[]=	temp[p][1]     duplicate/o temp1 $theGraph   endif   killwaves/Z  loadMat0, loadMat1endif        notebook $Logname selection={startOfFile, startOfFile}    do      notebook $Logname findText={theGraph+" ", 0}     if (V_flag==1)     Notebook $Logname  text="updated"     endif    while (V_flag==1)     notebook $Logname selection={endoffile, endoffile}    if ( GNum==0 ||  GNum==1 && logstart==0)     logtext ="////////////////////  "+"Wavename"+" ,  "+"Slice numbers"+" ,  "+ "Sweep times" +" ,  "+"Path of data"+"  ////////////////////"+"\r"	   Notebook $Logname  text=logtext	   logstart+=1	 endif   logtext =theGraph+" ,  "+mapt[Gnum+offset][4]+" slices ,  "+ mapt[Gnum+offset][2]+" times ,  "+filepathname+"\r"	Notebook $Logname  text=logtext		if (GrAllNum[offset/1000]<GNum)		GrAllNum[offset/1000]=GNum		endif		last_lf=GNum; lastNorm_lf=GNum; lastEF_lf=GNum		lastgr = theGraph		progressRate = ((GNum+1-firstG)/(lastG+1-firstG)*100)		ValDisplay valdisp0,value= _NUM:progressRate ,win=ProgressPanel	//	print progressRate    DoUpdate /W=ProgressPanel      if(stopLoad == 1)         stopLoad=0         break    endif  endfor	if(map[0][0]<Gnum-1)	map[0][0] = Gnum-1+offset	endif		Goffstring="G"+num2istr(offset)	if (offset==0)	 Goffstring+="000"	endif   logtext = "**************** Load END of "+Goffstring+" ****************\r\r"	Notebook $Logname  text=logtext	string/g $Goffstring	Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldername		logtext ="////////////////////    "+"Goffset :   "+"Folder Name    ////////////////////"+"\r"	//   Notebook $Logname  text=logtext	logtext_All = Goffstring + " :   " +lastfoldername+"\r"   DoWindow $Logname_All   if (V_flag == 0)		     NewNotebook/W=(30,30,500,400) /F=0/N=$Logname_All/V=0     Notebook $Logname_All fSize=12     Notebook $Logname_All  text=logtext   endif     notebook $Logname_All selection={startOfFile, startOfFile}    do      notebook $Logname_All findText={Goffstring, 0}     if (V_flag==1)     notebook $Logname_All selection={startOfParagraph,endOfParagraph}     Notebook $Logname_All  text=logtext_All     else          notebook $Logname_All selection={(1,0), (1,0)}          Goffset=0          do            	Goffstring="G"+num2istr(Goffset)          	if (offset==0)	             Goffstring+="000"	          endif           notebook $Logname_All findText={Goffstring,0}           if (V_flag==1)             notebook $Logname_All selection={startOfNextParagraph,startOfNextParagraph}           endif           Goffset+=1000           while (Goffset<offset|| V_flag==1)    		  				 Notebook $Logname_All  text=logtext_All  				 notebook $Logname_All selection={endoffile, endoffile}   			  	 endif   while (V_flag==1)     		Variable t0= ticks		do			DoUpdate /W=ProgressPanel  		while( ticks < (t0+10) )				KillWindow ProgressPanelEndFunction stopLoadFunc (ctrlName) : ButtonControl	String ctrlName Nvar stopLoad	stopLoad=1EndFunction LoadSynchFunc (path, postfix, firstG , lastG, offset)	String path, postfix	Variable firstG, lastG, offset  Nvar last_lf, autloadChecked, lastNorm_lf, lastEF_lf	String  theGraph, thewavex, thewavey, grx, logtext, Logname 	Variable WNum, GNum, i, i_updated, i_initial, logstart=0	string  filepathname, Goffstring, firstfilename, filename, infowave	svar Lastpathinfo, lastfoldername, lastgr  WAVE map, GrAllNum  wave/t mapt  Logname="LogG"+num2istr(offset)  if (offset==0)  Logname+="000"  endif   firstfilename = Indexedfile(DataFile,0,".txt")  i_initial=str2num(firstfilename[(strlen (firstfilename)-5)])   i_updated=firstG-i_initial	for ( GNum=firstG; GNum <= LastG; GNum+=1 )		if ( GNum<10 ) 				theGraph = path+"000" 				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "000" +num2istr(GNum)+postfix		elseif ( GNum < 100 )				theGraph = path + "00"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "00" +num2istr(GNum)+postfix	   elseif ( GNum < 1000 )				theGraph = path + "0"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "0" +num2istr(GNum)+postfix		else			theGraph = path					filename=firstfilename[0,(strlen (firstfilename)-9)]+num2istr(GNum)+postfix		endif 		theGraph+= num2istr(GNum)+postfix		for (i=i_updated; stringmatch (filename,indexedfile(DataFile,i,".txt"))!=1 ; i+=1)		 if  (stringmatch (indexedfile(DataFile,i,".txt"),"")==1)		 	  logtext = "**************** Load END of Goffset "+num2istr(offset)+" ****************\r\r"	    Notebook $Logname  text=logtext	    Goffstring="G"+num2istr(offset)	    if (offset==0)	   Goffstring+="000"	   endif	  string/g $Goffstring	  Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldername	      if (autloadChecked==1)	      return -1	      else	        		     abort "There is no file of No. " + num2istr(GNum)+" !!"		   endif		  endif		  i_updated=i+1		 endfor		 LoadWave/G/M/D/Q/N=loadMat/L={0,0,0,1,0} theGraph    if (v_flag == 0)       break    endif		LoadWave/G/M/D/Q/N=laodX/L={0,0,0,0,1} theGraph		filepathname = theGraph		loadwave/j/q/k=2/n=loadInfo theGraph   	theGraph = "gr"+num2istr(Gnum+offset)		grx = "gx"+num2istr(Gnum+offset)			make/o/n=(dimsize(laodX0,0)) temp		duplicate/o laodX0 temp1		temp[] = temp1[p][0]		duplicate/o temp $grx		killwaves/Z laodX0  				duplicate/o loadMat0 temp1		WNum = dimsize(temp1,1)	 GetInfofuncSynch(Gnum, offset)   if(wnum > 1)			duplicate/o loadMat0 $theGraph   elseif (wnum == 1)      make /o/n=(dimsize(temp1,0)) temp      temp[]=	temp1[p]     duplicate/o temp $theGraph   endif   killwaves/Z  loadMat0   	DoWindow/F $Logname	if (V_flag == 0)		     NewNotebook/W=(30,30,1000,200) /F=0/N=$Logname/V=1   endif   notebook $Logname selection={startOfFile, startOfFile}    do      notebook $Logname findText={theGraph+" ", 0}     if (V_flag==1)     Notebook $Logname  text="updated"     endif    while (V_flag==1)   Notebook $Logname fSize=12   notebook $Logname selection={endoffile, endoffile}    if ( GNum==0 ||  GNum==1 && logstart==0)     logtext ="////////////////////  "+"Wavename"+" ,  "+"Slice numbers"+" ,  "+ "Sweep times" +" ,  "+"Path of data"+"  ////////////////////"+"\r"	   Notebook $Logname  text=logtext	   logstart+=1	 endif   logtext = theGraph+" ,  "+mapt[Gnum+offset][4]+" slices ,  "+ mapt[Gnum+offset][2]+" times ,  "+filepathname+"\r"	Notebook $Logname  text=logtext		if (GrAllNum[offset/1000]<GNum)		GrAllNum[offset/1000]=GNum		endif		last_lf=GNum; lastNorm_lf=GNum; lastEF_lf=GNum		lastgr = theGraphendfor	if(map[0][0]<Gnum-1)	map[0][0] = Gnum-1+offset	endif	Notebook $Logname fSize=12   logtext = "**************** Load END of Goffset "+num2istr(offset)+" ****************\r\r"	Notebook $Logname  text=logtext	Goffstring="G"+num2istr(offset)	if (offset==0)	 Goffstring+="000"	endif	string/g $Goffstring	Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldernameEndFunction LoadAmesFunc (path, postfix, firstG , lastG, offset)	String path, postfix	Variable firstG, lastG, offset  Nvar last_lf, autloadChecked, lastNorm_lf, lastEF_lf	String  theGraph, thewavex, thewavey, grx, logtext,logtext_All,Logname, Logname_All	Variable WNum, GNum, i, i_updated, i_initial, logstart=0, Goffset	string  filepathname, Goffstring, firstfilename, filename, infowave	svar Lastpathinfo, lastfoldername, lastgr  WAVE map, GrAllNum  wave/t mapt  Logname="LogG"+num2istr(offset)  if (offset==0)   	Logname+="000"  endif  Logname_All="LogG_All"  firstfilename = Indexedfile(DataFile,0,".txt")  i_initial=str2num(firstfilename[(strlen (firstfilename)-5)])   i_updated=firstG-i_initial	for ( GNum=firstG; GNum <= LastG; GNum+=1 )		if ( GNum<10 ) 				theGraph = path+"000" 				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "000" +num2istr(GNum)+postfix		elseif ( GNum < 100 )				theGraph = path + "00"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "00" +num2istr(GNum)+postfix	   elseif ( GNum < 1000 )				theGraph = path + "0"				filename=firstfilename[0,(strlen (firstfilename)-9)]+ "0" +num2istr(GNum)+postfix		else			theGraph = path					filename=firstfilename[0,(strlen (firstfilename)-9)]+num2istr(GNum)+postfix		endif 		theGraph+= num2istr(GNum)+postfix		for (i=i_updated; stringmatch (filename,indexedfile(DataFile,i,".txt"))!=1 ; i+=1)		 if  (stringmatch (indexedfile(DataFile,i,".txt"),"")==1)		 	Goffstring="G"+num2istr(offset)	    if (offset==0)	      Goffstring+="000"	    endif				   logtext = "**************** Load END of "+Goffstring+" ****************\r\r"	    Notebook $Logname  text=logtext  	  string/g $Goffstring	    Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldername	      if (autloadChecked==1)	      return -1	      else	      		     abort "There is no file of No. " + num2istr(GNum)+" !!"		   endif		  endif		  i_updated=i+1		 endfor		 		 LoadWave/G/M/D/Q/N=loadMat/L={0,0,0,0,0} theGraph		 duplicate/o loadMat1 temp    if (v_flag < 2 )       break    endif		//LoadWave/G/M/D/Q/N=laodX/L={0,0,0,0,1} theGraph		filepathname = theGraph		loadwave/j/q/k=2/n=loadInfo theGraph   	theGraph = "gr"+num2istr(Gnum+offset)		grx = "gx"+num2istr(Gnum+offset)		make/o/n=(dimsize(temp,0)) temp1		temp1[]=temp[p][0]		duplicate/o temp1 $grx		//killwaves/Z loadX0,laodX1  		WNum = dimsize(temp,1)-1	 GetInfofuncAmes(Gnum, offset)   if(wnum > 1)       make/o/n=(dimsize(temp,0),dimsize(temp,1)-1) temp1       temp1[][]=temp[p][q+1]       duplicate/o temp1 $theGraph			//duplicate/o loadMat1 $theGraph	 elseif (wnum == 1)      make /o/n=(dimsize(temp1,0)) temp1      temp1[]=	temp[p][1]     duplicate/o temp1 $theGraph   endif   killwaves/Z  loadMat0, loadMat1   		DoWindow/F $Logname	 if (V_flag == 0)		     NewNotebook/W=(30,30,1000,200) /F=0/N=$Logname/V=1     Notebook $Logname fSize=12   endif   notebook $Logname selection={startOfFile, startOfFile}    do      notebook $Logname findText={theGraph+" ", 0}     if (V_flag==1)     Notebook $Logname  text="updated"     endif    while (V_flag==1)     notebook $Logname selection={endoffile, endoffile}    if ( GNum==0 ||  GNum==1 && logstart==0)     logtext ="////////////////////  "+"Wavename"+" ,  "+"Slice numbers"+" ,  "+ "Sweep times" +" ,  "+"Path of data"+"  ////////////////////"+"\r"	   Notebook $Logname  text=logtext	   logstart+=1	 endif   logtext =theGraph+" ,  "+mapt[Gnum+offset][4]+" slices ,  "+ mapt[Gnum+offset][2]+" times ,  "+filepathname+"\r"	Notebook $Logname  text=logtext		if (GrAllNum[offset/1000]<GNum)		GrAllNum[offset/1000]=GNum		endif		last_lf=GNum; lastNorm_lf=GNum; lastEF_lf=GNum		lastgr = theGraphendfor	if(map[0][0]<Gnum-1)	map[0][0] = Gnum-1+offset	endif	Goffstring="G"+num2istr(offset)	if (offset==0)	 Goffstring+="000"	endif   logtext = "**************** Load END of "+Goffstring+" ****************\r\r"	Notebook $Logname  text=logtext	string/g $Goffstring	Lastpathinfo = lastgr + " , " + Goffstring + " , " + lastfoldername			logtext ="////////////////////    "+"Goffset :   "+"Folder Name    ////////////////////"+"\r"	   Notebook $Logname  text=logtext	logtext_All = Goffstring + " :   " +lastfoldername+"\r"   DoWindow $Logname_All   if (V_flag == 0)		     NewNotebook/W=(30,30,500,400) /F=0/N=$Logname_All/V=0     Notebook $Logname_All fSize=12     Notebook $Logname_All  text=logtext   endif     notebook $Logname_All selection={startOfFile, startOfFile}    do      notebook $Logname_All findText={Goffstring, 0}     if (V_flag==1)     notebook $Logname_All selection={startOfParagraph,endOfParagraph}     Notebook $Logname_All  text=logtext_All     else          notebook $Logname_All selection={(1,0), (1,0)}          Goffset=0          do            	Goffstring="G"+num2istr(Goffset)          	if (offset==0)	             Goffstring+="000"	          endif           notebook $Logname_All findText={Goffstring,0}           if (V_flag==1)             notebook $Logname_All selection={startOfNextParagraph,startOfNextParagraph}           endif           Goffset+=1000           while (Goffset<offset|| V_flag==1)    		  				 Notebook $Logname_All  text=logtext_All  				 notebook $Logname_All selection={endoffile, endoffile}   			  	 endif   while (V_flag==1)  EndFunction InputInformation ()nvar goffsetsvar DateInfostr, SampleInfostr, SweepInfostr, PassEInfostr, SliceInfostr, dispwavesvar LowEInfostr, HighEInfostr, EStepstr, FolderInfostr, TimeInfostr, TotalGInfostr, GraphNoInfostrsvar TempInfostr, XInfostr, YInfostr, ZInfostr, ThetaInfostr,TiltInfostr,PsiInfostrwave/t maptwave grallnumnvar scope_graph, Goffvalue if ( stringmatch(dispwave,"cr")==1)    GraphNoInfostr = ""   SampleInfostr = ""	DateInfostr = ""	SweepInfostr = ""	PassEInfostr = ""	SliceInfostr = ""	LowEInfostr = ""	HighEInfostr = ""	EStepstr = ""	TimeInfostr = ""	TempInfostr = ""	XInfostr = ""	YInfostr = ""	ZInfostr = ""	ThetaInfostr = ""	TiltInfostr= ""	PsiInfostr= ""	TotalGInfostr = ""	FolderInfostr = ""   else  	GraphNoInfostr = num2str(scope_graph)   	SampleInfostr = mapt[scope_graph][0]	DateInfostr = mapt[scope_graph][1]	SweepInfostr = mapt[scope_graph][2]+" times"	PassEInfostr = mapt[scope_graph][3]+" eV"	SliceInfostr = mapt[scope_graph][4]+" slices"	LowEInfostr = mapt[scope_graph][5]+" eV"	HighEInfostr = mapt[scope_graph][6]+" eV"	EStepstr = num2str(str2num(mapt[scope_graph][7])*1000)+" meV"	TimeInfostr = mapt[scope_graph][8]		TempInfostr = mapt[scope_graph][9]+" K"	XInfostr = mapt[scope_graph][10]	YInfostr = mapt[scope_graph][11]	ZInfostr = mapt[scope_graph][12]	ThetaInfostr = mapt[scope_graph][13]+" deg"	TiltInfostr = mapt[scope_graph][14]+" deg"	PsiInfostr = mapt[scope_graph][15]+" deg"	TotalGInfostr = num2str(Goffvalue+grallnum[Goffvalue/1000])	FolderInfostr = mapt[scope_graph][19]endifendFunction GetInfofuncSynch (Gnum, offset)variable Gnum, offsetwave/t loadInfo0string infowavevariable i,n, startNostring  resultsvar LastFoldernamewave temp1wave/t mapt mapt[0][0]="Sample" mapt[0][1]="Date" mapt[0][2]="Number of Sweeps" mapt[0][3]="Pass Energy" mapt[0][4]="Number of Slices" mapt[0][5]="Low Energy" mapt[0][6]="High Energy" mapt[0][7]="Energy Step" mapt[0][8]="Time"  mapt[0][9]="Temp (K)" mapt[0][10]="X" mapt[0][11]="Y" mapt[0][12]="Z" mapt[0][13]="Theta (deg)" mapt[0][14]="hv (eV)"  mapt[0][19]="Folder name" mapt[Gnum+offset][19] = LastFoldernamefor (n=0 ; n<=8 ; n+=1)  for (i=0; i<dimsize(temp1,0); i+=1)   if (strsearch(loadInfo0[i], mapt[0][n], 0)!=-1)     break   endif  endfor  startNo = strsearch(loadInfo0[i], mapt[0][n], 0)+strlen(mapt[0][n])  result= (loadInfo0[i])[startNo+1,strlen(loadInfo0[i])]  mapt[Gnum+offset][n] = resultendforkillwaves loadInfo0endFunction GetInfofuncAmes (Gnum, offset)variable Gnum, offsetwave/t loadInfo0string infowavevariable i,n, startNostring  resultsvar LastFoldernamewave temp1, loadMat0, mapwave/t mapt mapt[0][0]="Sample" mapt[0][1]="Date" mapt[0][2]="Number of Sweeps" mapt[0][3]="Pass Energy" mapt[0][4]="Number of Slices" mapt[0][5]="Low Energy" mapt[0][6]="High Energy" mapt[0][7]="Energy Step" mapt[0][8]="Time"  mapt[0][9]="Temp (K)" mapt[0][10]="X" mapt[0][11]="Y" mapt[0][12]="Z" mapt[0][13]="Theta (deg)" mapt[0][14]="Tilt (deg)" mapt[0][15]="Psi (deg)" mapt[0][16]="hv (eV)"  mapt[0][19]="Folder name" mapt[Gnum+offset][19] = LastFoldername for (n=0 ; n<=8 ; n+=1)  for (i=0; i<dimsize(temp1,0); i+=1)   if (strsearch(loadInfo0[i], mapt[0][n], 0)!=-1)     break   endif  endfor  startNo = strsearch(loadInfo0[i], mapt[0][n], 0)+strlen(mapt[0][n])  result= (loadInfo0[i])[startNo+1,strlen(loadInfo0[i])]  mapt[Gnum+offset][n] = resultendfor//Only for Ames file  mapt[Gnum+offset][9] = num2str(loadMat0[1][0])	;	map[Gnum+offset][2] = loadMat0[1][0]	// Temp info  mapt[Gnum+offset][10] = num2str(loadMat0[2][0])	;	map[Gnum+offset][3] = loadMat0[2][0]	// X info  mapt[Gnum+offset][11] = num2str(loadMat0[3][0])	;	map[Gnum+offset][4] = loadMat0[3][0]	// Y info  mapt[Gnum+offset][12] = num2str(loadMat0[4][0])	;	map[Gnum+offset][5] = loadMat0[4][0]	// Z info  mapt[Gnum+offset][13] = num2str(loadMat0[5][0])	;	map[Gnum+offset][6] = loadMat0[5][0]	// Theta info  mapt[Gnum+offset][14] = num2str(loadMat0[6][0])	;	map[Gnum+offset][11] = loadMat0[6][0]	// Tilt info  mapt[Gnum+offset][15] = num2str(loadMat0[7][0])	;	 map[Gnum+offset][12] = loadMat0[7][0]	// Psi infokillwaves loadInfo0//edit loadMat0endFunction EF_check (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Svar EFwave	Nvar EFchecked,  scope_graph	string EF="EF", baseMat	baseMat="gr" + num2istr(scope_graph) EFchecked=checked //print EFwave Interpolate2/T=1/N=(dimsize($baseMat,1))/Y=$EF $EFwaveEndFunction change_dispwave (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	//print varName, varStr endFunction Scope_Change2D() 	variable epoints, kpoints, est, kst, de, dk	string gr	variable FWHM	NVAR scope_graph, interp_scope, update_scope, Fermicheck, Auto_FWHM_Convo	string Xaxis	SVAR dispwave, Auto_Yes_No_Convo	WAVE scopex, map	variable eV=1.6*10^-19, kB=1.3807*10^-23, Temperature, Vmax, Vmin	variable sizeX if (update_scope!=1)    if ( ((stringmatch(dispwave,"cr"))) || ((stringmatch(dispwave,"ak"))))    Xaxis = "cx"+num2istr(scope_graph)    else		 Xaxis = "gx"+num2istr(scope_graph)	  endif    duplicate /o $Xaxis scopeX  	    if ((( stringmatch(dispwave,"cr"))==0) && (( stringmatch(dispwave,"ak"))==0))       scopeX -=map[scope_graph][7]    endif endif	gr = dispwave+num2istr(scope_graph)	est = scopex[0]	de = scopex[1]-est	//print "scopex[0]",scopex[0],"scopex[1]",scopex[1], "est", est, "de", de	 if (exists(gr)==0)    		abort "No such a data!!"  	 endif	//dk = 0.22*21/dimsize($gr,1)	//kst = map[scope_graph][6] - floor(dimsize($gr,1)/2)*dk	 if (dimsize($gr,1)==0)	 make/o/n=(50,50) akw2d	 akw2d = 100 	 else    	if ( interp_scope > 1 )		  ImageInterpolate /f={1,interp_scope} bilinear $gr		  duplicate/o M_InterpolatedImage akw2d		  dk /= interp_scope	    else		 duplicate/o $gr akw2d	  endif	  	SetScale/P x est,de,"", akw2d//	   SetScale/P y kst,dk,"", akw2d	endif	dowindow Graph_Image  if (V_flag==1)	 if (Fermicheck==1)		  ImageStats/M=1 akw2d    		Vmax = V_max    		Vmin = V_min	 	 Temperature = map[scope_graph][2]	  //Temperature = map[scope_graph][0]	 	sizeX=dimsize(akw2d,0)	 	make/o/n=(sizeX) temp1, temp2	 	 temp2[]=pnt2x(akw2d,p)	 	 if (stringmatch(Auto_Yes_No_Convo,"Yes"))	 		makeFermiConvoWave (temp1,temp2,Temperature)	  	elseif (stringmatch(Auto_Yes_No_Convo,"No"))	    		temp1[]=1 / ( 1 + exp(temp2[p]/(kB*Temperature/eV) ) )	 	endif	 	akw2d[][] /= temp1[p]	  ModifyImage/w=Graph_Image akw2d ctab= {Vmin,Vmax,Rainbow,1}	 endif  endifEndFunction makeFermiConvoWave (temp1,temp2,T)	wave temp1,temp2	Variable T	Nvar Auto_FWHM_Convo	variable E_i=-0.35, E_f=0.35, dE=0.0005, E, i=0, MaxVal	variable dx, x, ValConvo	Variable Gau,fermi	variable eV=1.6*10^-19	variable KB=1.38*10^-23	variable C=2*(2*ln(2))^0.5	 make/o/n=( (E_f-E_i)/dE+1) ConvoFermi_X, ConvoFermi_Y   ConvoFermi_X=0; ConvoFermi_Y=0   ConvoFermi_X=E_i+dE*p   dx=(Auto_FWHM_Convo/1000)*3	 for (E=E_i ; E<=E_f ; E+=dE)    ValConvo = 0   		for (x=E-dx; x<=E+dx; x+=dE)	 	 					fermi=1/(1+exp(x/(KB*T/eV)))	 					Gau=exp(-(E-x)^2/(2*(Auto_FWHM_Convo/1000/C)^2))	 					ValConvo+=fermi*Gau	   		endfor   			ConvoFermi_Y[i] = ValConvo      	i+=1	 endfor			MaxVal = ConvoFermi_Y[0]			ConvoFermi_Y[] /= MaxVal			temp1[]=interp(temp2[p], ConvoFermi_X, ConvoFermi_Y )End    Function ScopeButton_Show2d(ctrlName) : ButtonControl	String ctrlName	Scope_Change2D()	dowindow/f Graph_Image	if (V_flag!=1)	Display /W=(5,42,377,293)	dowindow/c Graph_Image   AppendImage akw2d	 ModifyGraph swapXY=1	 ModifyImage akw2d ctab= {*,*,Rainbow,1}	 ModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdate     Label bottom "Slice";DelayUpdate               Label left "Energy (eV)"     endif     svar dispwave     if(stringmatch(dispwave, "Ek"))     Label bottom "Momentum (A\\S-1\\M)"     else     Label bottom "Slice"     endif//	Textbox/N=text0/F=0/A=MC/X=-20.00/Y=46.00 " \r Graph 80 T=0K hv=0 Angle=(0,0)"EndFunction ScopeButton_CheckScope(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR update_scope	update_scope = checkedEndFunction ScopeButton_CheckOffset(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR diffe_offset	diffe_offset = checkedEndFunction ScopeButton_Check2D(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR update_2d	update_2d = checkedEndProc ScopeButton_make(ctrlName) : ButtonControl	String ctrlName	string thesweep	sweep_desc[sweepNo] = sweep_title	thesweep = "sweep"+num2istr(sweepNo)	makebz( $thesweep )	createslicer srcwave=bzEndMacroFunction ScopeButton_ChangeScopeParam(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	ChangeScope()EndFunction ScopeButton_mean (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar scope_mean, scope_add, Old_scope_addif (stringmatch(WinName(0, 1),"Graph_scope")!=1)  DoWindow /f  graph_scopeelse   DoWindow graph_scopeendifif (V_flag!=1)	scope_add = Old_scope_addendifif (scope_add>1 && scope_mean > 1)	 if (V_flag==1)	 Old_scope_add = scope_add	scope_add =1	 setRange_appendFunc () 	  ChangeScope()	  ScopeButton_offset("",0,"","")	  OLd_scope_add = 1	endifelse	ChangeScope()endifEndFunction ScopeButton_Setsweep(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	NVAR sweepNo	SVAR sweep_title	WAVE/T sweep_desc	sweep_title = sweep_desc[sweepNo]EndProc ScopeButton_surf(ctrlName) : ButtonControl	String ctrlName	variable fwave,lwave	CreateSurfer	ModifySurfer srcWave=akw2d, srcType=1,update=1EndProc ScopeButton_diff(ctrlName) : ButtonControl	String ctrlName	string back	variable offs	back = "backgr"+num2istr(scope_graph)//	scope0-=$back	offs = scope0[xcsr(b)]//	scope0-=offs	smooth 10,scope0	wavestats /q scope0	scope0/=V_max	findlevels /b=5 /q scope0,0.5	//print scopex[W_findlevels[0]]-scopex[w_findlevels[1]]EndMacroFunction scopeButton_norm(ctrlName) : ButtonControl	String ctrlName	variable i, norm	string source	wave akw2d	NVAR  scope_angle, scope_range, scope_graph	DoWindow /f Graph_Scope	if ( V_Flag == 0 )		Abort "display the scope first and use\r Cursor A and B to define the norm-range"	endif	make /o /n=(GetGraphDim(scope_graph,0)) temp		for ( i=0; i<scope_range; i+=1 )		source = "scope"+num2istr(i)	//	print source		duplicate /o $source temp		norm = faverage(temp,xcsr(a),xcsr(b))		temp /= norm		duplicate /o temp $source		akw2d[][i]=temp[p]	endforEndFunction ScopeButton_offset (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Variable i,offs,diff, diff2	String dest,dest1,dest2	svar dispwave	wave scopex, temp1, temp2, temp0	NVAR scope_offs, scope_range, update_offset, diffe_offset, doffs, scope_add	offs = 0	//if (stringmatch(winname(0,1),"graph_scope")!=1)//	dowindow/f graph_scope	//endif	dowindow graph_scope	if (diffe_offset==1)//	for ( i=0; i<ceil(scope_range/scope_add); i+=1 )	for ( i=ceil(scope_range/scope_add)-1; i>=0; i-=1 )	  dest2 = "scope"+num2istr(i) 		dest1 = "scope"+num2istr(abs(i+1))	  duplicate/o  $dest1,temp1	  duplicate/o  $dest2,temp2	   duplicate/o  temp2,temp0	  temp0=temp2[p]-temp1[p]		wavestats/Q temp0		diff2=v_min		//print i , v_min		offs += scope_offs-diff2		ModifyGraph/w=Graph_scope offset($dest2)={0,offs}	endfor	else	for ( i=0; i<ceil(scope_range/scope_add); i+=1 )	  dest = "scope"+num2istr(i)  		ModifyGraph/w=Graph_scope offset($dest)={0,offs}		offs += scope_offs	endfor	endifEndFunction ScopeButton_offset_diff(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Variable i,offs,diff,diff1,diff2	String dest1,dest2		NVAR scope_offs, scope_range, update_offset   wave temp1, temp2	offs = 0	for ( i=0; i<scope_range; i+=1 )				dest2 = "scope"+num2istr(i) 		dest1 = "scope"+num2istr(i-1)	  duplicate/o  $dest1,temp1	  duplicate/o  $dest2,temp2	  temp1-=temp2		wavestats/Q temp1		diff2=v_min		ModifyGraph offset($dest1)={0,offs}		offs += scope_offs+diff	endfor//	print 1EndFunction Scopebutton_gbackgr(ctrlName) : ButtonControl	String ctrlName	string dest	NVAR scope_graph	dest = "backgr"+num2istr(scope_graph)	duplicate /o scope0 $dest	smooth 20, $destEndProc Scopebutton_Sbackgr(ctrlName) : ButtonControl	String ctrlName	variable i, start, kpoints	string dest, source	source = "backgr"+num2istr(scope_graph)	for ( i=0; i<scope_range; i+=1 )		dest	 = "scope"+num2istr(i)		$dest -= $source	endforEndMacroFunction Scopebutton_fermi (ctrlName) : ButtonControl	String ctrlName	variable i, start, kpoints, epoints, avrg, T	variable eV=1.6*10^-19   variable KB=1.38*10^-23, Yoffset	string source, destp, destw, base, fitresult, panelname, paneltext, BottomLabel, BottomNumstr	variable x1,x2	svar dispwave, FermiPassageStr	NVAR scope_graph, scope_range, scope_angle, scope_offs, scope_add, Convo_Check, T_convo	WAVE scopex, map, w_coef, w_sigma, wFermi   base=dispwave+num2istr(scope_graph)   kpoints=dimsize($base,1)   scope_angle=0   scope_range=kpoints   ChangeScope()	dowindow /f Graph_Scope	if ( V_Flag == 0 )		Abort "Display the Graph_Scope first and use \rCursor A and B to define the fitting range"	endif if (stringmatch(CsrWave(a,"Graph_Scope"),"") || stringmatch(CsrWave(b,"Graph_Scope"),""))       Abort "Set A and B cursors!!"  endif  	if (scope_add > 1)       Abort "Set Add = 1 !!"  endif	epoints = dimsize(scopex,0)		if (Convo_Check==0)		destp = "aup"+num2istr(scope_graph)		destw = "auw"+num2istr(scope_graph)	elseif (Convo_Check==1)	  destp = "aup"+num2istr(scope_graph)+"_convo"		destw = "auw"+num2istr(scope_graph)+"_convo"	endif	make /o/d /n=(scope_range)  temp, temp1, $destp, $destw//	make /o /d /n=5 wFermi	source = "scope"+num2istr(round(scope_range/2))		wFermi[1] = 0.005		wFermi[2] = vcsr(a,"Graph_scope")		wFermi[3] = vcsr(b,"Graph_scope")		wFermi[4] = 0		findlevel /q/R= [pcsr(a,"Graph_scope"),pcsr(b,"Graph_scope")] $source,(wFermi[2]+wFermi[3])/2 		wFermi[0] = scopex[V_LevelX]  silent 1; pauseupdate ; if (Convo_Check==1)   		  T_convo=map[scope_graph][2]  		  T=T_convo		    Prompt T, "Temperature(K)"  			Doprompt "Input temperature.", T   			if (V_Flag)   					return -1// User canceled   			endif   			T_convo=T endif  x1=xcsr(a,"Graph_scope") ;x2=xcsr(b,"Graph_scope")  for ( i=0; i<scope_range; i+=1 )		source = "scope"+num2istr(i)		variable /g v_fitoptions=4		if (Convo_Check==0)			FuncFit/q  Fermi wFermi $source(x1,x2) /X=scopeX			FermiPassageStr=num2str(i)+" / "+ num2str(scope_range-1)		elseif (Convo_Check==1)			FuncFit/q  Fermi_convolution wFermi $source(x1,x2) /X=scopeX/D			FermiPassageStr=num2str(i)+" / "+ num2str(scope_range-1)+", FWHM="+num2str(wFermi[1]*1000)+"[meV]"			source = "fit_scope"+num2istr(i)      ModifyGraph rgb($source)=(0,0,65535)      Yoffset=scope_offs*i      ModifyGraph offset($source)={0,Yoffset}		endif		v_fitoptions=0		temp[i+scope_angle]=wFermi[0]		temp1[i+scope_angle]=wFermi[1]  endfor	 temp1*=1	 duplicate /o temp $destp	 duplicate /o temp1 $destw	 panelname = destp+"_panel"	 aup_panel (scope_graph,panelname)EndFunction aup_panel (waveNo,panelname) : Graph   variable waveNo   string panelname   string aup, auw, fit_aup, fit_auw, paneltext1, paneltext2, BottomLabel, BottomNumstr   Nvar Convo_Check    wave map   if (Convo_Check==0) 		  aup = "aup" + num2str(waveNo) 	  	fit_aup = "fit_aup" + num2str(waveNo)   		auw = "auw" + num2str(waveNo)   		fit_auw = "fit_auw" + num2str(waveNo)   		CurveFit/q poly 5,  $aup[0,dimsize($aup,0)-1] /D    		CurveFit/q poly 5,  $auw[0,dimsize($auw,0)-1] /D    		paneltext1="\\Z16"+auw   		paneltext2="\\Z16"+aup   		dowindow/f $panelname   elseif (Convo_Check==1)   		aup = "aup" + num2str(waveNo)+"_convo" 	  	fit_aup = "fit_aup" + num2str(waveNo)+"_convo"   		auw = "auw" + num2str(waveNo)+"_convo"   		fit_auw = "fit_auw" + num2str(waveNo)+"_convo"   		CurveFit/q poly 5,  $aup[0,dimsize($aup,0)-1] /D    		CurveFit/q poly 5,  $auw[0,dimsize($auw,0)-1] /D    		paneltext1="\\Z16"+auw   		paneltext2="\\Z16"+aup   		dowindow/f $panelname   endif  if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(53,69,441,460) $auw,$fit_auw	dowindow/c $panelname	AppendToGraph/L=VertCrossing/B=HorizCrossing $aup,$fit_aup	ModifyGraph mode($auw)=4,mode($aup)=4	ModifyGraph marker($auw)=19,marker($aup)=19	ModifyGraph lSize($fit_auw)=2,lSize($fit_aup)=2	ModifyGraph rgb($auw)=(9,37552,0),rgb($fit_auw)=(0,0,65535),rgb($fit_aup)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-2.57143,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.41}	ModifyGraph axisEnab(VertCrossing)={0.59,1}	TextBox/C/N=auw/F=0/A=MC/X=-39.64/Y=-11.57 paneltext1	TextBox/C/N=aup/F=0/A=MC/X=-39.64/Y=46.59 paneltext2	ModifyGraph standoff=1	endif  if (Convo_Check==0)			Label VertCrossing "Energy (eV)";DelayUpdate  	 sprintf BottomNumstr, "%7.4f", mean($fit_aup,0,dimsize($fit_aup,0)-1)    		BottomLabel = "mean= "+BottomNumstr+" eV, "+"map["+num2istr(waveNo)+"][7]= "+ num2str(map[waveNo][7])+" eV"  	 	Label HorizCrossing BottomLabel       	Label left "dE (eV)";DelayUpdate    	BottomLabel = "mean= "+num2str(mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000)+" meV"+",  4.4*mean= "+num2str(4.4*mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000)+" meV"    	Label bottom BottomLabel        	print aup, "EF =", mean($fit_aup,0,dimsize($fit_aup,0)-1),"eV"    	print auw, "4.4*dE =", 4.4*mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000,"meV"   //  map[waveNo][9]=mean($fit_aup,0,dimsize($fit_aup,0)-1)   		 map[waveNo][9]=mean($fit_aup,0,dimsize($fit_aup,0)-1) + map[waveNo][7]    	map[waveNo][10]=4.4*mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000  elseif (Convo_Check==1)  		Label VertCrossing "Energy (eV)";DelayUpdate  	 sprintf BottomNumstr, "%7.4f", mean($fit_aup,0,dimsize($fit_aup,0)-1)    		BottomLabel = "mean= "+BottomNumstr+" eV, "+"map["+num2istr(waveNo)+"][7]= "+ num2str(map[waveNo][7])+" eV"  	 	Label HorizCrossing BottomLabel       	Label left "FWHM (eV)";DelayUpdate    	BottomLabel = "mean= "+num2str(mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000)+" meV"    	Label bottom BottomLabel        	print aup, "EF =", mean($fit_aup,0,dimsize($fit_aup,0)-1),"eV"    	print auw, "FWHM =", mean($fit_auw,0,dimsize($fit_auw,0)-1)*1000,"meV"   endifEndMacroFunction scopeButton_nk(ctrlName) : ButtonControl	string ctrlName	variable i, grsize	variable a, b	string source, dest	NVAR scope_graph, scope_range, scope_angle	dowindow /f Graph_Scope	if (V_Flag == 0 )		Abort "Display the Scope first and use \rCursor A and B to define the summation range"	endif	grsize = GetGraphDim(scope_graph,1)	a=xcsr(a);b=xcsr(b)	dest = "nk"+num2istr(scope_graph)	make /o /n=(scope_range)  temp	temp = 0	for ( i=0; i<scope_range; i+=1 )		source = "scope"+num2istr(i)		temp[i+scope_angle] = abs(area($source,a,b))	endfor	duplicate /o temp $dest//	dowindow /f nk//	append $dest//	dowindow /f Graph_ScopeEndmacromacro scopebutton_disp1(ctrlname) : ButtonControl	string ctrlname	scope_disp1(47)endmacromacro scope_disp1(startNum)    variable startNum	variable pointa, pointb, wcorr, Y_Offset	variable i=startNum, kpoints, epoints, center	string source, sourceX, ddest1, wdest1, ddest2, wdest2, FIT,name="fit_temp", waveName="coeff"	epoints = GetGraphDim(scope_graph,0)	kpoints = GetGraphDim(scope_graph,1)	source = dispwave+num2istr(scope_graph)	ddest1 = "EDCd"+num2istr(scope_graph)	wdest1 = "EDCw"+num2istr(scope_graph)	make /o /n=(kpoints)  temp1, temp2, temp3, temp4	temp1=nil;temp2=nil;temp3=nil;temp4=nil	//print scope_rangepointa=pcsr(a)pointb=pcsr(b)duplicate /o w w_coefSilent 1; PauseUpdatedo		source = "scope"+num2istr(i)		sourceX = "scopeX"+num2istr(i)		duplicate /o $source temp		duplicate /o $sourceX temp2		//print source, sourceX		 FuncFit/q   GGG1 $waveName temp[pointa,pointb]/D  /X=temp2 /d		 FIT="fit_tem"+num2istr(i)		 duplicate/o $name, $FIT		 AppendToGraph $FIT		ModifyGraph offset($FIT)={0,Y_Offset}		ModifyGraph rgb($FIT)=(1,12815,52428)		FindPeak/q $FIT		//temp1[i+scope_angle]=V_PeakLoc		temp1[i+scope_angle]=$waveName[3]		findlevel /q scopex,$waveName[3]		pointa=round(v_levelx-120*(2/2))		pointb=round(v_levelx+60*(2/2))		//print pointa, pointb, V_PeakLoc		Y_Offset=scope_offs*i     i+=1    // i-=1     duplicate /o temp1 $ddest1while(i<scope_range-1)//while(i>0)Endfunction GGG1(w,x)wave w; variable xreturn (W[0]+W[1]*x+W[2]/((x-W[3])^2+(W[4]/2)^2))endmacro scopebutton_disp2(ctrlname) : ButtonControl	string ctrlname	scope_disp2(240,240,0.5)//	scope_disp("dtl",128,200,.5)endmacromacro scopebutton_disp3(ctrlname) : ButtonControl	string ctrlname	string coefficient="coeff"	string fit_wavename	string wavename="te_linear"	string wavename2="te_fitted"	variable A ,B   A=(vcsr(a)-vcsr(b))/(hcsr(a)-hcsr(b))   B=vcsr(a)-A*hcsr(a)   //print pcsr(A)-pcsr(B)	make/o/n=(abs(pcsr(A)-pcsr(B))) $wavename	make/o/n=10 $coefficient	$wavename=A*scopex(x)+B		AppendToGraph $CsrWave(a) [pcsr(A),pcsr(B)] vs scopeX [pcsr(A),pcsr(B)]	AppendToGraph $wavename [pcsr(A),pcsr(B)] vs scopex[pcsr(A),pcsr(B)]		ModifyGraph mode($wavename)=7,hbFill($wavename)=2;DelayUpdate  ModifyGraph rgb($wavename)=(65535,65535,65535)	 ModifyGraph mode($CsrWave(a)#1)=7,hbFill($CsrWave(a)#1)=12;DelayUpdate   ModifyGraph rgb($CsrWave(a)#1)=(65535,32768,32768)   FuncFit GGG2 $coefficient $CsrWave(a)[pcsr(A),pcsr(B)]/d /x=scopex /d	$wavename2=$coefficient[0]+$coefficient[1]*scopex(x)+$coefficient[2]*exp(-((scopex(x)-$coefficient[3])/$coefficient[4])^2)   fit_wavename="fit_"+CsrWave(a)   ModifyGraph rgb($fit_wavename)=(1,4,52428)   ModifyGraph lsize($fit_wavename)=2   //print area($CsrWave(a),pcsr(A),pcsr(B))-area($wavename,pcsr(A),pcsr(B))   //print area($wavename2,pcsr(A),pcsr(B))-area($wavename,pcsr(A),pcsr(B))endmacromacro de()	FuncFit mdc2 W_coef  buttwave1[pcsr(A),pcsr(B)] /X=buttX1 /D 	dab1[butt_an1]=w_coef[5]	dbb1[butt_an1]=w_coef[2]endmacrofunction GGG2(w,x)wave w; variable xreturn (W[0]+W[1]*x+W[2]/((x-W[3])^2+(W[4]/2)^2))endmacro scope_disp2(pointa,pointb,wcorr) 	variable pointa, pointb, wcorr, Y_Offset, offset=1.3	variable i, kpoints, epoints, center	string source, ddest1, wdest1, ddest2, wdest2, FIT,name="fit_temp", waveName="coeff"	//	NVAR scope_range, scope_graph, scope_angle//	SVAR dispwave//	WAVE w_coef, scopex, nil	epoints = GetGraphDim(scope_graph,0)	kpoints = GetGraphDim(scope_graph,1)	source = dispwave+num2istr(scope_graph)	ddest1 = "edcdffa"+num2istr(scope_graph)	wdest1 = "edcwa"+num2istr(scope_graph)//	ddest2 = "edcd2"+num2istr(scope_graph)//	wdest2 = "edcw2"+num2istr(scope_graph)	make /o /n=(kpoints)  temp1, temp2, temp3, temp4	temp=nil;temp1=nil;temp2=nil;temp3=nil;temp4=nil	//print scope_rangepointa=xcsr(a)pointb=xcsr(b)//duplicate /o gpfit w_coef//	for ( i=0; i<scope_range-1; i+=1 )duplicate /o w w_coefSilent 1; PauseUpdatedo		source = "scope"+num2istr(i)		duplicate /o $source temp		//print source		 FuncFit   GGG2 $waveName temp(pointa,pointb)/d /x=scopex /d		 FIT="fit_tem"+num2istr(i)		 duplicate $name, $FIT		 AppendToGraph $FIT		ModifyGraph offset($FIT)={0,Y_Offset}		ModifyGraph rgb($FIT)=(1,12815,52428)		temp1[i+scope_angle]=$waveName[3]		temp=$waveName[2]*exp(-((scopex(x)-$waveName[3])/$waveName[4])^2)		temp2[i+scope_angle]=area(temp,leftx(temp),rightx(temp))		findlevel /q scopex,$waveName[3]		pointa=round(v_levelx-20)		pointb=round(v_levelx+20)		//print pointa, pointb, $waveName[3]//	endfori+=1Y_Offset=offset*iwhile(i<scope_range-1)	duplicate /o temp1 $ddest1//	duplicate /o temp2 $wdest1//	duplicate /o temp3 $ddest2//	duplicate /o temp4 $wdest2//	dowindow /f disp//	appendtograph $dest//	dowindow /f Graph_ScopeEndFunction scopebutton_width(ctrlName) : ButtonControl	String ctrlName	variable i	string source, dest, back	NVAR scope_graph, scope_range	WAVE scopeX, W_FindLevels		dowindow /f Graph_Scope	if ( V_Flag == 0 )		Abort "Display the Scope first !"	endif	dest = "w"+num2istr(scope_graph)	make /o/d /n=(scope_range) $dest	duplicate /o $dest temp//	back="backgr"+num2istr(scope_graph)//	duplicate /o $back temp2	for ( i=0; i<scope_range; i+=1 )		source = "scope"+num2istr(i)		duplicate /o $source temp1//		print source//		temp1-=$back		smooth 10,temp1		wavestats/q temp1		temp1 /= V_max		findlevels /q temp1,0.5		//print W_findlevels[0],w_findlevels[1]		if ( V_levelsfound==2 )			temp[i] = scopeX[W_findlevels[1]]-scopeX[W_findlevels[0]]		else			temp[i] = 0		endif	endfor	duplicate /o temp $dest	dowindow /f fwhm	if ( V_Flag == 1 )		appendtograph $dest	endif	DoWindow /f AutoGraphEndmacroFunction ScopeButton_SetRange(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	variable kpoints	nvar acope_add, Old_scope_range, scope_range, scope_graph, scope_angle	kpoints = GetGraphDim(scope_graph,1)- scope_angleif (scope_range > kpoints)	 scope_range = kpointsendifif (stringmatch(WinName(0, 1),"Graph_scope")!=1)  DoWindow /f  graph_scopeelse   DoWindow graph_scopeendifif (V_flag!=1)Old_scope_range = scope_rangeendifif (V_flag==1)	if (acope_add > 1)	   addfunc ()	else	setRange_appendFunc ()	ChangeScope()	ScopeButton_offset("",0,"","")	endifendifendFunction  SetRange_appendFunc_begin ()	variable kpoints, nwaves, i	string ScopeWave, ScopeWaveX  SVAR EFwave	NVAR scope_graph, scope_range, Old_scope_range, EFchecked	kpoints = GetGraphDim(scope_graph,1) scope_range = kpoints	if ( scope_range<=0 )		scope_range = 1	endif	if ( scope_range>kpoints )		scope_range = kpoints	endif	getwindow Graph_Scope wavelist	nwaves = dimsize(w_wavelist,0) 	for ( i=0; i<nwaves; i+=1 )		ScopeWave = "scope"+num2istr(i)		removefromgraph /z  $ScopeWave	endfor	for ( i=0; i<scope_range; i+=1 )		ScopeWave = "scope"+num2istr(i)		duplicate /o nil $scopewave		AppendToGraph $ScopeWave vs scopex	endfor	ShowInfo	ShowTools	ModifyGraph tick=2,zero(bottom)=3,mirror=1,minor(bottom)=1,fSize=16,axOffset=0;DelayUpdate  Label left "Intensity (arb. units)";DelayUpdate  Label bottom "Energy (eV)"   ModifyGraph margin(top)=28 SetVariable setvar0,pos={57,5},size={171,15},title=" ",value= scope_title   Old_scope_range = scope_rangeEndFunction  SetRange_appendFunc  ()variable index, i, j	, kpoints, epoints	nvar scope_range, scope_angle, scope_graph, scope_add, Old_scope_add, scope_offs, scope_mean, scope_smooth   nvar symcheck, Old_scope_graph, Old_scope_range   svar dispwave   string source, result, ScopeWave   wave scmat, temp, temp1   variable nwaves if (stringmatch(WinName(0, 1),"Graph_scope")!=1)  DoWindow /f  graph_scopeelse   DoWindow graph_scopeendifif (V_flag==1)   source = dispwave+num2istr(scope_graph)	 duplicate /o $source scmat	 epoints = dimsize(scmat,0)	 kpoints = dimsize(scmat,1)	if (kpoints==0)	kpoints =1	endif	    nwaves = ceil(Old_scope_range/Old_scope_add)  if (nwaves > ceil(Old_scope_range/scope_add))   for ( i=ceil(Old_scope_range/scope_add); i<nwaves; i+=1 )	  ScopeWave = "scope"+num2istr(i)    removefromgraph /z  $ScopeWave   endfor elseif (ceil(Old_scope_range/scope_add) > nwaves)   for ( i=nwaves; i<ceil(old_scope_range/scope_add); i+=1 )  		ScopeWave = "scope"+num2istr(i)  		duplicate /o nil $scopewave  		AppendToGraph $ScopeWave vs scopex 	endfor endif endif   if (Old_scope_range > scope_range)   nwaves = ceil(Old_scope_range/scope_add)   for ( i=ceil(scope_range/scope_add); i<nwaves; i+=1 )	  ScopeWave = "scope"+num2istr(i)    removefromgraph /z  $ScopeWave   endfor   elseif (Old_scope_range < scope_range)   nwaves = ceil(scope_range/scope_add)   for ( i=ceil(Old_scope_range/scope_add); i<nwaves; i+=1 )	  ScopeWave = "scope"+num2istr(i)	  duplicate /o nil $scopewave    AppendToGraph $ScopeWave vs scopex   endforendifOld_scope_range = scope_rangeEnd Function scopebutton_nw(ctrlName) : ButtonControl	String ctrlName	variable i, kpoints, grsize	string dest, graphname		NVAR scope_graph	SVAR dispwave	dowindow /f Graph_Scope	if ( V_Flag == 0 )		Abort "Display the Scope first "	endif	graphname = dispwave+num2istr(scope_graph)	kpoints = GetGraphDim( scope_graph, 1 )	grsize = GetGraphDim( scope_graph, 0 )	duplicate/o $graphname temp	make /o/n=(kpoints) temp1	make /o/n=(grsize) temp2		temp2 = 0	for ( i=0; i<grsize; i+=1 )		temp1 = temp[i][p]		temp2[i] = area(temp1,0,kpoints-1)		//print temp2[i]	endfor		dest = "nw"+num2istr(scope_graph)	duplicate /o temp2 $dest	dowindow /f nw	if ( V_Flag == 1 )		AppendToGraph $dest	endif	dowindow /f Graph_ScopeEndmacroFunction ScopeButton_DivFermi(ctrlName) : ButtonControl	string ctrlName	string source	variable i, secord		NVAR scope_range	Wave wFermi, scopex	DoWindow /f Graph_Scope	if ( V_Flag == 0 )		Abort "Display the Scope first and use \rCursor A and B to define the Background range\rMake sure wFermi[0] and wFermi[1] are set correctly"	endif	make /o /n=(dimsize(scopex,0)) temp1	wFermi[2] = 1	wFermi[3] = 0	wFermi[4] = 0		temp1 = Fermi( wFermi, scopex )		for ( i=0; i<scope_range; i+=1 )		source = "scope"+num2istr(i)		duplicate/o $source temp		secord = faverage(temp,xcsr(a),xcsr(b))		temp -= secord		//print secord		temp /= temp1		duplicate/o temp $source			endfor	DoWindow /f AutoGraphEnd////////////////////////////////////////////////		Button Graph and Procedures		////////////////////////////////////////////////Window Button_Graph() : Graph  variable i=1  string nameY, nameX	PauseUpdate; Silent 1		// building window...	Display /W=(309,48,723,580) 	do	   nameY = "buttwave"+num2istr(i)	   nameX = "buttx"+num2istr(i)	   appendtograph $nameY vs $nameX	  i+=1	while ( i<=Butt_of*10 )	ModifyGraph msize=0.5	ModifyGraph tick=2	ModifyGraph zero(bottom)=3	ModifyGraph mirror=1	ModifyGraph minor(bottom)=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-1.625	ModifyGraph lblLatPos(left)=-1	Label left "Intensity (arb. units)"	Label bottom "Energy (eV)"	ShowInfo	ShowTools	Butt_offsetALlFunc ()	Butt_ColorALlInput ()	Butt_BoldAllInput ()EndMacroFunction Butt_ColorAllFunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string colorstr, name	variable colorval1, colorval2, colorval3	variable i,No,page_i	Nvar Butt_page,butt_of	wave/t butt_color   for (page_i=1;page_i<=butt_of;page_i+=1)	  for (i=1 ; i<=10 ; i+=1)		No = (page_i-1)*10+i   	butt_color[No] = popStr    endfor 	endfor     Butt_ColorALlInput ()EndFunction Butt_ColorALlInput ()  variable colorval1, colorval2, colorval3, i, page_i,No  Nvar butt_of  wave/t butt_color  string  popStr, colorstr, name  dowindow Button_graph  if (V_flag==1)  	for (page_i=1;page_i<=butt_of;page_i+=1)	  for (i=1 ; i<=10 ; i+=1)	   No = (page_i-1)*10+i	   popStr = butt_color[No]		colorstr=popStr[1,strlen(popStr)-2]		colorval1=str2num(StringFromList(0, colorstr, ","))		colorval2=str2num(StringFromList(1, colorstr, ","))		colorval3=str2num(StringFromList(2, colorstr, ","))		name = "Buttwave"+num2str(No)   	ModifyGraph/w=Button_graph rgb($name)=(colorval1,colorval2,colorval3)    endfor 	endfor endifendFunction Butt_ColorFunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	//print ctrlName,popNum,popStr	string colorstr, name	variable colorval1, colorval2, colorval3	variable i,No	Nvar Butt_page	wave/t butt_color //  if (stringmatch(WinName(0, 1),"Button_Graph")!=1) //   	DoWindow /f  Button_Graph //  endif   DoWindow Button_Graphif (V_flag==1)	sscanf ctrlName, "Colorpop%f", i	No = (Butt_page-1)*10+i	colorstr=popStr[1,strlen(popStr)-2]	colorval1=str2num(StringFromList(0, colorstr, ","))	colorval2=str2num(StringFromList(1, colorstr, ","))	colorval3=str2num(StringFromList(2, colorstr, ","))	name = "Buttwave"+num2str(No)   ModifyGraph/w=Button_Graph rgb($name)=(colorval1,colorval2,colorval3)   butt_color[No] = popStr endif// print colorstr, colorval1, colorval2, colorval3 ButTempThetaInfo (No)EndWindow ButtonGraph() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(689,599,1061,1037)	ModifyPanel cbRGB=(32768,54615,65535)	SetDrawLayer UserBack	SetDrawEnv save	SetDrawEnv fstyle= 1	DrawText 177,18,"Slice"	SetDrawEnv fstyle= 1	DrawText 20,18,"Goffset"	SetDrawEnv fstyle= 1	DrawText 117,18,"Graph"	SetDrawEnv fstyle= 1	DrawText 90,18,"No"	SetDrawEnv fstyle= 1	DrawText 335,18,"Bold"	SetDrawEnv fstyle= 1	DrawText 290,18,"Color"	SetDrawEnv fstyle= 1	DrawText 228,18,"Offset"	DrawLine 8,37,365,37	DrawLine 8,56,365,56	DrawLine 8,75,365,75	DrawLine 8,94,365,94	DrawLine 8,113,365,113	DrawLine 8,132,365,132	DrawLine 8,151,365,151	DrawLine 8,170,365,170	DrawLine 8,189,365,189	SetDrawEnv linethick= 3	DrawLine 7,285,365,285	SetDrawEnv linethick= 3	DrawLine 7,332,365,332	SetDrawEnv linethick= 3	DrawLine 257,286,257,332	SetDrawEnv linethick= 3	DrawLine 7,236,365,236	SetDrawEnv linethick= 2,dash= 11	DrawLine 6,211,366,211	SetDrawEnv linethick= 3	DrawLine 7,405,365,405	SetDrawEnv linethick= 3	DrawLine 224,333,224,404	SetDrawEnv linethick= 3	DrawLine 137,333,137,404	SetVariable ButtSlice1,pos={171,20},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice1,value= butt_an1	SetVariable ButtSlice2,pos={171,39},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice2,value= butt_an2	SetVariable ButtSlice3,pos={171,58},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice3,value= butt_an3	SetVariable ButtSlice4,pos={171,77},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice4,value= butt_an4	SetVariable ButtSlice5,pos={171,96},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice5,value= butt_an5	SetVariable ButtSlice6,pos={171,115},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice6,value= butt_an6	SetVariable ButtSlice7,pos={171,134},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice7,value= butt_an7	SetVariable ButtSlice8,pos={171,153},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice8,value= butt_an8	SetVariable ButtSlice9,pos={171,172},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice9,value= butt_an9	SetVariable ButtSlice10,pos={171,191},size={55,15},proc=ButtProc,title=" "	SetVariable ButtSlice10,value= butt_an10	CheckBox Butt_leg,pos={80,369},size={50,14},proc=Butt_legend,title="Legend"	CheckBox Butt_leg,value= 0	CheckBox Nromcheck,pos={8,336},size={62,14},proc=Butt_Norm_check,title="AreaNorm"	CheckBox Nromcheck,value= 0	CheckBox check3,pos={80,384},size={47,14},proc=Butt_backgr,title="Backgr"	CheckBox check3,value= 0	Button button0,pos={9,291},size={39,20},proc=Butt_save_param,title="Save"	CheckBox AutoLoadcheck,pos={95,294},size={38,14},proc=buttload_cbox,title="auto"	CheckBox AutoLoadcheck,value= 1	SetVariable setvar4,pos={54,293},size={39,15},proc=Butt_load_param,title=" "	SetVariable setvar4,limits={0,inf,1},value= butt_set	Button button1,pos={10,261},size={46,20},proc=Butt_ShowGraph,title="Show"	Button button2,pos={216,410},size={60,20},proc=Butt_graphA,title="Graph"	CheckBox Sym,pos={80,337},size={37,14},proc=Butt_sym_check,title="Sym",value= 0	PopupMenu Goffpop10,pos={1,190},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop10,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop9,pos={1,171},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop9,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop8,pos={1,152},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop8,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop7,pos={1,133},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop7,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop6,pos={1,114},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop6,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop5,pos={1,95},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop5,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop4,pos={1,76},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop4,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop3,pos={1,57},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop3,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop2,pos={1,38},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop2,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	PopupMenu Goffpop1,pos={1,19},size={73,17},proc=Butt_ListGoffsetproc,title=" "	PopupMenu Goffpop1,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	SetVariable ButtGraph1,pos={117,20},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph1,limits={0,inf,1},value= butt_gr1	SetVariable ButtGraph2,pos={117,39},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph2,limits={0,inf,1},value= butt_gr2	SetVariable ButtGraph3,pos={117,58},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph3,limits={0,inf,1},value= butt_gr3	SetVariable ButtGraph4,pos={117,77},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph4,limits={0,inf,1},value= butt_gr4	SetVariable ButtGraph5,pos={117,96},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph5,limits={0,inf,1},value= butt_gr5	SetVariable ButtGraph6,pos={117,115},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph6,limits={0,inf,1},value= butt_gr6	SetVariable ButtGraph7,pos={117,134},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph7,limits={0,inf,1},value= butt_gr7	SetVariable ButtGraph8,pos={117,153},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph8,limits={0,inf,1},value= butt_gr8	SetVariable ButtGraph9,pos={117,172},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph9,limits={0,inf,1},value= butt_gr9	SetVariable ButtGraph10,pos={117,191},size={57,15},proc=ButtProc,title=" "	SetVariable ButtGraph10,limits={0,inf,1},value= butt_gr10	PopupMenu Goffpopup,pos={7,215},size={68,17},proc=Butt_ListGoffsetprocALL	PopupMenu Goffpopup,mode=1,popvalue="G0000",value= #"StringList(\"G*000\",\";\")"	Button button4,pos={122,410},size={86,20},proc=Butt_resetFunc,title="ResetAll"	Button button03,pos={144,291},size={53,20},proc=MemoButtListFunc,title="memo"	SetVariable setvar22,pos={16,313},size={234,15},title="memo",value= memoButt	PopupMenu changeValue,pos={197,242},size={71,17},proc=Butt_OffValmenuFunc,title="Off Unit"	PopupMenu changeValue,mode=3,popvalue="1",value= #"\"0.01;0.1;1;10;100;1000;10000\""	SetVariable setvar5,pos={71,242},size={50,15},disable=2,title="of"	SetVariable setvar5,limits={1,100,1},value= Butt_of	SetVariable setvar6,pos={8,242},size={62,15},proc=Butt_PageFunc,title="Page"	SetVariable setvar6,limits={1,100,1},value= Butt_Page	Button button6,pos={123,240},size={70,20},proc=Butt_NewPageProc,title="New Page"	CheckBox Sym1,pos={8,351},size={58,14},proc=Butt_MaxNorm_check,title="MaxNorm"	CheckBox Sym1,value= 0	SetVariable ButtGraph0,pos={85,20},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph0,limits={0,9999,1},value= butt_No1	SetVariable ButtGraph03,pos={85,39},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph03,limits={0,9999,1},value= butt_No2	SetVariable ButtGraph04,pos={85,58},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph04,limits={0,9999,1},value= butt_No3	SetVariable ButtGraph05,pos={85,77},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph05,limits={0,9999,1},value= butt_No4	SetVariable ButtGraph06,pos={85,96},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph06,limits={0,9999,1},value= butt_No5	SetVariable ButtGraph07,pos={85,115},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph07,limits={0,9999,1},value= butt_No6	SetVariable ButtGraph08,pos={85,134},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph08,limits={0,9999,1},value= butt_No7	SetVariable ButtGraph09,pos={85,153},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph09,limits={0,9999,1},value= butt_No8	SetVariable ButtGraph11,pos={85,172},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph11,limits={0,9999,1},value= butt_No9	SetVariable ButtGraph12,pos={85,191},size={28,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph12,limits={0,9999,1},value= butt_No10	PopupMenu Colorpop10,pos={275,190},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop10,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop9,pos={275,171},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop9,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop8,pos={275,152},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop8,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop7,pos={275,133},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop7,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop6,pos={275,114},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop6,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop5,pos={275,95},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop5,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop4,pos={275,76},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop4,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop3,pos={275,57},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop3,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop2,pos={275,38},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop2,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop1,pos={275,19},size={55,17},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop1,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	SetVariable Bold1,pos={336,20},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold1,limits={1,9,1},value= Butt_Bold1	SetVariable Bold2,pos={336,39},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold2,limits={1,9,1},value= Butt_Bold2	SetVariable Bold3,pos={336,58},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold3,limits={1,9,1},value= Butt_Bold3	SetVariable Bold4,pos={336,77},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold4,limits={1,9,1},value= Butt_Bold4	SetVariable Bold5,pos={336,96},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold5,limits={1,9,1},value= Butt_Bold5	SetVariable Bold6,pos={336,115},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold6,limits={1,9,1},value= Butt_Bold6	SetVariable Bold7,pos={336,134},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold7,limits={1,9,1},value= Butt_Bold7	SetVariable Bold8,pos={336,153},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold8,limits={1,9,1},value= Butt_Bold8	SetVariable Bold9,pos={336,172},size={31,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold9,limits={1,9,1},value= Butt_Bold9	SetVariable Bold10,pos={335,191},size={32,15},proc=Butt_BoldFunc,title=" "	SetVariable Bold10,limits={1,9,1},value= Butt_Bold10	SetVariable ButtOff1,pos={226,20},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff1,value= Butt_off1	SetVariable ButtOff2,pos={226,39},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff2,value= Butt_off2	SetVariable ButtOff3,pos={226,58},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff3,value= Butt_off3	SetVariable ButtOff4,pos={226,77},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff4,value= Butt_off4	SetVariable ButtOff5,pos={226,96},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff5,value= Butt_off5	SetVariable ButtOff6,pos={226,115},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff6,value= Butt_off6	SetVariable ButtOff7,pos={226,134},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff7,value= Butt_off7	SetVariable ButtOff8,pos={226,153},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff8,value= Butt_off8	SetVariable ButtOff9,pos={226,172},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff9,value= Butt_off9	SetVariable ButtOff10,pos={226,191},size={54,15},proc=Butt_offEachProc,title=" "	SetVariable ButtOff10,value= Butt_off10	PopupMenu Colorpop11,pos={275,215},size={55,17},proc=Butt_ColorAllFunc,title=" "	PopupMenu Colorpop11,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	SetVariable Bold11,pos={334,216},size={32,15},proc=Butt_BoldAllFunc,title=" "	SetVariable Bold11,limits={1,9,1},value= Butt_BoldAll	SetVariable ButtOffAll,pos={226,215},size={54,15},proc=Butt_offAllProc,title=" "	SetVariable ButtOffAll,value= Butt_offAll	SetVariable ButtShift,pos={171,216},size={55,15},proc=Butt_ShiftProc,title=" "	SetVariable ButtShift,value= butt_shift	SetVariable ButtGraph13,pos={85,215},size={27,15},disable=2,proc=ButtProc,title=" "	SetVariable ButtGraph13,value= butt_NoAll	SetVariable ButtRange,pos={124,263},size={87,15},proc=Butt_RangeProc,title="Range"	SetVariable ButtRange,limits={0,inf,1},value= butt_range	SetVariable setvar23,pos={266,302},size={83,15},disable=2,title="Temp"	SetVariable setvar23,value= ButtTemp	SetVariable setvar24,pos={266,316},size={83,15},disable=2,title="Theta"	SetVariable setvar24,value= ButtTheta	SetVariable setvar25,pos={266,288},size={83,15},disable=2,title="Graph"	SetVariable setvar25,value= ButtGraphNo	Button button5,pos={13,411},size={99,20},proc=Butt_Update,title="Update"	Button Stats1,pos={116,216},size={47,16},proc=Butt_adjustAngle,title="Adjust"	PopupMenu changeValue1,pos={264,377},size={46,17},proc=Butt_XValue_menu	PopupMenu changeValue1,mode=3,popvalue="0.1",value= #"\"0.001;0.01;0.1;1;10;100;1000\""	SetVariable Xmin,pos={229,340},size={96,15},proc=Butt_InputXFunc,title="X min"	SetVariable Xmin,limits={-inf,inf,0.1},value= ButtXminValue	SetVariable Xmax,pos={229,358},size={96,15},proc=Butt_InputXFunc,title="X max"	SetVariable Xmax,limits={-inf,inf,0.1},value= ButtXmaxValue	Button GetXYvalue,pos={327,336},size={36,20},proc=Butt_GetXYfunc,title="Get"	PopupMenu changeValue2,pos={63,262},size={57,17},proc=Butt_EDCMDCfunc	PopupMenu changeValue2,mode=2,popvalue="MDC",value= #"\"EDC;MDC\""	Button button7,pos={144,337},size={75,20},proc=Butt_DataSheet,title="Data sheet"	Button button8,pos={145,359},size={50,20},proc=Butt_Analize,title="Analize"	Button button9,pos={145,380},size={50,20},proc=Butt_Option,title="Option"	Button GetXYvalue1,pos={327,357},size={36,20},proc=Butt_UseXYfunc,title="Use"	Button Allaxis,pos={332,378},size={29,20},proc=Butt_AllaxisFunc,title="All"	CheckBox Sym2,pos={8,367},size={49,14},proc=Butt_AllArea_check,title="AllArea"	CheckBox Sym2,value= 0	Button button3,pos={204,290},size={44,20},proc=Butt_graphB,title="Graph"	CheckBox Sym3,pos={80,353},size={42,14},proc=Butt_Fermi_check,title="Fermi"	CheckBox Sym3,value= 0	CheckBox Sym4,pos={8,383},size={70,14},proc=Butt_useArea_check,title="useEDCArea"	CheckBox Sym4,value= 0	SetVariable ButtRange1,pos={255,263},size={78,15},proc=Butt_SmoothProc,title="Smooth"	SetVariable ButtRange1,limits={0,inf,1},value= butt_Smooth	Button button07,pos={212,261},size={39,20},proc=Butt_AddFunc,title="Add"EndMacroFunction Butt_AddFunc (ctrlName) : ButtonControl	String ctrlName	Nvar Butt_AddFirst, Butt_AddLast, butt_range, butt_shift, Butt_angle	variable AddFirst, AddLast	AddFirst=Butt_AddFirst	AddLast=Butt_AddLast	 Prompt AddFirst, "First slice No."	 Prompt AddLast, "Last slice No."   Doprompt "Input Add range", AddFirst,AddLast     if (V_Flag)   	   return -1// User canceled   	 endif 	Butt_AddFirst=AddFirst	Butt_AddLast=AddLast	butt_range=floor( abs(Butt_AddLast-Butt_AddFirst)/2 )	butt_shift=butt_range+AddFirst	Butt_angle = 0	ButtwaveInputFunc_simple ("an",1)	InputAnFunc ()end			Function Butt_SmoothProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string AnorGr	AnorGr = "an"   ButtwaveInputFunc_simple (AnorGr,1)    InputAnFunc ()EndFunction Butt_AllArea_check(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR AllAreaON, butt_of	variable page_i, i, No, Norm	string NameY, NameX   AllAreaON=checked   resetEDCarea()if (AllAreaON==1)  for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 		 No = (page_i-1)*10+i 		 NameY = "Buttwave"+num2str(NO) 		 NameX = "ButtX"+num2str(NO) 		 if (numpnts($NameY)!=0) 		  duplicate/o $nameY temp 		  duplicate/o $nameX temp2       Norm =  faverageXY (temp2,temp,-inf,inf)      //Norm = areaXY(temp2,temp,hcsr(a),hcsr(b))      getEDCarea(No,Norm)		  temp /= Norm			  duplicate/o temp $nameY		 endif 	 endfor  endfor else   ButtwaveInputFunc_simple ("an",1)   InputAnFunc ()	endifEndFunction resetEDCarea()     Nvar Butt_of     Nvar MDC_flag		 make/o/n=( Butt_of*10) EDCArea, EDCAreaNo		 if (MDC_flag==0) 	  	EDCArea[]=nan			EDCAreaNo[]=nan	  	   endif endFunction getEDCarea(No,Norm)  variable No,Norm  wave EDCArea, EDCAreaNo  Nvar MDC_flag  if (MDC_flag==0)  	EDCArea[No-1]=Norm  	EDCAreaNo[No-1]=No  endifendFunction Butt_useArea_check (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar useAreaCheck	useAreaCheck=checked	if (checked==1 && exists("EDCarea"))	   	  showEDCarea()	endifend		Function Butt_Fermi_check (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar ButtFermiON, butt_of, FWHM_Convolution	Svar Yes_No_Convolution    variable i, Page_i, No, Vmax, Vmin, Temperature, FWHM    string source, sourcexax, Yes_No    wave map, butt_graph, Butt_Goff    ButtFermiON = checked    dowindow Button_Graph    if (V_flag==1 && ButtFermiON==1)       GetAxis/q/W=Button_Graph left          Vmax = V_max          Vmin = V_min                 Yes_No = Yes_No_Convolution       Prompt Yes_No, "Do you use convolution?", popup ,"Yes"+";No"       Doprompt "Choose option.", Yes_No         if (V_Flag)   	  		  return -1// User canceled   			 endif   			Yes_No_Convolution =  Yes_No       if (stringmatch(Yes_No,"Yes"))            FWHM=FWHM_Convolution            Prompt FWHM, "Input FWHM of Gausian [meV]"            Doprompt "Convolution Gausian Width.", FWHM            if (V_Flag)   	  				return -1// User canceled   					endif             FWHM_Convolution=FWHM       endif                    	   for (Page_i=1;Page_i<=butt_of;Page_i+=1)	    	    for (i=1;i<=10;i+=1) 	      	    No = (Page_i-1)*10+i           	   if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)            	    Temperature = map[butt_graph[No]][2]	            	    //Temperature = map[butt_graph[No]][0]	              	  source = "buttwave"+num2istr(No)       	            	 	sourcexax = "buttx"+num2istr(No) 	             		duplicate/o $source, temp	             		duplicate/o $sourcexax, temp2	             		if (stringmatch(Yes_No,"Yes"))	             		 ButtFermiOne_Convolution (temp2,temp,sourcexax,source,Temperature)	             		elseif  (stringmatch(Yes_No,"No"))               		 ButtFermiOne (temp2,temp,sourcexax,source,Temperature)               		endif             	endif	     		endfor	 	endfor	    SetAxis/w=Button_Graph left Vmin, Vmax	 elseif (V_flag==1 && ButtFermiON!=1)	   ButtUpdateFunc_simple ()	 endifendFunction ButtFermiOne_Convolution (temp2, temp, resultX, resultY,Temperature)  wave  temp2, temp  string resultX, resultY  variable temperature  variable eV=1.6*10^-19, kB=1.3807*10^-23  wave map, butt_graph, Butt_Goff 		 duplicate/o temp2, temp1, temp3   //   temp1[] = 1 / ( 1 + exp( temp2[p]/(kB*Temperature/eV) ) )      Fermi_convolutedVal (temp1,temp2,Temperature)      temp3[] = temp[p]/temp1[p]      duplicate/o  temp3 $resultY      duplicate/o  temp2 $resultXendFunction Fermi_convolutedVal (temp1,temp2,T)	wave temp1,temp2	Variable T	Nvar FWHM_Convolution	variable E_i=-0.35, E_f=0.35, dE=0.0005, E, i=0, MaxVal	variable dx, x, ValConvo	Variable Gau,fermi	variable eV=1.6*10^-19	variable KB=1.38*10^-23	variable C=2*(2*ln(2))^0.5	 make/o/n=( (E_f-E_i)/dE+1) ConvoFermi_X, ConvoFermi_Y   ConvoFermi_X=0; ConvoFermi_Y=0   ConvoFermi_X=E_i+dE*p   dx=(FWHM_Convolution/1000)*3	 for (E=E_i ; E<=E_f ; E+=dE)    ValConvo = 0   		for (x=E-dx; x<=E+dx; x+=dE)	 	 					fermi=1/(1+exp(x/(KB*T/eV)))	 					Gau=exp(-(E-x)^2/(2*(FWHM_Convolution/1000/C)^2))	 					ValConvo+=fermi*Gau	   		endfor   			ConvoFermi_Y[i] = ValConvo      	i+=1	 endfor			MaxVal = ConvoFermi_Y[0]			ConvoFermi_Y[] /= MaxVal			temp1[]=interp(temp2[p], ConvoFermi_X, ConvoFermi_Y )EndFunction ButtFermiOne (temp2, temp, resultX, resultY,Temperature)  wave  temp2, temp  string resultX, resultY  variable temperature  variable eV=1.6*10^-19, kB=1.3807*10^-23  wave map, butt_graph, Butt_Goff 		 duplicate/o temp2, temp1, temp3      temp1[] = 1 / ( 1 + exp( temp2[p]/(kB*Temperature/eV) ) )      temp3[] = temp[p]/temp1[p]      duplicate/o  temp3 $resultY      duplicate/o  temp2 $resultXendFunction Butt_graphA(ctrlname) : ButtonControl	string	ctrlname	variable i,No,Page_i,wavelistnum, valXmin, valXmax, panel_flag, buttPanelNo	string source,dest,descriptor,destxax,sourcexax,lastItemstr	string legtext, name, values, panelname, buttgrstr, waveliststr, legt	NVAR butt_set, mdc_flag, butt_leg, butt_shift,butt_of	SVAR sampleName	WAVE butt_graph, butt_angle, map, Butt_Goff	string waveAll, statement	buttPanelNo = 0	do 	panelname = "Butt"+num2str(buttPanelNo)	dowindow $panelname	buttPanelNo+=1	while (V_flag==1)	buttPanelNo-=1	legtext="\\Z16Butt"+num2istr(buttPanelNo)	dowindow Button_graph  if (stringmatch(winname(0,1),"Button_graph")!=1)     dowindow/f Button_graph  endif  if (V_flag==1) 	  GetAxis/q bottom 	  valXmin= V_min ; valXmax= V_max  	   statement = WinRecreation(winname(0,1),0)  	   execute statement     	 waveAll = TraceNameList("",";",1)     for (i=ItemsInList(waveAll)-1; i >= 0; i-=1)        RemoveFromGraph $StringFromList(i, waveAll)     endfor     dowindow /c $panelname   endif  for (Page_i=1;Page_i<=butt_of;Page_i+=1)	for (i=1;i<=10;i+=1) 	  No = (Page_i-1)*10+i 	  buttgrstr = num2str(butt_graph[No])		if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)			source = "buttwave"+num2istr(No)       			sourcexax = "buttx"+num2istr(No)       				if ( mdc_flag )				dest = "G"+num2istr(butt_graph(No))+"Butt"+num2istr(buttPanelNo)+"No"+num2istr(No)				destxax = "G"+num2istr(butt_graph(No))+"Butt"+num2istr(buttPanelNo)+"No"+num2istr(No)+"x"			 legt = "G"+num2istr(butt_graph(No))			else				dest = "G"+num2istr(butt_graph(No))+"Ang"+num2istr(butt_angle(No)+Butt_shift)+"Butt"+num2istr(buttPanelNo)+"No"+num2istr(No)				destxax = "G"+num2istr(butt_graph(No))+"Ang"+num2istr(butt_angle(No)+Butt_shift)+"Butt"+num2istr(buttPanelNo)+"No"+num2istr(No)+"x"			  legt = "G"+num2istr(butt_graph(No))			endif				duplicate /o $source $dest			duplicate /o $sourcexax $destxax				appendtograph $dest vs $destxax			waveliststr = TraceNameList("",";",1)			wavelistnum = ItemsInList(waveliststr)			lastItemstr = StringFromList(wavelistnum-1,waveliststr)        dest = lastItemstr			          colorFunc(No,dest)        BoldFunc(No,dest)        offsetFunc(No,dest)        SetAxis bottom valXmin,valXmax        	    if ( butt_leg==1 )	      sprintf  name "\\s(%s) %s %gdeg %gK" dest,legt,map[butt_graph[No]][6],map[butt_graph[No]][2]			 legtext+="\r"+name		 endif		endif	endforendforLegend/C/N=ButtLeg/F=0/A=LT/B=0 legtext  legtext=legtext[0,strlen(legtext)-2]   ModifyGraph fSize=16	ModifyGraph tick(left)=3,tick(bottom)=2	ModifyGraph mirror(left)=2,mirror(bottom)=1	ModifyGraph minor(bottom)=1	ModifyGraph sep(bottom)=5	ModifyGraph noLabel(left)=1	ModifyGraph lblMargin(left)=10	ModifyGraph axOffset(left)=-1.85714	ModifyGraph lblLatPos(left)=1	ModifyGraph standoff=0	if (mdc_flag!=1)	ModifyGraph zero(bottom)=3	endif	Label left "Intensity (arb. units)"	if ( mdc_flag!=1)	Label bottom "Energy (eV)"	else	Label bottom "k (Slice)"	endif	dowindow/f ButtongraphendFunction Butt_graphB(ctrlname) : ButtonControl	string	ctrlname	variable i,No,Page_i,wavelistnum, valXmin, valXmax, panel_flag	string source,dest,descriptor,destxax,sourcexax,lastItemstr	string legtext, name, values, panelname, buttgrstr, waveliststr, legt	NVAR butt_set, mdc_flag, butt_leg, butt_shift, butt_of	SVAR sampleName	WAVE butt_graph, butt_angle, map, Butt_Goff	string waveAll, statement	legtext="\\Z16ButtSave"+num2istr(butt_set)	if ( mdc_flag )		panelname = "ButtMDCSave"+num2istr(butt_set)	else		panelname = "ButtEDCSave"+num2istr(butt_set)	endif			dowindow Button_graph  if (stringmatch(winname(0,1),"Button_graph")!=1)     dowindow/f Button_graph  endif  if (V_flag==1) 	  GetAxis/q bottom 	  valXmin= V_min ; valXmax= V_max  	endif 		dowindow/f $panelname	panel_flag = V_flag  if (V_flag==1)	  waveAll = TraceNameList("",";",1)	  appendtograph zerowave      for (i=ItemsInList(waveAll)-1; i >= 0; i-=1)        RemoveFromGraph $StringFromList(i, waveAll)     endfor    else      dowindow/f Button_graph    if (V_flag==1) 	   statement = WinRecreation(winname(0,1),0)  	   execute statement     	 waveAll = TraceNameList("",";",1)     for (i=ItemsInList(waveAll)-1; i >= 0; i-=1)        RemoveFromGraph $StringFromList(i, waveAll)     endfor     dowindow /c $panelname     endif    endiffor (Page_i=1;Page_i<=butt_of;Page_i+=1)	for (i=1;i<=10;i+=1) 	  No = (Page_i-1)*10+i 	  buttgrstr = num2str(butt_graph[No])		if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)			source = "buttwave"+num2istr(No)       			sourcexax = "buttx"+num2istr(No)       				if ( mdc_flag )				dest = "G"+num2istr(butt_graph(No))+"MDCSave"+num2istr(butt_set)+"No"+num2istr(No)				destxax = "G"+num2istr(butt_graph(No))+"MDCSave"+num2istr(butt_set)+"No"+num2istr(No) +"x"			 legt = "G"+num2istr(butt_graph(No))			else				dest = "G"+num2istr(butt_graph(No))+"Ang"+num2istr(butt_angle(No)+Butt_shift)+"EDCSave"+num2istr(butt_set)+"No"+num2istr(No)				destxax = "G"+num2istr(butt_graph(No))+"Ang"+num2istr(butt_angle(No)+Butt_shift)+"EDCSave"+num2istr(butt_set)+"No"+num2istr(No)+"x"			  legt = "G"+num2istr(butt_graph(No))			endif				duplicate /o $source $dest			duplicate /o $sourcexax $destxax				appendtograph $dest vs $destxax			waveliststr = TraceNameList("",";",1)			wavelistnum = ItemsInList(waveliststr)			lastItemstr = StringFromList(wavelistnum-1,waveliststr)        dest = lastItemstr			          colorFunc(No,dest)        BoldFunc(No,dest)        offsetFunc(No,dest)        SetAxis bottom valXmin,valXmax        	    if ( butt_leg==1 )	      sprintf  name "\\s(%s) %s %gdeg %gK" dest,legt,map[butt_graph[No]][6],map[butt_graph[No]][2]			 legtext+="\r"+name		 endif		endif	endforendforif (panel_flag ==1)   removefromgraph  zerowaveendif Legend/C/N=ButtLeg/F=0/A=LT/B=0 legtextif (panel_flag !=1)   legtext=legtext[0,strlen(legtext)-2]   ModifyGraph fSize=16	ModifyGraph tick(left)=3,tick(bottom)=2	ModifyGraph mirror(left)=2,mirror(bottom)=1	ModifyGraph minor(bottom)=1	ModifyGraph sep(bottom)=5	ModifyGraph noLabel(left)=1	ModifyGraph lblMargin(left)=10	ModifyGraph axOffset(left)=-1.85714	ModifyGraph lblLatPos(left)=1	ModifyGraph standoff=0	if (mdc_flag!=1)	ModifyGraph zero(bottom)=3	endif	Label left "Intensity (arb. units)"	if ( mdc_flag!=1)	Label bottom "Energy (eV)"	else	Label bottom "k (Slice)"	endifendif	dowindow/f ButtongraphendFunction Butt_Norm_check(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR normalizeON, butt_of   variable page_i, i, No, Norm, x1,x2	string NameY, NameX   normalizeON=checked   resetEDCarea() if (stringmatch(CsrWave(a,"Button_graph"),"") || stringmatch(CsrWave(b,"Button_graph"),"")) 	      Abort "Set A and B cursors!!" endif  x1=hcsr(a,"Button_graph") ;x2=hcsr(b,"Button_graph")  if (normalizeON==1)  for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 		 No = (page_i-1)*10+i 		 NameY = "Buttwave"+num2str(NO) 		 NameX = "ButtX"+num2str(NO) 		 if (numpnts($NameY)!=0) 		  duplicate/o $nameY temp 		  duplicate/o $nameX temp2 		  Norm = faverageXY(temp2,temp,x1,x2)       //Norm = areaXY(temp2,temp,hcsr(a),hcsr(b))     		  temp /= Norm			  duplicate/o temp $nameY		  getEDCarea(No,Norm)		 endif 	 endfor  endfor else   ButtwaveInputFunc_simple ("an",1)   InputAnFunc ()	endifEndFunction Butt_MaxNorm_check(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR MaxNormON, butt_of   variable page_i, i, No, Norm, Point_i, Point_f, x1, x2	string NameY, NameX	   MaxNormON=checked   resetEDCarea() if (stringmatch(CsrWave(a,"Button_graph"),"") || stringmatch(CsrWave(b,"Button_graph"),"")) 	      Abort "Set A and B cursors!!" endif   x1=hcsr(a,"Button_graph") ;x2=hcsr(b,"Button_graph")  if (MaxNormON==1)  for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 		 No = (page_i-1)*10+i 		 NameY = "Buttwave"+num2str(NO) 		 NameX = "ButtX"+num2str(NO) 		 if (numpnts($NameY)!=0) 		 duplicate/o $nameY temp 		 duplicate/o $nameX temp2 	    findlevel/P/Q temp2 x1	    Point_i = V_levelx	    findlevel/P/Q temp2 x2	    Point_f = V_levelx		  wavestats/Q/R=[Point_i,Point_f] temp		  Norm =  V_max		  temp /= Norm			 duplicate/o temp $nameY		   getEDCarea(No,Norm)		 endif 	 endfor  endfor else   ButtwaveInputFunc_simple ("an",1)   InputAnFunc ()	endifEndFunction Butt_UseXYfunc (ctrlName) : ButtonControl	String ctrlName   Butt_InputX ()EndFunction Butt_NewPageFunc (of) : ButtonControl	variable of	variable i	string nameButt_y, nameButt_x	Nvar Butt_of	wave butt_graph, butt_angle, butt_Goff, butt_offset, butt_Bold	wave/t Butt_color, ButtSaveTable, ButtSaveEDCMDC	dowindow/f Button_Graph	if (v_flag!=1)	 execute "Button_Graph()"	endif	Redimension/N=(of*10+1) butt_graph, butt_angle, butt_Goff, butt_offset,butt_Bold, Butt_color  Butt_of+=1  do	for (i=(Butt_of-1)*10+1 ; i<=Butt_of*10 ; i+=1)	  nameButt_y = "Buttwave" + num2istr(i)	  nameButt_x = "Buttx" + num2istr(i)	  duplicate/o zerowave $nameButt_y $nameButt_x 	  appendtograph $nameButt_y vs $nameButt_x	  ModifyGraph rgb($nameButt_y)=(0,0,0)	  Butt_color[i]=""	  butt_Bold[i]=1	endfor	Butt_of+=1 while (Butt_of<=of)  Butt_of-=1	Redimension/N=((Butt_of*10+1),-1,-1) ButtSaveTable	ButtSaveTable[(Butt_of-1)*10+1,Butt_of*10][][] = "0"	Redimension/N=((Butt_of*10+1),-1,-1) ButtSaveEDCMDC	ButtSaveEDCMDC[(Butt_of-1)*10+1,Butt_of*10][][] = "0"	dowindow/f ButtonGraph   dowindow Buttdatasheet	 if (V_flag==1)	      Butt_ChangeDataSheetAll ()    endifendFunction Butt_NewPageProc (ctrlName) : ButtonControl	String ctrlName	variable i	string nameButt_y, nameButt_x	Nvar Butt_of	wave butt_graph, butt_angle, butt_Goff, butt_offset, butt_Bold	wave/t Butt_color, ButtSaveTable, ButtSaveEDCMDC	dowindow Button_Graph	if (v_flag!=1)	 execute "Button_Graph()"	endif	Butt_of+=1	Redimension/N=(Butt_of*10+1) butt_graph, butt_angle, butt_Goff, butt_offset,butt_Bold, Butt_color	for (i=(Butt_of-1)*10+1 ; i<=Butt_of*10 ; i+=1)	  nameButt_y = "Buttwave" + num2istr(i)	  nameButt_x = "Buttx" + num2istr(i)	  duplicate/o zerowave $nameButt_y $nameButt_x 	  appendtograph/w=Button_graph $nameButt_y vs $nameButt_x	  ModifyGraph/w=Button_graph rgb($nameButt_y)=(0,0,0)	  Butt_color[i]=""	  butt_Bold[i]=1	endfor	Redimension/N=((Butt_of*10+1),-1,-1) ButtSaveTable	ButtSaveTable[(Butt_of-1)*10+1,Butt_of*10][][] = "0"	Redimension/N=((Butt_of*10+1),-1,-1) ButtSaveEDCMDC	ButtSaveEDCMDC[(Butt_of-1)*10+1,Butt_of*10][][] = "0"	dowindow/f ButtonGraph   dowindow Buttdatasheet	 if (V_flag==1)	      Butt_ChangeDataSheetAll ()    endifendProc Butt_Analize (ctrlName) : ButtonControl	String ctrlName		dowindow/f ButtonAnalize	if (V_flag!=1)	variable/g butt_2ndsmooth1,butt_2ndsmooth2,butt_2ndsmooth3	variable/g Butt_areaE, Butt_areaDeltaE, EDCFWHMTempCheck	ButtonAnalize()	endifendProc Butt_Option (ctrlName) : ButtonControl	String ctrlName		dowindow/f ButtonOption	if (V_flag!=1)	ButtonOption()	endifendWindow ButtonOption() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(765,411,992,746)	ModifyPanel cbRGB=(32768,54615,65535)	SetDrawLayer UserBack	SetDrawEnv linethick= 2,dash= 2	DrawLine 7,185,220,185	SetDrawEnv linethick= 3	DrawLine 3,258,216,258	SetDrawEnv linethick= 2,dash= 11	DrawLine 7,96,220,96	SetDrawEnv linethick= 2,dash= 2	DrawLine 7,144,220,144	SetDrawEnv linethick= 3	DrawLine 3,68,216,68	SetDrawEnv linethick= 2,dash= 2	DrawLine 7,232,220,232	SetDrawEnv linethick= 3	DrawLine 3,42,216,42	Button button3,pos={57,120},size={60,20},proc=Butt_Insert,title="Insert 0"	Button button05,pos={8,120},size={42,20},proc=Butt_resetPart,title="Reset"	SetVariable setvar0,pos={7,74},size={87,15},title="From No"	SetVariable setvar0,limits={1,inf,1},value= Butt_From	SetVariable setvar1,pos={93,74},size={59,15},title="to"	SetVariable setvar1,limits={1,inf,1},value= Butt_to	PopupMenu Colorpop12,pos={79,100},size={55,17},proc=Butt_ColorPartFunc,title=" "	PopupMenu Colorpop12,mode=1,popColor= (65535,21845,0),value= #"\"*COLORPOP*\""	PopupMenu Goffpopup1,pos={8,100},size={68,17},proc=Butt_ListGoffsetprocPart	PopupMenu Goffpopup1,mode=2,popvalue="G1000",value= #"StringList(\"G*000\",\";\")"	SetVariable ButtOffpartBase,pos={14,148},size={121,15},proc=Butt_offPartProc,title="Offset (+)"	SetVariable ButtOffpartBase,limits={-inf,inf,0.1},value= Butt_OffsetPartBase	PopupMenu changeOffsetVal,pos={131,148},size={51,17},proc=Butt_OffvalPartmenuFunc,title=" "	PopupMenu changeOffsetVal,mode=2,popvalue="0.1",value= #"\"0.01;0.1;1;10;100;1000;10000\""	Button button06,pos={156,72},size={33,20},proc=Butt_OptionAllNo,title="All"	Button button4,pos={127,120},size={48,20},proc=Butt_Erase,title="Erase"	Button button7,pos={123,188},size={24,20},proc=Butt_SlicePartPlus,title="+"	Button button8,pos={153,188},size={24,20},proc=Butt_SlicePartMinus,title="-"	SetVariable ButtOffpart,pos={14,166},size={121,15},proc=Butt_offPartProc,title="Offset (x No)"	SetVariable ButtOffpart,limits={-inf,inf,0.1},value= Butt_OffsetPart	PopupMenu changeSliceVal,pos={43,210},size={40,17},proc=Butt_SlicevalPartmenuFunc,title=" "	PopupMenu changeSliceVal,mode=3,popvalue="1",value= #"\"0.01;0.1;1;10;100;1000;10000\""	SetVariable ButtSliceval,pos={18,191},size={100,15},proc=Butt_SliceValFunc,title="Slice + --"	SetVariable ButtSliceval,value= Butt_SlicePart	SetVariable setvar4,pos={14,265},size={71,15},proc=Butt_DataSheetExtraInput,title="Save"	SetVariable setvar4,limits={0,50,1},value= butt_setExtra	Button button9,pos={87,262},size={85,20},proc=Butt_DataSheetExtra,title="Data sheet"	SetVariable setvar2,pos={14,285},size={87,15},title="From No"	SetVariable setvar2,limits={1,inf,1},value= Butt_FromEtra	SetVariable setvar3,pos={100,285},size={59,15},title="to"	SetVariable setvar3,limits={1,inf,1},value= Butt_ToEtra	SetVariable setvar5,pos={26,305},size={121,15},title="This page : at No"	SetVariable setvar5,limits={1,inf,1},value= Butt_ThisPageFrom	Button button5,pos={149,302},size={51,20},proc=Butt_InsertFromExtra,title="Insert"	SetVariable ButtOffpart1,pos={8,3},size={108,15},title="From Graph"	SetVariable ButtOffpart1,value= Butt_FromGraph	Button button07,pos={168,18},size={48,20},proc=Butt_FillGraph,title="Insert"	SetVariable setvar6,pos={89,22},size={74,15},title="at No"	SetVariable setvar6,limits={1,inf,1},value= Butt_FromNo	SetVariable ButtOffpart2,pos={119,3},size={70,15},title="to",value= Butt_toGraph	Button button0,pos={123,234},size={24,20},proc=Butt_GraphPartPlus,title="+"	Button button1,pos={153,234},size={24,20},proc=Butt_GraphPartMinus,title="-"	SetVariable ButtGraphval,pos={21,237},size={92,15},title="Graph + --"	SetVariable ButtGraphval,value= Butt_GraphPart	SetVariable setvar7,pos={16,47},size={60,15},title="No"	SetVariable setvar7,limits={1,inf,1},value= Butt_replaceNo	SetVariable setvar8,pos={78,47},size={69,15},title="with"	SetVariable setvar8,limits={1,inf,1},value= Butt_withNo	Button button08,pos={154,45},size={54,20},proc=Butt_ReplaceProc,title="replace"EndMacroFunction Butt_DataSheetExtraInput (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName 	string panelname, waveliststr	variable i	panelname = "ButtDataSheetExtra"	dowindow $panelname	if (v_flag==1)	waveliststr = wavelist("*",";","win:")	 if (stringmatch(StringFromList(0, waveliststr),"")!=1)	  for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveFromTable $StringFromList(i, waveliststr)      	endfor    endif   Butt_InputDataSheetExtra ()  endIFendFunction Butt_OptionAllNo (ctrlName) : ButtonControl	String ctrlName	string wavestrY	variable i, check	Nvar Butt_of, Butt_From, Butt_to	for (i=1 ; i<=( Butt_of*10) ; i+=1)	wavestrY = "Buttwave" + num2istr(i)			if (numpnts($wavestrY)!=0 && check!=1)       Butt_From = i       check = 1		endif		if (numpnts($wavestrY)!=0)       Butt_to = i		endif		   endforend	Function Butt_ReplaceProc (ctrlName) : ButtonControl	String ctrlName	Nvar Butt_replaceNo, Butt_withNo	variable No	 wave butt_graph, butt_angle, butt_offset,butt_Goff,Butt_Bold	 wave/t butt_color	 getAllColor ()	    duplicate/o butt_graph temp	 butt_graph[Butt_replaceNo] = temp[Butt_withNo]	 butt_graph[Butt_withNo] = temp[Butt_replaceNo]	 	 	 duplicate/o butt_angle temp	 butt_angle[Butt_replaceNo] = temp[Butt_withNo]	 butt_angle[Butt_withNo] = temp[Butt_replaceNo]	 	 	 duplicate/o butt_offset temp	 butt_offset[Butt_replaceNo] = temp[Butt_withNo]	 butt_offset[Butt_withNo] = temp[Butt_replaceNo]	 	 	 duplicate/o butt_Goff temp	 butt_Goff[Butt_replaceNo] = temp[Butt_withNo]	 butt_Goff[Butt_withNo] = temp[Butt_replaceNo]	 	 	 duplicate/o butt_Bold temp	 butt_Bold[Butt_replaceNo] = temp[Butt_withNo]	 butt_Bold[Butt_withNo] = temp[Butt_replaceNo]	 	 	 	 duplicate/t/o butt_color tempT	 butt_color[Butt_replaceNo] = tempT[Butt_withNo]	 butt_color[Butt_withNo] = tempT[Butt_replaceNo]		 	  InputGrFunc ()    InputAnFunc ()    InputoffFunc ()    InputBoldFunc ()     ButtwaveInputFunc ("an",1)     Butt_offsetALlFunc ()    Butt_ColorALlInput ()    Butt_BoldAllInput ()  EndFunction Butt_GraphPartMinus (ctrlName) : ButtonControl	String ctrlName  variable No	wave butt_graph	Nvar Butt_From, Butt_to,Butt_GraphPart   for (No=Butt_From ; No<=Butt_to ; No+=1)	 butt_graph[No] -= Butt_GraphPart   endfor   ButtwaveInputFunc ("gr",0)   InputgrFunc () EndFunction Butt_GraphPartPlus (ctrlName) : ButtonControl	String ctrlName  variable No	wave butt_graph	Nvar Butt_From, Butt_to,Butt_GraphPart   for (No=Butt_From ; No<=Butt_to ; No+=1)	 butt_graph[No] += Butt_GraphPart   endfor   ButtwaveInputFunc ("gr",0)   InputgrFunc () EndFunction Butt_FillGraph (ctrlName) : ButtonControl	String ctrlName	Nvar Butt_From, Butt_to	Nvar Butt_page, Butt_of	Nvar Butt_FromNo, Butt_FromGraph, Butt_toGraph	variable insertNum,restNo,i, of=1	wave butt_graph,butt_Goff,butt_angle,butt_offset,butt_Bold	wave/t butt_color,ButtSaveTable	insertNum = (Butt_toGraph - Butt_FromGraph)+1	restNo = 0	i = (Butt_of*10)  do       restNo+=1       i-=1  while (butt_graph[i]/1000 == round(Butt_graph[i]/1000) && i>=Butt_FromNo)  if (restNo < insertNum )     of = Butt_of +  ceil( (insertNum-restNo)/10 )     Butt_NewPageFunc (of)  endif    duplicate/o butt_Goff temp    butt_Goff[Butt_FromNo+insertNum,] = temp[p-insertNum]	// input after focusing range    duplicate/o butt_graph temp    butt_graph[Butt_FromNo+insertNum,] = temp[p-insertNum]	    duplicate/o butt_angle temp    butt_angle[Butt_FromNo+insertNum,] = temp[p-insertNum]	    duplicate/o butt_offset temp    butt_offset[Butt_FromNo+insertNum,] = temp[p-insertNum]	    duplicate/t/o butt_color tempT    butt_color[Butt_FromNo+insertNum,] = tempT[p-insertNum]	    duplicate/o butt_Bold temp    butt_Bold[Butt_FromNo+insertNum,] = temp[p-insertNum]	      butt_Goff[Butt_FromNo,Butt_FromNo+insertNum-1] = trunc(Butt_FromGraph/1000)*1000 	   butt_graph[Butt_FromNo,Butt_FromNo+insertNum-1] = Butt_FromGraph+(P-Butt_FromNo) 	   butt_angle[Butt_FromNo,Butt_FromNo+insertNum-1] = 0  	  // butt_offset[Butt_FromNo,Butt_FromNo+insertNum-1] = Butt_FromGraph+(P-Butt_FromNo) 	  // butt_color[Butt_FromNo,Butt_FromNo+insertNum-1] = "0" 	   butt_Bold[Butt_FromNo,Butt_FromNo+insertNum-1] = 1 	       ButtwaveInputFunc ("an",1)    Butt_offsetALlFunc ()    Butt_ColorALlInput ()    Butt_BoldAllInput ()    InputGrFunc ()    InputAnFunc ()    InputoffFunc ()    InputBoldFunc ()endFunction Butt_InsertFromExtra (ctrlName) : ButtonControl	String ctrlName	Nvar Butt_From, Butt_to	Nvar Butt_page, Butt_of,Butt_FromEtra,Butt_ToEtra,Butt_ThisPageFrom,Butt_setExtra	variable insertNum,restNo,i,of	wave butt_graph,butt_Goff,butt_angle,butt_offset,butt_Bold	wave/t butt_color,ButtSaveTable	insertNum = (Butt_ToEtra-Butt_FromEtra)+1	restNo = 0	i = (Butt_of*10)  do       restNo+=1       i-=1  while (butt_graph[i]/1000 == round(Butt_graph[i]/1000) && i>=Butt_ThisPageFrom)  if (restNo < insertNum )     of = Butt_of +  ceil( (insertNum-restNo)/10 )     Butt_NewPageFunc (of)  endif    duplicate/o butt_Goff temp    butt_Goff[Butt_ThisPageFrom+insertNum,] = temp[p-insertNum]	    duplicate/o butt_graph temp    butt_graph[Butt_ThisPageFrom+insertNum,] = temp[p-insertNum]	    duplicate/o butt_angle temp    butt_angle[Butt_ThisPageFrom+insertNum,] = temp[p-insertNum]	    duplicate/o butt_offset temp    butt_offset[Butt_ThisPageFrom+insertNum,] = temp[p-insertNum]	    duplicate/t/o butt_color tempT    butt_color[Butt_ThisPageFrom+insertNum,] = tempT[p-insertNum]	    duplicate/o butt_Bold temp    butt_Bold[Butt_ThisPageFrom+insertNum,] = temp[p-insertNum]	   if (stringmatch(ButtSaveTable[1][0][butt_setExtra],"")!=1)   	butt_Goff[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = str2num(ButtSaveTable[p-Butt_ThisPageFrom+Butt_FromEtra][0][butt_setExtra]) 	   butt_graph[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = str2num(ButtSaveTable[p-Butt_ThisPageFrom+Butt_FromEtra][1][butt_setExtra]) 	   butt_angle[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = str2num(ButtSaveTable[p-Butt_ThisPageFrom+Butt_FromEtra][2][butt_setExtra]) + str2num(ButtSaveTable[3][6][butt_setExtra])  	   butt_offset[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = str2num(ButtSaveTable[p-Butt_ThisPageFrom+Butt_FromEtra][3][butt_setExtra]) 	   butt_color[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = ButtSaveTable[p-Butt_ThisPageFrom+Butt_FromEtra][4][butt_setExtra] 	   butt_Bold[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = str2num(ButtSaveTable[p-Butt_ThisPageFrom+Butt_FromEtra][5][butt_setExtra])    else   	butt_Goff[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = 0 	   butt_graph[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = 0 	   butt_angle[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = 0  	   butt_offset[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = 0 	  // butt_color[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = "0" 	   butt_Bold[Butt_ThisPageFrom,Butt_ThisPageFrom+insertNum-1] = 1  endif     ButtwaveInputFunc ("an",1)    Butt_offsetALlFunc ()    Butt_ColorALlInput ()    Butt_BoldAllInput ()    InputGrFunc ()    InputAnFunc ()    InputoffFunc ()    InputBoldFunc ()endFunction Butt_InputDataSheetExtra ()   wave/t mapt, tempT 	 variable  FolderChecked, SampleChecked, SliceNoChecked, SweepChecked, PassEChecked, EiiChecked, EffChecked   variable EstepChecked, DateChecked, TimeChecked, TempChecked, XChecked, YChecked, ZChecked, ThetaChecked, AngleChecked   variable Windex   string waveResult, Graphstr,Goffsetstr   variable TableSize, page_i, i, No   wave butt_angle, Butt_graph, Butt_Goff   wave/t buttsavetable   Nvar butt_of,butt_setExtra   TempChecked=1 //check necessary information   ThetaChecked=1    AngleChecked=1   TableSize = dimsize(buttsavetable,0)      waveResult="No_Extra"          make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = num2istr(p)      tempT[0] = "Save "+num2str(butt_setExtra)      duplicate/o tempT $waveResult      appendtotable $waveResult         waveResult="Graph_Extra" for (page_i=1;page_i<=Butt_of;page_i+=1)   for (i=1;i<=10;i+=1)   No = (page_i-1)*10+i   make/o/t/n=(TableSize) tempT, $waveResult   Graphstr = buttsavetable[No][1][butt_setExtra]   Goffsetstr = buttsavetable[No][0][butt_setExtra]   if (stringmatch(Graphstr,Goffsetstr) != 1 &&  stringmatch(Graphstr,"0") != 1) 	  tempT[No] = Graphstr 	       else  	  tempT[No] = " "   endif   endfor endfor    tempT[0] = "Save "+num2str(butt_setExtra)    duplicate/o tempT $waveResult    appendtotable $waveResult   if (AngleChecked==1)      waveResult="Slice_Extra"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult     Graphstr = buttsavetable[No][1][butt_setExtra]     Goffsetstr = buttsavetable[No][0][butt_setExtra]      if (stringmatch(Graphstr,Goffsetstr) != 1 &&  stringmatch(Graphstr,"0") != 1)      tempT[No] = num2str( str2num( buttsavetable[No][2][butt_setExtra] ) + str2num( ButtSaveTable[3][6][butt_setExtra] ) )      else      tempT[No] = " "      endif      endfor    endfor      tempT[0] = "Save "+num2str(butt_setExtra)      duplicate/o tempT $waveResult      appendtotable $waveResultendif if (ThetaChecked==1)      waveResult="Theta_deg_Extra"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult     Graphstr = buttsavetable[No][1][butt_setExtra]     Goffsetstr = buttsavetable[No][0][butt_setExtra]      if (stringmatch(Graphstr,Goffsetstr) != 1 &&  stringmatch(Graphstr,"0") != 1)      tempT[No] = mapt[str2num(Graphstr)][13]+" deg"      else      tempT[No] = " "      endif      endfor    endfor      tempT[0] = "Save "+num2str(butt_setExtra)      duplicate/o tempT $waveResult      appendtotable $waveResultendif  if (TempChecked==1)      waveResult="Temp_K_Extra"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult        Graphstr = buttsavetable[No][1][butt_setExtra]       Goffsetstr = buttsavetable[No][0][butt_setExtra]      if (stringmatch(Graphstr,Goffsetstr) != 1 &&  stringmatch(Graphstr,"0") != 1)      tempT[No] = mapt[str2num(Graphstr)][9]+" K"      else      tempT[No] = " "      endif      endfor     endfor      tempT[0] = "Save "+num2str(butt_setExtra)      duplicate/o tempT $waveResult      appendtotable $waveResultendifend         Function Butt_DataSheetExtra (ctrlName) : ButtonControl	String ctrlName	string panelname, waveliststr	variable i	panelname = "ButtDataSheetExtra"	dowindow/f $panelname	if (v_flag==1)	waveliststr = wavelist("*",";","win:")	 if (stringmatch(StringFromList(0, waveliststr),"")!=1)	  for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveFromTable $StringFromList(i, waveliststr)      	endfor    endif   Butt_InputDataSheetExtra ()  else   	edit	 Butt_InputDataSheetExtra ()	dowindow/c $panelname  endIFendFunction Butt_SliceValFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar Butt_SlicePart		 if (abs(varNum)<10^-5)	    Butt_SlicePart = 0	 endif	 end		Function Butt_SlicePartMinus (ctrlName) : ButtonControl	String ctrlName  variable No	wave butt_angle	Nvar Butt_From, Butt_to,Butt_SlicePart   for (No=Butt_From ; No<=Butt_to ; No+=1)	 butt_angle[No] -= Butt_SlicePart   endfor   ButtwaveInputFunc ("an",0)   //ButtwaveInputFunc ("an",1)    InputAnFunc () EndFunction Butt_SlicePartPlus (ctrlName) : ButtonControl	String ctrlName  variable No	wave butt_angle	Nvar Butt_From, Butt_to,Butt_SlicePart   for (No=Butt_From ; No<=Butt_to ; No+=1)	 butt_angle[No] += Butt_SlicePart   endfor   ButtwaveInputFunc ("an",0)   //ButtwaveInputFunc ("an",1)    InputAnFunc () EndFUnction Butt_OffvalPartmenuFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string offName	variable i		if ( popnum==1 ) 	    		SetVariable ButtOffpart, limits={-Inf,Inf,0.01}	    		SetVariable ButtOffpartBase, limits={-Inf,Inf,0.01}		endif	  if ( popnum==2 ) 				SetVariable ButtOffpart, limits={-Inf,Inf,0.1}				SetVariable ButtOffpartBase, limits={-Inf,Inf,0.1}	  endif		if ( popnum==3 ) 				SetVariable ButtOffpart, limits={-Inf,Inf,1}				SetVariable ButtOffpartBase, limits={-Inf,Inf,1}		endif	   if ( popnum==4 ) 				SetVariable ButtOffpart, limits={-Inf,Inf,10}				SetVariable ButtOffpartBase, limits={-Inf,Inf,10}		endif	   if ( popnum==5 ) 				SetVariable ButtOffpart, limits={-Inf,Inf,100}				SetVariable ButtOffpartBase, limits={-Inf,Inf,100}		endif	   if ( popnum==6 ) 	   		SetVariable ButtOffpart, limits={-Inf,Inf,1000}	   		SetVariable ButtOffpartBase, limits={-Inf,Inf,1000}		endif	   if ( popnum==7 ) 				SetVariable ButtOffpart, limits={-Inf,Inf,10000}				SetVariable ButtOffpartBase, limits={-Inf,Inf,10000}		endif			  	 	EndFUnction Butt_SlicevalPartmenuFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string offName	variable i		if ( popnum==1 ) 	    		SetVariable ButtSliceval, limits={-Inf,Inf,0.01}		endif	  if ( popnum==2 ) 				SetVariable ButtSliceval, limits={-Inf,Inf,0.1}	  endif		if ( popnum==3 ) 				SetVariable ButtSliceval, limits={-Inf,Inf,1}		endif	   if ( popnum==4 ) 				SetVariable ButtSliceval, limits={-Inf,Inf,10}		endif	   if ( popnum==5 ) 				SetVariable ButtSliceval, limits={-Inf,Inf,100}		endif	   if ( popnum==6 ) 	   		SetVariable ButtSliceval, limits={-Inf,Inf,1000}		endif	   if ( popnum==7 ) 				SetVariable ButtSliceval, limits={-Inf,Inf,10000}		endif			  	 	EndFunction Butt_offPartProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	variable No,i	wave butt_offset	Nvar Butt_From, Butt_to, Butt_OffsetPartBase, Butt_OffsetPart	if (stringmatch(varName,"Butt_OffsetPart"))	 if (abs(varNum)<10^-5)	    Butt_OffsetPart = 0	 endif	elseif (stringmatch(varName,"Butt_OffsetPartBase"))	 if (abs(varNum)<10^-5)	    Butt_OffsetPartBase = 0	 endif	   	endif   for (No=Butt_From ; No<=Butt_to ; No+=1)    i = No-Butt_From	 butt_offset[No] = Butt_OffsetPart*i+Butt_OffsetPartBase   endfor 	 Butt_offsetALlFunc ()   InputoffFunc ()endFunction ButtFromTovalcheck (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar Butt_From, Butt_to	if (stringmatch(varName,"Butt_From") && Butt_From > Butt_to)	 Butt_From = Butt_to	endif	if (stringmatch(varName,"Butt_To") && Butt_From > Butt_to)	 Butt_to = Butt_From	endifend	Function Butt_Erase (ctrlName) : ButtonControl	String ctrlName	Nvar Butt_From, Butt_to	Nvar Butt_page, Butt_of	variable insertNum,restNo,i	wave butt_graph,butt_Goff,butt_angle,butt_offset,butt_Bold	wave/t butt_color	insertNum = (Butt_to-Butt_from)+1    duplicate/o butt_Goff temp    butt_Goff[Butt_from,] = temp[p+insertNum]	; butt_Goff[numpnts(butt_Goff)-insertNum,] = 0    duplicate/o butt_graph temp    butt_graph[Butt_from,] = temp[p+insertNum]	; butt_graph[numpnts(butt_graph)-insertNum,] = 0    duplicate/o butt_angle temp    butt_angle[Butt_from,] = temp[p+insertNum]	; butt_angle[numpnts(butt_angle)-insertNum,] = 0    duplicate/o butt_offset temp    butt_offset[Butt_from,] = temp[p+insertNum]	; butt_offset[numpnts(butt_offset)-insertNum,] = 0    duplicate/t/o butt_color tempT   // butt_color[Butt_from,] = tempT[p+insertNum]	; butt_color[numpnts(butt_color)-insertNum,] = "0"    duplicate/o butt_Bold temp    butt_Bold[Butt_from,] = temp[p+insertNum]	; butt_Bold[numpnts(butt_Bold)-insertNum,] = 0    ButtwaveInputFunc ("an",1)    Butt_offsetALlFunc ()    Butt_ColorALlInput ()    Butt_BoldAllInput ()    InputGrFunc ()    InputAnFunc ()    InputoffFunc ()    InputBoldFunc ()endFunction Butt_Insert (ctrlName) : ButtonControl	String ctrlName	Nvar Butt_From, Butt_to	Nvar Butt_page, Butt_of	variable insertNum,restNo,i,of	wave butt_graph,butt_Goff,butt_angle,butt_offset,butt_Bold	wave/t butt_color	insertNum = (Butt_to-Butt_from)+1	restNo = 0	i = (Butt_of*10)  do       restNo+=1       i-=1  while (butt_graph[i]/1000 == round(Butt_graph[i]/1000) && i>=Butt_from)  if (restNo < insertNum )     of = Butt_of +  ceil( (insertNum-restNo)/10 )     Butt_NewPageFunc (of)  endif    duplicate/o butt_Goff temp    butt_Goff[Butt_to+1,] = temp[p-insertNum]	    duplicate/o butt_graph temp    butt_graph[Butt_to+1,] = temp[p-insertNum]	    duplicate/o butt_angle temp    butt_angle[Butt_to+1,] = temp[p-insertNum]	    duplicate/o butt_offset temp    butt_offset[Butt_to+1,] = temp[p-insertNum]	    duplicate/t/o butt_color tempT    butt_color[Butt_to+1,] = tempT[p-insertNum]	    duplicate/o butt_Bold temp    butt_Bold[Butt_to+1,] = temp[p-insertNum]	    Butt_resetPart ("")    Butt_offsetALlFunc ()    Butt_ColorALlInput ()    Butt_BoldAllInput ()    InputGrFunc ()    InputAnFunc ()    InputoffFunc ()    InputBoldFunc ()endFunction Butt_resetPart (ctrlName) : ButtonControl	String ctrlName	string name   wave butt_graph, butt_angle, butt_offset,butt_Goff,Butt_Bold   Nvar butt_shift,butt_range,symon,Mdc_flag   Nvar normalizeON, MaxNormON   wave/t butt_color    Nvar Butt_From, Butt_to   butt_graph[Butt_From, Butt_to]=0   butt_angle[Butt_From, Butt_to]=0      InputGrFunc ()   InputAnFunc ()   ButtwaveInputFunc ("an",1)EndFunction Butt_ColorPartFunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	variable No	 Nvar Butt_From, Butt_to	wave/t butt_color	  for (No=Butt_From ; No<=Butt_to ; No+=1)   	butt_color[No] = popStr    endfor     Butt_ColorALlInput ()End			Function Butt_ListGoffsetprocPart (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr  variable No,Goffvalue, InputOn  wave  butt_graph  Nvar Butt_From, Butt_to  sscanf popStr, "G%f", Goffvalue 	for (No=Butt_From ; No<=Butt_to ; No+=1)		ListGoffsetFunc (No,Goffvalue) // adjust graphNo by Goffset   	ButtFunc(No,"gr",butt_graph[No],InputOn)	 	endfor   	InputGrFunc () 	dowindow ButtDataSheet if (v_flag==1)  Butt_ChangeDataSheetAll () endifend	Window ButtonAnalize() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(754,262,974,849)	ModifyPanel cbRGB=(51664,44236,58982)	SetDrawLayer UserBack	DrawLine 6,25,194,25	SetDrawEnv dash= 1	DrawLine 6,186,194,186	SetDrawEnv dash= 1	DrawLine 6,213,194,213	SetDrawEnv linethick= 3	DrawLine 6,532,194,532	SetDrawEnv dash= 1	DrawLine 9,288,197,288	SetDrawEnv dash= 1	DrawLine 6,65,194,65	SetDrawEnv dash= 1	DrawLine 6,141,194,141	SetDrawEnv dash= 1	DrawLine 7,261,195,261	SetDrawEnv dash= 1	DrawLine 6,360,194,360	SetDrawEnv linethick= 3	DrawLine 6,442,194,442	SetDrawEnv dash= 1	DrawLine 6,414,194,414	SetDrawEnv dash= 1	DrawLine 7,334,195,334	DrawText 11,329,"smooth:"	SetDrawEnv dash= 1	DrawLine 7,112,195,112	Button button3,pos={58,538},size={50,20},proc=Butt_ScaleX,title="ScaleX"	Button button4,pos={8,68},size={62,20},proc=Butt_GetPeakFunc,title="Get Peak"	Button button5,pos={7,365},size={91,20},proc=Butt_GetGapFunc,title="Get Gap Nor"	SetVariable MInus,pos={11,30},size={61,18},title="-P"	SetVariable MInus,limits={0,inf,1},value= CentMinus	SetVariable Plus,pos={72,29},size={61,18},title="+P"	SetVariable Plus,limits={0,inf,1},value= CentPlus	Button Stats,pos={9,538},size={42,20},proc=ButtStats,title="Stats"	Button button7,pos={8,189},size={62,20},proc=Butt_DivFermiFunc,title="Div Fermi"	SetVariable Plus1,pos={74,191},size={70,18},title="T (K)"	SetVariable Plus1,limits={0,inf,1},value= ButtFermiTemp	Button button8,pos={77,68},size={75,20},proc=Butt_InputPeakFunc,title="Input"	Button button9,pos={8,217},size={69,20},proc=Butt_Subtruct,title="SubtOne"	SetVariable Plus2,pos={86,219},size={62,18},title="No"	SetVariable Plus2,limits={0,inf,1},value= ButtSubtractNo	Button button10,pos={8,264},size={62,20},proc=Butt_Divide,title="DivOne"	SetVariable Plus4,pos={76,266},size={62,18},title="No"	SetVariable Plus4,limits={0,inf,1},value= ButtDivideNo	SetVariable MInus1,pos={7,6},size={84,18},title="From No"	SetVariable MInus1,limits={0,inf,1},value= AnaFromNo	SetVariable Plus3,pos={91,6},size={58,18},title="to"	SetVariable Plus3,limits={0,inf,1},value= AnaToNo	Button button0,pos={156,5},size={28,20},proc=Butt_AllNo,title="All"	CheckBox Sym,pos={143,191},size={42,15},proc=Butt_AutoTempcheck,title="auto"	CheckBox Sym,value= 0	Button button1,pos={8,386},size={90,20},proc=Butt_GetGapLorFunc,title="Get Gap Lor"	Button button2,pos={26,90},size={23,20},proc=Butt_peakShow,title="S"	Button button03,pos={141,143},size={23,20},proc=Butt_areaShow,title="S"	Button button04,pos={105,365},size={23,20},proc=Butt_gapShow,title="S"	Button button05,pos={105,386},size={23,20},proc=Butt_LorgapShow,title="S"	SetVariable ButtGraph10,pos={8,513},size={77,18},disable=2,proc=ButtProc,title="Graph"	SetVariable ButtGraph10,limits={0,9999,1},value= MDC_Graph	PopupMenu EFpopup,pos={89,447},size={65,21},proc=MDCpopupOneFunc	PopupMenu EFpopup,mode=2,popvalue="_none_",value= #"\"_none_;\" + WaveList(\"wMDCone*\",\";\",\"\")"	Button button06,pos={9,447},size={75,20},proc=Butt_MDConefit,title="MDCfit one"	SetVariable ButtSlice12,pos={93,512},size={81,18},disable=2,title="E"	SetVariable ButtSlice12,value= MDC_E	PopupMenu EFpopup1,pos={89,469},size={65,21},proc=MDCpopupTwoFunc	PopupMenu EFpopup1,mode=6,popvalue="_none_",value= #"\"_none_;\" + WaveList(\"wMDCtwoS*\",\";\",\"\")"	Button button07,pos={9,469},size={75,20},proc=Butt_MDCtwofit,title="MDCfit two"	Button buttonzt,pos={9,491},size={75,20},proc=Butt_MDCtifit,title="MDCfit TI"	PopupMenu EFpopup2,pos={89,491},size={65,21},proc=MDCpopupTwoFunc	PopupMenu EFpopup2,mode=6,popvalue="_none_",value= #"\"_none_;\" + WaveList(\"wMDCtwoD*\",\";\",\"\")"	Button button11,pos={8,337},size={84,20},proc=Butt_AddSpectra,title="AddSpectra"	Button button12,pos={100,337},size={62,20},proc=Butt_AddMap,title="AddMap"	Button button13,pos={88,238},size={75,20},proc=Butt_SubtMulti,title="SubtMulti"	Button button14,pos={141,264},size={66,20},proc=Butt_DivideMulti,title="DivMulti"	CheckBox Sym2,pos={135,379},size={65,15},proc=Butt_ContinueCheck,title="continue"	CheckBox Sym2,value= 0	CheckBox Sym3,pos={135,395},size={78,15},proc=Butt_HightCheck,title="Peak Hight"	CheckBox Sym3,value= 0	Button button08,pos={171,158},size={39,20},proc=Butt_UseAreaFunc,title="Use"	CheckBox Sym4,pos={135,364},size={61,15},proc=Butt_GapvsTempCheck,title="vs temp"	CheckBox Sym4,value= 0	CheckBox Sym5,pos={102,167},size={61,15},proc=Butt_AreavsTempCheck,title="vs temp"	CheckBox Sym5,value= 0	Button button15,pos={8,238},size={70,20},proc=Butt_SubtEach,title="SubtEach"	Button button09,pos={77,90},size={75,20},proc=Butt_adjustPeakFunc,title="adjust"	PopupMenu EFpopup3,pos={136,28},size={52,21},proc=Butt_energy_point_chose	PopupMenu EFpopup3,mode=2,popvalue="point",value= #"\"point;energy\""	SetVariable MInus2,pos={10,48},size={86,18},title="-E(meV)"	SetVariable MInus2,limits={0,inf,1},value= CentMinus_E	SetVariable Plus5,pos={96,48},size={90,18},title="+E(meV)"	SetVariable Plus5,limits={0,inf,1},value= CentPlus_E	Button button16,pos={8,419},size={89,20},proc=Butt_MDCgetBack,title="MDC Lor fit"	Button button17,pos={104,419},size={75,20},proc=Butt_BackSubt,title="subt back"	Button button18,pos={108,538},size={70,20},proc=time_conv,title="time conv"	SetVariable E,pos={10,145},size={86,18},proc=Butt_GetAreaFunc_set,title="E(eV)"	SetVariable E,limits={-inf,inf,0.001},value= Butt_areaE	SetVariable E1,pos={9,165},size={88,18},proc=Butt_GetAreaFunc_set,title="dE(eV)"	SetVariable E1,limits={0,inf,0.001},value= Butt_areaDeltaE	Button button19,pos={102,144},size={35,20},proc=Butt_GetArea_Crs,title="Crs"	SetVariable Plus6,pos={58,312},size={43,18},title="1"	SetVariable Plus6,limits={0,inf,1},value= butt_2ndsmooth1	SetVariable Plus7,pos={108,312},size={43,18},title="2"	SetVariable Plus7,limits={0,inf,1},value= butt_2ndsmooth2	SetVariable Plus8,pos={157,312},size={43,18},title="3"	SetVariable Plus8,limits={0,inf,1},value= butt_2ndsmooth3	Button button20,pos={10,290},size={94,20},proc=butt_2ndderivative,title="2nd Derivative"	Button button6,pos={11,116},size={77,20},proc=Butt_EDCFWHM,title="EDC FWHM"	CheckBox Sym6,pos={108,118},size={61,15},title="vs temp"	CheckBox Sym6,variable= EDCFWHMTempCheck	Button button21,pos={9,561},size={50,20},proc=Butt_Subtruct_flip,title="flip"EndMacro	Function time_conv (ctrlName) : ButtonControl	String ctrlName	wave/t date_, time_	wave map	variable t1, t2, t3, t4, t5, t6, onemoreday	variable i, startnum, endnum	string pm1,pm2	prompt startnum "start number"	prompt endnum "end number"	doprompt "range", startnum, endnum	if (v_flag)    		return -1    	endif    	    	for(i=startnum+1; i<=endnum; i=i+1)    		onemoreday=cmpstr(date_[i-1], date_[i])    		sscanf time_[i-1], "%f:%f:%f %s", t1,t2,t3,pm1    		sscanf time_[i], "%f:%f:%f %s", t4,t5,t6,pm2    		if(onemoreday==0)    			map[i][17]=map[i-1][17]+(from12to24(t4,t5,t6,pm2)-from12to24(t1,t2,t3,pm1))/3600    		else    			map[i][17]=map[i-1][17]+(from12to24(t4,t5,t6,pm2)-from12to24(t1,t2,t3,pm1))/3600+24    		endif    	endfor		endFunction/D from12to24(t1,t2,t3,pm1)	variable t1, t2, t3	string pm1	variable h		h=cmpstr( pm1, "PM")	if(h!=0 && t1==12)		t1=t1-12	elseif(h==0 &&t1!=12)		t1=t1+12	endif		return t1*3600+t2*60+t3end			Function Butt_MDCgetBack (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar AnaFromNo, AnaToNo, Butt_of	string wavestrX, wavestrY	wave coeff, W_coef	make/o/n=5 coeff	make/o/n=(Butt_of*10) BackNo, BackVal	BackNo[]=p+1; BackVal=nan	dowindow/f Button_graph	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrX = "buttx" + num2istr(i)	   wavestrY = "buttwave" + num2istr(i)	   CurveFit/q/NTHR=0 lor  $wavestrY[pcsr(A),pcsr(B)] /X=$wavestrX /D 	  BackVal[i-1]=W_coef[0]	  removefromgraph $("fit_"+wavestrY)	 //  coeff[0,3]=W_coef[p]; coeff[4]=0   	//	 FuncFit/l=200  lorOneSlope coeff $wavestrY[pcsr(A),pcsr(B)]/X=$wavestrX /D   endfor   dowindow/f BackValGraph   if (v_flag!=1)    	PauseUpdate; Silent 1		// building window...	Display /W=(252,271,647,479) BackVal vs BackNo	ModifyGraph mode=4	ModifyGraph marker=19	ModifyGraph tick=2	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=13	ModifyGraph standoff=0	Label left "Back Value"	Label bottom "No"    dowindow/c BackValGraph   endif  endFunction lorOneSlope(w,x) :FitFunc	wave w	variable x	return   W[0]+W[1]/((x-W[2])^2+W[3])+w[4]*xEndFunction Butt_BackSubt (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar AnaFromNo, AnaToNo, Butt_of	string wavestrX, wavestrY	wave BackVal	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "buttwave" + num2istr(i)	   duplicate/o $wavestrY temp	   temp-=BackVal[i-1]	  duplicate/o temp $wavestrY    endforendFunction Butt_adjustPeakFunc (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar AnaFromNo, AnaToNo	string wavestrX	variable correctionVal	wave ButtPeak	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrX = "buttx" + num2istr(i)		 duplicate/o $wavestrX temp		 correctionVal=ButtPeak[i-1]-ButtPeak[AnaFromNo-1]		 temp[]-=correctionVal		 duplicate/o temp $wavestrX    endforendFunction Butt_energy_point_chose (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Svar Butt_EnergyPointStr Butt_EnergyPointStr= popStrEndFunction Butt_SubtEach (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar AnaFromNo, AnaToNo	string wavestrY, wavestrX	wave Butt_angle	variable MeanVal, X1, X2	  X1=hcsr(a,"Button_graph")		X2=hcsr(b,"Button_graph")	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "Buttwave" + num2istr(i)	   wavestrX = "buttx" + num2istr(i)		if (numpnts($wavestrY)!=0)		  duplicate/o $wavestrY temp		  duplicate/o $wavestrX temp1		   MeanVal=areaXY(temp1,temp,x1,x2)/(abs(X1-X2))       temp[]-=MeanVal      duplicate/o temp $wavestrY		endif   endforendFunction Butt_AreavsTempCheck (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar AreavsTempCheck	AreavsTempCheck = checked		dowindow ButtAreaGraph	if(V_flag==1)	RemoveFromGraph/W=ButtAreaGraph ButtArea			if(AreavsTempCheck==1)		appendtograph/W=ButtAreaGraph ButtArea vs ButtAreaTemp		Label bottom "\\f01T (K)"		else		appendtograph/W=ButtAreaGraph ButtArea vs ButtAreaNo  		Label bottom "\\f01Graph"		endif		ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625			Label left "Area"						SetAxis left 0,*	endifEndFunction Butt_GapvsTempCheck (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar GapvsTempCheck	GapvsTempCheck = checkedEndFunction Butt_GetAreaFunc_set(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Butt_GetAreaFunc_calc()EndFunction Butt_GetArea_Crs(ctrlName) : ButtonControl	String ctrlName	nvar butt_areaE, butt_areadeltaE		dowindow/f Button_Graph		if (v_flag!=1)			abort "Show Button_Graph"		endif	variable X1=hcsr(a,"Button_graph")	variable X2=hcsr(b,"Button_graph")	butt_areadeltaE=abs(x1-x2)/2	butt_areaE=(x1+x2)/2	Butt_GetAreaFunc_calc()endFunction Butt_GetAreaFunc_calc()	String ctrlName	string wavestrX, wavestrY	variable i, center, check, x1, x2, windex	Nvar Butt_areaE, Butt_areadeltaE	Nvar AreavsTempCheck	X1=Butt_areaE-Butt_areadeltaE	X2=Butt_areaE+Butt_areadeltaE	Nvar Butt_of, AnaFromNo, AnaToNo, AutoCursorCheck	wave Butt_graph, map//		print abs(hcsr(a)-hcsr(b))		dowindow Button_Graph		if (v_flag!=1)			abort "Show Button_Graph"		endif		 make/o/n=( Butt_of*10) ButtArea, ButtAreaNo, ButtAreaTemp		 ButtAreaTemp[]=nan 	  	ButtArea[]=nan		ButtAreaNo[]=nan	   		for (i=AnaFromNo-1 ; i<=AnaToNo-1 ; i+=1)		   windex=i+1			wavestrY = "Buttwave" + num2istr(windex)			wavestrX = "buttx" + num2istr(windex)			duplicate/o $wavestrY temp			duplicate/o $wavestrX temp1			if (numpnts(temp)!=0)			 	ButtArea[i]=areaXY(temp1,temp,x1,x2)			 	ButtAreaTemp[i]=map[Butt_graph[windex]][2]				ButtAreaNo[i] = windex			else				ButtArea[i]=nan				ButtAreaTemp[i]=nan		 		ButtAreaNo[i]=nan			endif   	endfor    end   	   	   	   	Function Butt_GetAreaFunc (ctrlName) : ButtonControl	String ctrlName	string wavestrX, wavestrY	variable i, center, check, x1, x2, windex	Nvar Butt_X1, Butt_X2, AreavsTempCheck	Nvar Butt_of, AnaFromNo, AnaToNo, AutoCursorCheck	wave Butt_graph, map		print abs(hcsr(a)-hcsr(b))		dowindow/f Button_Graph		if (v_flag!=1)			abort "Show Button_Graph"		endif	  if (AutoCursorCheck==1)		  X1=hcsr(a,"Button_graph")		  X2=hcsr(b,"Button_graph")		elseif (AutoCursorCheck==0)		  X1=Butt_X1; X2=Butt_X2		  Prompt X1 , "start E(eV)"	 		Prompt X2, "end E(eV)"   		Doprompt "Energy range setting", X1,X2    if (V_Flag)   	  return -1// User canceled   	endif   	Butt_X1=X1; Butt_X2=X2		endif		 make/o/n=( Butt_of*10) ButtArea, ButtAreaNo, ButtAreaTemp		 ButtAreaTemp[]=nan 	  	ButtArea[]=nan			ButtAreaNo[]=nan	   		//for (i=1 ; i<=(Butt_of*10) ; i+=1)		for (i=AnaFromNo-1 ; i<=AnaToNo-1 ; i+=1)		   windex=i+1			wavestrY = "Buttwave" + num2istr(windex)			wavestrX = "buttx" + num2istr(windex)			duplicate/o $wavestrY temp			duplicate/o $wavestrX temp1			if (numpnts(temp)!=0)			 	ButtArea[i]=areaXY(temp1,temp,x1,x2)			 	ButtAreaTemp[i]=map[Butt_graph[windex]][2]				ButtAreaNo[i] = windex			else				ButtArea[i]=nan				ButtAreaTemp[i]=nan		 		ButtAreaNo[i]=nan			endif   	endfor   dowindow/f ButtAreaTable   if (V_flag==0)       edit ButtAreaNo, ButtArea        dowindow/c ButtAreaTable   endif      if (AreavsTempCheck!=1)       dowindow/f ButtAreaGraph   if (V_flag==0)      display ButtArea vs ButtAreaNo        dowindow/c ButtAreaGraph      ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625			Label left "Area"			Label bottom "No" 			SetAxis left 0,*   endif     elseif (AreavsTempCheck==1)        dowindow/f ButtAreaGraph    if (V_flag==0)    PauseUpdate; Silent 1		// building window...			Display /W=(53,69,441,460) ButtArea vs ButtAreaTemp 	  dowindow/c ButtAreaGraph       dowindow/c ButtAreaGraph      ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625			Label left "Area"			Label bottom "Temperature (K)"			SetAxis left 0,*	//	AppendToGraph/L=VertCrossing/B=HorizCrossing ButtArea vs ButtAreaTemp 	//	ModifyGraph mode(ButtArea#1)=4,marker(ButtArea#1)=19//    ModifyGraph mode=4,marker=19,rgb(ButtArea)=(0,0,65535) //   Label VertCrossing "Area";DelayUpdate//	  Label HorizCrossing "Temperature (K)"//	  Label left "Area";DelayUpdate//  	Label bottom "No"//		ModifyGraph lSize(ButtArea)=2//		ModifyGraph tick=2//		ModifyGraph minor=1//		ModifyGraph fSize=15//		ModifyGraph standoff=0//		ModifyGraph axOffset(left)=-2.57143,axOffset(bottom)=-0.8//		ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37//		ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}//		ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}//		ModifyGraph tickZap(VertCrossing)={0}//		ModifyGraph tickZap(HorizCrossing)={0}//		ModifyGraph axisEnab(left)={0,0.41}//		ModifyGraph axisEnab(VertCrossing)={0.59,1}		endif	endif   endFunction Butt_UseAreaFunc (ctrlName) : ButtonControl	String ctrlName	variable i, windex	Nvar AnaFromNo, AnaToNo	string wavestrY	wave  ButtArea	for (i=AnaFromNo-1 ; i<=AnaToNo-1 ; i+=1)	  if (stringmatch(num2str(ButtArea[i]),"nan")!=1)		  windex=i+1				wavestrY = "Buttwave" + num2istr(windex)		  duplicate/o $wavestrY temp		  temp[]/=ButtArea[i]		  duplicate/o temp $wavestrY 		endif  endforend	Function Butt_HightCheck (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar HightCheck	HightCheck = checkedEndFunction Butt_AutoCursorCheck (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar AutoCursorCheck	AutoCursorCheck = checkedEndFunction Butt_ContinueCheck (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar ContinueCheck	ContinueCheck = checkedEndFunction Butt_DivideMulti (ctrlName) : ButtonControl	String ctrlName	string A_from, A_to, B_from, B_to, A_fromList="", A_toList="", B_fromList="", B_toList=""	string wavestrY0, wavestrX0, wavestrY1, wavestrX1	variable pase0, pase1, No0, No1, i	Nvar Butt_of	 for (i=1; i<=Butt_of; i+=1)	   A_fromList += ";"+num2str(i)	   A_toList += ";"+num2str(i)	   B_fromList += ";"+num2str(i)	   B_toList += ";"+num2str(i)	 endfor 	 	  A_from = StrVarOrDefault("AFromStr", "1") 	  A_to = StrVarOrDefault("AToStr", "1") 	  B_from = StrVarOrDefault("BFromStr", "1") //	  B_to = StrVarOrDefault("AToStr", "1")	 Prompt A_from , "A: From? (page)", popup ,A_fromList	 Prompt A_to, "A: To? (page)", popup ,A_toList   Prompt B_from, "B: From? (page)", popup ,B_fromList//   Prompt B_to, "B: To? (page)", popup ,B_toList   Doprompt "A - B: ButtWave Sbstraction", A_from, A_to, B_from//, B_to    if (V_Flag)   	  return -1// User canceled   	endif   String/G AFromStr = A_from   String/G AToStr = A_to   String/G BFromStr = B_from //  String/G AToStr = A_to    pase1=str2num(B_from)	for (pase0=str2num(A_from)  ; pase0<=str2num(A_to) ; pase0+=1)	 for (i=1; i<=10 ; i+=1)	  No0 = (pase0-1)*10 + i	  No1 = (pase1-1)*10 + i	//  print "pase0,No0  ", pase0, No0, "; pase0,No1  ", pase1,  No1	   wavestrY0 = "Buttwave" + num2istr(No0)	   wavestrX0 = "Buttx" + num2istr(No0)	   wavestrY1 = "Buttwave" + num2istr(No1)	   wavestrX1 = "Buttx" + num2istr(No1)		if (numpnts($wavestrY0)!=0 && numpnts($wavestrY1)!=0)		  duplicate/o $wavestrY0, temp, subwave0		  duplicate/o $wavestrX0, temp1		  duplicate/o $wavestrY1, temp2, subwave1		  duplicate/o $wavestrX1, temp3		  subwave0[] = temp[p]/interp(temp1[p],temp3,temp2)		  subwave1[] = temp2[p]/interp(temp3[p],temp3,temp2)      duplicate/o subwave0, $wavestrY0      duplicate/o subwave1, $wavestrY1		endif	 endfor 	  pase1+=1  endfor   killwaves subwave0, subwave1endFunction Butt_SubtMulti (ctrlName) : ButtonControl	String ctrlName	string A_from, A_to, B_from, B_to, A_fromList="", A_toList="", B_fromList="", B_toList=""	string wavestrY0, wavestrX0, wavestrY1, wavestrX1	variable pase0, pase1, No0, No1, i	Nvar Butt_of	 for (i=1; i<=Butt_of; i+=1)	   A_fromList += ";"+num2str(i)	   A_toList += ";"+num2str(i)	   B_fromList += ";"+num2str(i)	   B_toList += ";"+num2str(i)	 endfor 	 	  A_from = StrVarOrDefault("AFromStr", "1") 	  A_to = StrVarOrDefault("AToStr", "1") 	  B_from = StrVarOrDefault("BFromStr", "1") //	  B_to = StrVarOrDefault("AToStr", "1")	 Prompt A_from , "A: From? (page)", popup ,A_fromList	 Prompt A_to, "A: To? (page)", popup ,A_toList   Prompt B_from, "B: From? (page)", popup ,B_fromList//   Prompt B_to, "B: To? (page)", popup ,B_toList   Doprompt "A - B: ButtWave Sbstraction", A_from, A_to, B_from//, B_to    if (V_Flag)   	  return -1// User canceled   	endif   String/G AFromStr = A_from   String/G AToStr = A_to   String/G BFromStr = B_from //  String/G AToStr = A_to    pase1=str2num(B_from)	for (pase0=str2num(A_from)  ; pase0<=str2num(A_to) ; pase0+=1)	 for (i=1; i<=10 ; i+=1)	  No0 = (pase0-1)*10 + i	  No1 = (pase1-1)*10 + i	//  print "pase0,No0  ", pase0, No0, "; pase0,No1  ", pase1,  No1	   wavestrY0 = "Buttwave" + num2istr(No0)	   wavestrX0 = "Buttx" + num2istr(No0)	   wavestrY1 = "Buttwave" + num2istr(No1)	   wavestrX1 = "Buttx" + num2istr(No1)		if (numpnts($wavestrY0)!=0 && numpnts($wavestrY1)!=0)		  duplicate/o $wavestrY0, temp, subwave0		  duplicate/o $wavestrX0, temp1		  duplicate/o $wavestrY1, temp2, subwave1		  duplicate/o $wavestrX1, temp3		  subwave0[] = temp[p]-interp(temp1[p],temp3,temp2)		  subwave1[] = temp2[p]-interp(temp3[p],temp3,temp2)      duplicate/o subwave0, $wavestrY0      duplicate/o subwave1, $wavestrY1		endif	 endfor 	  pase1+=1  endfor   killwaves subwave0, subwave1endfunction Butt_AddMap  (ctrlName): ButtonControl	String ctrlName	Nvar AnaFromNo, AnaToNo   variable i, f   variable num, NumMean, Addnum, est, de	string  name, result = "AddMap", Xaxis, Yes_No	wave ButtPeak, map, butt_graph	 i = butt_graph[AnaFromNo]	 f = butt_graph[AnaToNo]	 num = AnaFromNo-1	 Prompt Yes_No, "Did you get ButtPeak?", popup ,"Yes"+";No"	 Prompt i "Start Graph: "   Prompt f, "End Graph: "    Doprompt "AddMap info", Yes_No, i, f    if (V_Flag)   	  return -1// User canceled   	endif   	   if (stringmatch(Yes_No,"No"))    	abort "Get ButtPeak first!"   endif        name = "nr"+num2str(i)    duplicate/o $name temp1    temp1[][]=0    NumMean = mean(ButtPeak,AnaFromNo-1,AnaToNo-1)    Xaxis = "gx"+num2istr(i)    duplicate /o $Xaxis tempX  	     tempX -=map[i][7]    	est = tempX[0]	  de = tempX[1]-est     SetScale/P x est,de,"", temp1	for  (i = i ; i <= f ; i+=1)    name = "nr"+num2str(i)    duplicate/o $name temp2    temp1[][]+=temp2[p][q+(ButtPeak[num]-NumMean)]    num+=1    Addnum+=1	endfor    temp1[][]/=Addnum    duplicate/o temp1 $result   dowindow/f AddMapPanel   if (v_flag!=1)		PauseUpdate; Silent 1		// building window...		Display /W=(201,221,548,709)		dowindow/c AddMapPanel		AppendImage $result		ModifyImage $result ctab= {*,*,Rainbow,1}		ModifyGraph tick=2		ModifyGraph zero(bottom)=3		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=16		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-0.25,axOffset(bottom)=-2.75		Label left "Slice"		Label bottom "Energy (eV)"		ModifyGraph swapXY=1  endifendFunction Butt_AddSpectra (ctrlName): ButtonControl	String ctrlName	variable i, Num	Nvar ButtSubtractNo, AnaFromNo, AnaToNo	string wavestrY, wavestrX	wavestrY = "Buttwave" + num2istr(AnaFromNo)	wavestrX = "Buttx" + num2istr(AnaFromNo)  duplicate/o $wavestrY ButtwaveAdd_y  ButtwaveAdd_y[]=0  duplicate/o $wavestrX ButtwaveAdd_x	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "Buttwave" + num2istr(i)		if (numpnts($wavestrY)!=0)			  duplicate/o $wavestrY temp		  ButtwaveAdd_y[]+=temp[p]		  Num+=1		endif  endfor  ButtwaveAdd_y[]/=Num  dowindow/f ButtAdd  if (V_flag!=1)  	PauseUpdate; Silent 1		// building window...	Display /W=(245,265,685,526) ButtwaveAdd_y vs ButtwaveAdd_x	dowindow/c ButtAdd	ModifyGraph tick=2	ModifyGraph zero(bottom)=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-3.75,axOffset(bottom)=-0.5	Label left "Intensity (arb. units)"	Label bottom "Energy (eV)" endifendFunction Butt_Subtruct (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar Butt_of, ButtSubtractNo, AnaFromNo, AnaToNo	string wavestrY	wave Butt_angle	wavestrY = "Buttwave" + num2istr(ButtSubtractNo)   duplicate/o $wavestrY SubWave	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "Buttwave" + num2istr(i)		if (numpnts($wavestrY)!=0)	   //	ButtFunc(i,"an",butt_angle[i],1)			  duplicate/o $wavestrY temp       temp[]-=SubWave[p]      duplicate/o temp $wavestrY		endif   endfor   killwaves subwaveendFunction Butt_Subtruct_rev (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar Butt_of, ButtSubtractNo, AnaFromNo, AnaToNo	string wavestrY	wave Butt_angle	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "Buttwave" + num2istr(i)		if (numpnts($wavestrY)!=0)		  duplicate/o $wavestrY temp      		 temp[]*=-1      		duplicate/o temp $wavestrY		endif   endforendFunction MDCpopupOneFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	wave map  variable  Graph  if (stringmatch(popStr,"_none_"))   return -1// User canceled   endif  sscanf popStr, "wMDCone%f", Graph		Butt_MDCfitShow_OnePopup (Graph)EndFunction Butt_MDCfitShow_OnePopup (Graph)   variable Graph   string panelname   string dMDC, wMDC, enMDC, paneltext1, paneltext2   variable MDCone_Ei, MDCone_Ef   wave ddMDCone, wwMDCone, eneMDCone   variable waveLeng, i, j    panelname="MDCfitOnePanel"   dMDC = "dMDCone" + num2str(Graph)   wMDC = "wMDCone" + num2str(Graph)   enMDC = "enMDCone"+num2str(Graph)   duplicate/o $dMDC ddMDCone   duplicate/o $wMDC wwMDCone   duplicate/o $enMDC eneMDCone   paneltext1="\\Z16dMDCone"+num2str(Graph)   paneltext2="\\Z16wMDCone"+num2str(Graph)   dowindow/f $panelname   if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(168,88,464,596) wwMDCone vs eneMDCone	dowindow/c $panelname	AppendToGraph/L=VertCrossing/B=HorizCrossing eneMDCone vs ddMDCone	ModifyGraph mode=4,mode=4,marker=19	ModifyGraph rgb(wwMDCone)=(9,37552,0)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=0.428571,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.35}	ModifyGraph axisEnab(VertCrossing)={0.45,1}	ModifyGraph standoff=0	 ModifyGraph standoff=1		 Label VertCrossing "Energy (eV)";DelayUpdate   Label HorizCrossing "Slice";DelayUpdate    Label left "dk (Slice)";DelayUpdate   Label bottom "Energy (eV)";DelayUpdate  endif  	TextBox/C/N=auw/F=0/A=MC/X=-23.76/Y=-22.05 paneltext1	TextBox/C/N=aup/F=0/A=MC/X=-23.76/Y=47.82 paneltext2   waveLeng = numpnts(eneMDCone)    for (i=0 ; i<waveLeng ; i+=1)    if (stringmatch(num2str(ddMDCone[i]),"nan")!=1)      MDCone_Ef=eneMDCone[i]      break    endif  endfor  for (j=i ; j<waveLeng ; j+=1)    if (stringmatch(num2str(ddMDCone[j]),"nan")==1)       MDCone_Ei=eneMDCone[j-1]      break    endif  endfor  SetAxis bottom  MDCone_Ef-0.05,  MDCone_Ei+0.05  SetAxis VertCrossing MDCone_Ef-0.05,  MDCone_Ei+0.05EndMacroFunction MDCpopupTwoFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	String S_or_D	wave map variable  Graph string strGraph  if (stringmatch(popStr,"_none_"))   return -1// User canceled   endif  S_or_D = popStr[7]  strGraph = popStr[8,strlen(popStr)-1]  sscanf strGraph, "%f", Graph	 if (stringmatch(S_or_D,"S"))	 Butt_MDCfitShow_TwoSinglePopup (Graph) elseif (stringmatch(S_or_D,"D"))   Butt_MDCfitShow_TwoDoublePopup (Graph) endifEndFunction Butt_MDCfitShow_TwoDoublePopup (Graph)   variable Graph   string l_or_r   string panelname   string dMDC_l,dMDC_r, wMDC_l, wMDC_r, enMDC, paneltext1, paneltext2   variable MDCtwoD_Ei, MDCtwoD_Ef   variable waveLeng, i, j    panelname="MDCfitTwoDoublePanel"   dMDC_l = "dMDCtwoD" + num2str(Graph)+"_l"   dMDC_r = "dMDCtwoD" + num2str(Graph)+"_r"   wMDC_l = "wMDCtwoD" + num2str(Graph)+"_l"   wMDC_r = "wMDCtwoD" + num2str(Graph)+"_r"   enMDC = "enMDCtwoD"+num2str(Graph)   duplicate/o $dMDC_l ddMDCtwoD_l   duplicate/o $dMDC_r ddMDCtwoD_r   duplicate/o $wMDC_l wwMDCtwoD_l   duplicate/o $wMDC_r wwMDCtwoD_r    duplicate/o $enMDC eneMDCtwoD   paneltext1="\\Z16dMDCtwoD"+num2str(Graph)   paneltext2="\\Z16wMDCtwoD"+num2str(Graph)   dowindow/f $panelname   if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(168,88,464,596) wwMDCtwoD_l vs eneMDCtwoD	appendtograph wwMDCtwoD_r vs eneMDCtwoD	dowindow/c $panelname	AppendToGraph/L=VertCrossing/B=HorizCrossing eneMDCtwoD vs ddMDCtwoD_l	AppendToGraph/L=VertCrossing/B=HorizCrossing eneMDCtwoD vs ddMDCtwoD_r	ModifyGraph mode=4,mode=4,marker=19	ModifyGraph rgb(wwMDCtwoD_l)=(0,0,65535)	ModifyGraph rgb(eneMDCtwoD)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=0.428571,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.35}	ModifyGraph axisEnab(VertCrossing)={0.45,1}	ModifyGraph standoff=0	 ModifyGraph standoff=1		 Label VertCrossing "Energy (eV)";DelayUpdate   Label HorizCrossing "Slice";DelayUpdate    Label left "dk (Slice)";DelayUpdate   Label bottom "Energy (eV)";DelayUpdate  endif  	TextBox/C/N=auw/F=0/A=MC/X=-23.76/Y=-22.05 paneltext1	TextBox/C/N=aup/F=0/A=MC/X=-23.76/Y=47.82 paneltext2   waveLeng = numpnts(eneMDCtwoD)    for (i=0 ; i<waveLeng ; i+=1)    if (stringmatch(num2str(wwMDCtwoD_l[i]),"nan")!=1)      MDCtwoD_Ef=eneMDCtwoD[i]      break    endif  endfor  for (j=i ; j<waveLeng ; j+=1)    if (stringmatch(num2str(wwMDCtwoD_l[j]),"nan")==1)       MDCtwoD_Ei=eneMDCtwoD[j-1]      break    endif  endfor  SetAxis bottom  MDCtwoD_Ef-0.05,  MDCtwoD_Ei+0.05  SetAxis VertCrossing MDCtwoD_Ef-0.05,  MDCtwoD_Ei+0.05EndMacroFunction Butt_MDCfitShow_TwoSinglePopup (Graph)   variable Graph   string l_or_r   string panelname   string dMDC_l,dMDC_r, wMDC, enMDC, paneltext1, paneltext2   variable MDCtwoS_Ei, MDCtwoS_Ef   variable waveLeng, i, j    panelname="MDCfitTwoSinglePanel"   dMDC_l = "dMDCtwoS" + num2str(Graph)+"_l"   dMDC_r = "dMDCtwoS" + num2str(Graph)+"_r"   wMDC = "wMDCtwoS" + num2str(Graph)   enMDC = "enMDCtwoS"+num2str(Graph)   duplicate/o $dMDC_l ddMDCtwoS_l   duplicate/o $dMDC_r ddMDCtwoS_r   duplicate/o $wMDC wwMDCtwoS     duplicate/o $enMDC eneMDCtwoS   paneltext1="\\Z16dMDCtwoS"+num2str(Graph)   paneltext2="\\Z16wMDCtwoS"+num2str(Graph)   dowindow/f $panelname   if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(168,88,464,596) wwMDCtwoS vs eneMDCtwoS	dowindow/c $panelname	AppendToGraph/L=VertCrossing/B=HorizCrossing eneMDCtwoS vs ddMDCtwoS_l	AppendToGraph/L=VertCrossing/B=HorizCrossing eneMDCtwoS vs ddMDCtwoS_r	ModifyGraph mode=4,mode=4,marker=19	ModifyGraph rgb(wwMDCtwoS)=(9,37552,0)	ModifyGraph rgb(eneMDCtwoS)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=0.428571,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.35}	ModifyGraph axisEnab(VertCrossing)={0.45,1}	ModifyGraph standoff=0	 ModifyGraph standoff=1		 Label VertCrossing "Energy (eV)";DelayUpdate   Label HorizCrossing "Slice";DelayUpdate    Label left "dk (Slice)";DelayUpdate   Label bottom "Energy (eV)";DelayUpdate  endif  	TextBox/C/N=auw/F=0/A=MC/X=-23.76/Y=-22.05 paneltext1	TextBox/C/N=aup/F=0/A=MC/X=-23.76/Y=47.82 paneltext2   waveLeng = numpnts(eneMDCtwoS)    for (i=0 ; i<waveLeng ; i+=1)    if (stringmatch(num2str(wwMDCtwoS[i]),"nan")!=1)      MDCtwoS_Ef=eneMDCtwoS[i]      break    endif  endfor  for (j=i ; j<waveLeng ; j+=1)    if (stringmatch(num2str(wwMDCtwoS[j]),"nan")==1)       MDCtwoS_Ei=eneMDCtwoS[j-1]      break    endif  endfor  SetAxis bottom  MDCtwoS_Ef-0.05,  MDCtwoS_Ei+0.05  SetAxis VertCrossing MDCtwoS_Ef-0.05,  MDCtwoS_Ei+0.05EndMacroFunction Butt_MDConefit_back (ctrlName) : ButtonControl	String ctrlName	Nvar MDCone_Ei, MDCone_Ef, MDCone_mP0, MDCone_P0, MDCone_mP1, MDCone_P1, MDC_Graph, MDC_E	string nameA, nameB	wave Butt_graph	variable No, waveleng, Graph	variable Ei, Ef, P0, P1, mP0, mP1	nameA = csrwave(a,"button_graph")	if (stringmatch(nameA,"")==1)  	 abort "Set corsol a to the peak position !"  	endif		Ei=MDCone_Ei; Ef=MDCone_Ef; mP0=MDCone_mP0; P0=MDCone_P0; mP1=MDCone_mP1; P1=MDCone_P1	Prompt Ei, "Initial Energy"	prompt Ef, "Final Energy"	prompt mP0, "-P0"	prompt P0, "+P0"	prompt mP1, "-P1"	prompt P1, "+P1"  	Doprompt "MDC analysis", Ei, Ef, mP0, P0, mP1, P1  	if (V_Flag)   			return -1// User canceled   	endif   	MDCone_Ei=Ei; MDCone_Ef=Ef; MDCone_mP0=mP0; MDCone_P0=P0; MDCone_mP1=mP1; MDCone_P1=P1  	waveleng = strlen(nameA)  	No = str2num(nameA[waveleng-1])  Graph = Butt_graph[No]  MDC_Graph = Graph  variable /g v_fitoptions=4 	 Butt_MDConefitFunc (Graph,No,nameA)   v_fitoptions=0 	  Butt_MDConefitShow (Graph)  EndFunction Butt_MDConefit (ctrlName) : ButtonControl	String ctrlName	Nvar MDCone_Ei, MDCone_Ef, MDCone_mP0, MDCone_P0, MDCone_mP1, MDCone_P1, MDC_Graph, MDC_E, MDCgraphi, MDCgraphf	string nameA, nameB	wave Butt_graph	variable No, waveleng, Graph_i, Graph_f	variable Ei, Ef, P0, P1, mP0, mP1	nameA = csrwave(a,"button_graph")	waveleng = strlen(nameA)  	No = str2num(nameA[waveleng-1])	Graph_i = Butt_graph[No]	Graph_f = Butt_graph[No]	if (stringmatch(nameA,"")==1)  	 abort "Set corsol a to the peak position !"  	endif		Ei=MDCone_Ei; Ef=MDCone_Ef; mP0=MDCone_mP0; P0=MDCone_P0; mP1=MDCone_mP1; P1=MDCone_P1	Prompt Graph_i, "Initial Graph"	Prompt Graph_f, "Final Graph"	Prompt Ei, "Initial Energy"	prompt Ef, "Final Energy"	prompt mP0, "-P0"	prompt P0, "+P0"	prompt mP1, "-P1"	prompt P1, "+P1"  	Doprompt "MDC analysis", Graph_i, Graph_f, Ei, Ef, mP0, P0, mP1, P1  	if (V_Flag)   			return -1// User canceled   	endif   	MDCone_Ei=Ei; MDCone_Ef=Ef; MDCone_mP0=mP0; MDCone_P0=P0; MDCone_mP1=mP1; MDCone_P1=P1; MDCgraphf=Graph_f;  MDCgraphi=Graph_i 	 for (Graph_i=Graph_i; Graph_i<=Graph_f; Graph_i+=1)     		MDC_Graph = Graph_i   		variable /g v_fitoptions=4 	 	Butt_MDConefitFunc (Graph_i,No,nameA)   		v_fitoptions=0 	  	Butt_MDConefitShow (Graph_i)  	endfor  EndFunction Butt_MDConefitFunc (graph,No,name)	variable graph,No	string name	string namex="buttx"+name[8, strlen(name)-1]	string fit_name	Nvar MDCone_Ei, MDCone_Ef, MDCone_mP0, MDCone_P0, MDCone_mP1, MDCone_P1,MDCone_Graph, MDC_E	svar dispwave	variable fitoffset,fitdelta	if(stringmatch(dispwave, "ek")==1)		duplicate/o $namex temp		fitoffset=temp[0]		fitdelta=temp[1]-temp[0]	else	 	fitoffset=0		 fitdelta=1	endif		string destdispd,destdispw, enerwave	string destwidth, destArea	string destback,destslope	variable i,kpoints,epoints,center,NoFitCh=29,chan, starta,startb, enstep	WAVE nil, w_coef, temp2, Butt_offset	fit_name = "fit_"+name	destdispd = "dMDCone"+num2istr(graph) 	destwidth = "wMDCone"+num2istr(graph)	destArea = "aMDCone"+num2istr(graph) 	enerwave="enMDCone"+num2istr(graph)       epoints = GetGraphDim(graph,0)	kpoints = GetGraphDim(graph,1)   	make /o /n=(epoints) mdcfitd, mdcfitw, mdcArea	mdcfitd = nil; mdcfitw = nil; mdcArea = nil;   	 i = MDCone_Ei	dowindow /f Button_Graph	starta = pcsr(A,"button_graph")	center=starta		do	   	MDC_E = i		butt_MDC(No,graph,i)			findlevel/q temp2,i		chan = V_levelX 		enstep=temp2[2]-temp2[1]		curvefit /Q=1/NTHR=0  lor $name[center-MDCone_mP0-abs(i*MDCone_mP1), center+MDCone_P0+abs(i*MDCone_P1)] /x=$namex /d			ModifyGraph/w=button_graph offset($fit_name)={0,Butt_offset[No]}     		center=w_coef[2]		mdcfitd[chan] = (w_coef[2])     		mdcfitw[chan] =sqrt(w_coef[3])*2 //from HWHM to FWHM		mdcArea[chan] = w_coef[1]/sqrt(w_coef[3])		center=round((center-fitoffset)/fitdelta)    		i -= enstep				duplicate /o temp2 $enerwave		duplicate /o mdcfitd $destdispd	   	duplicate /o mdcfitw $destwidth	   	duplicate /o mdcArea $destArea	while( i >= MDCone_Ef )	//	removefromgraph/w=button_graph $fit_nameEndFunction Butt_MDConefitShow (Graph)   variable Graph   string panelname   string dMDC, wMDC, enMDC, paneltext1, paneltext2   Nvar MDCone_Ei, MDCone_Ef   panelname="MDCone"+num2str(Graph)+"_panel"   dMDC = "dMDCone" + num2str(Graph)   wMDC = "wMDCone" + num2str(Graph)   enMDC = "enMDCone"+num2str(Graph)   paneltext1="\\Z16"+wMDC   paneltext2="\\Z16"+dMDC   dowindow/f $panelname   if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(168,88,464,596) $wMDC vs $enMDC	dowindow/c $panelname	AppendToGraph/L=VertCrossing/B=HorizCrossing $enMDC vs $dMDC	ModifyGraph mode($wMDC)=4,mode($enMDC)=4	ModifyGraph marker($wMDC)=19,marker($enMDC)=19	ModifyGraph rgb($wMDC)=(9,37552,0)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=0.428571,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.35}	ModifyGraph axisEnab(VertCrossing)={0.45,1}	ModifyGraph standoff=0	TextBox/C/N=auw/F=0/A=MC/X=-23.76/Y=-22.05 paneltext1	TextBox/C/N=aup/F=0/A=MC/X=-23.76/Y=47.82 paneltext2	 ModifyGraph standoff=1		 Label VertCrossing "Energy (eV)";DelayUpdate   Label HorizCrossing "Slice";DelayUpdate    Label left "FWHM (Slice)";DelayUpdate   Label bottom "Energy (eV)";DelayUpdate  endif  	svar dispwave  	if(stringmatch(dispwave, "ek")==1)  	Label HorizCrossing "K// (A\\S-1\\M)";DelayUpdate  	Label left "FWHM (A\\S-1\\M)";DelayUpdate  	else  	Label HorizCrossing "Slice";DelayUpdate  	Label left "FWHM (Slice)";DelayUpdate  	endif  	print  wMDC,"vs", enMDC  	print enMDC, "vs", dMDC  SetAxis bottom  MDCone_Ef-0.05,  MDCone_Ei+0.05  SetAxis VertCrossing MDCone_Ef-0.05,  MDCone_Ei+0.05EndMacroFunction Butt_MDCtwofit (ctrlName) : ButtonControl	String ctrlName	Nvar MDCtwo_Ei, MDCtwo_Ef, MDCtwo_mP0, MDCtwo_P0, MDCtwo_mP1, MDCtwo_P1, MDC_Graph, MDC_E, MDCgraphf, MDCgraphi	Svar MDCtwo_mP0_OneorTwo	string nameA, nameB, OneorTwo	wave Butt_graph	variable No, waveleng, Graph, Graph_i, Graph_f	variable Ei, Ef, P0, P1, mP0, mP1	string destdispd_l,destdispd_r, enerwave, destwidth	wave w_coef, w_coef_l, w_coef_r, w_polyroots	variable dirac_en, i, dirac_width	wave map	nameA = csrwave(a,"button_graph")   	nameB = csrwave(b,"button_graph")   	waveleng = strlen(nameA)     	No = str2num(nameA[waveleng-1])  //   	print nameA//     	print No	Graph_i = Butt_graph[No]	Graph_f = Butt_graph[No]		if (stringmatch(nameA,"")==1 || stringmatch(nameB,"")==1)  	 abort "Set corsol a and b to the peak positions !"  	endif  	Ei=MDCtwo_Ei; Ef=MDCtwo_Ef; mP0=MDCtwo_mP0; P0=MDCtwo_P0; mP1=MDCtwo_mP1; P1=MDCtwo_P1  	OneorTwo=MDCtwo_mP0_OneorTwo  	Prompt Graph_i, "Initial Graph"	Prompt Graph_f, "Final Graph"	Prompt Ei, "Initial Energy"	prompt Ef, "Final Energy"	prompt mP0, "-P0"	prompt P0, "+P0"	prompt mP1, "-P1"	prompt P1, "+P1"	Prompt OneorTwo, "Single or Double Width", popup, "Single" + ";Double" + ";TI"  	Doprompt "MDC analysis", Graph_i, Graph_f, Ei, Ef, mP0, P0, mP1, P1, OneorTwo  	if (V_Flag)   			return -1// User canceled   	endif   	MDCtwo_Ei=Ei; MDCtwo_Ef=Ef; MDCtwo_mP0=mP0; MDCtwo_P0=P0; MDCtwo_mP1=mP1; MDCtwo_P1=P1; MDCgraphf=Graph_f;  MDCgraphi=Graph_i  	MDCtwo_mP0_OneorTwo=OneorTwo  	MDC_Graph = Graph  	Graph = Graph_i  	    do  variable /g v_fitoptions=4  if (stringmatch(OneorTwo"single")) 	 Butt_MDCtwofitFunc_single (Graph,No,nameA)   v_fitoptions=0 	 Butt_MDCtwofitShow_single (Graph)    	elseif (stringmatch(OneorTwo"double")) 	 Butt_MDCtwofitFunc_double (Graph,No,nameA)   v_fitoptions=0 	 Butt_MDCtwofitShow_double (Graph)    	   	 elseif (stringmatch(OneorTwo"TI")) 	 Butt_MDCtwofitFunc_single (Graph,No,nameA)   v_fitoptions=0 	 Butt_MDCtwofitShow_single (Graph)    	   	endif if (stringmatch(OneorTwo"TI")) 	destdispd_l = "dMDCtwoS"+num2istr(graph)+"_l"	destdispd_r = "dMDCtwoS"+num2istr(graph)+"_r"	enerwave="enMDCtwoS"+num2istr(graph) 	destwidth = "wMDCtwoS"+num2istr(graph)//	curvefit /q poly 3, $enerwave /x=$destdispd_l	curvefit /q line, $enerwave /x=$destdispd_l	duplicate/o w_coef, w_coef_l//	curvefit /q poly 3, $enerwave /x=$destdispd_r	curvefit /q line, $enerwave /x=$destdispd_r	duplicate/o w_coef, w_coef_r	dirac_en=(w_coef_l[0]*w_coef_r[1]-w_coef_l[1]*w_coef_r[0])/(w_coef_r[1]-w_coef_l[1])//	print dirac_en	map[graph][15]=dirac_en	curvefit /q poly 5, $enerwave /x=$destwidth	findroots /p=w_coef	for(i=0;i<4;i=i+1)		if(imag(w_polyroots[i])==0 && real(w_polyroots[i])<6 && real(w_polyroots[i])>2)		dirac_width=real(w_polyroots[i])		endif	endfor	map[graph][16]=dirac_widthendifGraph=Graph+1while(Graph<Graph_f+1)EndFunction Butt_MDCtifit (ctrlName) : ButtonControl	String ctrlName	Nvar MDCtwo_Ei, MDCtwo_Ef, MDCtwo_mP0, MDCtwo_P0, MDCtwo_mP1, MDCtwo_P1, MDC_Graph	variable Graph, startA, startB	string destdispd_l,destdispd_r, enerwave, destwidth	wave w_coef, w_coef_l, w_coef_r, w_polyroots	variable dirac_en, i, dirac_width	wave map 	MDCtwo_Ei=0 	MDCtwo_Ef=-0.17 	MDCtwo_mP0=40 	MDCtwo_P0=34 	MDCtwo_mP1=31 	MDCtwo_P1=40  	startA=91  	startB=165 for (i=608;i<640;i=i+1) 	Graph =i 	MDC_Graph = Graph	 variable /g v_fitoptions=4 	Butt_MDCtifitFunc_single (Graph,startA,startB)	v_fitoptions=0   	destdispd_l = "dMDCtwoS"+num2istr(graph)+"_l"	destdispd_r = "dMDCtwoS"+num2istr(graph)+"_r"	enerwave="enMDCtwoS"+num2istr(graph) 	destwidth = "wMDCtwoS"+num2istr(graph)	curvefit /q line, $enerwave /x=$destdispd_l	duplicate/o w_coef, w_coef_l	curvefit /q line, $enerwave /x=$destdispd_r	duplicate/o w_coef, w_coef_r	dirac_en=(w_coef_l[0]*w_coef_r[1]-w_coef_l[1]*w_coef_r[0])/(w_coef_r[1]-w_coef_l[1])	print dirac_en	map[graph][15]=dirac_enendforEndFunction Butt_MDCtwofitFunc_double (graph,No,name)	variable graph,No	string name	string fit_name,fit_name_l,fit_name_r	Nvar MDCtwo_Ei, MDCtwo_Ef, MDCtwo_mP0, MDCtwo_P0, MDCtwo_mP1, MDCtwo_P1,MDCtwo_Graph, MDC_E	string destdispd_l,destdispd_r, enerwave, destwidth_l, destwidth_r, destArea_l, destArea_r	variable i,kpoints,epoints,centerA,centerB,NoFitCh=29,chan, starta,startb, enstep	WAVE nil, w_coef, temp2, Butt_offset, coeff	variable fitoffset,fitdelta	string namex="buttx"+name[8, strlen(name)-1]	svar dispwave	if(stringmatch(dispwave, "ek")==1)		duplicate/o $namex temp		fitoffset=temp[0]		fitdelta=temp[1]-temp[0]	else	 	fitoffset=0		 fitdelta=1	endif	print namex		fit_name = "fit_"+name	destdispd_l = "dMDCtwoD"+num2istr(graph)+"_l"	destdispd_r = "dMDCtwoD"+num2istr(graph)+"_r"	destArea_l = "aMDCtwoD"+num2istr(graph)+"_l"	destArea_r = "aMDCtwoD"+num2istr(graph)+"_r"	  destwidth_l = "wMDCtwoD"+num2istr(graph)+"_l"  destwidth_r = "wMDCtwoD"+num2istr(graph)+"_r"	enerwave="enMDCtwoD"+num2istr(graph)   epoints = GetGraphDim(graph,0)  	kpoints = GetGraphDim(graph,1)   make /o /n=(epoints) mdcfitd_l, mdcfitd_r, mdcfitw_l, mdcfitw_r , mdcArea_l, mdcArea_r  make/o/n=(dimsize($name,0)) fit_MDC_l, fit_MDC_r, fit_MDC_All 	make /o /n=7 coeff	mdcfitd_l = nil; mdcfitd_r = nil; mdcfitw_l = nil; mdcfitw_r = nil; mdcArea_l = nil; mdcArea_r = nil;   i = MDCtwo_Ei	dowindow /f Button_Graph	startA = pcsr(A,"button_graph")	startB = pcsr(B,"button_graph")	butt_MDC(No, graph, i )		centerA=startA	centerB=startB	appendtograph/w=button_graph fit_MDC_l,fit_MDC_r, fit_MDC_All vs  $namex	curvefit /q /l=1000  lor  $name (centerA-MDCtwo_mP0-abs(i*MDCtwo_mP1),centerA+MDCtwo_P0+abs(i*MDCtwo_P1)) /d/x=$namex	//abort	coeff[0] = W_coef[0]	coeff[1] = W_coef[1]/2	coeff[2] = centerA*fitdelta+fitoffset	coeff[3] = sqrt(W_coef[3])/2	coeff[4] = hcsr(B,"button_graph")/hcsr(A,"button_graph")	coeff[5] =centerB*fitdelta+fitoffset	coeff[6] = sqrt(W_coef[3])/2		FuncFit/q/l=1000  lorTwoDetail coeff $name (min(centerA,centerB)-MDCtwo_mP0-abs(i*MDCtwo_mP1),max(centerA,centerB)+MDCtwo_P0+abs(i*MDCtwo_P1)) /D/x=$namex  	fit_MDC_l[] = abs(coeff[0])/2 + abs(coeff[1])/((p*fitdelta+fitoffset-coeff[2])^2+(coeff[3])^2)	fit_MDC_r[] = abs(coeff[0])/2 + abs(coeff[1]*coeff[4])/((p*fitdelta+fitoffset-coeff[5])^2+(coeff[6])^2)	fit_MDC_All[] = fit_MDC_l[p] +fit_MDC_r[p] 		ModifyGraph rgb(fit_MDC_l)=(0,0,65535),rgb(fit_MDC_r)=(2,39321,1)		ModifyGraph lsize(fit_MDC_All)=1,rgb(fit_MDC_All)=(0,65535,65535)		ModifyGraph lsize($fit_name)=2  	centerA=min(coeff[2],coeff[5])  	centerB=max(coeff[2],coeff[5])  	centerA=(centerA-fitoffset)/fitdelta    	centerB=(centerB-fitoffset)/fitdelta	do	  MDC_E = i		butt_MDC(No,graph,i)			findlevel/q temp2,i		chan = V_levelX 		enstep=temp2[2]-temp2[1]		FuncFit/q/l=1000  lorTwoDetail coeff $name (min(centerA,centerB)-MDCtwo_mP0-abs(i*MDCtwo_mP1),max(centerA,centerB)+MDCtwo_P0+abs(i*MDCtwo_P1)) /D/x=$namex	  fit_MDC_l[] =  abs(coeff[0])/2 + abs(coeff[1])/((p*fitdelta+fitoffset-coeff[2])^2+(coeff[3])^2)	fit_MDC_r[] =  abs(coeff[0])/2 + abs(coeff[1]*coeff[4])/((p*fitdelta+fitoffset-coeff[5])^2+(coeff[6])^2)	fit_MDC_All[] = fit_MDC_l[p] +fit_MDC_r[p] 		ModifyGraph/w=button_graph offset($fit_name)={0,Butt_offset[No]}     centerA=min(coeff[2],coeff[5])     centerB=max(coeff[2],coeff[5])		mdcfitd_l[chan] =  centerA; mdcfitd_r[chan] = centerB		if (coeff[2]<=coeff[5])	 		mdcfitw_l[chan] = coeff[3]*2; mdcfitw_r[chan] = coeff[6]*2    //from HWHM to FWHM		else		  mdcfitw_l[chan] = coeff[6]*2; mdcfitw_r[chan] = coeff[3]*2		//from HWHM to FWHM			endif		if (coeff[2] >= coeff[5])		  mdcArea_r[chan]=abs(coeff[1])/abs(coeff[3]) ; mdcArea_l[chan]=abs(coeff[1]*coeff[4])/abs(coeff[3])		else 		  mdcArea_l[chan]=abs(coeff[1])/abs(coeff[3]) ; mdcArea_r[chan]=abs(coeff[1]*coeff[4])/abs(coeff[3])		endif    		 i -= enstep		     		centerA=(centerA-fitoffset)/fitdelta    		centerB=(centerB-fitoffset)/fitdelta		duplicate /o temp2 $enerwave		duplicate /o mdcfitd_l $destdispd_l		duplicate /o mdcfitd_r $destdispd_r	  duplicate /o mdcfitw_l $destwidth_l	  duplicate /o mdcfitw_r $destwidth_r	  duplicate /o mdcArea_l $destArea_l  	  duplicate /o mdcArea_r $destArea_r	while( i >= MDCtwo_Ef )	//	removefromgraph/w=button_graph $fit_name fit_MDC_l,fit_MDC_rEndFunction Butt_MDCtwofitFunc_single (graph,No,name)	variable graph,No	string name	string fit_name	Nvar MDCtwo_Ei, MDCtwo_Ef, MDCtwo_mP0, MDCtwo_P0, MDCtwo_mP1, MDCtwo_P1, MDC_E	string destdispd_l,destdispd_r, enerwave, destwidth, destArea_l, destArea_r	variable i,kpoints,epoints,centerA,centerB,NoFitCh=29,chan, starta,startb, enstep	WAVE nil, w_coef, temp2, Butt_offset, coeff	variable fitoffset,fitdelta	string namex="buttx"+name[8, strlen(name)-1]	svar dispwave	if(stringmatch(dispwave, "ek")==1)		duplicate/o $namex temp		fitoffset=temp[0]		fitdelta=temp[1]-temp[0]	else	 	fitoffset=0		 fitdelta=1	endif		fit_name = "fit_"+name	destdispd_l = "dMDCtwoS"+num2istr(graph)+"_l"	destdispd_r = "dMDCtwoS"+num2istr(graph)+"_r"	destArea_l = "aMDCtwoS"+num2istr(graph)+"_l"	destArea_r = "aMDCtwoS"+num2istr(graph)+"_r"	   destwidth = "wMDCtwoS"+num2istr(graph)	enerwave="enMDCtwoS"+num2istr(graph)    epoints = GetGraphDim(graph,0)  	kpoints = GetGraphDim(graph,1)   make /o /n=(epoints) mdcfitd_l, mdcfitd_r, mdcfitw, mdcArea_l, mdcArea_r	make /o /n=6 coeff	mdcfitd_l = nil; mdcfitd_r = nil; mdcfitw = nil; mdcArea_l = nil; mdcArea_r = nil;   i = MDCtwo_Ei	dowindow /f Button_Graph	startA = pcsr(A,"button_graph")	startB = pcsr(B,"button_graph")	butt_MDC(No, graph, i )		centerA=startA	centerB=startB	curvefit /q /l=1000  lor  $name (centerA-MDCtwo_mP0-abs(i*MDCtwo_mP1),centerA+MDCtwo_P0+abs(i*MDCtwo_P1)) /d/x=$namex	coeff[0] = W_coef[0]	coeff[1] = W_coef[1]/2	coeff[2] = centerA*fitdelta+fitoffset	coeff[3] = sqrt(W_coef[3])/2	coeff[4] = hcsr(B,"button_graph")/hcsr(A,"button_graph")	coeff[5] =centerB*fitdelta+fitoffset	FuncFit/q/l=1000  lorTwoSimple coeff $name (min(centerA,centerB)-MDCtwo_mP0-abs(i*MDCtwo_mP1),max(centerA,centerB)+MDCtwo_P0+abs(i*MDCtwo_P1)) /D /x=$namex  	centerB=max(coeff[2],coeff[5])  	centerB=(centerB-fitoffset)/fitdelta	do	  MDC_E = i		butt_MDC(No,graph,i)			findlevel/q temp2,i		chan = V_levelX 		enstep=temp2[2]-temp2[1]		FuncFit/q/l=1000  lorTwoSimple coeff $name (min(centerA,centerB)-MDCtwo_mP0-abs(i*MDCtwo_mP1),max(centerA,centerB)+MDCtwo_P0+abs(i*MDCtwo_P1)) /D /x=$namex		ModifyGraph/w=button_graph offset($fit_name)={0,Butt_offset[No]}    		centerA=min(coeff[2],coeff[5])    		centerB=max(coeff[2],coeff[5])		mdcfitd_l[chan] =  centerA; mdcfitd_r[chan] = centerB		mdcfitw[chan] = coeff[3]*2    //from HWHM to FWHM		if (coeff[2] >= coeff[5])		  mdcArea_r[chan]=abs(coeff[1])/abs(coeff[3]) ; mdcArea_l[chan]=abs(coeff[1]*coeff[4])/abs(coeff[3])		else 		  mdcArea_l[chan]=abs(coeff[1])/abs(coeff[3]) ; mdcArea_r[chan]=abs(coeff[1]*coeff[4])/abs(coeff[3])		endif		centerA=(centerA-fitoffset)/fitdelta    		centerB=(centerB-fitoffset)/fitdelta     i -= enstep				duplicate /o temp2 $enerwave		duplicate /o mdcfitd_l $destdispd_l		duplicate /o mdcfitd_r $destdispd_r	   duplicate /o mdcfitw $destwidth	   duplicate /o mdcArea_l $destArea_l  	   duplicate /o mdcArea_r $destArea_r  while( i >= MDCtwo_Ef )		removefromgraph/w=button_graph $fit_nameEndFunction Butt_MDCtifitFunc_single (graph, startA,startB)	variable graph	variable startA, startB	string name	Nvar MDCtwo_Ei, MDCtwo_Ef, MDCtwo_mP0, MDCtwo_P0, MDCtwo_mP1, MDCtwo_P1, MDC_E	string destdispd_l,destdispd_r, enerwave, destwidth, destArea_l, destArea_r	variable i,kpoints,epoints,centerA,centerB,NoFitCh=29,chan,  enstep	WAVE nil, w_coef, temp2, Butt_offset, coeff	variable fitoffset,fitdelta	string namex="buttx"+name[8, strlen(name)-1]	svar dispwave	if(stringmatch(dispwave, "ek")==1)		duplicate/o $namex temp		fitoffset=temp[0]		fitdelta=temp[1]-temp[0]	else	 	fitoffset=0		 fitdelta=1	endif		name="Tiwave"+num2istr(graph)	destdispd_l = "dMDCtwoS"+num2istr(graph)+"_l"	destdispd_r = "dMDCtwoS"+num2istr(graph)+"_r"	destArea_l = "aMDCtwoS"+num2istr(graph)+"_l"	destArea_r = "aMDCtwoS"+num2istr(graph)+"_r"	   destwidth = "wMDCtwoS"+num2istr(graph)	enerwave="enMDCtwoS"+num2istr(graph)    epoints = GetGraphDim(graph,0)  	kpoints = GetGraphDim(graph,1)   make /o /n=(epoints) mdcfitd_l, mdcfitd_r, mdcfitw, mdcArea_l, mdcArea_r	make /o /n=6 coeff	mdcfitd_l = nil; mdcfitd_r = nil; mdcfitw = nil; mdcArea_l = nil; mdcArea_r = nil;	i = MDCtwo_Ei	Ti_MDC(graph, i )		centerA=startA	centerB=startB	curvefit /q /l=1000  lor  $name (centerA-MDCtwo_mP0-abs(i*MDCtwo_mP1),centerA+MDCtwo_P0+abs(i*MDCtwo_P1)) /d /x=$namex	coeff[0] = W_coef[0]	coeff[1] = W_coef[1]/2	coeff[2] = centerA*fitdelta+fitoffset	coeff[3] = sqrt(W_coef[3])/2	coeff[4] = startB/startA	coeff[5] =centerB*fitdelta+fitoffset	FuncFit/q/l=1000  lorTwoSimple coeff $name (min(centerA,centerB)-MDCtwo_mP0-abs(i*MDCtwo_mP1),max(centerA,centerB)+MDCtwo_P0+abs(i*MDCtwo_P1)) /D  /x=$namex  centerB=max(coeff[2],coeff[5])  centerB=(centerB-fitoffset)/fitdelta	do	  MDC_E = i		Ti_MDC(graph,i)			findlevel/q temp2,i		chan = V_levelX 		enstep=temp2[2]-temp2[1]		FuncFit/q/l=1000  lorTwoSimple coeff $name (min(centerA,centerB)-MDCtwo_mP0-abs(i*MDCtwo_mP1),max(centerA,centerB)+MDCtwo_P0+abs(i*MDCtwo_P1)) /D  /x=$namex    centerA=min(coeff[2],coeff[5])    centerB=max(coeff[2],coeff[5])		mdcfitd_l[chan] =  centerA; mdcfitd_r[chan] = centerB		mdcfitw[chan] = coeff[3]*2    //from HWHM to FWHM		if (coeff[2] >= coeff[5])		  mdcArea_r[chan]=abs(coeff[1])/abs(coeff[3]) ; mdcArea_l[chan]=abs(coeff[1]*coeff[4])/abs(coeff[3])		else 		  mdcArea_l[chan]=abs(coeff[1])/abs(coeff[3]) ; mdcArea_r[chan]=abs(coeff[1]*coeff[4])/abs(coeff[3])		endif		centerA=(centerA-fitoffset)/fitdelta    		centerB=(centerB-fitoffset)/fitdelta     i -= enstep				duplicate /o temp2 $enerwave		duplicate /o mdcfitd_l $destdispd_l		duplicate /o mdcfitd_r $destdispd_r	   duplicate /o mdcfitw $destwidth	   duplicate /o mdcArea_l $destArea_l  	   duplicate /o mdcArea_r $destArea_r  while( i >= MDCtwo_Ef )	EndFunction lorTwoDetail (w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[2])^2+(w[3])^2) 	f +=  abs(w[1]*W[4])/((x-w[5])^2+(w[6])^2)	return (f)EndFunction lorTwoSimple (w,x) : FitFunc	Wave w	Variable x	variable f	f = abs(w[0]) + abs(w[1])/((x-w[2])^2+(w[3])^2)	f +=  abs(w[1]*W[4])/((x-w[5])^2+(w[3])^2)	return (f)EndFunction Butt_MDCtwofitShow_double (Graph)   variable Graph   string panelname   string dMDC_l, dMDC_r, wMDC_l, wMDC_r, enMDC, paneltext1, paneltext2   Nvar MDCtwo_Ei, MDCtwo_Ef   panelname="MDCtwoD"+num2str(Graph)+"_panel"   dMDC_l = "dMDCtwoD" + num2str(Graph)+"_l"   dMDC_r = "dMDCtwoD" + num2str(Graph)+"_r"   wMDC_l = "wMDCtwoD" + num2str(Graph)+"_l"   wMDC_r = "wMDCtwoD" + num2str(Graph)+"_r"   enMDC = "enMDCtwoD"+num2str(Graph)   paneltext1="\\Z16"+"wMDCtwo" + num2str(Graph)   paneltext2="\\Z16"+"dMDCtwo" + num2str(Graph)   dowindow/f $panelname   if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(168,88,464,596) $wMDC_l vs $enMDC	AppendToGraph $wMDC_r vs $enMDC	dowindow/c $panelname	AppendToGraph/L=VertCrossing/B=HorizCrossing $enMDC vs $dMDC_l	AppendToGraph/L=VertCrossing/B=HorizCrossing $enMDC vs $dMDC_r	ModifyGraph mode=4,marker=19	ModifyGraph rgb($enMDC)=(0,0,65535)	ModifyGraph rgb($wMDC_l)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=0.428571,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.35}	ModifyGraph axisEnab(VertCrossing)={0.45,1}	ModifyGraph standoff=0	TextBox/C/N=auw/F=0/A=MC/X=-23.76/Y=-22.05 paneltext1	TextBox/C/N=aup/F=0/A=MC/X=-23.76/Y=47.82 paneltext2	 ModifyGraph standoff=1		 Label VertCrossing "Energy (eV)";DelayUpdate   Label HorizCrossing "Slice";DelayUpdate    Label left "FWHM (Slice)";DelayUpdate   Label bottom "Energy (eV)";DelayUpdate  endif  svar dispwave  if(stringmatch(dispwave, "ek")==1)  	Label HorizCrossing "K// (pi/a)";DelayUpdate  	Label left "FWHM (pi/a)";DelayUpdate  	else  	Label HorizCrossing "Slice";DelayUpdate  	Label left "FWHM (Slice)";DelayUpdate  	endif  SetAxis bottom  MDCtwo_Ef-0.05,  MDCtwo_Ei+0.05  SetAxis VertCrossing MDCtwo_Ef-0.05,  MDCtwo_Ei+0.05EndMacroFunction Butt_MDCtwofitShow_single (Graph)   variable Graph   string panelname   string dMDC_l, dMDC_r, wMDC, enMDC, paneltext1, paneltext2   Nvar MDCtwo_Ei, MDCtwo_Ef   panelname="MDCtwoS"+num2str(Graph)+"_panel"   dMDC_l = "dMDCtwoS" + num2str(Graph)+"_l"   dMDC_r = "dMDCtwoS" + num2str(Graph)+"_r"   wMDC = "wMDCtwoS" + num2str(Graph)   enMDC = "enMDCtwoS"+num2str(Graph)   paneltext1="\\Z16"+wMDC   paneltext2="\\Z16"+"dMDCtwoS" + num2str(Graph)   dowindow/f $panelname   if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		Display /W=(168,88,464,596) $wMDC vs $enMDC	dowindow/c $panelname	AppendToGraph/L=VertCrossing/B=HorizCrossing $enMDC vs $dMDC_l	AppendToGraph/L=VertCrossing/B=HorizCrossing $enMDC vs $dMDC_r	ModifyGraph mode=4,marker=19	ModifyGraph rgb($wMDC)=(9,37552,0)	ModifyGraph rgb($enMDC)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph mirror(left)=1,mirror(VertCrossing)=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=0.428571,axOffset(bottom)=-0.8	ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37	ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}	ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}	ModifyGraph tickZap(VertCrossing)={0}	ModifyGraph tickZap(HorizCrossing)={0}	ModifyGraph axisEnab(left)={0,0.35}	ModifyGraph axisEnab(VertCrossing)={0.45,1}	ModifyGraph standoff=0	TextBox/C/N=auw/F=0/A=MC/X=-23.76/Y=-22.05 paneltext1	TextBox/C/N=aup/F=0/A=MC/X=-23.76/Y=47.82 paneltext2	 ModifyGraph standoff=1		 Label VertCrossing "Energy (eV)";DelayUpdate   Label HorizCrossing "Slice";DelayUpdate    Label left "FWHM (Slice)";DelayUpdate   Label bottom "Energy (eV)";DelayUpdate  endif  svar dispwave  if(stringmatch(dispwave, "ek")==1)  	Label HorizCrossing "K// (pi/a)";DelayUpdate  	Label left "FWHM (pi/a)";DelayUpdate  	else  	Label HorizCrossing "Slice";DelayUpdate  	Label left "FWHM (Slice)";DelayUpdate  	endif  SetAxis bottom  MDCtwo_Ef-0.05,  MDCtwo_Ei+0.05  SetAxis VertCrossing MDCtwo_Ef-0.05,  MDCtwo_Ei+0.05EndMacro	Function Butt_peakShow (ctrlName) : ButtonControl	String ctrlName	wave ButtPeak, ButtPeakNo	dowindow/f ButtPeakTable	if (V_flag!=1)	  edit ButtPeakNo, ButtPeak	  dowindow/c ButtPeakTable	endif	dowindow/f ButtPeakGraph  if (V_flag!=1)	  display ButtPeak vs ButtPeakNo	  dowindow/c ButtPeakGraph  	  ModifyGraph mode=4		ModifyGraph marker=19		ModifyGraph tick=2		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=16		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625		Label left "Peak"		Label bottom "No"	endif end	Function Butt_gapShow (ctrlName) : ButtonControl	String ctrlName	wave ButtGap, ButtGapNo	dowindow/f ButtGapTable	if (V_flag!=1)	  edit ButtGapNo, ButtGap	  dowindow/c ButtGapTable	endif	dowindow/f ButtGapGraph	if (V_flag!=1)	  display ButtGap vs ButtGapNo	  dowindow/c ButtGapGraph	  ModifyGraph mode=4		ModifyGraph marker=19		ModifyGraph tick=2		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=16		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625		Label left "Gap"		Label bottom "No"	endifend	Function Butt_areaShow (ctrlName) : ButtonControl	String ctrlName	wave ButtArea, ButtAreaNo	nvar AreavsTempCheck	      dowindow/f ButtAreaGraph  	 if (V_flag==0)  		if (AreavsTempCheck!=1)      		 	display ButtArea vs ButtAreaNo       		 	Label bottom "No"      		 elseif (AreavsTempCheck==1)       		 	Display /W=(53,69,441,460) ButtArea vs ButtAreaTemp      		 	Label bottom "Temperature (K)"     		endif      			dowindow/c ButtAreaGraph      			ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625			Label left "Area"						SetAxis left 0,*   	endif     	 end	Function Butt_LorgapShow (ctrlName) : ButtonControl	String ctrlName	wave ButtGapLor, ButtGapLorNo	dowindow/f ButtGapLorTable	if (V_flag!=1)	  edit ButtGapLorNo, ButtGapLor	  dowindow/c ButtGapLorTable	endif	dowindow/f ButtGapLorGraph	if (V_flag!=1)	  display ButtGapLor vs ButtGapLorNo	  dowindow/c ButtGapLorGraph	  ModifyGraph mode=4		ModifyGraph marker=19		ModifyGraph tick=2		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=16		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625		Label left "Gap"		Label bottom "No"	endifend		Function Butt_EDCFWHM(ctrlName) : ButtonControl	String ctrlName	nvar AnatoNo	nvar AnafromNo	nvar EDCFWHMTempCheck	wave map	wave butt_graphmake/o/n=(AnatoNo-AnafromNo+1) EDCFWHM, EDCFWHMT, WDCMAX,EDCFWHMGvariable ii=AnafromNostring wname, wnamexdowname="buttwave"+num2str(ii)wnamex="buttx"+num2str(ii)duplicate/o $wname temp1duplicate/o $wnamex temp2if(strlen(CsrInfo(A, "Button_Graph"))<1)print "Set position using cursor A!"abortendifwavestats/Q temp1findlevel/Q temp1, (V_max+temp1[pcsr(A, "Button_Graph")])/2WDCMAX[ii-AnafromNo]=V_maxEDCFWHM[ii-AnafromNo]=abs(temp2[V_LevelX]*2)EDCFWHMT[ii-AnafromNo]=map[butt_graph[ii]][2]EDCFWHMG[ii-AnafromNo]=butt_graph[ii]ii+=1while(ii<AnatoNo+1)dowindow/f ButtEDCFWHM  	 if (V_flag==0)  		if (EDCFWHMTempCheck!=1)      		 	display EDCFWHM vs EDCFWHMG     		 	Label bottom "GraphNo"      		 elseif (EDCFWHMTempCheck==1)       		 	Display /W=(53,69,441,460) EDCFWHM vs EDCFWHMT     		 	Label bottom "Temperature (K)"     		endif      			dowindow/c ButtEDCFWHM      			ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625			Label left "FWHM"			//			SetAxis left 0,*   	endif    End	Function Butt_GetGapLorFunc (ctrlName) : ButtonControl	String ctrlName	string wavestrX, wavestrY	variable i, EFpoint, ckeck, centerE, centerPi, centerPf, windex, peakHight	variable pcsrA,pcsrB	Nvar Butt_of, CentPlus, CentMinus, AnaFromNo, AnaToNo, ContinueCheck, HightCheck	wave ButtGap, ButtNo , w_coef	wave Butt_offset, coeff	dowindow/f Button_Graph	if (v_flag!=1)	abort "Show Button_Graph"	endif	if (stringmatch(CsrWave(a,"Button_graph"),"") || stringmatch(CsrWave(b,"Button_graph"),""))       Abort "Set A and B cursors!!"  endif	pcsrA=pcsr(A,"Button_graph") ; pcsrB=pcsr(B,"Button_graph")	 make/o/n=(Butt_of*10) ButtGapLor, ButtGapLorNo, ButtPeakHightLor	 make/o/n=200 $"fit_temp"		dowindow/f Button_graph		appendtograph $"fit_temp"		if (ContinueCheck==0)		   		ButtGapLor[]=nan			ButtGapLorNo[]=nan			ButtPeakHightLor[]=nan		endif		ckeck = 0   variable /g v_fitoptions=4	for (i=AnaFromNo-1 ; i<=AnaToNo-1 ; i+=1)	   windex=i+1		wavestrY = "Buttwave" + num2istr(windex)		wavestrX = "buttx" + num2istr(windex)		duplicate/o $wavestrY temp		duplicate/o $wavestrX temp1		if (numpnts(temp)!=0)				ModifyGraph lsize($"fit_temp")=2				ModifyGraph offset($"fit_temp")={0,Butt_offset[windex]}				wavestats/q temp				coeff={0, 0.5, temp1[V_maxloc] ,0.01}				FuncFit/q  lorSym coeff temp[pcsrA,pcsrB] /X=temp1 /D 				  	  wavestats/q $"fit_temp"		  	  centerE = abs(V_maxloc)		  	   findlevel/q temp1, abs(centerE)				centerPf = V_levelX				findlevel/q temp1, -abs(centerE)				centerPi = V_levelX					FuncFit/q  lorSym coeff temp[centerPi-CentMinus,centerPf+CentPlus] /X=temp1 /D 				wavestats/q $"fit_temp"				peakHight = V_max		  	   ButtGapLor[i]= abs(V_maxloc)		  	   //ButtGapLor[i]= abs(coeff[2])		  	   ButtGapLorNo[i]=windex		  	   ButtPeakHightLor[i]=peakHight		else		ButtGapLor[i]=nan	 	ButtGapLorNo[i]=nan	 	ButtPeakHightLor[i]=nan		endif   endfor   v_fitoptions=0    removefromgraph $"fit_temp"    dowindow/f ButtGapLorTable    if (V_flag==0)       edit ButtGapLorNo, ButtGapLor        dowindow/c ButtGapLorTable    endif     dowindow/f ButtGapLorGraph    if (V_flag==1)      if (HightCheck==1 && stringmatch(TraceNameList("",";",1),"*ButtPeakHightLor*")!=1 )         appendtograph/r ButtPeakHightLor vs ButtGapLorNo          ModifyGraph rgb(ButtPeakHightLor)=(0,0,65535)         Label right "Peak Hight"         ModifyGraph mode=4			   ModifyGraph marker=19			  ModifyGraph tick=2		  	ModifyGraph minor=1			  ModifyGraph fSize=16		   	ModifyGraph standoff=0      endif    endif    if (V_flag==0)       display ButtGapLor vs ButtGapLorNo          dowindow/c ButtGapLorGraph        ModifyGraph mirror=1       Label left "Gap"			 Label bottom "No"       if  (HightCheck==1)          appendtograph/r ButtPeakHightLor vs ButtGapLorNo           ModifyGraph rgb(ButtPeakHightLor)=(0,0,65535)          Label right "Peak Hight"       endif      ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2					ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625    endif  end	Function lorSym (w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[2])^2+(w[3])^2)	f +=  abs(w[1])/((-x-w[2])^2+(w[3])^2)	return (f)EndFunction Butt_GetGapFunc (ctrlName) : ButtonControl	String ctrlName	string wavestrX, wavestrY, graphNo	variable i, EFpoint, ckeck, centerE, centerPi, centerPf, windex, peakHight	variable pcsrA,pcsrB	Nvar Butt_of, CentPlus, CentMinus, AnaFromNo, AnaToNo, ContinueCheck, HightCheck	Nvar GapvsTempCheck	wave ButtGap, ButtNo , w_coef	wave Butt_offset, coeff, map, Butt_graph	wave/t Graph_	dowindow/f Button_Graph	if (v_flag!=1)			abort "Show Button_Graph"	endif	if (stringmatch(CsrWave(a,"Button_graph"),"") || stringmatch(CsrWave(b,"Button_graph"),""))       Abort "Set A and B cursors!!"  endif	pcsrA=pcsr(A,"Button_graph") ; pcsrB=pcsr(B,"Button_graph")  make/o/n=(Butt_of*10) ButtGap, ButtWidth, ButtGapNo, ButtGapTemp, ButtPeakHight	 make/o/n=200 $"fit_temp"		dowindow/f Button_graph		appendtograph $"fit_temp"		if (ContinueCheck==0)   		ButtGap[]=nan   		ButtWidth[]=nan			ButtGapNO[]=nan			ButtGapTemp[]=nan			ButtPeakHight[]=nan		endif		ckeck = 0	//for (i=1 ; i<=(Butt_of*10) ; i+=1)	variable /g v_fitoptions=4	for (i=AnaFromNo-1 ; i<=AnaToNo-1 ; i+=1)	   dowindow/f Button_Graph	   windex=i+1		wavestrY = "Buttwave" + num2istr(windex)		wavestrX = "buttx" + num2istr(windex)		duplicate/o $wavestrY temp		duplicate/o $wavestrX temp1		if (numpnts(temp)!=0)				ModifyGraph lsize($"fit_temp")=2				ModifyGraph offset($"fit_temp")={0,Butt_offset[windex]}				//findlevel/q temp1 0				//EFpoint = V_LevelX + 5						//CurveFit/q lor  temp[pcsr(A),EFpoint] /X=temp1 /D 				//coeff={w_coef[0], 1, w_coef[2], sqrt(w_coef[3])}				wavestats/q/R=[pcsrA,pcsrB] temp				coeff={0, 1, temp1[V_maxloc] ,0.015}				FuncFit/q  GapFunction coeff temp[pcsrA,pcsrB] /X=temp1 /D 				  	  wavestats/q $"fit_temp"		  	  centerE = abs(V_maxloc)		  	   findlevel/q temp1, abs(centerE)				centerPf = V_levelX				findlevel/q temp1, -abs(centerE)				centerPi = V_levelX					FuncFit/q  GapFunction coeff temp[centerPi-CentMinus,centerPf+CentPlus] /X=temp1 /D				   wavestats/q $"fit_temp"				  peakHight = V_max		  	  //ButtGap[i]= abs(V_maxloc)		  	   ButtGap[i]= abs(coeff[2])		  	   ButtWidth[i] = abs(coeff[3])		  	   ButtGapNo[i]=windex		  	   ButtGapTemp[i]=map[Butt_graph[windex]][2]		  	   ButtPeakHight[i]=peakHight		  	dowindow/f ButtGapGraph		else		ButtGap[i]=nan		ButtWidth[i]=nan	 	ButtGapNo[i]=nan	 	ButtGapTemp[i]=nan	 	ButtPeakHight[i]=nan		endif   endfor   v_fitoptions=0   dowindow/f Button_Graph//    removefromgraph $"fit_temp"    dowindow/f ButtGapTable    if (V_flag==0)       edit ButtGapNo, ButtGap, ButtGapTemp       dowindow/c ButtGapTable    endif   if (GapvsTempCheck!=1)      dowindow/f ButtGapGraph    if (V_flag==1)      if (HightCheck==1 && stringmatch(TraceNameList("",";",1),"*ButtPeakHight*")!=1 )         appendtograph/r ButtPeakHight vs ButtGapNo         ModifyGraph rgb(ButtPeakHight)=(0,0,65535)         Label right "Peak Hight"         ModifyGraph mode=4			   ModifyGraph marker=19			  ModifyGraph tick=2		  	ModifyGraph minor=1			  ModifyGraph fSize=16		   	ModifyGraph standoff=0      endif    endif    if (V_flag==0)       display ButtGap vs ButtGapNo        dowindow/c ButtGapGraph        Label left "Gap"			 Label bottom "No"       ModifyGraph mirror=1       if  (HightCheck==1)          appendtograph/r ButtPeakHight vs ButtGapNo          ModifyGraph rgb(ButtPeakHight)=(0,0,65535)          Label right "Peak Hight"       endif      ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625    endif    elseif (GapvsTempCheck==1)        dowindow/f ButtGapGraph    if (V_flag==0)    PauseUpdate; Silent 1		// building window...			Display /W=(53,69,441,460) ButtGap vs ButtGapNo 	  dowindow/c ButtGapGraph		    if  (HightCheck==1)          appendtograph/r ButtPeakHight vs ButtGapNo          ModifyGraph axisEnab(right)={0,0.4}          ModifyGraph rgb(ButtPeakHight)=(2,39321,1)          Label right "Peak Hight"        endif		AppendToGraph/L=VertCrossing/B=HorizCrossing ButtGap vs ButtGapTemp 		ModifyGraph mode(ButtGap#1)=4,marker(ButtGap#1)=19    ModifyGraph mode=4,marker=19,rgb(ButtGap)=(0,0,65535)    Label VertCrossing "Gap (eV)";DelayUpdate	  Label HorizCrossing "Temperature (K)"	  Label left "Gap (eV)";DelayUpdate  	Label bottom "No"		ModifyGraph lSize(ButtGap)=2		ModifyGraph tick=2		//ModifyGraph mirror(left)=1,mirror(VertCrossing)=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-2.57143,axOffset(bottom)=-0.8		ModifyGraph lblPos(left)=84,lblPos(bottom)=44,lblPos(VertCrossing)=85,lblPos(HorizCrossing)=37		ModifyGraph freePos(VertCrossing)={-inf,HorizCrossing}		ModifyGraph freePos(HorizCrossing)={-inf,VertCrossing}		ModifyGraph tickZap(VertCrossing)={0}		ModifyGraph tickZap(HorizCrossing)={0}		ModifyGraph axisEnab(left)={0,0.41}		ModifyGraph axisEnab(VertCrossing)={0.59,1}		endif	endifend	function GapFunction (w,x)  wave w  variable x  variable Re, Im, result    Re=W[2]^2/(x)    Im=W[3]    result=W[0]+W[1]*(1/pi)*Im/((x-Re)^2+Im^2)  return(result)endfunction GapFunction2 (w,x)  wave w  variable x  variable Re, Im, result    Re=W[2]^2/(x)    Im=W[3]+W[2]^2/W[4]    result=W[0]+W[1]*(1/pi)*Im/((x-Re)^2+Im^2)  return(result)endFunction Butt_DivFermiFunc (ctrlName) : ButtonControl	String ctrlName	string wavestrX, wavestrY	variable i	variable eV=1.6*10^-19, kB=1.3807*10^-23, Temperature	Nvar Butt_of, ButtFermiTemp, AnaFromNo, AnaToNo, AutoTempcheck	wave butt_graph,butt_angle, map  		for (i=AnaFromNo ; i<=AnaToNo ; i+=1)		wavestrY = "Buttwave" + num2istr(i)		wavestrX = "buttx" + num2istr(i)     if (numpnts($wavestrY)!=0)		 ButtFunc(i,"an",butt_angle[i],1)		 duplicate/o $wavestrY temp, temp2, temp3		 duplicate/o $wavestrX temp1		  if (AutoTempcheck==0)      temp2[] = 1 / ( 1 + exp( temp1[p]/(kB*ButtFermiTemp/eV) ) )       elseif (AutoTempcheck==1)       Temperature = map[butt_graph[i]][2]       //Temperature = map[butt_graph[i]][0]       temp2[] = 1 / ( 1 + exp( temp1[p]/(kB*Temperature/eV) ) )       endif      temp[] = temp3[p]/temp2[p]      duplicate/o  temp $wavestrY		endif   endfor      dowindow/f Buttonanalize  endFunction Butt_AutoTempcheck (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar AutoTempcheck	AutoTempcheck = checkedEndFunction Butt_AllNo (ctrlName) : ButtonControl	String ctrlName	string wavestrY	variable i, check	Nvar Butt_of,  AnaFromNo, AnaToNo	for (i=1 ; i<=( Butt_of*10) ; i+=1)	wavestrY = "Buttwave" + num2istr(i)			if (numpnts($wavestrY)!=0 && check!=1)       AnaFromNo = i       check = 1		endif		if (numpnts($wavestrY)!=0)       AnaToNo = i		endif		   endforend		Function Butt_Divide (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar Butt_of, ButtDivideNo, AnaFromNo, AnaToNo	string wavestrY	wave Butt_angle	wavestrY = "Buttwave" + num2istr(ButtDivideNo)   duplicate/o $wavestrY SubWave	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "Buttwave" + num2istr(i)		if (numpnts($wavestrY)!=0)	   //	ButtFunc(i,"an",butt_angle[i],1)			  duplicate/o $wavestrY temp       temp[]/=SubWave[p]      duplicate/o temp $wavestrY		endif   endfor   killwaves subwaveendFunction butt_2ndderivative(ctrlName) : ButtonControl	String ctrlName	Nvar  AnaFromNo, AnaToNo	nvar butt_2ndsmooth1,butt_2ndsmooth2,butt_2ndsmooth3	variable i	string wavestrY, wavestrX		variable nor, norchck=1	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "Buttwave" + num2istr(i)		if (numpnts($wavestrY)!=0)		duplicate/o $wavestrY temp		smooth butt_2ndsmooth1, temp		differentiate temp		smooth butt_2ndsmooth2, temp		differentiate temp		smooth butt_2ndsmooth3, temp		temp=-temp		temp=temp[p]>0?temp[p]:0		if(norchck)		wavestrX = "ButtX"+num2str(i)		duplicate/o $wavestrX temp2		nor=faverageXY (temp2,temp,-inf,0)		temp/=nor		endif		duplicate/o temp $wavestrY		endif   endforEndFunction Butt_InputPeakFunc (ctrlName) : ButtonControl	String ctrlName	variable i,No	Nvar Butt_of 	wave ButtPeak, ButtPeakNo, Butt_angle		for (No=1 ; No<=( Butt_of*10) ; No+=1)	 i = No-1      if (stringmatch(num2str(ButtPeakNo[i]),"nan")!=1)         Butt_angle[No]=round(ButtPeak[i])       endif   endfor      ButtUpdateFunc_simple () endFunction Butt_GetPeakFunc (ctrlName) : ButtonControl	String ctrlName	string wavestrX, wavestrY	variable i, center, check, windex,x1,x2,p1,p2	Nvar Butt_of, CentPlus, CentMinus, AnaFromNo, AnaToNo, MDC_flag	Nvar CentMinus_E, CentPlus_E	wave ButtPeak, ButtNo , w_coef	wave Butt_offset, coeff	svar Butt_EnergyPointStr		dowindow/f Button_Graph	if (v_flag!=1)	abort "Show Button_Graph"	endif	 if (stringmatch(CsrWave(a,"Button_graph"),"") || stringmatch(CsrWave(b,"Button_graph"),""))       Abort "Set A and B cursors!!"  endif  //x1=pcsr(A,"Button_graph") ; x2=pcsr(B,"Button_graph")  x1=hcsr(A,"Button_graph") ; x2=hcsr(B,"Button_graph")	 make/o/n=(Butt_of*10) ButtPeak, ButtPeakNo 	 make/o/n=200 $"fit_temp"	 make/o/n=5 coeff		dowindow/f Button_graph		appendtograph $"fit_temp"   	ButtPeak[]=nan		ButtPeakNo[]=nan	     check = 0   //	variable /g v_fitoptions=4	for (i=AnaFromNo-1 ; i<=AnaToNo-1 ; i+=1)	  windex=i+1		wavestrY = "Buttwave" + num2istr(windex)		wavestrX = "buttx" + num2istr(windex)		duplicate/o $wavestrY temp		duplicate/o $wavestrX temp1		if (numpnts(temp)!=0)			ModifyGraph lsize($"fit_temp")=2			ModifyGraph offset($"fit_temp")={0,Butt_offset[windex]}			if (check == 0)    			   	FindLevel/Q temp1, x1	   		   p1 = V_LevelX	   		   FindLevel/Q temp1, x2	   		   p2 = V_LevelX		  		CurveFit/q lor  temp[p1,p2] /X=temp1 /D		  		coeff[0] = W_coef[0]		  		coeff[1] = 0		  		coeff[2] = W_coef[1]		  		coeff[3] = W_coef[2]		  		coeff[4] = W_coef[3]		  		FuncFit/q  peakfunc coeff temp[p1,p2] /X=temp1 /D		  		center = coeff[3]		  		check = 1		  	//	print x1,x2,p1,p2		  	//	abort 			else			  if (MDC_flag)			     FuncFit/q  peakfunc coeff temp[center-CentMinus,center+CentPlus] /X=temp1 /D	   		   center = coeff[3]	   		else	   			if (stringmatch(Butt_EnergyPointStr,"point")==1)	   		   p1 = center-CentMinus	   		   p2 = center+CentPlus	   	     FuncFit/q  peakfunc coeff temp[p1,p2] /X=temp1 /D	   		   center = coeff[3]	 	   		  // wavestats/q $"fit_temp"  	   		  // coeff[3] = V_maxloc 	   		  elseif (stringmatch(Butt_EnergyPointStr,"energy")==1)	   		   FindLevel/Q temp1, (center-CentMinus_E/1000)	   		   p1 = V_LevelX	   		   FindLevel/Q temp1, (center+CentPlus_E/1000)	   		   p2 = V_LevelX	   	     FuncFit/q  peakfunc coeff temp[p1,p2] /X=temp1 /D	   	     print center	   		   center = coeff[3]		   		  endif	   		endif			endif	        ButtPeakNo[i]=windex			ButtPeak[i]=(coeff[3])		else			ButtPeak[i]=nan		 	ButtPeakNo[i]=nan		endif   endfor// v_fitoptions=0   	removefromgraph $"fit_temp"    	dowindow/f ButtPeakTable   if (V_flag==0)       edit ButtPeakNo, ButtPeak        dowindow/c ButtPeakTable   endif    	dowindow/f ButtPeakGraph   if (V_flag==0)       display ButtPeak vs ButtPeakNo       dowindow/c ButtPeakGraph       	ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(bottom)=-0.25			Label left "Peak"			Label bottom "No"   endif   endfunction peakfunc (w,x)	wave w; variable x	return W[0]+W[1]*x+W[2]/((x-W[3])^2+W[4])endFunction getIntensity(i,num)variable i, numwave ButtPeakIntensitymake/o/n=(i+1) ButtPeakIntensityButtPeakIntensity[i]=numend		Function Butt_MDC_set (MDCrange, EDCrange)  variable MDCrange, EDCrange	variable i	string setVarStr	NVAR MDC_flag, butt_range      		 DoWindow Button_Graph	if (V_flag==1)	  if (MDC_flag == 1)	     svar dispwave     		if(stringmatch(dispwave, "Ek"))     			Label bottom "Momentum (A\\S-1\\M)"     		else     			Label bottom "K (Slice)"     		endif	  else	     Label/w=Button_Graph bottom "Energy (eV)"   	endif   endif	  if ( MDC_flag == 1 )		for (i=1 ;i<=10;i+=1)			setVarStr = "ButtSlice" + num2istr(i)			SetVariable $setVarStr limits={-Inf,Inf,0.002}		     endfor			SetVariable ButtShift limits={-Inf,Inf,0.002}			SetVariable ButtRange limits={0,Inf,0.001}			//butt_range = MDCrange          	else		MDC_flag = 0		for (i=1 ;i<=10;i+=1)			setVarStr = "ButtSlice" + num2istr(i)			SetVariable $setVarStr limits={-Inf,Inf,1}     endfor			SetVariable ButtShift limits={-Inf,Inf,1}			SetVariable ButtRange limits={0,Inf,1}			//butt_range = EDCrange    endifendFunction Butt_EDCMDCfunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Butt_EDCMDC (popStr)endFunction Butt_EDCMDC (popStr)  string popStr	Nvar MDC_flag, ButtXminValue, ButtXmaxValue, useAreaCheck	dowindow Button_Graph	if (V_flag==1)		if (MDC_flag==1)	  Butt_saveEDCMDC("MDC")  	elseif (MDC_flag!=1)	  Butt_saveEDCMDC("EDC")	endif		if (stringmatch(popStr,"EDC"))	Butt_LoadEDCMDC ("EDC") 	elseif (stringmatch(popStr,"MDC"))	  Butt_LoadEDCMDC ("MDC") 	  if (useAreaCheck==1)	     showEDCarea()	  endif	endif	if ( ButtXminValue==0 && ButtXmaxValue==0)		SetAxis/A/w=Button_Graph	else 	  SetAxis/w=Button_Graph bottom ButtXminValue, ButtXmaxValue	endifendifendFunction showEDCarea()  wave EDCArea, EDCAreaNo      dowindow/f EDCAreaGraph      if (V_flag==0)     display EDCArea vs EDCAreaNo        dowindow/c EDCAreaGraph      ModifyGraph mode=4			ModifyGraph marker=19			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0			ModifyGraph axOffset(left)=-1.875,axOffset(bottom)=-0.625			Label left "EDC Area"			Label bottom "No"    endif  endFunction useEDCarea()	string wavestrX, wavestrY	variable No, i, center, check, x1, x2, windex	Nvar Butt_X1, Butt_X2	Nvar Butt_of, AnaFromNo, AnaToNo 	wave EDCArea		 for (No=1 ; No<=Butt_of*10 ;No+=1)		  windex=No; i=No-1			wavestrY = "Buttwave" + num2istr(windex)			duplicate/o $wavestrY temp			if (numpnts(temp)!=0)        temp[]/=EDCArea[i]        duplicate/o temp, $wavestrY			endif   	endforendFunction Butt_saveEDCMDC (wavastr) 	string wavastr	   wave/t ButtSaveEDCMDC   Nvar butt_set   Nvar MDC_flag,symon,butt_shift, Butt_range, ButtXminValue, ButtXmaxValue, Butt_smooth   wave butt_graph,butt_angle,butt_Bold,butt_offset,butt_Goff   wave/t butt_color,memoT_Butt   variable valEDCorMDC   svar memoButt   Redimension/N=(dimsize(butt_graph,0),7,2) ButtSaveEDCMDC   if (stringmatch(wavastr,"EDC"))   valEDCorMDC=0    elseif (stringmatch(wavastr,"MDC"))   valEDCorMDC=1    endif   ButtSaveEDCMDC[][0][]=num2str(butt_Goff[p]) ; ButtSaveEDCMDC[0][0][]="Butt_Goff"   ButtSaveEDCMDC[][1][]=num2str(butt_graph[p]) ; ButtSaveEDCMDC[0][1][]="Butt_graph"   ButtSaveEDCMDC[][2][valEDCorMDC]=num2str(butt_angle[p]) ; ButtSaveEDCMDC[0][2][valEDCorMDC]="Butt_angle"   ButtSaveEDCMDC[][3][]=num2str(butt_offset[p]) ; ButtSaveEDCMDC[0][3][]="Butt_offset"   ButtSaveEDCMDC[][4][]=butt_color[p] ; ButtSaveEDCMDC[0][4][]="Butt_color"   ButtSaveEDCMDC[][5][]=num2str(butt_Bold[p]) ; ButtSaveEDCMDC[0][5][]="Butt_Bold"      ButtSaveEDCMDC[0][6][valEDCorMDC]="CheckList"   ButtSaveEDCMDC[1][6][valEDCorMDC]=num2str(MDC_flag)   ButtSaveEDCMDC[2][6][valEDCorMDC]=num2str(symON)    ButtSaveEDCMDC[3][6][valEDCorMDC]=num2str(butt_shift)    ButtSaveEDCMDC[4][6][valEDCorMDC]=num2str(Butt_range)    ButtSaveEDCMDC[7][6][valEDCorMDC]=num2str(Butt_smooth)      dowindow Button_Graph   if (V_flag==1)     GetAxis/q/w=Button_Graph bottom     ButtSaveEDCMDC[5][6][valEDCorMDC]=num2str(V_min)      ButtSaveEDCMDC[6][6][valEDCorMDC]=num2str(V_max)   endifend	Function Butt_LoadEDCMDC (wavastr) 	String wavastr   wave/t ButtSaveEDCMDC   Nvar butt_set,buttload_check   Nvar MDC_flag,symon,butt_shift, Butt_range   Nvar ButtXminValue, ButtXmaxValue, normalizeON, MaxNormON, AllareaON, Butt_smooth   wave butt_graph,butt_angle,butt_Bold,butt_offset,butt_Goff   wave/t butt_color, memoT_Butt   svar memoButt   variable i, valEDCorMDC   string panelname,waveliststr   if (stringmatch(wavastr,"EDC"))   valEDCorMDC=0   MDC_flag=0   elseif (stringmatch(wavastr,"MDC"))   valEDCorMDC=1   MDC_flag=1   endif   if (stringmatch(ButtSaveEDCMDC[1][2][valEDCorMDC],"")!=1)   	butt_Goff[1,] = str2num(ButtSaveEDCMDC[p][0][valEDCorMDC])    	butt_graph[1,] = str2num(ButtSaveEDCMDC[p][1][valEDCorMDC])    	butt_angle[1,] = str2num(ButtSaveEDCMDC[p][2][valEDCorMDC])    	butt_offset[1,] = str2num(ButtSaveEDCMDC[p][3][valEDCorMDC])    	butt_color[1,] = ButtSaveEDCMDC[p][4][valEDCorMDC]    	butt_Bold[1,] = str2num(ButtSaveEDCMDC[p][5][valEDCorMDC])        	MDC_flag = str2num(ButtSaveEDCMDC[1][6][valEDCorMDC])    	if (valEDCorMDC==0)    	symon = str2num(ButtSaveEDCMDC[2][6][valEDCorMDC])    	endif    	butt_shift = str2num(ButtSaveEDCMDC[3][6][valEDCorMDC])    	Butt_range = str2num(ButtSaveEDCMDC[4][6][valEDCorMDC])     	ButtXminValue = str2num(ButtSaveEDCMDC[5][6][valEDCorMDC])      ButtXmaxValue = str2num(ButtSaveEDCMDC[6][6][valEDCorMDC])      Butt_smooth = str2num(ButtSaveEDCMDC[7][6][valEDCorMDC])   else   	//butt_Goff[1,] = 0    	//butt_graph[1,] = 0    	butt_angle[1,] = 0    	//butt_offset[1,] = 0    	//butt_color[1,] =""    	//butt_Bold[1,] = 1    //	MDC_flag = 0    	symon = 0    	butt_shift = 0    	Butt_range = 0     	endif   	  normalizeON=0 ; MaxNormON=0 ; AllareaON=0  	  ButtwaveInputFunc ("an",1)  	  //if (normalizeON==1  || MaxNormON==1)  	   // ButtwaveInputFunc ("an",1)  	  //endif   	Butt_offsetALlFunc ()    	Butt_ColorALlInput ()    	Butt_BoldAllInput ()    	InputGrFunc ()    	InputAnFunc ()    	InputoffFunc ()   	InputBoldFunc ()   	Butt_MDC_set (Butt_range,Butt_range)    	Butt_InputX ()    //	Butt_NormFunc () ; Butt_NormFunc ()endFunction Butt_XValue_menu (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr		if ( popnum==1 ) 		SetVariable Xmax, limits={-Inf,Inf,0.001}		SetVariable Xmin, limits={-Inf,Inf,0.001}		endif	  if ( popnum==2 ) 		SetVariable Xmax, limits={-Inf,Inf,0.01}		SetVariable Xmin, limits={-Inf,Inf,0.01}		endif		if ( popnum==3 ) 		SetVariable Xmax, limits={-Inf,Inf,0.1}		SetVariable Xmin, limits={-Inf,Inf,0.1}		endif	   if ( popnum==4 ) 		SetVariable Xmax, limits={-Inf,Inf,1}		SetVariable Xmin, limits={-Inf,Inf,1}		endif	   if ( popnum==5 ) 		SetVariable Xmax, limits={-Inf,Inf,10}		SetVariable Xmin, limits={-Inf,Inf,10}		endif	   if ( popnum==6 ) 		SetVariable Xmax, limits={-Inf,Inf,100}		SetVariable Xmin, limits={-Inf,Inf,100}		endif	   if ( popnum==7 ) 		SetVariable Xmax, limits={-Inf,Inf,1000}		SetVariable Xmin, limits={-Inf,Inf,1000}		endifEndproc Butt_AllaxisFunc(ctrlName) : ButtonControl	String ctrlName   	dowindow Button_graph    	if (V_flag == 1)       SetAxis/A/w=Button_graph      endifEndFunction Butt_GetXYfunc (ctrlName) : ButtonControl	String ctrlName   Butt_GetXY ()EndFunction Butt_GetXY ()	Nvar ButtXminValue,ButtXmaxValue	dowindow Button_graph	if (V_flag==1)	GetAxis/q/w=Button_graph bottom	ButtXminValue= V_min ; ButtXmaxValue= V_max 	endifendFunction Butt_InputXFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName   Butt_InputX ()EndFunction Butt_InputX ()   	Nvar  ButtXmaxValue,ButtXminValue   	dowindow Button_graph    	if (V_flag == 1)      SetAxis/w=Button_graph bottom ButtXminValue,ButtXmaxValue     endifendFunction ButTempThetaInfo (No) variable No svar ButtTemp, ButtTheta, ButtGraphNo wave Butt_angle, Butt_graph, Butt_Goff wave/t mapt if (Butt_graph[No] != Butt_Goff[No] &&  Butt_graph[No] != 0) ButtGraphNo = num2str(Butt_graph[No]) ButtTemp = mapt[Butt_graph[No]][9]+" K" ButtTheta = mapt[Butt_graph[No]][13]+" deg" else ButtGraphNo = " " ButtTemp = " " ButtTheta = " " endifendFunction Butt_adjustAngle (ctrlName) : ButtonControl	String ctrlName	wave Butt_angle	Butt_angle = 0	ButtwaveInputFunc_simple ("an",1)	InputAnFunc ()end		Function Butt_Update (ctrlName) : ButtonControl	String ctrlName	dowindow ButtDataSheet	if (V_flag==1)	  UseDataSheet ()	endif   	ButtUpdateFunc ()endFunction UseDataSheet () 	variable No	Nvar Butt_of	wave butt_graph, butt_angle, butt_Goff	wave/t Graph_, Slice_	Nvar butt_shift	variable TableSize       TableSize = numpnts(butt_graph)        Redimension/N=(TableSize) No_, Temp_K_, Graph_, Theta_deg_, Slice_    for (No=1 ; No<=Butt_of*10 ;No+=1)      if (stringmatch(Graph_[No]," ")!=1 && stringmatch(Graph_[No],"")!=1)       butt_graph[No] = str2num(Graph_[No])       butt_Goff[No] = floor(str2num(Graph_[No])/1000)*1000      else        butt_graph[No] = 0       butt_Goff[No] = 0      endif      if (stringmatch(Slice_[No]," ")!=1 && stringmatch(Slice_[No],"")!=1 )       butt_angle[No] = str2num(Slice_[No])-butt_shift      else        butt_angle[No] = 0      endif    endfor     InputGrFunc ()endFunction ButtUpdateFunc ()  ButtwaveInputFunc ("an",1)  InputAnFunc ()end		Function ButtUpdateFunc_simple ()  ButtwaveInputFunc_simple ("an",1)  InputAnFunc ()end		Function Butt_DataSheet (ctrlName) : ButtonControl	String ctrlName	string  waveliststr	variable i	dowindow/f ButtDataSheet	if (v_flag==1)	  Butt_ChangeDataSheetAll ()	else  	Edit/W=(50,44,719,259)	 Butt_InputDataSheet ()	dowindow/c ButtDataSheet  endIFendFunction Butt_ChangeDataSheetAll ()   variable No, page_i, i, TableSize   Nvar butt_of   wave/t No_, Graph_, Temp_K_, Theta_deg_      TableSize = numpnts(butt_angle)     if (exists("No_")!=1)        make/o/t/n=(TableSize) No_, Temp_K_, Graph_, Theta_deg_, Tilt_deg_, Psi_deg_, Slice_    else       Redimension/N=(TableSize) No_, Temp_K_, Graph_, Theta_deg_, Tilt_deg_, Psi_deg_, Slice_    endif for (page_i=1;page_i<=Butt_of;page_i+=1)   for (i=1;i<=10;i+=1)  		 No = (page_i-1)*10+i 	  Butt_ChangeDataSheetOne (No) 	endfor endforendFunction Butt_ChangeDataSheetOne (No)   variable No   wave/t mapt, tempT   string Graphstr, Anglestr   variable TableSize   wave butt_angle, Butt_graph, Butt_Goff   wave/t No_, Graph_, Temp_K_, Theta_deg_, Tilt_deg_, Psi_deg_, Slice_   Nvar butt_shift       No_[] = num2istr(p)    No_[0] = "Button"         Graphstr = num2str(Butt_graph[No])   if (Butt_graph[No] != Butt_Goff[No] &&  Butt_graph[No] != 0)   Graph_[No] = Graphstr   else   Graph_[No] = " "   endif   Anglestr =  num2str(Butt_angle[No]+butt_shift)   if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)   Slice_[No] = Anglestr   else   Slice_[No] = " "   endif      if (Butt_graph[No] != Butt_Goff[No] &&  Butt_graph[No] != 0)   Temp_K_[No] = mapt[Butt_graph[p]][9]+" K"   else   Temp_K_[No] = " "   endif   if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)   Theta_deg_[No] = mapt[Butt_graph[p]][13]+" deg"   else   Theta_deg_[No] = " "   endif      if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)   Tilt_deg_[No] = mapt[Butt_graph[p]][14]+" deg"   else   Tilt_deg_[No] = " "   endif      if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)   Psi_deg_[No] = mapt[Butt_graph[p]][15]+" deg"   else   Psi_deg_[No] = " "   endifendFunction Butt_ChangeDataSheet (No)   variable No   variable TableSize   wave/t No_, Graph_, Temp_K_, Theta_deg_    TableSize = numpnts(butt_angle)      make/o/t/n=(TableSize) No_, Temp_K_, Graph_, Theta_deg_    print "test"   Butt_ChangeDataSheetOne (No)endFunction Butt_InputDataSheet ()   wave/t mapt, tempT 	 variable  AngleChecked, FolderChecked, SampleChecked, SliceNoChecked, SweepChecked, PassEChecked, EiiChecked, EffChecked   variable EstepChecked, DateChecked, TimeChecked, TempChecked, XChecked, YChecked, ZChecked, ThetaChecked, TiltChecked, PsiChecked   variable Windex   string waveResult, Graphstr, anglestr   variable TableSize, page_i, i, No   wave butt_angle, Butt_graph, Butt_Goff   Nvar butt_of, butt_shift   TempChecked=1 //check necessary information   ThetaChecked=1    AngleChecked=1   TiltChecked=1   PsiChecked=1      TableSize = numpnts(butt_angle)      waveResult="No_"          make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = num2istr(p)      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult         waveResult="Graph_" for (page_i=1;page_i<=Butt_of;page_i+=1)   for (i=1;i<=10;i+=1)   No = (page_i-1)*10+i   make/o/t/n=(TableSize) tempT, $waveResult   Graphstr = num2str(Butt_graph[No])   if (Butt_graph[No] != Butt_Goff[No] &&  Butt_graph[No] != 0)   tempT[No] = Graphstr   else   tempT[No] = " "   endif   endfor endfor    tempT[0] = "Button"    duplicate/o tempT $waveResult    appendtotable $waveResult if (AngleChecked==1)      waveResult="Slice_"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult      anglestr = num2str(Butt_angle[No]+butt_shift)      if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)      tempT[No] = anglestr      else      tempT[No] = " "      endif      endfor     endfor      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResultendif if (TempChecked==1)      waveResult="Temp_K_"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult      if (Butt_graph[No] != Butt_Goff[No] &&  Butt_graph[No] != 0)      tempT[No] = mapt[Butt_graph[p]][9]+" K"      else      tempT[No] = " "      endif      endfor     endfor      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResultendif if (ThetaChecked==1)      waveResult="Theta_deg_"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult      if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)      tempT[No] = mapt[Butt_graph[p]][13]+" deg"      else      tempT[No] = " "      endif      endfor     endfor      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResultendif if (TiltChecked==1)      waveResult="Tilt_deg_"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult      if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)      tempT[No] = mapt[Butt_graph[p]][14]+" deg"      else      tempT[No] = " "      endif      endfor     endfor      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResultendif if (PsiChecked==1)      waveResult="Psi_deg_"     for (page_i=1;page_i<=Butt_of;page_i+=1)      for (i=1;i<=10;i+=1)      No = (page_i-1)*10+i      make/o/t/n=(TableSize) tempT, $waveResult      if (Butt_graph[No] != Butt_Goff[No] && Butt_graph[No] != 0)      tempT[No] = mapt[Butt_graph[p]][15]+" deg"      else      tempT[No] = " "      endif      endfor     endfor      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResultendif          if (FolderChecked==1)        waveResult="Folder"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][19]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif   if (SampleChecked==1)      waveResult="Sample"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][0]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif   if (SliceNoChecked==1)      waveResult="Slice"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][4]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (SweepChecked==1)      waveResult="Sweep"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][2]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (PassEChecked==1)      waveResult="PassE"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][3]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (EiiChecked==1)      waveResult="Ei_eV"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][5]+" eV"      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (EffChecked==1)      waveResult="Ef_eV"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][6]+" eV"      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (EstepChecked==1)      waveResult="Estep_eV"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][7]+" eV"      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (DateChecked==1)      waveResult="Date_"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][1]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (TimeChecked==1)      waveResult="Time_"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][8]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (XChecked==1)      waveResult="Xaxis"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][10]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (YChecked==1)      waveResult="Yaxis"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][11]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endif      if (ZChecked==1)      waveResult="Zaxis"      make/o/t/n=(TableSize) tempT, $waveResult      tempT[] = mapt[Butt_graph[p]][12]      tempT[0] = "Button"      duplicate/o tempT $waveResult      appendtotable $waveResult   endifendFunction Butt_resetFunc (ctrlName) : ButtonControl	String ctrlName	string name   wave butt_graph, butt_angle, butt_offset,butt_Goff,Butt_Bold   Nvar butt_shift,butt_range,symon,Mdc_flag   Nvar normalizeON, MaxNormON, AllareaON   wave/t butt_color   butt_graph[]=0   butt_angle[]=0   butt_offset[]=0   butt_Goff[]=0   Butt_Bold[]=1 //  butt_color[] = ""   butt_shift=0   butt_range=0   symon=0   Mdc_flag=0   normalizeON = 0   MaxNormON = 0   AllareaON = 0      InputGrFunc ()   InputAnFunc ()   InputoffFunc ()   InputBoldFunc ()   ButtwaveInputFunc ("an",1)    Butt_offsetALlFunc ()	 Butt_ColorALlInput ()	 Butt_BoldAllInput ()EndFunction ButtwaveInputFunc_simple (AnorGr,InputOn)   string AnorGr  variable InputOn	variable page_i, No,i	NVAR butt_of,Butt_shift, useAreaCheck, MDC_flag, Butt_smooth  wave butt_angle, butt_graph if (stringmatch(AnorGr,"an"))	for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 		 No = (page_i-1)*10+i 		 if ( stringmatch(num2str(butt_graph[No])[1,inf],"000")!=1 && stringmatch(num2str(butt_graph[No])[0],"0")!=1) 			 ButtFunc(No,AnorGr,butt_angle[No],InputOn)		 		 endif  	 endfor 	endfor 	  if (useAreaCheck==1 && MDC_flag==1)	      useEDCarea()	  endif elseif (stringmatch(AnorGr,"gr"))	for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 		 No = (page_i-1)*10+i 		 if ( stringmatch(num2str(butt_graph[No])[1,inf],"000")!=1 && stringmatch(num2str(butt_graph[No])[0],"0")!=1) 		    ButtFunc(No,AnorGr,butt_graph[No],InputOn) 		 endif 	 endfor 	endfor  endif//  if ( Butt_smooth==1 )//   ButtSmoothFunc ()//  endif   dowindow ButtDataSheet if (v_flag==1)    Butt_ChangeDataSheetAll () endifendFunction ButtwaveInputFunc (AnorGr,InputOn)   string AnorGr  variable InputOn	variable page_i, No,i	NVAR butt_of,Butt_shift, useAreaCheck, MDC_flag, Butt_smooth  wave butt_angle, butt_graph if (stringmatch(AnorGr,"an"))	for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 		 No = (page_i-1)*10+i 		 ButtFunc(No,AnorGr,butt_angle[No],InputOn) 	 endfor 	endfor 	  if (useAreaCheck==1 && MDC_flag==1)	      useEDCarea()	  endif elseif (stringmatch(AnorGr,"gr"))	for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 		 No = (page_i-1)*10+i 		 ButtFunc(No,AnorGr,butt_graph[No],InputOn) 	 endfor 	endfor  endif//  if ( Butt_smooth>0 )//   ButtSmoothFunc ()//  endif   dowindow ButtDataSheet if (v_flag==1)    Butt_ChangeDataSheetAll () endifendFunction Butt_ShiftProc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string AnorGr	Nvar Butt_Shift	Butt_Shift = varNum	AnorGr = "an"   ButtwaveInputFunc_simple (AnorGr,0)    InputAnFunc () EndFunction Butt_RangeProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string AnorGr	AnorGr = "an"   ButtwaveInputFunc_simple (AnorGr,1)    InputAnFunc ()EndFunction Butt_BoldFunc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	variable i,No	string name	Nvar Butt_page	wave butt_Bold    	DoWindow Button_Graphif (V_flag==1)	 	sscanf varName, "Butt_Bold%f", i		No = (Butt_page-1)*10+i		name = "Buttwave"+num2str(No)		ModifyGraph/w=Button_Graph lsize($name)=varNum		butt_Bold[No] = varNum		ButTempThetaInfo (No)endifendFunction Butt_BoldAllFunc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	variable i,No,page_i	string name	Nvar Butt_page,butt_of	wave butt_Bold for (page_i=1;page_i<=butt_of;page_i+=1)  for (i=1 ; i<=10 ; i+=1)	 No = (page_i-1)*10+i 	 butt_Bold[No] = varNum  endfor endfor  InputBoldFunc()  Butt_BoldAllInput ()endFunction Butt_BoldAllInput ()	variable i,No,page_i	string name	Nvar Butt_page,butt_of	wave butt_Bold	variable varNum	dowindow Button_graphif (V_flag==1)  for (page_i=1;page_i<=butt_of;page_i+=1)    for (i=1 ; i<=10 ; i+=1)      No = (page_i-1)*10+i      varNum =  butt_Bold[No]    	name = "Buttwave"+num2str(No)	   ModifyGraph/w=Button_graph lsize($name)=varNum	 endfor  endforendifendFunction ButtProc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	Svar butt_No1,butt_No2,butt_No3,butt_No4,butt_No5,butt_No6,butt_No7,butt_No8,butt_No9,butt_No10	wave butt_Goff	Svar Butt_ANorGR	Nvar Butt_i, ButtAllON,Butt_page,butt_shift	string AnorGr	variable i,No, InputOn	if (abs(varNum)<10^-5)	  varNum = 0	endif	 i=str2num(varName[7,strlen(varName)-1])	No = (Butt_page-1)*10+i	if (stringmatch(varName[5],"A"))		 AnorGr = "An"	 	ButtFunc(No,AnorGr,varNum-butt_shift,InputOn) 	elseif (stringmatch(varName[5],"G"))	 	AnorGr = "Gr"	 		 ButtFunc(No,AnorGr,varNum,InputOn) 	endif	if (stringmatch(AnorGr,"an"))     		InputAnFunc ()   	elseif (stringmatch(AnorGr,"gr"))     		InputGrFunc ()     		InputAnFunc ()   	endif   ButTempThetaInfo (No)   dowindow ButtDataSheet   if (V_flag==1)   Butt_ChangeDataSheetOne (No)   endifendFunction ButtFunc(No,AnorGr,varNum,InputOn) 	Variable No		string AnorGr	variable varNum, InputOn	string legtext, name, gr, buttname, values	variable dest, destgr, destan, i	NVAR MDC_flag, butt_leg, Butt_i	Nvar Butt_page, Butt_shift, butt_of, Butt_smooth	WAVE butt_angle, butt_graph, map	Svar Butt_ANorGR		if ( stringmatch(AnorGr,"An") )			if (InputOn==0)			butt_angle[No] = Butt_AnAdjust (varNum,No)			else			butt_angle[No] = varNum			endif		endif		if ( stringmatch(AnorGr,"Gr"))			if (InputOn==0)			butt_graph[No] = Butt_GrAdjust (varNum,No)			else			butt_graph[No] = varNum				endif		endif	dest = No	destan = butt_angle[No]+Butt_shift	destgr = butt_graph[No]		if ( MDC_flag==1 )		Butt_MDC( dest, destgr, destan )	else		Butt_EDC( dest, destgr, destan )	endif	if ( Butt_smooth>0 ) 		  ButtSmoothFunc_single (No)  endif  legendFunc ()EndFunction ButtSmoothFunc_single (No)variable Nonvar Butt_smoothstring source		source  = "Buttwave"+num2istr(No)		if (dimsize($source,0)!=0)		  smooth Butt_smooth,$source		endifEndFunction ButtSmoothFunc ()nvar Butt_smooth, butt_ofstring sourcevariable page_i, No,i	for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1)    No = (page_i-1)*10+i		source  = "Buttwave"+num2istr(No)		if (dimsize($source,0)!=0)		  smooth Butt_smooth,$source		endif	 endfor	endforEndFunction Butt_EDC( dest, destgr, destan )	variable dest, destgr, destan	string source_wave, dest_wave, dest_x, mom, xaxis	variable i, size, secord, Norm,j,Point_i,Point_f,Temperature	NVAR butt_shift, butt_range, normalizeON,symon, Butt_backgr_on,MaxNormON,AllareaOn,ButtFermiON	WAVE temp1, temp2, map, Butt_graph	Svar Yes_No_Convolution	dest_wave = "Buttwave"+num2istr(dest)	dest_x = "buttx"+num2istr(dest)	getwave( destgr, destan)			//  => temp1, temp2	duplicate /o temp1 temp	temp = 0     i = -butt_range     j=0	 do			 getwave(destgr,destan+i ) //  => temp1, temp2        temp+=temp1        i += 1        j += 1       	 while ( i<=butt_range )       temp/=j 	if (symon==1 && numpnts(temp1)!=0  )		  Symmetrization_button(temp2, temp, "tempscopeX", "tempscopeY")	    duplicate /o tempscopeX temp2	    duplicate /o tempscopeY temp	endif		if ( normalizeON==1 || MaxNormOn==1 || AllareaOn==1 && numpnts(temp1)!=0 )	     dowindow Button_graph 	      if (stringmatch(winname(0,1),"Button_graph")!=1)	        dowindow/f Button_graph	      endif	    if (V_flag==1) 	    	if (normalizeON==1)       		   Norm =  faverageXY (temp2,temp,hcsr(a),hcsr(b))       		   //Norm = areaXY(temp2,temp,hcsr(a),hcsr(b))		    		temp /= Norm	    		  	endif		  	if ( MaxNormON==1 )					  if (numpnts(temp2)!=0)	   		  	 findlevel/P/Q temp2 hcsr(a)		      	 Point_i = V_levelx	  	    	 findlevel/P/Q temp2 hcsr(b)		      	 Point_f = V_levelx			       wavestats/Q/R=[Point_i,Point_f] temp			       Norm =  V_max		   	     temp /= Norm		       endif			  endif			if ( AllareaOn==1 )            Norm =  faverageXY (temp2,temp,-inf,inf)       		   //Norm = areaXY(temp2,temp,hcsr(a),hcsr(b))		    		temp /= Norm	  			endif	   endif	endif	if (ButtFermiON==1 && numpnts(temp1)!=0  )        Temperature = map[Butt_graph[dest]][2]       // Temperature = map[Butt_graph[dest]][0]        if (stringmatch(Yes_No_Convolution,"yes"))           ButtFermiOne_Convolution (temp2,temp,"tempscopeX", "tempscopeY",Temperature)        elseif (stringmatch(Yes_No_Convolution,"No"))           ButtFermiOne (temp2, temp, "tempscopeX", "tempscopeY",temperature)        endif   	   duplicate /o tempscopeX temp2	     duplicate /o tempscopeY temp     	endif   	duplicate /o temp $dest_wave	duplicate /o temp2 $dest_xendFunction Ti_MDC( destgr, destan )	variable destgr, destan	variable  secord	string dwave, destx	variable i, j, step, size, Norm	,Point_i,Point_f	NVAR butt_range, butt_shift, normalizeON, Butt_backgr_on,MaxNormOn,AllareaOn	WAVE temp1, temp2, tempdwave = "Tiwave"+num2istr(destgr)		destx = "Tix"+num2istr(destgr)  if (stringmatch(num2str(destgr)[1,inf],"000")!=1 && stringmatch(num2str(destgr)[0],"0")!=1)  	getMapForMDC(destgr) //		temp=Ywave, temp2=Xwave  	getMDC (destan) // 		step = temp2[1]-temp2[0]		duplicate /o temp1, mdcout 		mdcout = 0		i = -butt_range		j=0			do					getMDC(destan+i)			mdcout += temp1			i += step			j += 1		while ( i<=(butt_range) )		mdcout /= j	//	print destgr, j  if ( normalizeON==1 || MaxNormOn==1 || AllareaOn==1 && numpnts(temp1)!=0 )	  if (normalizeON==1)		Norm =  faverage(mdcout,pcsr(a),pcsr(b))		mdcout /= Norm    endif 		if ( MaxNormON==1 )	     	findlevel/P/Q temp3 pcsr(a)	     	Point_i = V_levelx	     	findlevel/P/Q temp3 pcsr(b)	     	Point_f = V_levelx		    wavestats/Q/R=[Point_i,Point_f] mdcout		    Norm =  V_max		    mdcout /= Norm		endif	  if (AllareaOn==1)		Norm =  faverage(mdcout,-inf,inf)		mdcout /= Norm    endif endif		duplicate /o mdcout $dwave		duplicate /o temp3 $destx else    duplicate /o zerowave $dwave endifEndFunction Butt_MDC( dest, destgr, destan )	variable dest, destgr, destan	variable  secord	string dwave, destx	variable i, j, step, size, Norm	,Point_i,Point_f	NVAR butt_range, butt_shift, normalizeON, Butt_backgr_on,MaxNormOn,AllareaOn	WAVE temp1, temp2, temp  wave butt_graph  dwave = "buttwave"+num2istr(dest)		destx = "buttx"+num2istr(dest)  if (stringmatch(num2str(destgr)[1,inf],"000")!=1 && stringmatch(num2str(destgr)[0],"0")!=1)  	getMapForMDC(destgr) //		temp=Ywave, temp2=Xwave  	getMDC (destan) // 		step = temp2[1]-temp2[0]		duplicate /o temp1, mdcout 		mdcout = 0		i = -butt_range		j=0			do					getMDC(destan+i)			mdcout += temp1			i += step			j += 1		while ( i<=(butt_range) )		mdcout /= j	//	print destgr, j  	if ( normalizeON==1 || MaxNormOn==1 || AllareaOn==1 && numpnts(temp1)!=0 )		if (normalizeON==1)		Norm =  faverage(mdcout,pcsr(a),pcsr(b))		mdcout /= Norm		endif 		if ( MaxNormON==1 )	     	findlevel/P/Q temp3 pcsr(a)	     	Point_i = V_levelx	     	findlevel/P/Q temp3 pcsr(b)	     	Point_f = V_levelx		    wavestats/Q/R=[Point_i,Point_f] mdcout		    Norm =  V_max		    mdcout /= Norm		endif		if (AllareaOn==1)		Norm =  faverage(mdcout,-inf,inf)		mdcout /= Norm   		endif 	endif		duplicate /o mdcout $dwave		duplicate /o temp3 $destx else    duplicate /o zerowave $dwave endifEndFunction getMDC (energy)	variable energy	variable kpoints, cut	wave temp, temp2 // temp=Ywave, temp2=Xwave	kpoints = dimsize(temp,1)	make/o/n=(kpoints) temp1, temp3			findlevel /q temp2, energy						cut = V_levelX			variable delta=Dimdelta(temp,1)				variable offset=DimOffset(temp,1)					temp1[]=Interp2D(temp,cut,p*delta+offset)  // temp1: y wave			temp3[]=p*delta+offsetendFunction getMapForMDC (graph)  variable graph   Nvar useAreaCheck  SVAR dispwave  variable ef  string source_wave, energyaxis  wave map   ef = 0	source_wave = DispWave+num2istr(graph)	if ( stringmatch(dispwave,"cr") )		energyaxis = "cx"+num2istr(graph)	else		energyaxis = "gx"+num2istr(graph)		ef = map[graph][7]	endif	if (GraphOffCheckFunc (graph) )	  duplicate /o zerowave temp1	else				  if (useAreaCheck==0)			duplicate/o $source_wave temp  			duplicate/o $energyaxis temp2			temp2 -= ef     	  	elseif (useAreaCheck==1)			duplicate/o $source_wave temp			duplicate/o $energyaxis temp2 			temp2 -= ef			  getMDCfromSymMap (temp2,temp)		endif	endifendFunction getMDCfromSymMap (XWaveIn,YWaveIn)	Wave XWaveIn, YWaveIn	variable kpoints, energy	String XWaveOut, YWaveOut	Variable Estep, EF, EFchannel, dE, NormEi, NormEf, cut, i	Variable Npoints, Norm, NormA, NormB  NormEi=0.1 ; NormEf=XWaveIn[inf] // eV   	Npoints = DimSize(XWaveIn,0)  Estep = (XWaveIn[Npoints-1]-XWaveIn[0])/(Npoints-1)	findlevel/P/Q XWaveIn 0	if ( V_Flag == 1 )	  //Ef not defined		Abort "Cannot locate Ef !! \rCheck your map"	endif	EF = V_levelx	NormA =NormEi/Estep+EF	NormB =NormEf/Estep+EF	kpoints = dimsize(YWaveIn,1)  // create X wave	EFchannel = round(EF)	make/o/n=(2*EFchannel+1) tempX	make/o/n=(2*EFchannel+1,kpoints) tempY	tempX[0,npoints-1] = XWaveIn[p]	tempX[npoints,] = XWaveIn[npoints-1]+(p-npoints+1)*Estep  SetScale/P x XWaveIn[0],Estep,"", tempX, tempY  SetScale/P y 0,1,"", tempY  duplicate/o tempX, temp1, temp3    //extend background silent 1 ; pauseupdate   for (i=0 ; i<kpoints ; i+=1)   temp3[] = YWaveIn[p][i]	norm = faverage(temp3, normA, normB)	temp1[0,normB]=temp3[p]	temp1[normB,]=norm		execute "temp3() = temp1(x)+temp1(-x)"	tempY[][i] = temp3[p] endfor duplicate/o tempY tempduplicate/o tempX temp2EndFunction getpntSYM(tempX,p)wave tempXvariable pvariable Xvalwave tempXXval=-tempX[p]findlevel/Q tempX Xvalif (p==1)  print tempX[0], tempX[inf], "V_LevelX", V_LevelXendifreturn (V_LevelX)endFunction Symmetrization_button( XWaveIn, YWaveIn,  XWaveOut,  YWaveOut )	Wave XWaveIn, YWaveIn	String XWaveOut, YWaveOut	Variable Estep, EF, EFchannel, dE, NormEi, NormEf	Variable Npoints, Norm, NormA, NormB       NormEi=0.1 ; NormEf=XWaveIn[inf] // eV   	// determine energy step, rounded to 1meV	Npoints = DimSize(XWaveIn,0)	//	Estep = Round(1000*(XWaveIn[Npoints-1]-XWaveIn[0])/(Npoints-1))/1000   Estep = (XWaveIn[Npoints-1]-XWaveIn[0])/(Npoints-1)  //print XWaveIn[Npoints-1],XWaveIn[0],Estep 	//Locate EF = 0	findlevel/P/Q XWaveIn 0	if ( V_Flag == 1 )	  //Ef not defined		Abort "Cannot locate Ef !! \rCheck your map"	endif	EF = V_levelx	//NormA=xcsr(a) ; NormB=xcsr(b)	NormA =NormEi/Estep+EF	NormB =NormEf/Estep+EF	  // create X wave	EFchannel = round(EF)	make/o/n=(2*EFchannel+1) tempX	tempX[0,npoints-1] = XWaveIn[p]	tempX[npoints,] = XWaveIn[npoints-1]+(p-npoints+1)*Estep  SetScale/P x XWaveIn[0],Estep,"", tempX   duplicate/o tempX temp1, tempY   // extend background	norm = faverage(YWaveIn, normA, normB)	temp1[0,normB] = YWaveIn[p]	temp1[normB,] = norm	// symmetrize   execute "tempY() = temp1(x)+temp1(-x)"   SetScale/P x 0,1,"", tempX, temp1, tempY   // Output	duplicate/o tempX $XWaveOut	duplicate/o tempY $YWaveOutEndFunction GraphOffCheckFunc (graph)variable graphvariable OnOffif (graph==0||graph==1000||graph==2000||graph==3000||graph==4000||graph==5000||graph==6000||graph==7000||graph==8000||graph==9000) OnOff = 1elseif (graph==10000||graph==11000||graph==12000||graph==13000||graph==14000||graph==15000||graph==16000||graph==17000||graph==18000||graph==19000) OnOff = 1elseif (graph==20000||graph==21000||graph==22000||graph==23000||graph==24000||graph==25000||graph==26000||graph==27000||graph==28000||graph==29000) OnOff = 1elseif (graph==30000||graph==31000||graph==32000||graph==33000||graph==34000||graph==35000||graph==36000||graph==37000||graph==38000||graph==39000) OnOff = 1 elseif (graph==40000||graph==41000||graph==42000||graph==43000||graph==44000||graph==45000||graph==46000||graph==47000||graph==48000||graph==49000||graph==50000) OnOff = 1 else  OnOff = 0endifreturn OnOffendFunction Butt_AnAdjust (varNum,No) 	Variable varNum,No	svar dispwave	WAVE/t mapT	wave Butt_graph,Butt_Goff,map	Nvar ButtAllON, Butt_i,MDC_flag,Butt_shift	Svar dispwave	variable sliceNo, sliceEi,sliceEfif (MDC_flag==0)    sliceNo = str2num(mapT[Butt_graph[No]][4])-1    if ( varNum+Butt_shift<0)			varNum=-Butt_shift    elseif  (Butt_graph[No] == Butt_Goff[No] ||  Butt_graph[No] == 0)       varNum=-Butt_shift    elseif  (varNum+Butt_shift> sliceNo)        varNum=sliceNo-Butt_shift    endifelseif (MDC_flag==1)  if (stringmatch(dispwave,"Cr") ==1 )    duplicate/o $("cx"+num2str(Butt_graph[No])) temp    sliceEf= temp[numpnts($("cx"+num2str(Butt_graph[No])))-1]    sliceEi= temp[0]  else    sliceEi=str2num(mapT[Butt_graph[No]][5])-map[Butt_graph[No]][7]    sliceEf=str2num(mapT[Butt_graph[No]][6])-map[Butt_graph[No]][7]  endif    if ( varNum+Butt_shift<sliceEi)			varNum=sliceEi-Butt_shift    elseif  (Butt_graph[No] == Butt_Goff[No] ||  Butt_graph[No] == 0)       varNum=-Butt_shift    elseif  (varNum+Butt_shift > sliceEf)        varNum=sliceEf-Butt_shift    endifendif		return (varNum)End      Function Butt_GrAdjust (varNum,No) 	Variable varNum,No	svar dispwave	WAVE map, GrAllNum, NrAllNum, Butt_Goff	Nvar ButtAllON, Butt_iif (varNum<1000000)		if ( varNum<1 )		varNum=0	endif	if (stringmatch(dispwave,"gr") && varNum>Butt_Goff[No]+GrAllNum[Butt_Goff[No]/1000] )		varNum=Butt_Goff[No]+GrAllNum[Butt_Goff[No]/1000]	endif  if (stringmatch(dispwave,"nr") && varNum>Butt_Goff[No]+NrAllNum[Butt_Goff[No]/1000] )		varNum=Butt_Goff[No]+NrAllNum[Butt_Goff[No]/1000]	endif	  if (varNum< Butt_Goff[No])		 varNum=Butt_Goff[No]    endif   endif	if ( varNum>map[0][0] )		varNum=map[0][0]	endif		return (varNum)EndFunction Butt_ListGoffsetprocALL (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr  string popName, inputName  variable i, No, ipage,Goffvalue, InputOn  Nvar ButtAllON,Butt_i,Butt_page, Butt_of  wave butt_angle, butt_graph  sscanf popStr, "G%f", Goffvalue for (ipage=1 ; ipage<=Butt_of ; ipage+=1) 	for (i=1 ; i<=10 ; i+=1)	No = (ipage-1)*10+i	ListGoffsetFunc (No,Goffvalue) // adjust graphNo by Goffset   ButtFunc(No,"gr",butt_graph[No],InputOn)	 	endfor endfor   InputGrFunc ()  dowindow ButtDataSheetif (v_flag==1)  Butt_ChangeDataSheetAll ()endifendFunction Butt_ListGoffsetproc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string inputName	Nvar ButtAllON,Butt_i,Butt_page	variable i, No,Goffvalue, InputOn	wave butt_angle, butt_graph, butt_Goff	sscanf ctrlName, "Goffpop%f", i 	No = (Butt_page-1)*10+i	sscanf popStr, "G%f", Goffvalue	ListGoffsetFunc (No,Goffvalue) // adjust graphNo by Goffset 	ButtFunc(No,"gr",butt_graph[No],InputOn)		InputGrFunc ()	ButTempThetaInfo (No)	Butt_ChangeDataSheetOne (No)EndFunction ListGoffsetFunc (No,Goffvalue)   variable No,Goffvalue  string butt_grStr	Svar dispwave	wave map, GrAllNum, NrAllNum, butt_angle, butt_graph, butt_Goff	Nvar Butt_page  if (stringmatch(dispwave,"nr") && NrAllNum[Goffvalue/1000]==0)  abort "There is no normalized data!!"  endif  	 if ( Goffvalue>=map[0][0] )		   Goffvalue=map[0][0]-1000	 endif	 if (butt_graph[No] < Goffvalue)      for (butt_graph[No]=butt_graph[No];butt_graph[No] <= Goffvalue+1000;butt_graph[No]+=1000)      endfor   endif   if (butt_graph[No] > Goffvalue)     for (butt_graph[No]=butt_graph[No];butt_graph[No] >= Goffvalue+1000;butt_graph[No]-=1000)     endfor     if (stringmatch(dispwave,"gr") && butt_graph[No] > Goffvalue+GrAllNum[Goffvalue/1000])		   butt_graph[No]=Goffvalue+GrAllNum[Goffvalue/1000]     endif      if (stringmatch(dispwave,"nr") && butt_graph[No] > Goffvalue+NrAllNum[Goffvalue/1000])		   butt_graph[No]=Goffvalue+NrAllNum[Goffvalue/1000]     endif    endif   butt_Goff[No]=GoffvalueendFunction Butt_Pagefunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	PagefuncButt ()end	Function PagefuncButt ()	Nvar Butt_page,Butt_of	Svar butt_No1,butt_No2,butt_No3,butt_No4,butt_No5,butt_No6,butt_No7,butt_No8,butt_No9,butt_No10  if (Butt_page<=Butt_of) 	butt_No1=num2istr( (Butt_page-1)*10+1 )	butt_No2=num2istr( (Butt_page-1)*10+2 )	butt_No3=num2istr( (Butt_page-1)*10+3 )	butt_No4=num2istr( (Butt_page-1)*10+4 )	butt_No5=num2istr( (Butt_page-1)*10+5 )	butt_No6=num2istr( (Butt_page-1)*10+6 )	butt_No7=num2istr( (Butt_page-1)*10+7 )	butt_No8=num2istr( (Butt_page-1)*10+8 )	butt_No9=num2istr( (Butt_page-1)*10+9 )	butt_No10=num2istr( (Butt_page-1)*10+10 )	else 	Butt_page=Butt_of	endif	InputGrFunc ()	InputAnFunc ()	InputOffFunc ()	InputBoldFunc ()end	Function InputGrFunc () Svar butt_No1,butt_No2,butt_No3,butt_No4,butt_No5,butt_No6,butt_No7,butt_No8,butt_No9,butt_No10 variable i1,i2,i3,i4,i5,i6,i7,i8,i9,i10 wave butt_graph Nvar Butt_gr1,Butt_gr2,Butt_gr3,Butt_gr4,Butt_gr5,Butt_gr6,Butt_gr7,Butt_gr8,Butt_gr9,Butt_gr10 i1=str2num(butt_No1);i2=str2num(butt_No2);i3=str2num(butt_No3);i4=str2num(butt_No4);i5=str2num(butt_No5) i6=str2num(butt_No6);i7=str2num(butt_No7);i8=str2num(butt_No8);i9=str2num(butt_No9);i10=str2num(butt_No10) Butt_gr1=butt_graph[i1] Butt_gr2=butt_graph[i2] Butt_gr3=butt_graph[i3] Butt_gr4=butt_graph[i4] Butt_gr5=butt_graph[i5] Butt_gr6=butt_graph[i6] Butt_gr7=butt_graph[i7] Butt_gr8=butt_graph[i8] Butt_gr9=butt_graph[i9] Butt_gr10=butt_graph[i10]endFunction InputAnFunc () Svar butt_No1,butt_No2,butt_No3,butt_No4,butt_No5,butt_No6,butt_No7,butt_No8,butt_No9,butt_No10 variable i1,i2,i3,i4,i5,i6,i7,i8,i9,i10  Nvar Butt_an1,Butt_an2,Butt_an3,Butt_an4,Butt_an5,Butt_an6,Butt_an7,Butt_an8,Butt_an9,Butt_an10, Butt_shift wave butt_angle i1=str2num(butt_No1);i2=str2num(butt_No2);i3=str2num(butt_No3);i4=str2num(butt_No4);i5=str2num(butt_No5) i6=str2num(butt_No6);i7=str2num(butt_No7);i8=str2num(butt_No8);i9=str2num(butt_No9);i10=str2num(butt_No10) Butt_an1=butt_angle[i1]+Butt_shift Butt_an2=butt_angle[i2]+Butt_shift Butt_an3=butt_angle[i3]+Butt_shift Butt_an4=butt_angle[i4]+Butt_shift Butt_an5=butt_angle[i5]+Butt_shift Butt_an6=butt_angle[i6]+Butt_shift Butt_an7=butt_angle[i7]+Butt_shift Butt_an8=butt_angle[i8]+Butt_shift Butt_an9=butt_angle[i9]+Butt_shift Butt_an10=butt_angle[i10]+Butt_shiftendFunction InputoffFunc () Svar butt_No1,butt_No2,butt_No3,butt_No4,butt_No5,butt_No6,butt_No7,butt_No8,butt_No9,butt_No10 variable i1,i2,i3,i4,i5,i6,i7,i8,i9,i10 wave butt_offset Nvar Butt_off1,Butt_off2,Butt_off3,Butt_off4,Butt_off5,Butt_off6,Butt_off7,Butt_off8,Butt_off9,Butt_off10 i1=str2num(butt_No1);i2=str2num(butt_No2);i3=str2num(butt_No3);i4=str2num(butt_No4);i5=str2num(butt_No5) i6=str2num(butt_No6);i7=str2num(butt_No7);i8=str2num(butt_No8);i9=str2num(butt_No9);i10=str2num(butt_No10) Butt_off1=butt_offset[i1] Butt_off2=butt_offset[i2] Butt_off3=butt_offset[i3] Butt_off4=butt_offset[i4] Butt_off5=butt_offset[i5] Butt_off6=butt_offset[i6] Butt_off7=butt_offset[i7] Butt_off8=butt_offset[i8] Butt_off9=butt_offset[i9] Butt_off10=butt_offset[i10]endFunction InputBoldFunc () Svar butt_No1,butt_No2,butt_No3,butt_No4,butt_No5,butt_No6,butt_No7,butt_No8,butt_No9,butt_No10 variable i1,i2,i3,i4,i5,i6,i7,i8,i9,i10 wave butt_Bold Nvar butt_Bold1,butt_Bold2,butt_Bold3,butt_Bold4,butt_Bold5,butt_Bold6,butt_Bold7,butt_Bold8,butt_Bold9,butt_Bold10 i1=str2num(butt_No1);i2=str2num(butt_No2);i3=str2num(butt_No3);i4=str2num(butt_No4);i5=str2num(butt_No5) i6=str2num(butt_No6);i7=str2num(butt_No7);i8=str2num(butt_No8);i9=str2num(butt_No9);i10=str2num(butt_No10) Butt_Bold1=butt_Bold[i1] Butt_Bold2=butt_Bold[i2] Butt_Bold3=butt_Bold[i3] Butt_Bold4=butt_Bold[i4] Butt_Bold5=butt_Bold[i5] Butt_Bold6=butt_Bold[i6] Butt_Bold7=butt_Bold[i7] Butt_Bold8=butt_Bold[i8] Butt_Bold9=butt_Bold[i9] Butt_Bold10=butt_Bold[i10]endFunction Butt_offAllProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string offName	Nvar butt_of,Butt_offAll	wave butt_offset	variable i, page_i, No  if (abs(varNum)<10^-5)	 varNum = 0 ; Butt_offAll=0	endiffor (page_i=1;page_i<=butt_of;page_i+=1)	for (i=1;i<=10;i+=1)		No=(page_i-1)*10+i     butt_offset[No] = varNum*(No-1)   endforendfor 	 Butt_offsetALlFunc ()   InputoffFunc ()endFunction Butt_offEachProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	wave butt_offset	variable offNo, No	Nvar Butt_page	if (abs(varNum)<10^-5)	 varNum = 0	endif	sscanf varName, "Butt_off%f", offNo	No=(Butt_page-1)*10+offNo   butt_offset[No] = varNum	Butt_offsetEachFunc (No)	ButTempThetaInfo (No)	Inputofffunc()endFunction Butt_offsetEachFunc (No)   variable No	string name, offname	string numstr	NVAR Butt_page	WAVE butt_graph, butt_offset	dowindow Button_Graph	if (V_flag == 1)			name="Buttwave"+num2istr(No)						modifygraph/w=Button_Graph offset($name)={0,butt_offset[No]}	endifEndFunction Butt_offsetAllFunc ()	string name, offname	Variable i,No,page_i	NVAR Butt_of	WAVE butt_graph, butt_offset	String numstr	DoWindow Button_Graph 	if (V_flag == 1)	for (page_i=1;page_i<=Butt_of;page_i+=1)	 for  ( i=1; i<=10; i+=1 )	   No=(page_i-1)*10+i			name="Buttwave"+num2istr(No)						modifygraph/w=Button_Graph offset($name)={0,butt_offset[No]}	 endfor		endfor	endifEndProc Butt_ShowGraph (ctrlName) : ButtonControl	String ctrlName	string panelname="Button_Graph"	dowindow/f $panelname	if (v_flag!=1)     Button_Graph()     //Butt_EDCMDC ("EDC")	endif	dowindow/f ButtonGraph//	Butt_Update ("")Endproc showButtExtra (ctrlName) : ButtonControl	String ctrlName   dowindow/f ButtonExtra	if (V_flag!=1)    ButtonExtra()	endif   EndFUnction Butt_OffValmenuFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string offName	variable i		if ( popnum==1 ) 	  	 	for (i=1 ; i<=10 ; i+=1)		  	 offName = "ButtOff" + num2istr(i)	    		SetVariable $offName, limits={-Inf,Inf,0.01}	  	 	endfor	  	 	SetVariable ButtOffAll, limits={-Inf,Inf,0.01}		endif	  if ( popnum==2 ) 	  	 	for (i=1 ; i<=10 ; i+=1)		  	 offName = "ButtOff" + num2istr(i)	    		SetVariable $offName, limits={-Inf,Inf,0.1}	  	 	endfor	  	 	SetVariable ButtOffAll, limits={-Inf,Inf,0.1}		endif		if ( popnum==3 ) 	  	 	for (i=1 ; i<=10 ; i+=1)		  	 offName = "ButtOff" + num2istr(i)	    		SetVariable $offName, limits={-Inf,Inf,1}	  	 	endfor	  	 	SetVariable ButtOffAll, limits={-Inf,Inf,1}		endif	   if ( popnum==4 ) 	  	 	for (i=1 ; i<=10 ; i+=1)		  	 offName = "ButtOff" + num2istr(i)	    		SetVariable $offName, limits={-Inf,Inf,10}	  	 	endfor	  	 	SetVariable ButtOffAll, limits={-Inf,Inf,10}		endif	   if ( popnum==5 ) 	  	 	for (i=1 ; i<=10 ; i+=1)		  	 offName = "ButtOff" + num2istr(i)	    		SetVariable $offName, limits={-Inf,Inf,100}	  	 	endfor	  	 	SetVariable ButtOffAll, limits={-Inf,Inf,100}		endif	   if ( popnum==6 ) 	  	 	for (i=1 ; i<=10 ; i+=1)		  	 offName = "ButtOff" + num2istr(i)	    		SetVariable $offName, limits={-Inf,Inf,1000}	  	 	endfor	  	 	SetVariable ButtOffAll, limits={-Inf,Inf,1000}		endif	   if ( popnum==7 ) 	  	 	for (i=1 ; i<=10 ; i+=1)		  	 offName = "ButtOff" + num2istr(i)	    		SetVariable $offName, limits={-Inf,Inf,10000}	  	 	endfor	  	 	SetVariable ButtOffAll, limits={-Inf,Inf,10000}		endif			  	 	Endproc InputButt_gr ()   variable i=1  string butt_grStr  silent 1 ; pauseupdate   if (ButtAllON==1)  do    butt_grStr = "butt_gr" + num2istr(i)    $butt_grStr = butt_graph[i]    i+=1  while (i<=30)  else     butt_grStr = "butt_gr" + num2istr(Butt_i)    $butt_grStr = butt_graph[Butt_i]  endifend   proc InputButt_an ()  variable i=1  string butt_anStr  silent 1 ; pauseupdate  if (ButtAllON==1)    do    butt_anStr = "butt_an" + num2istr(i)    $butt_anStr = butt_angle[i]    i+=1    while (i<=30)  else     butt_anStr = "butt_an" + num2istr(Butt_i)    $butt_anStr = butt_angle[Butt_i]  endifend  Function Butt_sym_check(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  string source, sourceX	variable i  NVAR symon, MDC_flag  NVAR butt_an1, butt_an2, butt_an3, butt_an4, butt_an5, butt_an6, butt_an7, butt_an8, butt_an9, butt_an10	   symon = checked	  if (MDC_flag==0)	     ButtwaveInputFunc_simple ("an",1) 	     InputAnFunc () 	  endif EndWindow buttdisp() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(802,62,1011,170)	ShowTools	ValDisplay valdisp0,pos={10,4},size={159,17},title="butt area1"	ValDisplay valdisp0,limits={0,0,0},barmisc={0,1000},value= #"buttarea1"	ValDisplay valdisp0_1,pos={10,24},size={159,17},title="butt area2"	ValDisplay valdisp0_1,limits={0,0,0},barmisc={0,1000},value= #"buttarea2"	ValDisplay valdisp0_2,pos={46,44},size={123,17},title="ratio"	ValDisplay valdisp0_2,limits={0,0,0},barmisc={0,1000},value= #"buttarea3"	ValDisplay valdisp0_3,pos={1,85},size={157,17},title="moment diff"	ValDisplay valdisp0_3,limits={0,0,0},barmisc={0,1000},value= #"buttarea5"	ValDisplay valdisp0_4,pos={12,64},size={157,17},title="difference"	ValDisplay valdisp0_4,limits={0,0,0},barmisc={0,1000},value= #"buttarea4"EndMacroFunction getwave( graph, angle )	Variable graph, angle  	Variable waveID, epoints	String source_wave, dest_wave,xaxis	SVAR dispwave	WAVE map, graphlist, zerowave// if ( (map[graph][0]==1) && (map[graph][1]==0) ) 	   	if (angle < 0 || angle >= GetGraphDim(graph,1) || GraphOffCheckFunc(graph)) 					duplicate /o zerowave temp1			duplicate /o zerowave temp2				else			epoints = GetGraphDim(graph,0)					source_wave = DispWave+num2istr(graph)			make /o /n=(epoints) temp1			duplicate /o $source_wave temp2			temp1 = temp2[p][angle]			if ( (stringmatch(dispwave,"cr")) || (stringmatch(dispwave,"ak")))				xaxis = "cx"+num2istr(graph)				duplicate /o $xaxis temp2			else				xaxis = "gx"+num2istr(graph)				duplicate /o $xaxis temp2				temp2 -= map[graph][7]			endif		endif//	else//		duplicate /o zerowave temp1, temp2//	endifendProc Butt_ScaleX(ctrlName) : ButtonControl	String ctrlName	Variable varNum,center	String varStr	String varName	string name, xname, fitname, backgr	variable i	WAVE butt_graph	backgr = "backgr"+num2istr(butt_graph[i])	i=1	do		if (butt_graph[i]!=0)			name = "Buttwave"+num2istr(i)			backgr = "backgr"+num2istr(butt_graph[i])			fitname = "fit_"+name			xname = "Buttx"+num2istr(i)						smooth 10,$name			if (Butt_backgr_on==1)				$name -= $backgr				endif			wavestats /q $name			center = V_maxloc			curvefit  /q gauss $name(center-(171-center)*.5-1,center+(171-center)*.3)  /x=$xname /d			wavestats /q $fitname			$name /= V_max		//	print center,V_max			center = W_coef[2]			$xname /= abs(center)		endif		i+=1	while ( i<=30 )EndFunction Butt_legend(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR butt_leg	butt_leg=checked  legendFunc ()EndFunction legendFunc ()  Nvar butt_of, butt_leg  string legtext, name, gr, values  variable i  wave butt_graph  wave/t mapt  	if ( butt_leg==1 )		textbox/k/n=text0		legtext=""		for ( i=1; i<=butt_of*10; i+=1 )			if ( butt_graph[i]!=0 )				name = "\\s(Buttwave"+num2istr(i)+") "				gr = "butt_gr"+num2istr(i)				//sprintf values "\\Z10\\s(Buttwave%g) %g: %gK, %geV, (%g,%g)",i,butt_graph[i],map[butt_graph[i]][2],map[butt_graph[i]][4],map[butt_graph[i]][5],map[butt_graph[i]][6]				sprintf values "\\Z14\\s(Buttwave%g) G%g: %s K, %s deg",i,butt_graph[i],mapt[butt_graph[i]][9],mapt[butt_graph[i]][13]				legtext += values				if ( i<10 )					legtext += "\r"				endif			endif		endfor		Legend/C/N=text0/J/F=0 legtext	else	Legend/K/N=text0	endifendFunction legendFunc_back ()  Nvar butt_of, butt_leg  string legtext, name, gr, values  variable i  wave butt_graph, map  	if ( butt_leg==1 )		textbox/k/n=text0		legtext=""		for ( i=1; i<=butt_of*10; i+=1 )			if ( butt_graph[i]!=0 )				name = "\\s(Buttwave"+num2istr(i)+") "				gr = "butt_gr"+num2istr(i)				//sprintf values "\\Z10\\s(Buttwave%g) %g: %gK, %geV, (%g,%g)",i,butt_graph[i],map[butt_graph[i]][2],map[butt_graph[i]][4],map[butt_graph[i]][5],map[butt_graph[i]][6]				sprintf values "\\Z14\\s(Buttwave%g) G%g: %g K, %g deg",i,butt_graph[i],map[butt_graph[i]][2],map[butt_graph[i]][6]				legtext += values				if ( i<10 )					legtext += "\r"				endif			endif		endfor		Legend/C/N=text0/J/F=0 legtext	else	Legend/K/N=text0	endifendFunction ButtStats(ctrlName) : ButtonControl	String ctrlName		variable epoints, sigma, sqrN, N, a	epoints=dimsize(buttwave1,0)	CurveFit /q poly 7,Buttwave1[pcsr(A),pcsr(B)] /X=buttx1 /D 	sigma=sqrt(V_chisq/abs(pcsr(B)-pcsr(A)))	N=faverage(buttwave1,xcsr(A),xcsr(B))	print "Sigma: ", sigma,"    N: ",N,"    Sqrt(N): ",sqrt(N)," MCF: ",N/sigma/sigmaEndFunction Butt_backgr(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR Butt_backgr_on	NVAR butt_an1, butt_an2, butt_an3, butt_an4, butt_an5, butt_an6, butt_an7, butt_an8, butt_an9, butt_an10	Butt_backgr_on=checked  // ButtInputFunc () EndFunction Butt_Load_param (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName   wave/t ButtSaveTable   Nvar butt_set,buttload_check   Nvar MDC_flag,symon,butt_shift, Butt_range   Nvar ButtXminValue, ButtXmaxValue, normalizeON, MaxNormON, AllareaOn, Butt_Smooth   wave butt_graph,butt_angle,butt_Bold,butt_offset,butt_Goff   wave/t butt_color, memoT_Butt   svar memoButt   variable i, memoTsize   string panelname,waveliststr   memoTsize = dimsize(memoT_Butt,0)  if (butt_set >= memoTsize)   butt_set = memoTsize-1  endif     memoButt = memoT_Butt[butt_set]   if ( buttload_check==1 )    if (stringmatch(ButtSaveTable[1][0][butt_set],"")!=1)    butt_Goff[1,] = str2num(ButtSaveTable[p][0][butt_set])    butt_graph[1,] = str2num(ButtSaveTable[p][1][butt_set])    butt_angle[1,] = str2num(ButtSaveTable[p][2][butt_set])    butt_offset[1,] = str2num(ButtSaveTable[p][3][butt_set])    butt_color[1,] = ButtSaveTable[p][4][butt_set]    butt_Bold[1,] = str2num(ButtSaveTable[p][5][butt_set])        MDC_flag = str2num(ButtSaveTable[1][6][butt_set])    symon = str2num(ButtSaveTable[2][6][butt_set])    butt_shift = str2num(ButtSaveTable[3][6][butt_set])    Butt_range = str2num(ButtSaveTable[4][6][butt_set])    ButtXminValue = str2num(ButtSaveTable[5][6][butt_set])    ButtXmaxValue = str2num(ButtSaveTable[6][6][butt_set])    Butt_Smooth = str2num(ButtSaveTable[7][6][butt_set])        normalizeON = 0    MaxNormON = 0    AllareaOn = 0    else    butt_Goff[1,] = 0    butt_graph[1,] = 0    butt_angle[1,] = 0    butt_offset[1,] = 0   // butt_color[1,] =""    butt_Bold[1,] = 1    MDC_flag = 0    symon = 0    butt_shift = 0    Butt_range = 0       endif         // dowindow Button_graph // if (stringmatch(winname(0,2),"Button_graph")!=1)  //dowindow/f Button_graph  //endif   normalizeON=0 ; MaxNormON=0 ; AllareaON=0   ButtwaveInputFunc ("an",1)   Butt_offsetALlFunc ()    Butt_ColorALlInput ()    Butt_BoldAllInput ()    InputGrFunc ()    InputAnFunc ()    InputoffFunc ()   InputBoldFunc ()   Butt_MDC_set (Butt_range,Butt_range)    Butt_InputX ()   // Butt_NormFunc ()endifendFunction Butt_NormFunc () Nvar normalizeON,MaxNormOn,AllareaOn NVAR butt_of,Butt_shift string dest_wave, dest_x variable page_i, No,i, Norm, Point_i, Point_f 	for (page_i=1;page_i<=butt_of;page_i+=1) 	 for (i=1 ; i<=10 ; i+=1) 	     	dest_wave = "Buttwave"+num2istr(i)        	dest_x = "buttx"+num2istr(i)        	duplicate/o $dest_wave temp        	duplicate/o $dest_x temp2	 if ( normalizeON==1 || MaxNormOn==1 || AllareaOn==1 && numpnts(temp)!=0 )	  			 dowindow Button_graph 	   	if (stringmatch(winname(0,1),"Button_graph")!=1)	     	 dowindow/f Button_graph	     endif	   if (V_flag==1) 			   //if (Butt_backgr_on)			   //size = dimsize(temp,0)		  		//secord = faverage(temp,size-21,size-1)			  //temp-= secord          //endif	   	if (normalizeON==1)       		 Norm =  faverageXY (temp2,temp,hcsr(a),hcsr(b))		    		temp /= Norm	 		    		//print norm   			endif			if ( MaxNormON==1 )	     	findlevel/P/Q temp2 hcsr(a)	     	Point_i = V_levelx	     	findlevel/P/Q temp2 hcsr(b)	     	Point_f = V_levelx		    wavestats/Q/R=[Point_i,Point_f] temp		    Norm =  V_max		    temp /= Norm			endif			if (AllareaOn==1)       		 Norm =  faverageXY (temp2,temp,-inf,inf)		    		temp /= Norm	  			endif	  endif	 endif	duplicate /o temp $dest_wave	duplicate /o temp2 $dest_x	endforendforend Function Butt_save_param (ctrlname) : ButtonControl	string ctrlname   wave/t ButtSaveTable   Nvar butt_set   Nvar MDC_flag,symon,butt_shift, Butt_range, ButtXminValue, ButtXmaxValue, Butt_Smooth   wave butt_graph,butt_angle,butt_Bold,butt_offset,butt_Goff   wave/t butt_color,memoT_Butt,ButtSaveTable   variable NewSize, Oldsize, memoTsize   svar memoButt   Oldsize = dimsize(ButtSaveTable,0)   Newsize = dimsize(butt_graph,0)   memoTsize = dimsize(memoT_Butt,0)   if (Newsize>Oldsize)   Redimension/N=(Newsize,7,memoTsize) ButtSaveTable   else   Redimension/N=(Oldsize,7,memoTsize) ButtSaveTable   endif      Butt_GetXY ()      ButtSaveTable[][0][butt_set]=num2str(butt_Goff[p]) ; ButtSaveTable[0][0][butt_set]="Butt_Goff"   ButtSaveTable[][1][butt_set]=num2str(butt_graph[p]) ; ButtSaveTable[0][1][butt_set]="Butt_graph"   ButtSaveTable[][2][butt_set]=num2str(butt_angle[p]) ; ButtSaveTable[0][2][butt_set]="Butt_angle"   ButtSaveTable[][3][butt_set]=num2str(butt_offset[p]) ; ButtSaveTable[0][3][butt_set]="Butt_offset"   getAllColor ()    ButtSaveTable[][4][butt_set]=butt_color[p] ; ButtSaveTable[0][4][butt_set]="Butt_color"   ButtSaveTable[][5][butt_set]=num2str(butt_Bold[p]) ; ButtSaveTable[0][5][butt_set]="Butt_Bold"      ButtSaveTable[0][6][butt_set]="CheckList"   ButtSaveTable[1][6][butt_set]=num2str(MDC_flag)   ButtSaveTable[2][6][butt_set]=num2str(symON)    ButtSaveTable[3][6][butt_set]=num2str(butt_shift)    ButtSaveTable[4][6][butt_set]=num2str(Butt_range)    ButtSaveTable[5][6][butt_set]=num2str(ButtXminValue)    ButtSaveTable[6][6][butt_set]=num2str(ButtXmaxValue)   ButtSaveTable[7][6][butt_set]=num2str(Butt_Smooth)       memoT_Butt[butt_set] = memoButtendFunction getAllColor () 	string waveliststr,source, TraceInformation, pieceStr, color	variable i,j, pieceNum, wavenum 	wave/t butt_color	dowindow Button_graphif (V_flag==1)    waveliststr = TraceNameList("Button_graph",";",1)    wavenum = ItemsInList(waveliststr) 	 for (i=0 ; i < wavenum ; i+=1) 	   source = StringFromList(i, waveliststr)	   TraceInformation =  TraceInfo("Button_graph", source, 0)	   pieceNum = ItemsInList (TraceInformation,";")      	for (j=0 ; j < pieceNum ; j+=1)   	   pieceStr =	StringFromList(j, TraceInformation)   	   if (stringmatch(pieceStr,"rgb(x)=*") == 1)   	      color =  pieceStr[strlen("rgb(x)="),strlen(pieceStr)-1]   	        butt_color[i+1] = color        endif          endfor    endforendifEndFunction MemoButtListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "MemoButtList"	wave/t memoT_Butt	dowindow/f $panelname	if (v_flag!=1)	edit memoT_Butt	dowindow/c $panelname	endif	dowindow/f ButtonGraphend	Function buttload_cbox(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR buttload_check	buttload_check=checkedEndProc ButtonProc_Fit(ctrlName) : ButtonControl	String ctrlName	variable left, right	string destdisp, destwidth//	buttproc("",34,"34","butt_an1")	destdisp = "dMDC"+num2istr(butt_gr1)		destwidth = "wMDC"+num2istr(butt_gr1)	left = faverage(buttwave1,xcsr(a),xcsr(a)+3)	right = faverage(buttwave1,xcsr(b)-4,xcsr(b))		//print left,right		buttwave1-=((left+right)/2+(left-right)/(xcsr(a)-xcsr(b))*x)	curvefit  lor buttwave1 (xcsr(a),xcsr(b)) /d	$destdisp[butt_an1]=w_coef[2]	$destwidth[butt_an1]=sqrt(w_coef[3])EndFunction MDCfit(graph)	variable graph	string destdispd,destdispw, enerwave	string destwidth	string destback,destslope	variable i,kpoints,epoints,center,NoFitCh=29,chan, starta,startb, enstep   NVAR butt_an9, butt_an10	WAVE nil, w_coef, temp	destdispd = "dMDCone"+num2istr(graph) 	destwidth = "wMDCone"+num2istr(graph) 	enerwave="enMDCone"+num2istr(graph)    destback = "bck"+num2istr(graph)	destslope = "slp"+num2istr(graph)  epoints = GetGraphDim(graph,0)	kpoints = GetGraphDim(graph,1)   make /o /n=(epoints) mdcfitd	make /o /n=(epoints) mdcfitw	make /o /n=(epoints) mdcfitbck	make /o /n=(epoints) mdcfitslp	mdcfitd = nil; 	mdcfitw = nil;    i = butt_an9	dowindow /f Button_Graph	starta = pcsr(A)	startb = pcsr(B)		butt_MDC(10, graph, i )			wavestats  /q /r=(starta,startb) /q buttwave10		center=v_maxloc	do		butt_MDC(10,graph,i)			findlevel/q temp,i		chan = V_levelX		enstep=temp[2]-temp[1]		//print i, chan		curvefit /q /l=1000  lor  buttwave10(center-25-abs(i*40),center+25+abs(i*40)) /d     center=(w_coef[2])		mdcfitd[chan] = (w_coef[2])  		mdcfitw[chan] = sqrt(w_coef[3])      	i -= enstep				duplicate /o temp $enerwave		duplicate /o mdcfitd $destdispd	   duplicate /o mdcfitw $destwidth	while( i >= butt_an10 )	EndFunction MDCfit2(graph,startPoint, endPoint)	variable graph, startPoint, endPoint	string destdispd1,destdispd2	string destwidth	string enerwave	string destArea1, destArea2	string destBck	variable i,kpoints,epoints,NoFitCh=29,chan, starta,startb, enstep	variable center1, center2   NVAR butt_an9, butt_an10	WAVE nil, w_coef, temp, temp0, temp1, temp2, coeff,buttwave10	string panelname1, panelname2	destdispd1 = "dMDC"+num2istr(graph)+"a"	destdispd2= "dMDC"+num2istr(graph)+"b"	destwidth = "wMDC"+num2istr(graph)	destArea1 = "aMDC"+num2istr(graph)+"a"	destArea2 = "aMDC"+num2istr(graph)+"b"	enerwave="enMDC"+num2istr(graph)	destBck="bckMDC"+num2istr(graph)  epoints = GetGraphDim(graph,0)	kpoints = GetGraphDim(graph,1)   make /o /n=(epoints) mdcfitd1   make /o /n=(epoints) mdcfitd2	make /o /n=(epoints) mdcfitw	make /o /n=(epoints) mdcfitaA	make /o /n=(epoints) mdcfitaB	make /o /n=(epoints) mdcfitbck	make /o /n=(epoints) mdcfitslp	make /o /n=(kpoints) mdcshape1	make /o /n=(kpoints) mdcshape2  make /o /n=(epoints) mdcarea1	make /o /n=(epoints) mdcarea2	mdcfitd1=0; mdcfitd2=0; mdcfitw=0; mdcfitaA=0; mdcfitaB=0	mdcfitbck=0; mdcfitslp=0; mdcshape1=0; mdcshape2=0; mdcarea1=0; mdcarea2=0	mdcfitw = nil;   i = butt_an9	dowindow /f Button_Graph	starta = pcsr(A)	startb = pcsr(B)	butt_MDC(10,graph,i)	   mdcfitd1=nan; mdcfitd2=nan   buttwave10[startPoint, endPoint]=nan   FuncFit/q  lorTwo coeff buttwave10(starta,startb) /d   center1=(coeff[3]); center2=(coeff[4])   display mdcarea1 vs temp ; appendtograph mdcarea2 vs temp   panelname1 = "MDC_Area"   dowindow/k $panelname1   dowindow/c $panelname1   ModifyGraph rgb(mdcarea2)=(0,0,65535)   ModifyGraph mode=3,marker=19   display/w=(50,400,400,650) mdcshape1 ; appendtograph mdcshape2   panelname2 = "LorFunc"   dowindow/k $panelname2   dowindow/c $panelname2   SetAxis left 0,2  do		butt_MDC(10,graph,i)			butt_MDC(8,graph,i)		findlevel/q temp,i		chan = V_levelX		enstep=temp[2]-temp[1]		buttwave10[startPoint, endPoint]=nan		print i, chan		FuncFit/q  lorTwo coeff buttwave10(center1-(15+abs(i*100)),center2+(15+abs(i*100))) /d		startPoint+=abs(i*1)		endPoint-=abs(i*1)		//curvefit /q /l=1000  lor  buttwave10(center-20-abs(i*30),center+20+abs(i*30)) /d     center1=(coeff[3]); center2=(coeff[4])     mdcshape1[] = abs(coeff[1]*coeff[5])/((x-coeff[3])^2+(coeff[5]/2)^2)		mdcshape2[] = abs(coeff[2]*coeff[5])/((x-coeff[4])^2+(coeff[5]/2)^2)		mdcfitd1[chan] = abs(coeff[3]) 		mdcfitd2[chan] = abs(coeff[4])  		mdcfitw[chan] =  abs(coeff[5])   		mdcfitbck[chan] =  abs(coeff[0])  		mdcarea1[chan] = abs(coeff[1])		mdcarea2[chan] = abs(coeff[2])		duplicate /o temp $enerwave		duplicate /o mdcfitd1 $destdispd1		duplicate /o mdcfitd2 $destdispd2	 	duplicate /o mdcfitw $destwidth	 	duplicate /o mdcfitbck $destBck	 	duplicate /o mdcarea1 $destarea1	 	duplicate /o mdcarea2 $destarea2	 	 	i -= enstep		while( i >= butt_an10 )	   print "done" EndFunction lorTwo(w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1]*w[5])/((x-w[3])^2+(w[5]/2)^2)	f +=  abs(w[2]*w[5])/((x-w[4])^2+(w[5]/2)^2)	return (f)EndFunction lorTwo2(w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[3])^2+(w[5]/2)^2)	f +=  abs(w[2])/((x-w[4])^2+(w[5]/2)^2)	return (f)EndFunction MDCfit4(graph)	variable graph	string destdispd1,destdispd2,destdispd3,destdispd4 	string destwidthA,destwidthB	string enerwave	string destArea1, destArea2, destArea3, destArea4	string destBck	variable i,kpoints,epoints,NoFitCh=29,chan, starta,startb, enstep	variable center1, center2, center3, center4   NVAR butt_an9, butt_an10	WAVE nil, w_coef, temp, temp0, temp1, temp2, coeff	destdispd1 = "dMDC"+num2istr(graph)+"a"	destdispd2= "dMDC"+num2istr(graph)+"b"	destdispd3 = "dMDC"+num2istr(graph)+"c"	destdispd4= "dMDC"+num2istr(graph)+"d"	destwidthA = "wMDC"+num2istr(graph)+"out"	destwidthB = "wMDC"+num2istr(graph)+"in"	destArea1 = "aMDC"+num2istr(graph)+"a"	destArea2 = "aMDC"+num2istr(graph)+"b"	destArea3 = "aMDC"+num2istr(graph)+"c"	destArea4 = "aMDC"+num2istr(graph)+"d"	enerwave="enMDC"+num2istr(graph)	destBck="bckMDC"+num2istr(graph)  epoints = GetGraphDim(graph,0)	kpoints = GetGraphDim(graph,1)   make /o /n=(epoints) mdcfitd1   make /o /n=(epoints) mdcfitd2   make /o /n=(epoints) mdcfitd3   make /o /n=(epoints) mdcfitd4	make /o /n=(epoints) mdcfitwA	make /o /n=(epoints) mdcfitwB	make /o /n=(epoints) mdcfitaA	make /o /n=(epoints) mdcfitaB	make /o /n=(epoints) mdcfitbck	make /o /n=(epoints) mdcfitslp	make /o /n=(kpoints) mdcshape1	make /o /n=(kpoints) mdcshape2	make /o /n=(kpoints) mdcshape3	make /o /n=(kpoints) mdcshape4  make /o /n=(epoints) mdcarea1	make /o /n=(epoints) mdcarea2	make /o /n=(epoints) mdcarea3	make /o /n=(epoints) mdcarea4	mdcfitwA = nil; mdcfitwB = nil   i = butt_an9	dowindow /f Button_Graph	starta = pcsr(A)	startb = pcsr(B)	butt_MDC(10,graph,i)	   mdcfitd1=nan; mdcfitd2=nan   FuncFit/q  lorfour coeff buttwave10(starta,startb) /d   center1=(coeff[5]); center2=(coeff[6]); center3=(coeff[7]); center4=(coeff[8])  do		butt_MDC(10,graph,i)			findlevel/q temp,i		chan = V_levelX		enstep=temp[2]-temp[1]		print i, chan		FuncFit/q  lorfour coeff buttwave10(center1-(10+abs(i*0)),center4+(10+abs(i*0))) /d		//curvefit /q /l=1000  lor  buttwave10(center-20-abs(i*30),center+20+abs(i*30)) /d     center1=(coeff[5]); center2=(coeff[6]); center3=(coeff[7]); center4=(coeff[8])     mdcshape1[] = abs(coeff[1])/((x-coeff[5])^2+(coeff[9]/2)^2) 		mdcshape2[] = abs(coeff[2])/((x-coeff[6])^2+(coeff[10]/2)^2)		mdcshape3[] = abs(coeff[3])/((x-coeff[7])^2+(coeff[10]/2)^2)		mdcshape4[] = abs(coeff[4])/((x-coeff[8])^2+(coeff[9]/2)^2)		mdcfitd1[chan] = (coeff[5]) 		mdcfitd2[chan] = (coeff[6])  	  	mdcfitd3[chan] = (coeff[7]) 		mdcfitd4[chan] = (coeff[8]) 		mdcfitwA[chan] =  (coeff[9])  		mdcfitwB[chan] =  (coeff[10])  		mdcfitbck[chan] =  (coeff[0])  		mdcarea1[chan] = area(mdcshape1,-inf,inf)		mdcarea2[chan] = area(mdcshape2,-inf,inf)		mdcarea3[chan] = area(mdcshape3,-inf,inf)		mdcarea4[chan] = area(mdcshape4,-inf,inf)    	i -= enstep				duplicate /o temp $enerwave		duplicate /o mdcfitd1 $destdispd1		duplicate /o mdcfitd2 $destdispd2		duplicate /o mdcfitd3 $destdispd3		duplicate /o mdcfitd4 $destdispd4	 	duplicate /o mdcfitwA $destwidthA	 	duplicate /o mdcfitwB $destwidthB	 	duplicate /o mdcfitwB $destwidthB	 	duplicate /o mdcfitbck $destBck	 	duplicate /o mdcarea1 $destarea1	 	duplicate /o mdcarea2 $destarea2	 	duplicate /o mdcarea3 $destarea3	 	duplicate /o mdcarea4 $destarea4	while( i >= butt_an10 )	   print "done"EndFunction lorFour(w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[5])^2+(w[9]/2)^2)	f +=  abs(w[2])/((x-w[6])^2+(w[10]/2)^2)	f +=  abs(w[3])/((x-w[7])^2+(w[10]/2)^2)	f +=  abs(w[4])/((x-w[8])^2+(w[9]/2)^2)	return (f)EndFunction lorFourDetail(w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[5])^2+(w[9]/2)^2)	f +=  abs(w[2])/((x-w[6])^2+(w[10]/2)^2)	f +=  abs(w[3])/((x-w[7])^2+(w[11]/2)^2)	f +=  abs(w[4])/((x-w[8])^2+(w[12]/2)^2)	return (f)EndFunction lorSix(w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[7])^2+(w[13]/2)^2)	f +=  abs(w[2])/((x-w[8])^2+(w[14]/2)^2)	f +=  abs(w[3])/((x-w[9])^2+(w[15]/2)^2)	f +=  abs(w[4])/((x-w[10])^2+(w[15]/2)^2)	f +=  abs(w[5])/((x-w[11])^2+(w[14]/2)^2)	f +=  abs(w[6])/((x-w[12])^2+(w[13]/2)^2)	return (f)EndFunction loreight1(w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[9])^2+(w[17]/2)^2)	f +=  abs(w[2])/((x-w[10])^2+(w[18]/2)^2)	f +=  abs(w[3])/((x-w[11])^2+(w[19]/2)^2)	f +=  abs(w[4])/((x-w[12])^2+(w[20]/2)^2)	f +=  abs(w[5])/((x-w[13])^2+(w[20]/2)^2)	f +=  abs(w[6])/((x-w[14])^2+(w[19]/2)^2)	f +=  abs(w[7])/((x-w[15])^2+(w[18]/2)^2)	f +=  abs(w[8])/((x-w[16])^2+(w[17]/2)^2)	return (f)EndFunction loreight2(w,x) : FitFunc	Wave w	Variable x	variable f	f =  abs(w[0]) + abs(w[1])/((x-w[9])^2+(w[17]/2)^2)	f +=  abs(w[2])/((x-w[10])^2+(w[18]/2)^2)	f +=  abs(w[3])/((x-w[11])^2+(w[19]/2)^2)	f +=  abs(w[4])/((x-w[12])^2+(w[20]/2)^2)	f +=  abs(w[5])/((x-w[13])^2+(w[21]/2)^2)	f +=  abs(w[6])/((x-w[14])^2+(w[22]/2)^2)	f +=  abs(w[7])/((x-w[15])^2+(w[23]/2)^2)	f +=  abs(w[8])/((x-w[16])^2+(w[24]/2)^2)	return (f)End/////////////////////////////////////////////		Combo Panel and Procedures		////////////////////////////////////////////Window Combo() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(870,389,1173,799)	ModifyPanel cbRGB=(65535,32768,32768)	SetDrawLayer UserBack	SetDrawEnv linethick= 3	DrawLine 8,272,291,272	SetDrawEnv linethick= 3	DrawLine 8,351,291,351	SetDrawEnv linethick= 3	DrawLine 8,298,291,298	DrawLine 8,35,292,35	DrawLine 8,54,292,54	DrawLine 8,73,292,73	DrawLine 8,92,292,92	DrawLine 8,111,292,111	DrawLine 8,130,292,130	DrawLine 8,149,292,149	DrawLine 8,168,292,168	DrawLine 8,187,292,187	DrawLine 8,206,292,206	DrawLine 8,225,292,225	SetDrawEnv fstyle= 1	DrawText 25,16,"Graph"	SetDrawEnv fstyle= 1	DrawText 244,16,"Color"	SetDrawEnv fstyle= 1	DrawText 185,16,"Offset"	SetDrawEnv fstyle= 1	DrawText 88,16,"First"	SetDrawEnv fstyle= 1	DrawText 136,16,"Num"	SetDrawEnv linethick= 2,dash= 11	DrawLine 8,247,291,247	SetVariable setvar1,pos={9,18},size={72,15},proc=Combo_gr,title="1",value= sg1	SetVariable setvar1_1,pos={84,18},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar1_1,value= st1	SetVariable setvar1_2,pos={133,18},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar1_2,value= num1	SetVariable setvar2,pos={9,37},size={72,15},proc=Combo_gr,title="2",value= sg2	SetVariable setvar2_1,pos={84,37},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar2_1,value= st2	SetVariable setvar2_2,pos={133,37},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar2_2,value= num2	SetVariable setvar3,pos={9,56},size={72,15},proc=Combo_gr,title="3",value= sg3	SetVariable setvar3_1,pos={84,56},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar3_1,value= st3	SetVariable setvar3_2,pos={133,56},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar3_2,value= num3	SetVariable setvar4,pos={9,75},size={72,15},proc=Combo_gr,title="4",value= sg4	SetVariable setvar4_1,pos={84,75},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar4_1,value= st4	SetVariable setvar4_2,pos={133,75},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar4_2,value= num4	SetVariable setvar5,pos={9,94},size={72,15},proc=Combo_gr,title="5",value= sg5	SetVariable setvar5_1,pos={84,94},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar5_1,value= st5	SetVariable setvar5_2,pos={133,94},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar5_2,value= num5	SetVariable setvar6,pos={9,113},size={72,15},proc=Combo_gr,title="6",value= sg6	SetVariable setvar6_1,pos={84,113},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar6_1,value= st6	SetVariable setvar6_2,pos={133,113},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar6_2,value= num6	SetVariable setvar7,pos={9,132},size={72,15},proc=Combo_gr,title="7",value= sg7	SetVariable setvar7_1,pos={84,132},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar7_1,value= st7	SetVariable setvar7_2,pos={133,132},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar7_2,value= num7	SetVariable setvar8,pos={9,151},size={72,15},proc=Combo_gr,title="8",value= sg8	SetVariable setvar8_1,pos={84,151},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar8_1,value= st8	SetVariable setvar8_2,pos={133,151},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar8_2,value= num8	SetVariable setvar9,pos={9,170},size={72,15},proc=Combo_gr,title="9",value= sg9	SetVariable setvar9_1,pos={84,170},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar9_1,value= st9	SetVariable setvar9_2,pos={133,170},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar9_2,value= num9	SetVariable setvar10,pos={9,189},size={72,15},proc=Combo_gr,title="10"	SetVariable setvar10,value= sg10	SetVariable setvar10_1,pos={84,189},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar10_1,value= st10	SetVariable setvar10_2,pos={133,189},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar10_2,value= num10	SetVariable setvar11,pos={9,208},size={72,15},proc=Combo_gr,title="11"	SetVariable setvar11,value= sg11	SetVariable setvar11_1,pos={84,208},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar11_1,value= st11	SetVariable setvar11_2,pos={133,208},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar11_2,value= num11	SetVariable setvar12,pos={9,227},size={72,15},proc=Combo_gr,title="12"	SetVariable setvar12,value= sg12	SetVariable setvar12_1,pos={84,227},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar12_1,value= st12	SetVariable setvar12_2,pos={133,227},size={46,15},proc=Combo_gr,title=" "	SetVariable setvar12_2,value= num12	Button button0,pos={72,275},size={50,20},proc=Combo_update,title="Update"	Button button1,pos={15,275},size={50,20},proc=Combo_show,title="Show"	SetVariable setvar9_4,pos={200,278},size={92,15},proc=Combo_offs_all,title="Offset"	SetVariable setvar9_4,limits={-inf,inf,0.1},value= combo_offset	Button button2,pos={16,302},size={50,20},proc=Combo_adjust,title="Adjust"	Button button3,pos={16,326},size={50,20},proc=Combo_average,title="Avrg"	Button button5,pos={15,355},size={50,20},proc=Combo_save,title="Save"	SetVariable setvar9_5,pos={72,357},size={44,15},proc=Combo_load,title=" "	SetVariable setvar9_5,limits={0,inf,1},value= combo_index	CheckBox combo_autoload_chk,pos={118,357},size={58,14},proc=Combo_AutoloadCheckProc,title="Autoload"	CheckBox combo_autoload_chk,value= 1	SetVariable setvar0,pos={16,377},size={271,15},title=" ",value= combo_descr	CheckBox combo_autoload_chk1,pos={74,303},size={64,14},proc=Combo_UsecursorCheckProc,title="Use cursor"	CheckBox combo_autoload_chk1,value= 0	SetVariable setvar09,pos={141,320},size={75,15},disable=2,title="Ei"	SetVariable setvar09,limits={-inf,inf,0.1},value= Combo_rangeEi	SetVariable setvar05,pos={215,319},size={75,15},disable=2,title="Ef"	SetVariable setvar05,limits={-inf,inf,0.1},value= Combo_rangeEf	CheckBox combo_autoload_chk2,pos={74,320},size={61,14},proc=Combo_UserangeCheckProc,title="Use range"	CheckBox combo_autoload_chk2,value= 0	SetVariable setvar13,pos={11,252},size={41,15},title=" ",value= sgAll	SetVariable setvar1201,pos={84,252},size={46,15},proc=Combo_grAll,title=" "	SetVariable setvar1201,value= stAll	SetVariable setvar1202,pos={133,252},size={46,15},proc=Combo_grAll,title=" "	SetVariable setvar1202,value= numAll	SetVariable setvar1203,pos={183,252},size={52,15},proc=Combo_grAll,title=" "	SetVariable setvar1203,value= offAll	Button button7,pos={52,249},size={24,20},proc=ComboGrPlus,title="+"	PopupMenu Colorpop12,pos={231,227},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop12,mode=1,popColor= (0,0,65535),value= #"\"*COLORPOP*\""	PopupMenu Colorpop11,pos={231,207},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop11,mode=1,popColor= (0,0,65535),value= #"\"*COLORPOP*\""	PopupMenu Colorpop10,pos={231,188},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop10,mode=1,popColor= (0,0,65535),value= #"\"*COLORPOP*\""	PopupMenu Colorpop9,pos={231,169},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop9,mode=1,popColor= (1,4,52428),value= #"\"*COLORPOP*\""	PopupMenu Colorpop8,pos={231,150},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop8,mode=1,popColor= (1,16019,65535),value= #"\"*COLORPOP*\""	PopupMenu Colorpop7,pos={231,132},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop7,mode=1,popColor= (2,39321,1),value= #"\"*COLORPOP*\""	PopupMenu Colorpop6,pos={231,113},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop6,mode=1,popColor= (65535,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop5,pos={232,94},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop5,mode=1,popColor= (2,39321,1),value= #"\"*COLORPOP*\""	PopupMenu Colorpop4,pos={231,75},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop4,mode=1,popColor= (65535,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop3,pos={231,55},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop3,mode=1,popColor= (2,39321,1),value= #"\"*COLORPOP*\""	PopupMenu Colorpop2,pos={231,35},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop2,mode=1,popColor= (65535,0,0),value= #"\"*COLORPOP*\""	PopupMenu Colorpop1,pos={231,16},size={56,17},proc=Combo_ColorFunc,title=" "	PopupMenu Colorpop1,mode=1,popColor= (2,39321,1),value= #"\"*COLORPOP*\""	SetVariable setvar1_3,pos={182,18},size={53,15},proc=Combo_gr,title=" "	SetVariable setvar1_3,value= off1	SetVariable setvar2_3,pos={183,37},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar2_3,value= off2	SetVariable setvar3_3,pos={183,56},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar3_3,value= off3	SetVariable setvar4_3,pos={183,75},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar4_3,value= off4	SetVariable setvar5_3,pos={183,94},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar5_3,value= off5	SetVariable setvar6_3,pos={183,113},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar6_3,value= off6	SetVariable setvar7_3,pos={183,132},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar7_3,value= off7	SetVariable setvar8_3,pos={183,151},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar8_3,value= off8	SetVariable setvar9_3,pos={183,170},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar9_3,value= off9	SetVariable setvar10_3,pos={183,189},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar10_3,value= off10	SetVariable setvar11_3,pos={183,208},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar11_3,value= off11	SetVariable setvar12_3,pos={183,227},size={52,15},proc=Combo_gr,title=" "	SetVariable setvar12_3,value= off12	Button button05,pos={180,355},size={92,20},proc=MemoComboListFunc,title="memo List"	Button button4,pos={128,275},size={62,20},proc=Combo_resetFunc,title="ResetAll"EndMacrofunction Combo_update(ctrlName) : ButtonControl	String ctrlName	variable i	dowindow /f combo_graph	for ( i=1; i<13; i+=1 )		combo_updateOne(i)	endfor	dowindow /f comboEndproc Combo_resetFunc (ctrlName) : ButtonControl 	String ctrlName	string gr, st, num, off	variable i	 silent 1; pauseupdate		combo_var =0		i=1		do 			gr = "sg"+num2istr(i)			st = "st"+num2istr(i)			num = "num"+num2istr(i)			off = "off"+num2istr(i)			$gr = combo_var[i][1]			$st = combo_var[i][2]			$num = combo_var[i][3]			$off = combo_var[i][4]			i+=1		while(i<13)		Combo_update("")endproc Combo_load(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string	dest_combo, gr, st, num, off	variable i	 silent 1; pauseupdate	combo_descr = combo_descr_wave[combo_index]	if ( combo_autoload_chk )		dest_combo = "combo_set"+num2istr(combo_index)		if (exists(dest_combo)!=1)		 	//abort "No such a combo!!"		 	combo_var =0		else			duplicate /o $dest_combo combo_var 		endif		i=1		do 			gr = "sg"+num2istr(i)			st = "st"+num2istr(i)			num = "num"+num2istr(i)			off = "off"+num2istr(i)			$gr = combo_var[i][1]			$st = combo_var[i][2]			$num = combo_var[i][3]			$off = combo_var[i][4]			i+=1		while(i<13)	endifEndFunction MemoComboListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "MemoComboList"	wave/t combo_descr_wave	dowindow/f $panelname	if (v_flag!=1)	edit combo_descr_wave	dowindow/c $panelname	endifend	Function Combo_save(ctrlName) : ButtonControl	String ctrlName	variable i,di, j, last, overlap, index, kpoints	variable waves	string ComboWave, graph,graphx, dest_combo	NVAR combo_index	SVAR combo_descr	WAVE combo_var	WAVE/T combo_descr_wave	graph = "cr"+num2istr(combo_index)	graphx = "cx"+num2istr(combo_index)	dest_combo = "combo_set"+num2istr(combo_index)	duplicate /o combo_var $dest_combo	combo_descr_wave[combo_index]=combo_descr	kpoints=0 ; overlap=0  	 	if (combo_var[1][4]<=combo_var[2][4])  	 di=1 	 last=1 	else  	 di=-1 	 last=Combo_GetLast () 	endif 		     	do		if ( combo_var[last][1]!=0 )			waves = combo_var[last][3]			kpoints += waves-overlap		endif		i = last+di		overlap = combo_var[last][3] + combo_var[last][4] - combo_var[i][4]		last=i	while ( i<13 && i>0)	make /o /n=(dimsize(combox1,0),kpoints) temp2		if (combo_var[1][4]<=combo_var[2][4])  	 di=1 	 last=1 	else  	 di=-1 	 last=Combo_GetLast () 	endif			index=0;overlap=0        	do		if ( combo_var[last][1]!=0 )			waves=combo_var[last][3]			j=overlap			do								ComboWave="combo"+num2istr(last)+"_"+num2istr(j)				duplicate /o $ComboWave temp1				temp2[][index]=temp1[x]				index += 1				j += 1			while ( j<waves )				endif		i = last+di		overlap = combo_var[last][3] + combo_var[last][4] - combo_var[i][4]		last = i	while( i<13 && i>0)	duplicate /o combox1 $graphx	duplicate /o temp2 $graphEndFunction Combo_GetLast ()variable i, GNumwave combo_var 		for (i=1;i<13;i+=1)    		if (combo_var[i][1]!=0)   			GNum+=1   		endif 		endfor 		return (GNum)endFunction Combo_adjust(ctrlName) : ButtonControl	String ctrlName	variable i,j,di, last, overlap, waveLeng,last_area, curr_area, Xi, Xf, P_i, P_f	string ComboWave, ComboWavex	WAVE combo_var	NVAR combo_Usecursor_chk, combo_Userange_chk, Combo_rangeEi, Combo_rangeEf	if (combo_Usecursor_chk==1)	  if (stringmatch(csrwave(a),"")==1 ||  stringmatch(csrwave(b),"")==1)	    abort "Set cursor A and B or check all range!"	  endif	endif  if (combo_Usecursor_chk == 1)    Xi = hcsr(a) ; Xf = hcsr(b)      Combo_rangeEi = Xi ; 	Combo_rangeEf = Xf  						    elseif (combo_Userange_chk == 1)     Xi = Combo_rangeEi ; Xf = Combo_rangeEf  endif	     	if (combo_var[1][4]<=combo_var[2][4])  	 di=1 	 last=1 	else  	 di=-1 	 last=Combo_GetLast () 	endif 		for ( i=last+di; i<13 && i>0 ; i+=di )		if ( combo_var[i][1]!=0 )				overlap = combo_var[last][3]+combo_var[last][4]-combo_var[i][4]			make/o/n=(overlap) overlapWave			if ( overlap>0 )				curr_area=0;last_area=0				j=0				do				// CALC AREA Ratio			  			ComboWave = "combo"+num2istr(last)+"_"+num2istr(combo_var[last][3]-overlap+j)						ComboWavex = "combox"+num2istr(last)							if (combo_Usecursor_chk == 1)    					   last_area = areaXY($ComboWavex, $ComboWave, Xi, Xf)			     					elseif (combo_Userange_chk == 1)    					    last_area = areaXY($ComboWavex, $ComboWave, Xi, Xf)     					else    						 Xi = 0 ; Xf = dimsize($ComboWave,0)    						 last_area = area($ComboWave,0,Xf)  						endif									ComboWave = "combo"+num2istr(i)+"_"+num2istr(j)						ComboWavex = "combox"+num2istr(i)						if (combo_Usecursor_chk == 1)    					    curr_area = areaXY($ComboWavex, $ComboWave, Xi, Xf) 		    					elseif (combo_Userange_chk == 1)    					   curr_area = areaXY($ComboWavex, $ComboWave, Xi, Xf)     					else    					    						 curr_area = area($ComboWave,0,Xf)    						  P_i = 0 ; P_f = dimsize($ComboWave,0)					   						endif						  overlapWave[j] = 	last_area/curr_area								j+=1				while ( j<overlap )							j=0				do	 // Adjust uing AREA Ratio					    		  				ComboWave = "combo"+num2istr(i)+"_"+num2istr(j)		  				waveLeng = combo_var[i][3]					duplicate /o $ComboWave temp 					temp *= overlapWave[j] 						duplicate /o temp $ComboWave					j += 1				while ( j<waveLeng)			endif		endif		last = i	endfor	  for ( i=1; i<13; i+=1 ) // ADJUST length   			if ( combo_var[i][1]!=0)		   if  (combo_Usecursor_chk ==1 || combo_Userange_chk ==1)		      ComboWavex = "combox"+num2istr(i)				   FindLevel/q  $ComboWavex, Xi    				P_i = V_LevelX     			  FindLevel/q  $ComboWavex, Xf    			   P_f = V_LevelX 	  	      				j=0				do								    					ComboWave = "combo"+num2istr(i)+"_"+num2istr(j)			 					duplicate /o $ComboWave temp			 					 		make/o/n=(P_f-P_i+1) temp1				 	temp1[] = temp[P_i+p] 						   	duplicate /o temp1 $ComboWave					j += 1				while ( j<combo_var[i][3] )			    duplicate /o $ComboWavex temp			    make/o/n=(P_f-P_i+1) temp1			    temp1[] = temp[P_i+p]						    duplicate /o temp1 $ComboWavex				endif	    		endif  endforEndFunction Combo_average(ctrlName) : ButtonControl	String ctrlName	variable i, di, j, last, overlap	string wave1, wave2	WAVE combo_var  	if (combo_var[1][4]<=combo_var[2][4])  	 di=1 	 last=1 	else  	 di=-1 	 last=Combo_GetLast () 	endif	for ( i=last+di; i<13 && i>0; i+=di )		if ( combo_var[i][1]!=0 )				overlap = combo_var[last][3]+combo_var[last][4]-combo_var[i][4]			if ( overlap>0 )				j=0				do				// CALC AREA					wave1 = "combo"+num2istr(last)+"_"+num2istr(combo_var[last][3]-overlap+j)					wave2 = "combo"+num2istr(i)+"_"+num2istr(j)					duplicate /o $wave1 temp1, temp3					duplicate /o $wave2 temp2					temp3 = (temp1+temp2)/2					duplicate /o temp3 $wave1 $wave2					j+=1				while ( j<overlap )			endif		endif		last=i	endforEndProc Combo_show(ctrlName) : ButtonControl	String ctrlName	combo_graph()EndWindow combo_graph() : Graph	PauseUpdate; Silent 1  dowindow /f combo_graph	if (V_flag==0)   	Display /W=(286,320,669,889)     dowindow /c combo_graph     Combo_update("")	//  ModifyGraph tick=2	//  ModifyGraph mirror=1	//  ModifyGraph fSize=16	//  ModifyGraph standoff=0	//  ModifyGraph axOffset(left)=-2.375,axOffset(bottom)=-0.1875  // 	Label left "Intensity (arb. units)"	//  Label bottom "Energy (eV)"	 endifEndMacroFunction combo_updateOne (combo)	variable combo	variable waves, j	string ComboWave, xwave	WAVE combo_var	waves = combo_var[combo][3]	combo_update_graph(combo)	j=0	dowindow combo_graph	if (V_flag!=1)	  execute "combo_graph()"	endif	do		ComboWave = "combo"+num2istr(combo)+"_"+num2istr(j)		xwave = "combox"+num2istr(combo)		removefromgraph/W=combo_graph /z  $ComboWave		if ( (combo_var[combo][1]!=0) && (j<waves) )			appendtograph/W=combo_graph $ComboWave vs $xwave		endif		j += 1		while ( j<=1000 )	Combo_ColorInput (combo)	combo_update_offs(combo)endFunction Combo_ColorFunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string colorstr	variable combo	wave/t Combo_color   DoWindow Combo_Graphif (V_flag==1)	sscanf ctrlName, "Colorpop%f", combo   Combo_color[combo] = popStr   Combo_ColorInput (combo) endifEndFunction Combo_ColorInput (combo)	Variable combo	variable colorval1, colorval2, colorval3, waves, i	string ColorStr, ColorPart, ComboWave	wave/t Combo_color	WAVE combo_var	ColorStr=Combo_color[combo]	ColorPart=ColorStr[1,strlen(ColorStr)-2]	colorval1=str2num(StringFromList(0, ColorPart, ","))	colorval2=str2num(StringFromList(1, ColorPart, ","))	colorval3=str2num(StringFromList(2, ColorPart, ","))	waves = combo_var[combo][3] if ( (combo_var[combo][1]!=0) && (waves!=0) )    for ( i=0; i<waves; i+=1 )    	ComboWave = "combo"+num2istr(combo)+"_"+num2istr(i)   	ModifyGraph/w=Combo_Graph rgb($ComboWave)=(colorval1,colorval2,colorval3)    endfor endifEndFunction combo_update_color(combo,colorval1,colorval2,colorval3)	variable combo,colorval1,colorval2,colorval3	variable i, waves	string ComboWave	WAVE combo_var	waves = combo_var[combo][3]	if ( (combo_var[combo][1]!=0) && (waves!=0) )		for ( i=0; i<waves; i+=1 )			ComboWave = "combo"+num2istr(combo)+"_"+num2istr(i)        ModifyGraph/w=Combo_Graph rgb($ComboWave)=(colorval1,colorval2,colorval3)		endfor	endifendFunction ComboGrPlus (ctrlName) : ButtonControl	String ctrlName	variable No	Nvar sgAll	wave combo_var	for (No=1 ; No<=12 ; No+=1) 	 if (combo_var[No][1]!=0)		  combo_var[No][1] += sgAll	    combo_update_graph( No )	 endif	endfor	execute "InputfromCombo_var ()"end			Function Combo_grAll(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string name	variable combo, oldvalue, No	wave combo_var  for (No=1 ; No<=12 ; No+=1) 	 if (combo_var[No][1]!=0)	   if (stringmatch(varName,"stAll")==1)		   combo_var[No][2] = varnum    		combo_update_graph(No)     endif     if (stringmatch(varName,"numAll")==1)		  combo_var[No][3] = varnum		  combo_updateOne(No)     endif      if (stringmatch(varName,"offAll")==1)		  combo_var[No][4] = varnum*(No-1)		  combo_update_offs(No)		endif	 endif  endfor  execute "InputfromCombo_var ()"Endproc InputfromCombo_var ()   string name    variable No=1   silent 1 ; pauseupdate    do       name="sg"+num2str(No)     $name=combo_var[No][1]          name="st"+num2str(No)     $name=combo_var[No][2]          name="num"+num2str(No)     $name=combo_var[No][3]          name="off"+num2str(No)     $name=combo_var[No][4]          No+=1   while (No<=12)endfunction match_param(base,param)	string base, param	string name	variable i, j		j=0;	i=1	for ( i=1; i<13; i+=1 )		name = base+num2istr(i)		if ( stringmatch(name,param) )				j = i			break 		endif	endfor	return(j)EndFunction Combo_gr(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	variable combo, oldvalue	WAVE combo_var		combo = match_param("sg",varname)  // Change Gr	if ( combo!=0 )		oldvalue = combo_var[combo][1]		combo_var[combo][1] = varnum		if ( (oldvalue!=0) && (varnum!=0) )			combo_update_graph( combo )		else				combo_updateOne( combo )		endif	endif	combo = match_param("st",varname) // Change St	if ( combo!=0 )		combo_var[combo][2] = varnum		combo_update_graph(combo)	endif	combo = match_param("num",varname) // Change Nb	if ( combo!=0 )		combo_var[combo][3] = varnum		combo_updateOne(combo)	endif	combo = match_param("off",varname) // Change Ofs	if ( combo!=0 )		combo_var[combo][4] = varnum		combo_update_offs(combo)	endifEndFunction Combo_UserangeCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR combo_Userange_chk	combo_Userange_chk=checkedEndFunction Combo_AutoloadCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR combo_autoload_chk	combo_autoload_chk=checkedEndFunction Combo_UsecursorCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	NVAR combo_Usecursor_chk	combo_Usecursor_chk=checkedEndFunction combo_update_graph(combo)	variable combo		variable graph, start, waves, i	string ComboWave, olddisp	SVAR dispwave	WAVE combo_var, temp1, temp2	graph = combo_var[combo][1]	start = combo_var[combo][2]	waves = combo_var[combo][3]	i = 0	olddisp = dispwave	//dispwave = "nr"	do		ComboWave ="combo"+num2istr(combo)+"_"+num2istr(i)		if ( graph!=0 )			getwave( graph, i+start )				//  => temp1			duplicate /o temp1 $ComboWave		else			duplicate /o zerowave $ComboWave		endif		i += 1	while ( i<=waves )		getwave(graph,0 )				//  => temp2	dispwave = olddisp	//	temp2-=map[graph][7]	ComboWave ="combox"+num2istr(combo)	duplicate /o temp2 $ComboWaveendFunction combo_update_offs(combo)	variable combo	variable i, offset, waves	string ComboWave	NVAR combo_offset	WAVE combo_var	offset = combo_var[combo][4]	waves = combo_var[combo][3]	if ( (combo_var[combo][1]!=0) && (waves!=0) )		for ( i=0; i<waves; i+=1 )			ComboWave = "combo"+num2istr(combo)+"_"+num2istr(i)			ModifyGraph /z offset($ComboWave)={0,combo_offset*(offset+i)}//			print ComboWave, combo_offset*(offset+i)		endfor	endifendFunction Combo_offs_all(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	variable i	for ( i=1; i<13; i+=1 )		combo_update_offs(i)	endforEnd//////////////////////////////////////		Utility Procedures		//////////////////////////////////////Macro	SaveGraph( graph )	string graph	variable wavenum,i	string wavenam		getwindow $graph wavelist		wavenum = dimsize(w_wavelist,0)	//print wavenum	wavenam =""	i=0	do ( i=0; i<wavenum; i+=1 )		wavenam +=w_wavelist[i][0]+" "	i+=1	while(I<wavenum)	wavenam ="save /t "+wavenam +" as "+"\""+graph+"\""	//print wavenam 	execute wavenamendMacroFunction NormGraph( graph )	string graph	variable wavenum,i, norm	string wavenam	WAVE /T w_Wavelist		getwindow $graph wavelist		wavenum = dimsize(w_wavelist,0)//	print "found ... ",wavenum," waves"	i=0	for ( i=0; i<wavenum/2; i+=1 )		wavenam=w_Wavelist[i][0]	//print wavenam		duplicate /o $wavenam temp1		norm=area(temp1,xcsr(a),xcsr(b))		temp1/=norm		duplicate /o temp1 $wavenam	endforendMacroMacro ProcessCP(name)	string name	variable numsets,numwaves, kpoints, epoints , so1, so2	variable i,j	string set, waveL, waveR, profile	PauseUpdate; Silent 1			numsets=numpnts($name)	//print " "	//print numsets	i=0	do		if ($name[i]!=0)			set = "Set"+num2istr($name[i])			//print " "			//print set			numwaves = dimsize($set,0)			waveR="gr"+num2istr($set[0][0])			waveL="gr"+num2istr($set[0][1])			duplicate /o $waveR temp1			duplicate /o $waveL temp2			temp1=0; temp2=0		//	SUM ALL WAVES IN SET			j=0			do				if($set[j][0]!=0)					waveR = "gr"+num2istr($set[j][0]); 					temp1 += $waveR;				endif				if($set[j][0]!=0)					waveL = "gr"+num2istr($set[j][1])								temp2 += $waveL					endif				//print waveR, waveL				j+=1			while(j<numwaves)				//	 NORMALIZE TEMP1 and TEMP2			kpoints = dimsize(temp1,1)			epoints = dimsize(temp1,0)			make /n=(epoints) /o temp			so1=0; so2=0			j=0			do				temp = temp1[x][j]				so1 += faverage(temp,70,110)				temp = temp2[x][j]				so2 += faverage(temp,70,110)				j+=1			while ( j<kpoints )			temp1 /= so1/kpoints			temp2 /= so2/kpoints			profile = set+"_prof"			//print profile			waveR = "cp"+num2istr($name[i])+"R"				waveL="cp"+num2istr($name[i])+"L"		//	CALCULATE N(k)			make /o /n=(kpoints) $waveR $waveL			CalcNK(temp1,0,70)			temp/=$profile			duplicate /o temp $waveR			CalcNK(temp2,0,70)			temp/=$profile			duplicate /o temp $waveL		endif		i+=1	while(i<numsets)endMacroFunction CalcNK( name, fromE, toE )	wave name	variable fromE, toE	variable i, epoints, kpoints	epoints = dimsize(name,0)	kpoints = dimsize(name,1)	make /o /n=(epoints) temp3	make /o /n=(kpoints) temp	for ( i=0; i<kpoints; i+=1 )		temp3 = name[p][i]		temp[i] = area(temp3,fromE,toE)	endforEndMacro CalcProfile(name)	string name	variable fromE=70, toE=110	variable i, j, kpoints, graphs,norm	string thewave, profile	PauseUpdate; Silent 1			graphs = dimsize($name,0)	//print graphs	j=0	temp1=0	display	do		i=0		thewave = "gr"+num2istr($name[i])		kpoints = dimsize($thewave,1)		make /o /n=(kpoints) temp1		do			thewave = "gr"+num2istr($name[i][j])			profile = "prof"+num2istr($name[i][j])			CalcNK($thewave, fromE, toE )			norm = faverage(temp,0,toE)			temp /= norm			duplicate/o  temp $profile			append $profile			temp1 += $profile			i += 1		while (i<graphs)			j+=1	while (j<2)	temp1 /= graphs*2	name += "_prof"	duplicate /o temp1 $name	append $name	ModifyGraph lsize($name)=2,rgb($name)=(0,0,0)endMacroMacro delpoint( firstG, lastG, startpoint, npoint )	Variable firstG=1, lastG=1, startpoint=390, npoint=11, graphnum, wavenum	String theWave	PauseUpdate; Silent 1	graphnum = firstG	do			wavenum = map[graphnum][0]		theWave = "wave" + num2istr(wavenum)		deletepoints startpoint,npoint,$thewave		wavenum += 1		//print graphnum		do			theWave = "wave" + num2istr(wavenum)			deletepoints startpoint,npoint,$thewave			wavenum+=2		while(wavenum<=map[graphnum][1])		graphnum+=1	while (graphnum <= lastG)EndMacromacro diff2d(grname)	string grname="nk55ev_grad"	variable nx,ny,i,j,temp1,temp2	string  dest	pauseUpdate;Silent 1	nx=dimsize($grname,0)	ny=dimsize($grname,1)	dest=grname+"_diff"	make/o/n=(nx,ny) $dest, diffx, diffy	make/o/n=(nx) tempx	make/o/n=(ny) tempy	make/o/n=(nx) normx	make/o/n=(ny) normy		j=0		// differentiate in x direction	do 		tempx=$grname[x][j]		normx=$grname[x][j]		differentiate tempx//		diffx[][j]=tempx[x]/normx[x]		diffx[][j]=tempx[x]/0.2667		j+=1	while(j<=ny-1)	i=0		// differentiate in y direction	do 		tempy=$grname[i][x]		normy=$grname[i][x]		differentiate tempy//		diffy[i][]=tempy[y]/normy[y]		diffy[i][]=tempy[y]		i+=1	while(i<=nx-1)//	j=0//	do//		i=0//		do //			temp1=abs(diffx[i][j])//			temp2=abs(diffy{i][j])//			$dest[i][j]=max(temp1,temp2)//			i+=1//		while(i<=nx-1)//		j+=1//	while(j<=ny-1)		make/o/n=(nx,ny) whichx,whichy	whichx=0	whichy=0	whichx=1*((abs(diffx)-abs(diffy))>0)	whichy=1*((abs(diffy)-abs(diffx))>0)//	diffx*=whichx//	diffy*=whichy//	$dest[][]=abs(diffx)+abs(diffy)		$dest[][]=abs(diffy)end macro////////////////////////////////////////////////////		Procedures related to Self-Energy		////////////////////////////////////////////////////////////////////////////////////////////////		Gapfit Graph and Procedures		////////////////////////////////////////////Window GapFitG() : Graph	PauseUpdate; Silent 1		// building window...	Display /W=(372,94,862,606) scope25 vs scopeX	AppendToGraph scope12, scope13, scope14, scope15, scope16, scope17, scope18, scope19, scope20 vs scopeX	AppendToGraph scope21, scope22, scope23, scope24, scope26, scope27, scope28, scope29, scope30 vs scopeX	AppendToGraph scope31, scope32, scope33, scope34, scope35, scope36, scope37, scope38 vs scopeX	AppendToGraph simh0, simh1, simh2, simh3, simh4, simh5, simh6, simh7, simh8, simh9 vs gapfit_y	AppendToGraph simh10, simh11, simh12, simh13, simh14, simh15, simh16, simh17, simh18, simh19 vs gapfit_y	AppendToGraph simh20, simh21, simh22, simh23, simh24 vs gapfit_y	ModifyGraph mode(scope12)=2,mode(scope13)=2,mode(scope14)=2,mode(scope15)=2,mode(scope16)=2	ModifyGraph mode(scope17)=2,mode(scope18)=2,mode(scope19)=2,mode(scope20)=2,mode(scope21)=2	ModifyGraph mode(scope22)=2,mode(scope23)=2,mode(scope24)=2,mode(scope25)=2,mode(scope26)=2	ModifyGraph mode(scope27)=2,mode(scope28)=2,mode(scope29)=2,mode(scope30)=2,mode(scope31)=2	ModifyGraph mode(scope32)=2,mode(scope33)=2,mode(scope34)=2,mode(scope35)=2,mode(scope36)=2	ModifyGraph mode(scope37)=2,mode(scope38)=2	ModifyGraph marker(scope25)=8	ModifyGraph lSize(scope12)=2,lSize(scope13)=2,lSize(scope14)=2,lSize(scope15)=2	ModifyGraph lSize(scope16)=2,lSize(scope17)=2,lSize(scope18)=2,lSize(scope19)=2	ModifyGraph lSize(scope20)=2,lSize(scope21)=2,lSize(scope22)=2,lSize(scope23)=2	ModifyGraph lSize(scope24)=2,lSize(scope25)=2,lSize(scope26)=2,lSize(scope27)=2	ModifyGraph lSize(scope28)=2,lSize(scope29)=2,lSize(scope30)=2,lSize(scope31)=2	ModifyGraph lSize(scope32)=2,lSize(scope33)=2,lSize(scope34)=2,lSize(scope35)=2	ModifyGraph lSize(scope36)=2,lSize(scope37)=2,lSize(scope38)=2	ModifyGraph rgb(simh0)=(1,16019,65535),rgb(simh1)=(1,16019,65535),rgb(simh2)=(1,16019,65535)	ModifyGraph rgb(simh3)=(1,16019,65535),rgb(simh4)=(1,16019,65535),rgb(simh5)=(1,16019,65535)	ModifyGraph rgb(simh6)=(1,16019,65535),rgb(simh7)=(1,16019,65535),rgb(simh8)=(1,16019,65535)	ModifyGraph rgb(simh9)=(1,16019,65535),rgb(simh10)=(1,16019,65535),rgb(simh11)=(1,16019,65535)	ModifyGraph rgb(simh12)=(1,16019,65535),rgb(simh13)=(1,16019,65535),rgb(simh14)=(1,16019,65535)	ModifyGraph rgb(simh15)=(1,16019,65535),rgb(simh16)=(1,16019,65535),rgb(simh17)=(1,16019,65535)	ModifyGraph rgb(simh18)=(1,16019,65535),rgb(simh19)=(1,16019,65535),rgb(simh20)=(1,16019,65535)	ModifyGraph rgb(simh21)=(1,16019,65535),rgb(simh22)=(1,16019,65535),rgb(simh23)=(1,16019,65535)	ModifyGraph rgb(simh24)=(1,16019,65535)	ModifyGraph msize(scope25)=3	ModifyGraph offset(scope21)={0,191.1},offset(scope22)={0,200.2},offset(scope23)={0,209.3}	ModifyGraph offset(scope25)={0,9.1},offset(scope26)={0,18.2},offset(scope27)={0,245.7}	ModifyGraph offset(scope28)={0,254.8},offset(scope29)={0,263.9},offset(scope30)={0,273}	ModifyGraph offset(scope31)={0,282.1},offset(scope19)={0,172.9},offset(scope20)={0,182}	ModifyGraph offset(scope32)={0,291.2},offset(scope18)={0,163.8},offset(scope33)={0,300.3}	ModifyGraph offset(scope16)={0,145.6},offset(scope34)={0,309.4},offset(scope14)={0,127.4}	ModifyGraph offset(scope36)={0,327.6},offset(scope13)={0,118.3},offset(scope37)={0,336.7}	ModifyGraph offset(scope12)={0,109.2},offset(scope38)={0,345.8},offset(scope15)={0,136.5}	ModifyGraph offset(scope35)={0,318.5},offset(scope17)={0,154.7},offset(simh0)={0,232}	ModifyGraph offset(simh1)={0,223},offset(simh2)={0,214},offset(simh3)={0,205},offset(simh4)={0,196}	ModifyGraph offset(simh5)={0,187},offset(simh6)={0,178},offset(simh7)={0,169},offset(simh8)={0,160}	ModifyGraph offset(simh9)={0,151},offset(simh10)={0,142},offset(simh11)={0,133}	ModifyGraph offset(simh12)={0,124},offset(simh13)={0,115},offset(simh14)={0,106}	ModifyGraph offset(simh15)={0,97},offset(simh16)={0,88},offset(simh17)={0,79},offset(simh18)={0,70}	ModifyGraph offset(simh19)={0,61},offset(simh20)={0,52},offset(simh21)={0,43},offset(simh22)={0,34}	ModifyGraph offset(simh23)={0,25},offset(simh24)={0,16}	ModifyGraph minor(bottom)=1	ModifyGraph axOffset(left)=7.14286	Textbox/N=text0/F=0/A=MC/X=-22.80/Y=-44.60 " \r Graph 157 T=0K hv=0 Angle=(0,0)"	Cursor A simh2 168;Cursor B simh2 173	ShowInfo	ShowTools	SetDrawLayer UserFront	SetDrawEnv xcoord= bottom,ycoord= left	DrawLine 0,17.1586578865463,0,247.721845717585EndMacroWindow Afit() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(905,59,1268,464)	ShowTools	SetDrawLayer UserBack	DrawLine 5,47,255,47	DrawLine 4,93,252,93	SetVariable setvar0,pos={74,241},size={76,15},title="step",value= GF_kxstep	SetVariable setvar0_1,pos={74,258},size={76,15},title="step"	SetVariable setvar0_1,limits={-Inf,Inf,0.001},value= GF_kystep	SetVariable setvar0_2,pos={157,242},size={58,15},title="kxp",value= kxp	SetVariable setvar1,pos={15,294},size={91,15},title="Ebeg"	SetVariable setvar1,limits={-1,20,0.002},value= GF_Ebeg	SetVariable setvar2,pos={15,310},size={91,15},title="Eend"	SetVariable setvar2,limits={0,20,0.002},value= GF_Eend	SetVariable setvar3,pos={13,326},size={93,15},title="Estep"	SetVariable setvar3,limits={0,0.01,0.001},value= GF_Estep	SetVariable setvar4,pos={116,8},size={97,15},proc=Sim_offset,title="Offset"	SetVariable setvar4,limits={-Inf,Inf,0.1},value= GF_offs	SetVariable setvar5,pos={115,300},size={105,15},title="Eres"	SetVariable setvar5,limits={0,1,0.001},value= GF_Eres	SetVariable setvar6,pos={134,316},size={86,15},title="T",value= GF_T	SetVariable setvar7,pos={2,241},size={69,15},title="kx"	SetVariable setvar7,limits={-Inf,Inf,0.01},value= GF_kx	SetVariable setvar8,pos={3,259},size={67,15},title="ky"	SetVariable setvar8,limits={-Inf,Inf,0.01},value= GF_ky	SetVariable setvar9,pos={228,243},size={81,15},title="kxR"	SetVariable setvar9,limits={0,10,0.05},value= GF_kxr	SetVariable setvar10,pos={228,260},size={81,15},title="kyR"	SetVariable setvar10,limits={0,10,0.05},value= GF_kyr	SetVariable setvar11,pos={20,24},size={87,15},title="Gap"	SetVariable setvar11,limits={-Inf,Inf,0.001},value= GF_Gap	SetVariable setvar12,pos={10,8},size={97,15},title="Inten"	SetVariable setvar12,limits={-Inf,Inf,10},value= GF_Inten	SetVariable setvar11_1,pos={21,56},size={69,15},title="a"	SetVariable setvar11_1,limits={-Inf,Inf,0.01},value= mfla	SetVariable setvar11_2,pos={21,72},size={69,15},title="b"	SetVariable setvar11_2,limits={-Inf,Inf,0.01},value= mflb	SetVariable setvar11_3,pos={92,56},size={70,15},title="wc"	SetVariable setvar11_3,limits={-Inf,Inf,0.01},value= mflwc	SetVariable setvar11_4,pos={102,72},size={60,16},title="a",font="Symbol"	SetVariable setvar11_4,limits={-Inf,Inf,0.1},value= mflalpha	SetVariable setvar11_5,pos={167,54},size={83,15},title="vf0"	SetVariable setvar11_5,limits={-Inf,Inf,0.001},value= mflvf0	SetVariable setvar11_6,pos={174,71},size={75,15},title="kf"	SetVariable setvar11_6,limits={-Inf,Inf,0.1},value= GF_kf	Button button0,pos={12,178},size={50,20},proc=Afit_ButtonProc,title="gapfit"	Button button0_1,pos={74,178},size={50,20},proc=Afit_show,title="Show"	Button button1,pos={141,178},size={50,20},proc=GapFit_update,title="Update"	SetVariable setvar13,pos={61,120},size={111,15},proc=Afit_offset,title="offset"	SetVariable setvar13,value= GF_offset	SetVariable setvar0_3,pos={157,261},size={58,15},title="kyp",value= kypEndMacroFunction Sim_offset(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName		string name, name1	variable i	NVAR GF_offs, GF_shift, GF_kpnts	i=0	do		name = "sim"+num2istr(i)		name1 = "sim_data"+num2istr(i)		modifygraph offset($name)={0,i*GF_offs+GF_shift}		modifygraph offset($name1)={0,i*GF_offs+GF_shift}		i += 1	while ( i<GF_kpnts )	Endmacro Afit_ButtonProc(ctrlName) : ButtonControl	String ctrlName	string sampleName, curve, curvex, curveek	variable ix, iy, size, inten, bkg//	NVAR GF_Eend, GF_Ebeg, GF_Estep//	NVAR GF_Gap, GF_Inten, GF_T, GF_power, GF_kf, GF_Eres, GF_kx, GF_ky, GF_kxr, GF_kyr, GF_kpnts//	NVAR Gf_kxstep,Gf_kystep//	NVAR MFLwc, MFLa, MFLb, MFLalpha, MFLvf0, kxp, kyp//	WAVE /d selfh, k75, disp75		variable kx, ky	//print "Fitting ..."	duplicate /o zerowave sim0 sim1 sim2 sim3 sim4 sim5 sim6 sim7 sim8 sim9 sim10 sim11 sim12 sim13 sim14 sim15 sim16 sim17 sim18 sim19 sim20 sim21 sim22 sim23 sim24	duplicate /o zerowave simh0 simh1 simh2 simh3 simh4 simh5 simh6 simh7 simh8 simh9 simh10 simh11 simh12 simh13 simh14 simh15 simh16 simh17 simh18 simh19 simh20 simh21 simh22 simh23 simh24	size = abs(GF_Eend-GF_Ebeg)/GF_Estep+1	//print size	make /d /o /n=(size) imsigl, resigl, gapfit, gapfit_y, imsigh, resigh, fermi_wave, band_wave, gauss_fit, back_wave	make /d /o /n=24 selfh	selfh=0	gapfit_y = GF_Ebeg+x*GF_Estep	make/o /d /n=9 fitp	make /o /d /n=8 tbind	//	t0 = 0.11, t1 = -0.5951, t2 = 0.1636, t3 = -0.0519, t4 = -0.1117, t5 = 0.051		tbind[0]=0.140  // -0.08 hole   E=3*ky	tbind[1]=-0.635	tbind[2]=0.123	tbind[3]=-0.1317	tbind[4]=0.008	tbind[5]=0.02	tbind[6]=1  	//Bonding band intensity	tbind[7]=0		// Antibonding band intensity		bandsetup(tbind,0,0)		selfh[0] = GF_Ebeg	selfh[1] = GF_Eend	selfh[2] = GF_Estep	selfh[3] = MFLwc	selfh[4] = MFLa			// a0	selfh[5] = 3			// a	selfh[6]=0				//den1	selfh[7] = MFLb			// b	selfh[8] = abs(GF_Ebeg)	//den2	selfh[9]=0					//dc	selfh[10]= abs(GF_Ebeg)	//den3	selfh[11]=0				// d	selfh[12]=0				// peak 1 pos	selfh[13]=0				// peak 1 amp	selfh[14]=0				// peak 1 width	selfh[15]=0				// peak 2 pos	selfh[16]=0				// peak 2 amp	selfh[17]=0				// peak 2 width	selfh[18]=0				// peak 3 pos	selfh[19]=0				// peak 3 amp	selfh[20]=0				// peak 3 width	selfh[21]=0			//t0	selfh[22] = MFLalpha*GF_T	selfh[23] = 2			// exponent		fitp[0] = GF_Gap    						// Gap		fitp[1] = GF_Inten					// Intensity		fitp[2] =1  //GF_BI	// Back inten		fitp[3] = 0								//BackGap		fitp[4] = Gf_T*0.00008617							// BackWidth		fitp[5] = 0	// 0 Ek correction		fitp[6] = 1		// kx resol points		fitp[7] = 1		// ky resol points		fitp[8] = 0.048	// Bilayer splitting	selfsetup(selfh,1)	imsigh = getfunction(2,x)	resigh = getfunction(3,x)	ix=0; kx=Gf_kx	do	curve="gr"+num2istr(ix+1)	curvex="gx"+num2istr(ix+1)	curveek="ek"+num2istr(ix+1)	make /o /d /n=(size,kyp) $curve	make /o /d /n=(kyp) $curvex	make /o /n=(kyp) $curveek	duplicate /o gapfit_y $curvex	$curve=nil	$curveek=nil	ky=Gf_ky;	iy=0		do			gapsetup(fitp,GF_Eres,GF_T,kx,ky,GF_kxr,GF_kyr)			gapfit = gapspect(fitp,x)//			gapfit=getfunction(5,x)			$curve[][iy]=gapfit[x]			ky+=Gf_kystep			iy+=1		while ( iy<kyp )		//print kx				kx+=Gf_kxstep		ix+=1	while ( ix<kxp )	iy=0; ky=Gf_ky//		do//			$curveek[iy]=gapsetup(fitp,GF_Eres,GF_T,kx,ky,GF_kxr,GF_kyr)//			gapfit = gapspect(fitp,x)//			$curve[][iy]=gapfit[x]//			duplicate /o gapfit $curve//			ky+=Gf_kystep//		kx+=Gf_kxstep//			iy+=1//		while ( iy<kyp )// fermi_wave = getfunction(4,x)//	band_wave = getfunction(5,x)//	back_wave=getfunction(9,x)//					case 0: p->result = point;break;//					case 1:	p->result = Energy[point];break;//					case 2: p->result = ImSig[point];break;//					case 3:	p->result = ReSig[point];break;//				 	case 4: p->result = Fermi[point];break;//					case 5:	p->result = Band[point];break;//					case 6: p->result = Spect[point];break;//					case 7:	p->result = Gauss[point];break;//					case 8:	p->result = Conv[point];break;//					case 9:	p->result = Back[point];break;//	duplicate /o gapfit_y omega	//	omega = (-k75+20.5)*MFLvf0//	disp75 = omega+resigh//	duplicate /o imsigh imsig//	imsig = imsigh/MFLvf0EndFunction Afit_offset(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	NVAR	gf_offset,kyp, GF_zero_offsvariable	offs,istring	dest	offs = GF_zero_offs	for ( i=0; i<kyp; i+=1 )		dest = "sim"+num2istr(i) ;		ModifyGraph offset($dest)={0,offs}		offs += gf_offset	endforEndmacro doautocor(bzname)string bznamevariable i, kpoints, epointsstring acnameduplicate /o $bzname bzepoints=Dimsize(bz,2)kpoints=Dimsize(bz,1)//print kpoints, epointsacname="ac"+bznamemake /d/o /n=(kpoints,kpoints,epoints) ftmake /d/o /n=(kpoints,kpoints) win, woutft=0i=0dobznk(i,i+1)win=nk2d[x][y]autocorel(win, wout)ft[][][i]=wout[x][y]//print ii+=1while(i<epoints) duplicate /o ft $acnameendmacroencorel(bzname)string bznamevariable i, kpoints, epoints, denstring acnameduplicate /o $bzname bzepoints=Dimsize(bz,2)kpoints=Dimsize(bz,1)//print kpoints, epointsacname="ac"+bznamemake /d/o /n=(kpoints,kpoints,epoints) enftmake /d/o /n=(kpoints,kpoints) win, woutft=0den=0doi=0do//enft[][][den]+=ft[][][i]*ft[][][i+den]i+=1while(i+den<epoints)while(den<epoints)function cselfl(w)	variable w	WAVE selfl	if(w>selfl[0])		return(selfl[1]+selfl[2]*w+selfl[3]*w*w+selfl[4]*w*w*w);	else		if(w>selfl[5])			return(selfl[6]+selfl[7]*w+selfl[8]*w*w+selfl[9]*w*w*w);		else			return(selfl[11]+selfl[12]*w+selfl[13]*w*w+selfl[14]*w*w*w);		endif	endifendfunction cselfh(w)	variable w	WAVE selfh	if(w>selfh[0])		return(selfh[1]+selfh[2]*w+selfh[3]*w*w+selfh[4]*w*w*w);	else		if(w>selfh[5])			return(selfh[6]+selfh[7]*w+selfh[8]*w*w+selfh[9]*w*w*w);		else			return(selfh[11]+selfh[12]*w+selfh[13]*w*w+selfh[14]*w*w*w);		endif	endifendFunction xlogxf( w, wi )	variable w, wi	if ( w==wi )		return(0)	else		return ( (w - wi)*ln(abs(w-wi) ) )	endifEndFunction CalcReSigf(w)	variable w	variable  out, wj, intstep	variable j	WAVE imstart, omega	out = 0		intstep = 0.002	for ( wj=1; wj<999; wj+=1 )		out += (imstart[wj+1]- imstart[wj])/intstep * (  xlogxf(omega[w], omega[wj]) - xlogxf(omega[w], omega[wj+1]) )	endfor	return out / PiEndFunction xlogxb( w, wi )	variable w, wi	if ( w==wi )		return(0)	else		return ( -(w - wi)*ln(abs(w-wi)) )	endifEndFunction CalcReSigb(w)	variable w	variable  out, wj, intstep	variable j	WAVE restart, omega	intstep = 0.002;	out = 0		for ( wj=1; wj<999; wj+=1 )		out += (restart[wj+1]-restart[wj])/intstep * ( xlogxb(omega[w], omega[wj]) - xlogxb(omega[w], omega[wj+1]) )	endfor	return out/Pi EndFunction CalcImSig(w)	variable w	variable peak, Ecutoff, Estep	variable a0, a, b, c, d 	variable en1, en2, en3	variable ep1, ep2, ep3	variable am1, am2, am3	variable wd1, wd2, wd3	variable result		NVAR GF_Estep	WAVE selfh		Ecutoff = selfh[3]	Estep = GF_Estep				a0 = selfh[4];		a = selfh[7];	en1 = selfh[8];		b = selfh[9];	en2 = selfh[10];	c = selfh[11]; 	en3 = selfh[12];	d = selfh[13];	ep1 = selfh[14];	am1 = selfh[15];	wd1 = selfh[16];	ep2 = selfh[15];	am2 = selfh[16];	wd2 = selfh[17];	ep3 = selfh[18];	am3 = selfh[19];	wd3 = selfh[20];	if ( w<0 ) 		w = -w;	endif		if ( w < Ecutoff )		peak = am1*exp(-(w-ep1)*(w-ep1)/2/wd1/wd1)+am2*exp(-(w-ep2)*(w-ep2)/2/wd2/wd2)+am3*exp(-(w-ep3)*(w-ep3)/2/wd3/wd3);		if ( w<en1 )			result = ( a0 + a*w + peak );		elseif ( w<en2 )			result = ( a0 + a*en1 + b*(w-en1) + peak );		elseif ( w<en3 )			result = ( a0 + a*en1 + b*(en2-en1) + c*(w-en2) + peak )		else			result = ( a0 + a*en1 + b*(en2-en1) + c*(en3-en2) + d*(w-en3) + peak )		endif	else		result = (a0+a*min(en1,Ecutoff)+b*(en2-en1)+c*(en3-en2)+d*(Ecutoff-en3)+peak);	//	result=0			endif	return (result)EndFunction xlogx( w, wi )	variable w, wi	return ( (w - wi)*ln(abs(w-wi)+0.001) )EndFunction CalcReSig( w )	variable w	variable  out, wj, intstep	variable j	WAVE selfh	out = 0	intstep = 0.002	wj = -selfh[3]	do		out += 1/Pi * ( abs(CalcImSig(wj+intstep))-abs(CalcImSig(wj)) )/intstep * ( xlogx(w, wj) - xlogx(w, wj+intstep) )//		print out ,(CalcImSig(wj))		wj += intstep;	while ( wj<selfh[3] )//	out-=1/Pi*CalcImSig(selfl[3])*log(abs(selfl[3]-w)/abs(selfl[3]+w))	return ( out )EndFunction ElihuReS(w,T,c)	variable w, T, c	variable g = 0.63		return((g/2)*(c*ln(abs((c-w)/(c+w)))-w*ln(abs((c-w)*(c+w))/abs((pi*T-w)*(pi*T+w))) -Pi*T*ln(abs((pi*T-w)/(pi*T+w))) ))end/////  Autocorrelation proceduresfunction cutout(value)	variable value	variable i,j	WAVE nk2d		for(i=0; i<180; i+=1)		for(j=0;j<180;j+=1)			if(nk2d[i][j]<value)				nk2d[i][j]=0			endif		endfor	endforend/////    ANGLE TESTSmacro calcpos(file)	variable file	p1[file]=w_coef[2]	p2[file]=w_coef[5]	p3[file]=w_coef[8]	p4[file]=w_coef[11]		w1[file]=w_coef[3]	w2[file]=w_coef[6]	w3[file]=w_coef[9]	w4[file]=w_coef[12]endmacroFunction XvalsetFunc (No,dest)   variable No    string dest      Nvar  ButtXmaxValue,ButtXminValue      SetAxis bottom ButtXminValue,ButtXmaxValueendFunction colorFunc(No,dest)  variable No  string dest  variable colorval1, colorval2, colorval3  string colorstrPlus, colorstr  wave/t Butt_color  colorstrPlus = Butt_color[No]	colorstr=colorstrPlus[1,strlen(colorstrPlus)-2]	colorval1=str2num(StringFromList(0, colorstr, ","))	colorval2=str2num(StringFromList(1, colorstr, ","))	colorval3=str2num(StringFromList(2, colorstr, ","))   ModifyGraph rgb($dest)=(colorval1,colorval2,colorval3)endFunction offsetFunc(No,dest)   variable No  string dest  wave Butt_offset  ModifyGraph offset($dest)={0,Butt_offset[No]}endFunction BoldFunc(No,dest)  variable No  string dest  wave Butt_Bold    ModifyGraph lsize($dest)=(Butt_Bold[No])endMacro ReduceEDCs (base,baseX,result,startNo,endNo,every,off,Ei_No,Ef_No)variable startNo, endNo=169, i, off=0.8, every=2,Ei_No=236,Ef_No=360string base="scope",baseX="scopeX", result="EDCs", resultXstring wavename1, wavename2, wavename3, wavename4resultX=result+"X"display silent 1; pauseupdatedo  wavename1 = base + num2istr(i)  wavename2 = result + num2istr(i)  wavename3 = baseX + num2istr(i)  wavename4 = resultX + num2istr(i)  make/o/n=(Ef_No-Ei_No+1) $wavename2,$wavename4  $wavename2=$wavename1[p+Ei_No]  $wavename4=$wavename3[p+Ei_No]  appendtograph $wavename2 vs $wavename4  i+=everywhile (endNo>=i)ModifyGraph zero(bottom)=12OffsetFun (result, off, startNo, endNo, every)endmacrofunction OffsetFun (result, off, startNo, endNo, every)   String result   variable off, startNo, endNo, every      Variable waveNum,Y_Offset, diff,i   String waveName, waveName1, waveName2, waveName3   Nvar diffe_offset   pauseUpdate; Silent 1	   waveNum=startNo   if (diffe_offset==1)	for ( i=0; i<= endNo; i+=every )		waveName2 = result+num2istr(i) 		waveName1 = result+num2istr(abs(i-every))	  duplicate/o  $waveName1,temp1	  duplicate/o  $waveName2,temp2	   duplicate/o  temp2,temp0	  temp0=temp2-temp1		wavestats/Q temp0		diff=v_min		Y_Offset += off-diff		ModifyGraph offset($waveName2)={0,Y_Offset}			endfor	else    for ( i=0; i<= endNo; i+=every )		  waveName = result + num2istr(i)		  ModifyGraph offset($waveName)={0,Y_Offset}		  Y_Offset += off		endfor    endifEnd////////////////////////////////////////  Graph_Modify////////////////////////////////////Window Graph_Modify() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(779,230,1066,851)	SetDrawLayer UserBack	SetDrawEnv fsize= 14,fstyle= 1,textrgb= (65535,0,0)	DrawText 37,181,"*** Left (Y)***"	SetDrawEnv fsize= 14,fstyle= 1,textrgb= (0,0,65535)	DrawText 149,181,"*** Bottom (X) ***"	DrawRect 8,183,278,313	SetDrawEnv linethick= 3,fillfgc= (32769,65535,32768)	DrawRect 8,28,278,163	SetDrawEnv fsize= 15,fstyle= 1	DrawText 14,45,"--- Choose effective option ---"	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (2,39321,1)	DrawText 17,203,"--- Axis ---"	DrawRect 8,315,278,382	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (2,39321,1)	DrawText 15,333,"--- YX value ---"	DrawRect 8,384,278,429	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (2,39321,1)	DrawText 13,401,"--- Graph size ---"	SetDrawEnv dash= 2	DrawLine 138,49,138,417	DrawRect 8,495,278,601	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (2,39321,1)	DrawText 15,515,"--- Lavel ---"	DrawRect 8,431,278,493	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (2,39321,1)	DrawText 13,448,"--- Margin ---"	Button Basic,pos={197,252},size={69,21},proc=BasicFunc,title="Basic Set"	PopupMenu Axis,pos={18,556},size={71,17},proc=AxisSetFunc	PopupMenu Axis,mode=2,popvalue="Bottom",value= #"\"Left;Bottom\""	Button kx,pos={85,555},size={33,20},proc=KxFunc,title="kx"	Button ky,pos={124,555},size={32,20},proc=KyFunc,title="ky"	Button Int,pos={124,577},size={33,20},proc=IntFunc,title="Int"	Button Channel,pos={237,554},size={37,20},proc=ChanFunc,title="Chan"	Button Energy,pos={86,577},size={32,20},proc=EnergyFunc,title="E"	SetVariable Bottom,pos={19,537},size={246,15},proc=BottomFunc,title="Bottom"	SetVariable Bottom,value= BottomLabel	SetVariable Left,pos={33,521},size={232,15},proc=LeftFunc,title="Left"	SetVariable Left,value= LeftLabel	SetVariable Labelname,pos={17,576},size={60,15},title=" ",value= AxisName	Button GetInfo,pos={58,5},size={177,20},proc=GetAllInfoFunc,title="Get All Info"	SetVariable ZeroInfo_L,pos={40,207},size={94,15},proc=ZeroFunc,title="Zero Line On"	SetVariable ZeroInfo_L,limits={0,1,1},value= ZeroLeft	SetVariable TickOnInfo_L,pos={61,259},size={72,15},proc=TickFunc,title="Tick On"	SetVariable TickOnInfo_L,limits={0,1,1},value= TickLeft	SetVariable LabelOnInfo_L,pos={58,224},size={75,15},proc=LabelFunc,title="Label On"	SetVariable LabelOnInfo_L,limits={0,1,1},value= LabelOnleft	SetVariable MinorInfo_L,pos={32,276},size={101,15},proc=minorfunc,title="Minor Tick On"	SetVariable MinorInfo_L,limits={0,1,1},value= MinorLeft	SetVariable ZeroInfo_B,pos={149,207},size={36,15},proc=ZeroFunc,title=" "	SetVariable ZeroInfo_B,limits={0,1,1},value= Zerobottom	SetVariable TickOnInfo_B,pos={149,259},size={35,15},proc=TickFunc,title=" "	SetVariable TickOnInfo_B,limits={0,1,1},value= TickBottom	SetVariable LabelOnInfo_B,pos={149,224},size={35,15},proc=LabelFunc,title=" "	SetVariable LabelOnInfo_B,limits={0,1,1},value= LabelOnBottom	SetVariable MinorInfo_B,pos={149,276},size={35,15},proc=MinorFunc,title=" "	SetVariable MinorInfo_B,limits={0,1,1},value= MinorBottom	SetVariable FontSizeInfo,pos={193,210},size={81,15},proc=FontSizeFunc,title="Font Size"	SetVariable FontSizeInfo,value= FontSizevalue	SetVariable Xmax,pos={149,361},size={67,15},proc=InputXFunc,title=" "	SetVariable Xmax,limits={-inf,inf,0.1},value= XmaxValue	SetVariable Xmin,pos={149,345},size={67,15},proc=InputXFunc,title=" "	SetVariable Xmin,limits={-inf,inf,0.1},value= XminValue	SetVariable Ymax,pos={18,362},size={115,15},proc=InputYFunc,title="Axis Max"	SetVariable Ymax,limits={-inf,inf,0.1},value= YmaxValue	SetVariable Ymin,pos={22,345},size={111,15},proc=InputYFunc,title="Axis Min"	SetVariable Ymin,limits={-inf,inf,0.1},value= YminValue	SetVariable StandOff,pos={53,241},size={80,15},proc=Standfunc,title="Stand Off"	SetVariable StandOff,limits={0,1,1},value= Standleft	SetVariable TickOnInfo_B1,pos={149,241},size={35,15},proc=Standfunc,title=" "	SetVariable TickOnInfo_B1,limits={0,1,1},value= StandBottom	Button kx1,pos={161,555},size={33,20},proc=dKxFunc,title="dkx"	Button ky1,pos={199,555},size={32,20},proc=dKyFunc,title="dky"	Button Temperature,pos={162,577},size={32,20},proc=TempFunc,title="T"	Button Angle,pos={199,577},size={32,20},proc=DegFunc,title="deg"	SetVariable LabelOffsetY,pos={18,293},size={115,15},proc=InputXYoffset,title="Label Offset"	SetVariable LabelOffsetY,limits={-inf,inf,0.1},value= OffsetLeft	SetVariable LabelOffsetX,pos={149,293},size={59,15},proc=InputXYoffset,title=" "	SetVariable LabelOffsetX,limits={-inf,inf,0.1},value= OffsetBottom	PopupMenu changeValue,pos={214,340},size={51,17},proc=Value_menu,title=" "	PopupMenu changeValue,mode=3,popvalue="0.1",value= #"\"0.001;0.01;0.1;1;10;100;1000\""	Button Allaxis,pos={226,359},size={29,20},proc=AllaxisFunc,title="All"	SetVariable GsizeY,pos={22,413},size={115,15},proc=SetYSizeInput,title="Size (cm)"	SetVariable GsizeY,limits={-inf,inf,0.1},value= Ysizevalue	SetVariable GsizeX,pos={147,413},size={67,15},proc=SetXSizeInput,title=" "	SetVariable GsizeX,limits={-inf,inf,0.1},value= Xsizevalue	Button GetInfoAxis,pos={166,185},size={49,20},proc=GetAxisFunc,title="Get"	Button UseInfo,pos={22,135},size={147,20},proc=SetAllOnFunc,title="Use set Info"	SetVariable YvalueOn,pos={103,64},size={32,15},disable=2,title=" "	SetVariable YvalueOn,value= Yvaluechecked	SetVariable XvalueOn,pos={203,64},size={32,15},disable=2,title=" "	SetVariable XvalueOn,value= Xvaluechecked	CheckBox YvalueSet1,pos={48,64},size={49,14},proc=YvaluecheckFunc,title="Y value"	CheckBox YvalueSet1,value= 1	CheckBox XvalueSet1,pos={148,64},size={49,14},proc=XvaluecheckFunc,title="X value"	CheckBox XvalueSet1,value= 1	SetVariable YsizeOn,pos={103,80},size={32,15},disable=2,title=" "	SetVariable YsizeOn,value= Ysizechecked	SetVariable XsizeOn,pos={203,80},size={32,15},disable=2,title=" "	SetVariable XsizeOn,value= Xsizechecked	CheckBox YvalueSet2,pos={48,79},size={44,14},proc=YsizecheckFunc,title="Y Size"	CheckBox YvalueSet2,value= 1	CheckBox XvalueSet2,pos={148,80},size={43,14},proc=XsizecheckFunc,title="X size"	CheckBox XvalueSet2,value= 1	Button UseAxisInfo,pos={222,185},size={48,20},proc=SetAxisFunc,title="Use"	CheckBox YvalueSet3,pos={48,48},size={44,14},proc=YAxischeckFunc,title="Y Axis"	CheckBox YvalueSet3,value= 1	SetVariable YaxisOn,pos={103,48},size={32,15},disable=2,title=" "	SetVariable YaxisOn,value= YAxischecked	CheckBox XvalueSet3,pos={148,48},size={44,14},proc=XAxischeckFunc,title="X Axis"	CheckBox XvalueSet3,value= 1	SetVariable XaxisOn,pos={203,48},size={32,15},disable=2,title=" "	SetVariable XaxisOn,value= XAxischecked	SetVariable MinorInfo_L1,pos={189,227},size={85,15},proc=SwapXYFunc,title="SwapXY On"	SetVariable MinorInfo_L1,limits={0,1,1},value= SwapXYvalue	SetVariable YlabelOn,pos={103,96},size={32,15},disable=2,title=" "	SetVariable YlabelOn,value= Ylabelchecked	CheckBox YvalueSet4,pos={48,95},size={46,14},proc=YlabelcheckFunc,title="Y label"	CheckBox YvalueSet4,value= 1	CheckBox XvalueSet4,pos={148,96},size={45,14},proc=XlabelcheckFunc,title="X lavel"	CheckBox XvalueSet4,value= 1	SetVariable XlabelOn,pos={203,96},size={32,15},disable=2,title=" "	SetVariable XlabelOn,value= Xlabelchecked	Button GetXYvalue,pos={119,318},size={44,20},proc=GetXYfunc,title="Get"	Button UseXvalue,pos={224,318},size={49,20},proc=SetXFunc,title="Use X"	Button Setsizevalue,pos={178,387},size={41,20},proc=SetSizeFunc,title="Use"	Button GetLabel,pos={173,498},size={47,20},proc=GetLabelFunc,title="Get"	Button Setlabel,pos={227,498},size={43,20},proc=SetlabelFunc,title="Use"	Button Allaxis1,pos={228,386},size={40,20},proc=AutoFunc,title="Auto"	Button Getsizeinfo,pos={129,387},size={44,20},proc=GetSizeFunc,title="Get"	Button UseYvalue,pos={169,318},size={49,20},proc=SetYFunc,title="Use Y"	Button Allaxis2,pos={238,33},size={36,20},proc=AllcondintionFunc,title="All"	Button Allaxis3,pos={237,54},size={38,20},proc=NoncondintionFunc,title="Non"	Button Allaxis4,pos={228,407},size={40,20},proc=OneOneFunc,title="1:1"	CheckBox check0,pos={22,400},size={57,14},proc=AutoOnOffFunk,title="AutoSize"	CheckBox check0,value= 1	CheckBox check1,pos={178,143},size={57,14},proc=AutoOnOffFunk,title="AutoSize"	CheckBox check1,value= 1	CheckBox XYswap,pos={178,127},size={53,14},proc=XYswapCheckFunc,title="XY swap"	CheckBox XYswap,value= 0	SetVariable XYswapOnOff,pos={239,127},size={32,15},disable=2,title=" "	SetVariable XYswapOnOff,value= XYswapCheck	SetVariable GsizeY1,pos={31,456},size={106,15},proc=SetMarginFunc_Top,title="top (cm)"	SetVariable GsizeY1,limits={-inf,inf,0.1},value= topMargin	SetVariable GsizeX1,pos={143,456},size={88,15},proc=SetMarginFunc_Right,title="right"	SetVariable GsizeX1,limits={-inf,inf,0.1},value= rightMargin	Button Setsizevalue1,pos={178,434},size={41,20},proc=SetMarginFunc,title="Use"	Button Allaxis5,pos={228,433},size={40,20},proc=AutoMarginFunc,title="Auto"	Button Getsizeinfo1,pos={129,434},size={44,20},proc=GetMarginFunc,title="Get"	SetVariable GsizeX2,pos={143,474},size={88,15},proc=SetMarginFunc_Left,title="left"	SetVariable GsizeX2,limits={-inf,inf,0.1},value= leftMargin	SetVariable GsizeY2,pos={31,474},size={106,15},proc=SetMarginFunc_Bottom,title="bottom"	SetVariable GsizeY2,limits={-inf,inf,0.1},value= bottomMargin	CheckBox check2,pos={48,112},size={46,14},proc=MarginOnOffFunk,title="Margin"	CheckBox check2,value= 1	SetVariable YlabelOn1,pos={103,112},size={32,15},disable=2,title=" "	SetVariable YlabelOn1,value= MarginCheck	SetVariable XYswapOnOff1,pos={239,143},size={32,15},disable=2,title=" "	SetVariable XYswapOnOff1,value= AutoCheckEndMacroProc SetAllOnFunc (ctrlName) : ButtonControl	String ctrlName	if (Xsizechecked == 1)   SetXSize ()  endif  	if (Ysizechecked == 1)    SetYSize ()   endif	silent 1 ; pauseupdate	if (XYswapCheck == 1)    swapXYgo ()  endif	if (XAxischecked == 1)  SetXAxisgo ()  endif  	if (YAxischecked == 1)   SetYAxisgo ()	  endif  	if (Xvaluechecked == 1)  SetX ()  endif  	if (Yvaluechecked == 1)   SetY ()  endif 	if (Xlabelchecked == 1)  SetXlabel ()  endif  if (Ylabelchecked == 1)  	 SetYlabel ()  endif  if (Margincheck == 1)  	SetMargin ()  endif  endFunction AllcondintionFunc(ctrlName) : ButtonControl	String ctrlName   Nvar  YAxischecked, XAxischecked, Yvaluechecked, Xvaluechecked   Nvar Ysizechecked, Xsizechecked, Ylabelchecked, Xlabelchecked   Nvar MarginCheck   YAxischecked=1; XAxischecked = 1; Yvaluechecked =1; Xvaluechecked=1   Ysizechecked=1; Xsizechecked=1; Ylabelchecked=1; Xlabelchecked=1   MarginCheck=1EndFunction NoncondintionFunc(ctrlName) : ButtonControl	String ctrlName   Nvar  YAxischecked, XAxischecked, Yvaluechecked, Xvaluechecked   Nvar Ysizechecked, Xsizechecked, Ylabelchecked, Xlabelchecked   Nvar MarginCheck   YAxischecked=0; XAxischecked = 0; Yvaluechecked =0; Xvaluechecked=0   Ysizechecked=0; Xsizechecked=0; Ylabelchecked=0; Xlabelchecked=0   MarginCheck=0EndProc MarginOnOffFunk (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   MarginCheck = checkedEndFunction GetAllInfoFunc (ctrlName) : ButtonControl	String ctrlName	Getlabel ()  GetSize ()  GetXY ()  GetAxisgo ()  GetMargin ()EndFunction AutoMarginFunc (ctrlName) : ButtonControl	String ctrlName  AutoMargin ()EndFunction AutoMargin ()	ModifyGraph/Z margin(top)=0, margin(bottom)=0, margin(left)=0, margin(right)=0endFunction SetMarginFunc (ctrlName) : ButtonControl	String ctrlName  SetMargin ()EndFunction SetMarginFunc_Top (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName  SetMargin_Top ()EndFunction SetMarginFunc_Bottom (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName  SetMargin_Bottom ()EndFunction SetMarginFunc_Right (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName  SetMargin_Right ()EndFunction SetMarginFunc_Left (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName  SetMargin_Left ()EndFunction SetMargin ()   SetMargin_Top()   SetMargin_Bottom()   SetMargin_Left()   SetMargin_Right()endFunction  SetMargin_Top()   Nvar topMargin   variable top   top = topMargin*72/2.54   ModifyGraph/Z margin(top)=topendFunction SetMargin_Bottom()   Nvar bottomMargin   variable bottom   bottom = bottomMargin*72/2.54   ModifyGraph/Z margin(bottom)=bottomendFunction SetMargin_Left()   Nvar leftMargin   variable left   left = leftMargin*72/2.54   ModifyGraph/Z margin(left)=leftendFunction SetMargin_Right()   Nvar rightMargin   variable right   right = rightMargin*72/2.54   ModifyGraph/Z margin(right)=rightendFunction GetMarginFunc (ctrlName) : ButtonControl	String ctrlName  GetMargin ()EndFunction GetMargin ()   Nvar topMargin, rightMargin, leftMargin, bottomMargin   string style, linestr, marginStr   string leftStr, bottomStr, topStr, rightStr   variable  leftVal, bottomVal, topVal, rightVal   variable lineNum, i, itemNum   style = WinRecreation(winname(0,1),1)   lineNum = ItemsInList(style, "\r")  if (stringmatch(style,"*ModifyGraph/Z margin*")==1)     	for (i=0 ; i < lineNum ; i+=1)   	   linestr =	 StringFromList(i, style, "\r")   	   if (stringmatch(linestr,"*ModifyGraph/Z margin*") == 1)   	        marginStr = StringFromList(1, linestr, " ")   	        if (stringmatch(linestr,"*margin(left)*")==1)   	           leftStr = StringByKey("margin(left)", marginStr, "=",",")     	           leftVal = str2num(leftStr)             else               leftVal = 0             endif             if (stringmatch(linestr,"*margin(bottom)*")==1)   	           bottomStr = StringByKey("margin(bottom)", marginStr, "=",",")     	           bottomVal = str2num(bottomStr)             else               bottomVal = 0             endif   	        if (stringmatch(linestr,"*margin(top)*")==1)   	           topStr = StringByKey("margin(top)", marginStr, "=",",")     	           topVal = str2num(topStr)             else               topVal = 0             endif   	            	        if (stringmatch(linestr,"*margin(right)*")==1)   	           rightStr = StringByKey("margin(right)", marginStr, "=",",")     	           rightVal = str2num(rightStr)             else               rightVal = 0             endif    	   endif       endfor  else     leftVal = 0; bottomVal = 0; topVal = 0;  rightVal = 0  endif  topMargin=topVal/72*2.54; rightMargin=rightVal/72*2.54; leftMargin=leftVal/72*2.54; bottomMargin=bottomVal/72*2.54endProc XYswapCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   XYswapCheck = checkedEndProc AutoSizeCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   AutoSizeCheck = checkedEndProc AutoOnOffFunk (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   AutoCheck = checkedEndFunction AutoFunc (ctrlName) : ButtonControl	String ctrlName  AutoFuncGo ()EndFunction AutoFuncGo ()  ModifyGraph width=0  ModifyGraph height=0endFunction OneOneFunc (ctrlName) : ButtonControl	String ctrlName  OneOneGo ()EndFunction OneOneGo ()ModifyGraph height={Aspect,1}endFunction XlabelcheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar Xlabelchecked  Xlabelchecked = checkedEndFunction YlabelcheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar Ylabelchecked  Ylabelchecked = checkedEndFunction XvaluecheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar Xvaluechecked  Xvaluechecked = checkedEndFunction YvaluecheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar Yvaluechecked  Yvaluechecked = checkedendFunction XSizecheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar Xsizechecked  Xsizechecked = checkedEndFunction YSizecheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar Ysizechecked  Ysizechecked = checkedEndFunction XAxischeckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar XAxischecked  XAxischecked = checkedEndFunction YAxischeckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked  nvar YAxischecked  YAxischecked = checkedEndFunction SetlabelFunc(ctrlName) : ButtonControl	String ctrlName  SetXlabel ()  SetYlabel ()EndFunction SetXlabel ()  Svar BottomLabel, LeftLabel  Label Bottom BottomLabelendFunction SetYlabel ()  Svar BottomLabel, LeftLabel  Label left LeftLabelendFunction GetLabelFunc(ctrlName) : ButtonControl	String ctrlName  Getlabel ()EndFunction Getlabel ()   Svar BottomLabel, LeftLabel   string style, linestr, Ylabelmodify, Xlabelmodify, rawLabel   variable lineNum, i, j, lineleng, itemNum   Svar stringstr   style = WinRecreation(winname(0,1),1)   lineNum = ItemsInList(style, "\r")   Xlabelmodify = ""   Ylabelmodify =""   if (stringmatch(style,"*Label/Z left*")==1)     	for (i=0 ; i < lineNum ; i+=1)   	   linestr =	 StringFromList(i, style, "\r")   	   if (stringmatch(linestr,"*Label/Z left*") == 1)   	      rawLabel =  linestr[strlen("Label/Z left ")+2,strlen(linestr)-2]             Ylabelmodify=""             itemNum = ItemsInList(rawLabel, "\\\\")             Ylabelmodify+=StringFromList(0, rawLabel,"\\\\")               for (j=1 ; j<itemnum ; j+=1)                       if (stringmatch(StringFromList(j, rawLabel,"\\\\"), "")!=1)                  Ylabelmodify+="\\"+StringFromList(j, rawLabel,"\\\\")                 endif               endfor   	   endif       endfor    endif    if (stringmatch(style,"*swapXY=1*")==1)                  BottomLabel = Ylabelmodify      else                  LeftLabel = Ylabelmodify               endif       if (stringmatch(style,"*Label/Z Bottom*")==1)	     for (i=0 ; i < lineNum ; i+=1)           linestr =	 StringFromList(i, style, "\r")   	   if (stringmatch(linestr,"*Label/Z bottom*") == 1)   	      rawLabel =  linestr[strlen("Label/Z Bottom ")+2,strlen(linestr)-2]              Xlabelmodify=""              itemNum = ItemsInList(rawLabel, "\\\\")            Xlabelmodify+=StringFromList(0, rawLabel,"\\\\")               for (j=1; j<itemnum ; j+=1)                 if (stringmatch(StringFromList(j, rawLabel,"\\\\"), "")!=1)                Xlabelmodify+="\\"+StringFromList(j, rawLabel,"\\\\")                 endif               endfor   	   endif   	endfor      endif    if (stringmatch(style,"*swapXY=1*")==1)         LeftLabel = Xlabelmodify    else         BottomLabel = Xlabelmodify   endifendproc SetXSizeInput (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	SetXSize ()Endproc SetYSizeInput (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	SetYSize ()Endproc SetSizeFunc (ctrlName) : ButtonControl	String ctrlName  SetXSize ()  SetYSize ()Endproc SetXSize ()//Nvar Ysizevalue, Xsizevalue  ModifyGraph width=(Xsizevalue/2.54*72)  if (Autocheck == 1)    AutoFuncGo ()  endifendproc SetYSize ()//Nvar Ysizevalue, Xsizevalue  ModifyGraph height=(Ysizevalue/2.54*72)    if (Autocheck == 1)    AutoFuncGo ()  endifend  Function GetSizeFunc (ctrlName) : ButtonControl	String ctrlName  GetSize ()EndFunction Getsize ()	string topgraph 	Nvar Ysizevalue, Xsizevalue	variable hight, width	topgraph = winname(0,1)	getwindow $topgraph, psize	Xsizevalue = (V_right-V_left)/72*2.54	Ysizevalue = (V_Bottom-V_top)/72*2.54endFunction SetXFunc (ctrlName) : ButtonControl	String ctrlName  SetX ()EndFunction SetYFunc (ctrlName) : ButtonControl	String ctrlName  SetY ()EndFunction SetX () Nvar XmaxValue,XminValue,YmaxValue,YminValue SetAxis bottom XminValue, XmaxValueend Function SetY () Nvar XmaxValue,XminValue,YmaxValue,YminValue SetAxis left YminValue, YmaxValue end   Function GetXYfunc (ctrlName) : ButtonControl	String ctrlName  GetXY ()EndFunction GetXY ()	Nvar XmaxValue,XminValue,YmaxValue,YminValue	GetAxis/q left	YminValue= V_min ; YmaxValue= V_max 	GetAxis/q bottom	XminValue= V_min ; XmaxValue= V_max endFunction SetAxisFunc (ctrlName) : ButtonControl	String ctrlName	SwapXYgo ()		SetXAxisgo ()	SetYAxisgo ()	endFunction SwapXYgo ()	 Nvar SwapXYvalue  	if (SwapXYvalue==1) 	ModifyGraph swapXY=1  else 	ModifyGraph swapXY=0  endifend Function SetXAxisgo ()		nvar ZeroLeft, Zerobottom, MinorLeft, MinorBottom, FontSizevalue	nvar LabelOnleft, LabelOnBottom, TickLeft, TickBottom, OffsetLeft, OffsetBottom	Nvar XmaxValue,XminValue,YmaxValue,YminValue	Nvar Ychecked, Xchecked	Nvar StandLeft, StandBottom	BasicXFunc ()	ModifyGraph fsize=(FontSizevalue)	  if (ZeroBottom==1)  ModifyGraph zero(Bottom)=3  else  ModifyGraph zero(Bottom)=0  endif    if (TickBottom==1)  ModifyGraph tick(Bottom)=2  else  ModifyGraph tick(Bottom)=3  endif   if (LabelOnBottom==1)  ModifyGraph noLabel(Bottom)=0  else  ModifyGraph noLabel(Bottom)=1  endif  if (MinorBottom==1)  ModifyGraph minor(Bottom)=1  else  ModifyGraph minor(Bottom)=0  endif   if (StandBottom==1)  ModifyGraph standoff(Bottom)=1  else  ModifyGraph standoff(Bottom)=0  endif      ModifyGraph axOffset(Bottom) =  OffsetBottomendFunction SetYAxisgo ()		nvar ZeroLeft, Zerobottom, MinorLeft, MinorBottom, FontSizevalue	nvar LabelOnleft, LabelOnBottom, TickLeft, TickBottom, OffsetLeft, OffsetBottom	Nvar XmaxValue,XminValue,YmaxValue,YminValue	Nvar Ychecked, Xchecked	Nvar StandLeft, StandBottom	BasicYFunc ()	ModifyGraph fsize=(FontSizevalue)  if (ZeroLeft==1)  ModifyGraph zero(left)=3  else  ModifyGraph zero(left)=0  endif        if (TickLeft==1)  ModifyGraph tick(left)=2  else  ModifyGraph tick(left)=3  endif      if (LabelOnleft==1)  ModifyGraph noLabel(left)=0  else  ModifyGraph noLabel(left)=1  endif     if (MinorLeft==1)  ModifyGraph minor(left)=1  else  ModifyGraph minor(left)=0  endif    if (StandLeft==1)  ModifyGraph standoff(Left)=1  else  ModifyGraph standoff(Left)=0  endif  ModifyGraph axOffset(left) = OffsetLeftendFunction GetAxisFunc (ctrlName) : ButtonControl	String ctrlName	GetAxisgo ()endFunction GetAxisgo ()	nvar ZeroLeft, Zerobottom, MinorLeft, MinorBottom, FontSizevalue	nvar LabelOnleft, LabelOnBottom, TickLeft, TickBottom, OffsetLeft, OffsetBottom	nvar Standleft, StandBottom, SwapXYvalue	string Infoleft, InfoBottom, Numstr, Focusstr	string style	Nvar XmaxValue,XminValue,YmaxValue,YminValue	style = WinRecreation(winname(0,1),1) 	Infoleft =  AxisInfo("", "left") 	InfoBottom = AxisInfo("", "Bottom")   if (stringmatch(style,"*swapXY=1*")==1)     SwapXYvalue = 1  else 	  SwapXYvalue = 0	endif		Focusstr="zero(x)"	Numstr=StringByKey(Focusstr, Infoleft,"=")	if (stringmatch(Numstr,"0")!=1)   ZeroLeft = 1   else   ZeroLeft = 0   endif   Numstr=StringByKey(Focusstr, InfoBottom,"=")   if (stringmatch(Numstr,"0")!=1)   Zerobottom = 1   else   Zerobottom = 0   endif   	Focusstr="minor(x)"	Numstr=StringByKey(Focusstr, Infoleft,"=")	if (stringmatch(Numstr,"0")!=1)   MinorLeft = 1   else   MinorLeft = 0   endif   Numstr=StringByKey(Focusstr, InfoBottom,"=")   if (stringmatch(Numstr,"0")!=1)   MinorBottom = 1   else   MinorBottom = 0   endif   	Focusstr="noLabel(x)"	Numstr=StringByKey(Focusstr, Infoleft,"=")	if (stringmatch(Numstr,"1")!=1)   LabelOnleft = 1   else   LabelOnleft = 0   endif   Numstr=StringByKey(Focusstr, InfoBottom,"=")   if (stringmatch(Numstr,"1")!=1)   LabelOnBottom = 1   else   LabelOnBottom = 0   endif	Focusstr="tick(x)"	Numstr=StringByKey(Focusstr, Infoleft,"=")	if (stringmatch(Numstr,"2")==1)   TickLeft = 1   else   TickLeft = 0   endif  Numstr=StringByKey(Focusstr, InfoBottom,"=")   if (stringmatch(Numstr,"2")==1)   TickBottom = 1   else   TickBottom = 0   endif      Focusstr="standoff(x)"	Numstr=StringByKey(Focusstr, Infoleft,"=")	if (stringmatch(Numstr,"1")==1)   Standleft = 1   else   Standleft = 0   endif  Numstr=StringByKey(Focusstr, InfoBottom,"=")   if (stringmatch(Numstr,"1")==1)   StandBottom = 1   else   StandBottom = 0   endif      Focusstr="axOffset(x)"	Numstr=StringByKey(Focusstr, Infoleft,"=")	OffsetLeft = str2num(Numstr)   Numstr=StringByKey(Focusstr, InfoBottom,"=")   OffsetBottom = str2num(Numstr)      Focusstr="fsize(x)"   Numstr=StringByKey(Focusstr, Infoleft,"=")   FontSizevalue = str2num(Numstr)EndFunction SwapXYFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar SwapXYvalueSwapXYvalue = varNumif (SwapXYvalue == 1)ModifyGraph swapXY=1else ModifyGraph swapXY=0endifEndproc AllaxisFunc(ctrlName) : ButtonControl	String ctrlName  SetAxis/A  GetXY ()EndFunction Value_menu (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr		if ( popnum==1 ) 		SetVariable Xmax, limits={-Inf,Inf,0.001}		SetVariable Xmin, limits={-Inf,Inf,0.001}		SetVariable Ymax, limits={-Inf,Inf,0.001}		SetVariable Ymin, limits={-Inf,Inf,0.001}		endif	  if ( popnum==2 ) 		SetVariable Xmax, limits={-Inf,Inf,0.01}		SetVariable Xmin, limits={-Inf,Inf,0.01}		SetVariable Ymax, limits={-Inf,Inf,0.01}		SetVariable Ymin, limits={-Inf,Inf,0.01}		endif		if ( popnum==3 ) 		SetVariable Xmax, limits={-Inf,Inf,0.1}		SetVariable Xmin, limits={-Inf,Inf,0.1}		SetVariable Ymax, limits={-Inf,Inf,0.1}		SetVariable Ymin, limits={-Inf,Inf,0.1}		endif	   if ( popnum==4 ) 		SetVariable Xmax, limits={-Inf,Inf,1}		SetVariable Xmin, limits={-Inf,Inf,1}		SetVariable Ymax, limits={-Inf,Inf,1}		SetVariable Ymin, limits={-Inf,Inf,1}		endif	   if ( popnum==5 ) 		SetVariable Xmax, limits={-Inf,Inf,10}		SetVariable Xmin, limits={-Inf,Inf,10}		SetVariable Ymax, limits={-Inf,Inf,10}		SetVariable Ymin, limits={-Inf,Inf,10}		endif	   if ( popnum==6 ) 		SetVariable Xmax, limits={-Inf,Inf,100}		SetVariable Xmin, limits={-Inf,Inf,100}		SetVariable Ymax, limits={-Inf,Inf,100}		SetVariable Ymin, limits={-Inf,Inf,100}		endif	   if ( popnum==7 ) 		SetVariable Xmax, limits={-Inf,Inf,1000}		SetVariable Xmin, limits={-Inf,Inf,1000}		SetVariable Ymax, limits={-Inf,Inf,1000}		SetVariable Ymin, limits={-Inf,Inf,1000}		endifEndFunction MinorFunc_backup (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar LeftOn, MinorLeft, MinorBottom	if (checked==1 && LeftOn==1)	ModifyGraph minor(left)=1 ; MinorLeft=1	elseif (checked==0 && LeftOn==1)  ModifyGraph minor(left)=0 ; MinorLeft=0  elseif (checked==1 && LeftOn==0)  ModifyGraph minor(bottom)=1 ; MinorBottom=1  elseif (checked==0 && LeftOn==0)  ModifyGraph minor(bottom)=0 ; MinorBottom=0  endifEndFunction MinorFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar   MinorLeft, MinorBottom		if (MinorLeft==1)	ModifyGraph minor(left)=1	elseif (MinorLeft==0)  ModifyGraph minor(left)=0  endif    if (MinorBottom==1)  ModifyGraph minor(bottom)=1  elseif (MinorBottom==0)  ModifyGraph minor(bottom)=0  endifEndFunction TickFunc_backup (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar LeftOn, TickLeft, TickBottom	if (checked==1 && LeftOn==1)	ModifyGraph tick(left)=2 ; TickLeft=1	elseif (checked==0 && LeftOn==1)  ModifyGraph tick(left)=3 ; TickLeft=0  elseif (checked==1 && LeftOn==0)  ModifyGraph tick(bottom)=2 ; TickBottom=1  elseif (checked==0 && LeftOn==0) ModifyGraph tick(bottom)=3 ; TickBottom=0  endifEndFunction TickFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar  TickLeft, TickBottom		if (TickLeft==1)	ModifyGraph tick(left)=2	elseif (TickLeft==0)  ModifyGraph tick(left)=3  endif     if (TickBottom==1)  ModifyGraph tick(bottom)=2  elseif (TickBottom==0)  ModifyGraph tick(bottom)=3  endifEndFunction Standfunc_backup (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar LeftOn, Standleft, StandBottom	if (checked==1 && LeftOn==1)	ModifyGraph standoff(left)=1 ; Standleft=1	elseif (checked==0 && LeftOn==1)  ModifyGraph standoff(left)=0 ; Standleft=0  elseif (checked==1 && LeftOn==0)  ModifyGraph standoff(bottom)=1 ; StandBottom=1  elseif (checked==0 && LeftOn==0)  ModifyGraph standoff(bottom)=0 ; StandBottom=0  endifEndFunction Standfunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar  Standleft, StandBottom		if (Standleft==1)	ModifyGraph standoff(left)=1	elseif (Standleft==0)  ModifyGraph standoff(left)=0  endif     if (StandBottom==1)  ModifyGraph standoff(bottom)=1  elseif (StandBottom==0)  ModifyGraph standoff(bottom)=0  endifEndFunction ZeroFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar  ZeroLeft, ZeroBottom		if (ZeroLeft==1)	ModifyGraph zero(left)=3 	elseif (ZeroLeft==0)  ModifyGraph zero(left)=0  endif     if (ZeroBottom==1)  ModifyGraph zero(bottom)=3   elseif (ZeroBottom==0)  ModifyGraph zero(bottom)=0   endifEndFunction LabelFunc_backup (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar LeftOn, LabelOnleft, LabelOnBottom	if (checked==1 && LeftOn==1)	ModifyGraph noLabel(left)=0 ; LabelOnleft=1	elseif (checked==0 && LeftOn==1) ModifyGraph noLabel(left)=1 ; LabelOnleft=0  elseif (checked==1 && LeftOn==0)  ModifyGraph noLabel(bottom)=0 ; LabelOnBottom=1  elseif (checked==0 && LeftOn==0) ModifyGraph noLabel(bottom)=1 ; LabelOnBottom=0  endifEndFunction LabelFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar  LabelOnleft, LabelOnBottom		if (LabelOnleft==1)	ModifyGraph noLabel(left)=0	elseif (LabelOnleft==0) ModifyGraph noLabel(left)=1  endif     if (LabelOnBottom==1)  ModifyGraph noLabel(Bottom)=0   elseif (LabelOnBottom==0)  ModifyGraph noLabel(Bottom)=1  endifEndFunction ZeroFunc_backup (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar LeftOn, ZeroLeft, ZeroBottom	if (checked==1 && LeftOn==1)	ModifyGraph zero(left)=3 ; ZeroLeft=1	elseif (checked==0 && LeftOn==1)  ModifyGraph zero(left)=0 ; ZeroLeft=0  elseif (checked==1 && LeftOn==0)  ModifyGraph zero(bottom)=3 ; ZeroBottom=1  elseif (checked==0 && LeftOn==0)  ModifyGraph zero(bottom)=0 ; ZeroBottom=0  endifEndFunction GetXYoffset (ctrlName) : ButtonControl	String ctrlName	string Infoleft, InfoBottom, Numstr, Focusstr	Nvar OffsetLeft, OffsetBottom  Infoleft =  AxisInfo("", "left") 	InfoBottom = AxisInfo("", "Bottom")	 Focusstr="axOffset(x)"	Numstr=StringByKey(Focusstr, Infoleft,"=")	OffsetLeft = str2num(Numstr)   Numstr=StringByKey(Focusstr, InfoBottom,"=")   OffsetBottom = str2num(Numstr)endFunction InputXYoffset (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar  OffsetLeft, OffsetBottom modifygraph axOffset(left) = OffsetLeft   modifygraph axOffset(Bottom) = OffsetBottomEndFunction DegFunc (ctrlName) : ButtonControl	String ctrlName	InputLabel ("Angle (deg)")EndFunction dKxFunc (ctrlName) : ButtonControl	String ctrlName	InputLabel ("\\F'Symbol'D\\F'Times'\\f02k\\Bx\\M\\f00 / \\F'Symbol'p")EndFunction TempFunc (ctrlName) : ButtonControl	String ctrlName 	InputLabel ("Temperature (K)")EndFunction dKyFunc (ctrlName) : ButtonControl	String ctrlName	InputLabel ("\\F'Symbol'D\\F'Times'\\f02k\\By\\M\\f00 / \\F'Symbol'p")EndFunction InputLabel (labelstr)string labelstr	Nvar LeftOn	svar BottomLabel, LeftLabel	if (LeftOn==1) Label Left labelstr LeftLabel= labelstr  elseif (LeftOn==0) Label Bottom labelstr BottomLabel= labelstr endifEndFunction EnergyFunc (ctrlName) : ButtonControl	String ctrlName InputLabel ("Energy (eV)")EndFunction IntFunc (ctrlName) : ButtonControl	String ctrlName  	InputLabel ("Intensity (arb. units)")EndFunction Chanfunc (ctrlName) : ButtonControl	String ctrlName  	InputLabel ("Channel")EndFunction KxFunc (ctrlName) : ButtonControl	String ctrlName  	InputLabel ("\\f02k\\Bx\\M\\f00 / \\F'Symbol'p")EndFunction KyFunc (ctrlName) : ButtonControl	String ctrlName  		InputLabel ("\\f02k\\By\\M\\f00 / \\F'Symbol'p")EndFunction InputXFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar  XmaxValue,XminValue,YmaxValue,YminValue   SetAxis bottom XminValue,XmaxValueEndFunction InputYFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar  XmaxValue,XminValue,YmaxValue,YminValue   SetAxis left YminValue,YmaxValueEndFunction XYswapFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	if (checked==1)	ModifyGraph swapXY=1	elseif (checked==0)   ModifyGraph swapXY=0  endifEndFunction BasicYFunc ()ModifyGraph tick(left)=2ModifyGraph mirror(left)=1ModifyGraph standoff(left)=0ModifyGraph noLabel(left)=0EndFunction BasicXFunc ()ModifyGraph tick(bottom)=2ModifyGraph mirror(bottom)=1ModifyGraph standoff(bottom)=0ModifyGraph noLabel(bottom)=0EndFunction BasicFunc (ctrlName) : ButtonControl	String ctrlNameBasicYFunc ()BasicXFunc ()EndFunction FontSizeFunc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varNameModifyGraph fSize=(varNum)EndFunction AxisSetFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Nvar LeftOn	svar AxisName	if (stringmatch(popStr,"bottom")==1)  LeftOn=0; AxisName="bottom"  elseif (stringmatch(popStr,"Left")==1)  LeftOn=1; AxisName="Left"  endifEndFunction BottomFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	svar BottomLabel	BottomLabel = varStr	Label Bottom BottomLabelEndFunction LeftFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	svar LeftLabel	LeftLabel = varStr	Label Left LeftLabelEndWindow Register() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(982,354,1200,745)	ModifyPanel cbRGB=(65535,60076,49151)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 14,154,204,154	SetDrawEnv linethick= 2	DrawLine 14,158,204,158	SetVariable ResisterWin,pos={9,2},size={191,15},proc=Renamewinfunc,title="Window"	SetVariable ResisterWin,value= GotName	PopupMenu Tablepopup,pos={28,44},size={115,17},proc=ShowGraph,title="Table"	PopupMenu Tablepopup,mode=2,popvalue="TBcoeff_R",value= #"\"none;\" + winList(\"*_R\",\";\",\"win:2\")"	PopupMenu Graphpopup,pos={26,66},size={132,17},proc=ShowTable,title="Graph"	PopupMenu Graphpopup,mode=2,popvalue="selfenergy_R",value= #"\"none;\" + winList(\"*_R\",\";\",\"win:1\")"	Button GetName,pos={51,20},size={37,20},proc=GetNameFunc,title="Get"	PopupMenu Graphpopup1,pos={22,88},size={121,17},proc=ShowLayout,title="Layout"	PopupMenu Graphpopup1,mode=6,popvalue="Analyse_R",value= #"\"none;\" + winList(\"*_R\",\";\",\"win:4\")"	Button Set_R,pos={97,20},size={37,20},proc=RegFunc,title="Reg"	Button Clear,pos={142,20},size={40,20},proc=ClearFunc,title="Clear"	Button button17,pos={12,163},size={61,20},proc=wavelistfunc,title="Wavelist"	Button button18,pos={83,163},size={62,20},proc=tracelistfunc,title="Tracelist"	Button button19,pos={14,315},size={51,20},proc=sameGfunc,title="sameG"	Button button20,pos={13,184},size={44,20},proc=YcsrAFunc,title="YcsrA"	Button button21,pos={63,184},size={43,20},proc=XcsrAFunc,title="XcsrA"	PopupMenu Graphpopup2,pos={12,109},size={124,17},proc=ShowNotebook,title="Notebook"	PopupMenu Graphpopup2,mode=2,popvalue="Memo_R",value= #"\"none;\" + winList(\"*_R\",\";\",\"win:16\")"	Button button22,pos={112,184},size={44,20},proc=YcsrBFunc,title="YcsrB"	Button button23,pos={161,184},size={43,20},proc=XcsrBFunc,title="XcsrB"	Button ButtonGraph2,pos={12,272},size={98,20},proc=NormInGraphFunc,title="DivByMeanAll"	Button button24,pos={74,315},size={48,20},proc=copyGfunc,title="copyG"	SetVariable copyGoffset,pos={15,362},size={91,15},proc=copyG_offset,title="Offset"	SetVariable copyGoffset,limits={-inf,inf,0.1},value= copyG_offs	PopupMenu changeValue,pos={109,360},size={51,17},proc=copyG_ValmenuFunc,title=" "	PopupMenu changeValue,mode=2,popvalue="0.1",value= #"\"0.01;0.1;1;10;100;1000;10000\""	SetVariable copyGoffset1,pos={146,111},size={64,15},proc=NoteFontSizeFunc,title="Font"	SetVariable copyGoffset1,limits={1,inf,1},value= NoteFontSize	Button ButtonGraph3,pos={12,337},size={65,20},proc=GoRootFunc,title="Go root:"	Button ButtonGraph4,pos={83,337},size={57,20},proc=GodirFunc,title="Go dir:"	Button GetName1,pos={161,129},size={45,20},proc=MakeNewNote,title="make"	SetVariable ResisterWin1,pos={20,132},size={136,15},title="note name"	SetVariable ResisterWin1,value= NewNoteName	Button ButtonGraph5,pos={121,294},size={78,20},proc=DivMeanOne,title="DivByMean"	SetVariable copyGoffset2,pos={13,298},size={54,15},title="Ei"	SetVariable copyGoffset2,limits={-inf,inf,0.1},value= DivMean_Ei	SetVariable copyGoffset3,pos={66,298},size={54,15},title="Ef"	SetVariable copyGoffset3,limits={-inf,inf,0.1},value= DivMean_Ef	Button ButtonGraph6,pos={121,271},size={63,20},proc=XscaleFunc,title="Xscale"	Button button25,pos={13,251},size={70,20},proc=FindWindowFunc,title="Find Win"	Button button26,pos={13,205},size={44,20},proc=YvalAFunc,title="YvalA"	Button button27,pos={63,205},size={43,20},proc=XvalAFunc,title="XvalA"	Button button28,pos={112,205},size={44,20},proc=YvalBFunc,title="YvalB"	Button button29,pos={161,205},size={43,20},proc=XvalBFunc,title="XvalB"	Button button30,pos={14,227},size={80,20},proc=DuplicateFunc,title="Duplicate"	Button button31,pos={100,227},size={80,20},proc=SortingWaveFunc,title="Sorting"EndMacroFunction SortingWaveFunc (ctrlName) : ButtonControl	String ctrlName	string source, type, option="", resultName	option+="1: Reverse"	option+=";2: Increase"	option+=";3: Decrease"	Prompt source,"Choose wave for sorting: ", popup  wavelist("*",";","win:")	Prompt type, "Type of sorting: ", popup  option  DoPrompt "Sorting", source, type  if (V_flag != 0) 	  return -1; // User cancelled.   endif   if ( stringmatch(type,"1: Reverse")==1 )      duplicate/o $source temp    resultName=source+"_reverse"    Reverse temp    duplicate/o temp $resultName    appendtotable $resultName  endif   if ( stringmatch(type,"2: Increase")==1 )      duplicate/o $source temp    resultName=source+"_increase"    Sort $source temp    duplicate/o temp $resultName    appendtotable $resultName  endif   if ( stringmatch(type,"3: Decrease")==1 )      duplicate/o $source temp    resultName=source+"_decrease"    Sort/r $source temp    duplicate/o temp $resultName    appendtotable $resultName  endif end			Function DuplicateFunc (ctrlName) : ButtonControl	String ctrlName	string Xname, Yname, YesNo, Xsource, Ysource	Ysource=csrwave(a) ;  Yname=csrwave(a)	Xsource=csrXwave(a);  Xname=csrXwave(a)	Prompt Yname, "Change X wave name: "	Prompt Xname, "Change Y wave name: "  Doprompt "Duplicate X wave and Y wave", Yname, Xname  if (V_Flag)   			return -1// User canceled   endif   if ( stringmatch(Yname,Ysource) || stringmatch(Xname,Xsource) )     abort "Change names !!"  endif  if (exists(Yname) || exists(Xname))  	Prompt YesNo, "There is same wave. Replace?", popup "NO;Yes"    Doprompt "Yes or No", YesNo    if (V_Flag)   			return -1// User canceled     endif      if (stringmatch(YesNo,"No"))      abort    endif  endif  duplicate/o $Ysource $Yname  duplicate/o $Xsource $Xname  display $Yname vs $Xname  ModifyGraph mode=4,marker=19  BasicFigureFunc ()  print "Ywave: ", Yname  print "Xwave: ", Xnameend Function BasicFigureFunc () BasicYFunc () BasicXFunc () ModifyGraph fSize=(15) ModifyGraph minor=1 ModifyGraph zero=3endFunction YvalAFunc (ctrlName) : ButtonControl	String ctrlNameprint "YvalA:",vcsr(a)end Function XvalAFunc (ctrlName) : ButtonControl	String ctrlNameprint "XvalA:",hcsr(a)end Function YvalBFunc (ctrlName) : ButtonControl	String ctrlNameprint "YvalB:",vcsr(b)end Function XvalBFunc (ctrlName) : ButtonControl	String ctrlNameprint "XvalB:",hcsr(b)end Function FindWindowFunc (ctrlName) : ButtonControl	String ctrlName	string TableName, GraphName, layoutname, PanelStr, GraphInlayout, Name, Allstr="", PanelType	variable  i=0, j=0, k=0, l=0	Svar FindWaveName  Name = FindWaveName	Prompt Name, "Wave Name: "	Prompt PanelType, "Looking panel type: ", popup "Graph and Table"+";Layout"  Doprompt "Find window with input wave name", Name, PanelType  if (V_Flag)   			return -1// User canceled   endif   FindWaveName = Name  Print "///////////// Search wave: ", Name  silent 1 ; pauseupdateif (stringmatch(PanelType,"Graph and Table")==1)    do     GraphName = WinName(i,1)    if (stringmatch(wavelist(name,"","win:"+GraphName),"")==0 && stringmatch(GraphName,"")==0)     dowindow/f $GraphName     print "Found Graph: ", GraphName     Allstr+=GraphName    endif    i+=1  while (stringmatch(GraphName,"")!=1)    do     TableName = WinName(j,2)    if (stringmatch(wavelist(name,"","win:"+TableName),"")==0 && stringmatch(TableName,"")==0)     dowindow/f $TableName    	print "Found Table: ", TableName    	 Allstr+=TableName    endif    j+=1  while (stringmatch(TableName,"")!=1)elseif (stringmatch(PanelType,"Layout")==1)    do  	layoutname = WinName(k,4)  	do  		 	PanelStr = StringFromList( 0, LayoutInfo(layoutname, num2str(l) ) )  		GraphInlayout = StringFromList(1, PanelStr , ":")   		if (WinType(GraphInlayout)==1 || WinType(GraphInlayout)==2 && stringmatch(layoutname,"")==0)	    	  if (stringmatch(wavelist(name,"","win:"+GraphInlayout),"")==0 && stringmatch(GraphInlayout,"")==0)      	   dowindow/f $layoutname      	   dowindow/f $GraphInlayout    	  	 print "Found Layout: ", layoutname, ", Panel: ", GraphInlayout    	  	 Allstr+=layoutname    		endif   		endif      l+=1    while (stringmatch(GraphInlayout,"")!=1)     l=0    k+=1  while (stringmatch(layoutname,"")!=1)endif  if (stringmatch(Allstr,"")==1)  	abort "There are no such panels."  endifend Function XscaleFunc (ctrlName) : ButtonControl	String ctrlName	string waveAll, printstr ,Panelname, Xwave  variable Itemtotal, i, Xscale  Panelname = StringFromList(0,WinList("*", ";","WIN:23"))  Prompt Panelname, "Panel Name: "	Prompt Xscale, "maltiply by ?: "  Doprompt "X scole", Panelname, Xscale  if (V_Flag)   			return -1// User canceled   endif 	waveAll =TraceNameList("",";",1)	Itemtotal = ItemsInList(waveAll, ";")	for (i=0 ; i<Itemtotal; i+=1)   	printstr = StringFromList(i, waveAll)   	 Xwave = XWaveName(Panelname,printstr)   	 duplicate/o $Xwave temp   	 temp*=Xscale   	 duplicate/o temp $Xwave    	 if (stringmatch(Xwave,"")==1)   	   abort "No X wave!!"   	 endif	endfor	print Panelname, ": X scaled (maltiplied) by", Xscaleend	Function DivMeanOne (ctrlName) : ButtonControl	String ctrlName	string waveliststr, Xwave, Ywave 	variable Meanval, i	string currentStr, dfA, Ywavestr, Xwavestr   Wave  wA = CsrWaveRef(A)    Nvar DivMean_Ei, DivMean_Ef   if ( stringmatch(CsrWave(a),""))      Abort "Set A cursors!!"   endif   // wA = CsrWaveRef(A)     dfA = GetWavesDataFolder(wA, 1)   currentStr= GetDataFolder(1)   setdatafolder dfA   Xwavestr = csrXwave(A)   Ywavestr = csrwave(A)  	   if (stringmatch(Xwavestr,"")==1)   	  Meanval = faverage($Ywavestr,DivMean_Ei, DivMean_Ef)   	  duplicate/o $Ywavestr temp        temp /= abs(Meanval)       duplicate/o temp $Ywavestr     else    	  Meanval = faverageXY($Xwavestr,$Ywavestr,DivMean_Ei, DivMean_Ef)   	  duplicate/o $Ywavestr temp        temp /= abs(Meanval)       duplicate/o temp $Ywavestr       endif   print Meanval   setdatafolder currentStrEndFunction NormInGraphFunc (ctrlName) : ButtonControl	String ctrlName	string waveliststr, Xwave, Ywave 	variable Meanval, i, point_i, point_f	silent 1 ; pauseupdate     if ( stringmatch(CsrWave(a),"") || stringmatch(CsrWave(b),"") )      Abort "Set A and B cursors!!"    endif  waveliststr = TraceNameList("",";",1)    i=0 	 for (i=0 ; i < ItemsInList(waveliststr) ; i+=1) 	   Xwave = XWaveName("",StringFromList(i, waveliststr))	   if (stringmatch(Xwave,"")==1)   	  Meanval = faverage($StringFromList(i, waveliststr),hcsr(a),hcsr(b))   	  duplicate/o $StringFromList(i, waveliststr) temp        temp /= abs(Meanval)       duplicate/o temp $StringFromList(i, waveliststr)     else    	     	  FindLevel/q/P $Xwave, hcsr(a)   	  point_i = trunc(V_LevelX)   	  FindLevel/q/P $Xwave, hcsr(b)  	    	  point_f = trunc(V_LevelX)   	 //print point_i, point_f   	  duplicate/o $Xwave temp   	  duplicate/o $StringFromList(i,waveliststr) temp1   	   make/o/n=( abs(point_f-point_i)+1 ) temp2, temp3   	    	  temp2[]=temp[p+min(point_i,point_f)]   	  temp3[]=temp1[p+min(point_i,point_f)]   	  Meanval = faverageXY(temp2,temp3)   	  if (stringmatch(num2str(Meanval),"nan")==1)   	   print StringFromList(i, waveliststr)   	   abort "nan"   	  endif   	   duplicate/o $StringFromList(i, waveliststr) temp        temp /= abs(Meanval)       duplicate/o temp $StringFromList(i, waveliststr)       endif   endforEndFunction ShowNotebook(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Svar Gotname	Svar Notename  dowindow/f $popStr  Gotname = popStr  Notename = popStrEndFunction MakeNewNote (ctrlName) : ButtonControl	String ctrlName	Svar NewNoteName	string name 		Svar Gotname	Svar Notename	name = NewNoteName + "_R"   dowindow $name	if (v_flag==0)	NewNotebook/W=(30,30,300,300) /F=0/N=$name /V=0	dowindow/f $name	endif	Gotname = name   Notename = nameend	Function GoRootFunc (ctrlName) : ButtonControl	String ctrlName	setdatafolder root:	print "root:"end	Function GodirFunc (ctrlName) : ButtonControl	String ctrlName	Wave wA = CsrWaveRef(A)    String dfA = GetWavesDataFolder(wA, 1)   setdatafolder dfA   print dfA end		Function NoteFontSizeFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName  Svar Notename   Notebook $Notename fsize=(varNum)EndFunction copyG_offset (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Variable i,offs,wavenum	String waveliststr, source	NVAR copyG_offs	offs = 0    waveliststr = TraceNameList("",";",1)    wavenum = ItemsInList(waveliststr) 	 for (i=0 ; i < wavenum ; i+=1) 	   source = StringFromList(i, waveliststr)		//offs += copyG_offs		offs = i*copyG_offs		ModifyGraph offset($source)={0,offs}	endforEndFunction copyG_ValmenuFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr		if ( popnum==1 ) 		SetVariable copyGoffset, limits={-Inf,Inf,0.01}		endif	  if ( popnum==2 ) 		SetVariable copyGoffset, limits={-Inf,Inf,0.1}		endif		if ( popnum==3 ) 		SetVariable copyGoffset, limits={-Inf,Inf,1}		endif	   if ( popnum==4 ) 		SetVariable copyGoffset, limits={-Inf,Inf,10}		endif	   if ( popnum==5 ) 		SetVariable copyGoffset, limits={-Inf,Inf,100}		endif	   if ( popnum==6 ) 		SetVariable copyGoffset, limits={-Inf,Inf,1000}		endif	   if ( popnum==7 ) 		SetVariable copyGoffset, limits={-Inf,Inf,10000}		endifEndFunction Getlabel_refer ()   Svar BottomLabel, LeftLabel   string style, linestr, Ylabelmodify, Xlabelmodify, rawLabel   variable lineNum, i, j, lineleng, itemNum   Svar stringstr   style = WinRecreation(winname(0,1),1)   lineNum = ItemsInList(style, "\r")   Xlabelmodify = ""   Ylabelmodify =""      if (stringmatch(style,"*Label/Z left*")==1)           lineNum = ItemsInList (TraceInfo("", "as4036_29", 0),";")   	for (i=0 ; i < lineNum ; i+=1)   	   linestr =	 StringFromList(i, style)   	   if (stringmatch(linestr,"*Label/Z left*") == 1)   	      rawLabel =  linestr[strlen("Label/Z left ")+2,strlen(linestr)-2]             Ylabelmodify=""             itemNum = ItemsInList(rawLabel, "\\\\")             Ylabelmodify+=StringFromList(0, rawLabel,"\\\\")               for (j=1 ; j<itemnum ; j+=1)                       if (stringmatch(StringFromList(j, rawLabel,"\\\\"), "")!=1)                  Ylabelmodify+="\\"+StringFromList(j, rawLabel,"\\\\")                 endif               endfor   	   endif       endfor    endif    if (stringmatch(style,"*swapXY=1*")==1)                  BottomLabel = Ylabelmodify      else                  LeftLabel = Ylabelmodify               endif       if (stringmatch(style,"*Label/Z Bottom*")==1)	     for (i=0 ; i < lineNum ; i+=1)           linestr =	 StringFromList(i, style, "\r")   	   if (stringmatch(linestr,"*Label/Z bottom*") == 1)   	      rawLabel =  linestr[strlen("Label/Z Bottom ")+2,strlen(linestr)-2]              Xlabelmodify=""              itemNum = ItemsInList(rawLabel, "\\\\")            Xlabelmodify+=StringFromList(0, rawLabel,"\\\\")               for (j=1; j<itemnum ; j+=1)                 if (stringmatch(StringFromList(j, rawLabel,"\\\\"), "")!=1)                Xlabelmodify+="\\"+StringFromList(j, rawLabel,"\\\\")                 endif               endfor   	   endif   	endfor      endif    if (stringmatch(style,"*swapXY=1*")==1)         LeftLabel = Xlabelmodify    else         BottomLabel = Xlabelmodify   endifendFunction copyGfunc (ctrlName) : ButtonControl	String ctrlName	string waveliststr, Xwave, Ywave 	variable Meanval, i,j, pieceNum, wavenum	string statement, copyName, source, TraceInformation, pieceStr, color	silent 1 ; pauseupdate    statement = WinRecreation(winname(0,1),0)    execute statement     waveliststr = TraceNameList("",";",1)    wavenum = ItemsInList(waveliststr) 	 for (i=0 ; i < wavenum ; i+=1) 	   source = StringFromList(i, waveliststr)	   Xwave = XWaveName("",source)	   copyName = source + "_copy"	   duplicate/o $source $copyName	    if (stringmatch(Xwave,"")==1)        appendtograph $copyName     else         appendtograph $copyName vs $Xwave     endif 	   TraceInformation =  TraceInfo("", source, 0)	   pieceNum = ItemsInList (TraceInformation,";")      	for (j=0 ; j < pieceNum ; j+=1)   	   pieceStr =	StringFromList(j, TraceInformation)   	   if (stringmatch(pieceStr,"rgb(x)=*") == 1)   	      color =  "ModifyGraph " + "rgb(" + copyName + ")=" + pieceStr[strlen("rgb(x)="),strlen(pieceStr)-1]   	       execute color         endif          endfor                    removefromgraph $source        endfor   SetDrawEnv fsize= 20   	DrawText 0.0493601462522848,0.134529147982063,"copy"EndFunction sameGfunc (ctrlName) : ButtonControl	String ctrlNamestring statementstatement = WinRecreation(winname(0,1),0)execute statementend Function YcsrBFunc (ctrlName) : ButtonControl	String ctrlNameprint "YcsrB:",CsrWave(b)end Function XcsrBFunc (ctrlName) : ButtonControl	String ctrlNameprint "XcsrB:",CsrXWave(b)end Function YcsrAFunc (ctrlName) : ButtonControl	String ctrlNameprint "YcsrA:",CsrWave(a)end Function XcsrAFunc (ctrlName) : ButtonControl	String ctrlNameprint "XcsrA:",CsrXWave(a)end Function ScientShowFunc (ctrlName) : ButtonControl	String ctrlName  DisplayProcedure  "autograph"EndFunction RegFunc (ctrlName) : ButtonControl	String ctrlName	string topwinname, RegiName	svar GotName   topwinname = StringFromList(0,WinList("*", ";","WIN:23"))      if (stringmatch(topwinname,GotName)!=1)   abort "Get window name first!!"   endif   if (stringmatch(topwinname[strlen(topwinname)-2,strlen(topwinname)-1],"_R")!=1)	RegiName =topwinname+"_R"	renamewindow $topwinname $RegiName	GotName = RegiName	endifEndFunction ClearFunc (ctrlName) : ButtonControl	String ctrlName	string topwinname, RegiName	svar GotName   topwinname = StringFromList(0,WinList("*", ";","WIN:7"))   if (stringmatch(topwinname,GotName)!=1)   abort "Get window name first!!"   endif   if (stringmatch(topwinname[strlen(topwinname)-2,strlen(topwinname)-1],"_R")==1)	 RegiName = topwinname[0,strlen(topwinname)-3]	renamewindow $topwinname $RegiName	GotName = RegiName	endifEndFunction GetNameFunc (ctrlName) : ButtonControl	String ctrlName  Svar Gotname  Gotname = StringFromList(0,WinList("*", ";","WIN:23"))EndFunction Renamewinfunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string RegiName, topwinname   topwinname = StringFromList(0,WinList("*", ";","WIN:23"))	RegiName = varStr	renamewindow $topwinname $RegiNameEndFunction showTable(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Svar Gotname  dowindow/f $popStr   Gotname = popStrEndFunction showLayout(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Svar Gotname  dowindow/f $popStr  Gotname = popStrEndFunction ShowGraph(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Svar Gotname  dowindow/f $popStr  Gotname = popStrEnd////////////////////////////////////////////////////		Tight bindig procedures 						///////////////////////////////////////////////////Window Tight_Binding() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(546,467,991,753)	SetDrawLayer UserBack	DrawRect 7,4,436,273	DrawText 205,45,"1"	DrawText 191,67,"c1[cos(kx)+(1+d1)cos(ky)]/2"	DrawText 191,86,"c2[cos(kx)cos(ky)]"	DrawText 191,108,"c3[cos(2kx)+(1+d3)cos(2ky)]/2"	DrawText 191,128,"c4[cos(2kx)cos(ky)+(1+d4)cos(kx)cos(2ky)]/2"	DrawText 191,148,"c5[cos(2kx)cos(2ky)]"	DrawText 191,169,"c6[cos(3kx)+(1+d6)cos(3ky)]/2"	SetDrawEnv linethick= 2	DrawLine 16,174,405,174	DrawLine 138,179,138,269	DrawLine 230,179,230,239	DrawLine 144,243,329,243	DrawLine 333,179,333,265	SetVariable setvar0,pos={100,32},size={87,15},proc=BandCalc,title="C0"	SetVariable setvar0,limits={-inf,inf,0.01},value= bt0	SetVariable setvar1,pos={101,52},size={87,15},proc=BandCalc,title="C1"	SetVariable setvar1,limits={-inf,inf,0.01},value= bt1	SetVariable setvar2,pos={101,72},size={86,15},proc=BandCalc,title="C2"	SetVariable setvar2,limits={-inf,inf,0.01},value= bt2	SetVariable setvar3,pos={101,92},size={86,15},proc=BandCalc,title="C3"	SetVariable setvar3,limits={-inf,inf,0.01},value= bt3	SetVariable setvar4,pos={101,113},size={86,15},proc=BandCalc,title="C4"	SetVariable setvar4,limits={-inf,inf,0.01},value= bt4	SetVariable setvar5,pos={101,134},size={86,15},proc=BandCalc,title="C5"	SetVariable setvar5,limits={-inf,inf,0.01},value= bt5	Button button0,pos={61,7},size={44,20},proc=TBinputProc,title="Input"	SetVariable setvar6,pos={19,53},size={73,15},proc=BandCalc,title="d1"	SetVariable setvar6,limits={-inf,inf,0.01},value= d1	SetVariable setvar8,pos={19,94},size={73,15},proc=BandCalc,title="d3"	SetVariable setvar8,limits={-inf,inf,0.01},value= d3	SetVariable setvar9,pos={19,115},size={73,15},proc=BandCalc,title="d4"	SetVariable setvar9,limits={-inf,inf,0.01},value= d4	SetVariable setvar11,pos={19,155},size={73,15},proc=BandCalc,title="d6"	SetVariable setvar11,limits={-inf,inf,0.01},value= d6	SetVariable setvar06,pos={101,155},size={86,15},proc=BandCalc,title="C6"	SetVariable setvar06,limits={-inf,inf,0.01},value= bt6	SetVariable setvar12,pos={322,10},size={33,15},proc=TBsaveNoProc,title=" "	SetVariable setvar12,limits={0,50,1},value= saveNo	Button button2,pos={278,8},size={40,20},proc=TBSaveButtonProc,title="Save"	CheckBox check0,pos={359,10},size={61,14},proc=TBCheckProc,title="AutoLoad"	CheckBox check0,value= 1	Button button6,pos={141,219},size={38,20},proc=Surfproc,title="Surf"	Button button3,pos={42,248},size={53,20},proc=Button_TBcutProc,title="LineCut"	SetVariable setvar7,pos={20,181},size={60,15},proc=SetVar_TBcutProc,title="A: x"	SetVariable setvar7,limits={-inf,inf,0.1},value= Ax	SetVariable setvar08,pos={85,181},size={45,15},proc=SetVar_TBcutProc,title="y"	SetVariable setvar08,limits={-inf,inf,0.1},value= Ay	SetVariable setvar09,pos={85,197},size={45,15},proc=SetVar_TBcutProc,title="y"	SetVariable setvar09,limits={-inf,inf,0.1},value= By	SetVariable setvar10,pos={20,197},size={60,15},proc=SetVar_TBcutProc,title="B: x"	SetVariable setvar10,limits={-inf,inf,0.1},value= Bx	Button button4,pos={10,248},size={27,20},proc=Button_csr,title="csr"	SetVariable setvar13,pos={111,10},size={82,15},proc=TBsizeProc,title="TBsize"	SetVariable setvar13,value= TBsize	PopupMenu BZpopup,pos={341,55},size={84,17},proc=TBcoeffpopupFunc	PopupMenu BZpopup,mode=9,popvalue="TBcoeff8",value= #"\"_none_;\" + WaveList(\"TBcoeff*\",\";\",\"\")"	SetVariable setvar14,pos={147,182},size={75,15},proc=SetVar_Emaxmin,title="E max"	SetVariable setvar14,limits={-inf,inf,0.1},value= TB_Emax	SetVariable setvar15,pos={147,200},size={75,15},proc=SetVar_Emaxmin,title="E min"	SetVariable setvar15,limits={-inf,inf,0.1},value= TB_Emin	Button button7,pos={185,219},size={41,20},proc=SurfScaleproc,title="Scale"	PopupMenu BZpopup1,pos={235,180},size={109,17},proc=TBtracepopupFunc	PopupMenu BZpopup1,mode=8,popvalue="'TBwave=-0.1'",value= #"\"_none_;\" + TraceNameList(\"TB_Econtour\",\";\",2)"	Button button8,pos={235,200},size={48,20},proc=GetpFunc,title="Get p"	SetVariable setvar16,pos={245,223},size={70,15},disable=2,title="p"	SetVariable setvar16,value= p_value	Button button5,pos={11,7},size={44,20},proc=TBshowProc,title="Show"	SetVariable setvar17,pos={20,213},size={60,15},proc=SetVar_TBcutProc,title="C: x"	SetVariable setvar17,limits={-inf,inf,0.1},value= Cx	SetVariable setvar18,pos={85,213},size={45,15},proc=SetVar_TBcutProc,title="y"	SetVariable setvar18,limits={-inf,inf,0.1},value= Cy	SetVariable setvar19,pos={20,230},size={60,15},proc=SetVar_TBcutProc,title="D: x"	SetVariable setvar19,limits={-inf,inf,0.1},value= Dx	SetVariable setvar20,pos={85,230},size={45,15},proc=SetVar_TBcutProc,title="y"	SetVariable setvar20,limits={-inf,inf,0.1},value= Dy	Button button9,pos={151,249},size={48,20},proc=GetDosFunc,title="DOS"	Button button09,pos={289,200},size={39,20},proc=GetAngFunc,title="Ang"	SetVariable setvar07,pos={204,251},size={124,15},proc=SigmavalFunc,title="Sigma (meV)"	SetVariable setvar07,limits={0.001,inf,0.001},value= Sigma	SetVariable setvar21,pos={194,10},size={52,15},proc=Pi_angleFunc,title="Pi"	SetVariable setvar21,limits={1,inf,1},value= PiAngle	SetVariable setvar22,pos={232,30},size={143,15},proc=MemoFunc,title=" memo"	SetVariable setvar22,value= saveNo_memo	Button button03,pos={380,26},size={40,20},proc=MemoListFunc,title="List"	PopupMenu popup0,pos={95,250},size={55,17},proc=CutRangeProc,title=" "	PopupMenu popup0,mode=3,popvalue="A-D",value= #"\"A-B;A-C;A-D\""	SetVariable setvar23,pos={338,177},size={80,15},title=" kx",value= TB_kx	SetVariable setvar24,pos={338,194},size={80,15},title=" ky",value= TB_ky	SetVariable setvar25,pos={338,211},size={80,15},title=" E",value= TB_E	Button button10,pos={385,228},size={44,20},proc=TBplotProc,title="Show"	Button button11,pos={340,250},size={46,20},proc=GoTBfitProc,title="TB fit"	Button button12,pos={342,228},size={36,20},proc=TBEditProc,title="Edit"	PopupMenu popup1,pos={5,31},size={67,17},proc=TBcuprateProc,title=" "	PopupMenu popup1,mode=2,popvalue="LSCO",value= #"\"Bi2212;Bi2201;LSCO;Y124_AB;Y124_BB\""	CheckBox check1,pos={390,253},size={42,14},proc=FourSymCheckProc,title="4sym"	CheckBox check1,value= 1EndMacrofunction TB_function(w,x,y)wave wvariable x,y	nvar bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	variable TBwave	TBwave = w[0]  	TBwave += w[1]*cos(PI*x)/2+w[7]*cos(PI*y)/2	TBwave += w[2]*cos(PI*x)*cos(PI*y)	TBwave += w[3]*cos(2*PI*x)/2+w[8]*cos(2*PI*y)/2	TBwave += w[4]*cos(2*PI*x)*cos(PI*y)/2 + w[9]*cos(PI*x)*cos(2*PI*y)/2	TBwave += w[5]*cos(2*PI*x)*cos(2*PI*y)	TBwave += w[6]*cos(3*PI*x)/2+w[10]*cos(3*PI*y)/2	bt0=w[0] ; bt1=w[1]; bt2=w[2]; bt3=w[3]; bt4=w[4]; bt5=w[5]; bt6=w[6]d1=w[7]/w[1]-1 ; d3=w[8]/w[3]-1; d4=w[9]/w[4]-1; d6=w[10]/w[6]-1return(TBwave)endfunction TB_function_4sym (w,x,y)wave wvariable x,y	nvar bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	variable TBwave	TBwave = w[0]  	TBwave += w[1]*(cos(PI*x)+cos(PI*y))/2	TBwave += w[2]*cos(PI*x)*cos(PI*y)	TBwave += w[3]*(cos(2*PI*x)+cos(2*PI*y))/2	TBwave += w[4]*(cos(2*PI*x)*cos(PI*y) + cos(PI*x)*cos(2*PI*y))/2	TBwave += w[5]*cos(2*PI*x)*cos(2*PI*y)	//TBwave += w[6]*(cos(3*PI*x)+cos(3*PI*y))/2	bt0=w[0] ; bt1=w[1]; bt2=w[2]; bt3=w[3]; bt4=w[4]; bt5=w[5]; bt6=0   d1=0; d3=0; d4=0; d6=0return(TBwave)endProc GoTBfitProc (ctrlName) : ButtonControl	String ctrlName	string TBcoeff = "TBcoeffbegin"	silent 1 ; pauseupdate if (FourSymCheck!=1)	bt0=0.1305; bt1=-0.5951; bt2=0.1636; bt3=-0.0519; bt4=-0.1117; bt5=0.0510 ; bt6=0	d1=0; d2=0; d3=0; d4=0; d5=0; d6=0	make/o/n=(11) $TBcoeff 	$TBcoeff = {bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d3,d4,d6}	FuncFit TB_function $TBcoeff $TB_E /X={$TB_kx,$TB_ky} endif if (FourSymCheck==1)   bt0=0.1305; bt1=-0.5951; bt2=0.1636; bt3=-0.0519; bt4=-0.1117; bt5=0.0510   make/o/n=(6) $TBcoeff 	$TBcoeff = {bt0,bt1,bt2,bt3,bt4,bt5}	FuncFit TB_function_4sym $TBcoeff $TB_E /X={$TB_kx,$TB_ky} endif	TB()end	Function FourSymCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar FourSymCheckFourSymCheck = checkedEndProc TBcuprateProc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr  if (popNum==1)    Bi2212_norman ()   endif   if (popNum==2)    Bi2201_kondo ()   endif   if (popNum==3)    LSCO_yoshida ()   endif  if (popNum==4)    Y124_AB_kaminski ()  endif  if (popNum==5)    Y124_BB_kaminski ()  endif  	TB()	  TBcutProc ()	  MakeCopyOfTrace("TB_Econtour","'TBwave=0'")End	Function Bi2212_norman () 	String ctrlName  NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	bt0=0.1305; bt1=-0.5951; bt2=0.1636; bt3=-0.0519; bt4=-0.1117; bt5=0.0510 ; bt6=0	d1=0; d3=0; d4=0; d6=0EndFunction Bi2201_Kondo () 	String ctrlName  NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	bt0=0.258; bt1=-0.9219; bt2=0.195; bt3=-0.1356; bt4=-0.022; bt5=0.03382 ; bt6=0	d1=0; d3=0; d4=0; d6=0EndFunction LSCO_yoshida () 	String ctrlName  NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6  variable ee, tt, tt1, tt2  tt=0.25 ; tt1=tt*(-0.15) ; ee = tt*0.81 ; tt2=-0.5*tt1	bt0=ee ; bt1=-4*tt; bt2=-4*tt1; bt3=-4*tt2; bt4=0; bt5=0 ; bt6=0	d1=0; d3=0; d4=0; d6=0EndFunction Y124_AB_kaminski () 	String ctrlName  NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	bt0=0.241701; bt1=-0.582033; bt2=0.188719; bt3=-0.0550626; bt4=-0.022524; bt5=-0.00708416 ; bt6=-0.0185997	d1=0.029203; d3=-0.0726892; d4=-0.299679; d6=0.334293EndFunction Y124_BB_kaminski () 	String ctrlName  NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	bt0=0.0999555; bt1=-0.66543; bt2=0.166037; bt3=-0.102164; bt4=-0.107509; bt5=-0.00928805 ; bt6=-0.0549447	d1=-0.00173055; d3=-0.0715575; d4=0.350043; d6=-0.0562981End    proc TBEditProc (ctrlName) : ButtonControl	String ctrlName	string panelname = "TBedit"	string waveliststr	dowindow/f $panelname	if (v_flag == 1)	waveliststr = wavelist("*",";","win:")	remove $stringfromlist (0,waveliststr)	remove $stringfromlist (1,waveliststr)	remove $stringfromlist (2,waveliststr)	appendtotable $TB_kx,$TB_ky,$TB_E	endif	if (v_flag!=1)	edit $TB_kx,$TB_ky,$TB_E	dowindow/c $panelname	endifendproc TBplotProc (ctrlName) : ButtonControl	String ctrlName	string panelname = "TBplot"	dowindow/f $panelname	if (v_flag==1)	ModifySurfer srcType=4,srcWave=($TB_kx,$TB_ky,$TB_E)	endif	if (v_flag!=1)	CreateSurfer/N = TBplot	ModifySurfer srcType=4,srcWave=($TB_kx,$TB_ky,$TB_E)   //MoveWindow 331,234,828,599 	ModifySurfer  FactoryDefaults, Update=0	ModifySurfer/N=TBplot	ModifySurfer  srcType=4,plotType=5	ModifySurfer  setControlView=2	ModifySurfer  theta=15.4,  phi=52.5,  zScale=1,  xStep=1,  yStep=1	ModifySurfer  frame=32767,  drawFrame=1	ModifySurfer  axisLabelUnits=8	ModifySurfer  drawTicks=5	ModifySurfer  tickLabelSize=14	ModifySurfer tickLabelFont="Times"	ModifySurfer  noTicksX=0,  noTicksY=0,  noTicksZ=0	//ModifySurfer backRGB={65535,65535,65535}	//ModifySurfer palette=Rainbow	ModifySurfer  reverseColorMap=1	//ModifySurfer markerRGB={65535,0,0}	ModifySurfer  highTripX=1000	ModifySurfer  lowTripX=-200,  lowTripZ=300	ModifySurfer  markerSize=2	ModifySurfer  secondaryMode=1	ModifySurfer  Update=1	endifend	Function CutRangeProc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Nvar CutRangeNum  if (popNum==1)    CutRangeNum = 1  elseif (popNum==2)    CutRangeNum = 2  elseif (popNum==3)    CutRangeNum = 3  endif  execute "TBcutProc ()"Endproc TBcutProc ()	variable i	variable distanceAB, distanceBC, distanceCD	variable Axy, Bxy, XX, YY,    string cutwave="TBcut"   variable Mapsize, CutsizeAB, CutsizeBC, CutsizeCD   variable MaxTB, MinTB   silent 1 ; pauseupdate   wavestats/q TBwave   MaxTB = V_max   MinTB = V_min   distanceAB = sqrt((Ax-Bx)^2+(Ay-By)^2)   distanceBC = sqrt((Bx-Cx)^2+(By-Cy)^2)   distanceCD = sqrt((Cx-Dx)^2+(Cy-Dy)^2)   Mapsize = TBsize/2   CutsizeAB = round(Mapsize*distanceAB)   CutsizeBC = round(Mapsize*distanceBC)   CutsizeCD = round(Mapsize*distanceCD)   if (CutsizeAB+CutsizeBC+CutsizeCD==0)       return -1   endif  i=0   make/o/n=(CutsizeAB) $cutwave        SetScale/I x 0,distanceAB,"", $cutwave   do      XX=Ax+(Bx-Ax)/(CutsizeAB-1)*i     YY=Ay+(By-Ay)/(CutsizeAB-1)*i     $cutwave[i] = TBwave(XX)(YY)      i+=1    while (i< CutsizeAB)   if (CutRangeNum == 1)    Smooth 3, $cutwave    make/o/n=2 Line1x, Line1y, Line2x, Line2y    Line1y[] =nan ; Line2y[] = nan    Line1x[] = nan ; Line2x[] = nan    return -1   endif i=0   Redimension/N=(CutsizeAB+CutsizeBC) $cutwave       SetScale/I x 0,distanceAB+distanceBC,"", $cutwave   do    XX=Bx+(Cx-Bx)/(CutsizeBC-1)*i   YY=By+(Cy-By)/(CutsizeBC-1)*i   $cutwave[CutsizeAB+i] = TBwave(XX)(YY)    i+=1    while (i< CutsizeBC)   if (CutRangeNum == 2)    Smooth 3, $cutwave     make/o/n=2 Line1x, Line1y, Line2x, Line2y    Line1y[] = {MinTB, MaxTB} ; Line2y[] = {MinTB, MaxTB}    Line1x[] = distanceAB ; Line2x[] = distanceAB     return -1   endif i=0 Redimension/N=(CutsizeAB+CutsizeBC+CutsizeCD) $cutwave         SetScale/I x 0,distanceAB+distanceBC+distanceCD,"", $cutwave   do    XX=Cx+(Dx-Cx)/(CutsizeCD-1)*i   YY=Cy+(Dy-Cy)/(CutsizeCD-1)*i   $cutwave[CutsizeAB+CutsizeBC+i] = TBwave(XX)(YY)    i+=1    while (i< CutsizeCD)   if (CutRangeNum == 3)     Smooth 3, $cutwave     make/o/n=2 Line1x, Line1y, Line2x, Line2y     Line1y[] = {MinTB, MaxTB} ; Line2y[] = {MinTB, MaxTB}      Line1x[] = distanceAB ; Line2x[] = distanceAB + distanceBC   return -1   endifEndproc Button_TBcutProc (ctrlName) : ButtonControl	String ctrlName	string cutwave="TBcut"	string panelname="TBline" 	variable MaxTB, MinTB	silent 1 ; pauseupdate	wavestats/q TBwave   MaxTB = V_max   MinTB = V_min   //make/o/n=2 Line1x, Line1y, Line2x, Line2y   //Line1x = nan; Line1y = nan; Line2x = nan; Line2y = nan	TBcutProc ()	 dowindow/f $panelname   if (v_flag!=1)   display/W=(525,230,837,484) $cutwave   //make/o/n=2 Line1x, Line1y, Line2x, Line2y   appendtograph Line1y vs Line1x   appendtograph Line2y vs Line2x   ModifyGraph lstyle(Line1y)=0,rgb(Line1y)=(0,0,0)   ModifyGraph lstyle(Line2y)=0,rgb(Line2y)=(0,0,0)   dowindow/c $panelname	ModifyGraph tick=2	ModifyGraph zero(left)=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-2.28571,axOffset(bottom)=-0.466667	Label left "Energy (eV)"	Label bottom "\\f02k\\B\\M\\f00 / \\F'Symbol'p"   endif  SetAxis left MinTB,MaxTB  //SetAxis/AendFunction MemoListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "MemoList"	wave/t memoT	dowindow/f $panelname	if (v_flag!=1)	edit memoT	dowindow/c $panelname	endifend		proc TBsaveNoProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string TBcoeff	silent 1 ; pauseupdate	saveNo = varNum	if (TBsavecheck)	TBcoeff="TBcoeff"+num2istr(saveNo)   saveNo_memo = memoT[saveNo]	 duplicate/o $TBcoeff temp0	bt0=temp0[0]; bt1=temp0[1]; bt2=temp0[2]; bt3=temp0[3]; bt4=temp0[4]; bt5=temp0[5]; bt6=temp0[6]	d1=temp0[7]	d3=temp0[8]	d4=temp0[9]	d6=temp0[10]	TB ()	TBcutProc ()	endifEndFunction Pi_angleFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar PiAngle  PiAngle = varNum  SetScale/I x (PiAngle*(-1)),PiAngle,"", TBwave;DelayUpdate  SetScale/I y (PiAngle*(-1)),PiAngle,"", TBwaveend   Function MemoFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	svar saveNo_memo   NVAR saveNo   string TBcoeff   saveNo_memo = varStrEndFunction TBSaveButtonProc (ctrlName) : ButtonControl	String ctrlName   NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6, saveNo   string TBcoeff   wave/t memoT   svar saveNo_memo   TBcoeff="TBcoeff"+num2istr(saveNo)   make/o/n=13 $TBcoeff   duplicate/o $TBcoeff temp0   temp0 = {bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d3,d4,d6}   duplicate/o temp0 $TBcoeff   memoT[saveNo] = saveNo_memoEnd	Function GetpFunc (ctrlName) : ButtonControl	String ctrlName	wave traceY, traceX, temp1, temp2	variable i, j=0, Initialangle, Finalangle	Nvar piangle	make/o/n=0 temp1,temp2   for (i=0 ;i<numpnts(traceY) ;i+=1)     if (traceY[i]>0 && traceX[i]>0)      j+=1      Redimension/N=(j+2) temp1,temp2      temp1[j]=traceX[i]      temp2[j]=traceY[i]     endif   endfor   Initialangle = atan(temp2[1]/temp1[1])/pi*180   Finalangle = atan(temp2[j]/temp1[j])/pi*180   if (min(Initialangle,Finalangle)>0.1)      if (Finalangle>Initialangle)      temp1[0]=piangle ; temp2[0]=0      else      temp1[j+1]=piangle ; temp2[j+1]=0      endif   endif   if (max(Initialangle,Finalangle)<(90-0.1))      if (Finalangle>Initialangle)      temp1[j+1]=0 ; temp2[j+1]=piangle      else      temp1[0]=0 ; temp2[0]=piangle      endif  endif   Area_SF(temp1,temp2)end	Function GetAngFunc (ctrlName) : ButtonControl	String ctrlName	string result = "FSangle", panelname="FSangleInfo"	variable minP=0,maxP=0, i, j	wave traceY, traceX	Nvar piangle		make/o/n=0 temp1,temp2   for (i=0 ;i<numpnts(traceY) ;i+=1)     if (traceY[i]>0 && traceX[i]>0)       if (minP==0)         minP = i       endif      j+=1      Redimension/N=(j) temp1,temp2      temp1[j-1]=traceX[i]      temp2[j-1]=traceY[i]     endif   endfor   duplicate/o temp1 temp3 temp3[]=atan((piangle-temp1[p])/(piangle-temp2[p]))*180/pi   duplicate/o temp3 $result   maxP = minP + (j-1)   SetScale/I x minP,maxP,"",  $result   dowindow/f $panelname   if (v_flag!=1)   Display /W=(318,147,723,471) $result	ModifyGraph tick=2	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.625,axOffset(bottom)=-0.25	Label left "Angle (deg)"	Label bottom "Point No."	dowindow/c $panelname	endif Endmacro		Function SigmavalFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varNameend Function GetDosFunc (ctrlName) : ButtonControl	String ctrlName	wave DOS	string panelname="DOS_of_TBwave"	make_DOS ()	dowindow/f $panelname	if (v_flag!=1)	Display /W=(338,124,822,407) DOS	ModifyGraph tick=2	ModifyGraph zero(bottom)=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-1.25,axOffset(bottom)=-0.375	Label left "DOS"	Label bottom "Energy (eV)"   dowindow/c $panelname  endifendFunction make_DOS ()wave TBwave, DOSNvar TBsize, sigma, RestNovariable x0, DOSmax, DOSmin, i, j, TBhalfsize, C, AreaDOSTBhalfsize = round((TBsize-1)/2)   make/o/n=(TBsize*5) DOS	wavestats/q TBwave   DOSmax = V_max+0.3   DOSmin = V_min-0.3   SetScale/I x DOSmin,DOSmax,"",  DOS   duplicate/o DOS temp   DOS=0 for (i=0 ; i< TBhalfsize+1 ; i+=1) for (j=0 ; j< TBhalfsize+1 ; j+=1)  x0 = TBwave[i][j]  temp[]= Gauss_DOS (pnt2x(DOS, p), x0, sigma)  if (pnt2x(TBwave,j)<10^-10 || pnt2x(TBwave,i)<10^-10)    if (pnt2x(TBwave,j)<10^-10 && pnt2x(TBwave,i)<10^-10)           C = 1/4    else           C = 1/2    endif  else          C = 1  endif      DOS[]+=C*temp[p] endfor RestNo = (TBhalfsize)-i print restNoendforAreaDOS = area(DOS,-inf,inf)DOS/=AreaDOS ; DOS*=2EndFunction make_DOS_backup ()wave TBwave, DOSNvar TBsize, sigma, RestNovariable x0, DOSmax, DOSmin, i, jRestNo = TBsize   make/o/n=(TBsize*5) DOS	wavestats/q TBwave   DOSmax = V_max+0.3   DOSmin = V_min-0.3   SetScale/I x DOSmin,DOSmax,"",  DOS   duplicate/o DOS temp   DOS=0for (i=0 ; i< TBsize ; i+=1) for (j=0 ; j< TBsize ; j+=1)  x0 = TBwave[i][j]  temp[]= Gauss_DOS (pnt2x(DOS, p), x0, sigma)  DOS[]+=temp[p] endfor RestNo = TBsize-1-i print restNoendforEndFunction Gauss_DOS (x, x0, sigma)variable x, x0, sigmavariable GG = (1/(sigma)*pi^0.5)*exp(-((x-x0)/(sigma))^2)return (G)endFunction TBinputProc(ctrlName) : ButtonControl	String ctrlName	string panelname	panelname = "TB_Econtour"TB()EndFunction TBshowProc(ctrlName) : ButtonControl	String ctrlName	string panelname	panelname = "TB_Econtour"dowindow/f $panelnameif (v_flag!=1)TB()Display;AppendMatrixContour TBwaveModifyContour TBwave ctabLines={*,*,Rainbow,1}ModifyContour TBwave autoLevels={*,*,20}, labels=0	ModifyGraph height={Aspect,1}	ModifyGraph lSize('TBwave=0')=2	ModifyGraph rgb('TBwave=0')=(65535,0,0)	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-1.75,axOffset(bottom)=-0.375	Label left "\\f02k\\By\\M\\f00 / \\F'Symbol'p"	Label bottom "\\f02k\\Bx\\M\\f00 / \\F'Symbol'p"dowindow/c $panelnameendifEndFunction Area_SF(temp1,temp2)  wave temp1,temp2  nvar p_value, piangle // string Xwave="fit_kx_a",Ywave="fit_ky_a"  variable Xa,Ya,Xb,Yb,Area_Quarter,Area_part,Windex,waveNum  variable Area_all  waveNum=numpnts(temp1)Silent 1; PauseUpdate  do    Xa=temp1[Windex]    Ya=temp2[Windex]    Xb=temp1[Windex+1]    Yb=temp2[Windex+1]    Area_part=(Xa*Yb-Ya*Xb)/2    Area_Quarter+=Area_part    Windex+=1  while(Windex+1<waveNum)  Area_all=abs(Area_Quarter*4)  p_value = 2*((2*piangle)^2-Area_all)/(2*piangle)^2-1endMacroFunction TBtracepopupFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	wave traceY, traceX	string panelname="EnergContour"	Nvar PiAngleMakeCopyOfTrace("TB_Econtour",popStr)dowindow/f $panelnameif (v_flag==1)  SetAxis left  (PiAngle*(-1)),PiAngle ;DelayUpdate   SetAxis bottom  (PiAngle*(-1)),PiAngleendifif(v_flag!=1)	PauseUpdate; Silent 1		// building window...	Display /W=(336,186,650,473) traceY vs traceX	ModifyGraph height={Aspect,1}	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-1.625	Label left "\\f02k\\By\\M\\f00 / \\F'Symbol'p"	Label bottom "\\f02k\\Bx\\M\\f00 / \\F'Symbol'p"	SetAxis left  (PiAngle*(-1)),PiAngle ;DelayUpdate   SetAxis bottom  (PiAngle*(-1)),PiAngledowindow/c $panelnameendifEndFunction CopyContourTrace()String traceNamePrompt traceName,"contour trace",popup,TraceNameList("",";",2)Doprompt "Get contour trace", traceNameMakeCopyOfTrace("",traceName)Print traceName, " copied to waves traceX and traceY"EndFunction MakeCopyOfTrace(graphNameStr,traceNameStr)String graphNameStr,traceNameStrWave w= TraceNameToWaveRef(graphNameStr,traceNameStr)Make/O/N=(numpnts(w)) traceYtraceY= wWave w= XWaveRefFromTrace(graphNameStr,traceNameStr)Make/O/N=(numpnts(w)) traceXtraceX= wwavestats/Q traceYtraceY[0, V_npnts/4-1]=traceY[p]+2traceX[0,V_npnts/4-1]=traceX[p]+2traceX[V_npnts/4+1,2*V_npnts/4]=traceX[p]+2traceY[3*V_npnts/4+3, ]=traceY[p]+2Endproc GetTraceproc (ctrlName) : ButtonControl	String ctrlName  EmaxminFunc ()end	proc SurfScaleproc (ctrlName) : ButtonControl	String ctrlName  EmaxminFunc ()end	proc SetVar_Emaxmin (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	//EmaxminFunc ()end proc EmaxminFunc ()	string panelname="TightBinding"	 dowindow $panelname	if (stringmatch(WinName(0,4096),"TightBinding")!=1)	  dowindow/f $panelname	endif		if (v_flag==1)		ModifySurfer zmin=TB_Emin,  zmax=TB_Emax	endifendproc SetVar_TBcutProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	TBcutProc ()endFunction TBcoeffpopupFunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar bzname	string panelname="TBcoeff"	string strwave = "coeffInfo"	wave/t tempT	if (stringmatch(popStr,"_none_")) 	bzname=""  return -1// User canceled   endif   make/t/o/n=(numpnts($popStr)) $strwave  	duplicate/t/o $strwave tempT  	tempT = {"bt0","bt1","bt2","bt3","bt4","bt5","bt6","d1","d3","d4","d6"}  	duplicate/t/o tempT  $strwave	dowindow/k $panelname	edit/W=(50,50,350,300) $strwave 	appendtotable $popStr	dowindow/c $panelname	bzname=popStrEndproc TBsizeProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string panelname	silent 1 ; pauseupdate 	TBsize = varNum	panelname="TightBinding"	dowindow $panelname		if (v_flag==1)	ModifySurfer xStep=(TBsize/20),  yStep=(TBsize/20)	endif	TB()	panelname="TBline"	dowindow $panelname	if (v_flag==1)	TBcutProc ()	endifendFunction Button_csr (ctrlName) : ButtonControl	String ctrlName	NVAR Ax, Ay, Bx, By	if (stringmatch(CsrWave(a),"")==1 || stringmatch(CsrWave(b),"")==1)	abort "set cursor a and b."	else	Ax = hcsr(a)	Ay = vcsr(a)   Bx = hcsr(b)	By = vcsr(b)	endifend		Proc Surfproc (ctrlName) : ButtonControl	String ctrlName	variable fwave,lwave	string panelname = "TightBinding"	silent 1 ; pauseupdate 	if (Piangle==0)	  abort "Input Pi value!!"	endif	dowindow/f $panelname	if (v_flag!=1)	CreateSurfer/N = TightBinding	MoveWindow 295,456,832,889 	ModifySurfer  FactoryDefaults, Update=0	ModifySurfer/N=TightBinding	ModifySurfer srcWave=root:TBwave	ModifySurfer  srcType=1,plotType=3	ModifySurfer  setControlView=2	ModifySurfer  theta=21.4,  phi=40.1,  zScale=1,  xStep=TBsize/20,  yStep=TBsize/20	ModifySurfer  frame=28671,  drawFrame=1	ModifySurfer  axisLabelUnits=8	ModifySurfer  drawTicks=5	ModifySurfer  tickLabelSize=16	ModifySurfer tickLabelFont="Times"	ModifySurfer  noTicksX=0,  noTicksY=0,  noTicksZ=0	ModifySurfer backRGB={65535,65535,65535}	ModifySurfer palette=Rainbow	ModifySurfer  reverseColorMap=1	ModifySurfer  highTripX=1000	ModifySurfer  lowTripX=-200,  lowTripZ=300	ModifySurfer  numContourLevels=10,  contour=2049	ModifySurfer  secondaryMode=1	ModifySurfer  Update=1	endifEndFunction TB()	NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	Nvar TBsize, PiAngle	variable kpi   make /o/n=(TBsize,TBsize) TBwave	SetScale/I x (PiAngle*(-1)),PiAngle,TBwave	SetScale/I y (PiAngle*(-1)),PiAngle,TBwave	kpi=pi/PiAngle	TBwave = bt0  	TBwave += bt1*(cos(kpi*x)+(1+d1)*cos(kpi*y))/2	TBwave += bt2*cos(kpi*x)*cos(kpi*y)	TBwave += bt3*(cos(2*kpi*x)+(1+d3)*cos(2*kpi*y))/2	TBwave += bt4*(cos(2*kpi*x)*cos(kpi*y) + (1+d4)*cos(kpi*x)*cos(2*kpi*y) )/2	TBwave += bt5*cos(2*kpi*x)*cos(2*kpi*y)	TBwave += bt6*(cos(3*kpi*x)+(1+d6)*cos(3*kpi*y))/2endFunction TBCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar TBsavecheckTBsavecheck = checkedEndFunction BandCalc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	TB ()end////////////////////////////////////////////////////		FS adjustment procedures 						///////////////////////////////////////////////////Function GetPhiFunc (ctrlName) : ButtonControl	String ctrlName	string waveliststr	wave Rotaky_a1,Rotakx_a1, PhiA	svar kywaveRota	nvar piangle	variable i, checkA=0	if (stringmatch(kywaveRota,"")!=1) 	  duplicate/o Rotaky_a1 PhiA     PhiA[]=atan((piangle- abs(Rotakx_a1[p]))/(piangle-abs(Rotaky_a1[p])))*180/pi     checkA=1    endif   dowindow/f PhiWave  if (V_flag==1)     	waveliststr = wavelist("*",";","win:")	 if (stringmatch(StringFromList(0, waveliststr),"")!=1)	   for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveFromTable $StringFromList(i, waveliststr)      	endfor   	  if (checkA==1)   	  appendtotable PhiA   	  endif   endif  else     edit        if (checkA==1)   	  appendtotable PhiA   	  endif    dowindow/c PhiWave   endifend			Function AutoRotaCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar RotaChecked	RotaChecked = checkedEndProc RotaPlotfunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName//	Nvar RotaChecked	if (RotaChecked==1)   //RotaAllFunc ()   RotaEulerAngle ()   endifEndFunction RotaKxMakeFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	svar kxwaveRotaEndProc FSshowFunc (ctrlName) : ButtonControl	String ctrlName 	dowindow/f RotatedMapping	if (v_flag==1)	  if ( stringmatch(wavelist("Rotaky_a1",";","win:"),"")==1 && stringmatch(kywaveRota,"")!=1)        appendtograph Rotaky_a1 vs Rotakx_a1	  		ModifyGraph mode(Rotaky_a1)=4,marker(Rotaky_a1)=19,rgb(Rotaky_a1)=(65535,0,52428), msize(Rotaky_a1)=3	  	endif   endifendProc FSplotRota (ctrlName) : ButtonControl	String ctrlName	     //RotaAllFunc ()	     RotaEulerAngle ()end			Proc RotaEulerAngle () silent 1 ; pauseupdate    if (stringmatch(kywaveRota,"")!=1)	   duplicate/o  $kywaveRota Rotaky_a1, Rotaky_b1, Rotakx_c1, Rotakx_d1	   duplicate/o $kywaveRota temp      temp[]=p      duplicate/o temp $"RotaKxNum"	   if (stringmatch(kxwaverota,"")!=1)  		 duplicate/o  $kxwaverota Rotakx_a1, Rotakx_b1, Rotakx_c1, Rotakx_d1  		 //print "A"  		 else  		 duplicate/o  RotaKxNum Rotakx_a1, Rotakx_b1, Rotakx_c1, Rotakx_d1  		 //print "B"  		 endif   	endif    Rota_XspacingFunc ()    Rota_scaleFunc ()     Rota_EulerRotaFunc ()      Rota_oneFunc ()endFunction Rota_EulerRotaFunc ()wave Rotaky_a1, Rotakx_a1Nvar offpsi,offphi,offtheta,MapRotaPiangle,SliceAnglevariable Psi,Phi,Theta,i,termX2,termX3,termY2,termY3variable sizeX,sizeY,maxXYsize,dX,dY,firstY,midYSvar kywaveRotastring baseMatSvar UseparaFSMapstrbaseMat=UseparaFSMapstrsizeY=dimsize($baseMat,1) dY = SliceAngle*DimDelta($baseMat,1) firstY = DimOffset($baseMat,1)midY= firstY+dy*(sizeY-1)/2Psi=offpsi*(pi/180)Phi=-offphi*(pi/180)  if (stringmatch(kywaveRota,"")!=1)	duplicate/o Rotaky_a1 Ywave1,Zwave1,Twave1,x2wave1,y2wave1	Rotaky_a1[] -= midY	Ywave1[] = sin(Rotaky_a1[p]*pi/180) / sin(MapRotaPiangle*pi/180)	Zwave1[] = cos(Rotaky_a1[p]*pi/180) / sin(MapRotaPiangle*pi/180)	Twave1[] = Rotakx_a1[p]+offtheta	for (i=0 ; i<=numpnts(Rotaky_a1) ; i+=1)		Theta = Twave1[i]*(pi/180)		termX2=cos(Psi)*sin(Theta)+cos(Phi)*cos(Theta)*sin(Psi)		termX3=sin(Psi)*sin(Phi)		termY2=-sin(Phi)*cos(Theta)		termY3=cos(Phi)		x2wave1[i] = termX2*Zwave1[i]+termX3*Ywave1[i]		y2wave1[i] = termY2*Zwave1[i]+termY3*Ywave1[i]	endfor	duplicate/o y2wave1 Rotaky_a1	duplicate/o x2wave1 Rotakx_a1endifendProc RotaAllFunc () silent 1 ; pauseupdate    if (stringmatch(kyAwaveRota,"")!=1)	   duplicate/o  $kyAwaveRota Rotaky_a1, Rotaky_b1, Rotakx_c1, Rotakx_d1  		 duplicate/o  RotaKxA Rotakx_a1, Rotakx_b1, Rotakx_c1, Rotakx_d1  	endif  	if (stringmatch(kyBwaveRota,"")!=1) 	   duplicate/o  $kyBwaveRota Rotaky_a2, Rotaky_b2, Rotakx_c2, Rotakx_d2  		 duplicate/o  RotaKxB Rotakx_a2, Rotakx_b2, Rotakx_c2, Rotakx_d2  	endif     Rota_XspacingFunc ()    Rota_scaleFunc ()     Rota_offseFunc ()     Rota_moveLine ()    Rota_oneFunc ()    //Rota_4symFunc ()      Rota_ARPEScorr ()    Rota_Piscale ()    endProc showRotaFunc (ctrlName) : ButtonControl	String ctrlName	string panelname="FSadjustment"	silent 1 ; pauseupdate   dowindow/f $panelname   RotaAllFunc ()    if (v_flag!=1) 	RotaAllFunc () 	  Diagonalline () Display /W=(145,114,790,452)  dowindow/c $panelname duplicate/o TBwave TBwave_copy SetScale/I x PiAngle,3*PiAngle,"", TBwave_copy   appendtograph diagonalY vs diagonalX   ModifyGraph rgb(diagonalY)=(0,0,0)   AppendMatrixContour TBwave	ModifyContour TBwave autoLevels={*,*,20}, ctabLines={*,*,Rainbow,1}, labels=0	AppendMatrixContour TBwave_copy	 appendtograph Rotaky_a1 vs Rotakx_a1 appendtograph Rotaky_a2 vs Rotakx_a2	ModifyContour TBwave_copy autoLevels={*,*,20}, ctabLines={*,*,Rainbow,1}, labels=0	ModifyGraph width={Aspect,2}	ModifyGraph mode(Rotaky_a1)=3,mode(Rotaky_a2)=3	ModifyGraph marker(Rotaky_a1)=19,marker(Rotaky_a2)=19	ModifyGraph lSize('TBwave=0')=2,lSize('TBwave_copy=0')=2	ModifyGraph rgb(Rotaky_a1)=(0,0,65535),rgb(Rotaky_a2)=(0,0,65535),rgb('TBwave=0')=(65535,0,0)	ModifyGraph rgb('TBwave_copy=0')=(65535,0,0)	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-3.14286,axOffset(bottom)=-0.8	Label left "Angle (deg)"	Label bottom "Angle (deg)"	endifendFunction AddTBFSfunc (ctrlName) : ButtonControl	String ctrlName 	wave traceY, traceX	  TBshowProc("")	  MakeCopyOfTrace("TB_Econtour","'TBwave=0'")	  dowindow/f RotatedMapping  if (v_flag==1)    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX       appendtograph traceY vs traceX       appendtograph traceY vs traceX     appendtograph traceY vs traceX       appendtograph traceY vs traceX       appendtograph traceY vs traceX       appendtograph traceY vs traceX         	ModifyGraph offset(traceY#1)={2,0},offset(traceY#2)={-2,0},offset(traceY#3)={0,2}, offset(traceY#4)={0,-2}, offset(traceY#5)={2,2},offset(traceY#6)={2,-2}	ModifyGraph offset(traceY#7)={-2,2},offset(traceY#8)={-2,-2}, offset(traceY#9)={-4,0}, offset(traceY#10)={-4,2}, offset(traceY#11)={-4,-2}, offset(traceY#12)={-4,-4}, offset(traceY#13)={-2,-4}	ModifyGraph offset(traceY#14)={0,-4}, offset(traceY#15)={2,-4}	ModifyGraph lsize(traceY)=1.5,lsize(traceY#1)=1.5,lsize(traceY#2)=1.5 	ModifyGraph lsize(traceY#3)=1.5,lsize(traceY#4)=1.5,lsize(traceY#5)=1.5 	ModifyGraph lsize(traceY#6)=1.5,lsize(traceY#7)=1.5,lsize(traceY#8)=1.5	ModifyGraph lsize(traceY#9)=1.5,lsize(traceY#10)=1.5,lsize(traceY#11)=1.5 	ModifyGraph lsize(traceY#12)=1.5,lsize(traceY#13)=1.5,lsize(traceY#14)=1.5 	ModifyGraph lsize(traceY#15)=1.5    //    Diagonalline ()  endifendFunction AddSBFSfunc (ctrlName) : ButtonControl	String ctrlName 	wave traceY, traceX	duplicate/o  traceY SBtraceY	duplicate/o  traceX SBtraceX	  TBshowProc("")	  MakeCopyOfTrace("TB_Econtour","'TBwave=0'")	  dowindow/f RotatedMapping 	 if (v_flag==1)   	 appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	appendtograph SBtraceY vs SBtraceX    	ModifyGraph offset(SBtraceY)={1,1}, offset(SBtraceY#1)={-1,1},offset(SBtraceY#2)={-3,1},offset(SBtraceY#3)={1,-1},offset(SBtraceY#4)={-1,-1},offset(SBtraceY#5)={-3,-1},offset(SBtraceY#6)={1,-3},offset(SBtraceY#7)={-1,-3},offset(SBtraceY#8)={-3,-3}	ModifyGraph rgb(SBtraceY)=(52224,0,41728),rgb(SBtraceY#1)=(52224,0,41728)	ModifyGraph rgb(SBtraceY#2)=(52224,0,41728),rgb(SBtraceY#3)=(52224,0,41728)	ModifyGraph rgb(SBtraceY#4)=(52224,0,41728),rgb(SBtraceY#5)=(52224,0,41728)	ModifyGraph rgb(SBtraceY#6)=(52224,0,41728),rgb(SBtraceY#7)=(52224,0,41728)	ModifyGraph rgb(SBtraceY#8)=(52224,0,41728)	ModifyGraph lstyle(SBtraceY)=2,lstyle(SBtraceY#1)=2,lstyle(SBtraceY#2)=2	ModifyGraph lstyle(SBtraceY#3)=2,lstyle(SBtraceY#4)=2,lstyle(SBtraceY#5)=2	ModifyGraph lstyle(SBtraceY#6)=2,lstyle(SBtraceY#7)=2,lstyle(SBtraceY#8)=2  endifendFunction RMSSFSfunc (ctrlName) : ButtonControl	String ctrlName 	string FSlinelist=TraceNameList("RotatedMapping", ";", 1 )	string tempname	variable n=ItemsInList(FSlinelist)	dowindow/f RotatedMapping	if(V_flag==1)		do		tempname=StringFromList(n,  FSlinelist)		if (stringmatch(tempname, "SS*")==1)		RemoveFromGraph $tempname		endif		n=n-1		while(n>-1)	endifendFunction RMSBFSfunc (ctrlName) : ButtonControl	String ctrlName 	string FSlinelist=TraceNameList("RotatedMapping", ";", 1 )	string tempname	variable n=ItemsInList(FSlinelist)	dowindow/f RotatedMapping	if(V_flag==1)		do		tempname=StringFromList(n,  FSlinelist)		if (stringmatch(tempname, "SB*")==1)		RemoveFromGraph $tempname		endif		n=n-1		while(n>-1)	endifend	Function AddSSFSfunc (ctrlName) : ButtonControl	String ctrlName 	wave traceY, traceX	nvar SSvector	  TBshowProc("")	  MakeCopyOfTrace("TB_Econtour","'TBwave=0'")	  duplicate/o  traceY SSFtraceY	duplicate/o  traceX SSFtraceX	duplicate/o  traceY SSBtraceY	duplicate/o  traceX SSBtraceX 	SSFtraceY=SSFtraceY+SSvector	SSFtraceX=SSFtraceX+SSvector	SSBtraceY=SSBtraceY-SSvector	SSBtraceX=SSBtraceX-SSvector	  dowindow/f RotatedMapping  if (v_flag==1)    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX    appendtograph SSBtraceY vs SSBtraceX       appendtograph SSBtraceY vs SSBtraceX       appendtograph SSBtraceY vs SSBtraceX     appendtograph SSBtraceY vs SSBtraceX       appendtograph SSBtraceY vs SSBtraceX       appendtograph SSBtraceY vs SSBtraceX       appendtograph SSBtraceY vs SSBtraceX         	ModifyGraph offset(SSBtraceY#1)={2,0},offset(SSBtraceY#2)={-2,0},offset(SSBtraceY#3)={0,2}, offset(SSBtraceY#4)={0,-2}, offset(SSBtraceY#5)={2,2},offset(SSBtraceY#6)={2,-2}	ModifyGraph offset(SSBtraceY#7)={-2,2},offset(SSBtraceY#8)={-2,-2}, offset(SSBtraceY#9)={-4,0}, offset(SSBtraceY#10)={-4,2}, offset(SSBtraceY#11)={-4,-2}, offset(SSBtraceY#12)={-4,-4}, offset(SSBtraceY#13)={-2,-4}	ModifyGraph offset(SSBtraceY#14)={0,-4}, offset(SSBtraceY#15)={2,-4}            appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX    appendtograph SSFtraceY vs SSFtraceX       appendtograph SSFtraceY vs SSFtraceX       appendtograph SSFtraceY vs SSFtraceX     appendtograph SSFtraceY vs SSFtraceX       appendtograph SSFtraceY vs SSFtraceX       appendtograph SSFtraceY vs SSFtraceX       appendtograph SSFtraceY vs SSFtraceX         	ModifyGraph offset(SSFtraceY#1)={2,0},offset(SSFtraceY#2)={-2,0},offset(SSFtraceY#3)={0,2}, offset(SSFtraceY#4)={0,-2}, offset(SSFtraceY#5)={2,2},offset(SSFtraceY#6)={2,-2}	ModifyGraph offset(SSFtraceY#7)={-2,2},offset(SSFtraceY#8)={-2,-2}, offset(SSFtraceY#9)={-4,0}, offset(SSFtraceY#10)={-4,2}, offset(SSFtraceY#11)={-4,-2}, offset(SSFtraceY#12)={-4,-4}, offset(SSFtraceY#13)={-2,-4}	ModifyGraph offset(SSFtraceY#14)={0,-4}, offset(SSFtraceY#15)={2,-4}		ModifyGraph lstyle(SSBtraceY)=3,rgb(SSBtraceY)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#1)=3,rgb(SSBtraceY#1)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#2)=3,rgb(SSBtraceY#2)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#3)=3,rgb(SSBtraceY#3)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#4)=3,rgb(SSBtraceY#4)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#5)=3,rgb(SSBtraceY#5)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#6)=3,rgb(SSBtraceY#6)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#7)=3,rgb(SSBtraceY#7)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#8)=3,rgb(SSBtraceY#8)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#9)=3,rgb(SSBtraceY#9)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#10)=3,rgb(SSBtraceY#10)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#11)=3,rgb(SSBtraceY#11)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#12)=3,rgb(SSBtraceY#12)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#13)=3,rgb(SSBtraceY#13)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#14)=3,rgb(SSBtraceY#14)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSBtraceY#15)=3,rgb(SSBtraceY#15)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY)=3,rgb(SSFtraceY)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#1)=3,rgb(SSFtraceY#1)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#2)=3,rgb(SSFtraceY#2)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#3)=3,rgb(SSFtraceY#3)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#4)=3,rgb(SSFtraceY#4)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#5)=3,rgb(SSFtraceY#5)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#6)=3,rgb(SSFtraceY#6)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#7)=3,rgb(SSFtraceY#7)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#8)=3,rgb(SSFtraceY#8)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#9)=3,rgb(SSFtraceY#9)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#10)=3,rgb(SSFtraceY#10)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#11)=3,rgb(SSFtraceY#11)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#12)=3,rgb(SSFtraceY#12)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#13)=3,rgb(SSFtraceY#13)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#14)=3,rgb(SSFtraceY#14)=(39168,39168,0);DelayUpdateModifyGraph lstyle(SSFtraceY#15)=3,rgb(SSFtraceY#15)=(39168,39168,0);ModifyGraph lsize(SSBtraceY)=1.5,rgb(SSBtraceY)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#1)=1.5,rgb(SSBtraceY#1)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#2)=1.5,rgb(SSBtraceY#2)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#3)=1.5,rgb(SSBtraceY#3)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#4)=1.5,rgb(SSBtraceY#4)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#5)=1.5,rgb(SSBtraceY#5)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#6)=1.5,rgb(SSBtraceY#6)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#7)=1.5,rgb(SSBtraceY#7)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#8)=1.5,rgb(SSBtraceY#8)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#9)=1.5,rgb(SSBtraceY#9)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#10)=1.5,rgb(SSBtraceY#10)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#11)=1.5,rgb(SSBtraceY#11)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#12)=1.5,rgb(SSBtraceY#12)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#13)=1.5,rgb(SSBtraceY#13)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#14)=1.5,rgb(SSBtraceY#14)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSBtraceY#15)=1.5,rgb(SSBtraceY#15)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY)=1.5,rgb(SSFtraceY)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#1)=1.5,rgb(SSFtraceY#1)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#2)=1.5,rgb(SSFtraceY#2)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#3)=1.5,rgb(SSFtraceY#3)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#4)=1.5,rgb(SSFtraceY#4)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#5)=1.5,rgb(SSFtraceY#5)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#6)=1.5,rgb(SSFtraceY#6)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#7)=1.5,rgb(SSFtraceY#7)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#8)=1.5,rgb(SSFtraceY#8)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#9)=1.5,rgb(SSFtraceY#9)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#10)=1.5,rgb(SSFtraceY#10)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#11)=1.5,rgb(SSFtraceY#11)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#12)=1.5,rgb(SSFtraceY#12)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#13)=1.5,rgb(SSFtraceY#13)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#14)=1.5,rgb(SSFtraceY#14)=(65280,65280,16384);DelayUpdateModifyGraph lsize(SSFtraceY#15)=1.5,rgb(SSFtraceY#15)=(65280,65280,16384)//    Diagonalline ()  endifendFunction  calcSSFS(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	wave traceY, traceX	nvar SSvector	duplicate/o  traceY SSFtraceY	duplicate/o  traceX SSFtraceX	duplicate/o  traceY SSBtraceY	duplicate/o  traceX SSBtraceX 	SSFtraceY=SSFtraceY+SSvector	SSFtraceX=SSFtraceX+SSvector	SSBtraceY=SSBtraceY-SSvector	SSBtraceX=SSBtraceX-SSvectorend	Function Diagonalline () Nvar piangle 	make/o/n=13 diagonalX, diagonalY 	diagonalX[0] = -piangle ; diagonalY[0] = piangle 	diagonalX[1] = -piangle ; diagonalY[1] = -piangle 	diagonalX[2] = 3*piangle ; diagonalY[2] = -piangle 	diagonalX[3] = 3*piangle ; diagonalY[3] = piangle 	diagonalX[4] = piangle ; diagonalY[4] = piangle 	diagonalX[5] = piangle ; diagonalY[5] = -piangle 	diagonalX[6] = 3*piangle ; diagonalY[6] = piangle 	diagonalX[7] = 3*piangle ; diagonalY[7] = -piangle 	diagonalX[8] = piangle ; diagonalY[8] = piangle 	diagonalX[9] = -piangle ; diagonalY[9] = piangle 	diagonalX[10] = piangle ; diagonalY[10] = -piangle 	diagonalX[11] = piangle ; diagonalY[11] = piangle 	diagonalX[12] = -piangle ; diagonalY[12] = -piangle 	appendtograph diagonalY vs diagonalX 	ModifyGraph rgb(diagonalY)=(0,0,0)endFunction TB_FS()	NVAR bt0,bt1,bt2,bt3,bt4,bt5,bt6,d1,d2,d3,d4,d5,d6	Nvar TBsize, PiAngle	variable kpi   make /o/n=(TBsize,TBsize) TBwave	SetScale/I x (PiAngle*(-1)),PiAngle,TBwave	SetScale/I y (PiAngle*(-1)),PiAngle,TBwave	kpi=pi/PiAngle	TBwave = bt0  	TBwave += bt1*(cos(kpi*x)+(1+d1)*cos(kpi*y))/2	TBwave += bt2*cos(kpi*x)*cos(kpi*y)	TBwave += bt3*(cos(2*kpi*x)+(1+d3)*cos(2*kpi*y))/2	TBwave += bt4*(cos(2*kpi*x)*cos(kpi*y) + (1+d4)*cos(kpi*x)*cos(2*kpi*y) )/2	TBwave += bt5*cos(2*kpi*x)*cos(2*kpi*y)	TBwave += bt6*(cos(3*kpi*x)+(1+d6)*cos(3*kpi*y))/2endfunction LooksorceMapFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "sorceMap", waveliststr	variable i	svar UseparaFSMapstr	silent 1; pauseupdate	dowindow/f $panelname  if (v_flag==1)	   waveliststr = wavelist("*",";","win:")	  for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveImage $StringFromList(i, waveliststr)    endfor   appendimage $UseparaFSMapstr	ModifyImage $UseparaFSMapstr ctab= {*,*,Rainbow,1}	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	else	display/W=(267,193,681,424) 	dowindow/c $panelname	appendimage $UseparaFSMapstr	ModifyImage $UseparaFSMapstr ctab= {*,*,Rainbow,1}	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	endifendFunction FSeditFunc (ctrlName) : ButtonControl	String ctrlName	svar kxwaveRota, kywaveRota	string  waveliststr	variable i	dowindow/f FSedit	if (v_flag==1)	waveliststr = wavelist("*",";","win:")	  for (i=0 ; i < ItemsInList(waveliststr); i+=1)   	  RemoveFromTable $StringFromList(i, waveliststr)    	endfor   	  if (stringmatch(kywaveRota,"")!=1)    	 appendtotable $kywaveRota     	 endif    	 if (stringmatch(kxwaveRota,"")!=1)    	 appendtotable $kxwaveRota    	 endif  else      edit      if (stringmatch(kywaveRota,"")!=1)    	 appendtotable $kywaveRota     	 endif    	 if (stringmatch(kxwaveRota,"")!=1)    	 appendtotable $kxwaveRota    	 endif	dowindow/c FSedit  endIFENDFunction MemoFSListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "MemoFSList"	wave/t memoT_FS	dowindow/f $panelname	if (v_flag!=1)	edit memoT_FS	dowindow/c $panelname	endifend	Function FSSaveButtonProc (ctrlName) : ButtonControl	String ctrlName   NVAR RotaXspacing, SliceAngle   NVAR PhotoEnergy, workfunction, LatticeConstant   NVAR readRota, readTheta, readPhi,offRota,offTheta, offPhi   NVAR saveNo_FS   string FScoeff   wave/t memoT_FS   svar saveNo_memoFS   FScoeff="FScoeff"+num2istr(saveNo_FS)   make/o/n=11 $FScoeff   duplicate/o $FScoeff temp0  // temp0 = {RotaXspacing, SliceAngle, RotaAngle, offXrota, offYrota, MapRotaPiAngle}  temp0 = {RotaXspacing, SliceAngle, PhotoEnergy, workfunction, LatticeConstant, readRota, readTheta, readPhi,offRota,offTheta, offPhi}   duplicate/o temp0 $FScoeff   memoT_FS[saveNo_FS] = saveNo_memoFSEndFunction FSCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar FSsavecheckFSsavecheck = checkedEnd	Function CutvsdegFunc (ctrlName) : ButtonControl	String ctrlName	string resultY = "FSangle",resultX = "ARPESangle", panelname	variable minP=0,maxP=0, i, j	wave traceY, traceX	Nvar piangle   panelname="FSadjustment"	dowindow $panelname	if (v_flag!=1)	abort "Show FS panel !!"	endif	MakeCopyOfTrace("FSadjustment","'TBwave=0'")			make/o/n=0 temp1,temp2   for (i=0 ;i<numpnts(traceY) ;i+=1)     if (traceY[i]>0 && traceX[i]>0)      j+=1      Redimension/N=(j) temp1,temp2      temp1[j-1]=traceX[i]      temp2[j-1]=traceY[i]     endif   endfor   duplicate/o temp1 temp3   temp3[]=atan((piangle-temp1[p])/(piangle-temp2[p]))*180/pi   duplicate/o temp3, $resultY   duplicate/o temp1, $resultX      panelname="Cutvsdeg"   dowindow/f $panelname   if (v_flag!=1)   Display /W=(318,147,723,471) $resultY vs $resultX	ModifyGraph tick=2	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.625,axOffset(bottom)=-0.25	Label left "FS angle (deg)"	Label bottom "ARPES angle (deg)"	ModifyGraph grid=1	ModifyGraph nticks=10	dowindow/c $panelname	endif EndmacroProc GapsizeFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	GapsymmetryFunc () endProc showGapsymfunc (ctrlName) : ButtonControl	String ctrlName	string panelname="Gap_symmetry"	 PauseUpdate; Silent 1	GapsymmetryFunc () 	 dowindow/f $panelname 	if (v_flag!=1)	Display /W=(242,139,520,457) Gapsym_dwave	dowindow/c $panelname	ModifyGraph tick=2	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.857143,axOffset(bottom)=-0.666667	Label left "Gap (meV)"	Label bottom "FS angle (deg)"	ModifyGraph grid=1	ModifyGraph nticks=10	endifendProc GapsymmetryFunc ()  PauseUpdate; Silent 1	make/o/n=101 Gapsym_dwave	setscale/I x, 0,45,"" Gapsym_dwave	Gapsym_dwave = GapMaxDwave*( GapBvalue*cos(2*x*pi/180)+(1-GapBvalue)*cos(6*x*pi/180) )endFunction GetThetaFunc (ctrlName) : ButtonControl	String ctrlName	string panelname="FSadjustment"	Nvar piangle, Theta	variable a_csrXval, a_csrYval dowindow/f $panelname	if (v_flag!=1)	abort "Show FS panel !!"	endif	a_csrXval=hcsr(a); a_csrYval=vcsr(a)	if (stringmatch(CsrWave(a),""))		abort "Set csr a !!"	endif Theta=atan((piangle-a_csrXval)/(piangle-a_csrYval))*180/pi Endmacro Proc RotasetFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	RotaAllFunc ()endProc Rota_scaleFunc ()silent 1 ; pauseupdate if (stringmatch(kywaveRota,"")!=1)		Rotaky_a1[]=$kywaveRota[p]*SliceAngle endifendproc XspacingFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string panelname	silent 1 ; pauseupdate    RotaAllFunc ()endProc Rota_XspacingFunc ()silent 1 ; pauseupdate if (stringmatch(kywaveRota,"")!=1)		Rotakx_a1[]*=RotaXspacing endifendProc Rota_moveLine ()variable midYsilent 1 ; pauseupdate if (stringmatch(kyAwaveRota,"")!=1)   midY = Rotaky_a1[numpnts(Rotaky_a1)/2]   Rotaky_a1[] -= midY*( 1-cos(Rotakx_a1[p]/180*pi) ) endif if (stringmatch(kyBwaveRota,"")!=1)    midY = Rotaky_a2[numpnts(Rotaky_a2)/2]   Rotaky_a2[] -= midY*( 1-cos(Rotakx_a2[p]/180*pi) ) endifendProc Rota_ARPEScorr ()silent 1 ; pauseupdateduplicate/o Rotakx_a1 tempduplicate/o Rotakx_a2 temp1duplicate/o Rotaky_a1 temp2duplicate/o Rotaky_a2 temp3 if (stringmatch(kyAwaveRota,"")!=1)   Rotaky_a1[]*= ( sin(sqrt(temp[p]^2+temp2[p]^2)*(pi/180)) / (sqrt(temp[p]^2+temp2[p]^2)*(pi/180)) ) 	Rotakx_a1[]*= ( sin(sqrt(temp[p]^2+temp2[p]^2)*(pi/180)) / (sqrt(temp[p]^2+temp2[p]^2)*(pi/180)) ) endif if (stringmatch(kyBwaveRota,"")!=1)  	Rotakx_a2[]*= sin(sqrt(temp1[p]^2+temp3[p]^2)*(pi/180)) /  (sqrt(temp1[p]^2+temp3[p]^2)*(pi/180))	 	Rotaky_a2[]*= sin(sqrt(temp1[p]^2+temp3[p]^2)*(pi/180)) / (sqrt(temp1[p]^2+temp3[p]^2)*(pi/180)) endif  //Rotakx_a1[]*= sin(Rotakx_a1[p]*(pi/180)) / (Rotakx_a1[p]*(pi/180)) //Rotakx_a2[]*= sin(Rotakx_a2[p]*(pi/180)) / (Rotakx_a2[p]*(pi/180)) //Rotaky_a1[]*= sin(Rotaky_a1[p]*(pi/180)) / (Rotaky_a1[p]*(pi/180)) //Rotaky_a2[]*= sin(Rotaky_a2[p]*(pi/180)) / (Rotaky_a2[p]*(pi/180))  //Rotakx_a1[]/=(Rotakx_a1[p]/PiAngle) / ( sin(Rotakx_a1[p]*(pi/180))/sin(PiAngle*(pi/180)) ) //Rotakx_a2[]/=(Rotakx_a2[p]/PiAngle) / ( sin(Rotakx_a2[p]*(pi/180))/sin(PiAngle*(pi/180)) )  //Rotaky_a1[]/=(Rotaky_a1[p]/PiAngle) / ( sin(Rotaky_a1[p]*(pi/180))/sin(PiAngle*(pi/180)) )// Rotaky_a2[]/=(Rotaky_a2[p]/PiAngle) / ( sin(Rotaky_a2[p]*(pi/180))/sin(PiAngle*(pi/180)) )endproc FSsizeProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string panelname	silent 1 ; pauseupdate 	TBsize = varNum	TB_FS()	modiTBwave_copy ()endFunction FSPiangleFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar PiAngle  PiAngle = varNum  SetScale/I x (PiAngle*(-1)),PiAngle,"", TBwave;DelayUpdate  SetScale/I y (PiAngle*(-1)),PiAngle,"", TBwave  modiTBwave_copy ()  Diagonalline ()endFunction modiTBwave_copy ()    wave TBwave    Nvar PiAngle   duplicate/o TBwave TBwave_copy    SetScale/I x PiAngle,3*PiAngle,"", TBwave_copyendProc FScuprateProc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr  if (popNum==1)    Bi2212_norman ()   endif   if (popNum==2)    LSCO_yoshida ()   endif  if (popNum==3)    Bi2201_Kondo ()   endif  	TB_FS()  //modiTBwave_copy ()	if (stringmatch(WinList("TB_Econtour",";",""),"")==1)		TBshowProc("")	endif	MakeCopyOfTrace("TB_Econtour","'TBwave=0'")Endproc FSCalc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	TB_FS ()	//modiTBwave_copy ()	if (stringmatch(WinList("TB_Econtour",";",""),"")==1)		TBshowProc("")	endif	MakeCopyOfTrace("TB_Econtour","'TBwave=0'")endFunction GetpFunc2 (ctrlName) : ButtonControl	String ctrlName	string panelname="FSadjustment"	wave traceY, traceX, temp1, temp2	variable i, j=0, Initialangle, Finalangle	Nvar piangle	dowindow $panelname	if (v_flag!=1)	abort "Show FS panel !!"	endif	MakeCopyOfTrace("FSadjustment","'TBwave=0'")	make/o/n=0 temp1,temp2   for (i=0 ;i<numpnts(traceY) ;i+=1)     if (traceY[i]>0 && traceX[i]>0)      j+=1      Redimension/N=(j+2) temp1,temp2      temp1[j]=traceX[i]      temp2[j]=traceY[i]     endif   endfor   Initialangle = atan(temp2[1]/temp1[1])/pi*180   Finalangle = atan(temp2[j]/temp1[j])/pi*180   if (min(Initialangle,Finalangle)>0.1)      if (Finalangle>Initialangle)      temp1[0]=piangle ; temp2[0]=0      else      temp1[j+1]=piangle ; temp2[j+1]=0      endif   endif   if (max(Initialangle,Finalangle)<(90-0.1))      if (Finalangle>Initialangle)      temp1[j+1]=0 ; temp2[j+1]=piangle      else      temp1[0]=0 ; temp2[0]=piangle      endif  endif   Area_SF(temp1,temp2)end	Function GetpFunc_back (ctrlName) : ButtonControl	String ctrlName	wave traceY, traceX, temp1, temp2	variable i, j=0, Initialangle, Finalangle	Nvar piangle	make/o/n=0 temp1,temp2   for (i=0 ;i<numpnts(traceY) ;i+=1)     if (traceY[i]>0 && traceX[i]>0)      j+=1      Redimension/N=(j+2) temp1,temp2      temp1[j]=traceX[i]      temp2[j]=traceY[i]     endif   endfor   Initialangle = atan(temp2[1]/temp1[1])/pi*180   Finalangle = atan(temp2[j]/temp1[j])/pi*180   if (min(Initialangle,Finalangle)>0.1)      if (Finalangle>Initialangle)      temp1[0]=piangle ; temp2[0]=0      else      temp1[j+1]=piangle ; temp2[j+1]=0      endif   endif   if (max(Initialangle,Finalangle)<(90-0.1))      if (Finalangle>Initialangle)      temp1[j+1]=0 ; temp2[j+1]=piangle      else      temp1[0]=0 ; temp2[0]=piangle      endif  endif   Area_SF(temp1,temp2)end	Proc GoTBfitProc2 (ctrlName) : ButtonControl	String ctrlName	string TBcoeff = "TBcoeffbegin", TB_kx="FSkx", TB_ky="FSky", TB_E="FSE"	string panelname="FSadjustment"	variable sizekx, sizeky, sizeE	sizekx = dimsize(Rotakx_a1,0) + dimsize(Rotakx_a2,0)+3	sizeky = sizekx	sizeE = sizekx	make/o/n=(sizekx) $TB_kx, $TB_ky, $TB_E	$TB_kx=0; $TB_ky=0; $TB_E=0	$TB_kx[0,dimsize(Rotakx_a1,0)-1]=Rotakx_a1/Piangle	$TB_ky[0,dimsize(Rotaky_a1,0)-1]=Rotaky_a1/Piangle	$TB_kx[dimsize(Rotakx_a1,0),dimsize(Rotakx_a1,0) + dimsize(Rotakx_a2,0)-1]=Rotakx_a2[p-dimsize(Rotakx_a1,0)]/Piangle	$TB_ky[dimsize(Rotaky_a1,0),dimsize(Rotakx_a1,0) + dimsize(Rotakx_a2,0)-1]=Rotaky_a2[p-dimsize(Rotakx_a1,0)]/Piangle	$TB_kx[sizekx-1]=1 ; $TB_ky[sizeky-1]=1 ; $TB_E[sizekx-1]=1	$TB_kx[sizekx-2]=0.73913 ; $TB_ky[sizeky-2]=0.73913 ; $TB_E[sizekx-2]=0.75   $TB_E[sizekx-3]=-0.5	//silent 1 ; pauseupdate   bt0=0.1305; bt1=-0.5951; bt2=0.1636; bt3=-0.0519; bt4=-0.1117; bt5=0.0510   make/o/n=(6) $TBcoeff 	$TBcoeff = {bt0,bt1,bt2,bt3,bt4,bt5}	FuncFit/q TB_function_4sym $TBcoeff $TB_E /X={$TB_kx,$TB_ky}	TB_FS()	//modiTBwave_copy ()	if (stringmatch(WinList("TB_Econtour",";",""),"")==1)		TBshowProc("")	endif	MakeCopyOfTrace("TB_Econtour","'TBwave=0'")endProc showRotaFSFunc (ctrlName) : ButtonControl	String ctrlName	string panelname="FS4symPlot"	silent 1 ; pauseupdate	make/o/n=8 frameX, frameY	frameX[]={(-1)*piangle,(-1)*piangle,piangle,piangle,(-1)*piangle,piangle,piangle,(-1)*piangle}	frameY[]={(-1)*piangle,piangle,piangle,(-1)*piangle,(-1)*piangle,piangle,(-1)*piangle,piangle}    dowindow/f $panelname   if (v_flag!=1) 	RotaAllFunc ()	Display /W=(271,213,666,583) Rotaky_a1 vs Rotakx_a1	dowindow/c $panelname	AppendToGraph Rotaky_b1 vs Rotakx_b1	AppendToGraph Rotaky_c1 vs Rotakx_c1	AppendToGraph Rotaky_d1 vs Rotakx_d1	AppendToGraph Rotaky_a2 vs Rotakx_a2	AppendToGraph Rotaky_b2 vs Rotakx_b2	AppendToGraph Rotaky_c2 vs Rotakx_c2	AppendToGraph Rotaky_d2 vs Rotakx_d2	ModifyGraph mode=3	ModifyGraph msize=3	ModifyGraph rgb(Rotaky_a1)=(0,0,65535),rgb(Rotaky_b1)=(0,0,65535);DelayUpdateModifyGraph rgb(Rotaky_c1)=(0,0,65535),rgb(Rotaky_d1)=(0,0,65535);DelayUpdateModifyGraph rgb(Rotaky_a2)=(0,0,65535),rgb(Rotaky_b2)=(0,0,65535);DelayUpdateModifyGraph rgb(Rotaky_c2)=(0,0,65535),rgb(Rotaky_d2)=(0,0,65535)		appendtograph traceY vs traceXappendtograph traceY vs traceXModifyGraph offset(traceY#1)={2*piangle,0}appendtograph traceY vs traceXModifyGraph offset(traceY#2)={(-2)*piangle,0}appendtograph traceY vs traceXModifyGraph offset(traceY#3)={0,2*piangle}appendtograph traceY vs traceXModifyGraph offset(traceY#4)={0,(-2)*piangle}ModifyGraph mode(traceY)=0,mode(traceY#1)=0,mode(traceY#2)=0,mode(traceY#3)=0;DelayUpdateModifyGraph mode(traceY#4)=0	ModifyGraph height={Aspect,1}	ModifyGraph marker=19	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-2.71429,axOffset(bottom)=-0.8	Label left "Angle (deg)"	Label bottom "Angle (deg)"		appendtograph frameY vs frameX	ModifyGraph mode(frameY)=0,rgb(frameY)=(0,0,0)	endifendProc Rota_Piscale () silent 1 ; pauseupdate if (stringmatch(kyAwaveRota,"")!=1)   Rotakx_a1/=MaprotaPiangle   Rotaky_a1/=MaprotaPiangle endif if  (stringmatch(kyBwaveRota,"")!=1)    Rotakx_a2/=MaprotaPiangle      Rotaky_a2/=MaprotaPiangle endifendProc Rota_offseFunc ()silent 1 ; pauseupdate	   if (stringmatch(kyAwaveRota,"")!=1)	  		 Rotakx_a1+=offXrota  			 Rotaky_a1+=offYrota	  	endif	  	if  (stringmatch(kyBwaveRota,"")!=1) 				  	   Rotakx_a2+=offXrota  			Rotaky_a2+=offYrota  	   endifendProc Rota_oneFunc ()silent 1 ; pauseupdate    RotationFunc ("Rotakx_a1","Rotaky_a1","Rotakx_a1","Rotaky_a1",RotaAngle)    RotationFunc ("Rotakx_a2","Rotaky_a2","Rotakx_a2","Rotaky_a2",RotaAngle)endProc Rota_4symFunc ()silent 1 ; pauseupdate    RotationFunc ("Rotakx_a1","Rotaky_a1","Rotakx_b1","Rotaky_b1",90)    RotationFunc ("Rotakx_a2","Rotaky_a2","Rotakx_b2","Rotaky_b2",90)    RotationFunc ("Rotakx_a1","Rotaky_a1","Rotakx_c1","Rotaky_c1",180)    RotationFunc ("Rotakx_a2","Rotaky_a2","Rotakx_c2","Rotaky_c2",180)    RotationFunc ("Rotakx_a1","Rotaky_a1","Rotakx_d1","Rotaky_d1",270)    RotationFunc ("Rotakx_a2","Rotaky_a2","Rotakx_d2","Rotaky_d2",270)endproc RotationFunc(kx,ky,kx_,ky_,angle)  string kx, ky, kx_,ky_  variable angle, deg    silent 1 ; pauseupdate  deg = angle*(pi/180)     duplicate/o $kx, temp1   duplicate/o $ky, temp2   temp1[]=$kx[p]*cos(Deg)-$ky[p]*sin(Deg)   temp2[]=$kx[p]*sin(Deg)+$ky[p]*cos(Deg)   duplicate/o temp1, $kx_   duplicate/o temp2, $ky_EndMacro////////////////////////////////////////////////////		Self Energy					///////////////////////////////////////////////////Window Self_Energy() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(208,220,491,715)	SetDrawLayer UserBack	DrawRect 8,5,273,277	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (0,0,65535)	DrawText 13,125,"-Data"	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (0,0,65535)	DrawText 13,176,"-Model"	SetDrawEnv fsize= 13,fstyle= 1,textrgb= (1,26214,0)	DrawText 15,212,"wMDC(x) = a0*x2 + c0"	SetDrawEnv fsize= 13,fstyle= 1,textrgb= (1,26214,0)	DrawText 14,252,"wMDC(x) = a1*x + c1"	SetDrawEnv linethick= 2	DrawLine 9,398,274,398	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 15,418,"Make Map"	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 14,298,"Bare Band"	SetDrawEnv linethick= 2,dash= 3	DrawLine 19,69,266,69	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 13,89,"(b) Set MDC width"	SetDrawEnv linethick= 2	DrawLine 9,319,274,319	SetDrawEnv linethick= 2	DrawLine 8,349,273,349	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 12,28,"(a) Input Im"	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 14,370,"Get Re(Sigma)"	SetVariable setvar13,pos={14,422},size={82,15},title="Kpoints"	SetVariable setvar13,limits={50,inf,1},value= SelfMap_Kpoints	SetVariable setvar14,pos={14,440},size={82,15},title="Epoints"	SetVariable setvar14,limits={50,inf,1},value= SelfMap_Epoints	SetVariable setvar15,pos={102,422},size={82,15},title="ki[pi/a]"	SetVariable setvar15,limits={-1,0,0.1},value= SelfMap_ki	SetVariable setvarEi,pos={102,440},size={82,15},title="Ei[eV]"	SetVariable setvarEi,limits={-1.5,0,0.1},value= SelfMap_Ei	SetVariable SelfMapVF,pos={118,299},size={91,15},proc=VFmodiFunc,title="VF[eVA]"	SetVariable SelfMapVF,limits={-inf,inf,0.1},value= SelfMap_VF_eVA	SetVariable setvar18,pos={188,422},size={82,15},title="kf[pi/a]"	SetVariable setvar18,limits={0,1,0.1},value= SelfMap_kf	SetVariable setvar19,pos={188,440},size={82,15},title="Ef[eV]"	SetVariable setvar19,limits={0,1,0.1},value= SelfMap_Ef	Button button6,pos={179,458},size={86,20},proc=SelfMapshowFunc,title="show Map"	SetVariable setvar20,pos={204,403},size={67,15},title="T[K]"	SetVariable setvar20,limits={1,inf,1},value= SelfMap_T	Button button7,pos={107,324},size={137,20},proc=showIm_eV_proc,title="show Im [eV]"	Button button8,pos={34,373},size={90,20},proc=calcReSigma,title="Calc Re [eV]"	PopupMenu changeValue,pos={206,298},size={51,17},proc=SelfMap_ValmenuFunc,title=" "	PopupMenu changeValue,mode=2,popvalue="0.1",value= #"\"0.01;0.1;1\""	SetVariable setvar21,pos={207,355},size={53,15},proc=ModifysigmaProc,title="/C"	SetVariable setvar21,limits={0.01,inf,0.1},value= SelfMap_C	Button button9,pos={138,374},size={86,20},proc=showSigmaFunc,title="show Sigma"	SetVariable setvar17,pos={17,216},size={88,15},proc=InputMDCproc,title="FL:  a0"	SetVariable setvar17,limits={-inf,inf,0.1},value= SelfMap_aFL	SetVariable setvar22,pos={105,216},size={64,15},proc=InputMDCproc,title="c0"	SetVariable setvar22,limits={-inf,inf,0.01},value= SelfMap_cFL	SetVariable setvar23,pos={169,215},size={98,15},proc=InputMDCproc,title="Emin0[eV]"	SetVariable setvar23,limits={-inf,-0.01,0.1},value= SelfMap_EminFL	SetVariable setvar24,pos={17,256},size={87,15},proc=InputMDCproc,title="ML:  a1"	SetVariable setvar24,limits={-inf,inf,0.1},value= SelfMap_aML	SetVariable setvar25,pos={104,256},size={64,15},proc=InputMDCproc,title="c1"	SetVariable setvar25,limits={-inf,inf,0.01},value= SelfMap_cML	SetVariable setvar26,pos={169,256},size={98,15},proc=InputMDCproc,title="Emin1[eV]"	SetVariable setvar26,limits={-inf,-0.01,0.1},value= SelfMap_EminML	PopupMenu popup1,pos={16,177},size={73,17},proc=ChoseFLMLproc,title=" "	PopupMenu popup1,mode=3,popvalue="FL+ML",value= #"\"FL;ML;FL+ML\""	SetVariable setvar27,pos={21,299},size={95,15},proc=UpdateFunc,title="kF[pi/a]"	SetVariable setvar27,limits={-1,1,0.01},value= SelfMap_kFermi	SetVariable setvar28,pos={118,355},size={82,15},proc=ErangeSetFunc,title="E [eV]"	SetVariable setvar28,limits={0,3,0.5},value= SelfMap_Erange	CheckBox check0,pos={88,283},size={65,14},proc=LinearBand,title="linear band"	CheckBox check0,value= 1	CheckBox check1,pos={14,93},size={38,14},proc=ChoseDaraModel,title="Data"	CheckBox check1,value= 0	SetVariable setvar6,pos={51,51},size={171,15},title="ImX [eV]",value= ImXstr	SetVariable setvar7,pos={51,33},size={171,15},title="ImY [eV]",value= ImYstr	CheckBox check2,pos={27,327},size={71,14},proc=ChoseInputIm,title="Use Input Im"	CheckBox check2,value= 0	Button button1,pos={101,10},size={131,20},proc=showInputIm,title="show Input Im [eV]"	PopupMenu EFpopup,pos={149,138},size={95,17},proc=Self_MDCpopupFunc	PopupMenu EFpopup,mode=2,popvalue="wMDCwave",value= #"\"_none_;\" + WaveList(\"wMDC*\",\";\",\"\")"	SetVariable setvar16,pos={18,124},size={126,15},title="pi angle (deg)"	SetVariable setvar16,limits={1,inf,1},value= Self_PiAngle	SetVariable setvar0,pos={19,140},size={125,15},title="one slice (deg)"	SetVariable setvar0,limits={0,inf,0.01},value= Self_SliceAngle	Button button0,pos={149,72},size={85,20},proc=showMDCfunc,title="show MDC"EndMacroWindow Self_Energy_v2() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(660,437,974,812)	SetDrawLayer UserBack	DrawRect 8,7,306,153	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (0,0,65535)	DrawText 13,40,"-Model"	SetDrawEnv fsize= 13,fstyle= 1,textrgb= (1,26214,0)	DrawText 15,55,"Im(x) = a*x2 + b*x + c"	SetDrawEnv linethick= 2	DrawLine 10,285,301,285	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 20,305,"Make Map"	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 14,224,"Bare Band"	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 13,25,"Make Im(Sigma)"	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 14,174,"Get Re(Sigma)"	SetDrawEnv linethick= 2	DrawLine 10,204,301,204	SetDrawEnv linethick= 2	DrawLine 11,248,302,248	SetDrawEnv fsize= 15,fstyle= 1,textrgb= (65535,0,0)	DrawText 14,273,"SC Gap"	SetVariable setvar13,pos={20,309},size={82,18},title="Kpoints"	SetVariable setvar13,limits={50,inf,1},value= SelfMap_Kpoints	SetVariable setvar14,pos={20,327},size={82,18},title="Epoints"	SetVariable setvar14,limits={50,inf,1},value= SelfMap_Epoints	SetVariable setvar15,pos={108,309},size={82,18},title="ki[pi/a]"	SetVariable setvar15,limits={-1,0,0.1},value= SelfMap_ki	SetVariable setvarEi,pos={108,327},size={82,18},title="Ei[eV]"	SetVariable setvarEi,limits={-1.5,0,0.1},value= SelfMap_Ei	SetVariable SelfMapVF,pos={131,225},size={91,18},proc=VFmodiFunc_v2,title="VF[eVA]"	SetVariable SelfMapVF,limits={-inf,inf,0.1},value= SelfMap_VF_eVA	SetVariable setvar18,pos={194,309},size={82,18},title="kf[pi/a]"	SetVariable setvar18,limits={0,1,0.1},value= SelfMap_kf	SetVariable setvar19,pos={194,327},size={82,18},title="Ef[eV]"	SetVariable setvar19,limits={0,1,0.1},value= SelfMap_Ef	Button button6,pos={124,345},size={86,20},proc=SelfMapshowFunc,title="show Map"	SetVariable setvar20,pos={210,290},size={67,18},title="T[K]"	SetVariable setvar20,limits={1,inf,1},value= SelfMap_T	Button button8,pos={34,179},size={90,20},proc=calcReSigma_v2,title="Calc Re [eV]"	PopupMenu changeValue,pos={219,224},size={50,21},proc=SelfMap_ValmenuFunc,title=" "	PopupMenu changeValue,mode=2,popvalue="0.1",value= #"\"0.01;0.1;1\""	SetVariable setvar21,pos={207,161},size={53,18},proc=ModifysigmaProc_v2,title="/C"	SetVariable setvar21,limits={0.01,inf,0.1},value= SelfMap_C	Button button9,pos={138,180},size={86,20},proc=showSigmaFunc,title="show Sigma"	SetVariable setvar17,pos={13,59},size={78,18},proc=InputIMproc,title="Im1:  a"	SetVariable setvar17,limits={-inf,inf,0.1},value= SelfMap_a1	SetVariable setvar22,pos={91,59},size={54,18},proc=InputIMproc,title="b"	SetVariable setvar22,limits={-inf,inf,0.01},value= SelfMap_b1	SetVariable setvar23,pos={201,58},size={98,18},proc=InputIMproc,title="Emin[eV]"	SetVariable setvar23,limits={-inf,0,0.1},value= SelfMap_Emin1	SetVariable setvar24,pos={13,75},size={78,18},proc=InputIMproc,title="Im2:  a"	SetVariable setvar24,limits={-inf,inf,0.1},value= SelfMap_a2	SetVariable setvar25,pos={91,75},size={54,18},proc=InputIMproc,title="b"	SetVariable setvar25,limits={-inf,inf,0.01},value= SelfMap_b2	SetVariable setvar26,pos={201,75},size={98,18},proc=InputIMproc,title="Emin[eV]"	SetVariable setvar26,limits={-inf,0,0.1},value= SelfMap_Emin2	SetVariable setvar27,pos={34,225},size={95,18},proc=UpdateFunc_v2,title="kF[pi/a]"	SetVariable setvar27,limits={-1,1,0.01},value= SelfMap_kFermi	SetVariable setvar28,pos={118,161},size={82,18},proc=ErangeSetFunc,title="E [eV]"	SetVariable setvar28,limits={0,3,0.5},value= SelfMap_Erange	CheckBox check0,pos={88,209},size={80,15},proc=LinearBand_v2,title="linear band"	CheckBox check0,value= 0	Button button0,pos={148,17},size={115,20},proc=showIMfunc,title="show Im(Sigma)"	SetVariable setvar29,pos={146,59},size={54,18},proc=InputIMproc,title="c"	SetVariable setvar29,limits={-inf,inf,0.01},value= SelfMap_c1	SetVariable setvar30,pos={146,75},size={54,18},proc=InputIMproc,title="c"	SetVariable setvar30,limits={-inf,inf,0.01},value= SelfMap_c2	SetVariable setvar31,pos={13,91},size={78,18},proc=InputIMproc,title="Im3:  a"	SetVariable setvar31,limits={-inf,inf,0.1},value= SelfMap_a3	SetVariable setvar32,pos={91,91},size={54,18},proc=InputIMproc,title="b"	SetVariable setvar32,limits={-inf,inf,0.01},value= SelfMap_b3	SetVariable setvar33,pos={201,91},size={98,18},proc=InputIMproc,title="Emin[eV]"	SetVariable setvar33,limits={-inf,0,0.1},value= SelfMap_Emin3	SetVariable setvar34,pos={146,91},size={54,18},proc=InputIMproc,title="c"	SetVariable setvar34,limits={-inf,inf,0.01},value= SelfMap_c3	Button button7,pos={217,344},size={70,20},proc=SelfMapCreate,title="Create"	SetVariable setvar35,pos={78,255},size={95,18},title="gap (eV)"	SetVariable setvar35,limits={-0.1,0.1,0.001},value= SE_gap	SetVariable setvar36,pos={22,132},size={78,18},proc=InputIMproc,title="height"	SetVariable setvar36,limits={-inf,inf,0.1},value= selfmap_gh	SetVariable setvar37,pos={110,132},size={90,18},proc=InputIMproc,title="position"	SetVariable setvar37,limits={-inf,inf,0.1},value= selfmap_gp	SetVariable setvar38,pos={208,132},size={78,18},proc=InputIMproc,title="width"	SetVariable setvar38,limits={-inf,inf,0.1},value= selfmap_gw	CheckBox check1,pos={18,113},size={164,15},proc=InputIMCheckProc,title="add  peak (gauss function)"	CheckBox check1,variable= selfmap_gaussckEndMacroFunction SelfMapCreate (ctrlName) : ButtonControl	String ctrlName	string offsetstring,OffsetStr, theGraph, grx	variable offset, GNum, kpoints, Epoints, X0, dX	wave selfMap, GrAllNum	wave map	OffsetStr = "0000"+";1000"+";2000"+";3000"+";4000"+";5000"+";6000"+";7000"+";8000"+";9000"  OffsetStr+= ";10000"+";11000"+";12000"+";13000"+";14000"+";15000"+";16000"+";17000"+";18000"+";19000"  OffsetStr+= ";20000"+";21000"+";22000"+";23000"+";24000"+";25000"+";26000"+";27000"+";28000"+";29000"  OffsetStr+= ";30000"+";31000"+";32000"+";33000"+";34000"+";35000"+";36000"+";37000"+";38000"+";39000"  OffsetStr+= ";40000"+";41000"+";42000"+";43000"+";44000"+";45000"+";46000"+";47000"+";48000"+";49000"+";50000"  Prompt offsetstring, "Graph offset: ", popup , OffsetStr	Prompt GNum, "Graph Number: "  Doprompt "Map Create", offsetstring, GNum  if (V_Flag)   			return -1// User canceled   endif   offset = str2num(offsetstring)  if(offset+1000>map[0][0])  redimension/n=(offset+1000, dimsize(map,1)) map  map[0][0]=offset+1000  endif  string/g $("G"+offsetstring)  Epoints=dimsize(selfMap,0)  kpoints=dimsize(selfMap,1)    grx = "gx"+num2istr(GNum+offset)  make/o/n=(Epoints) $grx, temp  X0=DimOffset(selfMap, 0)   dX=DimDelta(selfMap, 0)  temp[]=X0+dX*p  duplicate/o temp, $grx    theGraph = "gr"+num2istr(GNum+offset)  make/o/n=(Epoints,kpoints) $theGraph, temp, temp1  duplicate/o selfMap, temp  temp1[][]=temp[p][q]  duplicate/o temp1, $theGraph	if (GrAllNum[offset/1000]<GNum)	 GrAllNum[offset/1000]=GNum	endifend			proc VFmodiFunc_v2 (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	variable aa=3.82   SelfMap_VF = SelfMap_VF_eVA*(pi/aa)   makeIm_interp_v2 ("wIMwave", "enIMwave", "ImInterp")EndProc UpdateFunc_v2 (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName  if (InputImCheck != 1)     InputIm ()     makeIm_interp_v2 ("wIMwave", "enIMwave", "ImInterp")  endifend Proc LinearBand_v2 (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   LinearBandCheck = checked  if (InputImCheck != 1)     InputIm ()     makeIm_interp_v2 ("wIMwave", "enIMwave", "ImInterp")  endifEndFunction ModifysigmaProc_v2 (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Modifysigma_v2 ()endProc calcReSigma_v2 (ctrlName) : ButtonControl	String ctrlName	string panelname="SigmaPanel"	variable E_i=-1*selfmap_Erange-0.01 , E_f	variable E, waveNum, n, enMDCNum, EiEf	string BaseImSig="ImInterp", EEwave="Ewave"	string ReSig="ReResult", ImSig="ImInterp"	string Re_Result="ReResult_modify", Im_Result="ImResult_modify"	variable MaxSig, MinSig	silent 1; pauseupdate//     InputIm ()     makeIm_interp_v2 ("wIMwave", "enIMwave", "ImInterp")       	duplicate/o $ImSig, $ReSig, $EEwave,temp   $EEwave() = x	 E = $EEwave[x2pnt($EEwave,E_i)]	 E_f = (-1)*E_i   $ReSig = nan   n = x2pnt($ReSig,E_f) - x2pnt($ReSig,E) do			temp() = $ImSig(x)/(x-E)		temp(E) = 0		$ReSig(E) = (-1)*area(temp,-inf,inf)/pi		n = x2pnt($ReSig,0) - x2pnt($ReSig,E)   	if (trunc(n/50) == n/50)   		print n   	endif		E+=DimDelta($ReSig,0) while (E<=DimDelta($ReSig,0))   duplicate/o $ReSig temp   $ReSig(DimDelta($ReSig,0),E_f) = (-1)*temp(-x)   Modifysigma_v2 ()    duplicate/o $Re_Result temp temp=temp[p]^2>0?temp[p]:0 duplicate/o temp $Re_Result  dowindow/f $panelname if (v_flag==1) 	wavestats/q $Im_Result	MaxSig = V_max*1.3   wavestats/q $Re_Result	MinSig = V_min*1.3	SetAxis left MinSig, MaxSig	SetAxis bottom -1,1 endif  if (v_flag!=1)	Display /W=(272,368,707,606) $Re_Result, $Im_Result	ModifyGraph width=347,height=178	ModifyGraph width=0,height=0	ModifyGraph rgb($Re_Result)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.857143	TextBox/C/N=aupname/F=0/A=MC/X=0/Y=38.62 "\\Z16Sigma (eV)"	Label left "Im, Re (eV)"	Label bottom "Energy (eV)"	wavestats/q $Im_Result	MaxSig = V_max*1.3   wavestats/q $Re_Result	MinSig = V_min*1.3	SetAxis left MinSig, MaxSig	SetAxis bottom -1,1	dowindow/c $panelname endifendFunction 	Modifysigma_v2 ()   Nvar SelfMap_C   string Re_Result="ReResult", Im_Result="ImInterp"   string Re_Result_Modify="ReResult_Modify", Im_Result_Modify="ImResult_Modify"   duplicate/o $Re_Result  temp   duplicate/o $Im_Result  temp1   temp/=SelfMap_C   temp1/=SelfMap_C   duplicate/o temp $Re_Result_modify     duplicate/o temp1 $Im_Result_modify  endProc makeIm_interp_v2 (wIMstr,enIMstr,ImSigma)	string  wIMstr,enIMstr,ImSigma	string  wIM_interp="wImInterp"	variable Xi=-100,Xf,InterpN=1	variable E, waveNum, n, enIMNum, EiEf	silent 1; pauseupdate	enIMNum = numpnts($enIMstr)  Interpolate2/T=1/N=(enIMNum)/Y=$wIM_interp $enIMstr, $wIMstr		EiEf = abs($enIMstr[0]-$enIMstr[enIMNum-1])	waveNum = (enIMNum/InterpN)*abs(2*Xi)/EiEf	 Xf = (-1)*Xi	make/o/n=(ceil(waveNum)) $ImSigma   setscale/I x,Xi,Xf,"", $ImSigma	 $ImSigma(Xi,0) = $wIM_interp(x)	 $ImSigma(0,Xf) = $wIM_interp(-x)endProc InputMDCproc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	InputMDC ()end Proc InputIMproc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	InputIm ()end Proc InputIMCheckProc(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	InputIm ()Endproc showMDCfunc (ctrlName) : ButtonControl	String ctrlName   InputMDC ()	showMDC ()  end		proc showIMfunc (ctrlName) : ButtonControl	String ctrlName   InputIm ()	showIm ()  end	Proc InputIm () string wIm="wImWave", enIm="enImWave" variable dE = 0.002, waveNum, MinE silent 1 ; pauseupdate  if  (SelfMap_Emin3==0)   SelfMap_Emin3=-0.01 endif MinE = SelfMap_Emin3 waveNum = round( abs(MinE) /dE ) make/o/n=( waveNum )  $wIm, $enIm, temp1, temp2, temp3 setscale/I x,MinE,0,"", $wIm, $enIm, temp1, temp2, temp3 $enIm()=x  temp1() = SelfMap_a1*x^2+SelfMap_b1*abs(x)^2+SelfMap_c1 temp2() = SelfMap_a2*x^2+SelfMap_b2*abs(x)+SelfMap_c2 temp3() = SelfMap_a3*x^2+SelfMap_b3*abs(x)+SelfMap_c3 	$wIm(SelfMap_Emin1,0)=temp1(x)	$wIm(SelfMap_Emin2,SelfMap_Emin1) = temp1(SelfMap_Emin1) + temp2(x-SelfMap_Emin1)	$wIm(SelfMap_Emin3,SelfMap_Emin2) = temp1(SelfMap_Emin1) + temp2(SelfMap_Emin2-SelfMap_Emin1) + temp3(x-SelfMap_Emin2)	if(selfmap_gaussck)	duplicate/o $wIm temp4	temp4=selfmap_gh*exp(-2.773*(x-selfmap_gp)^2/selfmap_gw^2)	$wIm()=$wIm(x)+temp4(x)	endif	end Function showIm ()	string panelname="ImPanel"  string wIm="wImWave", enIm="enImWave"   variable MaxSig, MinSig   dowindow/f $panelname    if (v_flag==1)   	wavestats/q $wIm		MaxSig = V_max*1.3		MinSig = -0.01		SetAxis left MinSig, MaxSig		SetAxis bottom -1,0.1	endif 	if (v_flag!=1)		Display /W=(272,368,707,606) $wIm vs $enIm		ModifyGraph width=347,height=178		ModifyGraph width=0,height=0		ModifyGraph tick=2		ModifyGraph zero=3		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-0.857143		Label left "Im (eV)"		Label bottom "Energy (eV)"  	wavestats/q $wIm		MaxSig = V_max*1.3		MinSig = -0.01		SetAxis left MinSig, MaxSig		SetAxis bottom -1,0.1		dowindow/c $panelname endifEndProc InputParaFLML (modeFLML) variable modeFLML string wMDC="wMDCwave", enMDC="enMDCwave" variable dE = 0.005, waveNum, MinE, MaxE silent 1 ; pauseupdate  if (modeFLML==1)  waveNum = round( abs(SelfMap_EminFL/dE) ) make/o/n=( waveNum )  $wMDC, $enMDC setscale/I x,SelfMap_EminFL,0,"", $wMDC, $enMDC $wMDC()=SelfMap_aFL*x^2+SelfMap_cFL $enMDC()=x  endif   if (modeFLML==2) waveNum = round( abs(SelfMap_EminML/dE) ) make/o/n=( waveNum )  $wMDC, $enMDC  setscale/I x,SelfMap_EminML,0,"", $wMDC, $enMDC $wMDC()=SelfMap_aML*abs(x)+SelfMap_cML $enMDC()=x  endif  if (modeFLML==3) MinE = Min(SelfMap_EminFL, SelfMap_EminML) MaxE = Max(SelfMap_EminFL, SelfMap_EminML)  waveNum = round( abs(MinE) /dE ) make/o/n=( waveNum )  $wMDC, $enMDC  setscale/I x,MinE,0,"", $wMDC, $enMDC $enMDC()=x    if (SelfMap_EminFL>=SelfMap_EminML)       duplicate/o $wMDC temp      $wMDC(SelfMap_EminFL,0)=SelfMap_aFL*x^2+SelfMap_cFL      temp() = SelfMap_aFL*x^2+SelfMap_cFL      $wMDC(SelfMap_EminML,SelfMap_EminFL) = temp(SelfMap_EminFL) + SelfMap_cML + SelfMap_aML*abs(x-SelfMap_EminFL)   else       duplicate/o $wMDC temp       $wMDC(SelfMap_EminML,0) = SelfMap_aML*abs(x)+SelfMap_cML      temp() = SelfMap_aML*abs(x)+SelfMap_cML      $wMDC(SelfMap_EminFL,SelfMap_EminML)= temp(SelfMap_EminML) +SelfMap_cFL + SelfMap_aFL*(x-SelfMap_EminML)^2       endif endifendProc InputMDC ()	Variable varNum	String varStr	String varName  if (DataModelCheck !=1)   InputParaFLML (modeFLML)  else   InputData ()  endifEndFunction showMDC ()	string panelname="wMDCPanel"	string wMDCwave="wMDCwave", enMDCwave="enMDCwave"   variable MaxSig, MinSig   dowindow/f $panelname    if (v_flag==1)   	wavestats/q $wMDCwave		MaxSig = V_max*1.3		MinSig = -0.01		SetAxis left MinSig, MaxSig		SetAxis bottom -1,0.1	endif 	if (v_flag!=1)		Display /W=(272,368,707,606) $wMDCwave vs $enMDCwave		ModifyGraph width=347,height=178		ModifyGraph width=0,height=0		ModifyGraph tick=2		ModifyGraph zero=3		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-0.857143		Label left "wMDC [\\F'Symbol'p\\F'Times' / a]"		Label bottom "Energy (eV)"  	 	wavestats/q $wMDCwave		MaxSig = V_max*1.3		MinSig = -0.01		SetAxis left MinSig, MaxSig		SetAxis bottom -1,0.1		dowindow/c $panelname endifEndProc Self_MDCpopupFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	//svar wMDCstr, enMDCstr  if (stringmatch(popStr,"_none_"))   return -1// User canceled   endif  silent 1 ; pauseupdate   wMDCstr = popStr  enMDCstr = "en"+ popStr[1,inf]  InputMDC ()	showMDC ()  EndFunction showInputIm (ctrlName) : ButtonControl	String ctrlName	string panelname="InputImPanel"	Svar ImXstr, ImYstr	string ImYstr_copy="InputImy", ImXstr_copy="InputImx"	variable MaxSig, MinSig	if (stringmatch(ImXstr,"")==1 || stringmatch(ImYstr,"")==1)	 abort "Input ImX and ImY!!"	endif	duplicate/o $ImXstr $ImXstr_copy	duplicate/o $ImYstr $ImYstr_copy      dowindow/f $panelname    if (v_flag==1)   	wavestats/q $ImYstr_copy		MaxSig = V_max*1.3		MinSig = -0.01		SetAxis left MinSig, MaxSig		SetAxis bottom -1,0.1	endif 	if (v_flag!=1)		Display /W=(272,368,707,606) $ImYstr_copy vs $ImXstr_copy		ModifyGraph width=347,height=178		ModifyGraph width=0,height=0		ModifyGraph tick=2		ModifyGraph zero=3		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		ModifyGraph axOffset(left)=-0.857143		Label left "Input Im (eV)"		Label bottom "Energy (eV)"  	 	wavestats/q $ImYstr_copy		MaxSig = V_max*1.3		MinSig = -0.01		SetAxis left MinSig, MaxSig		SetAxis bottom -1,0.1		dowindow/c $panelname endifEndProc ChoseInputIm (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked    InputImCheck = checked    if (InputImCheck == 1)      if (stringmatch(ImXstr,"")==1 || stringmatch(ImYstr,"")==1)        abort "No Input Im!!"      endif         makeIm_interp (ImYstr,ImXstr, "ImInterp")         ModifyIm ()         else         InputMDC ()         makeIm_interp ("wMDCwave", "enMDCwave", "ImInterp")         ModifyIm ()    endifEndProc ChoseDaraModel (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   DataModelCheck = checked   InputMDC ()EndProc UpdateFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName  if (InputImCheck != 1)	  InputMDC ()	  makeIm_interp ("wMDCwave", "enMDCwave", "ImInterp")    ModifyIm ()  endifend Function ModifysigmaProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Modifysigma ()endFunction 	Modifysigma ()   Nvar SelfMap_C   string Re_Result="ReResult", Im_Result="ImResult"   string Re_Result_Modify="ReResult_Modify", Im_Result_Modify="ImResult_Modify"   duplicate/o $Re_Result  temp   duplicate/o $Im_Result  temp1   temp/=SelfMap_C   temp1/=SelfMap_C   duplicate/o temp $Re_Result_modify     duplicate/o temp1 $Im_Result_modify  endProc calcReSigma (ctrlName) : ButtonControl	String ctrlName	string panelname="SigmaPanel"	variable E_i=-1*selfmap_Erange-0.01 , E_f	variable E, waveNum, n, enMDCNum, EiEf	string BaseImSig="wMDCInterp", EEwave="Ewave"	string ReSig="ReResult", ImSig="ImResult"	string Re_Result="ReResult_modify", Im_Result="ImResult_modify"	variable MaxSig, MinSig	silent 1; pauseupdate    if (InputImCheck == 1)       makeIm_interp (ImYstr,ImXstr, "ImInterp")       ModifyIm ()    else (InputImCheck != 1)       InputMDC ()       makeIm_interp ("wMDCwave", "enMDCwave", "ImInterp")       ModifyIm ()    endif		duplicate/o $ImSig, $ReSig, $EEwave,temp   $EEwave() = x	 E = $EEwave[x2pnt($EEwave,E_i)]	 E_f = (-1)*E_i	    SelfMap_VF_Erange = pnt2x($BaseImSig,0)    $ReSig = nan   n = x2pnt($ReSig,E_f) - x2pnt($ReSig,E) do		temp() = $ImSig(x)/(x-E)	temp(E) = 0	$ReSig(E) = (-1)*area(temp,-inf,inf)/pi	n = x2pnt($ReSig,0) - x2pnt($ReSig,E)   if (trunc(n/50) == n/50)   print n   endif	E+=DimDelta($ReSig,0)   while (E<=DimDelta($ReSig,0))   duplicate/o $ReSig temp   $ReSig(DimDelta($ReSig,0),E_f) = (-1)*temp(-x)   Modifysigma ()  dowindow/f $panelname if (v_flag==1) 	wavestats/q $Im_Result	MaxSig = V_max*1.3   wavestats/q $Re_Result	MinSig = V_min*1.3	SetAxis left MinSig, MaxSig	SetAxis bottom -1,1 endif  if (v_flag!=1)	Display /W=(272,368,707,606) $Re_Result, $Im_Result	ModifyGraph width=347,height=178	ModifyGraph width=0,height=0	ModifyGraph rgb($Re_Result)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.857143	TextBox/C/N=aupname/F=0/A=MC/X=0/Y=38.62 "\\Z16Sigma (eV)"	Label left "Im, Re (eV)"	Label bottom "Energy (eV)"	wavestats/q $Im_Result	MaxSig = V_max*1.3   wavestats/q $Re_Result	MinSig = V_min*1.3	SetAxis left MinSig, MaxSig	SetAxis bottom -1,1	dowindow/c $panelname endifendProc LinearBand (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   LinearBandCheck = checked  if (InputImCheck != 1)  	 InputMDC ()  	 makeIm_interp ("wMDCwave", "enMDCwave", "ImInterp")  	 ModifyIm ()  endifEndproc VFmodiFunc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	variable aa=3.82   SelfMap_VF = SelfMap_VF_eVA*(pi/aa)   makeIm_interp ("wMDCwave", "enMDCwave", "ImInterp")   ModifyIm ()Endproc showIm_eV_proc (ctrlName) : ButtonControl	String ctrlName	string panelname="ImInputPanel", ImSigma="ImResult"	variable MaxSig, MinSig    if (InputImCheck == 1)      if (stringmatch(ImXstr,"")==1 || stringmatch(ImYstr,"")==1)         abort "No Input Im!!"      endif       makeIm_interp (ImYstr,ImXstr, "ImInterp")       ModifyIm ()    else (InputImCheck != 1)       InputMDC ()       makeIm_interp ("wMDCwave", "enMDCwave", "ImInterp")       ModifyIm ()    endif	  silent 1 ; pauseupdate    dowindow/f $panelname  if (v_flag == 1)  wavestats/q $ImSigma	MaxSig = V_max*1.3	MinSig = 0	SetAxis left MinSig, MaxSig	SetAxis bottom -1,1	dowindow/c $panelnameendif if (v_flag!=1)	Display /W=(272,368,707,606) $ImSigma	ModifyGraph width=347,height=178	ModifyGraph width=0,height=0	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.857143	TextBox/C/N=aupname/F=0/A=MC/X=0/Y=38.62 "\\Z16Im (eV)"	Label left "Im (eV)"	Label bottom "Energy (eV)"	wavestats/q $ImSigma	MaxSig = V_max*1.3	MinSig = 0  SetAxis left MinSig, MaxSig	wavestats/q $ImSigma	SetAxis bottom -1,1	dowindow/c $panelname endifEndProc makeIm_interp (wMDCstr,enMDCstr,ImSigma)	string  wMDCstr, enMDCstr, ImSigma	string  wMDC_interp="wMDCInterp"	variable Xi=-100,Xf,InterpN=2	variable E, waveNum, n, enMDCNum, EiEf	silent 1; pauseupdate	enMDCNum = numpnts($enMDCstr)	InterpFunc (wMDCstr,enMDCstr,wMDC_interp)		EiEf = abs($enMDCstr[0]-$enMDCstr[enMDCNum-1])	waveNum = (enMDCNum/InterpN)*abs(2*Xi)/EiEf	 Xf = (-1)*Xi	make/o/n=(ceil(waveNum)) $ImSigma   setscale/I x,Xi,Xf,"", $ImSigma	 $ImSigma(Xi,0) = $wMDC_interp(x)	 $ImSigma(0,Xf) = $wMDC_interp(-x)endFunction ModifyIm ()  variable mode	string panelname   variable MaxSig, MinSig, aa=3.82    variable AAA, EE0, VFerange=1   Nvar selfmap_c, selfmap_VF_eVA, SelfMap_VF, SelfMap_kFermi, SelfMap_VF_Erange, LinearBandCheck   Nvar InputImCheck   string ImSigma="ImInterp", ImSigma_result="ImResult"   duplicate/o $ImSigma temp2if (InputImCheck != 1)    temp2*=(pi/aa)   if (LinearBandCheck!=1)   duplicate/o temp2 temp3   temp3 = 0    AAA = abs(SelfMap_VF)/(2*SelfMap_kFermi)    EE0 = (-1)*AAA*(SelfMap_kFermi)^2    if ( abs(SelfMap_VF_Erange) > abs(EE0) )   	 temp3[x2pnt(temp3,EE0),x2pnt(temp3,0)] = 2*(AAA)^0.5*(pnt2x(temp3,p)-EE0)^0.5    	temp3[x2pnt(temp3,0),x2pnt(temp3,abs(EE0))] = 2*(AAA)^0.5*(abs(EE0)-pnt2x(temp3,p))^0.5    	temp3[0,x2pnt(temp3,EE0)] =  0    	temp3[x2pnt(temp3,abs(EE0)),inf] = 0    else    	temp3[x2pnt(temp3,SelfMap_VF_Erange),x2pnt(temp3,0)] = 2*(AAA)^0.5*(pnt2x(temp3,p)-EE0)^0.5    	temp3[x2pnt(temp3,0),x2pnt(temp3,abs(SelfMap_VF_Erange))] = 2*(AAA)^0.5*(abs(EE0)-pnt2x(temp3,p))^0.5    	temp3[0,x2pnt(temp3,SelfMap_VF_Erange)] = 2*(AAA)^0.5*( (SelfMap_VF_Erange) -EE0)^0.5    	temp3[x2pnt(temp3,abs(SelfMap_VF_Erange)),inf] = 2*(AAA)^0.5*( (SelfMap_VF_Erange) -EE0)^0.5     endif    temp3[]/=(pi/aa)    temp2*=temp3[p]  elseif (LinearBandCheck==1)   temp2*=abs(selfmap_VF_eVA)  endifendif   duplicate/o temp2 $ImSigma_resultendFunction InterpFunc (wMDCwave,enMDCwave,wMDC_interp)   string wMDCwave, enMDCwave, wMDC_interp	variable enMDCNum	variable i, j	string wMDCmodify, enMDCmodify	nvar SelfMap_VF_Erange	if ( numpnts($wMDCwave)!=numpnts($enMDCwave) )	   abort "Not same Input wave length!!"	endif	wMDCmodify = wMDCwave + "_modi"	enMDCmodify = enMDCwave + "_modi"	duplicate/o $wMDCwave temp, temp1	duplicate/o $enMDCwave temp2, temp3	for (i=0 ; i<numpnts($wMDCwave) ; i+=1)	  if( numtype(temp1[i]) == 0 && numtype(temp3[i]) == 0 )	     temp[j] = temp1[i]	     temp2[j] = temp3[i]	     j+=1	  endif 	endfor  	duplicate/o temp, $wMDCmodify 	duplicate/o temp2, $enMDCmodify 	enMDCNum = numpnts($enMDCwave)	Interpolate2/T=1/N=(enMDCNum)/Y=$wMDC_interp $enMDCmodify, $wMDCmodify	SelfMap_VF_Erange = pnt2x($wMDC_interp,0)endFunction  InputData ()  svar wMDCstr, enMDCstr  string wMDC="wMDCwave", enMDC="enMDCwave"   Nvar Self_SliceAngle, Self_Piangle  if (stringmatch(wMDCstr,"")==1 || stringmatch(enMDCstr,"")==1)    abort "Input wMDC and enMDC!!"  endif  duplicate/o $enMDCstr $enMDC  duplicate/o $wMDCstr temp  temp*=Self_SliceAngle/Self_Piangle  duplicate/o temp $wMDC endProc ChoseFLMLproc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	silent 1 ; pauseupdate   if (popNum==1)   modeFLML=1  endif   if (popNum==2)    modeFLML=2  endif  if (popNum==3)     modeFLML=3  endif    if (DataModelCheck !=1)  InputParaFLML (modeFLML)   endifEndFunction ErangeSetFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar selfmap_Erange, selfmap_Ei  SetVariable setvarEi,limits={-1*SelfMap_Erange,0,0.1},value= selfmap_EiEndFunction MDCdispersionFunc () wave SelfMap variable i, EF_point0, EF_point1, kiPoint, kfPoint string MDCdispersion = "MDCdispersion", EDCdispersion = "EDCdispersion" string SelfMap_smth = "SelfMap_smth" string Raw="BareDispersion" Nvar SelfMap_Epoints,SelfMap_kpoints Nvar SelfMap_ki,SelfMap_kf Nvar SelfMap_Ei,SelfMap_Ef, LinearBandcheck variable Kstart, kend make/o/n=(SelfMap_kpoints) temp make/o/n=(SelfMap_Epoints) $MDCdispersion, temp1 setscale/I x,SelfMap_ki,SelfMap_kf,"", temp setscale/I x,SelfMap_Ei,SelfMap_Ef,"", $MDCdispersion, temp1  EF_point0 = x2pnt($MDCdispersion,0)  wavestats/q $Raw EF_point1 = x2pnt($MDCdispersion,V_min)  temp1 = nan if (LinearBandcheck!=1)   for (i= EF_point1 ; i<= EF_point0 ; i+=1)    temp = 0   if ( abs(SelfMap_ki) >= abs(SelfMap_kf) )   temp[x2pnt(temp,SelfMap_ki),x2pnt(temp,0)] = SelfMap[i][p]   else   temp[x2pnt(temp,0),x2pnt(temp,SelfMap_kf)] = SelfMap[i][p]   endif   //wavestats/q temp   //temp1[i] = V_maxloc   findpeak/q temp   temp1[i] = V_PeakLoc  endfor elseif (LinearBandcheck==1)   for (i= 0 ; i<= EF_point0 ; i+=1)   temp[] = SelfMap[i][p]      findpeak/q temp      temp1[i] = V_PeakLoc   endfor endif duplicate/o temp1  $MDCdispersion temp = nan kiPoint=x2pnt(temp,temp1[EF_point0]) ; kfPoint=x2pnt(temp, temp1[EF_point1]) Duplicate/O SelfMap,$SelfMap_smth;DelayUpdate Smooth 10, $SelfMap_smth duplicate/o $SelfMap_smth temp3 for (i=min(kiPoint,kfPoint) ; i<max(kiPoint,kfPoint) ; i+=1)   temp1[] = temp3[p][i]   wavestats/q temp1   temp[i] =V_maxloc   //findpeak/q temp1   //temp[i] = V_PeakLoc endfor duplicate/o temp  $EDCdispersionendFunction CreateSelfMap ()	wave SelfMap	string ImSigma="ImResult_Modify", ReSigma="ReResult_Modify"  Nvar SelfMap_Epoints,SelfMap_kpoints  Nvar SelfMap_ki, SelfMap_kf  Nvar SelfMap_Ei, SelfMap_Ef  Nvar SelfMap_VF, SelfMap_T  Nvar SelfMap_VF_eVA  Nvar selfmap_C, SelfMap_kFermi, LinearBandCheck  Nvar gap=SE_gap  variable AA, EE0  string Raw="BareDispersion" variable i, k, E, dE, dk, eV=1.6*10^-19, KB=1.38*10^-23  	make/o/n = 100 temp if (LinearBandCheck!=1)	 setscale/I x,(-1)*abs(SelfMap_kFermi),abs(SelfMap_kFermi),"", temp 	AA = abs(SelfMap_VF)/(2*SelfMap_kFermi) 	EE0 = (-1)*AA*(SelfMap_kFermi)^2 	temp[] = AA*(pnt2x(temp,p))^2+EE0 	duplicate/o temp $Raw elseif (LinearBandCheck==1)   setscale/I x,(-1)*abs(SelfMap_ki),abs(SelfMap_kf),"", temp 	 temp[] = SelfMap_VF*(pnt2x(temp,p)-SelfMap_kFermi) 	 duplicate/o temp $Raw endif  make/o/n=(SelfMap_Epoints,SelfMap_kpoints) SelfMap setscale/I x,SelfMap_Ei,SelfMap_Ef,"", SelfMap setscale/I y,SelfMap_ki,SelfMap_kf,"", SelfMap duplicate/o SelfMap temp make/o/n=(SelfMap_Epoints) temp1 setscale/I x,SelfMap_Ei,SelfMap_Ef,"", temp1 duplicate/o $ImSigma temp2 duplicate/o $ReSigma temp3  variable E0=SelfMap_Ei dE = DimDelta(SelfMap,0) dk = DimDelta(SelfMap,1) variable Ek, vk, uk, E2 for (i=0 ; i<SelfMap_kpoints ; i+=1)   k = SelfMap_ki + dk*i   if (LinearBandCheck!=1)   	E = AA*(k)^2+EE0   elseif (LinearBandCheck==1)  	E = SelfMap_VF*(k-SelfMap_kFermi)   endif	   	Ek=sqrt(E^2+gap^2)   	vk=sqrt(0.5*(1-E/Ek))   	uk=sqrt(0.5*(1+E/Ek))//	SelfMap[][i]=(1/pi)*temp2( pnt2x(SelfMap,p) ) / ( (pnt2x(SelfMap,p)+Ek-temp3(pnt2x(SelfMap,p)) )^2 + ( temp2(pnt2x(SelfMap,p)) )^2 )	SelfMap[][i]=(1/pi)*temp2(E0+p*dE)*( uk^2/((E0+p*dE-Ek-temp3(E0+p*dE))^2+temp2(E0+p*dE)^2) + vk^2/((E0+p*dE+Ek-temp3(E0+p*dE))^2+temp2(E0+p*dE)^2) )	SelfMap[][i]*=1/( 1 + exp( pnt2x(SelfMap,p)/(KB*SelfMap_T/eV) )) endfor  make/o/n=(SelfMap_Epoints) temp make/o/n=(SelfMap_kpoints) temp1 setscale/I x,SelfMap_Ei,SelfMap_Ef,"", temp setscale/I x,SelfMap_ki,SelfMap_kf,"", temp1 temp[]=SelfMap[p][x2pnt(temp1,SelfMap_kFermi)] duplicate/o temp, SelfEDCendFunction showSigmaFunc(ctrlName) : ButtonControl	String ctrlName	string panelname="SigmaPanel", Re_Result="ReResult_Modify", Im_Result="ImResult_Modify"	Nvar selfmap_c, selfmap_VF_eVA	Svar ReSigma, ImSigma   variable MaxSig, MinSig   dowindow/f $panelname  if (v_flag==1)  		wavestats/q $Im_Result		MaxSig = V_max*1.3   	wavestats/q $Re_Result		MinSig = V_min*1.3		SetAxis left MinSig, MaxSig		SetAxis bottom -1,1	endif if (v_flag!=1)	Display /W=(272,368,707,606) $Re_Result, $Im_Result	ModifyGraph width=347,height=178	ModifyGraph width=0,height=0	ModifyGraph rgb($Re_Result)=(0,0,65535)	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.857143	TextBox/C/N=aupname/F=0/A=MC/X=0/Y=38.62 "\\Z16Sigma (eV)"	Label left "Im, Re (eV)"	Label bottom "Energy (eV)"	wavestats/q $Im_Result	MaxSig = V_max*1.3   wavestats/q $Re_Result	MinSig = V_min*1.3	SetAxis left MinSig, MaxSig	SetAxis bottom -1,1	dowindow/c $panelname endifEndFunction SelfMap_ValmenuFunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr		if ( popnum==1 ) 		SetVariable SelfMapVF, limits={-Inf,Inf,0.01}		endif	  if ( popnum==2 ) 		SetVariable SelfMapVF, limits={-Inf,Inf,0.1}		endif		if ( popnum==3 ) 		SetVariable SelfMapVF, limits={-Inf,Inf,1}		endifEndFunction SelfMapshowFunc (ctrlName) : ButtonControl	String ctrlName	Nvar SelfMap_ki, SelfMap_kf   Nvar SelfMap_Ei, SelfMap_Ef	string panelname="SelfMapPanel", MDCdispersion = "MDCdispersion"	string panelname2="SelfMapEDC"	string EDCdispersion = "EDCdispersion"	wave selfmap, SelfEDC	string Raw="BareDispersion"  CreateSelfMap()  MDCdispersionFunc()    dowindow/f $panelname  if (v_flag !=1)  	Display /W=(439,322,775,693)	AppendImage SelfMap	ModifyImage SelfMap ctab= {*,*,Rainbow,1}	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-0.266667,axOffset(bottom)=-2.14286	Label left "\\f02k\\B\\M\\f00 / \\F'Symbol'p"	Label bottom "Energy (eV)"	ShowInfo	SetAxis left SelfMap_ki, SelfMap_kf	SetAxis bottom SelfMap_Ei, SelfMap_Ef	ModifyGraph swapXY=1	appendtograph/VERT $Raw	appendtograph $MDCdispersion	appendtograph/vert $EDCdispersion	ModifyGraph rgb($Raw)=(0,0,0)	ModifyGraph rgb($MDCdispersion)=(65535,65535,65535)	ModifyGraph rgb($EDCdispersion)=(21845,21845,21845)  dowindow/c $panelname  endif    dowindow/f $panelname2  if (v_flag !=1)    PauseUpdate; Silent 1		// building window...		Display /W=(219,122,645,312) SelfEDC		dowindow/c $panelname2		ModifyGraph tick=2		ModifyGraph zero(bottom)=3		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		Label left "Intensity (arb. units)"		Label bottom "Energy (eV)"  endifEnd////////////////////////////////////////////////////		FS rotation				///////////////////////////////////////////////////Window FS_rotation() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(768,357,1120,772)	ModifyPanel cbRGB=(65535,43688,32768)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 16,26,341,26	DrawRect 176,29,337,95	SetDrawEnv linethick= 2	DrawLine 21,317,341,317	SetDrawEnv linethick= 2	DrawLine 19,365,342,365	DrawText 72,153,"Read"	DrawText 15,194,"Theta"	DrawText 17,216,"Phi"	DrawText 16,172,"Rotation"	DrawText 121,153,"Delta"	SetDrawEnv linethick= 2	DrawLine 19,132,344,132	SetDrawEnv linethick= 2	DrawLine 20,270,345,270	SetDrawEnv linethick= 2	DrawLine 18,224,343,224	DrawText 20,241,"FS Symmetrize"	SetVariable setvar1,pos={20,323},size={113,18},title="ky",value= kywaveRota	SetVariable setvar2,pos={20,341},size={113,18},title="kx",value= kxwaveRota	Button button5,pos={145,320},size={40,20},proc=FSeditFunc,title="Edit"	Button button6,pos={289,320},size={40,20},proc=FSshowFunc,title="show"	SetVariable setvar0,pos={19,69},size={146,18},proc=RotaPlotfunc,title="one slice (deg)"	SetVariable setvar0,limits={0,inf,0.01},value= SliceAngle	SetVariable setvar08,pos={26,274},size={126,18},proc=RotaPlotfunc,title="Psi (deg)"	SetVariable setvar08,limits={-inf,inf,0.5},value= offPsi	SetVariable DeltaTheta,pos={117,178},size={48,18},proc=RotaPlotfunc,title=" "	SetVariable DeltaTheta,limits={-inf,inf,0.5},value= offTheta	SetVariable DeltaPhi,pos={116,201},size={49,18},proc=RotaPlotfunc,title=" "	SetVariable DeltaPhi,limits={-inf,inf,0.5},value= offPhi	Button button05,pos={215,71},size={92,20},proc=MemoFSListFunc,title="memo List"	SetVariable setvar24,pos={182,53},size={142,18},title="memo"	SetVariable setvar24,value= saveNo_memoFS	Button button06,pos={181,32},size={40,20},proc=FSSaveButtonProc,title="Save"	SetVariable setvar14,pos={225,34},size={33,18},proc=MRsaveNoProc,title=" "	SetVariable setvar14,limits={0,20,1},value= saveNo_FS	CheckBox check1,pos={257,35},size={70,15},proc=FSCheckProc,title="AutoLoad"	CheckBox check1,value= 1	SetVariable setvar25,pos={15,4},size={157,18},title=" Base Map "	SetVariable setvar25,value= UseparaFSMapstr	Button button08,pos={185,1},size={40,20},proc=LooksorceMapFunc,title="look"	Button button09,pos={262,293},size={66,20},proc=CreateRotaMap,title="Create"	SetVariable setvar26,pos={24,296},size={208,18},title="New Map"	SetVariable setvar26,value= NewRotaMapName	SetVariable setvar20,pos={196,135},size={125,18},title="Output mesh size"	SetVariable setvar20,limits={1,50,1},value= maltiplesize	Button button4,pos={195,320},size={74,20},proc=FSplotRota,title="Go roation"	CheckBox check2,pos={167,344},size={68,15},proc=AutoRotaCheckProc,title="AutoRota"	CheckBox check2,value= 0	Button button7,pos={269,341},size={63,20},proc=GetPhiFunc,title="Get Phi"	SetVariable DeltaRota,pos={118,156},size={46,18},proc=RotaPlotfunc,title=" "	SetVariable DeltaRota,limits={-inf,inf,0.5},value= offRota	PopupMenu ListGoffset,pos={257,177},size={84,21},proc=FSColorSetproc	PopupMenu ListGoffset,mode=7,popvalue="PlanetEarth",value= #"CTabList()"	CheckBox auto1,pos={293,202},size={47,15},proc=FSInvertCheckProc,title="Invert"	CheckBox auto1,value= 1	Button button07,pos={253,155},size={89,20},proc=RotaMapFunc,title="Go rotation"	Button button13,pos={181,155},size={44,20},proc=FSshowProc,title="Show"	SetVariable setvar23,pos={239,200},size={47,18},proc=FSGammaproc,title="g"	SetVariable setvar23,font="Symbol",limits={0.1,inf,0.1},value= FSGammaVal	Button ButtonGraph3,pos={91,370},size={78,20},proc=Get_Cut,title="Get_Cut"	PopupMenu ListGoffset1,pos={182,176},size={41,21},proc=BrankMapset	PopupMenu ListGoffset1,mode=4,popvalue="Int",value= #"\"nan;inf;zero;Int\""	Button button17,pos={16,370},size={72,20},proc=DrawProc,title="Draw Opt."	Button ButtonGraph1,pos={17,393},size={68,20},proc=HighTcproc,title="CuSC FS"	Button Button15,pos={102,391},size={45,20},proc=Curvaturefunc,title="Curv"	SetVariable setvar27,pos={181,200},size={53,18},title="Int"	SetVariable setvar27,limits={0,inf,1},value= FSBlankInt	SetVariable ReadRota,pos={68,156},size={41,18},title=" "	SetVariable ReadRota,valueBackColor=(56576,56576,56576)	SetVariable ReadRota,limits={-inf,inf,0},value= readRota,noedit= 1	SetVariable ReadTheta,pos={68,178},size={41,18},title=" "	SetVariable ReadTheta,valueBackColor=(56576,56576,56576)	SetVariable ReadTheta,limits={-inf,inf,0},value= readTheta,noedit= 1	SetVariable ReadPhi,pos={68,201},size={41,18},title=" "	SetVariable ReadPhi,valueBackColor=(56576,56576,56576)	SetVariable ReadPhi,limits={-inf,inf,0},value= readPhi,noedit= 1	Button Button16,pos={235,366},size={68,20},proc=ExtractFS,title="KxKy",fSize=14	Button Button16,fStyle=0	SetVariable setvar8,pos={18,106},size={85,18},title="hv (eV)"	SetVariable setvar8,limits={1,inf,1},value= PhotoEnergy	SetVariable setvar10,pos={111,105},size={83,18},title="WF(eV)"	SetVariable setvar10,limits={0,inf,0.1},value= workfunction	SetVariable setvar9,pos={201,106},size={78,18},title="a (A)"	SetVariable setvar9,limits={0,inf,0.1},value= LatticeConstant	PopupMenu popup1,pos={282,105},size={60,21},proc=FS_BZType,title=" "	PopupMenu popup1,mode=1,popvalue="Tetra",value= #"\"Tetra;Hex\""	Button ButtonGraph4,pos={241,388},size={55,22},proc=Calek_ButtonProc,title="Cal_Ek"	Button ButtonGraph4,fStyle=1	PopupMenu popup0,pos={21,243},size={97,21},proc=FSChoosemode,title="Mode"	PopupMenu popup0,mode=5,popvalue="rot6fold",value= #"\"mirrorLeft;mirrorRight;rot3fold;rot4fold;rot6fold;rot8fold\""	SetVariable setvar3,pos={125,245},size={76,18},proc=FSsetAngle,title=" Angle"	SetVariable setvar3,limits={-360,360,5},value= FSsection	Button button0,pos={213,237},size={30,27},proc=FSsymGo,title="Go"	Button button1,pos={273,241},size={47,21},proc=FSrmlines,title="remove"	SetVariable setvar4,pos={20,40},size={146,18},proc=RotaPlotfunc,title="angle  step (deg)"	SetVariable setvar4,limits={0,inf,0.01},value= RotaXspacingEndMacrofunction Curvaturefunc (ctrlName) : ButtonControl	String ctrlNamesvar dispwavewave dup_wavevariable wavenumber, high_binding, low_binding, stepstring wave_namevariable i, j	Prompt wavenumber, "wave number"	Prompt high_binding, "high energy"	Prompt low_binding, "low energy"	Prompt step, "energy step"	Doprompt "Enter", wavenumber, high_binding, low_binding	if(V_Flag)		return -1	endif	wave_name=dispwave+num2str(wavenumber)	duplicate/o $wave_name dup_wave//	 ww[i]=mpf2_autompfit("ruijiang","Lorentzian","peakcoefs%d","None","abc","temp_rui1","",5)	End       Proc HighTcproc (ctrlName) : ButtonControl	String ctrlName	dowindow/f HighTc	if (V_flag!=1)	HighTc ()	endifEndWindow HighTc() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(1174,439,1499,710)	SetDrawLayer UserBack	DrawRect 6,5,318,200	DrawText 109,65,"1"	DrawText 109,81,"[cos(kx)+cos(ky)]/2"	DrawText 109,97,"[cos(kx)cos(ky)]"	DrawText 109,113,"[cos(2kx)+cos(2ky)]/2"	DrawText 109,130,"[cos(2kx)cos(ky)+cos(2kx)cos(2ky)]/2"	DrawText 109,146,"[cos(2kx)cos(2ky)]"	Button button0,pos={211,206},size={88,20},proc=showRotaFunc,title="show FS 1/4"	Button button1,pos={211,226},size={89,20},proc=showRotaFSFunc,title="show FS All"	SetVariable setvar7,pos={14,52},size={87,18},proc=FSCalc,title="C0"	SetVariable setvar7,limits={-inf,inf,0.01},value= bt0	SetVariable setvar8,pos={14,68},size={87,18},proc=FSCalc,title="C1"	SetVariable setvar8,limits={-inf,inf,0.01},value= bt1	SetVariable setvar9,pos={14,84},size={86,18},proc=FSCalc,title="C2"	SetVariable setvar9,limits={-inf,inf,0.01},value= bt2	SetVariable setvar04,pos={14,100},size={86,18},proc=FSCalc,title="C3"	SetVariable setvar04,limits={-inf,inf,0.01},value= bt3	SetVariable setvar05,pos={14,117},size={86,18},proc=FSCalc,title="C4"	SetVariable setvar05,limits={-inf,inf,0.01},value= bt4	SetVariable setvar06,pos={14,134},size={86,18},proc=FSCalc,title="C5"	SetVariable setvar06,limits={-inf,inf,0.01},value= bt5	PopupMenu popup1,pos={62,30},size={68,21},proc=FScuprateProc,title=" "	PopupMenu popup1,mode=3,popvalue="Bi2201",value= #"\"Bi2212;LSCO;Bi2201\""	SetVariable setvar21,pos={95,11},size={52,18},proc=FSPiangleFunc,title="Pi"	SetVariable setvar21,limits={1,inf,1},value= PiAngle	SetVariable setvar13,pos={13,11},size={78,18},proc=FSsizeProc,title="TBsize"	SetVariable setvar13,value= TBsize	Button button8,pos={202,152},size={44,20},proc=GetpFunc,title="Get p"	SetVariable setvar16,pos={250,154},size={63,18},disable=2,title="p"	SetVariable setvar16,value= p_value	Button button9,pos={19,227},size={74,20},proc=GetThetaFunc,title="Get Theta"	SetVariable setvar17,pos={12,249},size={82,18},disable=2,title="Theta"	SetVariable setvar17,value= Theta	SetVariable setvar18,pos={103,227},size={99,18},proc=GapsizeFunc,title="gap (meV)"	SetVariable setvar18,value= GapMaxDwave	Button button2,pos={126,206},size={70,20},proc=showGapsymfunc,title="Gap (deg)"	SetVariable setvar19,pos={119,243},size={83,18},proc=GapsizeFunc,title="B"	SetVariable setvar19,limits={0,1,0.01},value= GapBvalue	Button button3,pos={19,206},size={75,20},proc=CutvsdegFunc,title="Cut vs deg"	Button button11,pos={153,153},size={43,20},proc=GoTBfitProc2,title="TB fit"	Button button12,pos={14,154},size={53,20},proc=AddTBFSfunc,title="Add FS"	CheckBox check0,pos={242,17},size={70,15},proc=TBCheckProc,title="AutoLoad"	CheckBox check0,value= 1	Button button03,pos={267,34},size={32,20},proc=MemoListFunc,title="List"	SetVariable setvar12,pos={203,16},size={33,18},proc=FSsaveNoProc,title=" "	SetVariable setvar12,limits={0,50,1},value= saveNo	Button button04,pos={162,14},size={36,20},proc=TBSaveButtonProc,title="Save"	SetVariable setvar22,pos={151,37},size={111,18},proc=MemoFunc,title="memo"	SetVariable setvar22,value= saveNo_memo	Button button10,pos={14,29},size={44,20},proc=TBshowProc,title="Show"	Button button13,pos={15,176},size={53,20},proc=AddSBFSfunc,title="Add SB"	Button button14,pos={73,156},size={53,20},proc=AddSSFSfunc,title="Add SS"	SetVariable SSVecotr,pos={71,177},size={75,18},proc=calcSSFS,title="Q_ss"	SetVariable SSVecotr,limits={-inf,inf,0.01},value= SSvector	Button button15,pos={151,176},size={53,20},proc=RMSBFSfunc,title="rmSB"	Button button16,pos={207,176},size={53,20},proc=RMSSFSfunc,title="rm SS"EndMacroFunction BrankMapset (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar FSbrankstr    FSbrankstr = popStrEndFunction FSGammaproc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName     FSColorSetfunc ()EndFunction FS_BZType(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar BZType	BZType=popStr	  dowindow/f RotatedMapping	 if (V_flag==1)	 print BZType		AddBZlines(BZType)	endifEndFunction RotaMapFunc (ctrlName) : ButtonControlString ctrlNameSvar UseparaFSMapstr, FSbrankstrNvar offRota,offphi,offtheta,readRota,readPhi, readTheta,RotaXspacing,SliceAngle,maltiplesize,RotaAngle,FSBlankInt, LatticeConstant, Workfunction, PhotoEnergystring baseMat,resultvariable ANG, MaxK, sizeX, sizeY, firstX, dX, firstY, dY , baseXvale, baseYvale, lastX, lastYvariable maxXYsize,maxXYvalue,midY,i,j,Psi,Phi,thetavariable termX1,termX2,termX3,termY1,termY2,termY3,termZ1,termZ2,termZ3wave FSColorCTif(PhotoEnergy<10)MaxK=1.5elseMaxK=3endif// Adjust size of Map output make/o/n=(maltiplesize*100,maltiplesize*100 ) tempsetscale/I x, -MaxK, MaxK, "" tempsetscale/I y, -MaxK, MaxK, "" temp// Make brank Mapif (stringmatch(FSbrankstr,"nan")==1)	temp=nan elseif (stringmatch(FSbrankstr,"inf")==1)	temp=infelseif (stringmatch(FSbrankstr,"zero")==1)	temp=0 elseif (stringmatch(FSbrankstr,"Int")==1)	temp=FSBlankIntendif// Adjust Map unit to degreebaseMat=UseparaFSMapstrduplicate/o $baseMat temp1sizeX=dimsize($baseMat,0)sizeY=dimsize($baseMat,1)dX = RotaXspacing*DimDelta($baseMat,0) dY = SliceAngle*DimDelta($baseMat,1) firstY = DimOffset($baseMat,1)midY= firstY+dy*(sizeY-1)/2RotaAngle=readRota-offRotareadTheta=DimOffset($baseMat,0)// Unit change to kx and kymake/o/n=(sizeY) Ywave,Zwave,x2wave,y2wave, temp2setscale/I x, -midY, midY, "" Ywave,ZwaveYwave[] = sin(pnt2x(Ywave,p)*pi/180)*getKval(PhotoEnergy, Workfunction, LatticeConstant)Zwave[] = cos(pnt2x(Zwave,p)*pi/180)*getKval(PhotoEnergy, Workfunction, LatticeConstant)//Psi = (readTheta-offTheta)*(pi/180)Psi =0Phi = (readPhi-offphi)*(pi/180)    for (i=0 ; i<=sizeX; i+=1)	temp2[] = temp1[i][p]   Theta=-(DimOffset($baseMat,0)+dx*i-offtheta) *(pi/180)      termX1=cos(Psi)*cos(Theta)-cos(Phi)*sin(Theta)*sin(Psi)	termX2=cos(Psi)*sin(Theta)+cos(Phi)*cos(Theta)*sin(Psi)	termX3=sin(Psi)*sin(Phi)	   termY1=-sin(Psi)*cos(Theta)-cos(Phi)*sin(Theta)*cos(Psi)	termY2=-sin(Psi)*sin(Theta)+cos(Phi)*cos(Theta)*cos(Psi)	termY3=cos(Psi)*sin(Phi)			termZ1=sin(Phi)*sin(Theta)	termZ2=-sin(Phi)*cos(Theta)	termZ3=cos(Phi)	x2wave[] = termX2*Zwave[p]+termX3*Ywave[p]	y2wave[] = termZ2*Zwave[p]+termZ3*Ywave[p]	for (j=0 ; j<=sizeY ; j+=1) 		temp[x2pnt(temp,x2wave[j])][x2pnt(temp,y2wave[j])] = temp2[j]	endforendforduplicate/o temp FSrotamap// Map rotationif (RotaAngle != 0) 	ANG=RotaAngle*pi/180	FSrotamap[][]=temp(pnt2x(FSrotamap,p)*cos(-ANG)-pnt2x(FSrotamap,q)*sin(-ANG))(pnt2x(FSrotamap,p)*sin(-ANG)+pnt2x(FSrotamap,q)*cos(-ANG))endifShowRotaMapping()endFunction RotaMapFunc_back (ctrlName) : ButtonControlString ctrlNameSvar UseparaFSMapstr, FSbrankstrNvar offpsi,offphi,offtheta,RotaXspacing,SliceAngle,maltiplesize,MapRotaPiangle,RotaAnglestring baseMat,resultvariable ANG, MaxK=4, sizeX, sizeY, firstX, dX, firstY, dY , baseXvale, baseYvale, lastX, lastYvariable maxXYsize,maxXYvalue,midY,i,j,Psi,Phi,thetavariable termX1,termX2,termX3,termY1,termY2,termY3wave FSColorCT// Adjust size of Map output make/o/n=(maltiplesize*100,maltiplesize*100 ) tempsetscale/I x, -MaxK, MaxK, "" tempsetscale/I y, -MaxK, MaxK, "" temp// Make brank Mapif (stringmatch(FSbrankstr,"nan")==1)	temp=nan elseif (stringmatch(FSbrankstr,"inf")==1)	temp=infelseif (stringmatch(FSbrankstr,"zero")==1)	temp=0 endif// Adjust Map unit to degreebaseMat=UseparaFSMapstrduplicate/o $baseMat temp1sizeX=dimsize($baseMat,0)sizeY=dimsize($baseMat,1)dX = RotaXspacing*DimDelta($baseMat,0) dY = SliceAngle*DimDelta($baseMat,1) firstY = DimOffset($baseMat,1)midY= firstY+dy*(sizeY-1)/2// Unit change to kx and kymake/o/n=(sizeY) Ywave,Zwave,x2wave,y2wave, temp2setscale/I x, -midY, midY, "" Ywave,ZwaveYwave[] = sin(pnt2x(Ywave,p)*pi/180) / sin(MapRotaPiangle*pi/180)Zwave[] = cos(pnt2x(Zwave,p)*pi/180) / sin(MapRotaPiangle*pi/180)Psi = offpsi*(pi/180)Phi =- offphi*(pi/180)    for (i=0 ; i<=sizeX; i+=1)	temp2[] = temp1[i][p]   Theta= (DimOffset($baseMat,0)+dx*i+offtheta) *(pi/180)   termX1=cos(Psi)*cos(Theta)-cos(Phi)*sin(Theta)*sin(Psi)	termX2=cos(Psi)*sin(Theta)+cos(Phi)*cos(Theta)*sin(Psi)	termX3=sin(Psi)*sin(Phi)	termY1=sin(Phi)*sin(Theta)	termY2=-sin(Phi)*cos(Theta)	termY3=cos(Phi)	x2wave[] = termX2*Zwave[p]+termX3*Ywave[p]	y2wave[] = termY2*Zwave[p]+termY3*Ywave[p]	//x2wave[] = termX2*Zwave[p]+termX3*Ywave[p]	//y2wave[] = termY2*Zwave[p]+termY3*Ywave[p]	for (j=0 ; j<=sizeY ; j+=1) 		temp[x2pnt(temp,x2wave[j])][x2pnt(temp,y2wave[j])] = temp2[j]	endforendforduplicate/o temp FSrotamap// Map rotationif (RotaAngle != 0) 	ANG=RotaAngle*pi/180	FSrotamap[][]=temp(pnt2x(FSrotamap,p)*cos(-ANG)-pnt2x(FSrotamap,q)*sin(-ANG))(pnt2x(FSrotamap,p)*sin(-ANG)+pnt2x(FSrotamap,q)*cos(-ANG))endifdowindow/f RotatedMappingif (V_flag==1)  FSColorSetfunc ()  ModifyImage FSrotamap cindex= FSColorCTendifif (V_flag!=1)  display/W=(279,112,683,496);   dowindow/c RotatedMapping  AppendImage FSrotaMap  //ColorTab2Wave Rainbow  ColorTab2Wave Grays  duplicate/o M_colors FSColorCT  ModifyImage FSrotamap cindex= FSColorCT // ModifyImage FSrotaMap ctab= {*,*,Rainbow,1};DelayUpdate	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-2,axOffset(bottom)=-0.4	Label left "\\f02k\\By\\M\\f00 / \\F'Symbol'p"	Label bottom "\\f02k\\Bx\\M\\f00 / \\F'Symbol'p"endifendFunction FSChoosemode(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	nvar FSSymMode	FSSymMode=popNum	FSsectionline()EndFunction FSsetAngle(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	FSsectionline()End	Function FSsectionline()	nvar FSsection	nvar FSSymMode	wave FSsecLine1y	wave FSsecLine1x	wave FSsecLine2y	wave FSsecLine2x	variable lenght=5	variable anglewidth	if(FSSymMode<3)			anglewidth=180			endif	if(FSSymMode==3)			anglewidth=120		endif	if(FSSymMode==4)			anglewidth=90		endif	if(FSSymMode==5)			anglewidth=60			endif	if(FSSymMode==6)			anglewidth=45			endif	FSsecLine1y[1]=lenght*sin(FSsection/180*pi)	FSsecLine1x[1]=lenght*cos(FSsection/180*pi)	FSsecLine2y[1]=lenght*sin((FSsection+anglewidth)/180*pi)	FSsecLine2x[1]=lenght*cos((FSsection+anglewidth)/180*pi)	dowindow/f RotatedMapping	if(v_flag==0)		print "Calculate FSrotamap first!"	else		removefromgraph/z FSsecLine1y		removefromgraph/z FSsecLine2y		appendtograph FSsecLine1y vs FSsecLine1x		appendtograph FSsecLine2y vs FSsecLine2x		ModifyGraph lsize(FSsecLine1y)=2,lsize(FSsecLine2y)=2	endifEndFunction FSrmlines(ctrlName) : ButtonControl	String ctrlName	dowindow/f RotatedMapping	if(v_flag==1)		removefromgraph/z FSsecLine1y		removefromgraph/z FSsecLine2y	endifendFunction FSsymGo(ctrlName) : ButtonControl	String ctrlName	nvar FSSymMode	nvar FSsection	wave FSrotamap	duplicate/o FSrotamap temp2D	variable tempangle	variable ppnum=dimsize(FSrotamap,0)	variable qqnum=dimsize(FSrotamap,1)	variable xx, yy,xx0,yy0,xx1,yy1	variable ppoffset=dimoffset(FSrotamap,0)	variable qqoffset=dimoffset(FSrotamap,1)	variable ppdelta=dimdelta(FSrotamap,0)	variable qqdelta=dimdelta(FSrotamap,1)	variable pp=0	variable qq=0	variable n=1	variable anglewidth		if(FSSymMode==3)			anglewidth=120		endif	if(FSSymMode==4)			anglewidth=90		endif	if(FSSymMode==5)			anglewidth=60			endif	if(FSSymMode==6)			anglewidth=45			endif	do		xx=ppoffset+ppdelta*pp		qq=0		do				yy=qqoffset+qqdelta*qq		if(FSSymMode<3)			xx1=xx*cos(FSsection*pi/180)-yy*sin(FSsection*pi/180)			yy1=xx*sin(FSsection*pi/180)+yy*cos(FSsection*pi/180)				if(FSSymMode==2)			yy1=abs(yy1)			else			yy1=-abs(yy1)			endif			xx0=xx1*cos(-FSsection*pi/180)-yy1*sin(-FSsection*pi/180)			yy0=xx1*sin(-FSsection*pi/180)+yy1*cos(-FSsection*pi/180)			else					tempangle=atan(yy/xx)*180/pi+360			if(xx<0)				tempangle+=180			endif			n=ceil((FSsection+720-tempangle)/anglewidth)			xx0=xx*cos(n*anglewidth*pi/180)-yy*sin(n*anglewidth*pi/180)			yy0=xx*sin(n*anglewidth*pi/180)+yy*cos(n*anglewidth*pi/180)					endif			temp2D[pp][qq]=FSrotamap(xx0)(yy0)				qq+=1		while(qq<qqnum)		pp+=1	while(pp<ppnum)	duplicate/o temp2D FSrotamapEndFunction FSColorSetproc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar FScolor    FScolor = popStr    FSColorSetfunc ()EndFunction 	FSColorSetfunc ()	variable size, maxVal, minVal   Nvar FSGammaval, FSInvertCheck   wave M_colors   Svar FScolor      ColorTab2Wave $FScolor      duplicate/o M_colors FSColorCT      size = dimsize(FSColorCT,0)        FSColorCT[][] = M_colors[size*(p/size)^FSGammaval][q]       wavestats/q FSrotamap       maxVal = V_max       minVal = V_min       if (FSInvertCheck==0)          setScale/I x,minVal,maxVal,"",FSColorCT        elseif (FSInvertCheck==1)         setScale/I x,maxVal,minVal,"",FSColorCT        endifendFunction FSInvertCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   Nvar FSInvertCheck   FSInvertCheck = checked   FSColorSetfunc ()EndFunction FSshowProc (ctrlName) : ButtonControlString ctrlName dowindow/f RotatedMapping end  Function ShowRotaMapping()  dowindow/f RotatedMapping if (V_flag!=1)  	display/W=(279,112,683,496);   	dowindow/c RotatedMapping  	svar BZType	AddBZlines(BZType)  	AppendImage FSrotaMap  	//ColorTab2Wave Rainbow 	 ColorTab2Wave Grays  	duplicate/o M_colors FSColorCT  	ModifyImage FSrotamap cindex= FSColorCT 	 ModifyImage FSrotamap ctab= {*,*,PlanetEarth,1} // ModifyImage FSrotaMap ctab= {*,*,Rainbow,1};DelayUpdate	ModifyGraph tick=2	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	ModifyGraph axOffset(left)=-2,axOffset(bottom)=-0.4	Label left "\\f02k\\By\\M\\f00 / \\F'Symbol'p"	Label bottom "\\f02k\\Bx\\M\\f00 / \\F'Symbol'p"		SetAxis left -3,3	SetAxis bottom -3,3	endifendFunction AddBZlines(bztype)string bztypestring FSlinelist=TraceNameList("", ";", 1 )	string tempname	variable n=ItemsInList(FSlinelist)//	dowindow/f RotatedMapping//	if(V_flag==1)		do		tempname=StringFromList(n,  FSlinelist)		if (stringmatch(tempname, "BZline*")==1)				RemoveFromGraph $tempname		endif		n=n-1				while(n>-1)//	endifif(stringmatch(bztype,"Tetra")==1)  	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	AppendToGraph BZlinetetraY vs BZlinetetraX	ModifyGraph offset(BZlinetetraY#1)={2,0}, offset(BZlinetetraY#2)={0,2}, offset(BZlinetetraY#3)={2,2}, offset(BZlinetetraY#4)={-2,0}, offset(BZlinetetraY#5)={0,-2}, offset(BZlinetetraY#6)={-2,-2}, offset(BZlinetetraY#7)={2,-2}, offset(BZlinetetraY#8)={-2,2}	ModifyGraph lsize=1.5		AppendToGraph BZlinetetraDiagY1,BZlinetetraDiagY2 vs BZlinetetraDiagX	AppendToGraph BZlinetetraDiagY1,BZlinetetraDiagY2 vs BZlinetetraDiagX	AppendToGraph BZlinetetraDiagY1,BZlinetetraDiagY2 vs BZlinetetraDiagX	ModifyGraph offset(BZlinetetraDiagY1#1)={1,-1},offset(BZlinetetraDiagY2#1)={1,1}	ModifyGraph offset(BZlinetetraDiagY1#2)={-1,1},offset(BZlinetetraDiagY2#2)={-1,-1}	ModifyGraph lstyle(BZlinetetraDiagY1)=7,lstyle(BZlinetetraDiagY2)=7	ModifyGraph lstyle(BZlinetetraDiagY1#1)=7,lstyle(BZlinetetraDiagY2#1)=7	ModifyGraph lstyle(BZlinetetraDiagY1#2)=7,lstyle(BZlinetetraDiagY2#2)=7	AppendToGraph BZlinetetraVY  vs BZlinetetraVX	AppendToGraph BZlinetetraVY  vs BZlinetetraVX	AppendToGraph BZlinetetraVY  vs BZlinetetraVX	ModifyGraph offset(BZlinetetraVY#1)={0,-2}, offset(BZlinetetraVY#2)={0,2}	ModifyGraph lstyle(BZlinetetraVY#1)=7,lstyle(BZlinetetraVY#2)=7,lstyle(BZlinetetraVY)=7		AppendToGraph BZlinetetraHY  vs BZlinetetraHX	AppendToGraph BZlinetetraHY  vs BZlinetetraHX	AppendToGraph BZlinetetraHY  vs BZlinetetraHX	ModifyGraph offset(BZlinetetraHY#1)={-2,0}, offset(BZlinetetraHY#2)={2,0}	ModifyGraph lstyle(BZlinetetraHY#1)=7,lstyle(BZlinetetraHY#2)=7,lstyle(BZlinetetraHY)=7		ModifyGraph rgb=(0,0,0)endifif(stringmatch(bztype,"Hex")==1)	AppendToGraph BZlinehexY vs BZlinehexXp	AppendToGraph BZlinehexY vs BZlinehexXp	AppendToGraph BZlinehexY vs BZlinehexXp	AppendToGraph BZlinehexY vs BZlinehexXp	ModifyGraph offset(BZlinehexY#1)={2,0},offset(BZlinehexY#2)={-2,0}, offset(BZlinehexY#3)={-4,0}		AppendToGraph BZlinehexY vs BZlinehexXn	AppendToGraph BZlinehexY vs BZlinehexXn	AppendToGraph BZlinehexY vs BZlinehexXn	AppendToGraph BZlinehexY vs BZlinehexXn	ModifyGraph offset(BZlinehexY#5)={-2,0},offset(BZlinehexY#6)={2,0}, offset(BZlinehexY#7)={4,0}		ModifyGraph lsize=1.5		AppendToGraph BZlinehexDiage1Y vs BZlinehexDiage1X	AppendToGraph BZlinehexDiage2Y vs BZlinehexDiage2X	AppendToGraph BZlinehexDiage3Y vs BZlinehexDiage3X		AppendToGraph BZlinehexDiage1Y vs BZlinehexDiage1X	AppendToGraph BZlinehexDiage2Y vs BZlinehexDiage2X	AppendToGraph BZlinehexDiage3Y vs BZlinehexDiage3X		AppendToGraph BZlinehexDiage1Y vs BZlinehexDiage1X	AppendToGraph BZlinehexDiage2Y vs BZlinehexDiage2X	AppendToGraph BZlinehexDiage3Y vs BZlinehexDiage3X		AppendToGraph BZlinehexDiage1Y vs BZlinehexDiage1X	AppendToGraph BZlinehexDiage2Y vs BZlinehexDiage2X	AppendToGraph BZlinehexDiage3Y vs BZlinehexDiage3X		AppendToGraph BZlinehexDiage1Y vs BZlinehexDiage1X	AppendToGraph BZlinehexDiage2Y vs BZlinehexDiage2X	AppendToGraph BZlinehexDiage3Y vs BZlinehexDiage3X		ModifyGraph offset(BZlinehexDiage1Y#1)={0,-1.73205*2}, offset(BZlinehexDiage1Y#2)={0,-1.73205}, offset(BZlinehexDiage1Y#3)={0,1.73205}, offset(BZlinehexDiage1Y#4)={0,1.73205*2}	ModifyGraph offset(BZlinehexDiage2Y#1)={-4,0}, offset(BZlinehexDiage2Y#2)={-2,0}, offset(BZlinehexDiage2Y#3)={2,0}, offset(BZlinehexDiage2Y#4)={4,0}	ModifyGraph offset(BZlinehexDiage3Y#1)={-4,0}, offset(BZlinehexDiage3Y#2)={-2,0}, offset(BZlinehexDiage3Y#3)={2,0}, offset(BZlinehexDiage3Y#4)={4,0}			ModifyGraph lstyle(BZlinehexDiage1Y)=3,lstyle(BZlinehexDiage2Y)=3, lstyle(BZlinehexDiage3Y)=3	ModifyGraph lstyle(BZlinehexDiage1Y#1)=3,lstyle(BZlinehexDiage2Y#1)=3, lstyle(BZlinehexDiage3Y#1)=3	ModifyGraph lstyle(BZlinehexDiage1Y#2)=3,lstyle(BZlinehexDiage2Y#2)=3, lstyle(BZlinehexDiage3Y#2)=3	ModifyGraph lstyle(BZlinehexDiage1Y#3)=3,lstyle(BZlinehexDiage2Y#3)=3, lstyle(BZlinehexDiage3Y#3)=3	ModifyGraph lstyle(BZlinehexDiage1Y#4)=3,lstyle(BZlinehexDiage2Y#4)=3, lstyle(BZlinehexDiage3Y#4)=3	ModifyGraph rgb=(0,0,0)endifendproc FSsaveNoProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string TBcoeff	silent 1 ; pauseupdate	saveNo = varNum	if (TBsavecheck)	TBcoeff="TBcoeff"+num2istr(saveNo)   saveNo_memo = memoT[saveNo]	 duplicate/o $TBcoeff temp0	bt0=temp0[0]; bt1=temp0[1]; bt2=temp0[2]; bt3=temp0[3]; bt4=temp0[4]; bt5=temp0[5]; bt6=temp0[6]	d1=temp0[7]	d3=temp0[8]	d4=temp0[9]	d6=temp0[10]	TB_FS ()	endif		if (stringmatch(WinList("TB_Econtour",";",""),"")==1)		TBshowProc("")	endif	MakeCopyOfTrace("TB_Econtour","'TBwave=0'")EndProc ARPESlineFunc ()variable termX1, termX2, termX3variable termY1, termY2, termY3variable termZ1, termZ2, termZ3variable Psi, Theta, PhiTheta=ScientaThetaval*(pi/180)Psi=ScientaPsival*(pi/180)Phi=ScientaPhival*(pi/180)make/o/n=(200) Xwave,Ywave,Zwave,x2wave,y2wave,z2wave SetScale/I x -(pi/180*14),(pi/180*14),"", Xwave,Ywave,Zwave,x2wave,y2wave,z2waveZwave() = cos(x)  Ywave() = sin(x)  //termX1=cos(Psi)*cos(Theta)-cos(Phi)*sin(Theta)*sin(Psi)termX2=cos(Psi)*sin(Theta)+cos(Phi)*cos(Theta)*sin(Psi)termX3=sin(Psi)*sin(Phi)//termZ1=sin(Phi)*sin(Theta)termY2=-sin(Phi)*cos(Theta)termY3=cos(Phi)x2wave[] = termX2*Zwave[p]+termX3*Ywave[p]y2wave[] = termY2*Zwave[p]+termY3*Ywave[p]endmacroFunction CreateRotaMap (ctrlName) : ButtonControl	String ctrlName	Svar NewRotaMapName	string ImName,panelName, descriptor, rotaMap="FSrotaMap"	string ColorCT, YesNo	wave FSColorCT	Nvar FSInvertCheck	if (stringmatch(NewRotaMapName,"")==1)	   abort "Input Map name!!"	endif	if (exists(NewRotaMapName)==1) 	  Prompt YesNo, "Yes or No", popup, "Yes"+";No" 	  DoPrompt "There is this Map name. Do you want to replace?",  YesNo 	   if (stringmatch(YesNo,"No")==1) 	    abort      endif 	endif 	if (V_Flag)   			return -1// User canceled   	endif 	ImName = NewRotaMapName	panelName=NewRotaMapName+"_panel"	ColorCT="ColorCT_"+NewRotaMapName	duplicate/o FSColorCT $ColorCT 	duplicate/o $rotaMap $ImName	Dowindow/f $panelName	if (V_flag==1)	ModifyImage $ImName cindex= $ColorCT	endif	if (V_flag!=1)	 display/W=(279,112,683,496); 	 dowindow /c $panelName	AppendImage $ImName	ModifyImage $ImName cindex= $ColorCT	//ModifyImage $ImName ctab= {*,*,Rainbow,1}	ModifyGraph width={Aspect,1}	ModifyGraph zero=3	textbox/k/n=text0   sprintf descriptor " \\Z16%s ", ImName	Textbox/N=ImName /x=-32/y=40/F=0/A=MC descriptor	ModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdate	Label left "\\f02k\\By\\M\\f00 / \\F'Symbol'p"	Label bottom "\\f02k\\Bx\\M\\f00 / \\F'Symbol'p"  endifEndend	proc MRsaveNoProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string FScoeff	silent 1 ; pauseupdate	saveNo_FS = varNum	if (FSsavecheck)	FScoeff="FScoeff"+num2istr(saveNo_FS)   saveNo_memoFS = memoT_FS[saveNo_FS]	 duplicate/o $FScoeff temp0	 RotaXspacing=temp0[0]	 SliceAngle=temp0[1]  	PhotoEnergy=temp0[2]  	workfunction=temp0[3]  	LatticeConstant=temp0[4]   	readRota=temp0[5]   	readTheta=temp0[6]   	readPhi=temp0[7]   	offRota=temp0[8]   	offTheta=temp0[9]   	offPhi=temp0[10]  	endifEnd////////////////////////////////////////////////////		ARPES line correction					///////////////////////////////////////////////////Window ARPEScorrection() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(1038,388,1304,632)	ShowTools/A	SetDrawLayer UserBack	DrawRect 92,6,256,70	DrawText 23,132,"Rota para (deg)"	DrawText 152,132,"Theta para (deg)"	SetDrawEnv dash= 11	DrawLine 139,123,139,223	Button button0,pos={12,3},size={50,20},proc=showARPESline,title="Show"	SetVariable setvar1,pos={25,158},size={96,18},proc=ARPESlineModi,title="Theta"	SetVariable setvar1,value= ScientaThetaval	SetVariable setvar2,pos={35,177},size={86,18},proc=ARPESlineModi,title="Phi"	SetVariable setvar2,value= ScientaPhival	SetVariable setvar3,pos={153,135},size={80,18},proc=ARPESlineModi,title="from"	SetVariable setvar3,value= ScientaThetaFrom	SetVariable setvar4,pos={168,158},size={69,18},proc=ARPESlineModi,title="to"	SetVariable setvar4,value= ScientaThetaTo	SetVariable setvar6,pos={155,181},size={79,18},proc=ARPESlineModi,title="step"	SetVariable setvar6,value= ScientaThetaStep	Button button1,pos={182,203},size={35,20},proc=GetARPESimage,title="Go"	SetVariable setvar5,pos={14,138},size={107,18},proc=ARPESlineModi,title="rotation"	SetVariable setvar5,value= ScientaRotaAngle	Button button12,pos={15,48},size={53,20},proc=AddFSfunc,title="Add FS"	PopupMenu popup1,pos={8,71},size={80,21},proc=ScientaAnarizer,title=" "	PopupMenu popup1,mode=1,popvalue="SES2002",value= #"\"SES2002;R4000\""	Button button05,pos={126,49},size={97,20},proc=MemoScientaListFunc,title="memo List"	SetVariable setvar24,pos={99,31},size={142,18},title="memo"	SetVariable setvar24,value= saveNo_memoScienta	Button button06,pos={95,10},size={40,20},proc=ScientaSaveButtonProc,title="Save"	SetVariable setvar14,pos={140,12},size={33,18},proc=ScientaSaveNoProc,title=" "	SetVariable setvar14,limits={0,20,1},value= saveNo_FS	CheckBox check1,pos={179,13},size={70,15},proc=ScientaCheckProc,title="AutoLoad"	CheckBox check1,value= 1	Button button13,pos={12,202},size={53,20},proc=CuttoFS,title="CuttoFS"	Button button14,pos={71,203},size={56,19},proc=ShowCutAngle,title="GoHere"	SetVariable setvar8,pos={13,96},size={61,18},proc=ARPESlineModi,title="hv"	SetVariable setvar8,limits={1,inf,1},value= Scientahv	SetVariable setvar10,pos={93,96},size={60,18},proc=ARPESlineModi,title="WF"	SetVariable setvar10,limits={0,inf,0.1},value= Scientawk	SetVariable setvar9,pos={169,97},size={78,18},proc=ARPESlineModi,title="a (A)"	SetVariable setvar9,limits={0,inf,0.1},value= Scientaaa	PopupMenu popup2,pos={11,25},size={60,21},proc=ARPESline_BZType,title=" "	PopupMenu popup2,mode=1,popvalue="Tetra",value= #"\"Tetra;Hex\""	CheckBox check0,pos={68,226},size={61,15},title="AngCali",variable= CaliAngleCKEndMacroProc CuttoFS (ctrlName) : ButtonControl	String ctrlName	dowindow/f RotatedMapping	ARPEScalibration ()	if (V_flag==1)		AppendToGraph y2wave vs x2wave	endifEndProc ShowCutAngle (ctrlName) : ButtonControl	String ctrlName	CalRealAngle()	dowindow/f RealAngle	if (V_flag!=1)		RealAngle()	endifendWindow RealAngle() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(912,684,1058,782)	SetVariable Thetaval,pos={32,13},size={84,18},proc=ARPESlineModi,title="Theta:"	SetVariable Thetaval,limits={-inf,inf,0},value= RealTheta,noedit= 1	SetVariable Phival,pos={30,38},size={86,18},proc=ARPESlineModi,title="Tilt:"	SetVariable Phival,limits={-inf,inf,0},value= RealPhi,noedit= 1	SetVariable Totation,pos={30,63},size={85,18},proc=ARPESlineModi,title="Rotation:"	SetVariable Totation,limits={-inf,inf,0},value= RealRotation,noedit= 1EndMacroFunction CalRealAngle()nvar RealTheta, RealPhi, RealRotationnvar ScientaThetaval, ScientaRotaAngle, ScientaPhival,ScientaPsival, MapRotaPiAngle, offPhi, offRota, offTheta, readPhi, readRota, readThetanvar CaliAngleCKif(CaliAngleCK)variable DeltaPhi=offPhivariable DeltaTheta= offThetavariable Omega=readRota-offRotavariable Phi_Anglevariable Theta_Anglevariable Omega_Angle=ScientaRotaAngle 	DeltaPhi*=pi/180	DeltaTheta*=pi/180	Omega*=pi/180	Omega_Angle*=pi/180variable DeltaOmega=Omega_Angle-Omegavariable x, y, x1,y1x=sin(DeltaTheta)*cos(DeltaPhi)y=-sin(DeltaPhi)x1=cos(DeltaOmega)*x-sin(DeltaOmega)*yy1=sin(DeltaOmega)*x+cos(DeltaOmega)*yPhi_Angle=-asin(y1)*180/piTheta_Angle=asin(x1/sqrt(1-y1^2))*180/piTheta_Angle=round(Theta_Angle*100)/100Phi_Angle=round(Phi_Angle*100)/100	RealTheta=ScientaThetaval+Theta_Angle	RealPhi=ScientaPhival+Phi_Angle	RealRotation=ScientaRotaAngle+offRotaelseRealTheta=ScientaThetaval+offThetaRealPhi=ScientaPhival+offPhiRealRotation=ScientaRotaAngle+offRotaendifendFunction MemoScientaListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "MemoScientaList"	wave/t memoT_Scienta	dowindow/f $panelname	if (v_flag!=1)	edit memoT_Scienta	dowindow/c $panelname	endifend	Function ScientaCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar ScientaSavecheckScientaSavecheck = checkedEndproc ScientaSaveNoProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string coeff	silent 1 ; pauseupdate	saveNo_Scienta = varNum	if (ScientaSavecheck)	coeff="ScientaCoeff"+num2istr(saveNo_Scienta)   saveNo_memoScienta = memoT_Scienta[saveNo_Scienta]	 duplicate/o $coeff temp0	 ScientaPiAngle=temp0[0]	 ScientaRotaAngle=temp0[1]	 ScientaThetaval=temp0[2]	 ScientaPhival=temp0[3]	 ScientaPsival=temp0[4]	 ScientaThetaFrom=temp0[5]	 ScientaThetaTo=temp0[6]	 ScientaThetaStep=temp0[7]	endifEndFunction ScientaSaveButtonProc (ctrlName) : ButtonControl	String ctrlName     NVAR ScientaPiAngle, ScientaRotaAngle, ScientaThetaval, ScientaPhival, ScientaPsival, ScientaThetaFrom, ScientaThetaTo, ScientaThetaStep     NVAR saveNo_Scienta     svar saveNo_memoScienta     string coeff     wave/t memoT_Scienta   coeff="ScientaCoeff"+num2istr(saveNo_Scienta)   make/o/n=8 temp0  temp0 = {ScientaPiAngle, ScientaRotaAngle, ScientaThetaval, ScientaPhival, ScientaPsival, ScientaThetaFrom, ScientaThetaTo, ScientaThetaStep}   duplicate/o temp0 $coeff   memoT_Scienta[saveNo_Scienta] = saveNo_memoScientaEndFunction ScientaAnarizer (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Nvar scientaAngle  if (stringmatch(popStr,"SES2002"))    scientaAngle = 7  elseif (stringmatch(popStr,"R4000"))    scientaAngle = 15  endif  execute "ARPEScalibration ()"end			FUnction AddFSfunc (ctrlName) : ButtonControl	String ctrlName 	wave traceY, traceX	  TBshowProc("")	  MakeCopyOfTrace("TB_Econtour","'TBwave=0'")	  dowindow/f ARPESline  if (v_flag==1)    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX    appendtograph traceY vs traceX       appendtograph traceY vs traceX       appendtograph traceY vs traceX     appendtograph traceY vs traceX       appendtograph traceY vs traceX       appendtograph traceY vs traceX       appendtograph traceY vs traceX         	ModifyGraph offset(traceY#1)={2,0},offset(traceY#2)={-2,0},offset(traceY#3)={0,2}, offset(traceY#4)={0,-2}, offset(traceY#5)={2,2},offset(traceY#6)={2,-2}	ModifyGraph offset(traceY#7)={-2,2},offset(traceY#8)={-2,-2}, offset(traceY#9)={-4,0}, offset(traceY#10)={-4,2}, offset(traceY#11)={-4,-2}, offset(traceY#12)={-4,-4}, offset(traceY#13)={-2,-4}	ModifyGraph offset(traceY#14)={0,-4}, offset(traceY#15)={2,-4}	ModifyGraph lsize(traceY)=1.5,lsize(traceY#1)=1.5,lsize(traceY#2)=1.5 	ModifyGraph lsize(traceY#3)=1.5,lsize(traceY#4)=1.5,lsize(traceY#5)=1.5 	ModifyGraph lsize(traceY#6)=1.5,lsize(traceY#7)=1.5,lsize(traceY#8)=1.5	ModifyGraph lsize(traceY#9)=1.5,lsize(traceY#10)=1.5,lsize(traceY#11)=1.5 	ModifyGraph lsize(traceY#12)=1.5,lsize(traceY#13)=1.5,lsize(traceY#14)=1.5 	ModifyGraph lsize(traceY#15)=1.5	ModifyGraph rgb(traceY)=(0,26112,39168),rgb(traceY#1)=(0,26112,39168)	ModifyGraph rgb(traceY#2)=(0,26112,39168),rgb(traceY#3)=(0,26112,39168)	ModifyGraph rgb(traceY#4)=(0,26112,39168),rgb(traceY#5)=(0,26112,39168)	ModifyGraph rgb(traceY#6)=(0,26112,39168),rgb(traceY#7)=(0,26112,39168)	ModifyGraph rgb(traceY#8)=(0,26112,39168)	ModifyGraph rgb(traceY#9)=(0,26112,39168),rgb(traceY#10)=(0,26112,39168);DelayUpdate	ModifyGraph rgb(traceY#11)=(0,26112,39168),rgb(traceY#12)=(0,26112,39168);DelayUpdate	ModifyGraph rgb(traceY#13)=(0,26112,39168),rgb(traceY#14)=(0,26112,39168);DelayUpdate	ModifyGraph rgb(traceY#15)=(0,26112,39168)//    ARPEScorrDiagonalline ()  endifendFunction ARPEScorrDiagonalline () Nvar piangle 	make/o/n=13 diagonalX, diagonalY 	diagonalX[0] = -piangle ; diagonalY[0] = piangle 	diagonalX[1] = -piangle ; diagonalY[1] = -piangle 	diagonalX[2] = 3*piangle ; diagonalY[2] = -piangle 	diagonalX[3] = 3*piangle ; diagonalY[3] = piangle 	diagonalX[4] = piangle ; diagonalY[4] = piangle 	diagonalX[5] = piangle ; diagonalY[5] = -piangle 	diagonalX[6] = 3*piangle ; diagonalY[6] = piangle 	diagonalX[7] = 3*piangle ; diagonalY[7] = -piangle 	diagonalX[8] = piangle ; diagonalY[8] = piangle 	diagonalX[9] = -piangle ; diagonalY[9] = piangle 	diagonalX[10] = piangle ; diagonalY[10] = -piangle 	diagonalX[11] = piangle ; diagonalY[11] = piangle 	diagonalX[12] = -piangle ; diagonalY[12] = -piangle 	appendtograph diagonalY vs diagonalX 	ModifyGraph rgb(diagonalY)=(0,0,0)endFunction ARPESline_BZType(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar BZType_Cut	BZType_Cut=popStr	  dowindow/f ARPESline	 if (V_flag==1)		AddBZlines(BZType_Cut)	endifEndproc showARPESline (ctrlName) : ButtonControl	String ctrlName       ARPEScalibration  ()	dowindow/f ARPESline	make/o/n=10 zerowaveX, zerowaveY//	zerowaveX=nan ; zerowaveY=nan	if (V_flag==0)	Display /W=(281,99,742,515) 		AddBZlines(BZType_cut)		appendtograph y2wave vs x2wave//	ModifyGraph rgb(zerowaveY)=(0,0,65535)//	ModifyGraph lSize=2	ModifyGraph lsize(y2wave)=2	ModifyGraph tick=2	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=15	ModifyGraph standoff=0	Label left "\f02k\By\M\f00 / \F'Symbol'p"	Label bottom "\f02k\Bx\M\f00 / \F'Symbol'p"//	SetAxis left -90/ScientaPiAngle,90/ScientaPiAngle//	SetAxis bottom -90/ScientaPiAngle,90/ScientaPiAngle	SetAxis left -2,2;DelayUpdate	SetAxis bottom -2,2	dowindow/c ARPESline	endifEndproc ARPESlineModi (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName   ARPEScalibration ()   CalRealAngle()EndProc ARPEScalibration ()variable tmX1, tmX2, tmX3variable tmY1, tmY2, tmY3variable tmZ1, tmZ2, tmZ3variable Psi, Theta,  ANG, Phi//nvar Scientahv, Scientawk, Scientaaa//variable ScientaPiAngle= getpiangle(Scientahv, Scientawk, Scientaaa)silent 1 ; pauseupdate Theta=-ScientaThetaval*(pi/180)Psi=-ScientaPsival*(pi/180)Phi=ScientaPhival*(pi/180)make/o/n=(100) Xwave,Ywave,Zwave,x2wave,y2wave,z2wave SetScale/I x -(pi/180*scientaAngle),(pi/180*scientaAngle),"", Xwave,Ywave,Zwave,x2wave,y2wave,z2waveZwave() = cos(x)*getKval(Scientahv, Scientawk, Scientaaa)Ywave() = sin(x) *getKval(Scientahv, Scientawk, Scientaaa)  //tmX1=cos(Psi)*cos(Theta)-cos(Phi)*sin(Theta)*sin(Psi)//tmX2=cos(Psi)*sin(Theta)+cos(Phi)*cos(Theta)*sin(Psi)tmX2=sin(Theta)//tmX3=sin(Psi)*sin(Phi)tmX3=0  //tmZ1=sin(Phi)*sin(Theta)tmY2=-sin(Phi)*cos(Theta)tmY3=cos(Phi)x2wave[] = tmX2*Zwave[p]  //+tmX3*Ywave[p]y2wave[] = tmY2*Zwave[p]+tmY3*Ywave[p]if (ScientaRotaAngle != 0) 	ANG=ScientaRotaAngle*pi/180	duplicate/o x2wave temp1	duplicate/o y2wave temp2	x2wave[] = temp1[p]*cos(ANG)-temp2[p]*sin(ANG)	y2wave[] = temp1[p]*sin(ANG)+temp2[p]*cos(ANG)endifendmacroProc ARPEScalibrationnew()variable tmX1, tmX2, tmX3variable tmY1, tmY2, tmY3variable tmZ1, tmZ2, tmZ3variable Psi, Theta, Phi, ANGsilent 1 ; pauseupdate Theta=-ScientaThetaval*(pi/180)Psi=-ScientaPsival*(pi/180)//Phi=ScientaPhival*(pi/180)make/o/n=(100) Xwave,Ywave,Zwave,x2wave,y2wave,z2wave SetScale/I x -(pi/180*scientaAngle),(pi/180*scientaAngle),"", Xwave,Ywave,Zwave,x2wave,y2wave,z2waveZwave() = cos(x) / sin(ScientaPiAngle*pi/180)Ywave() = sin(x) / sin(ScientaPiAngle*pi/180)  //tmX1=cos(Psi)*cos(Theta)-cos(Phi)*sin(Theta)*sin(Psi)tmX2=sin(Theta)tmX3=-0  //tmZ1=sin(Phi)*sin(Theta)tmY2=-sin(Phi)*cos(Theta)tmY3=cos(Phi)x2wave[] = tmX2*Zwave[p]+tmX3*Ywave[p]y2wave[] = tmY2*Zwave[p]+tmY3*Ywave[p]if (ScientaRotaAngle != 0) 	ANG=ScientaRotaAngle*pi/180	duplicate/o x2wave temp1	duplicate/o y2wave temp2	x2wave[] = temp1[p]*cos(ANG)-temp2[p]*sin(ANG)	y2wave[] = temp1[p]*sin(ANG)+temp2[p]*cos(ANG)endifendmacroFunction GetARPESimage (ctrlName) : ButtonControl	String ctrlName	string nameX, nameY	wave zerowaveY, zerowaveX, x2wave, y2wave   Nvar ScientaThetaFrom, ScientaThetaTo, ScientaThetaStep   Nvar Psival, ScientaThetaval, ScientaPhival   variable waveNum, dTheta, i, windex  // waveNum = 20  if (ScientaThetaStep==0)   abort "set theta!!"  endif  waveNum = abs(ScientaThetaTo-ScientaThetaFrom)/ScientaThetaStep+1   make/o/n=(waveNum*101) zerowaveX, zerowaveY   dTheta = ( max(ScientaThetaFrom,ScientaThetaTo)-min(ScientaThetaFrom,ScientaThetaTo) )/waveNum    print dtheta   zerowaveY=nan     for ( i=0 ; i<=waveNum ; i+=1)     ScientaThetaval = min(ScientaThetaFrom, ScientaThetaTo)+dTheta*i     execute "ARPEScalibration ()"     zerowaveY[windex,windex+100] = y2wave[p-windex]     zerowaveY[windex+100,windex+101] = nan     zerowaveX[windex,windex+100] = x2wave[p-windex]     zerowaveX[windex+100,windex+101] = nan     windex+=101        endforEndFunction GetARPESimage_back (ctrlName) : ButtonControl	String ctrlName	string nameX, nameY   Nvar ScientaThetaFrom, ScientaThetaTo   Nvar Psival, ScientaThetaval, ScientaPhival   variable waveNum, dTheta, i   waveNum = 20   dTheta = ( max(ScientaThetaFrom,ScientaThetaTo)-min(ScientaThetaFrom,ScientaThetaTo) )/waveNum   dowindow/f ARPESimage   if (V_flag==1)   dowindow/k ARPESimage   execute "ARPEScalibration ()"   Display ///W=(281,99,742,515)   appendtograph y2wave vs x2wave    				ModifyGraph tick=2		ModifyGraph zero=3		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		Label left "ky"		Label bottom "kx"		SetAxis left -1,1		SetAxis bottom -1,1	dowindow/c ARPESimage   elseif (V_flag==0)   execute "ARPEScalibration ()"	Display // /W=(281,99,742,515)	appendtograph y2wave vs x2wave		ModifyGraph tick=2		ModifyGraph zero=3		ModifyGraph mirror=1		ModifyGraph minor=1		ModifyGraph fSize=15		ModifyGraph standoff=0		Label left "ky"		Label bottom "kx"		SetAxis left -1,1		SetAxis bottom -1,1	dowindow/c ARPESimage	endif       for ( i=0 ; i<=waveNum ; i+=1)     ScientaThetaval = min(ScientaThetaFrom, ScientaThetaTo)+dTheta*i     execute "ARPEScalibration ()"     nameX =  "ARPESlineKx" + num2istr(i)     nameY =  "ARPESlineKy" + num2istr(i)     duplicate/o y2wave $nameY      duplicate/o x2wave $nameX       appendtograph $nameY  vs $nameX     ModifyGraph lSize=2   endforEnd////////////////////////////////////////   ALS procedures////////////////////////////////////Window ALS() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(334,434,546,810)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 6,59,199,59	SetDrawEnv linethick= 2	DrawLine 6,151,199,151	DrawRect 30,245,182,308	Button Load3D,pos={8,6},size={50,21},proc=Load3DFunc,title="Load"	Button corr,pos={80,6},size={50,21},proc=corrbyfit,title="Corr"	Button draw,pos={135,6},size={50,21},proc=DrawROI,title="Draw"	Button Load31,pos={157,32},size={35,21},proc=ALSCutImageFunc,title="Cut"	SetVariable setvar08,pos={17,90},size={54,15},proc=Gammaproc,title="g"	SetVariable setvar08,font="Symbol",limits={0.1,inf,0.1},value= GammaVal	SetVariable setvar09,pos={10,110},size={77,15},proc=BzEnergyGammaFunc,title="E"	SetVariable setvar09,limits={-inf,inf,0.01},value= BzEnergy	SetVariable setvar07,pos={92,110},size={74,15},proc=BzEnergyGammaFunc,title="dE"	SetVariable setvar07,limits={0.001,1,0.01},value= BzErange	SetVariable InterpX,pos={11,129},size={82,15},proc=InterpBzGammaFunc,title="Interp: X"	SetVariable InterpX,limits={1,50,1},value= interpX_Bz	SetVariable InterpY,pos={97,129},size={47,15},proc=InterpBzGammaFunc,title="Y"	SetVariable InterpY,limits={1,20,1},value= interpY_Bz	Button Load32,pos={8,64},size={67,21},proc=ALSShowFunc,title="Show FS"	PopupMenu ListGoffset,pos={132,67},size={55,17},proc=ColorSetproc	PopupMenu ListGoffset,mode=26,popvalue="Gold",value= #"CTabList()"	CheckBox auto1,pos={146,88},size={44,14},proc=InvertCheckProc,title="Invert"	CheckBox auto1,value= 0	Button Load33,pos={92,32},size={61,21},proc=GridCorrFunk,title="GridCorr"	Button Load34,pos={8,32},size={80,21},proc=GetGridInfoFunc,title="Get GridInfo"	Button Load35,pos={35,314},size={136,21},proc=KzImageCorrProc,title="Go kz Corr"	SetVariable setvar10,pos={31,156},size={47,15},title=" "	SetVariable setvar10,limits={1,inf,1},value= ALShv1	SetVariable setvar11,pos={78,156},size={111,15},title="<= hv(eV) <="	SetVariable setvar11,limits={1,inf,1},value= ALShv2	SetVariable setvar12,pos={33,175},size={142,15},title="Angle per slice (deg)"	SetVariable setvar12,limits={0,inf,0.01},value= ALSsliceDeg	SetVariable setvar13,pos={33,191},size={142,15},title="Theta offset (deg)"	SetVariable setvar13,limits={-inf,inf,0.1},value= ALSThetaOffset	SetVariable setvar14,pos={33,208},size={142,15},title="Inner potential (eV)"	SetVariable setvar14,limits={1,inf,1},value= ALSInner	SetVariable setvar15,pos={33,225},size={76,15},title="a (A)"	SetVariable setvar15,limits={1,inf,0.1},value= ALSlattice_a	SetVariable setvar16,pos={110,225},size={76,15},title="c (A)"	SetVariable setvar16,limits={1,inf,0.1},value= ALSlattice_c	CheckBox auto2,pos={80,68},size={42,14},proc=ALSNormCheckFunc,title="Norm"	CheckBox auto2,value= 1	Button button06,pos={37,248},size={40,20},proc=ALSSaveButtonProc,title="Save"	SetVariable setvar17,pos={81,250},size={33,15},proc=ALSsaveNoProc,title=" "	SetVariable setvar17,limits={0,50,1},value= ALSsaveNo	CheckBox check1,pos={117,251},size={61,14},proc=ALSCheckProc,title="AutoLoad"	CheckBox check1,value= 1	SetVariable setvar24,pos={36,269},size={142,15},title="memo"	SetVariable setvar24,value= saveNo_memoALS	Button button05,pos={69,285},size={92,20},proc=MemoALSListFunc,title="memo List"	SetVariable setvar26,pos={13,341},size={127,15},title="Map name"	SetVariable setvar26,value= NewALSMapName	Button button09,pos={148,338},size={51,20},proc=CreateALSMap,title="Create"EndMacroFunction DrawROI (ctrlName) : ButtonControl	String ctrlName	SVAR  DrawWinName, DrawPanelname	DrawWinName=WinName(0,1)	dowindow/f $DrawWinName	GraphWaveDraw/o DrawY,DrawX	DrawPanelname = DrawWinNameendFunction Corrbyfit (ctrlName) : ButtonControl	String ctrlName	wave Grallnum, temp_corr,line, temp_corrfit, line_fit, line_fit_CS     variable epoints,kpoints, offset,i,j,totalnum, tonum     string offsetstr     wave drawY, drawX, w_coefa, w_coefb     wave startp, endp     wave Grallnum, temp_save2gr     variable v_min,v_max     getaxis/q/w=Graph_Image left     make/o temp_corr     make/o temp_corrfit     make/o line     make/o/n=(tonum) line_fit     Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")       Prompt tonum, "new number of Slices"     Doprompt "Select", offsetstr, tonum   if (V_Flag)   	  return -1// User canceled    endif          	sscanf offsetstr, "G%f", offset  	totalnum=Grallnum[offset/1000]  	  	duplicate/o $"gr"+num2istr(offset) temp_corr  	epoints=dimsize(temp_corr,0)  	  	make/o/n=2 w_coefa  	make/o/n=2 w_coefb  	w_coefa[1]=(drawY[1]-drawY[0])/(drawX[1]-drawX[0])      w_coefa[0]=drawY[1]-(drawX[1]-v_max)*w_coefa[1]       w_coefa[1]= w_coefa[1]/epoints*(v_min-v_max)  	w_coefb[1]=(drawY[3]-drawY[2])/(drawX[3]-drawX[2])      w_coefb[0]=drawY[3]-(drawX[3]-v_max)*w_coefb[1]       w_coefb[1]= w_coefb[1]/epoints*(v_min-v_max)  	  	for(i=0;i<totalnum;i=i+1)  	    duplicate/o $"gr"+num2istr(offset+i) temp_corr  	    redimension/n=(epoints, tonum) temp_corrfit  	    make/o/n=(epoints) startp  	    make/o/n=(epoints) endp  	    startp[]=poly(w_coefa,epoints-p-1)  	    endp[]=poly(w_coefb,epoints-p-1)  	    for(j=0;j<epoints;j=j+1)  	        	      redimension/n=(round(endp[j]-startp[j]+1)) line  	       line[]=temp_corr[j][startp+p]             interpolate2 /n=(tonum) /y=line_fit  line             temp_corrfit[j][]=line_fit[q]          endfor                    duplicate/o temp_corrfit $"gr"+num2istr(offset+i)                 endforendFunction CreateALSMap (ctrlName) : ButtonControl	String ctrlName		Svar NewALSMapName	string ImName,panelName, descriptor, Map="kzMap"	string ALSColorCT	wave ColorCT	Nvar FSInvertCheck		if (stringmatch(NewALSMapName,"")==1)	   abort "Input Map name!!"	endif	ImName = NewALSMapName	panelName=NewALSMapName+"_panel"	ALSColorCT="ColorCT_"+NewALSMapName	duplicate/o ColorCT $ALSColorCT 	duplicate/o $Map $ImName	Dowindow/f $panelName	if (V_flag==1)	ModifyImage $ImName cindex= $ALSColorCT	endif		if (V_flag!=1)	Display /W=(245,122,635,514)	dowindow/c $panelName	AppendImage $ImName	ModifyImage $ImName cindex= $ALSColorCT	ModifyGraph mirror=1	ModifyGraph nticks=10	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	Label left "( \\f02k\\Bx\\M\\f00 , \\f02k\\By\\M\\f00 ) / \\F'Symbol'p"	Label bottom "\\f02k\\Bz\\M\\f00 / \\F'Symbol'p"	ModifyGraph swapXY=1		textbox/k/n=text0   sprintf descriptor " \\Z16%s ", ImName	Textbox/N=ImName /x=-32/y=40/F=0/A=MC descriptor	endif end	proc ALSsaveNoProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName		string ALScoeff	silent 1 ; pauseupdate	if (ALSsavecheck)	ALScoeff="ALScoeff"+num2istr(ALSsaveNo)   saveNo_memoALS = memoT_ALS[ALSsaveNo]	 duplicate/o $ALScoeff temp0	 ALShv1=temp0[0]	 ALShv2=temp0[1]	 ALSsliceDeg=temp0[2]	 ALSThetaOffset=temp0[3]	 ALSInner=temp0[4]	 ALSlattice_a=temp0[5]	 ALSlattice_c=temp0[6]	endifEndFunction MemoALSListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "MemoALSList"	wave/t memoT_ALS	dowindow/f $panelname	if (v_flag!=1)	edit memoT_ALS	dowindow/c $panelname	endifend	Function ALSSaveButtonProc (ctrlName) : ButtonControl	String ctrlName   Nvar ALSsaveNo   Nvar ALShv1, ALShv2, ALSsliceDeg, ALSThetaOffset, ALSInner, ALSlattice_a, ALSlattice_c   string ALScoeff   wave/t memoT_ALS   svar saveNo_memoALS   ALScoeff="ALScoeff"+num2istr(ALSsaveNo)   make/o/n=7 $ALScoeff   duplicate/o $ALScoeff temp0  temp0 = {ALShv1, ALShv2, ALSsliceDeg, ALSThetaOffset, ALSInner, ALSlattice_a, ALSlattice_c}   duplicate/o temp0 $ALScoeff   memoT_ALS[ALSsaveNo] = saveNo_memoALSEndFunction ALSCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar ALSsavecheckALSsavecheck = checkedEndFunction BzEnergyGammaFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar BzEnergy	Nvar ALSNormCheckMappingFunc ()duplicate/o fsmapping FS_ALSColorSetfunc ()     if (ALSNormCheck==1)      ALSNormFunc ()     endifEndFunction InterpBzGammaFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	Nvar ALSNormCheckMappingFunc ()duplicate/o fsmapping FS_ALSColorSetfunc ()     if (ALSNormCheck==1)      ALSNormFunc ()     endifEndFunction ALSNormCheckFunc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar ALSNormCheckALSNormCheck=checkedEndFunction ALSNormFunc ()	variable sizeX, sizeY,i	wave nk2d	Nvar BzErange, BzEnergy, interpX_Bz, interpY_Bz	Svar bzname	variable Enegative, Epositive	string base="M_interpolatedimage"	 Enegative=(-1)*BzErange+BzEnergy 	Epositive=BzErange+BzEnergy 	bznk($bzname,Enegative,Epositive) 	sizeX = dimsize(nk2d,0) 	sizeY = dimsize(nk2d,1) 	make/o/n=(sizeY) temp1 	for (i=0;i<sizeX;i+=1) 	  temp1[] = nk2d[i][p] 		nk2d[i][] /= mean(temp1,0,sizeY-1) 	endfor 	ImageInterpolate /f={interpX_Bz,interpY_Bz} bilinear nk2d 	 duplicate/o $base FS_ALS 	 ColorSetfunc ()endFunction ALSShowFunc (ctrlName) : ButtonControlstring ctrlNamewave ColorCTNvar ALSNormCheck      dowindow mapping      if (V_flag==0)      abort "Show FSmapping !!"     endif      if  (V_flag==1)     	 duplicate/o fsmapping FS_ALS      	dowindow/f MappingALS      	      	if (V_flag==1)      		ColorSetfunc ()     		 ModifyImage FS_ALS cindex= ColorCT     	endif      	if (V_flag!=1)      	 display ; appendimage FS_ALS      	 make/o/n=100 M_colors,ColorCT      	 ColorSetfunc ()      	 ModifyImage FS_ALS cindex= ColorCT      	 dowindow/C MappingALS      	endif      endif     if (ALSNormCheck==1)      ALSNormFunc ()     endifendFunction ALSShowFunc_back (ctrlName) : ButtonControlstring ctrlNamewave ColorCT      dowindow mapping      if (V_flag==0)      abort "Show FSmapping !!"     endif     if  (V_flag==1)     	 duplicate/o fsmapping FS_ALS      	dowindow/f MappingALS      	      	if (V_flag==1)      	ColorSetfunc ()     	 ModifyImage FS_ALS cindex= ColorCT     	 endif      	if (V_flag!=1)      	 display ; appendimage FS_ALS      	 make/o/n=100 M_colors,ColorCT      	 ColorSetfunc ()      	 ModifyImage FS_ALS cindex= ColorCT      	 dowindow/C MappingALS      	endif      endifendFunction 	ColorSetfunc ()	variable size, maxVal, minVal   Nvar Gammaval, InvertCheck   wave M_colors   Svar ALScolor      ColorTab2Wave $ALScolor      duplicate/o M_colors ColorCT      size = dimsize(ColorCT,0)        ColorCT[][] = M_colors[size*(p/size)^GammaVal][q]       wavestats/q FS_ALS       maxVal = V_max       minVal = V_min       if (InvertCheck==0)          setScale/I x,minVal,maxVal,"",ColorCT        elseif (InvertCheck==1)         setScale/I x,maxVal,minVal,"",ColorCT        endifendproc KzImageCorrProc (ctrlName) : ButtonControlstring ctrlNamevariable h_bar=1.0545*10^-34,aa,cc,m=9.11*10^-31,eV=1.6*10^-19variable ki, kf, kzi, kzf, Tipi, Tfpi, Ei, Ef, EieV, EfeV, HalfMCP, kpoints, WV0eVvariable WW=4.5silent 1 ; pauseupdateduplicate/o FS_ALS, kzSourceMap, kzMap, ThetaMap, EkMapkpoints=dimsize(FS_ALS,1)/interpY_BZHalfMCP=abs( (kpoints-1)*ALSsliceDeg/2 )SetScale/I y -HalfMCP+ALSThetaOffset,HalfMCP+ALSThetaOffset,"", kzSourceMapSetScale/I x (ALShv1-WW),(ALShv2-WW),"", kzSourceMapTipi=-(HalfMCP-ALSThetaOffset)*pi/180Tfpi=(HalfMCP+ALSThetaOffset)*pi/180EieV=(ALShv1-WW)*eVEfeV=(ALShv2-WW)*eVWV0eV=ALSInner*eVki=sqrt(2*m*EfeV)/h_bar*sin(Tipi)kf=sqrt(2*m*EfeV)/h_bar*sin(Tfpi)kzi=(1/h_bar)*sqrt( 2*m*(EieV*cos(Tipi)^2+WV0eV) )kzf=(1/h_bar)*sqrt( 2*m*(EfeV+WV0eV) )SetScale/I y ki,kf,"", kzMap, ThetaMap, EkMapSetScale/I x kzi,kzf,"", kzMap, ThetaMap, EkMapThetaMap()()=asin( y / sqrt( x^2 +y^2 - 2*m*WV0eV/(h_bar^2) ) )EkMap()()=( (h_bar*x)^2/(2*m) - WV0eV ) / cos( ThetaMap(x)(y) )^2 /eVkzMap[][]= kzSourceMap(EkMap[p][q])(ThetaMap[p][q]/pi*180)aa=ALSlattice_a*10^-10cc=ALSlattice_c*10^-10SetScale/I y ki/(pi/aa),kf/(pi/aa),"", kzMapSetScale/I x kzi/(pi/cc),kzf/(pi/cc),"", kzMapSetScale/I x ALShv1,ALShv2,"", kzSourceMapdowindow/f kzSourceMapPanelif (V_flag!=1)	Display /W=(245,122,635,514)	dowindow/c kzSourceMapPanel	AppendImage kzSourceMap	ModifyImage kzSourceMap ctab= {*,*,Grays,0}	ModifyGraph mirror=1	ModifyGraph nticks=10	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	Label bottom "Photon energy (eV)"	Label left "MCP angle (deg)"	ModifyGraph swapXY=1	 ModifyImage kzSourceMap cindex= ColorCTendifdowindow/f kzMapPanelif (V_flag!=1)	Display /W=(245,122,635,514)	dowindow/c kzMapPanel	AppendImage kzMap	ModifyImage kzMap ctab= {*,*,Grays,0}	ModifyGraph mirror=1	ModifyGraph nticks=10	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	Label left "( \\f02k\\Bx\\M\\f00 , \\f02k\\By\\M\\f00 ) / \\F'Symbol'p"	Label bottom "\\f02k\\Bz\\M\\f00 / \\F'Symbol'p"	ModifyGraph swapXY=1	 ModifyImage kzMap cindex= ColorCTendifendFunction GetGridInfoFunc (ctrlName) : ButtonControl	String ctrlName	string Grid2D	variable  ebin = 30, Threshold = 0.05	Prompt Grid2D, "2d Image name: "	prompt ebin, "E-bin value"	prompt Threshold, "Threshold"  	Doprompt "Get GridInfo", Grid2D, ebin, Threshold  	if (V_Flag)   			return -1// User canceled   	endif   	calcanglecorr($Grid2D, "GridInfo", ebin, Threshold)  // get gridinfo image from Grod2D  	dowindow/f GridInfoPanel  	if (V_flag!=1)  	 display ; appendimage GridInfo  	 ModifyImage GridInfo ctab= {*,*,Rainbow,0}  	 dowindow/c GridInfoPanel  	 Label left "\\Z15Peaks";DelayUpdate    Label bottom "\\Z15Epoints"  endifEnd//#############################// This function fits peaks position along single profile. Returned peak table contains // peak positions that are larger than threshold fixed at 5% of the highest peakFunction FindPeaks(kprofile, Threshold)WAVE kprofilevariable Thresholdvariable profstart,profendvariable thresholdval, nbofpeaksvariable PeakPosvariable ivariable peakstart, peakend, peakwidthWAVE W_findlevels, W_Coefvariable v_levelsfoundsilent 1; pauseupdatewavestats /q kprofilethresholdval=v_max*Thresholdfindlevels /q  kprofile,thresholdvalnbofpeaks=v_levelsfound/2// print "Threshhold:", threshold, "Nb of peaks:  ",nbofpeaksmake /o /n=(nbofpeaks) peaktablei=0dopeakstart=w_findlevels[2*i]peakend=w_findlevels[2*i+1]peakwidth=peakend-peakstartvariable /g v_fitoptions=4//print "width =", peakwidth, "start=", peakstartCurveFit /q  gauss kprofile[peakstart-peakwidth, peakend+peakwidth] /dv_fitoptions=0peaktable[i]=w_coef[2]i+=1while(i<nbofpeaks)return nbofpeaksend//###########################// This function calculates the Detector angular correction, saves the matrix angcorr that // for each energy contains the  test grid peak positions Function calcanglecorr(calimage, DetCorrAngles, bin, Threshold)WAVE calimagestring DetCorrAnglesvariable bin, ThresholdWAVE peaktableWAVE angtraceWAVE angcorrtableWAVE angcorrWAVE DetCorrWAVE energymaskvariable kpoints, epoints, i,j, nbofpeaks, curr_nbofpeaksvariable intstart, intendNvar Gridkpoints, Gridepointsduplicate/o calimage PeakLineImagedowindow/f PeakLineImagePanelif (V_flag!=1)display ; appendimage PeakLineImagedowindow/c PeakLineImagePanelelse dowindow/k PeakLineImagePaneldisplay ; appendimage PeakLineImagedowindow/c PeakLineImagePanelendif//silent 1; pauseupdate// Bin the angle grid imagemake /o/n=(dimsize(calimage,0)/bin,dimsize(calimage,1)) calbinimagecalbinimage=0i=0docalbinimage[][]+=calimage[x*bin+i][y]i+=1while(i<bin)////////////////////////////////// calc and make neccessary vars/waveskpoints=dimsize(calbinimage,1) ; Gridkpoints = kpointsepoints=dimsize(calbinimage,0) ; Gridepoints = epointsmake /o /n=(kpoints) kprofilemake /o /n=(epoints) angletrace, energymaskkprofile[]=calbinimage[epoints/2][x]nbofpeaks=FindPeaks(kprofile,Threshold)print "Kpoints: ",kpoints, "     Epoints: ",epoints, "     # of peaks: ",nbofpeaksprint "Energy point:  "make /o /n=(kpoints) kprofilemake /o /n=(epoints,nbofpeaks) angcorrtable//////////////////////// Extract peak dispersionangcorrtable=0energymask=0i=0dokprofile[]=calbinimage[i][x]curr_nbofpeaks=FindPeaks(kprofile,Threshold)if(curr_nbofpeaks==nbofpeaks)angcorrtable[i][]=peaktable[y]energymask[i]=1elseenergymask[i]=0endifprint "Epoints",i, "Peaks",curr_nbofpeaksi+=1while(i<epoints)//abort/////////////////////////////////////// Interpolate the edges along energy directionmake /o /n=(epoints) angletraceduplicate /o angcorrtable angcorr//filter out "bad"pointsi=0doangletrace[]=angcorr[p][i]CurveFit /q poly 3,  angletrace /m=energymask/dj=0			//first stage 50%doif( abs(angletrace[j]-poly(W_coef,j)) > poly(W_coef,epoints/2)*0.5 )energymask[j]=0//print "j", jendifj+=1while(j<epoints)CurveFit /q poly 3,  angletrace[] /m=energymask/dj=0			// second stage 20%doif( abs(angletrace[j]-poly(W_coef,j)) > poly(W_coef,epoints/2)*0.2)energymask[j]=0//print "j", jendifj+=1while(j<epoints)CurveFit /q poly 3,  angletrace[] /m=energymask/dj=0			//third stage 10%doif( abs(angletrace[j]-poly(W_coef,j))>poly(W_coef,epoints/2)*0.1)energymask[j]=0//print "j", jendifj+=1while(j<epoints)CurveFit /q poly 3,  angletrace[] /m=energymask/dangletrace[]=0angletrace = poly(W_coef,p)angcorr[][i]=angletrace[p]Interpolate2/T=1/N=100/Y=$("PeakLine"+num2str(i)) angletraceSetScale/I x 0, (dimsize(calimage,0)-1),"", $("PeakLine"+num2str(i))appendtograph $("PeakLine"+num2str(i))i+=1while(i<nbofpeaks)// Expand the detector edges along k axismake /o /n=(epoints,nbofpeaks+2) DetCorrDetCorr[][]=angcorr[x][y-1]DetCorr[][0]=2*angcorr[x][0]-angcorr[x][1]DetCorr[][nbofpeaks+1]=2*angcorr[x][nbofpeaks-1]-angcorr[x][nbofpeaks-2]duplicate /o DetCorr $DetCorrAnglesendFunction GridCorrFunk (ctrlName) : ButtonControl	String ctrlName	string  Goffset, Goffstr, name	variable FirstNo, LastNo, kbin=1, ebin=1, GraphNo, Goffval	wave GridInfo	Prompt Goffset, "Graph offset: ", popup ,StringList("G*000",";")	prompt FirstNo, "From (Graph No)"	prompt LastNo, "To (Graph No)"//	prompt kbin, "Used K-bin value"//	prompt ebin, "Used E-bin value"  	Doprompt "Grid Correction", Goffset, FirstNo, LastNo//, kbin, ebin  	if (V_Flag)   			return -1// User canceled   	endif   sscanf Goffset, "G%f", Goffval  FirstNo+=Goffval  LastNo+=Goffval  for (GraphNo=FirstNo; GraphNo<=LastNo ; GraphNo+=1)     name = "gr" + num2str(GraphNo)  		CorrImageAng(name, name, "GridInfo") // correction with gridinfo  endforEnd//########################// Main macro correcting a single detector imagefunction CorrImageAng (image, corrimage, DetCorrAngles)string image, corrimage, DetCorrAnglesvariable kbin, ebinvariable kpoints, epointsvariable corr_kpoints, corr_epointsNvar Gridkpoints, Gridepointsepoints=dimsize($image,0)kpoints=dimsize($image,1)//ebin = Gridepoints/epointskbin = Gridkpoints/kpointscorr_epoints=dimsize($DetCorrAngles,0)corr_kpoints=dimsize($DetCorrAngles,1)//print "Kpoints: ",kpoints, "     Epoints: ",epoints//print "corr_kpoints: ",corr_kpoints, "     corr_epoints: ",corr_epointsduplicate/o $image sourceimage, corrimgduplicate/o $DetCorrAngles temptemp/=kbincorrimg[][]=interp2D(sourceimage,p,interp2D(temp,p*(corr_epoints-1)/(epoints-1),q*(corr_kpoints-1)/(kpoints-1)))duplicate /o corrimg $corrimageendmacroFunction InvertCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   Nvar InvertCheck   InvertCheck = checked   ColorSetfunc ()EndFunction ColorSetproc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar ALScolor    ALScolor = popStr    ColorSetfunc ()EndFunction Gammaproc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName     ColorSetfunc ()EndFunction 	GammaFunc_back ()string ItemStr, pieceStr, colorstr	variable leng1, leng2, Allleng, size, maxVal, minVal, Invert   Nvar Gammaval   variable ItemNum, i   wave M_colors   ItemStr = ImageInfo("mappingGamma","fsgamma",0)   ItemNum = ItemsInList(ItemStr)   wavestats/q fsmapping   maxVal = V_max   minVal = V_min   for (i=0 ; i<ItemNum ; i+=1)     pieceStr = StringFromList(i, ItemStr)      if ( stringmatch(pieceStr , "*ctab*" ) )      Allleng = strlen(pieceStr)      leng1 = strlen("RECREATION:ctab= {*,*,")      leng2 = strlen(",0}")      colorstr = pieceStr[leng1,Allleng-leng2-1]      Invert = str2num(pieceStr[Allleng-2])      break     endif   endfor         ColorTab2Wave $colorstr      duplicate/o M_colors ColorCT      size = dimsize(ColorCT,0)        ColorCT[][] = M_colors[size*(p/size)^GammaVal][q]       if (Invert==0)          setScale/I x,minVal,maxVal,"",ColorCT        elseif (Invert==1)         setScale/I x,maxVal,minVal,"",ColorCT        endifendFunction ALSCutImageFunc (ctrlName) : ButtonControlstring ctrlNamestring Goffsetvariable FirstNo, LastNo  Prompt Goffset, "Graph offset ", popup, StringList("G*000",";")	Prompt FirstNo, "First Slice: "	Prompt LastNo, "Last Slice: "  	Doprompt "Cut Slice", Goffset,FirstNo, LastNo  ALSImageCutFunc (Goffset,FirstNo, LastNo)endFunction ALSImageCutFunc (Goffset,FirstNo, LastNo)string Goffsetvariable FirstNo, LastNostring wavenamevariable Goffvalstring result, base2Dvariable size0, size1, size2, Windex=0, iwave/t ALS3Dnamesscanf Goffset, "G%f", Goffvalwavename = ALS3Dname[Goffval/1000]   size0=dimsize($wavename,1) // X  size1=(LastNo-FirstNo)+1 // Y  size2=dimsize($wavename,2) // Zdo   Windex = Goffval+i   result ="gr"+num2istr(Windex)   base2D ="gr"+num2istr(Windex)   duplicate/o $base2D temp1   Make/o/N=(size0,size1)/D temp2      temp2[][]=temp1[p][q+FirstNo]     duplicate/o temp2, $result  // 2D Image   i+=1while(i<size2)endFunction ImageCutFunc_back (Goffset,FirstNo, LastNo)string Goffsetvariable FirstNo, LastNostring wavenamevariable Goffvalstring result, result1, resultX="gx", result2D="gr"variable size0, size1, size2, Windex=0, iwave grallnumwave/t ALS3Dnamesscanf Goffset, "G%f", Goffvalwavename = ALS3Dname[Goffval/1000] duplicate/o $wavename tempsize0=(LastNo-FirstNo)+1 // Ysize1=dimsize($wavename,1) // Xsize2=dimsize($wavename,2) // Zdo    Windex = Goffval+i   result1=resultX+num2istr(Windex)   make/o/n = (size1) $result1, temp1  temp1[]=DimOffset($wavename,1) +p*DimDelta($wavename,1)   duplicate/o temp1, $result1  // X wave   result=result2D+num2istr(Windex)   Make/o/N=(size1,size0)/D $result, temp2   temp2[][]=temp[q+FirstNo][p][i]   duplicate/o temp2, $result  // 2D Image   i+=1while(i<size2)endFunction Load3DFunc (ctrlName) : ButtonControl	String ctrlName	string Name3Di, Name3Df, Goffset, Goffstr, OffsetStr	variable No, iGraphNo	wave map	wave grallnum	 wave/t mapTOffsetStr = "0000"+";1000"+";2000"+";3000"+";4000"+";5000"+";6000"+";7000"+";8000"+";9000"OffsetStr+= ";10000"+";11000"+";12000"+";13000"+";14000"+";15000"+";16000"+";17000"+";18000"+";19000"OffsetStr+= ";20000"+";21000"+";22000"+";23000"+";24000"+";25000"+";26000"+";27000"+";28000"+";29000"OffsetStr+= ";30000"+";31000"+";32000"+";33000"+";34000"+";35000"+";36000"+";37000"+";38000"+";39000"OffsetStr+= ";40000"+";41000"+";42000"+";43000"+";44000"+";45000"+";46000"+";47000"+";48000"+";49000"+";50000"	Prompt Name3Di, "3d wave start: ", popup , WaveList("f00*",";","") 	Prompt Name3Df, "3d wave end: ", popup , WaveList("f00*",";","") 	Prompt Goffset, "Graph offset: ", popup , OffsetStr 	  	Doprompt "Norm Data Number", Name3Di, Name3Df,  Goffset  	No = str2num(Goffset)/1000  	iGraphNo=grallnum[No]+1  	Prompt iGraphNo, "Initial Graph No: "  	Doprompt "Start Graph Number", iGraphNo  	grallnum[No]=iGraphNo-1//  	print grallnum[No]  	if (V_Flag)   			return -1// User canceled   	endif   	Goffstr = "G"+Goffset  	string/g $Goffstr  if (map[0][0] < str2num(Goffset)+1000)   Redimension/N=(str2num(Goffset)+1000,-1) map   Redimension/N=(str2num(Goffset)+1000,-1) mapT   map[0][0]=str2num(Goffset)+1000   //map[2,str2num(Goffset)+1000-1][0]=1 endif  	 	 	variable ii=str2num(Name3Di[1,strlen(Name3Di)-1]) 	variable iimax=str2num(Name3Df[1,strlen(Name3Di)-1]) 	string Name3D 	do 	iGraphNo=grallnum[No]+1 	sprintf Name3D "f%05g", ii  	slice_3Dto2D (Name3D,No, iGraphNo)  	ii=ii+1  	while(ii<=iimax)EndFunction slice_3Dto2D (Name3D,No,iGraphNo)string Name3Dvariable No variable iGraphNostring result, result1, resultX="gx", result2D="gr"variable size0, size1, size2, Windex=0,i=0wave grallnumduplicate/o $Name3D tempsize0=dimsize($Name3D,0)size1=dimsize($Name3D,1)size2=dimsize($Name3D,2)size2=size2==0?1:size2do    Windex = (No*1000)+i+iGraphNo   result1=resultX+num2istr(Windex)   make/o/n = (size1) $result1, temp1  temp1[]=DimOffset($Name3D,1) +p*DimDelta($Name3D,1)   duplicate/o temp1, $result1  // X wave    result=result2D+num2istr(Windex)   Make/o/N=(size1,size0)/D $result, temp2   temp2[][]=temp[q][p][i]   duplicate/o temp2, $result  // 2D Image   i+=1while(i<size2)make/t/o/n=10 ALS3Dnamegrallnum[No] =grallnum[No]+size2ALS3Dname[No] = Name3Dend/////////////////////////////////////////////		Map Axis Correction 	////////////////////////////////////////////Window ImageAxisCorr() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(679,447,987,672)	ModifyPanel cbRGB=(1,52428,26586)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 18,26,292,26	DrawRect 143,31,295,94	SetDrawEnv linethick= 2	DrawLine 18,162,292,162	SetVariable setvar0,pos={18,32},size={125,15},title="one slice (deg)"	SetVariable setvar0,limits={0,inf,0.01},value= ImAxis_oneSliceAngle	SetVariable setvar09,pos={19,65},size={124,15},title="Axis Off"	SetVariable setvar09,limits={-inf,inf,0.5},value= ImAxis_offset	Button button05,pos={182,71},size={92,20},proc=ImAxis_MemoListFunc,title="memo List"	SetVariable setvar24,pos={149,55},size={142,15},title="memo"	SetVariable setvar24,value= ImAxis_saveNo_memo	Button button06,pos={150,34},size={40,20},proc=ImAxis_SaveButtonProc,title="Save"	SetVariable setvar14,pos={194,36},size={33,15},proc=ImAxis_saveNoProc,title=" "	SetVariable setvar14,limits={0,50,1},value= ImAxis_saveNo	CheckBox check1,pos={230,37},size={60,14},proc=ImAxis_CheckProc,title="AutoLoad"	CheckBox check1,value= 0	SetVariable setvar25,pos={73,6},size={212,15},title="Base Image"	SetVariable setvar25,value= ImAxis_ImageName	Button button08,pos={18,3},size={40,20},proc=GetImageNameFunc,title="Get"	SetVariable setvar15,pos={17,48},size={126,15},title="pi angle (deg)"	SetVariable setvar15,limits={1,inf,1},value= ImAxis_PiAngle	Button button09,pos={223,137},size={66,20},proc=ImAxis_CreateMap,title="Create"	SetVariable setvar26,pos={15,140},size={201,15},title="New name"	SetVariable setvar26,value= ImAxis_NewImageName	PopupMenu ListGoffset,pos={142,100},size={77,17},proc=ImAxis_ColorSetproc	PopupMenu ListGoffset,mode=2,popvalue="Rainbow",value= #"CTabList()"	CheckBox auto1,pos={190,121},size={43,14},proc=ImAxis_InvertCheckProc,title="Invert"	CheckBox auto1,value= 1	Button button07,pos={36,94},size={89,20},proc=GoImAxisCorrFunc,title="Go correction"	Button button13,pos={38,115},size={44,20},proc=ImAxis_showProc,title="Show"	SetVariable setvar23,pos={143,120},size={46,12},proc=ImAxis_Gammaproc,title="g"	SetVariable setvar23,font="Symbol",limits={0.1,inf,0.1},value= ImAxis_GammaVal	SetVariable ButtSlice1,pos={106,170},size={111,15},proc=ImAxisUpdateFunc,title="Energy or k"	SetVariable ButtSlice1,limits={-inf,inf,0.01},value= ImAxisCurveSlice	SetVariable ButtRange,pos={101,189},size={116,15},proc=ImAxisUpdateFunc,title="Range (slice)"	SetVariable ButtRange,limits={0,inf,1},value= ImAxisCurveRange	Button button5,pos={232,167},size={49,20},proc=ImAxisUpdateButton,title="Update"	PopupMenu changeValue2,pos={30,192},size={57,17},proc=ImAxis_EDCMDCfunc	PopupMenu changeValue2,mode=2,popvalue="MDC",value= #"\"EDC;MDC\""	Button button14,pos={38,167},size={44,20},proc=ImAxisCurve_showProc,title="Show"EndMacrofunction ImAxisUpdateButton (ctrlName) : ButtonControl	String ctrlName     ImAxisCurve_update ()endfunction ImAxisUpdateFunc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName   ImAxisCurve_update ()endproc ImAxisCurve_showProc (ctrlName) : ButtonControl	String ctrlName	string mapname="ImAxis_corrMap"		 dowindow/f ImAxisCurvePanel 		if (v_flag!=1) 		  ImAxisCurve_update ()    	Display /W=(174,273,642,591) ImAxisCurve_y vs ImAxisCurve_x 			dowindow/c ImAxisCurvePanel			ModifyGraph tick=2			ModifyGraph mirror=1			ModifyGraph minor=1			ModifyGraph fSize=16			ModifyGraph standoff=0      ImAxis_setLabel ()		endifendFunction ImAxis_EDCMDCfunc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Nvar ImAxis_MDCflag	if ( stringmatch(popStr,"MDC") )	  ImAxis_MDCflag = 1	else    ImAxis_MDCflag = 0	endif    ImAxis_setLabel ()    ImAxisCurve_update ()endFunction ImAxis_setLabel ()  Nvar ImAxis_MDCflag	dowindow ImAxisCurvePanel		if (V_flag==1)	  	if (ImAxis_MDCflag == 1)	   	  Label/w=ImAxisCurvePanel bottom "\f02k\M\f00 / \F'Symbol'p"	   	  Label/w=ImAxisCurvePanel left "Intensity (arb. units)"	  	else 	     Label/w=ImAxisCurvePanel bottom "Energy (eV)"	   	  Label/w=ImAxisCurvePanel left "Intensity (arb. units)"     		  endif		endifendfunction ImAxisCurve_update ()	variable kpoints, epoints, i	Nvar ImAxis_MDCflag, ImAxisCurveSlice, ImAxisCurveRange	string mapname="ImAxis_corrMap"		if (exists(mapname) != 1)  			abort "Go correction first!!"		endif		duplicate/o $mapname temp 		epoints = dimsize($mapname,0)		kpoints = dimsize($mapname,1)		if (ImAxis_MDCflag==1)			 make/o/n=(kpoints) ImAxisCurve_x, ImAxisCurve_y				  make/o/n=(epoints) temp1      ImAxisCurve_x[] = DimOffset($mapname,1) + p*DimDelta($mapname,1)	    temp1[] = DimOffset($mapname,0) + p*DimDelta($mapname,0)	    FindLevel/q temp1 ImAxisCurveSlice	    ImAxisCurve_y[] = 0	    for (i=-ImAxisCurveRange;i<=ImAxisCurveRange;i+=1)	      ImAxisCurve_y[] += temp[V_LevelX+i][p]		 			    endfor 	      ImAxisCurve_y[]/=2*ImAxisCurveRange+1		else			 make/o/n=(epoints) ImAxisCurve_x, ImAxisCurve_y				  make/o/n=(kpoints) temp1	    ImAxisCurve_x[] = DimOffset($mapname,0) + p*DimDelta($mapname,0)	    temp1[] = DimOffset($mapname,1) + p*DimDelta($mapname,1)	    FindLevel/q temp1 ImAxisCurveSlice	    ImAxisCurve_y[] = 0 	  for (i=-ImAxisCurveRange;i<=ImAxisCurveRange;i+=1)	    ImAxisCurve_y[] += temp[p][V_LevelX+i]			  endfor		     ImAxisCurve_y[]/=2*ImAxisCurveRange+1		endifendFunction ImAxis_MemoListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "ImAxis_MemoList"	wave/t ImAxis_memoT	dowindow/f $panelname	if (v_flag!=1)	edit ImAxis_memoT	dowindow/c $panelname	endifend	proc ImAxis_saveNoProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string Axiscoeff	silent 1 ; pauseupdate	ImAxis_saveNo = varNum	if (ImAxis_savecheck)	Axiscoeff="ImAxis_coeff"+num2istr(ImAxis_saveNo)   ImAxis_saveNo_memo = ImAxis_memoT[ImAxis_saveNo]	 duplicate/o $Axiscoeff temp0	 ImAxis_oneSliceAngle=temp0[0]	 ImAxis_PiAngle=temp0[1]	 ImAxis_offset=temp0[2]	endifEndFunction ImAxis_SaveButtonProc (ctrlName) : ButtonControl	String ctrlName	 Nvar ImAxis_oneSliceAngle, ImAxis_PiAngle, ImAxis_offset, ImAxis_saveNo   string coeff   wave/t ImAxis_memoT   svar ImAxis_saveNo_memo   coeff="ImAxis_coeff"+num2istr(ImAxis_saveNo)   make/o/n=3 temp0   temp0 = {ImAxis_oneSliceAngle, ImAxis_PiAngle, ImAxis_offset}   duplicate/o temp0 $coeff   ImAxis_memoT[ImAxis_saveNo] = ImAxis_saveNo_memoEndFunction ImAxis_CheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar ImAxis_savecheck    ImAxis_savecheck = checkedEndFunction ImAxis_CreateMap (ctrlName) : ButtonControl	String ctrlName	Svar ImAxis_NewImageName	string ImName,panelName, descriptor, corrMap="ImAxis_corrMap"	string ColorCT, YesNo	wave ImAxis_ColorCT	Nvar ImAxis_InvertCheck	if (stringmatch(ImAxis_NewImageName,"")==1)	   abort "Input Image name!!"	endif	if (exists(ImAxis_NewImageName)==1) 	  Prompt YesNo, "Yes or No", popup, "Yes"+";No" 	  DoPrompt "There is this Image name. Do you want to replace?",  YesNo 	   if (stringmatch(YesNo,"No")==1) 	    abort      endif 	endif	ImName = ImAxis_NewImageName	panelName=ImAxis_NewImageName+"_panel"	ColorCT="ColorCT_"+ImAxis_NewImageName	duplicate/o ImAxis_ColorCT $ColorCT 	duplicate/o $corrMap $ImName	Dowindow/f $panelName	if (V_flag==1)	ModifyImage $ImName cindex= $ColorCT	endif	if (V_flag!=1)	 display/W=(279,112,683,496); 	 dowindow /c $panelName	AppendImage $ImName	ModifyImage $ImName cindex= $ColorCT//	ModifyGraph width={Aspect,1}	ModifyGraph zero=3	textbox/k/n=text0   sprintf descriptor " \\Z16%s ", ImName	Textbox/N=ImName /x=-32/y=40/F=0/A=MC descriptor	ModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdate	ModifyGraph swapXY=1	Label left "Energy (eV)"	Label bottom "\\f02k\\M\\f00 / \\F'Symbol'p"  endifEndendFunction ImAxis_Gammaproc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName     ImAxis_ColorSetfunc ()EndFunction ImAxis_showProc (ctrlName) : ButtonControlString ctrlName dowindow/f ImAxisPanelendFUnction GetImageNameFunc (ctrlName): ButtonControlString ctrlNameSvar ImAxis_ImageNamestring waveAll	waveAll = wavelist("*",";","win:")	ImAxis_ImageName = StringFromList(0, waveAll)endProc GoImAxisCorrFunc (ctrlName) : ButtonControlString ctrlNamevariable rrr, Theta_off, Theta_min, Theta_max, k_min, k_max, kpointssilent 1; pauseupdateduplicate/o $ImAxis_ImageName temp, temp1print ImAxis_ImageNamekpoints=dimsize($ImAxis_ImageName,1)rrr=1/sin(ImAxis_PiAngle/180*pi)Theta_off=asin(ImAxis_offset/rrr)Theta_min=-Theta_offk_min=rrr*sin(Theta_min)Theta_max=Theta_min+(kpoints-1)*(ImAxis_oneSliceAngle/180*pi)k_max=rrr*sin(Theta_max)setscale/I y, Theta_min, Theta_max, "" tempsetscale/I y, k_min, k_max, "" temp1temp1()() = temp(x)(asin(y/rrr))duplicate/o temp1 ImAxis_corrMapdowindow/f ImAxisPanelif (V_flag==1)  ImAxis_ColorSetfunc ()  ModifyImage ImAxis_corrMap cindex= ImAxis_ColorCTendifif (V_flag!=1)  display/W=(279,112,683,496);   dowindow/c ImAxisPanel  AppendImage ImAxis_corrMap  ImAxis_ColorSetfunc ()   ModifyImage ImAxis_corrMap cindex= ImAxis_ColorCT 	ModifyGraph tick=2	ModifyGraph zero=3	ModifyGraph mirror=1	ModifyGraph minor=1	ModifyGraph fSize=16	ModifyGraph standoff=0	ModifyGraph swapXY=1	Label left "Energy (eV)"	Label bottom "\\f02k\\M\\f00 / \\F'Symbol'p"endifendFunction 	ImAxis_ColorSetfunc ()	variable size, maxVal, minVal   Nvar ImAxis_Gammaval, ImAxis_InvertCheck   wave M_colors   Svar ImAxis_color      ColorTab2Wave $ImAxis_color      duplicate/o M_colors ImAxis_ColorCT      size = dimsize(ImAxis_ColorCT,0)        ImAxis_ColorCT[][] = M_colors[size*(p/size)^ImAxis_Gammaval][q]       wavestats/q ImAxis_corrMap       maxVal = V_max       minVal = V_min       if (ImAxis_InvertCheck==0)          setScale/I x,minVal,maxVal,"",ImAxis_ColorCT        elseif (ImAxis_InvertCheck==1)         setScale/I x,maxVal,minVal,"",ImAxis_ColorCT        endifendFunction ImAxis_ColorSetproc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar ImAxis_color    ImAxis_color = popStr    ImAxis_ColorSetfunc ()EndFunction ImAxis_InvertCheckProc (ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked   Nvar ImAxis_InvertCheck   ImAxis_InvertCheck = checked   ImAxis_ColorSetfunc ()EndFUnction wavelistfunc (ctrlName): ButtonControlString ctrlNamestring waveAll, printstrvariable Itemtotal, i	waveAll = wavelist("*",";","win:")	Itemtotal = ItemsInList(waveAll, ";")	for (i=0 ; i<Itemtotal; i+=1)	printstr = StringFromList(i, waveAll)	  print printstr	endforend/////////////////////////////////////////////		get and save color tables 	////////////////////////////////////////////Window getColortable() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(842,321,1076,507)	PopupMenu ListColor,pos={16,9},size={123,17},proc=showColortable,title="All colors"	PopupMenu ListColor,mode=23,popvalue="Magenta",value= #"CTabList()"	Button button0,pos={103,31},size={94,20},proc=getListOf256color,title="get 256 color"	PopupMenu ListColor1,pos={8,55},size={106,17},proc=showColortable,title="256 colors"	PopupMenu ListColor1,mode=23,popvalue="Mud",value= #"color256listStr"	Button button3,pos={58,78},size={111,20},proc=save256Colortable,title="save 256 colors"	Button button4,pos={131,124},size={76,20},proc=makeColorfunc,title="make color"	SetVariable setvar22,pos={16,127},size={101,15},title="name"	SetVariable setvar22,value= madeColorName	SetVariable setvar2,pos={25,104},size={72,15},title="from"	SetVariable setvar2,limits={0,inf,1},value= from_color	SetVariable AddSetvalue,pos={100,104},size={65,15},title="to"	SetVariable AddSetvalue,limits={1,inf,1},value= to_color	CheckBox auto1,pos={41,33},size={46,14},proc=To8bitCheck,title="8 bit ?"	CheckBox auto1,value= 1	Button button5,pos={96,149},size={111,20},proc=saveMadeColortable,title="save made color"EndMacroFunction saveMadeColortable (ctrlName) : ButtonControl	String ctrlName  Svar madeColorName  string filename        newpath/o colorFolder   		 filename = madeColorName+".txt"  		 Save/O/G/M="\r\n"/F/P=colorFolder  $madeColorName as filename         EndFunction To8bitCheck(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	Nvar changeTo8bitCheckchangeTo8bitCheck=checkedEndFunction makeColorfunc (ctrlName) : ButtonControl	String ctrlName	svar madeColorName	wave M_colors//, M_InterpolatedImage	Nvar from_color, to_color, changeTo8bitCheck	variable spaceNum, resultSize, INTcoeff	spaceNum = to_color-from_color	make/o/n=(spaceNum+1,3) ColorMat	ColorMat[][]=M_colors[from_color+p][q]	resultSize=dimsize(M_colors,0)	INTcoeff=(resultSize-1)/spaceNum	ImageInterpolate /f={INTcoeff,1} bilinear ColorMat			if (changeTo8bitCheck==1)     changeTo8bit ( M_InterpolatedImage )      endif	duplicate/o M_InterpolatedImage $madeColorName  dowindow/f madeColorpanel  if (V_flag==0)  	edit  	dowindow/c madeColorpanel  	appendtotable $madeColorName  endifEndFunction save256Colortable (ctrlName) : ButtonControl	String ctrlName     string filename, colorstr     svar color256listStr     nvar changeTo8bitCheck      variable itemNum, i      wave M_colors      newpath/o colorFolder     itemNum = ItemsInList(color256listStr)     for (i=0;i<itemNum;i+=1)          colorstr = StringFromList(i,color256listStr)          ColorTab2Wave $colorstr		if (changeTo8bitCheck==1)     changeTo8bit ( M_colors )      endif   				filename = colorstr+".txt"  		 Save/O/G/M="\r\n"/F/P=colorFolder  M_colors as filename              endforEndfunction  changeTo8bit(original)wave original	Redimension/D original	wavestats/q original	original/=V_max	original*=255	Redimension/B/U original        end                    Function getListOf256color (ctrlName) : ButtonControl	String ctrlName	string colorListStr, eachColor, color256list=""	variable itemNum, i , N	svar color256listStr	colorListStr = CTabList()	itemNum =  ItemsInList(colorListStr)    for (i=0;i<itemNum;i+=1)    		eachColor =  StringFromList(i, colorListStr)    		ColorTab2Wave $eachColor    		duplicate/o M_colors $eachColor    		N = dimsize($eachColor,0)    		if (N==256)    		   color256list+=eachColor+";"   		      		endif    	endfor     color256listStr = color256listEndProc showColortable (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	ColorName = popStr	ColorTab2Wave $colorName		if (changeTo8bitCheck==1)     changeTo8bit ( M_colors )      endif		dowindow/f colortable	if  (v_flag==0)		edit 		dowindow/c colortable		appendtotable M_colors	endif	showColorBar(colorName)EndWindow showColorBar(colorName) : Graph	string colorName	PauseUpdate; Silent 1		// building window...	dowindow/f colorBar	if (v_flag==0)		Display /W=(375,151,468,412)		dowindow/c colorBar     	 endif		ColorScale/C/N=text0/F=0/A=MC  ctab={0,100,$colorName,0}				EndMacroproc ExtractFS (ctrlName) : ButtonControl	String ctrlNamestring/g getfs_newGoffset="G0000"string/g getfs_Goffset="G0000"string/g getfs_newFSnamestring/g getfs_FSliststring/g getfs_calliststring/g getfs_FSnamestring/g getfs_calnamevariable/g getfs_numvariable/g getfs_graphvariable/g getfs_rotationvariable/g getfs_thetavariable/g getfs_phivariable/g getfs_slicevariable/g getfs_newnum//variable/g getfs_PhiAngle//variable/g getfs_SliceAnglestring/g getfs_ScientaMode="14;30"variable/g getfs_hv=PhotoEnergyvariable/g getfs_latticeCvariable/g getfs_latticeA=LatticeConstant//variable/g getfs_ScientaAngle=14variable/g getfs_workfunction=workfunctionvariable/g getfs_thetaNivariable/g getfs_thetaNfvariable/g getfs_thetaSvariable/g getfs_thetaDvariable/g getfs_GraphNivariable/g getfs_GraphNfvariable/g getfs_GraphSvariable/g getfs_GraphDvariable/g getfs_SliceAngle=SliceAngledowindow/f GetFSif(v_flag!=1)GetFS()endifendWindow GetFS() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(405,487,816,823) as "GetFS"	SetDrawLayer UserBack	SetDrawEnv fillfgc= (65280,59904,48896),fillbgc= (65280,59904,48896)	DrawRect 206,4,402,70	SetDrawEnv fillfgc= (32768,54528,65280),fillbgc= (32768,54528,65280)	DrawRect 4,76,314,179	SetDrawEnv fillfgc= (32768,54528,65280),fillbgc= (32768,54528,65280)	DrawRect 5,185,406,235	DrawText 16,205,"No"	DrawText 63,205,"Goffset"	DrawText 135,206,"Graph"	DrawText 189,205,"Rotation"	DrawText 303,204,"Theta"	DrawText 253,205,"Phi"	DrawText 360,204,"Slice"	SetDrawEnv fillfgc= (65280,59904,48896),fillbgc= (65280,59904,48896)	DrawRect 4,4,200,70	DrawText 72,99,"No"	DrawText 25,120,"Graph:"	DrawText 28,167,"Theta:"	DrawText 124,99,"No"	DrawText 110,168,"to"	DrawText 109,121,"to"	DrawText 215,99,"delta"	DrawText 172,99,"Graphi"	SetDrawEnv fillfgc= (65280,59904,48896),fillbgc= (65280,59904,48896)	DrawRect 5,262,256,326	PopupMenu popup0,pos={53,208},size={67,21},proc=getfs_Goffsetfunc,title=" "	PopupMenu popup0,mode=2,popvalue="G1000",value= #"StringList(\"G*000\",\";\")"	SetVariable setvar0,pos={10,210},size={41,18},proc=getfs_FSnumfunc,title=" "	SetVariable setvar0,limits={0,inf,1},value= getfs_num	SetVariable setvar1,pos={131,210},size={52,18},title=" "	SetVariable setvar1,limits={1,inf,1},value= getfs_graph	SetVariable setvar2,pos={192,210},size={46,18},title=" ",value= getfs_rotation	SetVariable setvar3,pos={296,210},size={53,18},title=" ",value= getfs_theta	SetVariable setvar4,pos={244,210},size={50,18},title=" ",value= getfs_phi	Button button1,pos={9,239},size={17,17},proc=getfs_addpoint,title="+"	Button button2,pos={328,106},size={73,26},proc=getfs_showtable,title="ShowList"	Button button2,fStyle=1	Button button3,pos={129,41},size={62,22},proc=Getfs_newFS,title="CreatFS"	Button button4,pos={193,267},size={56,29},proc=getfs_calFS,title="GetFS"	Button button4,fSize=14,fStyle=1	SetVariable setvar5,pos={10,42},size={111,18},title=" ",value= getfs_newFSname	PopupMenu popup1,pos={211,11},size={124,21},proc=Getfs_FSnamefunc,title="FS sheets"	PopupMenu popup1,mode=1,popvalue="Gamma",value= #"root:getfs_FSlist"	SetVariable setvar6,pos={352,209},size={50,18},title=" "	SetVariable setvar6,limits={0,inf,1},value= getfs_slice	PopupMenu popup2,pos={6,11},size={67,21},proc=getfs_newGoffsetfunc,title=" "	PopupMenu popup2,mode=2,popvalue="G1000",value= #"StringList(\"G*000\",\";\")"	SetVariable setvar7,pos={84,12},size={107,18},title="Points No"	SetVariable setvar7,limits={1,inf,1},value= getfs_newnum	SetVariable setvar8,pos={11,273},size={87,18},title="hv (eV)"	SetVariable setvar8,limits={1,inf,1},value= getfs_hv	SetVariable setvar9,pos={13,303},size={85,18},title="a (A)"	SetVariable setvar9,limits={0,inf,0.1},value= getfs_latticeA	SetVariable setvar10,pos={102,274},size={83,18},title="WF(eV)"	SetVariable setvar10,limits={0,inf,0.1},value= getfs_workfunction	Button button5,pos={343,12},size={46,18},proc=getfs_delFSsheet,title="Delete"	Button button6,pos={28,239},size={18,17},proc=getfs_delpoint,title="-"	Button button0,pos={253,239},size={22,19},proc=getfs_PhifromFS,title="FS"	Button button7,pos={109,126},size={53,20},proc=getfs_PhiAll,title="Phi"	Button button8,pos={199,239},size={22,19},proc=getfs_RotafromFS,title="FS"	Button button9,pos={261,151},size={26,19},proc=getfs_settheta,title="Go"	SetVariable setvar02,pos={70,103},size={36,18},title=" "	SetVariable setvar02,limits={0,inf,1},value= getfs_GraphNi	SetVariable setvar03,pos={121,103},size={36,18},title=" "	SetVariable setvar03,limits={0,inf,1},value= getfs_GraphNf	SetVariable setvar04,pos={176,103},size={36,18},title=" "	SetVariable setvar04,limits={1,inf,1},value= getfs_GraphS	SetVariable setvar05,pos={219,103},size={36,18},title=" ",value= getfs_GraphD	SetVariable setvar06,pos={71,151},size={36,18},title=" "	SetVariable setvar06,limits={0,inf,1},value= getfs_thetaNi	SetVariable setvar07,pos={122,151},size={36,18},title=" "	SetVariable setvar07,limits={0,inf,1},value= getfs_thetaNf	SetVariable setvar08,pos={177,152},size={36,18},title=" ",value= getfs_thetaS	SetVariable setvar09,pos={220,152},size={36,18},title=" ",value= getfs_thetaD	Button button10,pos={168,127},size={55,19},proc=getfs_RotaAll,title="Rotation"	Button button11,pos={260,101},size={26,21},proc=getfs_setgraph,title="Go"	SetVariable setvar11,pos={109,303},size={138,18},title="one slice (deg)"	SetVariable setvar11,limits={0,inf,0.01},value= getfs_SliceAngle	Button button05,pos={277,300},size={44,22},proc=getfs_ap2FS,title="to FS"	Button button05,fSize=12,fStyle=0	Button button06,pos={338,300},size={44,22},proc=getfs_ap2top,title="to top"	Button button06,fSize=12,fStyle=0	PopupMenu popup3,pos={272,270},size={108,21},proc=getfs_calfsfunc,title="FS sheets"	PopupMenu popup3,mode=1,popvalue="bets",value= #"root:getfs_callist"	Button button12,pos={230,127},size={55,19},proc=getfs_ThetaAll,title="Theta"	Button button13,pos={25,127},size={71,21},proc=getfs_angleAll,title="All Angles"	Button button13,fStyle=1EndMacroFunction Getfs_newFS(ctrlName) : ButtonControl	String ctrlName	svar getfs_newFSname	svar getfs_FSlist	svar getfs_newGoffset	svar getfs_FSname	nvar getfs_num	nvar getfs_newnum	string YesNo	string goffsetlist="getfs_"+getfs_newFSname+"_Goffset"	string graphlist="getfs_"+getfs_newFSname+"_Graph"	string rotationlist="getfs_"+getfs_newFSname+"_Rotation"	string thetalist="getfs_"+getfs_newFSname+"_Theta"	string philist="getfs_"+getfs_newFSname+"_Phi"	string slicelist="getfs_"+getfs_newFSname+"_Slice"	string kxlist="getfs_"+getfs_newFSname+"_Kx"	string kylist="getfs_"+getfs_newFSname+"_Ky"		string tempfsname	variable ii, iimax	variable check=0	iimax=ItemsInList(getfs_FSlist)	ii=0	do	tempfsname=stringfromlist(ii,getfs_FSlist)	if(stringmatch(tempfsname, getfs_newFSname))	 			check=1 	  	Prompt YesNo, "Yes or No", popup, "Yes"+";No" 	  	DoPrompt "There is this 'FS' name. Do you want to replace?",  YesNo 	  	if( stringmatch(YesNo,"yes")==1) 	  	Redimension/n=(getfs_newnum) $graphlist, $rotationlist, $thetalist, $philist, $slicelist, $kxlist, $kylist  	  	endif 	  	break 	endif 	ii+=1 	while(ii<iimax) 	 	if(check==0) 		if(strlen(getfs_FSlist)>0) 		getfs_FSlist=getfs_FSlist+";"+getfs_newFSname	 		else 		getfs_FSlist=getfs_newFSname	 		endif 		make/o/n=(getfs_newnum) $graphlist, $rotationlist, $thetalist, $philist, $slicelist, $kxlist, $kylist  	endif	getfs_num=1	getfs_FSname=getfs_newFSname	PopupMenu popup1,mode=1,popvalue=getfs_FSname,value= #"root:getfs_FSlist"		getfs_showtable("")	getfs_FSnumfunc("",getfs_num,"","")EndFunction Getfs_FSnamefunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar getfs_FSname	nvar getfs_num	getfs_FSname=popStr	getfs_num=1	getfs_FSnumfunc("",getfs_num,"","")EndFunction getfs_FSnumfunc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName		svar getfs_Goffset	svar getfs_FSname		nvar getfs_num	nvar getfs_graph	nvar getfs_rotation	nvar getfs_theta	nvar getfs_phi	nvar getfs_slice	if(strlen(getfs_FSname)>0)		string graphlist="getfs_"+getfs_FSname+"_Graph"		string rotationlist="getfs_"+getfs_FSname+"_Rotation"		string thetalist="getfs_"+getfs_FSname+"_Theta"		string philist="getfs_"+getfs_FSname+"_Phi"		string slicelist="getfs_"+getfs_FSname+"_Slice"		string kxlist="getfs_"+getfs_FSname+"_Kx"		string kylist="getfs_"+getfs_FSname+"_Ky"			if(getfs_num+1>dimsize($graphlist,0))//		Redimension/n=(getfs_num) $goffsetlist, $graphlist, $rotationlist, $thetalist, $philist, $slicelist, $kxlist, $kylist 			getfs_graph=0			getfs_rotation=0			getfs_theta=0			getfs_phi=0			getfs_slice=0		else			duplicate/o $graphlist getfs_temp			getfs_graph=getfs_temp[getfs_num]-1000*floor(getfs_temp[getfs_num]/1000)			if(floor(getfs_temp[getfs_num]/1000)==0)			getfs_Goffset="G0000"			else			getfs_Goffset="G"+num2str(1000*floor(getfs_temp[getfs_num]/1000))			endif			PopupMenu popup0,mode=1,popvalue=getfs_Goffset,value= #"StringList(\"G*000\",\";\")"						duplicate/o $rotationlist getfs_temp			getfs_rotation=getfs_temp[getfs_num]			duplicate/o $thetalist getfs_temp			getfs_theta=getfs_temp[getfs_num]			duplicate/o $philist getfs_temp			getfs_phi=getfs_temp[getfs_num]			duplicate/o $slicelist getfs_temp			getfs_slice=getfs_temp[getfs_num]		endif	endifEndFunction getfs_addpoint(ctrlName) : ButtonControl	String ctrlName		svar getfs_FSname		svar getfs_Goffset	nvar getfs_num	nvar getfs_graph	nvar getfs_rotation	nvar getfs_theta	nvar getfs_phi	nvar getfs_slice	if(strlen(getfs_FSname)>0)		string graphlist="getfs_"+getfs_FSname+"_Graph"		string rotationlist="getfs_"+getfs_FSname+"_Rotation"		string thetalist="getfs_"+getfs_FSname+"_Theta"		string philist="getfs_"+getfs_FSname+"_Phi"		string slicelist="getfs_"+getfs_FSname+"_Slice"		string kxlist="getfs_"+getfs_FSname+"_Kx"		string kylist="getfs_"+getfs_FSname+"_Ky"				if(getfs_num+1>dimsize($graphlist,0))			Redimension/n=(getfs_num+1) $graphlist, $rotationlist, $thetalist, $philist, $slicelist, $kxlist, $kylist 		endif				duplicate/o $graphlist getfs_temp		getfs_temp[getfs_num]=str2num(getfs_Goffset[1,4])+getfs_graph		duplicate/o getfs_temp $graphlist 				duplicate/o $rotationlist getfs_temp		getfs_temp[getfs_num]=getfs_rotation		duplicate/o  getfs_temp $rotationlist					duplicate/o $thetalist getfs_temp		getfs_temp[getfs_num]=getfs_theta		duplicate/o getfs_temp $thetalist 					duplicate/o $philist getfs_temp		getfs_temp[getfs_num]=getfs_phi		duplicate/o getfs_temp $philist					duplicate/o $slicelist getfs_temp		getfs_temp[getfs_num]=getfs_slice		duplicate/o getfs_temp $slicelist	endifEndFunction getfs_showtable(ctrlName) : ButtonControl	String ctrlName	svar getfs_FSname		svar getfs_Goffset	nvar getfs_num	nvar getfs_graph	nvar getfs_rotation	nvar getfs_theta	nvar getfs_phi	nvar getfs_slice	if(strlen(getfs_FSname)>0)		string graphlist="getfs_"+getfs_FSname+"_Graph"		string rotationlist="getfs_"+getfs_FSname+"_Rotation"		string thetalist="getfs_"+getfs_FSname+"_Theta"		string philist="getfs_"+getfs_FSname+"_Phi"		string slicelist="getfs_"+getfs_FSname+"_Slice"		string kxlist="getfs_"+getfs_FSname+"_Kx"		string kylist="getfs_"+getfs_FSname+"_Ky"				string tablename="FSlist_"+getfs_FSname		dowindow/f  $tablename		if(V_flag==0)		edit/N=$tablename $graphlist, $thetalist, $rotationlist, $philist, $slicelist, $kxlist, $kylist as tablename		endif	endifEndFunction getfs_newGoffsetfunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar getfs_newGoffset	getfs_newGoffset=popStrEndFunction getfs_Goffsetfunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar getfs_Goffset	getfs_Goffset=popStrEndFunction getfs_calfs(ctrlName) : ButtonControl	String ctrlName	svar getfs_FSname	svar getfs_callist	svar getfs_calname	svar dispwave	nvar getfs_hv	nvar getfs_latticeA	nvar getfs_SliceAngle		nvar getfs_workfunction	variable aa=getfs_latticeA*10^-10	variable momentum=getKval(getfs_hv, getfs_workfunction, getfs_latticeA)	if(strlen(getfs_FSname)>0)		string graphlist="getfs_"+getfs_FSname+"_Graph"		string rotationlist="getfs_"+getfs_FSname+"_Rotation"		string thetalist="getfs_"+getfs_FSname+"_Theta"		string philist="getfs_"+getfs_FSname+"_Phi"		string slicelist="getfs_"+getfs_FSname+"_Slice"		string kxlist="getfs_"+getfs_FSname+"_Kx"		string kylist="getfs_"+getfs_FSname+"_Ky"				duplicate/o $graphlist getfs_tempgraph		duplicate/o $rotationlist getfs_temprotation		duplicate/o $thetalist getfs_temptheta		duplicate/o $philist getfs_tempphi		duplicate/o $slicelist getfs_tempslice		duplicate/o $kxlist getfs_tempkx		duplicate/o $kylist getfs_tempky		string graphname		variable SliceAngle=getfs_SliceAngle			variable cutnum=dimsize($graphlist,0)		variable xval=0		variable Kx, Ky, Kx1,Ky1		variable ii=0		variable Phi, Theta,Rotation		do		graphname=dispwave+num2str(getfs_tempgraph[ii])		Phi=getfs_tempphi[ii]*(pi/180)		Theta=-getfs_temptheta[ii]*(pi/180)		Rotation=getfs_temprotation[ii]*(pi/180)				xval=SliceAngle*(getfs_tempslice[ii]-dimsize($graphname,1)/2)				xval=xval*pi/180		Kx=sin(Theta)*cos(xval)*momentum		Ky=-sin(Phi)*cos(Theta)*cos(xval) *momentum+cos(Phi)*sin(xval) *momentum		Kx1=Kx*cos(Rotation)-Ky*sin(Rotation)		Ky1=Kx*sin(Rotation)+Ky*cos(Rotation)		getfs_tempkx[ii]=Kx1		getfs_tempky[ii]=Ky1		ii+=1		while(ii<cutnum)				duplicate/o  getfs_tempkx $kxlist		duplicate/o  getfs_tempky $kylist		if(strlen(getfs_callist)==0)		getfs_callist=getfs_FSname				else				string tempfsname				variable jj, jjmax				variable check=0				jjmax=ItemsInList(getfs_callist)				jj=0				do				tempfsname=stringfromlist(jj,getfs_callist)				if(stringmatch(tempfsname, getfs_FSname))	 					check=1 	  			break 				endif 				jj+=1 				while(jj<jjmax)				if(check==0)				getfs_callist=getfs_callist+";"+getfs_FSname				endif		endif		getfs_calname=getfs_FSname		PopupMenu popup3,mode=1,popvalue=getfs_calname,value= #"root:getfs_callist"	endifEndFunction getfs_modefunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	nvar getfs_ScientaAngle	getfs_ScientaAngle=str2num(popStr)EndFunction getfs_delFSsheet(ctrlName) : ButtonControl	String ctrlName	svar getfs_FSname	svar getfs_FSlist	string tempfsname,templist	variable ii, iimax	iimax=ItemsInList(getfs_FSlist)	ii=0	do	tempfsname=stringfromlist(ii,getfs_FSlist)	if(stringmatch(tempfsname, getfs_FSname))		string tablename="FSlist_"+tempfsname		print  tablename		dowindow/K  $tablename		string graphlist="getfs_"+tempfsname+"_Graph"		string rotationlist="getfs_"+tempfsname+"_Rotation"		string thetalist="getfs_"+tempfsname+"_Theta"		string philist="getfs_"+tempfsname+"_Phi"		string slicelist="getfs_"+tempfsname+"_Slice"		string kxlist="getfs_"+tempfsname+"_Kx"		string kylist="getfs_"+tempfsname+"_Ky"				killwaves/z $graphlist		killwaves/z $rotationlist		killwaves/z $thetalist		killwaves/z $philist		killwaves/z $slicelist		killwaves/z $kxlist		killwaves/z $kylist		if(iimax==1)			getfs_FSname=""		elseif(ii==0)			getfs_FSname=stringfromlist(1,getfs_FSlist)		else			getfs_FSname=stringfromlist(ii-1,getfs_FSlist)		endif		PopupMenu popup1,mode=1,popvalue=getfs_FSname,value= #"root:getfs_FSlist"	else			if(strlen(templist)>0)		templist=templist+";"+tempfsname		else		templist=tempfsname		endif	endif	ii+=1	while(ii<iimax)	getfs_FSlist=templist	getfs_FSnumfunc("",1,"","")EndFunction getfs_PhifromFS(ctrlName) : ButtonControl	String ctrlName	nvar getfs_phi		nvar readPhi	nvar offPhi		getfs_phi=readPhi-offPhiEndFunction getfs_RotafromFS(ctrlName) : ButtonControl	String ctrlName	nvar getfs_rotation		nvar readRota	nvar offRota		getfs_rotation=readRota-offRotaEndFunction getfs_PhiAll(ctrlName) : ButtonControl	String ctrlName	nvar getfs_phi	svar getfs_FSname	nvar offPhi	wave map	string philist="getfs_"+getfs_FSname+"_Phi"	string graphlist="getfs_"+getfs_FSname+"_Graph"	duplicate/o $graphlist temp1	duplicate/o $philist temp2	temp2 =  map[temp1[p]][11]-offPhi	duplicate/o  temp2 $philistEndFunction getfs_RotaAll(ctrlName) : ButtonControl	String ctrlName	nvar getfs_phi	svar getfs_FSname	nvar offRota	wave map	string rotationlist="getfs_"+getfs_FSname+"_Rotation"	string graphlist="getfs_"+getfs_FSname+"_Graph"	duplicate/o $graphlist temp1	duplicate/o $rotationlist temp2	temp2 =  map[temp1[p]][12]-offRota	duplicate/o  temp2 $rotationlistEndFunction getfs_ThetaAll(ctrlName) : ButtonControl	String ctrlName	nvar getfs_phi	svar getfs_FSname	nvar offTheta	wave map	string thetalist="getfs_"+getfs_FSname+"_Theta"	string graphlist="getfs_"+getfs_FSname+"_Graph"	duplicate/o $graphlist temp1	duplicate/o $thetalist temp2	temp2 =  map[temp1[p]][6]-offTheta	duplicate/o  temp2 $thetalistEndFunction getfs_angleAll(ctrlName) : ButtonControl	String ctrlName	getfs_ThetaAll(ctrlName)	getfs_RotaAll(ctrlName) 	getfs_PhiAll(ctrlName) EndFunction getfs_settheta(ctrlName) : ButtonControl	String ctrlName	nvar Ni=getfs_ThetaNi	nvar Nf=getfs_ThetaNf	nvar Start=getfs_ThetaS	nvar delta=getfs_ThetaD	svar getfs_FSname	string listname	listname="getfs_"+getfs_FSname+"_theta"	duplicate/o $listname getfs_temp	getfs_temp[Ni,Nf]=Start+delta*(p-Ni)	duplicate/o getfs_temp $listname EndFunction getfs_setgraph(ctrlName) : ButtonControl	String ctrlName	nvar Ni=getfs_graphNi	nvar Nf=getfs_graphNf	nvar Start=getfs_graphS	nvar delta=getfs_graphD	svar getfs_Goffset	svar getfs_FSname	string listname	variable gnum=str2num(getfs_Goffset[1,4])	listname="getfs_"+getfs_FSname+"_graph"	duplicate/o $listname getfs_temp	getfs_temp[Ni,Nf]=Start+delta*(p-Ni)+gnum	duplicate/o getfs_temp $listname EndFunction getfs_delpoint(ctrlName) : ButtonControl	String ctrlName	nvar getfs_num	svar getfs_FSname	if(strlen(getfs_FSname)>0)		string graphlist="getfs_"+getfs_FSname+"_Graph"		string rotationlist="getfs_"+getfs_FSname+"_Rotation"		string thetalist="getfs_"+getfs_FSname+"_Theta"		string philist="getfs_"+getfs_FSname+"_Phi"		string slicelist="getfs_"+getfs_FSname+"_Slice"		string kxlist="getfs_"+getfs_FSname+"_Kx"		string kylist="getfs_"+getfs_FSname+"_Ky"						variable points= dimsize($graphlist,0)		if(getfs_num<points)		getfs_dellistpoints(graphlist,getfs_num)			getfs_dellistpoints(rotationlist,getfs_num)			getfs_dellistpoints(thetalist,getfs_num)			getfs_dellistpoints(philist,getfs_num)			getfs_dellistpoints(slicelist,getfs_num)			getfs_dellistpoints(Kxlist,getfs_num)			getfs_dellistpoints(Kylist,getfs_num)			endif	endifEndfunction getfs_dellistpoints(listname,delnum)	string listname	variable delnum		duplicate/o $listname getfs_temp		variable points= dimsize($listname,0)		getfs_temp[delnum,points-2]=getfs_temp[p+1]		redimension/n=(points-1) getfs_temp		duplicate/o  getfs_temp $listname	endFunction getfs_ap2FS(ctrlName) : ButtonControl	String ctrlName	svar getfs_calname	string kxlist="getfs_"+getfs_calname+"_Kx"	string kylist="getfs_"+getfs_calname+"_Ky"	dowindow/f RotatedMapping	if(V_flag==1)	appendtograph $kylist vs $kxlist	ModifyGraph mode($kylist)=3	ModifyGraph marker($kylist)=19	endif	EndFunction getfs_ap2top(ctrlName) : ButtonControl	String ctrlName	svar getfs_calname	string kxlist="getfs_"+getfs_calname+"_Kx"	string kylist="getfs_"+getfs_calname+"_Ky"	appendtograph $kylist vs $kxlist	ModifyGraph mode($kylist)=3	ModifyGraph marker($kylist)=19EndFunction getfs_calfsfunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar getfs_calname	getfs_calname=popStrEndFunction D2nd_Goffsetproc (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	Nvar D2nd_graph, D2nd_Goffvalue		if (stringmatch(popStr,"_none_"))   		return -1// User canceled   	endif  	sscanf popStr, "G%f", D2nd_Goffvalue  	D2nd_graph=mod(D2nd_graph,1000)+D2nd_Goffvalue  	D2d_ChangeGraph ("",1,"","") EndFunction D2d_ChangeGraph (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr, varName	nvar D2nd_graph, D2nd_Goffvalue	svar D2nd_dispWave	WAVE map, GrAllNum, NrAllNumif (D2nd_graph<100000)	  if (D2nd_graph < D2nd_Goffvalue)   for (D2nd_graph=D2nd_graph;D2nd_graph <= D2nd_Goffvalue+1000;D2nd_graph+=1000)   endfor  endif	if ( D2nd_graph<1 )		D2nd_graph=1	endif	if (stringmatch(D2nd_dispwave,"gr") && D2nd_graph>D2nd_Goffvalue+GrAllNum[D2nd_Goffvalue/1000] )		D2nd_graph=D2nd_Goffvalue+GrAllNum[D2nd_Goffvalue/1000]	endif  if (stringmatch(D2nd_dispwave,"nr") &&D2nd_graph>D2nd_Goffvalue+NrAllNum[D2nd_Goffvalue/1000] )		D2nd_graph=D2nd_Goffvalue+NrAllNum[D2nd_Goffvalue/1000]	endif	if( D2nd_graph==D2nd_Goffvalue)	D2nd_graph=D2nd_graph+1	endifendif	if ( D2nd_graph>map[0][0] )		D2nd_graph=map[0][0]	endif		dowindow D2nd_ImageW	if(V_flag==1)	D2nd_showimg("") 	endifEndFunction D2nd_showimg(ctrlName) : ButtonControl	String ctrlName	svar D2nd_dispWave	nvar D2nd_graph	wave map	string grapname=D2nd_dispWave+num2istr(D2nd_graph)	string  Xaxis	if (exists(grapname)==0)    		abort "No such a data!!"  	 endif  	 if (stringmatch(D2nd_dispWave,"cr"))    	 Xaxis = "cx"+num2istr(D2nd_graph)    	else		 Xaxis = "gx"+num2istr(D2nd_graph)	  endif	  duplicate /o $Xaxis D2ndX  		 if (stringmatch(D2nd_dispWave,"cr")==0)       D2ndX  -=map[D2nd_graph][7]       endif       	variable est = D2ndX [0]	variable de = D2ndX [1]-est	  	 duplicate/o $grapname D2ndimg  	 SetScale/P x est,de,"", D2ndimg  	 dowindow/f D2nd_ImageW  	  if (V_flag!=1)  	  	Display /W=(5,42,377,293)/n=D2nd_ImageW as "D2nd_ImageW"  		 AppendImage D2ndimg		 ModifyGraph swapXY=1		ModifyImage D2ndimg ctab= {*,*,Rainbow,1}		 ModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdate    		 Label bottom "Slice";DelayUpdate     		Label left "Energy (eV)"  	  endifEndFunction D2nd_Data_type(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	String/g D2nd_dispWave	if ( popnum==1 ) 		D2nd_dispWave="gr"	elseif ( popnum==2 )		D2nd_dispWave="nr"	elseif ( popnum==3 )		D2nd_dispWave="cr"	endif	D2d_ChangeGraph ("",1,"","")EndFunction D2nd_difmodefuc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	nvar D2nd_mode	 D2nd_mode=popnumEndFunction D2nd_dimfunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	nvar D2nd_dim	 D2nd_dim=popnumEndFunction D2nd_difimg(ctrlName) : ButtonControl	String ctrlName	nvar D2nd_graph,D2nd_dim	wave Dif2dwave	string filename	D2nd_difCal2D()	D2nd_showdif2D("")	if(D2nd_dim==1)	filename="difEDC"+num2str(D2nd_graph)	elseif(D2nd_dim==2)	filename="difMDC"+num2str(D2nd_graph)	endif	duplicate/o Dif2dwave $filename	TextBox/C/N=imagename/F=0/A=MC/X=-38.00/Y=45.00 "\\f01"+filenameendFunction D2nd_difmultiImg(ctrlName) : ButtonControl	String ctrlName	nvar D2nd_graphi	nvar D2nd_graphf	nvar Goffset	svar D2nd_dispWave	nvar D2nd_graph,D2nd_dim,d2nd_2dchecked	wave deriva2dwave	variable graphi	variable graphf	if(d2nd_2dchecked==0)	graphi=mod(D2nd_graphi,1000)	graphf=mod(D2nd_graphf,1000)		string offsetstr	if (Goffset==0)   		offsetstr = "G0000"  	else   		offsetstr = "G"+num2str(Goffset)  	endif	Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")		Prompt graphi, "startG: "      Prompt graphf, "lastG.: "       Doprompt "Derivative Parameter",  offsetstr, graphi, graphf         if (V_Flag)            return -1// User canceled         endif                        elseif(d2nd_2dchecked==1)        graphi=0        graphf=dimsize(deriva2dwave,0)        endif                variable offset 	sscanf offsetstr, "G%f", offset 	graphi+=offset 	graphf+=offset 	D2nd_graphi=graphi        D2nd_graphf=graphf         variable j        string imgname, filename               for (j=graphi; j<=graphf; j+=1)        	D2nd_graph=j        	if(d2nd_2dchecked==1)        	D2nd_graph=deriva2dwave[j]        	endif        	imgname=D2nd_dispWave+num2str(D2nd_graph)        	        	if(waveexists($imgname))        		D2nd_difCal2D()        		if(D2nd_dim==1)			filename="difEDC"+num2str(D2nd_graph)			elseif(D2nd_dim==2)			filename="difMDC"+num2str(D2nd_graph)			endif			duplicate/o Dif2dwave $filename        	endif        	print num2str(j+1-graphi)+"/"+num2str(graphf+1-graphi)        endfor                D2nd_showdif2D("")        TextBox/C/N=imagename/F=0/A=MC/X=-38.00/Y=45.00 "\\f01"+filenameEndfunction D2nd_difCal2D()nvar D2nd_mode, D2nd_dimsvar D2nd_dispWavenvar D2nd_graphnvar D2nd_avgEDC, D2nd_avgMDCwave mapstring grapname=D2nd_dispWave+num2istr(D2nd_graph)string  Xaxis	if (exists(grapname)==0)    		abort "No such a data!!"  	 endif  	 if (stringmatch(D2nd_dispWave,"cr"))    	 Xaxis = "cx"+num2istr(D2nd_graph)    	else		 Xaxis = "gx"+num2istr(D2nd_graph)	  endif	  duplicate /o $Xaxis D2ndX  		 if (stringmatch(D2nd_dispWave,"cr")==0)       	D2ndX  -=map[D2nd_graph][7]       endif       	variable est = D2ndX [0]	variable de = D2ndX [1]-est	  	 duplicate/o $grapname Dif2dwave  	 SetScale/P x est,de,"", Dif2dwave	variable i	variable mean_slicesif(D2nd_dim==1)  // along EDC	duplicate/o Dif2dwave  temp0	temp0=0	mean_slices=D2nd_avgEDC	 for (i=-mean_slices ; i<=mean_slices ; i+=1)  		 temp0+=Dif2dwave[p+i][q]  	endfor   	duplicate/o  temp0 Dif2dwave	if(D2nd_mode==1)		D2nd_difCalm1EDC()	elseif(D2nd_mode==2)		D2nd_difCalm2EDC()		//	elseif(D2nd_mode==3)	endifendifif(D2nd_dim==2) // along MDC	duplicate/o Dif2dwave  temp0	temp0=0	mean_slices=round( D2nd_avgMDC/(de*1000) )	 for (i=-mean_slices ; i<=mean_slices ; i+=1)  		 temp0+=Dif2dwave[p][q+i]  	endfor   	duplicate/o  temp0 Dif2dwave	if(D2nd_mode==1)		D2nd_difCalm1MDC()	elseif(D2nd_mode==2)		D2nd_difCalm2MDC()		//	elseif(D2nd_mode==3)	endifendifendfunction D2nd_difCalm1EDC()wave Dif2dwavenvar D2nd_EDCsm1,D2nd_EDCsm2, D2nd_EDCsm3if(D2nd_EDCsm1>1)smooth/dim=0 D2nd_EDCsm1, Dif2dwaveendifdifferentiate/Dim=0 Dif2dwaveif(D2nd_EDCsm2>1)smooth/dim=0 D2nd_EDCsm2, Dif2dwaveendifdifferentiate/Dim=0 Dif2dwaveif(D2nd_EDCsm3>1)smooth/dim=0 D2nd_EDCsm3, Dif2dwaveendifDif2dwave=-1*Dif2dwaveDif2dwave=Dif2dwave[p][q]>0?Dif2dwave[p][q]:0endfunction D2nd_difCalm1MDC()wave Dif2dwavenvar D2nd_MDCsm1,D2nd_MDCsm2, D2nd_MDCsm3if(D2nd_MDCsm1>1)smooth/dim=1 D2nd_MDCsm1, Dif2dwaveendifdifferentiate/Dim=1 Dif2dwaveif(D2nd_MDCsm2>1)smooth/dim=1 D2nd_MDCsm2, Dif2dwaveendifdifferentiate/Dim=1 Dif2dwaveif(D2nd_MDCsm3>1)smooth/dim=1 D2nd_MDCsm3, Dif2dwaveendifDif2dwave=-1*Dif2dwaveDif2dwave=Dif2dwave[p][q]>0?Dif2dwave[p][q]:0endfunction D2nd_difCalm2EDC()wave Dif2dwavenvar dE_points=D2nd_EDCfitpointsvariable sliceNo=dimsize(Dif2dwave,1)variable epoints=dimsize(Dif2dwave,0)variable j,ivariable No_poly=3string  fit, fit_def, fit_defdeffit="fit_temp0"fit_def="fit_temp0_DIF"fit_defdef="fit_temp0_DIFDIF"make/o/n=(epoints) temp0 duplicate/o temp0  temp1duplicate/o Dif2dwave temp3variable /g v_fitoptions=4for (j=0; j<sliceNo; j+=1)  print j,"/",sliceNo  temp0=Dif2dwave[p][j] for (i=0; i<epoints; i+=1)  if (i<= dE_points)   CurveFit/q poly No_poly, temp0[0,i+dE_points] /D   elseif (i <= (epoints - dE_points))   CurveFit/q poly No_poly, temp0[i-dE_points,i+dE_points]/D   else     CurveFit/q poly No_poly, temp0[i-dE_points,epoints-1]/D   endif  	   Differentiate $fit/D=$fit_def   Differentiate $fit_def/D=$fit_defdef   duplicate/o $fit_defdef temp2  if (i<= dE_points)   temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dE_points)]  else    temp1[i]=-temp2[dimsize(temp2,0)/2]  endif endfor temp3[][j]=temp1[p] duplicate/o temp3 Dif2dwaveendforv_fitoptions=0endfunction D2nd_difCalm2MDC()wave Dif2dwavenvar dK_points=D2nd_MDCfitpointsvariable sliceNo=dimsize(Dif2dwave,1)variable epoints=dimsize(Dif2dwave,0)variable j,ivariable No_poly=3string  fit, fit_def, fit_defdefdK_points=dK_points/2fit="fit_temp0"fit_def="fit_temp0_DIF"fit_defdef="fit_temp0_DIFDIF"make/o/n=(sliceNo) temp0 duplicate/o temp0  temp1duplicate/o Dif2dwave temp3variable /g v_fitoptions=4for (j=0; j<epoints; j+=1)  print j,"/",epoints  temp0=Dif2dwave[j][p] for (i=0; i<sliceNo; i+=1)  if (i<= dK_points)   CurveFit/q poly No_poly, temp0[0,i+dK_points]/D   elseif (i <= (sliceNo - dK_points))   CurveFit/q poly No_poly, temp0[i-dK_points,i+dK_points]/D   else     CurveFit/q poly No_poly, temp0[i-dK_points,sliceNo-1]/D   endif   Differentiate $fit/D=$fit_def   Differentiate $fit_def/D=$fit_defdef   duplicate/o $fit_defdef temp2  if (i<= dK_points)   temp1[i]=-temp2[dimsize(temp2,0)*i/(i+dK_points)]  else    temp1[i]=-temp2[dimsize(temp2,0)/2]  endif endfor temp3[j][]=temp1[p] duplicate/o temp3 Dif2dwaveendforv_fitoptions=0endfunction D2nd_showdif2D(ctrlName) : ButtonControl	String ctrlName	wave Dif2dwave	nvar D2nd_graph	dowindow/f DIFpanel	if (V_flag!=1)    display/N=DIFpanel/W=(358,147,670,459) as "DIFpanel"    appendimage Dif2dwave    PauseUpdate; Silent 1		// building window...     ImageStats/M=1 Dif2dwave      ModifyImage Dif2dwave ctab= {0,*,PlanetEarth,1}	 ModifyGraph tick=2	 ModifyGraph mirror=1	 ModifyGraph minor=1	 ModifyGraph fSize=16	 ModifyGraph standoff=0	 ModifyGraph axOffset(left)=-0.3125,axOffset(bottom)=-2.125	 	 Label left "Slice"	 Label bottom "Eenrgy (eV)"	 ModifyGraph swapXY=1  	endif  	endFunction D2nd_showextdif(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	duplicate/o $popStr Dif2dwave	D2nd_showdif2D("") 	TextBox/C/N=imagename/F=0/A=MC/X=-38.00/Y=45.00 "\\f01"+popStrEndFunction D2nd_paraChange(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar D2nd_mode	if(D2nd_mode==1)	D2nd_difCal2D()	endifEndFunction D2nd_MapGraph (ctrlName) : ButtonControl	String ctrlName	Svar Difname	nvar D2nd_EDCsm1,D2nd_MDCsm1,D2nd_mode, D2nd_dim		string textstring=StringByKey("Text", AnnotationInfo("DIFpanel", "imagename"))	string ImName=textstring[5, strlen(textstring)-1]	//string textname=filename+"sm_"+num2str()	string ImNameN=ImName+"_graph"	string panelName=ImName+"_graphW"		duplicate/o  $ImName $ImNameN	Dowindow/f $panelName	if (V_flag!=1)	 Display /W=(5,42,377,293)	 dowindow /c $panelName	AppendImage $ImNameN	ModifyGraph swapXY=1	 ImageStats/M=1 $ImNameN   ModifyImage $ImNameN ctab= {0,*,PlanetEarth,1}	textbox/k/n=text0	Textbox/N=ImName /x=-32/y=40/F=0/A=MC " \\Z16"+ ImName	ModifyGraph tick=2,mirror=1,minor=1,fSize=16,standoff=0;DelayUpdate  Label bottom "Slice";DelayUpdate  Label left "Energy (eV)"  endifEndFunction D2nd_showtable(ctrlName) : ButtonControl	String ctrlName     dowindow/f Deriva2dTable    if (V_flag!=1)      edit       appendtotable Deriva2dwave      dowindow/c Deriva2dTable     endif Endproc SetTraceColor(ctrlName) : ButtonControl	String ctrlNamedowindow/f setTraceColorif(V_flag!=1)make/o/n=3 STRGBwave_i,STRGBwave_fstring/g SC_traceliststrstring/g SC_modelist="RGBlinear;"+"RGBquadratic;"+"HLSlinear;"+"HLSquadratic"string/g SC_modstr="RGBlinear"string/g SC_startColor="(0,0,0)"string/g SC_endColor="(0,0,0)"string/g SC_axisvariable/g SC_Hcontr=0.5variable/g SC_Lcontr=0.5variable/g SC_Scontr=0.5variable/g SC_reversevariable/g SC_offsetvariable/g SC_offsetdelta=1make/o/T/n=0 SC_tracelistwavemake/o/T/n=0 SC_tracelistwaveSmake/o/T/n=0 SC_colorwave, SC_colorwaveSmake/o/n=0 SC_traceselwavesetTraceColorpanel()endifendWindow setTraceColorpanel() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/k=1 /W=(510,546,988,888) as "setTraceColorW"	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 259,151,457,151	SetDrawEnv fillfgc= (61696,64000,57856),fillbgc= (32768,54528,65280)	DrawRect 251,96,468,227	DrawLine 258,153,460,153	SetDrawEnv fillfgc= (61696,64000,57856),fillbgc= (32768,54528,65280)	DrawRect 251,236,468,329	PopupMenu popup0,pos={260,123},size={200,21},proc=SC_fromColorTable	PopupMenu popup0,mode=11,value= #"\"*COLORTABLEPOPNONAMES*\""	PopupMenu popup1,pos={261,173},size={78,21},proc=SC_manualStart,title="Start"	PopupMenu popup1,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu popup2,pos={371,172},size={75,21},proc=SC_manualEnd,title="End"	PopupMenu popup2,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	ListBox tracellistbox,pos={6,37},size={231,273},proc=SC_updatesellist	ListBox tracellistbox,listWave=root:SC_tracelistwave	ListBox tracellistbox,selWave=root:SC_traceselwave,mode= 9	Button moveup,pos={185,5},size={24,28},proc=SC_traceup,title="\\W617"	Button moveup1,pos={210,5},size={23,29},proc=SC_tracedown,title="\\W623"	Button button0,pos={15,4},size={84,26},proc=SC_updateList,title="Get Traces"	Button button0,fSize=14,fStyle=1	TitleBox title0,pos={259,102},size={64,15},title="Color Table",frame=0	TitleBox title1,pos={263,157},size={40,15},title="Manual",frame=0	TitleBox title2,pos={251,76},size={60,15},title="Alll Traces",frame=0,fStyle=1	TitleBox title3,pos={250,12},size={93,15},title="Selected Traces",frame=0	TitleBox title3,fStyle=1	PopupMenu popup3,pos={353,9},size={50,21},proc=SC_seltrace	PopupMenu popup3,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu popup4,pos={261,201},size={110,21},proc=SC_colormode,title="Mode"	PopupMenu popup4,mode=1,popvalue="RGBlinear",value= #"SC_modelist"	Slider Hue,pos={294,245},size={170,19},proc=SC_changeHLS,fSize=10	Slider Hue,limits={0,1,0.005},variable= SC_Hcontr,vert= 0,ticks= 0	Slider Lum,pos={295,273},size={170,19},proc=SC_changeHLS,fSize=10	Slider Lum,limits={0,1,0.005},variable= SC_Lcontr,vert= 0,ticks= 0	Slider Sat,pos={295,303},size={170,19},proc=SC_changeHLS,fSize=10	Slider Sat,limits={0,1,0.005},variable= SC_Scontr,vert= 0,ticks= 0	TitleBox title4,pos={258,246},size={25,15},title="Hue:",frame=0,fStyle=1	TitleBox title5,pos={257,273},size={28,15},title="Lum:",frame=0,fStyle=1	TitleBox title6,pos={257,303},size={22,15},title="Sat:",frame=0,fStyle=1	CheckBox check1,pos={397,102},size={59,15},proc=SC_reversecheck,title="reverse"	CheckBox check1,variable= SC_reverse	Button button1,pos={94,315},size={35,23},proc=SC_selAlltraces,title="All"	Button button1,fSize=14,fStyle=1	SetVariable offset,pos={255,49},size={55,18},proc=SC_offsetchange,title=" "	SetVariable offset,value= SC_offset	PopupMenu offunit,pos={368,48},size={60,21},proc=SC_offsetunit,title="Unit"	PopupMenu offunit,mode=4,popvalue="1",value= #"\"0.001;0.01;0.1;1;10;100;1000;10000;100000\""	PopupMenu popup5,pos={316,47},size={40,21},proc=SC_selAxis,title=" "	PopupMenu popup5,mode=1,popvalue="y",value= #"\"x;y\""	TitleBox title7,pos={255,31},size={30,15},title="offset",frame=0,fStyle=0EndMacrofunction SC_updateList(ctrlName) : ButtonControl	String ctrlName	wave/T listwave=SC_tracelistwave	wave selwave=SC_traceselwave	string tracelist=TraceNameList("",";",1)	variable jj,jjmax	jjmax=ItemsInList(tracelist)	redimension/n=(jjmax) listwave	redimension/n=(jjmax)  selwave	jj=0		if(jjmax>0)	string temptrace, tempcolorstr	do		temptrace=StringFromList(jj,  tracelist)		listwave[jj]=temptrace		jj+=1	while(jj<jjmax)		endif	nvar SC_Hcontr, SC_Lcontr, SC_Scontr	 	SC_Hcontr=0.5 	SC_Lcontr=0.5 	SC_Scontr=0.5 end  Function SC_updatesellist(ctrlName,row,col,event) : ListBoxControl	String ctrlName	Variable row	Variable col	Variable event	//1=mouse down, 2=up, 3=dbl click, 4=cell select with mouse or keys					//5=cell select with shift key, 6=begin edit, 7=end	SC_updatesellistcal()	return 0EndFunction SC_selAlltraces(ctrlName)  : ButtonControl	String ctrlName	wave selwave=SC_traceselwave	selwave=1		SC_updatesellistcal()Endfunction SC_updatesellistcal()	wave selwave=SC_traceselwave	variable selnum=0	wave/T listwaveS=SC_tracelistwaveS	wave/T listwave=SC_tracelistwave	wave/T colorwaveS=SC_colorwaveS	variable ii,iimax	ii=0	iimax=dimsize(selwave,0)	redimension/n=(iimax) listwaveS	redimension/n=(iimax) colorwaveS	do		if(selwave(ii)>0)			listwaveS[selnum]=listwave[ii]			selnum+=1		endif	ii+=1	while(ii<iimax)	redimension/n=(selnum) listwaveS	redimension/n=(selnum) colorwaveS	duplicate/o colorwaveS SC_colorwaveHLSendFunction SC_traceup(ctrlName) : ButtonControl	String ctrlName    controlinfo/W=MDCWidthShow MDCWidthlistbox  wave/T tmp=SC_tracelistwave  wave selwave=SC_traceselwave   string tmpstr  variable ii,iimax   iimax=dimsize(selwave,0)  	 ii=1     do     if(selwave[ii])     tmpstr=tmp[ii-1]     tmp[ii-1]=tmp[ii]     tmp[ii]=tmpstr     selwave[ii]=0     selwave[ii-1]=1     endif     ii+=1     while(ii<iimax)   EndFunction SC_tracedown(ctrlName) : ButtonControl	String ctrlName    controlinfo/W=MDCWidthShow MDCWidthlistbox  wave/T tmp=SC_tracelistwave  wave selwave=SC_traceselwave   string tmpstr  variable ii,iimax   iimax=dimsize(selwave,0)  	 ii=iimax-1     do     if(selwave[ii])     tmpstr=tmp[ii+1]     tmp[ii+1]=tmp[ii]     tmp[ii]=tmpstr     selwave[ii]=0     selwave[ii+1]=1     endif     ii-=1     while(ii>=0) EndFunction SC_seltrace(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string colorstr	wave/T  SC_colorwaveS	wave/T listwaveS=SC_tracelistwaveS	variable jj,jjmax	jjmax=dimsize(listwaveS,0)	jj=0		if(jjmax>0)	string temptrace	do		SC_colorwaveS[jj]=popStr		jj+=1	while(jj<jjmax)		endif		SC_changecolor()	nvar SC_Hcontr, SC_Lcontr, SC_Scontr	 	SC_Hcontr=0.5 	SC_Lcontr=0.5	SC_Scontr=0.5EndFunction SC_manualStart(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar  SC_StartColor	SC_StartColor=popStr	SC_calcolor()	SC_changecolor()	nvar SC_Hcontr, SC_Lcontr, SC_Scontr	 	SC_Hcontr=0.5 	SC_Lcontr=0.5 	SC_Scontr=0.5EndFunction  SC_manualEnd(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar  SC_endColor	SC_endColor=popStr	SC_calcolor()	SC_changecolor()	nvar SC_Hcontr, SC_Lcontr, SC_Scontr	 	SC_Hcontr=0.5 	SC_Lcontr=0.5 	SC_Scontr=0.5EndFunction SC_colormode(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar mode=SC_modstr	mode=popStr	SC_calcolor()	SC_changecolor()	nvar SC_Hcontr, SC_Lcontr, SC_Scontr		SC_Hcontr=0.5 	SC_Lcontr=0.5 	SC_Scontr=0.5EndFunction SC_calcolor()	wave STRGBwave_i	wave STRGBwave_f	wave/T listwaveS=SC_tracelistwaveS	wave/T  SC_colorwaveS	svar mode=SC_modstr	svar SC_endColor	svar SC_StartColor	nvar SC_reverse	duplicate/o STRGBwave_i STHLSwave_i	duplicate/o STRGBwave_f STHLSwave_f	duplicate/o STRGBwave_f tempRGBwave,tempHLSwave	string colorstr	 colorstr=SC_StartColor	colorstr=colorstr[1,strlen(colorstr)-2]	STRGBwave_i[0]=str2num(StringFromList(0, colorstr, ","))	STRGBwave_i[1]=str2num(StringFromList(1, colorstr, ","))	STRGBwave_i[2]=str2num(StringFromList(2, colorstr, ","))	colorstr=SC_endColor	colorstr=colorstr[1,strlen(colorstr)-2]	STRGBwave_f[0]=str2num(StringFromList(0, colorstr, ","))	STRGBwave_f[1]=str2num(StringFromList(1, colorstr, ","))	STRGBwave_f[2]=str2num(StringFromList(2, colorstr, ","))		STHLSwave_i=RGB2HLS(STRGBwave_i) 	STHLSwave_f=RGB2HLS(STRGBwave_f)		variable jj,jjmax,r,g,b	jjmax=dimsize(listwaveS,0)	jj=0		if(jjmax>0)	string temptrace	do		temptrace=listwaveS[jj]		if(stringmatch(mode,"RGBlinear"))		tempRGBwave=STRGBwave_i+(STRGBwave_f-STRGBwave_i)*jj/jjmax		endif		if(stringmatch(mode,"HLSlinear"))		tempHLSwave=STHLSwave_i+(STHLSwave_f-STHLSwave_i)*jj/jjmax		tempRGBwave=HLS2RGB(tempHLSwave) 		endif		if(stringmatch(mode,"RGBquadratic"))		tempRGBwave=STRGBwave_i+(STRGBwave_f-STRGBwave_i)*jj*jj/jjmax/jjmax		endif		if(stringmatch(mode,"HLSquadratic"))		tempHLSwave=STHLSwave_i+(STHLSwave_f-STHLSwave_i)*jj*jj/jjmax/jjmax		tempRGBwave=HLS2RGB(tempHLSwave) 		endif		r=tempRGBwave[0]		g=tempRGBwave[1]		b=tempRGBwave[2]		SC_colorwaveS[jj]="("+num2str(r)+","+num2str(g)+","+num2str(b)+")"		jj+=1	while(jj<jjmax)		endif	if(SC_reverse==1)	 SC_reversefunc()	 endif	 duplicate/o SC_colorwaveS SC_colorwaveHLSEndFunction SC_changecolor()	wave/T listwaveS=SC_tracelistwaveS	wave/T  SC_colorwaveS		variable jj,jjmax,r,g,b	string colorstr,temptrace	jjmax=dimsize(listwaveS,0)	jj=0		if(jjmax>0)	do		temptrace=listwaveS[jj]		colorstr=SC_colorwaveS[jj]		colorstr=colorstr[1,strlen(colorstr)-2]		r=str2num(StringFromList(0, colorstr, ","))		g=str2num(StringFromList(1, colorstr, ","))		b=str2num(StringFromList(2, colorstr, ","))		modifygraph rgb($temptrace)=(r,g,b)		jj+=1	while(jj<jjmax)		endifendFunction SC_fromColorTable(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr				wave/T listwaveS=SC_tracelistwaveS	wave/T colorwaveS=SC_colorwaveS	nvar SC_reverse	ColorTab2Wave $popStr	wave M_colors	variable cpnt=dimsize(M_colors,0)	variable jj,jjmax,ii	jjmax=dimsize(listwaveS,0)	jj=0		if(jjmax>0)	do		 colorwaveS[jj]="("+num2str(M_colors[jj*cpnt/jjmax][0])+","+num2str(M_colors[jj*cpnt/jjmax][1])+","+num2str(M_colors[jj*cpnt/jjmax][2])+")"		jj+=1	while(jj<jjmax)		endif	 if(SC_reverse==1)	 SC_reversefunc()	 endif	SC_changecolor()	duplicate/o colorwaveS SC_colorwaveHLS	nvar SC_Hcontr, SC_Lcontr, SC_Scontr	 	SC_Hcontr=0.5 	SC_Lcontr=0.5 	SC_Scontr=0.5Endfunction RGB2HLS(RGB) 	wave RGB	duplicate/o RGB HLSwave	variable r,g,b,h,l,s 	r=RGB[0]/255/256	g=RGB[1]/255/256	b=RGB[2]/255/256 	variable  m=max(max(r,g),b)  	variable n=min(min(r,g),b)	l=(m+n)/2	if(m==n)    		s=0		h=0   	else     		if(l<=0.5)      		s=(m-n)/(m+n)    		else      		s=(m-n)/(2-m-n)    		endif    	    		if(r==m)    			h=(g-b)/(m-n)    		elseif(g==m)    			h=2+(b-r)/(m-n)    		elseif(b==m)    			h=4+(r-g)/(m-n)    		endif    	    		h=h*60    	    		if(h<0)    			h=h+360    		endif       	endif    	HLSwave[0]=h    	HLSwave[1]=l    	HLSwave[2]=s    	return HLSwaveendfunction HLS2RGB(HLS) 	wave HLS	duplicate/o HLS RGBwave	variable r,g,b,h,l,s 	h=HLS[0]	l=HLS[1]	s=HLS[2] 	variable cmax,cmin;   	 if(l <= 0.5)        	cmax = l*(1+s);   	 else        	cmax = l*(1-s)+s;        endif    	cmin = 2*l-cmax;   	 if(s == 0)        r =l*255;         g= l*255;         b = l*255;    	else        r = HLS2RGBvalue(cmin,cmax,h+120)*255;        g = HLS2RGBvalue(cmin,cmax,h)*255;        b = HLS2RGBvalue(cmin,cmax,h-120)*255;     endif     RGBwave[0]=r*256    RGBwave[1]=g*256     RGBwave[2]=b*256     return RGBwaveendfunction HLS2RGBvalue(n1,n2,hue)	variable n1,n2,hue    	if(hue > 360)        	hue -= 360;    	endif    	if(hue < 0)        hue += 360;        endif                   	 if(hue < 60)        return n1+(n2-n1)*hue/60;    	 elseif(hue < 180)        return n2;    	 elseif(hue < 240)        return n1+(n2-n1)*(240-hue)/60;    	else        return n1;        endifendFunction SC_changeHLS(ctrlName,sliderValue,event) : SliderControl	String ctrlName	Variable sliderValue	Variable event	// bit field: bit 0: value set, 1: mouse down, 2: mouse up, 3: mouse moved//	wave STRGBwave_i	wave/T  SC_colorwaveS	wave/T  SC_colorwaveHLS	duplicate/o STRGBwave_f tempRGBwave,tempHLSwave	string colorstr,temptrace	variable jj,jjmax	nvar SC_Hcontr,SC_Lcontr,SC_Scontr	jjmax=dimsize(SC_colorwaveS,0)	jj=0		if(jjmax>0)	do		colorstr=SC_colorwaveHLS[jj]		colorstr=colorstr[1,strlen(colorstr)-2]		tempRGBwave[0]=str2num(StringFromList(0, colorstr, ","))		tempRGBwave[1]=str2num(StringFromList(1, colorstr, ","))		tempRGBwave[2]=str2num(StringFromList(2, colorstr, ","))		tempHLSwave=RGB2HLS(tempRGBwave)		tempHLSwave[0]=tempHLSwave[0]+(SC_Hcontr-0.5)*360			if(tempHLSwave[0]>360)			tempHLSwave[0]=tempHLSwave[0]-360			endif			if(tempHLSwave[0]<0)			tempHLSwave[0]=tempHLSwave[0]+360			endif		tempHLSwave[1]=tempHLSwave[1]+(SC_Lcontr-0.5)		tempHLSwave[1]=tempHLSwave[1]<1?tempHLSwave[1]:1		tempHLSwave[1]=tempHLSwave[1]>0?tempHLSwave[1]:0		tempHLSwave[2]=tempHLSwave[2]+(SC_Scontr-0.5)		tempHLSwave[2]=tempHLSwave[2]<1?tempHLSwave[2]:1		tempHLSwave[2]=tempHLSwave[2]>0?tempHLSwave[2]:0		tempRGBwave=HLS2RGB(tempHLSwave)		SC_colorwaveS[jj]="("+num2str(tempRGBwave[0])+","+num2str(tempRGBwave[1])+","+num2str(tempRGBwave[2])+")"		jj+=1	while(jj<jjmax)		endif	SC_changecolor()EndFunction SC_reversecheck(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	SC_reversefunc()	SC_changecolor()Endfunction SC_reversefunc()	wave/t SC_colorwaveS	wave/t SC_colorwave	wave/t SC_colorwaveHLS	variable num=dimsize(SC_colorwaveS,0)	duplicate/o/t SC_colorwaveS, SC_colortemp	SC_colorwaveS=SC_colortemp[num-1-p]	duplicate/o/t SC_colorwaveHLS, SC_colortemp	SC_colorwaveHLS=SC_colortemp[num-1-p]endFunction SC_selAxis(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar SC_axis	SC_axis=popStrEndFunction SC_offsetchange(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	SC_offsettrace()EndFunction SC_offsetunit(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	SetVariable offset,limits={-inf,inf,str2num(popStr)}Endfunction SC_offsettrace()nvar offset=SC_offsetsvar axis=SC_axiswave/T listwaveS=SC_tracelistwaveSvariable jj,jjmaxstring temptracejjmax=dimsize(listwaveS,0)jj=0		if(jjmax>0)	if(stringmatch(axis,"x"))			do		temptrace=listwaveS[jj]		ModifyGraph offset($temptrace)={offset*jj, }		jj+=1		while(jj<jjmax)	else		do		temptrace=listwaveS[jj]		ModifyGraph offset($temptrace)={, offset*jj}		jj+=1		while(jj<jjmax)		endif	endifend//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////T dependent MDC fitproc MDCAlanize(ctrlName) : ButtonControl	String ctrlName	dowindow/f MDCFitResults	if(V_flag!=1)		string/g MDCsetname		variable/g MDCTnumIm		variable/g MDCEnumIm		variable/g MDCcheckvsTIm		variable/g MDCTnumRe		variable/g MDCEnumRe		variable/g MDCcheckvsTRe		MDCFitResults()	endifEndWindow MDCFitResults() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(667,434,1155,717) as "MDCFitResults"	ModifyPanel cbRGB=(60416,47360,59392)	SetDrawLayer UserBack	DrawLine 11,149,234,149	DrawLine 8,211,234,211	SetDrawEnv fsize= 14,fstyle= 1	DrawText 11,145,"E dependent"	SetDrawEnv fsize= 14,fstyle= 1	DrawText 10,206,"G dependent"	SetDrawEnv linethick= 2	DrawLine 13,45,477,45	SetDrawEnv linethick= 2	DrawLine 241,49,241,277	SetDrawEnv fname= "Times New Roman",fsize= 20,fstyle= 1,textrgb= (0,15872,65280)	DrawText 16,72,"ImSE"	SetDrawEnv fname= "Times New Roman",fsize= 20,fstyle= 1,textrgb= (52224,0,20736)	DrawText 256,71,"ReSE"	DrawLine 249,148,472,148	DrawLine 246,210,472,210	SetDrawEnv fsize= 14,fstyle= 1	DrawText 249,144,"E dependent"	SetDrawEnv fsize= 14,fstyle= 1	DrawText 248,205,"G dependent"	SetVariable setvar0,pos={95,160},size={92,18},proc=MDCWidth_setTpointsIm,title="T Points"	SetVariable setvar0,value= MDCTnumIm	Button Get3D,pos={80,48},size={55,26},proc=MDCWidth_makeimageIm,title="Go"	Button Get3D,fSize=15,fStyle=1	PopupMenu BZpopup,pos={100,11},size={110,21},proc=MDCWidth_pop	PopupMenu BZpopup,mode=2,popvalue="MDCTable_node",value= #"WaveList(\"MDCTable_*\",\";\",\"\")"	Button button5,pos={19,12},size={32,20},proc=MDCWidth_newset	SetVariable setvar1,pos={78,223},size={92,18},proc=MDCWidth_setEpointsIm,title="E Points"	SetVariable setvar1,value= MDCEnumIm	Button Update,pos={355,11},size={88,22},proc=MDCWidth_updatePM,title="Update Table"	Button Update,fSize=12,fStyle=0	Button showImg,pos={152,102},size={74,24},proc=MDCWidth_showImSE,title="ShowImg"	Button showImg,fSize=15,fStyle=1	Button showImg1,pos={11,154},size={58,26},proc=MDCWidth_showEdepIm,title="Show"	Button showImg1,fSize=15,fStyle=1	Button showImg2,pos={11,218},size={58,26},proc=MDCWidth_showGdepIm,title="Show"	Button showImg2,fSize=15,fStyle=1	Button Get3D1,pos={82,250},size={83,31},proc=MDCWidthShow_new,title="Multi Cuts"	Button Get3D1,fSize=15,fStyle=1	CheckBox Sym5,pos={175,224},size={61,15},proc=MDCWidth_CKvsTIm,title="vs temp"	CheckBox Sym5,variable= MDCcheckvsTIm	PopupMenu BZpopup1,pos={11,76},size={120,21},proc=MDCWidth_selImSE	PopupMenu BZpopup1,mode=2,popvalue="MDCImSE_L_node",value= #"WaveList(\"MDCImSe_*\",\";\",\"\")"	PopupMenu BZpopup2,pos={248,76},size={123,21},proc=MDCWidth_selReSE	PopupMenu BZpopup2,mode=2,popvalue="MDCReSE_L_node",value= #"WaveList(\"MDCReSE_*\",\";\",\"\")"	SetVariable setvar2,pos={333,159},size={92,18},proc=MDCWidth_setTpointsRe,title="T Points"	SetVariable setvar2,value= MDCTnumRe	SetVariable setvar3,pos={316,222},size={92,18},proc=MDCWidth_setEpointsRe,title="E Points"	SetVariable setvar3,value= MDCEnumRe	Button showImg3,pos={399,100},size={74,24},proc=MDCWidth_showReSE,title="ShowImg"	Button showImg3,fSize=15,fStyle=1	Button showImg4,pos={249,153},size={58,26},proc=MDCWidth_showEdepRe,title="Show"	Button showImg4,fSize=15,fStyle=1	Button showImg5,pos={249,217},size={58,26},proc=MDCWidth_showGdepRe,title="Show"	Button showImg5,fSize=15,fStyle=1	CheckBox Sym6,pos={413,223},size={61,15},proc=MDCWidth_CKvsTRe,title="vs temp"	CheckBox Sym6,variable= MDCcheckvsTRe	Button Get3D2,pos={317,47},size={55,26},proc=MDCWidth_makeimageRe,title="Go"	Button Get3D2,fSize=15,fStyle=1EndMacroFunction MDCWidth_newset (ctrlName) : ButtonControl	String ctrlName	Nvar Goffset	string Addname="", offsetstr, YesNo	variable LastGraphNo=1, FirstGraphNo=1, offset	svar  MDCsetname	string MDCFWHMTable	string FitMethod//	variable MDCMethod	if (Goffset==0)   		offsetstr = "G0000"  	else   		offsetstr = "G"+num2str(Goffset)  	endif	Prompt Addname,"MDCTable_ + ? : MDCFWHM Table Name"	Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")	Prompt FirstGraphNo,"From No."	Prompt LastGraphNo,"To No."	Prompt FitMethod, "Fitting Method ", popup, "1. One Peak;2. Two Peaks and Single Width;3. Two Peaks and Double Width "   DoPrompt "MDCFWHM Table setting",  Addname, offsetstr, FirstGraphNo, LastGraphNo , FitMethod//   	MDCMethod=str2num(FitMethod)	if (V_flag != 0) 	 return -1; // User cancelled.  	endif  	 	MDCFWHMTable= "MDCTable_" + Addname 	if (exists(MDCFWHMTable)==1) 	  Prompt YesNo, "Yes or No", popup, "Yes"+";No" 	  DoPrompt "There is this 'MDCSet' name. Do you want to replace?",  YesNo 	endif 	if (exists(MDCFWHMTable)==0 || stringmatch(YesNo,"yes")==1) 	MDCsetname=Addname       Make/o/N=((abs(LastGraphNo-FirstGraphNo)+1),6)/D $MDCFWHMTable	duplicate/o $MDCFWHMTable temp	temp=0	sscanf offsetstr, "G%f", offset	temp[][0]=p+offset+FirstGraphNo	//graph number	temp[][5]=str2num(FitMethod)		// Fitting Method	duplicate/o  temp $MDCFWHMTable		MDCWidth_getPM ()	MDCWidth_showtable()		endifEndFunction MDCWidth_getPM ()	svar MDCsetname 	string MDCFWHMTable= "MDCTable_" + MDCsetname 	wave map 	duplicate/o $MDCFWHMTable temp 	variable ii=0 	variable iimax=dimsize(temp,0) 	string enMDCname 	do		temp[ii][1]=map[temp[ii][0]][2] //temperature		if(temp[0][5]==1)			enMDCname="enMDCone"+num2str(temp[ii][0])			elseif(temp[0][5]==2)			enMDCname="enMDCtwoS"+num2str(temp[ii][0])		elseif(temp[0][5]==3)			enMDCname="enMDCtwoD"+num2str(temp[ii][0])				endif						if(exists(enMDCname)==1)				duplicate/o  $enMDCname  temp1D			temp[ii][2]=temp1D[0] //Ei			temp[ii][3]=temp1D[dimsize(temp1D,0)-1] //Ef				temp[ii][4]=dimsize(temp1D,0) //E points		else			temp[ii][2]=0 //Ei			temp[ii][3]=0 //Ef			temp[ii][4]=0 //E points		endif		ii+=1	while(ii<iimax)	duplicate/o 	temp $MDCFWHMTableendFunction MDCWidth_showtable()	svar MDCsetname 	string MDCFWHMTable= "MDCTable_" + MDCsetname 	duplicate/o $MDCFWHMTable MDCTable	string windowname="MDCTableW"	dowindow/f $windowname	if (v_flag!=1)	edit/W=(50,50,400,500) MDCTable	dowindow/c $windowname	endifendFunction MDCWidth_pop(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar MDCsetname	MDCsetname=popStr[9, strlen(popStr)-1]	MDCWidth_showtable()Endfunction MDCWidth_makeimageIm(ctrlName): ButtonControl	String ctrlName	svar MDCsetname 	string MDCFWHMTable= "MDCTable_" + MDCsetname 	 	if (exists(MDCFWHMTable)!=1) 	  return -1; 	endif 	duplicate/o $MDCFWHMTable temp 	 	make/o/n=(dimsize(temp,0)) temp1D  	string MDCFWHMT="MDCT_" + MDCsetname 	 	temp1D=temp[p][1] 	duplicate/o temp1D $MDCFWHMT  	 	string MDCFWHMG="MDCG_" + MDCsetname 	 	 	temp1D=temp[p][0] 	duplicate/o temp1D $MDCFWHMG 	 	variable maxpoints= temp[0][4] 	variable maxnum=0 	variable ii=0 	variable iimax=dimsize(temp,0) 	do 	if(maxpoints< temp[ii][4]) 	maxpoints=temp[ii][4] 	maxnum=ii 	endif 	ii+=1 	while(ii<iimax) 	 	string MDCFWHME="MDCE_" + MDCsetname 	string enMDCname 	if(temp[0][5]==1)			enMDCname="enMDCone"+num2str(temp[ii][0])			elseif(temp[0][5]==2)			enMDCname="enMDCtwoS"+num2str(temp[ii][0])		elseif(temp[0][5]==3)			enMDCname="enMDCtwoD"+num2str(temp[ii][0])				endif	duplicate/o $enMDCname $MDCFWHME	 	 	make/o/n=(dimsize(temp,0), maxpoints) temp1,temp2,temp3,temp4 	temp1=0 	string wMDC1, wMDC2 	string MDCfitImSE,MDCfitImSEl,MDCfitImSEr 	ii=0 	 	if(temp[0][5]==1) 		do 		wMDC1="wMDCone" + num2str(temp[ii][0])	 		if(exists(wMDC1)==0) 			abort "Calculate MDC Width First!" 		endif 		duplicate/o $wMDC1 temp1D 		temp1[ii][]=temp1D[q] 		ii+=1 		while(ii<iimax) 		MDCfitImSE= "MDCImSE_L_" + MDCsetname 		duplicate/o temp1 $MDCfitImSE 	endif 	 	if(temp[0][5]==2) 		do 		wMDC1="wMDCtwoS" + num2str(temp[ii][0])		if(exists(wMDC1)==0) 			abort "Calculate MDC Width First!" 		endif 		duplicate/o $wMDC1 temp1D 		temp1[ii][]=temp1D[q] 		ii+=1 		while(ii<iimax) 		MDCfitImSE= "MDCImSE_L_" + MDCsetname 		duplicate/o temp1 $MDCfitImSE 	endif 	 	if(temp[0][5]==3) 	 	do 		wMDC1="wMDCtwoD" + num2str(temp[ii][0])+"_l" 		wMDC2="wMDCtwoD"  + num2str(temp[ii][0])+"_r" 		if(exists(wMDC1)==0) 			abort "Calculate MDC Width First!" 		endif 		duplicate/o $wMDC1 temp1D 		temp1[ii][]=temp1D[q] 		if(exists(wMDC2)==0) 			abort "Calculate MDC Width First!" 		endif 		duplicate/o $wMDC2 temp1D 		temp2[ii][]=temp1D[q] 		 		ii+=1 		while(ii<iimax) 		MDCfitImSEl= "MDCImSE_L_" + MDCsetname 		MDCfitImSEr= "MDCImSE_R_" + MDCsetname 		duplicate/o temp1 $MDCfitImSEl 		duplicate/o temp2 $MDCfitImSEr 	endifendfunction MDCWidth_makeimageRe(ctrlName): ButtonControl	String ctrlName	svar MDCsetname 	string MDCFWHMTable= "MDCTable_" + MDCsetname 	 	if (exists(MDCFWHMTable)!=1) 	  return -1; 	endif 	duplicate/o $MDCFWHMTable temp 	 	make/o/n=(dimsize(temp,0)) temp1D  	string MDCFWHMT="MDCT_" + MDCsetname 	 	temp1D=temp[p][1] 	duplicate/o temp1D $MDCFWHMT  	 	string MDCFWHMG="MDCG_" + MDCsetname 	 	 	temp1D=temp[p][0] 	duplicate/o temp1D $MDCFWHMG 	 	variable maxpoints= temp[0][4] 	variable maxnum=0 	variable ii=0 	variable iimax=dimsize(temp,0) 	do 	if(maxpoints< temp[ii][4]) 	maxpoints=temp[ii][4] 	maxnum=ii 	endif 	ii+=1 	while(ii<iimax) 	 	string MDCFWHME="MDCE_" + MDCsetname 	string enMDCname 	if(temp[0][5]==1)			enMDCname="enMDCone"+num2str(temp[ii][0])			elseif(temp[0][5]==2)			enMDCname="enMDCtwoS"+num2str(temp[ii][0])		elseif(temp[0][5]==3)			enMDCname="enMDCtwoD"+num2str(temp[ii][0])				endif	duplicate/o $enMDCname $MDCFWHME	 	 	make/o/n=(dimsize(temp,0), maxpoints) temp1,temp2,temp3,temp4 	temp1=0 	string rMDC1,rMDC2 	string MDCfitReSE,MDCfitReSEl,MDCfitReSEr 	ii=0 	 	if(temp[0][5]==1) 		do		rMDC1="rMDCone" + num2str(temp[ii][0]) 		 		if(exists(rMDC1)==0) 			abort "Calculate Real Part Selfenergy First!" 		endif 		duplicate/o $rMDC1 temp1D 		temp1[ii][]=temp1D[q] 		ii+=1 		while(ii<iimax) 		MDCfitReSE= "MDCReSE_L_" + MDCsetname 		duplicate/o temp1 $MDCfitReSE 	endif 	 	if(temp[0][5]==2) 		do		rMDC1="rMDCtwoS" +num2str(temp[ii][0])+"_l" 		rMDC2="rMDCtwoS" +num2str(temp[ii][0])+"_r" 		if(exists(rMDC1)==0) 			abort "Calculate Real Part Selfenergy of Left Dispersion First!" 		endif 		duplicate/o $rMDC1 temp1D 		temp1[ii][]=temp1D[q] 		if(exists(rMDC2)==0) 			abort "Calculate Real Part Selfenergy of Right Dispersion First!" 		endif 		duplicate/o $rMDC2 temp1D 		temp2[ii][]=temp1D[q] 		ii+=1 		while(ii<iimax) 		MDCfitReSEl= "MDCReSE_L_" + MDCsetname 		 MDCfitReSEr= "MDCReSE_R_" + MDCsetname 		duplicate/o temp1 $MDCfitReSEl 		duplicate/o temp2 $MDCfitReSEr 	endif 	 	if(temp[0][5]==3) 	 	do 		rMDC1="rMDCtwoS" +num2str(temp[ii][0])+"_l" 		rMDC2="rMDCtwoS" +num2str(temp[ii][0])+"_r" 		if(exists(rMDC1)==0) 			abort "Calculate Real Part Selfenergy of Left Dispersion First!" 		endif 		duplicate/o $rMDC1 temp1D 		temp1[ii][]=temp1D[q] 		if(exists(rMDC2)==0) 			abort "Calculate Real Part Selfenergy of Right Dispersion First!" 		endif 		duplicate/o $rMDC2 temp1D 		temp3[ii][]=temp1D[q] 		ii+=1 		while(ii<iimax) 		MDCfitReSEl= "MDCReSE_L_" + MDCsetname 		MDCfitReSEr= "MDCReSE_R_" + MDCsetname 		duplicate/o temp1 $MDCfitReSEl 		duplicate/o temp2 $MDCfitReSEr	 	endifendFunction MDCWidth_selImSE(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string MDCsetname=popStr[10, strlen(popStr)-1]		string MDCFWHMT="MDCT_" + MDCsetname 	string MDCFWHMG="MDCG_" + MDCsetname 	 	string MDCFWHME="MDCE_" + MDCsetname	duplicate/o $popStr MDCImSE 	 	duplicate/o $MDCFWHMT MDCTwaveIm 	duplicate/o $MDCFWHME MDCEwaveIm 	duplicate/o $MDCFWHMG MDCGwaveIm 	MDCWidth_EdepCalIm() 	MDCWidth_GdepCalIm()EndFunction MDCWidth_selReSE(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string MDCsetname=popStr[10, strlen(popStr)-1]		string MDCFWHMT="MDCT_" + MDCsetname 	string MDCFWHMG="MDCG_" + MDCsetname 	 	string MDCFWHME="MDCE_" + MDCsetname	duplicate/o $popStr MDCReSE 	 	duplicate/o $MDCFWHMT MDCTwaveRe 	duplicate/o $MDCFWHME MDCEwaveRe 	duplicate/o $MDCFWHMG MDCGwaveRe	MDCWidth_EdepCalRe()	MDCWidth_GdepCalRe()EndFunction MDCWidth_showImSE(ctrlName) : ButtonControl	String ctrlName		Dowindow/f MDCImSEW	if (v_flag!=1)	display	appendimage MDCImSE	ModifyImage MDCImSE ctab= {*,*,YellowHot256,1}	dowindow/c MDCImSEW	endifEndFunction MDCWidth_showReSE(ctrlName) : ButtonControl	String ctrlName		Dowindow/f MDCReSEW	if (v_flag!=1)	display	appendimage MDCReSE	ModifyImage MDCReSE ctab= {*,*,YellowHot256,1}	dowindow/c MDCReSEW	endifEndFunction MDCWidth_updatePM(ctrlName) : ButtonControl	String ctrlName	svar MDCsetname 	string MDCFWHMTable= "MDCTable_" + MDCsetname 	wave MDCTable 	duplicate/o MDCTable $MDCFWHMTable	MDCWidth_getPM ()	duplicate/o  $MDCFWHMTable MDCTable	EndFunction MDCWidth_showEdepIm(ctrlName) : ButtonControl	String ctrlName	MDCWidth_EdepCalIm()	dowindow/f MDC_EdepImW	if(V_flag!=1)		display MDCEdepIm vs MDCEWaveIm as "MDC_EdepImW"		ModifyGraph mode=3,marker=8,msize=3		ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0		Label bottom "\\f01E - E\\BF\\M (eV)"		Label left "MDC Width (Slice)"		string text		nvar MDCTnumIm		wave MDCTwaveIm		text="\\f01\\Z14"+num2str(MDCTwaveIm[MDCTnumIm])+" K"		TextBox/C/N=text0/F=0/H=8/A=MC text		TextBox/C/N=text0/X=40.00/Y=38.00		dowindow/c MDC_EdepImW	endifEndFunction MDCWidth_showEdepRe(ctrlName) : ButtonControl	String ctrlName	MDCWidth_EdepCalRe()	dowindow/f MDC_EdepReW	if(V_flag!=1)		display  MDCEdepRe vs MDCEWaveRe as "MDC_EdepReW"		ModifyGraph mode=3,marker=8,msize=3		ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0		Label bottom  "\\f01E - E\\BF\\M (eV)"		Label left "ReSE (eV)"		string text		nvar MDCTnumRe		wave MDCTwaveRe		text="\\f01\\Z14"+num2str(MDCTwaveRe[MDCTnumRe])+" K"		TextBox/C/N=text0/F=0/H=8/A=MC text		TextBox/C/N=text0/X=40.00/Y=38.00		dowindow/c MDC_EdepReW	endifEndFunction MDCWidth_EdepCalIm()	wave MDCImSE	wave MDCEWaveIm	wave MDCTwaveIm	nvar MDCTnumIm	duplicate/o MDCEWaveIm MDCEdepIm	MDCEdepIm=MDCImSE[MDCTnumIm][p]EndFunction MDCWidth_EdepCalRe()	wave MDCReSE	wave MDCEWaveRe	wave MDCTwaveRe	nvar MDCTnumRe	duplicate/o MDCEWaveRe MDCEdepRe	MDCEdepRe=MDCReSE[MDCTnumRe][p]EndFunction MDCWidth_setTpointsIm(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar MDCTnumIm	wave MDCTwaveIm	if(MDCTnumIm<0)	MDCTnumIm=0	endif	if(MDCTnumIm>(dimsize(MDCTwaveIm,0)-1))	MDCTnumIm=dimsize(MDCTwaveIm,0)-1	endif	MDCWidth_EdepCalIm()	dowindow MDC_EdepImW	if(V_flag==1)	string text="\\f01\\Z14"+num2str(MDCTwaveIm[MDCTnumIm])+" K"	TextBox/C/N=text0/F=0/H=8/A=MC/W=MDC_EdepImW text	endifEndFunction MDCWidth_setTpointsRe(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar MDCTnumRe	wave MDCTwaveRe	if(MDCTnumRe<0)	MDCTnumRe=0	endif	if(MDCTnumRe>(dimsize(MDCTwaveRe,0)-1))	MDCTnumRe=dimsize(MDCTwaveRe,0)-1	endif	MDCWidth_EdepCalRe()	dowindow MDC_EdepReW	if(V_flag==1)	string text="\\f01\\Z14"+num2str(MDCTwaveRe[MDCTnumRe])+" K"	TextBox/C/N=text0/F=0/H=8/A=MC/W=MDC_EdepReW text	endifEndFunction MDCWidth_showGdepIm(ctrlName) : ButtonControl	String ctrlName	nvar MDCcheckvsTIm	MDCWidth_GdepCalIm()	dowindow/f MDC_GdepImW	if(V_flag!=1)				if(MDCcheckvsTIm==1)		display MDCGdepIm vs MDCTWaveIm as "MDC_GdepImW"		Label bottom "\\f01T (K)"		else		display MDCGdepIm vs MDCGWaveIm as "MDC_GdepImW"		Label bottom "\\f01Graph"		endif		ModifyGraph mode=3,marker=8,msize=3		ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0				Label left "MDC Width (Slice)"		string text		nvar MDCEnumIm		wave MDCEwaveIm		text="\\f01\\Z14"+num2str(round(MDCEwaveIm[MDCEnumIm]*10000)/10)+" meV"		TextBox/C/N=text0/F=0/H=8/A=MC text		TextBox/C/N=text0/X=30/Y=42		dowindow/c MDC_GdepImW	endifEndFunction MDCWidth_showGdepRe(ctrlName) : ButtonControl	String ctrlName	nvar MDCcheckvsTRe	MDCWidth_GdepCalRe()	dowindow/f MDC_GdepReW	if(V_flag!=1)				if(MDCcheckvsTRe==1)		display MDCGdepRe vs MDCTWaveRe as "MDC_GdepReW"		Label bottom "\\f01T (K)"		else		display MDCGdepRe vs MDCGWaveRe as "MDC_GdepReW"		Label bottom "\\f01Graph"		endif		ModifyGraph mode=3,marker=8,msize=3		ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0				Label left "ReSE (eV)"		string text		nvar MDCEnumRe		wave MDCEwaveRe		text="\\f01\\Z14"+num2str(round(MDCEwaveRe[MDCEnumRe]*10000)/10)+" meV"		TextBox/C/N=text0/F=0/H=8/A=MC text		TextBox/C/N=text0/X=30/Y=42		dowindow/c MDC_GdepReW	endifEndFunction MDCWidth_GdepCalIm()	wave MDCImSE	wave MDCTWaveIm	nvar MDCEnumIm	duplicate/o MDCTWaveIm MDCGdepIm	MDCGdepIm=MDCImSE[p][MDCEnumIm]EndFunction MDCWidth_GdepCalRe()	wave MDCReSE	wave MDCTWaveRe	nvar MDCEnumRe	duplicate/o MDCTWaveRe MDCGdepRe	MDCGdepRe=MDCReSE[p][MDCEnumRe]EndFunction MDCWidth_setEpointsIm(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar MDCEnumIm	wave MDCEwaveIm	if(MDCEnumIm<0)	MDCEnumIm=0	endif	if(MDCEnumIm>(dimsize(MDCEwaveIm,0)-1))	MDCEnumIm=dimsize(MDCEwaveIm,0)-1	endif	MDCWidth_GdepCalIm()	dowindow MDC_GdepImW	if(V_flag==1)	string text="\\f01\\Z14"+num2str(round(MDCEwaveIm[MDCEnumIm]*10000)/10)+" meV"	TextBox/C/N=text0/W=MDC_GdepImW text	endifEndFunction MDCWidth_setEpointsRe(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar MDCEnumRe	wave MDCEwaveRe	if(MDCEnumRe<0)	MDCEnumRe=0	endif	if(MDCEnumRe>(dimsize(MDCEwaveRe,0)-1))	MDCEnumRe=dimsize(MDCEwaveRe,0)-1	endif	MDCWidth_GdepCalRe()	dowindow MDC_GdepReW	if(V_flag==1)	string text="\\f01\\Z14"+num2str(round(MDCEwaveRe[MDCEnumRe]*10000)/10)+" meV"	TextBox/C/N=text0/W=MDC_GdepReW text	endifEndFunction MDCWidth_CKvsTIm(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	nvar MDCcheckvsTIm	dowindow MDC_GdepImW	if(V_flag==1)	RemoveFromGraph/W=MDC_GdepImW MDCGdepIm			if(MDCcheckvsTIm==1)		appendtograph/W=MDC_GdepImW MDCGdepIm vs MDCTWaveIm 		Label bottom "\\f01T (K)"		else		appendtograph/W=MDC_GdepImW MDCGdepIm vs MDCGWaveIm 		Label bottom "\\f01Graph"		endif		ModifyGraph mode=3,marker=8,msize=3		ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0				Label left "MDC Width (Slice)"	endifEndFunction MDCWidth_CKvsTRe(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	nvar MDCcheckvsTRe	dowindow MDC_GdepReW	if(V_flag==1)	RemoveFromGraph/W=MDC_GdepReW MDCGdepRe			if(MDCcheckvsTRe==1)		appendtograph/W=MDC_GdepReW MDCGdepRe vs MDCTWaveRe 		Label bottom "\\f01T (K)"		else		appendtograph/W=MDC_GdepReW MDCGdepRe vs MDCGWaveRe		Label bottom "\\f01Graph"		endif		ModifyGraph mode=3,marker=8,msize=3		ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0				Label left "K\\B//\\M (Slice)"	endifEnd/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////show MDC widthproc MDCWidthShow_new(ctrlName) : ButtonControl	String ctrlName	dowindow/f MDCWidthShow_new	if(V_flag!=1)	variable/g MDCWidthShow_E, MDCwidthshow_T	variable/g offset_EvsT, offset_EvsAng, offset_TvsAng	variable/g  MDCWidth_Tstep=1	variable/g  MDCWidth_T, MDCWidth_E	string/G MDCwidthfiterstr, MDCwidthrefstr		variable/g showcheckall, showcheck1, showcheck2, showcheck3, showcheck4, showcheck5, showcheck6, showcheck7, showcheck8, showcheck9, showcheck10	string/g MDCWidth3Dname1,MDCWidth3Dname2,MDCWidth3Dname3,MDCWidth3Dname4,MDCWidth3Dname5,MDCWidth3Dname6,MDCWidth3Dname7,MDCWidth3Dname8,MDCWidth3Dname9,MDCWidth3Dname10		variable/g MDCtotalPages, MDCpage	string/g MDCshowcontrol, MDCwinName	variable/g MDCgraphcontrol	if(!exists("SelMDCnameList"))	make/T/o/n=0 SelMDCnameList		endif		if(!exists("ShowcheckList"))	make/o/n=0 ShowcheckList	endif		if(!exists("MDCcolorList"))	make/T/o/n=0 MDCcolorList	endif		if(MDCpage==0)	MDCpage=1	endif			make/o/T/n=0 MDCwidthListwave	make/o/n=0 MDCwidthSelwave//	MDCwidthrefresh("",1,"","")	MDCWidthShowW_new() 	MDCWidth3DnameUpdate()	endifendFunction MDCwidthrefresh(ctrlName, varNum, varStr, varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName		wave/T MDCwidthListwave, MDCwidthSelwave	svar MDCwidthfiterstr, MDCwidthrefstr	variable ii,itemnum	string tmptstr	MDCwidthrefstr=wavelist( "MDCImSE_"+"*"+MDCwidthfiterstr+"*",";","DIMS:2")	itemnum=itemsinlist(MDCwidthrefstr)	redimension/N=(itemnum) MDCwidthListwave, MDCwidthSelwave	ii=0	do	tmptstr=stringfromlist(ii,MDCwidthrefstr)	MDCwidthListwave[ii]=tmptstr	ii+=1	while(ii<itemnum)	ListBox MDCWidthlistbox,mode=9EndFunction MDCWidthmoveup(ctrlName) : ButtonControl	String ctrlName    controlinfo/W=MDCWidthShow MDCWidthlistbox  wave/T tmp=MDCwidthListwave  wave selwave=MDCwidthSelwave   string tmpstr  variable ii,iimax   iimax=dimsize(selwave,0)  	 ii=1     do     if(selwave[ii])     tmpstr=tmp[ii-1]     tmp[ii-1]=tmp[ii]     tmp[ii]=tmpstr     selwave[ii]=0     selwave[ii-1]=1     endif     ii+=1     while(ii<iimax)   EndFunction MDCWidthmovedown(ctrlName) : ButtonControl	String ctrlName    controlinfo/W=MDCWidthShow MDCWidthlistbox  wave/T tmp=MDCwidthListwave  wave selwave=MDCwidthSelwave   string tmpstr  variable ii,iimax   iimax=dimsize(selwave,0)  	 ii=iimax-1     do     if(selwave[ii])     tmpstr=tmp[ii+1]     tmp[ii+1]=tmp[ii]     tmp[ii]=tmpstr     selwave[ii]=0     selwave[ii+1]=1     endif     ii-=1     while(ii>=0) EndWindow MDCWidthShowW_new() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(1101,199,1539,496) as "MDCWidthShow_new"	ModifyPanel fixedSize=1, frameStyle=1	SetDrawLayer UserBack	SetDrawEnv fillfgc= (32768,54528,65280)	DrawRect 233,16,424,70	SetDrawEnv fillfgc= (32768,54528,65280)	DrawRect 234,102,425,156	SetDrawEnv fillfgc= (32768,54528,65280)	DrawRect 236,192,427,246	SetDrawEnv fillfgc= (63232,50944,32768)	DrawRect 10,31,226,291	Button show,pos={244,24},size={53,35},proc=MDCWidthShow_EvsT_new,title="Show"	Button show,font="@Arial Unicode MS",fSize=14,fStyle=1	SetVariable offset,pos={314,132},size={105,20},proc=MDCWidth_EvsAng_offset_new,title="\\F'@Arial Unicode MS'Offset"	SetVariable offset,limits={-inf,inf,0.1},value= offset_EvsAng	SetVariable offset1,pos={313,21},size={101,20},proc=MDCWidth_EvsT_offset_new,title="\\F'@Arial Unicode MS'T step"	SetVariable offset1,limits={1,inf,1},value= MDCWidth_Tstep	Button show1,pos={246,113},size={53,35},proc=MDCWidthShow_EvsAng_new,title="Show"	Button show1,font="@Arial Unicode MS",fSize=14,fStyle=1	SetVariable offset2,pos={316,45},size={101,20},proc=MDCWidth_EvsT_offset_new,title="\\F'@Arial Unicode MS'Offset"	SetVariable offset2,limits={-inf,inf,0.1},value= offset_EvsT	SetVariable offset3,pos={314,108},size={101,20},proc=MDCWidth_EvsAng_offset_new,title="\\F'@Arial Unicode MS'T"	SetVariable offset3,limits={1,inf,5},value= MDCWidth_T	SetVariable offset4,pos={316,222},size={105,20},proc=MDCWidth_TvsAng_offset_new,title="\\F'@Arial Unicode MS'Offset"	SetVariable offset4,limits={-inf,inf,0.1},value= offset_TvsAng	Button show2,pos={248,203},size={53,35},proc=MDCWidthShow_TvsAng_new,title="Show"	Button show2,font="@Arial Unicode MS",fSize=14,fStyle=1	SetVariable offset5,pos={316,198},size={101,20},proc=MDCWidth_TvsAng_offset_new,title="\\F'@Arial Unicode MS'E"	SetVariable offset5,limits={-0.3,0.01,0.002},value= MDCWidth_E	PopupMenu Colorpop1,pos={163,36},size={56,21},proc=Butt_ColorFunc,title=" "	PopupMenu Colorpop1,mode=1,popColor= (0,0,0),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop1,pos={164,36},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop1,mode=1,popColor= (0,0,65535),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop2,pos={163,58},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop2,mode=1,popColor= (202,3640,61894),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop3,pos={163,81},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop3,mode=1,popColor= (0,65280,65280),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop4,pos={163,104},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop4,mode=1,popColor= (1820,10922,54612),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop5,pos={163,127},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop5,mode=1,popColor= (0,52224,52224),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop6,pos={163,151},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop6,mode=1,popColor= (5056,18204,47331),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop7,pos={163,174},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop7,mode=1,popColor= (7281,21845,43690),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop8,pos={163,197},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop8,mode=1,popColor= (65280,0,26112),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop9,pos={163,220},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop9,mode=1,popColor= (12945,29127,36408),value= #"\"*COLORPOP*\""	PopupMenu MDCColorpop10,pos={163,242},size={56,21},proc=MDCWidthColor,title=" "	PopupMenu MDCColorpop10,mode=1,popColor= (16384,32768,32768),value= #"\"*COLORPOP*\""	SetVariable setvar6,pos={104,8},size={62,18},proc=MDCchangepage,title="Page"	SetVariable setvar6,limits={1,100,1},value= MDCpage	SetVariable setvar5,pos={169,8},size={50,18},disable=2,title="of"	SetVariable setvar5,limits={1,100,1},value= MDCtotalPages,noedit= 1	CheckBox showck2,pos={11,64},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck2,variable= showcheck2	SetVariable MDC3Dname1,pos={33,38},size={127,18},title=" "	SetVariable MDC3Dname1,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname1,value= MDCWidth3Dname1,noedit= 1	SetVariable MDC3Dname2,pos={33,60},size={127,18},title=" "	SetVariable MDC3Dname2,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname2,value= MDCWidth3Dname2,noedit= 1	SetVariable MDC3Dname3,pos={33,83},size={127,18},title=" "	SetVariable MDC3Dname3,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname3,value= MDCWidth3Dname3,noedit= 1	Button button0,pos={9,5},size={53,24},proc=LoadMDCfile,title="Load",fSize=14	Button button0,fStyle=1	CheckBox showcheck4,pos={12,109},size={16,14},title="",variable= showcheck4	CheckBox showcheck5,pos={12,130},size={16,14},title="",variable= showcheck5	CheckBox showcheck6,pos={12,153},size={16,14},title="",variable= showcheck6	SetVariable MDC3Dname4,pos={34,106},size={127,18},title=" "	SetVariable MDC3Dname4,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname4,value= MDCWidth3Dname4,noedit= 1	SetVariable MDC3Dname5,pos={34,128},size={127,18},title=" "	SetVariable MDC3Dname5,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname5,value= MDCWidth3Dname5,noedit= 1	SetVariable MDC3Dname6,pos={34,151},size={127,18},title=" "	SetVariable MDC3Dname6,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname6,value= MDCWidth3Dname6,noedit= 1	SetVariable MDC3Dname7,pos={33,83},size={127,18},title=" "	SetVariable MDC3Dname7,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname7,value= MDCWidth3Dname3,noedit= 1	CheckBox showck4,pos={12,110},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck4,variable= showcheck4	CheckBox showck5,pos={13,131},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck5,variable= showcheck5	CheckBox showck6,pos={12,154},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck6,variable= showcheck6	SetVariable MDC3Dname8,pos={34,106},size={127,18},title=" "	SetVariable MDC3Dname8,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname8,value= MDCWidth3Dname4,noedit= 1	SetVariable MDC3Dname9,pos={34,128},size={127,18},title=" "	SetVariable MDC3Dname9,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname9,value= MDCWidth3Dname5,noedit= 1	SetVariable MDC3Dname0,pos={34,151},size={127,18},title=" "	SetVariable MDC3Dname0,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname0,value= MDCWidth3Dname6,noedit= 1	CheckBox showck7,pos={13,178},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck7,variable= showcheck7	SetVariable MDC3Dname08,pos={35,175},size={127,18},title=" "	SetVariable MDC3Dname08,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname08,value= MDCWidth3Dname7,noedit= 1	CheckBox showck8,pos={14,201},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck8,variable= showcheck8	CheckBox showck9,pos={14,223},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck9,variable= showcheck9	CheckBox showck10,pos={14,246},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck10,variable= showcheck10	SetVariable MDC3Dname09,pos={36,198},size={127,18},title=" "	SetVariable MDC3Dname09,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname09,value= MDCWidth3Dname8,noedit= 1	SetVariable MDC3Dname10,pos={36,220},size={127,18},title=" "	SetVariable MDC3Dname10,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname10,value= MDCWidth3Dname9,noedit= 1	SetVariable MDC3Dname01,pos={36,243},size={127,18},title=" "	SetVariable MDC3Dname01,labelBack=(65535,65535,65535),frame=0	SetVariable MDC3Dname01,value= MDCWidth3Dname10,noedit= 1	CheckBox showck1,pos={11,40},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck1,variable= showcheck1	CheckBox showck3,pos={11,86},size={16,14},proc=MDCCheckProc,title=""	CheckBox showck3,variable= showcheck3	CheckBox Checkall,pos={14,271},size={31,15},proc=MDCCheckallProc,title="All"	CheckBox Checkall,variable= showcheckall	Button MDCgraph,pos={302,254},size={53,35},proc=MDCWidth_graphbutt,title="Graph"	Button MDCgraph,font="@Arial Unicode MS",fSize=14,fStyle=1	Button MDCgraph1,pos={172,265},size={36,23},proc=MDCWidth_autocolor,title="auto"	Button MDCgraph1,font="@Arial Unicode MS",fSize=12,fStyle=0EndMacroProc LoadMDCfile(ctrlName) : ButtonControl	String ctrlName	dowindow/f LoadMDCfileW	if (V_flag!=1)  	LoadMDCfileW()  	MDCwidthrefresh("", 1,"", "")	endifEndWindow LoadMDCfileW() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel /W=(717,304,977,630) as "LoadMDCfileW"	ModifyPanel fixedSize=1, frameStyle=1	ListBox MDCWidthlistbox,pos={10,49},size={240,268}	ListBox MDCWidthlistbox,listWave=root:MDCwidthListwave	ListBox MDCWidthlistbox,selWave=root:MDCwidthSelwave,mode= 9	SetVariable fiterwave,pos={10,14},size={105,20},proc=MDCwidthrefresh,title="\\F'@Arial Unicode MS'Filter"	SetVariable fiterwave,value= MDCwidthfiterstr	Button moveup,pos={120,5},size={25,37},proc=MDCWidthmoveup,title=""	Button moveup,picture= ProcGlobal#UpButton	Button moveup1,pos={155,6},size={25,37},proc=MDCWidthmovedown,title=""	Button moveup1,picture= ProcGlobal#DownButton	Button button0,pos={190,6},size={47,34},proc=LoadMDCfileGo,title="Load",fSize=14	Button button0,fStyle=1EndMacrofunction LoadMDCfileGo(ctrlName) : ButtonControl	String ctrlName	controlinfo/W=MDCWidthShow MDCWidthlistbox	wave/T tmp=MDCwidthListwave	wave selwave=MDCwidthSelwave	variable ii,jj,iimax, wavenum	nvar MDCtotalPages	wave/T MDCcolorList 		variable prenum=dimsize(MDCcolorList,0)	iimax=dimsize(selwave,0)	ii=0	jj=0	string name	variable pnt,qpoint	string Eindexname    	do    		if(selwave[ii]!=0)  	 	jj=jj+1    		endif    		ii+=1   	 while(ii<iimax)   	 wavenum=jj   	 make/T/o/n=(wavenum) SelMDCnameList   	 make/o/n=(wavenum) ShowcheckList    	 redimension/n=(wavenum) MDCcolorList    	 ShowcheckList=1      	 if(prenum<wavenum)   	 MDCcolorList[prenum-1,wavenum-1]="(0,0,0)"   	 endif   	 jj=0   	 ii=0   	 do     		if(selwave[ii]!=0)     		SelMDCnameList[jj]=tmp[ii]  	 	jj=jj+1    		endif    		ii+=1   	 while(ii<wavenum)   	 MDCtotalPages=ceil(wavenum/10)   	 MDCWidth3DnameUpdate()   	 dowindow/K LoadMDCfileWendFunction MDCchangepage(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	nvar MDCpage, MDCtotalPages	if(MDCpage>MDCtotalPages)	MDCpage=MDCtotalPages	endif	MDCWidth3DnameUpdate()Endfunction MDCWidth3DnameUpdate()		wave/T SelMDCnameList, MDCcolorList	wave ShowcheckList	nvar MDCpage	string MDC3Dname,showckname, MDCpopname	variable i=0	variable selnum=dimsize(SelMDCnameList,0)	string colorstr	variable colorval1,colorval2,colorval3	do	MDC3Dname="MDCWidth3Dname"+num2str(i+1)	showckname="showcheck"+num2str(i+1)	MDCpopname="MDCColorpop"+num2str(i+1)	svar temp=$MDC3Dname	nvar temp2=$showckname	if((MDCpage-1)*10+i<selnum)	temp=SelMDCnameList[(MDCpage-1)*10+i]	temp2=ShowcheckList[(MDCpage-1)*10+i]		colorstr=MDCcolorList[(MDCpage-1)*10+i]	colorstr=colorstr[1,strlen(colorstr)-2]	colorval1=str2num(StringFromList(0, colorstr, ","))	colorval2=str2num(StringFromList(1, colorstr, ","))	colorval3=str2num(StringFromList(2, colorstr, ","))	PopupMenu $MDCpopname,popColor=(colorval1,colorval2,colorval3)	 	else	temp=""	temp2=0	PopupMenu $MDCpopname,popColor=(0,0,0)	endif	i=i+1	while(i<10)endFunction MDCCheckProc(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	nvar MDCpage	wave ShowcheckList	ShowcheckList[(MDCpage-1)*10+str2num(ctrlName[6,8])-1]=checked	MDCWidth3DnameUpdate()	 dowindow MDCWidth_ShowW 	 if(V_flag==1) 	 	MDCWidth_calc()	nvar MDCgraphcontrol	MDCgraphcontrol=0		MDCWidth_show() 	endifEndFunction MDCCheckallProc(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	wave ShowcheckList	ShowcheckList=checked	MDCWidth3DnameUpdate()	dowindow MDCWidth_ShowW 	 if(V_flag==1)	nvar MDCgraphcontrol	MDCgraphcontrol=0	MDCWidth_show()	endifEndFunction MDCWidthColor(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	variable i,No	Nvar MDCpage	wave/t MDCcolorList	sscanf ctrlName, "MDCColorpop%f", i	No = (MDCpage-1)*10+i-1 	 MDCcolorList[No] = popStr 	 dowindow MDCWidth_ShowW 	 if(V_flag==1) 		MDCWidth_show() 	endif 	EndFunction MDCWidthShow_EvsT_new(ctrlName):ButtonControl	String ctrlName	svar control=MDCshowcontrol	control="EvsT"	MDCWidth_calc()		nvar MDCgraphcontrol	MDCgraphcontrol=0	dowindow/f MDCWidth_showW	MDCWidth_show()endFunction MDCWidth_EvsT_offset_new(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	svar control=MDCshowcontrol	if(stringmatch(control,"EvsT"))	MDCWidth_calc()	dowindow MDCWidth_ShowW 	 if(V_flag==1)		nvar MDCgraphcontrol	MDCgraphcontrol=0	MDCWidth_show()	endif	endifEndFunction MDCWidthShow_TvsAng_new(ctrlName):ButtonControl	String ctrlName	svar control=MDCshowcontrol	control="TvsAng"	MDCWidth_calc()	nvar MDCgraphcontrol	MDCgraphcontrol=0	dowindow/f MDCWidth_showW	MDCWidth_show()endFunction MDCWidth_TvsAng_offset_new(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	svar control=MDCshowcontrol	if(stringmatch(control,"TvsAng"))	MDCWidth_calc()			dowindow MDCWidth_ShowW 	 if(V_flag==1)	nvar MDCgraphcontrol	MDCgraphcontrol=0	MDCWidth_show()	endif	endifEndFunction MDCWidthShow_EvsAng_new(ctrlName):ButtonControl	String ctrlName	svar control=MDCshowcontrol	control="EvsAng"	MDCWidth_calc()		nvar MDCgraphcontrol	MDCgraphcontrol=0	MDCWidth_show()	endFunction MDCWidth_EvsAng_offset_new(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	svar control=MDCshowcontrol	if(stringmatch(control,"EvsAng"))	MDCWidth_calc()		dowindow MDCWidth_ShowW 	 if(V_flag==1)	nvar MDCgraphcontrol	MDCgraphcontrol=0	MDCWidth_show()	endif	endifEndfunction MDCWidth_show()	svar control=MDCshowcontrol	wave/T tmp=SelMDCnameList	wave selwave=ShowcheckList	variable ii,jj,iimax,jjmax	string MDCWidth3Dname, MDCWidthTname, Eindexname, MDCWidthEname	nvar offset_TvsAng, MDCWidth_E, offset_EvsAng, MDCWidth_Tstep,offset_EvsT	wave/T MDCcolorList	nvar MDCgraphcontrol	svar MDCwinName		string tmpwinname	if(MDCgraphcontrol==1)	tmpwinname="MDCWidth_"+MDCwinName	else	tmpwinname="MDCWidth_showW"	endif		dowindow $tmpwinname		if(V_flag!=1)			display/N=$tmpwinname as tmpwinname	dowindow/C $tmpwinname	else		string tracelist=TraceNameList("MDCWidth_showW", ";", 1)	string tempname	variable n=ItemsInList(tracelist)		if(n>0)	do		tempname=StringFromList(n-1,  tracelist)		RemoveFromGraph/W=$tmpwinname $tempname		n=n-1	while(n>0)		endif	endif	Legend/C/N=text0/J "\\Z08 "	iimax=dimsize(selwave,0)	ii=0	jj=0	string name	string colorstr	variable colorval1,colorval2,colorval3	string legendtext=""    	do    		if(selwave[ii]!=0)	    		    		MDCWidth3Dname=tmp[ii]    		wave temptMDCWidth3D=$MDCWidth3Dname    		    		MDCWidthTname="MDCT_" +MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]    		MDCWidthEname="MDCE_" +MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]       		wave MDCWidth_Tindex=$MDCWidthTname    		wave MDCWidth_Eindex=$MDCWidthEname    		if(stringmatch(control,"EvsT"))   			 jjmax=dimsize(MDCWidth_Tindex,0)   	 		variable tmpt   		 	jj=0  	 		do  				 if(MDCWidth_Tindex[1]>MDCWidth_Tindex[0])  		 		tmpt=MDCWidth_Tindex[jj]  		 		else  	 			tmpt=MDCWidth_Tindex[jjmax-1-jj]  		 		endif  	 			name="MT"+num2str(round(tmpt))+"K"  	 			if(MDCgraphcontrol==1)  	 			name=name+"_"+MDCwinName  	 			endif   	 			wave namewave=$name   	    	 			if(mod(jj,MDCWidth_Tstep)==0)   	// 			if(MDCgraphcontrol==1)   	// 			string tmpname="MDCWidth_Eindex"+"_"+MDCwinName   	// 			appendtograph namewave vs $tmpname   	 			   	// 			else  	 			appendtograph/W=$tmpwinname namewave vs MDCWidth_Eindex  	// 			endif  	 			  	 			ModifyGraph/W=$tmpwinname offset($name)={0, jj*offset_EvsT}  	 			ModifyGraph/W=$tmpwinname mode($name)=3,marker($name)=jj+3,msize($name)=2, rgb($name)=(65535*jj*jj/jjmax/jjmax,65535*jj/jjmax,65535*(jjmax-jj)/jjmax)//(0,34816,52224)  	 			legendtext=legendtext+"\s("+name+")"+num2str(round(tmpt))+"K"  	 			if(mod(jj/MDCWidth_Tstep,3)==2)	 			legendtext=legendtext+" \r"	 			else	 			legendtext=legendtext+" "	 			endif  				endif  				 jj+=1   		 	while(jj<jjmax)   		 	break  	 	  	 	else 	  	 	    			if(stringmatch(control,"TvsAng"))    			name="MT"+MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1] //   			print name    			if(MDCgraphcontrol==1)  	 		name=name+"_"+MDCwinName  	 		endif    			wave namewave=$name   					appendtograph/W=$tmpwinname namewave vs MDCWidth_Tindex  	 		ModifyGraph/W=$tmpwinname offset($name)={0, -1*jj*offset_TvsAng}  	 		endif  	 	  	 		if(stringmatch(control,"EvsAng"))    			name="ME"+MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]   // 			Eindexname=name+"_Ei"    			if(MDCgraphcontrol==1)  	 		name=name+"_"+MDCwinName  //	 		Eindexname=Eindexname+"_"+MDCwinName  	 		endif    			wave namewave=$name   // 			wave MDCWidth_Eindex=$Eindexname  	 		appendtograph/W=$tmpwinname namewave vs MDCWidth_Eindex  	 		ModifyGraph/W=$tmpwinname offset($name)={0, -1*jj*offset_EvsAng}  //	 		SetAxis/W=$tmpwinname bottom -0.25,0.005  	 		endif  	 	  	 	  	 		ModifyGraph/W=$tmpwinname mode($name)=3,marker($name)=19, msize($name)=2  	 		colorstr=MDCcolorList[ii]			colorstr=colorstr[1,strlen(colorstr)-2]			colorval1=str2num(StringFromList(0, colorstr, ","))			colorval2=str2num(StringFromList(1, colorstr, ","))			colorval3=str2num(StringFromList(2, colorstr, ","))	 		ModifyGraph/W=$tmpwinname rgb($name)=(colorval1,colorval2,colorval3)	 	//	 		legendtext=legendtext+"\s("+name+")"+MDCWidth3Dname[strsearch(MDCWidth3Dname, "_P",0)+1,strsearch(MDCWidth3Dname, "_S",0)+4]	 		legendtext=legendtext+"\s("+name+")"+MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]	 			 		if(mod(jj,3)==2)	 		legendtext=legendtext+" \r"	 		else	 		legendtext=legendtext+" "	 		endif	 		 	endif  	 	jj=jj+1  	   	 	    	      		endif      		ii+=1   	 while(ii<iimax)     	 if(jj)  	 Legend/W=$tmpwinname/C/N=text0/J "\\Z08"   	 AppendText/W=$tmpwinname/N=text0 legendtext        	 ModifyGraph/W=$tmpwinname tick=1,mirror=2,standoff=0, fStyle=1,fSize=14   	 Label/W=$tmpwinname left "MDC Width (slice)"   	 Label/W=$tmpwinname bottom "E (eV)"   	    	 if(stringmatch(control,"TvsAng"))   	 Label/W=$tmpwinname bottom "T (K)"   	 endif 	   	 Legend/W=$tmpwinname/C/N=text1/J/X=50.00/Y=0.00 "\\Z14\f01"   	 if(MDCgraphcontrol==0)   	 AppendText/W=$tmpwinname/N=text1 control   	 else   	 AppendText/W=$tmpwinname/N=text1 control+"_"+MDCwinName   	 endif   	 endif   	 endfunction MDCWidth_calc()	svar control=MDCshowcontrol	wave/T tmp=SelMDCnameList	variable ii,iimax	string MDCWidth3Dname, MDCWidthTname, MDCWidthEname	nvar MDCWidth_E, MDCWidth_T		wave selwave=ShowcheckList		iimax=dimsize(tmp,0)	ii=0	string name	variable tpnt, epnt,qpoint	string Eindexname    	do    	if(selwave[ii]!=0)    		    		MDCWidth3Dname=tmp[ii]    		wave temptMDCWidth3D=$MDCWidth3Dname    		MDCWidthTname="MDCT_" +MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]    		MDCWidthEname="MDCE_" +MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]    	    		wave  MDCWidthTwave=$MDCWidthTname	    		wave  MDCWidthEwave=$MDCWidthEname    		tpnt=dimsize(MDCWidthTwave,0)    		epnt=dimsize(MDCWidthEwave,0)    		    		    		if(stringmatch(control,"TvsAng"))    		name="MT"+MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]    		make/o/n=(tpnt) $name    		    		wave namewave=$name    		findlevel/Q $MDCWidthEname MDCWidth_E   		    		if(V_LevelX<0)    		namewave=NaN    		else    		namewave= temptMDCWidth3D[p][V_LevelX]    		endif    		endif    		    		    		if(stringmatch(control,"EvsAng"))    		name="ME"+MDCWidth3Dname[10, strlen(MDCWidth3Dname)-1]    		    		make/o/n=(epnt) $name    		    		    		findlevel/Q $MDCWidthTname MDCWidth_T    		wave namewave=$name    		namewave= temptMDCWidth3D[V_LevelX][p]    		endif	    		    		 if(stringmatch(control,"EvsT"))    		 variable jj, jjmax    		 jjmax=tpnt    		 do  	 		name="MT"+num2str(round(MDCWidthTwave[jj]))+"K"   	 		make/o/n=(epnt) $name   			wave namewave=$name  	 		namewave= temptMDCWidth3D[jj][p]  			jj+=1   		while(jj<jjmax)    	   		     		  break   		     		 endif   		    	endif   		    		ii+=1   	 while(ii<iimax)endFunction MDCWidth_graphbutt(ctrlName):ButtonControl	String ctrlName	Svar MDCwinName	nvar MDCgraphcontrol	svar control=MDCshowcontrol	nvar MDCWidth_T, MDCWidth_E 	   		MDCgraphcontrol=1			dowindow MDCWidth_showW	if(V_flag==1)		MDCwinName="i"	string tracelist=TraceNameList("MDCWidth_showW", ";", 1)	string curnamey,tempnamey,curnamex,tempnamex	variable n=ItemsInList(tracelist)		if(n>0)		do		curnamey=StringFromList(n-1,  tracelist)				if(stringmatch(control,"TvsAng"))		if(MDCWidth_E<0)		MDCwinName=num2str(round(abs(MDCWidth_E)*1000))+"meV"		else		MDCwinName="p"+num2str(round(abs(MDCWidth_E)*1000))+"meV"		endif		endif				if(stringmatch(control,"EvsAng"))//		curnamex="MDCE_"+curnamey[2,strlen(curnamey)-1]		MDCwinName=num2str(MDCWidth_T)+"K"		endif						 if(stringmatch(control,"EvsT"))//		 curnamex="MDCT_"+curnamey[2,strlen(curnamey)-1]		 wave/T tmp=SelMDCnameList		 variable ii,iimax		 string MDCWidth3Dname		 wave selwave=ShowcheckList			 iimax=dimsize(tmp,0)		 ii=0		 string name		 variable tpnt, epnt,qpoint		 string Eindexname    			do    			if(selwave[ii]!=0)    		    			MDCWidth3Dname=tmp[ii]    			MDCwinName=MDCWidth3Dname[9, strlen(MDCWidth3Dname)-1]    			break    			endif    			ii+=1    			while(ii<iimax)		 endif				tempnamey =curnamey+"_"+MDCwinName				duplicate/o $curnamey $tempnamey				n=n-1		while(n>0)				endif	MDCWidth_show()	endif		MDCgraphcontrol=0	endFunction MDCWidth_autocolor(ctrlName):ButtonControl	String ctrlName	variable colorseed	wave/T tmp=SelMDCnameList	wave/t MDCcolorList	variable jj,jjmax	jjmax=dimsize(tmp,0)	jj=0	do		MDCcolorList[jj]="("+num2str(65535*jj*jj/jjmax/jjmax)+","+num2str(65535*jj/jjmax)+","+num2str(65535*(jjmax-jj)/jjmax)+")"	jj=jj+1	while(jj<jjmax)	MDCWidth3DnameUpdate()	dowindow/f MDCWidth_ShowW 	 if(V_flag==1) 		MDCWidth_show() 	endif endPicture UpButton	ASCII85Begin	M,6r;%14!\!!!!.8Ou6I!!!!l!!!!F#Qau+!/8jRQN.!c$#iF<ErZ1J'*&"?'*/*%S/;5+$;G5%6Vp	TmDffo=BQ%i48OGifE,ol/Bl%>\!-m4g;g2?-pD,sMpLOk96J1e4QY_3Q+sX/pa:MLK&<[$%KFeb]`	J'*T<YQ8\S4HYuK%13!SVZ9u.(EnUMMPGo<EqNO+5Ed%I<tALmJGN4]]YgJr6BT6%tG6)-B[GbC&g7	lKfhEK+-02g`6#]C!Yn8a"<\9<bJIlq`;fo-"*o-?FKe"-!O$DA!W[2i/gM(MiW"PA:aT6D+HZZ^+q	j&H!K^1Za=^H5'EH2k!3fD.A-r=$!!$h\HpT"WWXSspoLV4M!8+97g_TtCU)^-<!0%!ZR4(QN!^O?t	?r_bU/-<W(!2-DY+ta#6XoX&U[PC>SJ@u*dG)f[d%mXM&J=/_TbQ&bF!WYS/'?pV%9EUqAd_F_>?Z:	_/8-&_+bE^>=9@>U1\<YDZGOk7]iZ[<uCp?<8(F]o-$03;#Q^]358EU(Kc3s[Q)Yqdsr]!-(kN:jak	%<dmn+=SnrbM"A,!I1?hu:9I!X&K7:=&C_?fgD#")u9]Y][]rWETAV<WHgjq->f2$(tH/d!GMGGrY^	e*hK'%a?1I_$4@7/-"<R]0]S'Ts"iVPi/<'Xr'2>&gNr>hELK.\Xh^]arGc7`G-4`'kK<up0lHaK,Q	>`;J,PBVdGd!f>V$VInQ:XX:a/WSH+?h86m9[;iY(L*1@ZHPr<\[3%03Ja:V]`6#IV`k^jb\P!fIOj	dWPUUIe,.M)@MZ-&8*gTH1q:=PJ?pS5Uuj8c'P6d!!'[q(gO#((JMgS!!#E[JL[li#7SE_XM>=9_&^	2((BS"L6pM/+^cW/p#3::S$DA<&5oEY;3nOSCYQGf:&XqYi[)"IV%HlX^>_23[(C"7aT#)>WL'[uKa	9WGf+ZbDk@ZK(bc3P5SNW^P782QK[U`eoX'N$'naE"'XWBt?^>t?42/TMOcNEeaFOP@i!15c!e]LO]	@J[/,Te,jbX\YpSgMT2<1d<%2U?%A68CXF'-*^,%^U8QC3k]LtII>X%pJC-(]ArPDO>`=G,@#7u(-H	?m3j]FB@O#:Df=>tC<)o/%Rmg(0?MguK-#[W/q_JFgcO@NDH=@9#5lm&kM\d2@DK7ktr-R+bQ:UDEo	')BIj@QLcU=@TA=mNEVpSg@\j%MN3580e\eP2o@F+XN4*8IJ+*8D?ZeUf4'QdL^,_9IB(eD9:Yq#dS	u^+IA5"O:RFKP5EA=jL5ga`JEMI$)/\CUm)Ka2.]#6"Jq_G6CFLH;9c)3e-N(13hKSID4l&K02mY*'	/Xj#--_np6d)8WUXd_[BkM/SBJ8Ul\d@2F*^uFBQdT[5#O1F9KCj?r%>G=Ea%0Yf)/C+:)5e=\))%C	OV?PG8RE/>]f.n;5B:'3sDcKmhp*tG)Oie<%3gEa2I[0)r<)n!>5Lk%Z$WO0,&$'#;IATJ6ZV]\]$.	K`keYsQh];[]kc;JjaO&4/"?_b>BrIXlU%C1_B7\GK,UJta4`YjaZ(</+@nQ8-/E`N;./8LVI@U$/6	lqDR+q\s]3HV@@*F/iiRAs$\rk&JWH%`Yd3n2]0l9$SU*%F0;P""c_hZ.<ZlB!$Na2qiT3^=m&`EpX	Y0le:fME1K7b/=lGpD*%E6$+`%+;7_ImgNCj-51=$-H0GY.b4Q8/h9eacD=jUr([CJ?n'N490Jj%nO	;Vjh3+MI%OCRKiQta(Xn:]c!&^+k!Oi1q.d7L)\\0gX!BB(jo(HuH4D]E5f1u;g!CHQ$7BenG=`2(B	5^+%<kCRSkHdBqAEbfn-ZgoT/0am>$JeXUEH@D:F-g\d%bV+$on8rGTca-PGFI*2\Z9pYOTQrZCOGu	jT=f;qQp>jEs,D:Vd):`EK*%%B;IbI4@OS#sVPRr.$siY7G&dOFifDV?i3r9OdWRd:7G3VHnT-2)3L	cQ14L&foObF?=kjFEPfNCiI&QUu=/JWPkdRkuVL:B;'C;o/.>]99@=0QZe]3;f/FiVf&,QbE_0-m^g	iSe+KK*]:7TXfko6pbWWpnX8>UDRiBIT_`dHSo^MTWic33&SYqsT_XilP04&g.=^M!=*`',4-D&dBD	91JM>N!3<HXJlu4_=K8klX,h4p%@&T81.X^*;Gt^*A*XI[PWir1<dIqTJhupqPd5neUaj"^hAI!Ta?	qJJs*G")@u\"ITCh#;l[E"hOsl$pGCm$jdAG+**Q`^_cP\q-u59B.TM!(!6fQ'j;RQ0[(k;*nCp`L<	g._&:SPpq+U%s[Kq]I7r4!k+))U\(\rIn.4R*Q0'Z<@;fm#$pFOmsjB;@m]oMWDWJnALgM40;G%[mk	Cf5(Zm$kM8\>m&iG_c&_nWsl1'-mnOM<)V-`'&t;ErtN@RPUJpRT,SpA$4qKU:D*&l-@JDG<B"c=ce	"jKpWL>Z9RH'+@8mX(f07kDG;,bnq<Kd:IW!lNM9:T\%#$mP3/<9Q1d2n4+0KmBSK;PFiH3D:Jr]gO	Vs=m,P+W17+U4rce3<k/NK&cPanLH%;D-8/(ZJa.(;ua.k?emjE]m)ar?P"b4jsAq/c/^'l8RtdA+'	HY##TD9J<=pGZu"hGdp;X86XM!he)lQq'-9!(4<fWYY_j6Ze2d4=n1Do^I>aM,E#J:G:kUU;S$C`C%	0Q!b@o))QMjY>=Ai/iC3eV*N`(MXV56O0JladoWKbNJDQ`V8\RQ@_Q"3n`C7!IT<duS8Q!^V3XJi;s	YXZ.bi`Al^eU7%8D;*_#9"2t1lU^?;lY`fu=hh.4]kTj`d"_$!XW-eijVqQD9&=Z`H><,5c*Ya<bl]	h32=4Vl[]J6STf/\>HC]Okb?"SDX1,gr-JI%ch045;%YGc:45TFjm(B_VGZS[o7=FiHddD_CNuDIH]	"dBVh7,t!:W8odH_l&op-nH9C34B1gonK-Z3bAG2N8bK3cO2MJ8a/2m@&7,E*=_$_Em;"-f:eKHfIr	dU!CR2_p.),J%,(VlUZ:OdQ5-cX=^2aTKT!^n*#_*SK2#W8%uJ4Id]#O@s,gLO&qpGSL?Ykq;d-kj/	6FcSt/V@4k,nTH1t#1R;6)*?+jl<c^m?;FRDi3?h_\6hWKr*n@W`4,55R$-+?OL4g$q<IW58E8?Z69	lXfh6m8lEQFS&;n443NGJ,3oqeT9@;f.L@$H+i[dll3EO-J]ZO-+`dEG4t;>G7*b3gg,5eGd%%ZgAU	:Aq@Dk@[/R=A^hr$)@)-0r_c[N=%LIo^rfmH3LZ-ZObX^2.7O*nRSKApm%2uqNABpCtVm<36ccU];s	*<pOX68C=iqlBp=T$h@$i,_,^TMj]o5a<#WNSA',KCn=c?VSCVYmRAgO8P#n%.Ds]cWXjr':6Xo?mD	Ea/@9[pHIbfrqnGDK_,'ed[r;q!!!.75tsWF!3qQ3qb`OW!!"-O85`.^!.#pk!.]\%!;ZWp!.a;6!-	Ksq!:!ql!'6JI!#KR:?c>J7!!R(.6pXdsg=07g81RCKSXF:>;>b,:Ld+uiLtIO>.jHGJ&P49::pCRK	"I1A@(7IQ_5q=IFM-qL*Z*7%-6NUHp&M4\)"U.=_'@#qlfjqg+pr7TK2,8UF`*:;D]6eSDgcK`JhLV	;kT4MSF='&J(X/h,PJF(Nu\(b^W8Wm%QXf/1#>?fk7fDmqbq"XX2cql\AL(G+/$=iGsqfd4,>$>*g7	O,ni6AR?#!72+"c2IkH+G;GgGB\7*9hiOC_Z55_q>(!frQ<8Tp0A^ac\KEsrr2oMg"?En$)/jEI(mn	O:7KL_&B\FiK#-C(iShVh_<pWlcf](XBk_?ubDHt,'p$D]cd-fZGH7aDA6CN!P]1qpW[LJXD_I4oNC	G(ESF_CFqY^8mW2MD>c't2l%hB0s,pdDFD%OQd//F/_ph:>=WiE'q.($Imp\t.u-n$7(8jN_+KZRcq	j5WLi,YaMPI!faID%-m^Pa@`CTaN#3#Xor"qtp9VlYA6W!5KF%M@tn<<E7RC<d/bseS76-3B9,]8uE	t,dd-47,SD8J$3c,sA?)XZ8Wpnt5R859#(#8$H<i.ia5\?CC@3:!"@4^[NT?Nn,n^Ma<=qReDmNWLB	!^0*[6d#D#Z8f46BNFS5;_tb1%oiS$O[=BJAoLHmHnaG8/DK@87*b/:]LK^b@NT$!<?`<g#[8E0<..	.&7J70nG`[mn9VcH;cE>9aiR,8a.l;e8"qW&MZc&Fo($gMOa08:)Y*0a5mTUp%kE^neC9`7lQnaX:N	7:Jq2!5q$L.EGq"QgS*YisJI&n8L\i)K+Qd1FCS"#o-Q^8X*U*3,F<?Mil3#ifbal.1A!WelXFZQ'/	M^8Ii`F<gJSNQI`L-g"L&XL7@cu->a<,/L*h2$27S[Gl55=3oOf)@'Q+"5'&Iio<\Of&ej.rT$3L5-	FR2Ea5%h;(2e"I@r;5C]8rShS/A2)UeQSt;OphAV5=FJEr'H'o)DXK5reR[BHb:u=Et-^6O<YWG?eU	QnQ^Q17'sPk1B5D5MOm;PLa69ic"ef8"1=bQ"H:&h74ACc0,V[J5CG/!mOf(k8c(MM.^1LZsY[LU!_	:/TuiY\O,mgd<\]`$%og@Z\tN&Z=lCX1guen3rK5mP\i/FbPMH)I\,En"[;"@3'TY-S^)&\)-N757@	b)!Ym%M;>L(O>`lH-uIfFU2#(K/'o($gEG4tLt14OTI:g^mo[Kf5q'ZK4sAcP(p;j/Ve\h,U2#DPR=	p%<G-_#!nR-ksfo?<0mYr=792'1K1"Tn,8)^:p0RRFSkXKgP,DbJqOkc6BTK6JlYAX?>bu<[<1JXl5	M*a;glPqSoEF.uIeaID,%R6pj=o.#MQ*[$EL<W@fR@9K2;G$RN$4&B$9BNK&qURhIXb@:NdlJV_9SZ	7Hq'#)mOWR7sGTUkul:GIuZK3Y^X-3IZh*j5efjWDinl"I]`67A7aW4NW44BqCrhj70Y$A0MI%!._)	LZ7HY;hCT,/BJ^Wa7$>Zf+FJlC6(io)p@bu)2o"6W=''TmHV5_8?)M9;@k7n;/B_*r=,B>>Vl(m^%W	?3$?!LW6<`ZrI]OZ.'BeUC`nbCAR9m(T$?XKEN8VMa/]"5He7G6AIl0.=j5<gO9^mVrofj`3:1-Ifb	[^NUS%hD#5hr!<%%hE5SIXQXhp:Sph1mXAjN/W^SNfF/@$3^U.d:d6.BeUB/>$=f<7?^nsK9k&H&99	`M%Yl8EM^8uBEqo'G]<eX%#j0dlf\k[1H]F^_e:.Q#S/<V`.>ts5z8OZBBY!QNJ	ASCII85EndEndPicture DownButton	ASCII85Begin	M,6r;%14!\!!!!.8Ou6I!!!!l!!!!F#QOi)!&*)")uos=$#iF<ErZ1J'*&"?'*/*%S/;5+!uYf?6Vp	TmDffo=BQ%i48OGifE,ol/Bl%>\!-m4-?soSaki1[G,f%2l:fL?R*on.U&K.F\I\)+MJXM(?JUr@q0	tFg00d+8eJUr@q00_+T!<[_]`k][2^qanlf?qRZQ%:d-RTrZg_SEs+J:W9f-mc8\R=TqJ$NgJuH?i(	J#m19>$j-Ta85aUs#m19>!<WFV89ROc1BR_h$NgJE:J#:i#m183K6)K-APm&c7Yu_jV5:#?@nM2JW^	:Z9ECjn_Z%?UpEdgkOISjQGC'k%F"4Reb"pP9<Qi%I"pVb9<"[c3g"tG7]a=%5an3MjR5]UR9)2,uM	^qd`.^nA[)a&'m^MW"T21h.6[4N=9mL.i%MQ^BXt)k$0#fW`S0AS02!]uoKU[Y\:DI3s^L7jfZ7B/:	>[<uX(WpI$&OSu'*>]SH96q4@+X$O@'?(3C4;,h+6D."#,B?'JE4X&tlOVta;L'M2`TUJ_iT]$aAbk	/`;"$-Jg(mnrROjAijc1dsDs77lUKl;k;^F[$=<NOPARZmKOcl<*?Zl+YS-U-IP.`\>QVdTFrm\&ge	^_e(FCq^j9K'<QY`/SnC'7I4.C^=keq\F"OWl'V'KQ`[FVh,_*?oiU:ccte4,6D)62bPYE:Y7K8(\2	WVRnG//MU!LTi6nh%:7O^bFa10)X`T>(J,g9$=S9-[bGq)a]>e3X!<+].]XR&)1p[X^BeI-a3Mi20`	+"hhC-;j2/;-5i^l>6.N>.qNBqFM.:)Lj[b[%t1VCV/FHf]h5BhL2o#U!LHfDSj,Es!Km'Bq9QZ3q&	$cRBpKgR\MaLADY$(>RSFb/RJ?pWPc"Jb9*lD?IcX`k$$S`:$Z_81t^<_q8$+4D,[onf]g"`eK0aal	2-J_:d<TXkk,P&URR=&T;XpKjL"ZL/a$Zj[pSoP.IQc+Wts<Qh%79QHL'mfoXd'Nq`Hk-aRo#fVi&f	4^(>\FopY\Nh:nRj90[h#<:K_>f=Z%jIcUP,n@SJA[sqEXrrW6N^E&4'Dc'^=!!!.75tsWF!3qQ3qb	`OW!!"-O85`.^!.#pk!.]\%!;ZWp!.a;6!-Ksq!:!ql!'6JI!#KR:?c>J7!!61m6pXdsg?b-OCD/uJ	a1lP9;U*$9'Z>Vo4bSts$A/6\$;9k2[-!O-'WLV!pS(2T$asg>&u9bM.>fNE+f2`7*kZ9@Q^!"JM20	g3r+\.)b]qc7\i\#O!d`'P4l1tgSXo5^fj-Z2I<j7k*:o(7RTs(cX5eBQ"c1KCB0=%;BB"\r)%S[(8	-1&/oCj7+:Ofqq@stDR5/+%8q#aM"W0u?.ktZbIl?>c5ao5P#e)&]JM#]E/h6X-M>H6li\7!f9P\JJ	$/arMO&$e2>M#'u<,!BiglX7+efblIJd402`PZ*O^KbQsQ4<DLm<h%KQP`1FD&eSW2.f_:(C)-f2<N	RkbJ7-;t4?+#pgTG.".5QPf=ipbIN_nQNmJn[Y\:B:k#_6.+[I=D0N5.7<.)7`E%T7h$,f&pL@]VH<	)Jf:UDueP%CFu*pb=cGnn#R6LOalEr(]^L+Rsm-Bc(=*8+TK:n(jiWH,qUdgKXE2"E!N7Il=pj2g>8	rgrEd(-(]q;*cc+*R2J4sjV.(d:Q!p>0Ng_+,e)\u7)a0J]:iJN1>&9jrg!_V)%kR=KKb;l?btVGu*	ZkDbB6>Z9A/5o,c]5_Lq8PGsh>o(\:d"@!"F>c[:'Z_4UN_(>=HaXtjoRM1VcpC`,j!rsrBqB6lS[r	,kG\<6$V.ucVDle5Ucn6?VL<%PrV*;KdWJQY\^OVq:4V6#]t*Wt9;\<Y27(MaBtYWrIF#jV>AsXC3g	G$HpV0>P+4S6ig,mDk#V8G;j95Gl!#0GWkFmC>%KHJ/!(fUS7'8jaJc	ASCII85EndEnd//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Calculate Cut angleproc cutang(ctrlName) : ButtonControl	String ctrlName	dowindow/f CutAngCalcW	if(V_flag!=1)	variable/g  CutAngCalc_Kx ,CutAngCalc_Ky, CutAngCalc_ang, CutAngCalc_type	CutAngCalcW()	endifEndWindow CutAngCalcW() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(854,543,1044,662) as "CutAngCalcW"	SetVariable Graphi1,pos={31,33},size={89,18},proc=SetVarProcCutAngCalc,title="Kx"	SetVariable Graphi1,limits={-inf,inf,0.001},value= CutAngCalc_Kx	SetVariable Graphi2,pos={32,57},size={88,18},proc=SetVarProcCutAngCalc,title="Ky"	SetVariable Graphi2,limits={-inf,inf,0.001},value= CutAngCalc_Ky	SetVariable Graphi3,pos={32,86},size={99,18},title="Angle"	SetVariable Graphi3,limits={-inf,inf,0.001},value= CutAngCalc_ang,noedit= 1	Button button0,pos={127,42},size={43,27},proc=CutAngCalc_valfromcrs,title="csr"	PopupMenu popup0,pos={18,4},size={135,21},proc=CutAngCalc_seltype,title="center"	PopupMenu popup0,mode=2,popvalue="(1,1)_Cuprates",value= #"\"(0,0);(1,1)_Cuprates\""EndMacroFunction CutAngCalc_seltype(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	nvar CutAngCalc_type	CutAngCalc_type=popNum	Endfunction SetVarProcCutAngCalc(sva) : SetVariableControl	STRUCT WMSetVariableAction &sva	CutAngCalc()Endfunction CutAngCalc()nvar CutAngCalc_Kx ,CutAngCalc_Ky, CutAngCalc_ang, CutAngCalc_typevariable tempKx=CutAngCalc_Kxvariable tempKy=CutAngCalc_KytempKx=mod(tempKx,2)tempKy=mod(tempKy,2)if(CutAngCalc_type==1)CutAngCalc_ang=atan2(tempKx,tempKy)*180/piCutAngCalc_ang=90-CutAngCalc_angif(CutAngCalc_ang<0)CutAngCalc_ang=CutAngCalc_ang+360endifendifif(CutAngCalc_type==2)tempKx=abs(tempKx)>1?(tempKx-sign(tempKx)*2):tempKxtempKy=abs(tempKy)>1?(tempKy-sign(tempKy)*2):tempKytempKx=abs(tempKx)tempKy=abs(tempKy)CutAngCalc_ang=atan2(1-tempKx,1-tempKy)*180/piif(CutAngCalc_ang>45)CutAngCalc_ang=90-CutAngCalc_angendifendifendproc CutAngCalc_valfromcrs(ctrlName): ButtonControlString ctrlNameCutAngCalc_Kx=hcsr(A, "RotatedMapping")CutAngCalc_Ky=vcsr(A, "RotatedMapping")CutAngCalc()end//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Symmetrize image for MDC fitproc Imgsym(ctrlName) : ButtonControl	String ctrlName	dowindow/f  ImgSymW	if(V_flag!=1)	variable/g SymPoint, SymGraphi, SymGraphf	variable/g CheckL2R, CheckR2L	ImgSymW()	endifEndWindow ImgSymW() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(1133,666,1339,788) as "ImgSymW"	SetVariable Graphi,pos={18,36},size={77,18},title="From",value= SymGraphi	SetVariable Graphi1,pos={18,39},size={84,18},title="From"	SetVariable Graphi1,limits={0,inf,1},value= SymGraphi	SetVariable Graphi2,pos={109,38},size={72,18},title="To"	SetVariable Graphi2,limits={0,inf,1},value= SymGraphf	CheckBox check0,pos={20,72},size={83,15},title=" Left 2 Right"	CheckBox check0,variable= CheckL2R	CheckBox check1,pos={20,93},size={86,15},title=" Right  2 Left"	CheckBox check1,variable= CheckR2L	Button button0,pos={125,73},size={53,32},proc=symmetrize_MDC,title="Go",fSize=15	Button button0,fStyle=1	SetVariable Sympoint,pos={17,9},size={164,18},title="Sym Point"	SetVariable Sympoint,limits={0,inf,1},value= SymPointEndMacroproc symmetrize_MDC(ctrlName): ButtonControlString ctrlNamevariable EPoint, KPointstring graphNamevariable i=SymGraphidographName=dispwave+num2str(i)KPoint=dimsize($graphName,1)EPoint=dimsize($graphName,0)if(CheckL2R==1)duplicate/o $graphName tempt2Dredimension/n=(EPoint, 2*SymPoint+1) tempt2Dtempt2D[][]=q>SymPoint?$graphName[p][2*SymPoint-q]:$graphName[p][q]elseduplicate/o $graphName tempt2Dredimension/n=(EPoint, 2*KPoint-2*SymPoint+1) tempt2Dtempt2D[][]=q<(2*KPoint-2*SymPoint+1)/2?$graphName[p][KPoint-1-q]:$graphName[p][SymPoint+q-(2*KPoint-2*SymPoint+1)/2+0.5]endifduplicate/o tempt2D  $graphNamei+=1while(i<SymGraphf+1)end///////////////////////////////////////////////////////////////////////////////////////////////laser wavelength to photon energyproc Laserhv(ctrlName) : ButtonControl	String ctrlName	dowindow/f PE_PhotonEnergy	if(v_flag!=1)	variable/g PE_wl	variable/g PE_hv	PE_PhotonEnergy()	endifEndWindow PE_PhotonEnergy() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel /K=1/W=(691,328,883,399) as "PE_PhotonEnergy"	SetVariable setvar0,pos={16,39},size={155,16},proc=PE_hv2wl,title="hv (eV)"	SetVariable setvar0,limits={0,inf,0.1},value= PE_hv	SetVariable setvar1,pos={14,13},size={156,16},proc=PE_wl2hv,title="Wave Length (nm)"	SetVariable setvar1,limits={0,inf,10},value= PE_wlEndMacroFunction  PE_wl2hv(sva) : SetVariableControl	STRUCT WMSetVariableAction &sva	nvar PE_hv	nvar PE_wl	PE_hv=1.2398*4*1000/PE_wlEndFunction PE_hv2wl(sva) : SetVariableControl	STRUCT WMSetVariableAction &sva	nvar PE_hv	nvar PE_wl	PE_wl=1.2398*4*1000/PE_hvEnd//////////////////////////////////////////////////////////////////////////////////////////////////////////calculate EkFunction Calek_ButtonProc(ctrlName) : ButtonControl	String ctrlName	Nvar Goffset	string offsetstr	variable LastGraphNo=1, FirstGraphNo=1, offset,graph	string fromImg //,KScaleMethod	if (Goffset==0)   		offsetstr = "G0000"  	else   		offsetstr = "G"+num2str(Goffset)  	endif	Prompt offsetstr, "Graph offset ", popup, StringList("G*000",";")	Prompt FirstGraphNo,"From No."	Prompt LastGraphNo,"To No."//	Prompt KScaleMethod, "K scale method", popup, "1. zero at midle;2. zero at min"	Prompt fromImg, "From Image", popup, "norm;raw"      DoPrompt "Calculate Ek", fromImg,offsetstr, FirstGraphNo, LastGraphNo //, KScaleMethod	if (V_flag != 0) 	 return -1; // User cancelled.  	endif  	 	sscanf offsetstr, "G%f", offset 	variable ii, iimax 	ii=0 	iimax=abs(LastGraphNo-FirstGraphNo+1) 	do 	graph=ii*sign(LastGraphNo-FirstGraphNo)+FirstGraphNo+offset 	calEk(graph,fromImg) 	ii+=1 	print num2str(ii)+"/"+num2str(iimax) 	while(ii<iimax)Endfunction calEk(Graph,fromImg)variable graphstring fromImgstring grnameif(stringmatch(fromImg,"norm")==1)	 grname="nr"+num2str(graph)elseif(stringmatch(fromImg,"raw")==1)	grname="gr"+num2str(graph)endifif(waveexists($grname)!=1)abort "There is no"+grnameendifstring gxname="gx"+num2str(graph)string akname="ek"+num2str(graph)duplicate/o $grname temp2Dvariable  numpoint=dimsize($grname,1)make/o/n=(numpoint)  AKYwave,AKZwave,AKx2wave,AKy2wave,temp1,temp2,tempduplicate/o $gxname tempvariable Estart, Eend, deltaE,ii,iimaxEstart=temp[dimsize(temp,0)-1]deltaE=temp[0]-temp[1]Eend=temp[0]calckxky(graph,Estart)variable cutnx,cutnycutnx=(AKx2wave[numpoint-1]-AKx2wave[0])cutny=(AKy2wave[numpoint-1]-AKy2wave[0])variable nlength=sqrt(cutnx^2+cutny^2)cutnx=cutnx/nlengthcutny=cutny/nlengthvariable zerox, zeroyif(AKx2wave[0]^2+AKy2wave[0]^2-AKx2wave[numpoint-1]^2-AKy2wave[numpoint-1]^2>0)cutnx=-cutnxcutny=-cutnyendifzerox=cutny*(AKx2wave[0]*AKy2wave[numpoint-1]-AKx2wave[numpoint-1]*AKy2wave[0])/(cutny*(AKy2wave[numpoint-1]-AKy2wave[0])+cutnx*(AKx2wave[numpoint-1]-AKx2wave[0]))zeroy=-zerox*cutnx/cutnyvariable scalemin,scalemaxscalemin=min((AKx2wave[0]-zerox)*cutnx+(AKy2wave[0]-zeroy)*cutny, (AKx2wave[numpoint-1]-zerox)*cutnx+(AKy2wave[numpoint-1]-zeroy)*cutny)scalemax=max((AKx2wave[0]-zerox)*cutnx+(AKy2wave[0]-zeroy)*cutny, (AKx2wave[numpoint-1]-zerox)*cutnx+(AKy2wave[numpoint-1]-zeroy)*cutny)calckxky(graph,Eend)scalemin=min(scalemin,min((AKx2wave[0]-zerox)*cutnx+(AKy2wave[0]-zeroy)*cutny, (AKx2wave[numpoint-1]-zerox)*cutnx+(AKy2wave[numpoint-1]-zeroy)*cutny))scalemax=max(scalemax,max((AKx2wave[0]-zerox)*cutnx+(AKy2wave[0]-zeroy)*cutny, (AKx2wave[numpoint-1]-zerox)*cutnx+(AKy2wave[numpoint-1]-zeroy)*cutny))setscale/i y scalemin, scalemax, temp2Dvariable deltaK=(scalemax-scalemin)/(numpoint-1)variable Energy=Estartvariable newnum,nump,numS,numEii=0iimax=dimsize(temp,0)make/o/n=(numpoint) tempsetscale/i x scalemin, scalemax, tempdoEnergy=Estart+ii*deltaEcalckxky(graph,Energy)temp1=(AKx2wave[p]-zerox)*cutnx+(AKy2wave[p]-zeroy)*cutnytemp2=temp2D[iimax-ii-1][p]//make/o/n=(numE) temp//setscale/p x scalemin+numS*deltaK, deltaK, temptemp=interp(x, temp1, temp2)temp2D[iimax-ii-1][]=temp[q]numS=round((min(temp1[0],temp1[numpoint-1])-scalemin)/deltaK)numE=round(abs(temp1[0]-temp1[numpoint-1])/deltaK)+1//temp2D[iimax-ii-1][0, numS-1]=temp[0]//temp2D[iimax-ii-1][numE+numS,]=temp[numE]//temp2D[iimax-ii-1][numS, numE+numS-1]=temp[q-numS]ii+=1while(ii<iimax)duplicate/o temp2D, $aknameendfunction calckxky(graph,Energy)variable Energyvariable graphvariable Psi, Theta,Phiwave mapnvar offRota, offTheta, offPhinvar SliceAnglewave AKYwave,AKZwave,AKx2wave,AKy2wavevariable numpoint=dimsize(AKYwave,0)Theta=-(map[graph][6]-offTheta)*(pi/180)Psi=(map[graph][12]-offRota)*(pi/180)Phi=(map[graph][11]-offPhi)*(pi/180)//nvar aa=LatticeConstantvariable aa=pivariable h_bar=1.0545*10^-34, m=9.11*10^-31, eV=1.6*10^-19variable momentummomentum=(2*m*Energy*eV)^0.5/(pi/(aa*10^-10))/h_barAKZwave = cos((p-numpoint/2)*pi/180*SliceAngle)*momentumAKYwave = sin((p-numpoint/2)*pi/180*SliceAngle)*momentumAKx2wave[] = sin(Theta)*AKZwave[p]AKy2wave[] = -sin(Phi)*cos(Theta)*AKZwave[p]+cos(Phi)*AKYwave[p]if (Psi != 0) 	duplicate/o AKx2wave temp1	duplicate/o AKy2wave temp2	AKx2wave[] = temp1[p]*cos(Psi)-temp2[p]*sin(Psi)	AKy2wave[] = temp1[p]*sin(Psi)+temp2[p]*cos(Psi)endifend//////////////////////////////////////////////////////////////////////////////////////Real part of SelfEnergyproc Re_SE (ctrlName) : ButtonControl	String ctrlName	string panelname="ReSe_W"	dowindow/f $panelname	if (V_flag!=1)//	make/o/n=100 ReSE_bareband	variable/g ReSE_lineara, ReSE_linearb,  ReSE_quada,ReSE_quadb,ReSE_quadc, ReSe_updatecheck=0	string/g ReSe_bareMethod="linear"	string/g ReSe_Sename	ReSe_W() 	endifendWindow ReSe_W() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(931,359,1380,606) as "ReSE"	ModifyPanel cbRGB=(49152,65280,32768)	SetDrawLayer UserBack	DrawText 16,61,"One Band"	DrawText 152,60,"Two Band One Width"	DrawText 308,59,"Two Band Two Width"	SetDrawEnv linethick= 2	DrawLine 13,11,431,11	SetDrawEnv linethick= 2	DrawLine 18,95,436,95	SetDrawEnv fsize= 16,fstyle= 1,textrgb= (0,15872,65280)	DrawText 13,36,"Ffitted dispersion"	SetDrawEnv fsize= 16,fstyle= 1,textrgb= (65280,0,0)	DrawText 20,120,"Bare dispersion"	SetDrawEnv linethick= 2	DrawLine 21,199,439,199	DrawText 22,147,"Linear"	SetDrawEnv textrgb= (65280,0,0)	DrawText 372,144,"E(K)=a+b*K"	DrawText 21,178,"quadratic"	SetDrawEnv textrgb= (65280,0,0)	DrawText 337,178,"E(K)=a+b*K+c*K^2"	PopupMenu EFpopup,pos={19,63},size={95,21},proc=Re_SE_showband	PopupMenu EFpopup,mode=146,popvalue="dMDCone156",value= #"\"_none_;\" + WaveList(\"dMDCone*\",\";\",\"\")"	PopupMenu EFpopup1,pos={155,63},size={104,21},proc=Re_SE_showband	PopupMenu EFpopup1,mode=5,popvalue="dMDCtwoS62_r",value= #"\"_none_;\" + WaveList(\"dMDCtwoS*\",\";\",\"\")"	PopupMenu EFpopup2,pos={309,63},size={105,21},proc=Re_SE_showband	PopupMenu EFpopup2,mode=3,popvalue="dMDCtwoD60_r",value= #"\"_none_;\" + WaveList(\"dMDCtwoD*\",\";\",\"\")"	SetVariable a,pos={90,130},size={70,18},proc=ReSe_linearfunc,title="a"	SetVariable a,limits={-inf,inf,0.1},value= ReSE_lineara	SetVariable b,pos={166,130},size={69,18},proc=ReSe_linearfunc,title="b"	SetVariable b,limits={-inf,inf,0.1},value= ReSE_linearb	Button FCrs,pos={248,129},size={58,19},proc=ReSe_linefit,title="fit"	SetVariable a1,pos={86,160},size={58,18},proc=ReSe_linearfunc,title="a"	SetVariable a1,limits={-inf,inf,0.1},value= ReSE_quada	SetVariable b1,pos={154,161},size={52,18},proc=ReSe_linearfunc,title="b"	SetVariable b1,limits={-inf,inf,0.1},value= ReSE_quadb	SetVariable b2,pos={216,161},size={52,18},proc=ReSe_linearfunc,title="c"	SetVariable b2,limits={-inf,inf,0.1},value= ReSE_quadc	PopupMenu EFpopup3,pos={163,98},size={99,21},proc=ReSE_baremethodfunc,title="method"	PopupMenu EFpopup3,mode=1,popvalue="linear",value= #"\"linear;quadratic\""	Button showbare,pos={290,99},size={54,21},proc=ReSe_showbare,title="show"	Button showbare1,pos={27,211},size={78,23},proc=Re_Se_showReSe,title="Show ReSe"	Button showbare1,fStyle=1	CheckBox check0,pos={331,16},size={90,15},title="update ReSe",fStyle=1	CheckBox check0,variable= ReSe_updatecheck	Button FCrs1,pos={271,160},size={58,19},proc=ReSe_quadraticfit,title=" fit"	Button showbare2,pos={166,15},size={54,21},proc=ReSE_showfitted,title="show"	Button FCrs2,pos={308,129},size={55,18},proc=ReSe_fromCrs,title="FCrs"	Button multicalc,pos={116,210},size={99,23},proc=ReSe_multiReSe,title="multi ReSe Calc"	Button multicalc,fStyle=1EndMacroFunction ReSE_showfitted(ctrlName) : ButtonControl	String ctrlName	string panelname="ReSE_disp"	dowindow/f $panelname	if (V_flag!=1)	PauseUpdate; Silent 1		// building window...		if(exists("Re_bandE")==0)	 abort "Choose a fitted dispersion first!"	endif	wave Re_bandE, Re_bandK	display Re_bandE vs Re_bandK as panelname	dowindow/c $panelname 	ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0	Label left "Energy (eV)"	Label bottom "K//"	ModifyGraph mode=3,marker=8,msize=3,rgb=(0,15872,65280)	ModifyGraph margin(left)=43,margin(bottom)=36,margin(top)=7,margin(right)=7;DelayUpdate//	ModifyGraph height={Aspect,1.5}	svar ReSe_Sename	TextBox/C/N=text0/F=0/A=MC ReSe_Sename[1,strlen(ReSe_Sename)-1]	TextBox/C/N=text0/X=30.00/Y=40.00	endifEndFunction Re_SE_showband (ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string bandE, bandK	svar ReSe_Sename//	variable graph	bandK=popStr	if(stringmatch(bandK[0,6], "dMDCone"))		bandE=popStr		bandE[0,0]="en"	else		bandE=popStr[0,strlen(popStr)-3]		bandE[0,0]="en"	endif		ReSe_Sename=popStr	ReSe_Sename[0,0]="r"	string panelname="ReSE_disp"	dowindow $panelname	if (V_flag==1)	TextBox/W=ReSe_disp/C/N=text0/F=0/A=MC ReSe_Sename[1,strlen(ReSe_Sename)-1]	endif	duplicate/o $bandE Re_bandE	duplicate/o $bandK Re_bandK		nvar ReSe_updatecheck	if(ReSe_updatecheck)	ReSe_ReSecalc()	endifendFunction ReSe_linefit(ctrlName) : ButtonControl	String ctrlName	string panelname="ReSE_disp"	dowindow/f $panelname	if(V_flag==1)	wave Re_bandE, Re_bandK	if (stringmatch(CsrWave(a),"") || stringmatch(CsrWave(b),"")) 	      CurveFit/Q=1/M=2/W=0 line, Re_bandE/X=Re_bandK/D 	else  //		CurveFit/NTHR=0 line  ReSE_barebandE[pcsr(B),pcsr(A)] /X=Re_bandK /D  		CurveFit/Q=1/M=2/W=0 line, Re_bandE[pcsr(B),pcsr(A)]/X=Re_bandK/D 	endif		RemoveFromGraph fit_Re_bandE	nvar ReSE_lineara, ReSE_linearb	wave W_coef	ReSE_lineara=W_coef[0]	 ReSE_linearb=W_coef[1]	 ReSe_calbareband()	 nvar ReSe_updatecheck	if(ReSe_updatecheck)	ReSe_ReSecalc()	endif	endifEndFunction ReSe_fromCrs(ctrlName) : ButtonControl	String ctrlName	nvar a=ReSE_lineara	nvar b=ReSE_linearb	string panelname="ReSE_disp"	dowindow/f $panelname	if(V_flag==1)	wave Re_bandE, Re_bandK	if (stringmatch(CsrWave(a),"") || stringmatch(CsrWave(b),"")) 	      Abort "Set A and B cursors!!" 	else // 	CsrAx = hcsr(A)//	CsrAy = vcsr(A)//	CsrBx = hcsr(B)//	CsrBy = vcsr(B)	b=(vcsr(B)-vcsr(A))/(hcsr(B)-hcsr(A))	a=vcsr(B)-b*hcsr(B) 	endif	 ReSe_calbareband()	 nvar ReSe_updatecheck	if(ReSe_updatecheck)	ReSe_ReSecalc()	endif	endifEndFunction ReSe_quadraticfit(ctrlName) : ButtonControl	String ctrlName		string panelname="ReSE_disp"	dowindow/f $panelname	if(V_flag==1)	wave Re_bandE, Re_bandK	if (stringmatch(CsrWave(a),"") || stringmatch(CsrWave(b),""))		CurveFit/Q=1/M=2/W=0 poly 3, Re_bandE/X=Re_bandK/D	else 		CurveFit/Q=1/M=2/W=0 poly 3, Re_bandE[pcsr(B),pcsr(A)]/X=Re_bandK/D		endif	RemoveFromGraph fit_Re_bandE	nvar ReSE_quada,ReSE_quadb,ReSE_quadc	wave W_coef	 ReSE_quada=W_coef[0]	 ReSE_quadb=W_coef[1]	 ReSE_quadc=W_coef[2]	 ReSe_calbareband()	 nvar ReSe_updatecheck	if(ReSe_updatecheck)	ReSe_ReSecalc()	endif	endifEndfunction ReSe_calbareband()	svar method=ReSe_bareMethod	wave RRe_bandE,Re_bandK	duplicate/o Re_bandK ReSE_barebandK, ReSE_barebandE	if(stringmatch(method, "linear"))		nvar a=ReSE_lineara		nvar slope=ReSE_linearb		ReSE_barebandE=a+slope*ReSE_barebandK	else		 nvar a=ReSE_quada		 nvar b=ReSE_quadb		 nvar c=ReSE_quadc		 ReSE_barebandE=a+b*ReSE_barebandK+c*ReSE_barebandK*ReSE_barebandK	endifendFunction ReSE_baremethodfunc(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	svar ReSe_bareMethod	ReSe_bareMethod=popStr	ReSe_calbareband()	nvar ReSe_updatecheck	if(ReSe_updatecheck)	ReSe_ReSecalc()	endifEndFunction ReSe_showbare(ctrlName) : ButtonControl	String ctrlName	string panelname="ReSE_disp"		dowindow/f $panelname	if (V_flag==1)		ReSe_calbareband()		string list=TraceNameList("", ";",1)		if(!stringmatch(list, "*ReSE_bareband*"))		wave ReSE_barebandE, ReSE_barebandK		appendtograph ReSE_barebandE vs ReSE_barebandK		ModifyGraph lsize(ReSE_barebandE)=2		endif	endifEndFunction ReSe_linearfunc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	ReSe_calbareband()	nvar ReSe_updatecheck	if(ReSe_updatecheck)	ReSe_ReSecalc()	endifEndfunction ReSe_ReSecalc()	ReSe_calbareband()	wave Re_bandE, ReSE_barebandE	svar ReSe_Sename	duplicate/o Re_bandE ReSe_SeE, ReSe_Se	ReSe_Se=Re_bandE-ReSE_barebandE	duplicate/o ReSe_Se $ReSe_SenameendFunction Re_Se_showReSe(ctrlName) : ButtonControl	String ctrlName	string panelname="ReSE_results"	ReSe_ReSecalc()	dowindow/f $panelname	if (V_flag!=1)		PauseUpdate; Silent 1		// building window...		wave ReSe_Se, ReSe_SeE	display ReSe_Se vs ReSe_SeE as panelname	dowindow/c $panelname 	ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0	Label bottom "Energy (eV)"	Label left "Re_SE (eV)"	ModifyGraph mode=3,marker=8,msize=3,rgb=(52224,0,41728)	ModifyGraph margin(left)=43,margin(bottom)=36,margin(top)=7,margin(right)=7;DelayUpdate//	ModifyGraph height={Aspect,0.6}	endifEndFunction ReSe_multiReSe(ctrlName) : ButtonControl	String ctrlName	variable graphi	variable graphf	nvar Goffset	string fittingtype="oneband"	string offsetstr	string fitbareband="No"	string branch="Left"	if (Goffset==0)   		offsetstr = "G0000"  	else   		offsetstr = "G"+num2str(Goffset)  	endif  	prompt fittingtype, "MDC fitting type:", popup, "OneBand;TwoBandSingle;TwoBandDouble"  	prompt branch, "If two bands, which branch?", popup, "Left;Right"	Prompt offsetstr, "Graph offset:", popup, StringList("G*000",";")		Prompt graphi, "startG: "      Prompt graphf, "lastG.: "      Prompt fitbareband, "Calc bare band every dispersion?", popup, "No;Yes"       Doprompt "Graph Num. to Calc",  fittingtype, offsetstr, graphi, graphf, fitbareband         if (V_Flag)            return -1// User canceled         endif                        variable offset 	sscanf offsetstr, "G%f", offset 	graphi+=offset 	graphf+=offset                 if(stringmatch(fitbareband, "Yes"))        	 svar method=ReSe_bareMethod       	 if(stringmatch(method, "linear"))        		string baremethod="Fitting"        		Prompt baremethod, "Method to get bare band?", popup, "FromCrs;Fitting"        		Doprompt "", baremethod        		if (V_Flag)           		 return -1// User canceled         		endif               	endif        endif                       string Kprifex, Eprifex, Reprifex        if(stringmatch(fittingtype, "OneBand"))        	Kprifex="dMDCone"        	Eprifex="enMDCone"        	Reprifex="rMDCone"        elseif(stringmatch(fittingtype, "TwoBandSingle"))       	 Kprifex="dMDCtwoS"        	Eprifex="enMDCtwoS"        	Reprifex="rMDCtwoS"        elseif(stringmatch(fittingtype, "TwoBandDouble"))        	Kprifex="dMDCtwoD"        	Eprifex="enMDCtwoD"        	Reprifex="rMDCtwoD"        endif        svar ReSe_Sename        variable ii=graphi        string bandK, bandE                variable updatebackup        nvar ReSe_updatecheck        updatebackup=ReSe_updatecheck        ReSe_updatecheck=1        do        bandK=Kprifex+num2str(ii)        bandE=Eprifex+num2str(ii)        ReSe_Sename=Reprifex+num2str(ii)        if(stringmatch(fittingtype, "OneBand"))        else        	if(stringmatch(branch, "Left"))        		Kprifex+="_l"        		Eprifex+="_l"        		Reprifex+="_l"        	else        		Kprifex+="_r"        		Eprifex+="_r"        		Reprifex+="_r"        	        	endif        endif                duplicate/o $bandE Re_bandE	 duplicate/o $bandK Re_bandK		 if(stringmatch(fitbareband, "Yes"))	 	if(stringmatch(method, "linear"))	 		if(stringmatch(baremethod, "Fitting"))	 			ReSe_linefit("")	 		else	 			ReSe_fromCrs("")	 		endif	 	else	 		ReSe_quadraticfit("")	 	endif	 endif	 //        ReSe_ReSecalc()                ii+=1        while(ii<=graphf)        ReSe_updatecheck=updatebackupEnd///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// selfEnergy panelFunction SE_showReSe(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr	string ReSename, ReSeEname	ReSename=popStr	if(stringmatch(ReSename[0,6], "rMDCone"))		ReSeEname=ReSename		ReSeEname[0,0]="en"	else		ReSeEname=ReSename[0,strlen(ReSename)-3]		ReSeEname[0,0]="en"	endif		duplicate/o $ReSename SE_ReSe	duplicate/o $ReSeEname SE_ReSeE	string panelname="ReSE"	dowindow/f $panelname	if (V_flag!=1)		PauseUpdate; Silent 1		// building window...	//	wave SE_ReSe, SE_ReSeE	display SE_ReSe vs SE_ReSeE as panelname	dowindow/c $panelname 	ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0	Label bottom "Energy (eV)"	Label left "Re_SE (eV)"	ModifyGraph mode=3,marker=8,msize=3,rgb=(52224,0,41728)	ModifyGraph margin(left)=43,margin(bottom)=36,margin(top)=7,margin(right)=7;DelayUpdate	endif		nvar check=SE_apCKReSe	if(check)	appendtograph $ReSename vs $ReSeEname	endifEndFunction SE_showMDCWidth(ctrlName,popNum,popStr) : PopupMenuControl	String ctrlName	Variable popNum	String popStr		string MDCWname, MDCWEname	MDCWname=popStr		if(stringmatch(MDCWname[0,7], "wMDCtwoD"))		MDCWEname=MDCWname[0,strlen(MDCWname)-3]		MDCWEname[0,0]="en"	else				MDCWEname=MDCWname		MDCWEname[0,0]="en"	endif		duplicate/o $MDCWname SE_MDCW	duplicate/o $MDCWEname SE_MDCWE	string panelname="MDCWidth"	dowindow/f $panelname	if (V_flag!=1)		PauseUpdate; Silent 1		// building window...		display SE_MDCW vs SE_MDCWE as panelname	dowindow/c $panelname 	ModifyGraph tick=2,mirror=2,fStyle=1,fSize=12,standoff=0	Label bottom "Energy (eV)"	Label left "MDC Width (slice)"	ModifyGraph mode=3,marker=8,msize=3,rgb=(0,39168,39168)	ModifyGraph margin(left)=43,margin(bottom)=36,margin(top)=7,margin(right)=7;DelayUpdate	endif		nvar check=SE_apCKMDCW	if(check)	appendtograph $MDCWname vs $MDCWEname	endif	EndWindow SelfEnergyW() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/K=1 /W=(536,407,865,557) as "SelfEnergy"	ModifyPanel cbRGB=(48896,65280,48896)	SetDrawLayer UserBack	SetDrawEnv linethick= 2	DrawLine 15,41,320,41	SetDrawEnv linethick= 2	DrawLine 13,109,316,109	SetDrawEnv fsize= 16,fstyle= 1,textrgb= (52224,0,41728)	DrawText 23,69,"ReSe"	SetDrawEnv fsize= 16,fstyle= 1,textrgb= (0,39168,39168)	DrawText 23,30,"MDC Width"	SetDrawEnv fsize= 14,fstyle= 1	DrawText 87,101,"Show"	PopupMenu Repopup,pos={140,81},size={86,21},proc=SE_showReSe	PopupMenu Repopup,mode=5,popvalue="rMDCone63",value= #"\"_none_;\" + WaveList(\"rMDC*\",\";\",\"\")"	PopupMenu MDCWidthpopup,pos={123,10},size={91,21},proc=SE_showMDCWidth	PopupMenu MDCWidthpopup,mode=2,popvalue="wMDCone47",value= #"\"_none_;\" + WaveList(\"wMDC*\",\";\",\"\")"	CheckBox append,pos={238,13},size={67,15},title="append?",variable= SE_apCKMDCW	Button button16,pos={86,48},size={88,22},proc=Re_SE,title="Calculation",fSize=14	Button button16,fStyle=1	Button button20,pos={18,119},size={95,24},proc=MDCAlanize,title="TdepSE"	Button button20,fSize=16,fStyle=1	CheckBox append1,pos={236,85},size={67,15},title="append?",variable= SE_apCKReSeEndMacroproc SE_ButtonProc(ctrlName) : ButtonControl	String ctrlName	dowindow/f SelfEnergyW	if (V_flag!=1)	variable/g SE_apCKMDCW, SE_apCKReSe	SelfEnergyW()	endifEnd////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////circular data processWindow CircularLightW() : Panel	PauseUpdate; Silent 1		// building window...	NewPanel/k=1 /W=(142,324,426,562) as "Circular Light"	SetDrawLayer UserBack	DrawRect 91,141,260,224	DrawText 153,23,"shift"	SetVariable setvar0,pos={152,34},size={107,18},title="Theta"	SetVariable setvar0,limits={-inf,inf,0.5},value= CThetaShift	SetVariable setvar1,pos={153,67},size={107,18},title="Slice"	SetVariable setvar1,limits={-inf,inf,0.5},value= CSliceShift	SetVariable setvar2,pos={140,96},size={120,18},title="Energy (meV)"	SetVariable setvar2,limits={-inf,inf,0.5},value= CEnergyShift	SetVariable setvar3,pos={13,38},size={107,18},title="L graph i"	SetVariable setvar3,limits={1,inf,1},value= CLgraphi	SetVariable setvar4,pos={13,71},size={107,18},title="R graph i"	SetVariable setvar4,limits={1,inf,1},value= CRgraphi	SetVariable setvar5,pos={13,100},size={107,18},title="Graph num."	SetVariable setvar5,limits={1,inf,1},value= Cgraphnum	Button button0,pos={11,157},size={66,33},proc=ButtonProc_circularcalc,title="Go"	Button button0,fSize=14,fStyle=1	CheckBox check0,pos={14,8},size={43,15},title="nor?",variable= Cnor	Button button1,pos={101,149},size={37,22},proc=CDSaveButtonProc,title="Save"	Button button1,fSize=14,fStyle=0	SetVariable setvar6,pos={141,151},size={34,18},proc=CDsaveNoProc,title=" "	SetVariable setvar6,limits={0,inf,1},value= saveno_CD	CheckBox check1,pos={180,153},size={70,15},title="AutoLoad"	CheckBox check1,variable= CDsavecheck	SetVariable setvar24,pos={102,175},size={142,18},title="memo"	SetVariable setvar24,value= saveno_memoCD	Button button05,pos={134,198},size={92,20},proc=MemoCDListFunc,title="memo List"EndMacroproc ButtonProc_circular(ctrlName) : ButtonControl	String ctrlName	dowindow/F CircularLightW	if(v_flag==0)	variable/g CLgraphi	variable/g CRgraphi	variable/g Cgraphnum	variable/g CThetaShift	variable/g CEnergyShift	variable/g CSliceShift	variable/g Cnor	variable/g saveno_CD	string/g saveno_memoCD	variable/g CDsavecheck	make/o/t/n=51 memoT_CD		CircularLightW()	endifEndFunction MemoCDListFunc (ctrlName) : ButtonControl	String ctrlName	string panelname = "MemoCDList"	wave/t memoT_CD	dowindow/f $panelname	if (v_flag!=1)	edit memoT_CD	dowindow/c $panelname	endifend	Function CDSaveButtonProc (ctrlName) : ButtonControl	String ctrlName   NVAR CLgraphi,CRgraphi,Cgraphnum,CThetaShift,CSliceShift,CEnergyShift   NVAR saveNo_CD   string CDcoeff   wave/t memoT_CD   svar saveno_memoCD   CDcoeff="CDcoeff"+num2istr(saveNo_CD)   make/o/n=6 $CDcoeff   duplicate/o $CDcoeff temp0  temp0={CLgraphi,CRgraphi,Cgraphnum,CThetaShift,CSliceShift,CEnergyShift}   duplicate/o temp0 $CDcoeff  memoT_CD[saveNo_CD]=saveNo_memoCDEndproc CDsaveNoProc (ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	string CDcoeff	silent 1 ; pauseupdate	saveNo_CD = varNum	if (CDsavecheck)	CDcoeff="CDcoeff"+num2istr(saveNo_CD)       saveNo_memoCD=memoT_CD[saveNo_CD]	 duplicate/o $CDcoeff temp0	 CLgraphi=temp0[0]	 CRgraphi=temp0[1]  	Cgraphnum=temp0[2]  	CThetaShift=temp0[3]  	CSliceShift=temp0[4]   	CEnergyShift=temp0[5]	endifEndproc ButtonProc_circularcalc(ctrlName) : ButtonControl	String ctrlNamestring name1string name2string name3variable bg=0variable deltaE=str2num(mapt[CLgraphi][7])*1000variable deltaT=str2num(mapt[CLgraphi+1][13])-str2num(mapt[CLgraphi][13])variable graphl,graphhvariable ii=0doif(Cgraphnum>1&&mod(CThetaShift,1)!=0)graphl=ii+CLgraphi+ceil(CThetaShift)graphh=ii+CLgraphi+floor(CThetaShift)graphl=graphl>CLgraphi?(graphl):(CLgraphi)graphl=graphl<(CLgraphi+Cgraphnum-1)?(graphl):(CLgraphi+Cgraphnum-1)graphh=graphh>CLgraphi?(graphh):(CLgraphi)graphh=graphh<(CLgraphi+Cgraphnum-1)?(graphh):(CLgraphi+Cgraphnum-1)name1="nr"+num2str(graphl)name2="nr"+num2str(graphh)duplicate/o $name1 temp2d1,temp2dduplicate/o $name2 temp2d2temp2d1=abs(floor(CThetaShift)-CThetaShift)*temp2d1+abs(ceil(CThetaShift)-CThetaShift)*temp2d2elsegraphl=ii+CLgraphi+CThetaShiftgraphl=graphl<(CLgraphi+Cgraphnum-1)?(graphl):(CLgraphi+Cgraphnum-1)graphl=graphl>CLgraphi?(graphl):(CLgraphi)name1="nr"+num2str(graphl)duplicate/o $name1 temp2d1,temp2dendifname2="nr"+num2str(ii+CRgraphi)duplicate/o $name2 temp2d2if(Cnor)temp2d=(temp2d1[p-CEnergyShift/deltaE][q-CSliceShift]-temp2d2[p][q])/(temp2d1[p-CEnergyShift/deltaE][q-CSliceShift]+temp2d2[p][q])elsetemp2d=temp2d1[p-CEnergyShift/deltaE][q-CSliceShift]-temp2d2[p][q]endifname3="dif"+num2str(ii+CRgraphi)duplicate/o temp2d $name3ii+=1while(ii<Cgraphnum)end////////////////////////////////////////////////////////////////////////////////////////Function Butt_Subtruct_flip (ctrlName) : ButtonControl	String ctrlName	variable i	Nvar Butt_of, ButtSubtractNo, AnaFromNo, AnaToNo	string wavestrY	wave Butt_angle	for (i=AnaFromNo ; i<=AnaToNo ; i+=1)	   wavestrY = "Buttwave" + num2istr(i)		if (numpnts($wavestrY)!=0)		  duplicate/o $wavestrY temp      		 temp[]*=-1      		duplicate/o temp $wavestrY		endif   endforend